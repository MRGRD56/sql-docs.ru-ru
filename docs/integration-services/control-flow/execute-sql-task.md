---
description: Задача "Выполнение SQL"
title: Задача "Выполнение SQL"
ms.custom: ''
ms.date: 03/13/2017
ms.prod: sql
ms.prod_service: integration-services
ms.reviewer: ''
ms.technology: integration-services
ms.topic: conceptual
f1_keywords:
- sql13.dts.designer.executesqltask.f1
- sql13.dts.designer.executesqltask.general.f1
- sql13.dts.designer.executesqltask.parametermapping.f1
- sql13.dts.designer.executesqltask.resultset.f1
helpviewer_keywords:
- Transact-SQL statements, SSIS
- statements [Integration Services]
- batches [Integration Services]
- Execute SQL task [Integration Services]
ms.assetid: bebb2e8c-0410-43b2-ac2f-6fc80c8f2e9e
author: chugugrace
ms.author: chugu
ms.openlocfilehash: 0b8155db361eeffd3b84ba1aadf313ecef4652e9
ms.sourcegitcommit: cfa04a73b26312bf18d8f6296891679166e2754d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/19/2020
ms.locfileid: "92196546"
---
# <a name="execute-sql-task"></a>Задача "Выполнение SQL"

[!INCLUDE[sqlserver-ssis](../../includes/applies-to-version/sqlserver-ssis.md)]

  Задача «Выполнение SQL» выполняет инструкции SQL или хранимые процедуры из пакета. Задача может содержать одну инструкцию SQL или несколько инструкций, запускаемых последовательно. Задача «Выполнение SQL» может быть использована для следующих целей:  
  
-   усечение таблицы или представления в процессе подготовки для вставки данных;  
  
-   создание, изменение и удаление объектов базы данных, таких как таблицы и представления;  
  
-   повторное создание таблиц фактов и таблиц измерений перед загрузкой данных;  
  
-   выполнение хранимых процедур; Если инструкция SQL вызывает хранимую процедуру, возвращающую результаты из временной таблицы, используйте параметр WITH RESULT SETS для определения метаданных набора результатов.  
  
-   сохранение набора строк, возвращенного в переменную из запроса.  
  
 Задача «Выполнение SQL» может использоваться в сочетании с контейнерами «цикл по каждому элементу» и «цикл по элементам» для выполнения нескольких инструкций SQL. Эти контейнеры выполняют повторяющиеся потоки управления в пакете и могут запускать задачу «Выполнение SQL» повторно. Например, с помощью контейнера «цикл по каждому элементу» пакет может перечислять файлы в папке и повторно запускать задачу «Выполнение SQL» с инструкциями SQL из каждого файла.  
  
## <a name="connect-to-a-data-source"></a>Подключение к источнику данных  
 Задача «Выполнение SQL» может использовать разные типы диспетчеров соединений для подключения к источнику данных, где требуется выполнить инструкцию SQL или хранимую процедуру. Задача может использовать типы соединений, перечисленные в следующей таблице.  
  
|Тип соединений|Диспетчер соединений|  
|---------------------|------------------------|  
|EXCEL|[Диспетчер подключений Excel](../../integration-services/connection-manager/excel-connection-manager.md)|  
|OLE DB|[Диспетчер соединений OLE DB](../../integration-services/connection-manager/ole-db-connection-manager.md)|  
|ODBC|[Диспетчер подключений ODBC](../../integration-services/connection-manager/odbc-connection-manager.md)|  
|ADO|[Диспетчер подключений объектов данных ActiveX](../../integration-services/connection-manager/ado-connection-manager.md)|  
|ADO.NET|[Диспетчер подключений ADO.NET](../../integration-services/connection-manager/ado-net-connection-manager.md)|  
|SQLMOBILE|[Диспетчер подключений SQL Server Compact Edition](../../integration-services/connection-manager/sql-server-compact-edition-connection-manager.md)|  
  
## <a name="create-sql-statements"></a>Создание инструкций SQL  
 Источником инструкций SQL для этой задачи может быть свойство задачи, которое содержит инструкцию, соединение с файлом, содержащим инструкции, или имя переменной, хранящей инструкцию. Для написания инструкций SQL необходимо использовать разновидность языка SQL, используемую системой управления базой данных-источником (СУБД). Дополнительные сведения см. в разделе [Запросы в службах Integration Services (SSIS)](../../integration-services/integration-services-ssis-queries.md).  
  
 Если инструкции SQL хранятся в файле, задача использует диспетчер подключения файлов для подключения к файлу. Дополнительные сведения см. в статье [File Connection Manager](../../integration-services/connection-manager/file-connection-manager.md).  
  
 В конструкторе служб [!INCLUDE[ssIS](../../includes/ssis-md.md)] можно использовать диалоговое окно **Редактор задачи «Выполнение SQL»** для ввода инструкций SQL или **построитель запросов**— графический пользовательский интерфейс для создания запросов SQL. 
  
> [!NOTE]  
>  Задача «Выполнение SQL» не может провести синтаксический анализ допустимых инструкций SQL, созданных за ее пределами.  
  
> [!NOTE]  
>  Задача «Выполнение SQL» использует значение перечисления **RecognizeAll** ParseMode. Дополнительные сведения см. в разделе [Пространство имен ManagedBatchParser](/dotnet/api/managedbatchparser).  
  
## <a name="send-multiple-statements-in-a-batch"></a>Отправка нескольких инструкций в пакете  
 Если в задачу «Выполнение SQL» включить несколько инструкций, их можно сгруппировать и запускать как пакет. Для обозначения окончания пакета используется команда GO. Все инструкции SQL, находящиеся между двумя командами GO, отправляются в одном пакете поставщику OLE DB для выполнения. Команда SQL может содержать несколько пакетов, разделенных командами GO.  
  
 Существуют ограничения на тип инструкций SQL, которые могут объединяться в пакеты. Дополнительные сведения см. в разделе [Batches of Statements](../../relational-databases/native-client-odbc-queries/executing-statements/batches-of-statements.md).  
  
 Если задача «Выполнение SQL» выполняет пакет инструкций SQL, к пакету применяются следующие правила:  
  
-   Только одна инструкция может возвращать результирующий набор. Эта инструкция должна быть первой в пакете.  
  
-   Если в результирующем наборе содержатся связанные столбцы, запросы должны возвращать такое же количество столбцов. Если запросы возвращают разное количество столбцов, происходит сбой выполнения задачи. Тем не менее, даже в случае сбоя выполнения задачи ее запросы, такие как DELETE или INSERT могут быть выполнены успешно.  
  
-   Если в результирующих связываниях участвуют имена столбцов, запросы должны возвращать столбцы с такими же именами, как в результирующем наборе, используемом задачей. Если столбцы отсутствуют, происходит сбой выполнения задачи.  
  
-   Если в задаче используются связывания параметров, у всех запросов в пакете должны быть одинаковые типы параметров и их количество.  
  
## <a name="run-parameterized-sql-commands"></a>Выполнение параметризованных команд SQL  
 В инструкциях SQL и хранимых процедурах часто используются входные параметры, выходные параметры и коды возврата. Задача «Выполнение SQL» поддерживает типы параметров **Input**, **Output**и **ReturnValue** . Используйте тип **Input** для входных параметров, **Output** — для выходных и **ReturnValue** — для кодов возврата.  
  
> [!NOTE]  
>  В задаче «Выполнение SQL» параметры могут использоваться, только если их поддерживает поставщик данных.  
  
## <a name="specify-a-result-set-type"></a>Указание типа результирующего набора  
 В зависимости от команды SQL задаче «Выполнение SQL» может быть возвращен (или не возвращен) результирующий набор. Например, инструкция SELECT обычно возвращает результирующий набор, а инструкция INSERT нет. Результирующий набор инструкции SELECT может не содержать ни одной строки, содержать одну строку или несколько строк. Хранимые процедуры возвращают целочисленные значения, называемые кодом возврата, который отражает состояние выполнения процедуры. В этом случае результирующий набор состоит из одной строки.  
  
## <a name="configure-the-execute-sql-task"></a>Настройка задачи "Выполнение SQL"  
 Настроить задачу «Выполнение SQL» можно одним из следующих способов:  
  
-   Указать тип диспетчера соединений для подключения к базе данных.  
  
-   Указать тип результирующего набора, возвращаемого инструкцией SQL.  
  
-   Указать время ожидания для инструкции SQL.  
  
-   Указать источник для инструкции SQL.  
  
-   Указать, должна ли задача пропустить фазу подготовки инструкции SQL.  
  
-   При использовании типа соединения ADO необходимо указать, является ли инструкция SQL хранимой процедурой. Для других типов соединений это свойство доступно только для чтения и всегда имеет значение **false**.  
  
 Свойства задаются программно или через конструктор служб [!INCLUDE[ssIS](../../includes/ssis-md.md)] .  

## <a name="general-page---execute-sql-task-editor"></a>Страница "Общие" — редактор задачи "Выполнение SQL"
 Используйте страницу **Общие** диалогового окна **Редактор задачи «Выполнение SQL»** для настройки задачи «Выполнение SQL» и формирования инструкции SQL, которую запускает задача.  

Дополнительные сведения о языке Transact-SQL см. в [Справочнике по Transact-SQL (компонент Database Engine)](../../t-sql/language-reference.md).  
  
### <a name="static-options"></a>Статические параметры  
 **имя**;  
 Укажите уникальное имя для задачи «Выполнение SQL» в рабочем процессе. Предоставляемое имя будет отображаться в конструкторе служб [!INCLUDE[ssIS](../../includes/ssis-md.md)] .  
  
 **Описание**  
 Приведите описание задачи «Выполнение SQL». Рекомендуется описать назначение задачи, чтобы сделать пакеты самодокументируемыми и более простыми в обслуживании.  
  
 **Время ожидания**  
 Укажите максимальное число секунд времени работы задачи перед истечением времени ожидания. Значение 0 указывает на бесконечное время работы. Значение по умолчанию равно 0.  
  
> [!NOTE]  
>  Хранимые процедуры не завершаются по истечении времени ожидания, если в них моделируются функции ожидания при помощи предоставления времени для выполнения соединений и завершения транзакций, большего, чем время в секундах, задаваемое параметром **Время ожидания**. Однако хранимые процедуры, выполняющие запросы, всегда ограничены по времени, что задается параметром **Время ожидания**.  
  
 **CodePage**  
 Укажите кодовую страницу, используемую при преобразовании значений переменных в Юникоде. По умолчанию используется кодовая страница локального компьютера.  
  
> [!NOTE]  
>  Если задача «Выполнение SQL» использует диспетчер соединений ADO или ODBC, свойство **Кодовая страница** недоступно. Если решению необходимо использовать кодовую страницу, с задачей «Выполнение SQL» следует применять диспетчер соединений OLE DB или ADO.NET.  
  
 **TypeConversionMode**  
 Когда этому свойству задается значение **Разрешено**, задача "Выполнение SQL" пытается преобразовать выходной параметр и результаты запроса в тип данных переменной, к которой относятся эти результаты. Это относится к типу результирующего набора **Одна строка** .  
  
 **ResultSet**  
 Укажите ожидаемый тип результата выполнения инструкции SQL. Выберите из **Одна строка**, **Полный результирующий набор**, **XML**или **Нет**.  
  
 **ConnectionType**  
 Выберите тип, используемый диспетчером соединений для соединения с источником данных. В качестве возможных типов соединения могут быть: **OLE DB**, **ODBC**, **ADO**, **ADO.NET** и **SQLMOBILE**.  
  
 **См. также:** подробные сведения о [диспетчере подключений OLE DB](../../integration-services/connection-manager/ole-db-connection-manager.md), [диспетчере подключений ODBC](../../integration-services/connection-manager/odbc-connection-manager.md), [диспетчере подключений ADO](../../integration-services/connection-manager/ado-connection-manager.md), [диспетчере подключений ADO.NET](../../integration-services/connection-manager/ado-net-connection-manager.md), [диспетчере подключений SQL Server Compact Edition](../../integration-services/connection-manager/sql-server-compact-edition-connection-manager.md).  
  
 **Соединение**  
 Выберите соединение из списка определенных диспетчеров соединений. Для создания подключения выберите \<**New connection...**>.  
  
 **SQLSourceType**  
 Выберите тип источника для инструкции SQL, выполняемой этой задачей.  
  
 В зависимости от типа диспетчера соединений, используемого задачей «Выполнение SQL», в параметризованных инструкциях SQL необходимо использовать определенные маркеры параметров.    
  
 Это свойство имеет параметры, указанные в следующей таблице.  
  
|Значение|Описание|  
|-----------|-----------------|  
|**Прямой ввод**|Задайте источник для инструкции Transact-SQL. При выборе этого значения отображается динамический параметр **SQLStatement**.|  
|**Соединение с файлом**|Выберите файл, содержащий инструкцию Transact-SQL. При установке этого параметра отображается динамический параметр **Подключение файла**.|  
|**Переменная**|В качестве источника задайте переменную, определяющую инструкцию Transact-SQL. При выборе этого значения отображается динамический параметр **SourceVariable**.|  
  
 **QueryIsStoredProcedure**  
 Указывает, является ли заданная для запуска инструкция SQL хранимой процедурой. Если задача использует диспетчер соединений ADO, это свойство доступно только для чтения и записи. В противном случае свойство доступно только для чтения и имеет значение **false**.  
  
 **BypassPrepare**  
 Укажите, нужно ли разработать инструкцию SQL.  **true** ― пропустить подготовку; **false** ― подготовить инструкцию SQL перед выполнением. Этот параметр доступен только с соединениями OLE DB, поддерживающими подготовку.  
  
 **См. также:**  [Подготовленное выполнение](../../relational-databases/native-client-odbc-queries/executing-statements/prepared-execution.md)  
  
 **Обзор**  
 Укажите расположение файла, содержащего инструкцию SQL, при помощи диалогового окна **Открыть** . Выберите файл, содержимое которого копируется как инструкция SQL в свойство **SQLStatement** .  
  
 **Создать запрос**  
 Создайте инструкцию SQL при помощи диалогового окна **Построитель запросов** , графического средства для создания запросов. Этот параметр доступен, если параметр **SQLSourceType** установлен в значение **Прямой ввод**.  
  
 **Анализ запроса**  
 Проверьте синтаксис инструкции SQL.  
  
### <a name="sqlsourcetype-dynamic-options"></a>Динамические параметры SQLSourceType  
  
#### <a name="sqlsourcetype--direct-input"></a>WQLQuerySource = Прямой ввод  
 **SQLStatement**  
 Введите инструкцию SQL для выполнения в окне параметров или нажмите кнопку обзора (...) для ввода инструкции SQL в диалоговом окне **Ввод SQL-запроса**, либо нажмите кнопку **Создать запрос** для составления инструкции при помощи диалогового окна **Построитель запросов**.  
  
 **См. также:** [Построитель запросов](../integration-services-ssis-queries.md)  
  
#### <a name="sqlsourcetype--file-connection"></a>WQLQuerySource = Подключение файла  
 **FileConnection**  
 Выберите существующий диспетчер подключений файлов или создайте его, щелкнув пункт \<**New connection...**>.  
  
 **См. также:** подробные сведения о [диспетчере файловых подключений](../../integration-services/connection-manager/file-connection-manager.md) и о [редакторе диспетчера файловых подключений](../connection-manager/file-connection-manager.md).  
  
#### <a name="sqlsourcetype--variable"></a>SQLSourceType = Переменная  
 **SourceVariable**  
 Выберите существующую переменную или щелкните \<**New variable...**>, чтобы создать новую.  
  
 **См. также:** подробные сведения о [переменных в службах Integration Services &#40;SSIS&#41;](../../integration-services/integration-services-ssis-variables.md) и о [добавлении переменной](../integration-services-ssis-variables.md).  
 
## <a name="parameter-mapping-page---execute-sql-task-editor"></a>Страница "Сопоставление параметров" — редактор задачи "Выполнение SQL"
Используйте страницу **Сопоставление параметров** диалогового окна **Редактор задачи «Выполнение SQL»** для сопоставления переменных с параметрами в инструкции SQL.  
  
### <a name="options"></a>Параметры  
 **Имя переменной**  
 Добавив сопоставление параметров нажатием кнопки **Добавить**, выберите системную или определяемую пользователем переменную в списке или щелкните \<**New variable...**> для добавления новой переменной с помощью диалогового окна **Добавление переменной**.  
  
 **См. также:** [Переменные в службах Integration Services (SSIS)](../../integration-services/integration-services-ssis-variables.md)  
  
 **Направление**  
 Выбор направления для параметра. Сопоставьте каждую переменную с входным параметром, выходным параметром или кодом возврата.  
  
 **Тип данных**  
 Выберите тип данных для параметра. Список доступных типов данных зависит от поставщика, который был выбран в диспетчере соединений, используемом задачей.  
  
 **Имя параметра**  
 Введите имя параметра.  
  
 В зависимости от типа диспетчера соединений, используемого задачей, необходимо использовать числа или имена параметра. Для некоторых типов диспетчеров соединений требуется, чтобы в качестве первого символа имени параметра использовался символ \@, а в качестве имен параметров использовались определенные имена, например \@Param1, или имена столбцов.  
  
 **Размер параметра**  
 Укажите размер для параметров, имеющих переменную длину, например, строк и двоичных полей.  
  
 Эта настройка гарантирует, что поставщик выделит достаточное пространство для значений параметров изменяемой длины.  
  
 **Добавление**  
 Нажмите для добавления сопоставления параметра.  
  
 **Удалить**  
 Выберите сопоставление параметра из списка, затем нажмите **Удалить**.  
 
## <a name="result-set-page---execute-sql-task-editor"></a>Страница "Результирующий набор" — редактор задачи "Выполнение SQL"
Страница **Результирующий набор** диалогового окна **Редактор задачи «Выполнение SQL»** применяется для сопоставления результатов инструкции SQL с новыми или существующими переменными. Эти параметры в диалоговом окне отключены, если параметр **Результирующий набор** на странице «Общие» установлен в **Нет**.  
  
### <a name="options"></a>Параметры  
 **Имя результата**  
 После того как с помощью кнопки **Добавить**было добавлено сопоставление результирующего набора, укажите имя результата. В зависимости от типа результирующего набора необходимо использовать определенные имена результирующих наборов.  
  
 Если тип результирующего набора **Одна строка**, то можно использовать имя столбца, возвращаемого запросом, или число, указывающее положение столбца в списке столбцов, возвращаемых запросом.  
  
 Если результирующий набор имеет тип **Полный результирующий набор** или **XML**, то в качестве имени результирующего набора необходимо использовать 0.  
 
  
 **Имя переменной**  
 Для сопоставления результирующего набора с переменной выберите ее или щелкните \<**New variable...**>, чтобы добавить новую переменную с помощью диалогового окна **Добавление переменной**.  
  
 **Добавление**  
 Нажмите кнопку, чтобы добавить сопоставление результирующего набора.  
  
 **Удалить**  
 Выберите в списке сопоставление результирующего набора и нажмите кнопку **Удалить**.  
 
## <a name="parameters-in-the-execute-sql-task"></a>Параметры в задаче "Выполнение SQL"
В инструкциях SQL и хранимых процедурах часто используются входные параметры **input** , выходные параметры **output** и коды возврата. В [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] задача "Выполнение SQL" поддерживает типы параметров **Input**, **Output** и **ReturnValue**. Используйте тип **Input** для входных параметров, **Output** — для выходных и **ReturnValue** — для кодов возврата.  
  
> [!NOTE]  
>  В задаче «Выполнение SQL» параметры могут использоваться, только если их поддерживает поставщик данных.  
  
 Параметры команд SQL, включая запросы и хранимые процедуры, сопоставлены с пользовательскими переменными, созданными в области задачи «Выполнение SQL», в области родительского контейнера или в области пакета. Значения переменных можно задать во время разработки или динамически заполнить во время выполнения. Также можно сопоставить параметры системным переменным. Дополнительные сведения см. в разделах [Переменные в службах Integration Services (SSIS)](../../integration-services/integration-services-ssis-variables.md) и [Системные переменные](../../integration-services/system-variables.md).  
  
 Однако для работы с параметрами и кодами возврата задачи «Выполнение SQL» необходимо знать больше, чем поддерживаемые задачей типы параметров и как сопоставлены эти параметры. Существуют дополнительные требования и рекомендации для успешного использования параметров и кодов возврата в задаче «Выполнение SQL». В оставшейся части раздела приведены эти требования и рекомендации.  
  
-   [Применение имен и маркеров параметров](#Parameter_names_and_markers)  
  
-   [Использование параметров с типами данных даты и времени](#Date_and_time_data_types)  
  
-   [Использование параметров в предложениях WHERE](#WHERE_clauses)  
  
-   [Использование параметров с хранимыми процедурами](#Stored_procedures)  
  
-   [Возвращение значений кодов возврата](#Return_codes)    
  
###  <a name="parameter-names-and-markers"></a><a name="Parameter_names_and_markers"></a> Имена и маркеры параметров  
 В зависимости от типа соединения, который использует задача «Выполнение SQL», синтаксис команды SQL использует различные маркеры параметров. Например, для типа диспетчера подключений [!INCLUDE[vstecado](../../includes/vstecado-md.md)] требуется, чтобы команда SQL использовала маркер параметра в формате **\@varParameter**, в то время как для типа OLE DB требуется, чтобы в качестве маркера параметра использовался символ вопросительного знака (?).  
  
 Имена, которые можно использовать как имена параметров в сопоставлениях между переменными и параметрами, также зависят от типа диспетчера соединений. Например, тип диспетчера подключений [!INCLUDE[vstecado](../../includes/vstecado-md.md)] использует определенные пользователем имена, начинающиеся с префикса \@, в то время как для типа OLE DB требуется, чтобы в качестве имени параметра использовалось числовое значение (начинающееся с нуля).  
  
 В следующей таблице подведен итог требованиям для команд SQL для различных типов диспетчеров соединений, которые может использовать задача «Выполнение SQL».  
  
|Тип соединений|Маркер параметра|Имя параметра|Пример команды SQL|  
|---------------------|----------------------|--------------------|-------------------------|  
|ADO|?|Param1, Param2, …|SELECT FirstName, LastName, Title FROM Person.Contact WHERE ContactID = ?|  
|[!INCLUDE[vstecado](../../includes/vstecado-md.md)]|\@\<parameter name>|\@\<parameter name>|SELECT FirstName, LastName, Title FROM Person.Contact WHERE ContactID = \@parmContactID|  
|ODBC|?|1, 2, 3, ...|SELECT FirstName, LastName, Title FROM Person.Contact WHERE ContactID = ?|  
|EXCEL и OLE DB|?|0, 1, 2, 3, ...|SELECT FirstName, LastName, Title FROM Person.Contact WHERE ContactID = ?|  
  
#### <a name="use-parameters-with-adonet-and-ado-connection-managers"></a>Использование параметров с диспетчерами подключений ADO и ADO.NET  
 Диспетчеры подключений [!INCLUDE[vstecado](../../includes/vstecado-md.md)] и ADO предъявляют особые требования к командам SQL, использующим параметры:  
  
-   Диспетчер соединений [!INCLUDE[vstecado](../../includes/vstecado-md.md)] требует, чтобы команда SQL использовала имена параметров в качестве маркеров параметров. Это означает, что переменные могут быть прямо сопоставлены с параметрами. Например, переменная `@varName` сопоставляется с параметром по имени `@parName` и предоставляет значение параметру `@parName`.  
  
-   Диспетчеры соединений ADO требуют, чтобы в команде SQL в качестве маркеров параметров использовались вопросительные знаки (?). Однако в качестве имен параметров можно использовать любые имена, за исключением целых чисел.  
  
 Чтобы предоставить параметрам значения, переменные сопоставляются с именами параметров. Затем задача «Выполнение SQL» использует для загрузки значений из переменных параметры значения порядкового номера имени параметра в списке параметров.  
  
#### <a name="use-parameters-with-excel-odbc-and-ole-db-connection-managers"></a>Использование параметров с диспетчерами подключений EXCEL, ODBC и OLE DB  
 Диспетчеры соединений EXCEL, ODBC и OLE DB требуют, чтобы команды SQL использовали символы знака вопроса (?) в качестве маркеров параметров и числовые значения (начиная с нуля или с единицы) в качестве имен параметров. Если задача «Выполнение SQL» использует диспетчер соединений ODBC, то именем параметра, сопоставляемым первому параметру в запросе, является 1. В противном случае именем параметра будет 0. Для последующих параметров числовое значение имени параметра указывает на параметр в команде SQL, которому сопоставлено это имя параметра. Например, параметр под именем 3 сопоставлен с третьим параметром, который представляется третьим знаком вопроса (?) в команде SQL.  
  
 Чтобы предоставить параметрам значения, переменные сопоставляются с именами параметров и задача «Выполнение SQL» использует порядковое значение имени параметра для загрузки значения из переменных в параметры.  
  
 В зависимости от поставщика, который используют диспетчеры соединений, некоторые типы данных OLE DB могут не поддерживаться. Например, драйвер Excel распознает только ограниченный набор типов данных. Дополнительные сведения о поведении поставщика Jet с драйвером Excel см. в разделе [Excel Source](../../integration-services/data-flow/excel-source.md).  
  
#### <a name="use-parameters-with-ole-db-connection-managers"></a>Использование параметров с диспетчерами подключений OLE DB  
 Если в задаче "Выполнение SQL" используется диспетчер соединений OLE DB, становится доступным свойство BypassPrepare задачи. Этому свойству необходимо присвоить значение **true** , если задача «Выполнение SQL» использует инструкции SQL с параметрами.  
  
 При использовании диспетчера соединений OLE DB нельзя применять параметризованные вложенные запросы, поскольку в задаче «Выполнение SQL» нельзя получить путем анализа информацию о параметрах через поставщик OLE DB. Однако можно использовать выражение, чтобы объединить значения параметров в строку запроса и задать свойство SqlStatementSource этой задачи.  
  
###  <a name="use-parameters-with-date-and-time-data-types"></a><a name="Date_and_time_data_types"></a> Использование параметров с типами данных даты и времени  
  
#### <a name="use-date-and-time-parameters-with-adonet-and-ado-connection-managers"></a>Использование параметров даты и времени с диспетчерами подключений ADO и ADO.NET  
 При считывании данных типов [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , **time** и **datetimeoffset**, задача "Выполнение SQL", которая использует диспетчер соединений [!INCLUDE[vstecado](../../includes/vstecado-md.md)] или ADO, имеет следующие дополнительные требования:  
  
-   Диспетчер соединений [!INCLUDE[vstecado](../../includes/vstecado-md.md)] требует, чтобы данные типа **time** хранились в параметре типа **Input** или **Output**, имеющем тип данных **string**.  
  
-   Для данных типа **datetimeoffset** диспетчер соединений [!INCLUDE[vstecado](../../includes/vstecado-md.md)] требует, чтобы они хранились в одном из следующих параметров:  
  
    -   Параметр типа **Input** имеет тип данных **string**.  
  
    -   Параметр типа **Output** или **ReturnValue**имеет тип данных **datetimeoffset**, **string**или **datetime2**. Если выбран параметр с типом данных **string** или **datetime2**, то службы [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] преобразуют данные в тип string или datetime2.  
  
-   Диспетчер соединений ADO требует, чтобы данные **time** или **datetimeoffset** хранились в параметре типа **Input** или **Output**, имеющем тип данных **adVarWchar**.  
  
 Дополнительные сведения о типах данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и их сопоставлении с типами данных [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] см. в разделе [Типы данных (Transact-SQL)](../../t-sql/data-types/data-types-transact-sql.md) и [Типы данных службы Integration Services](../../integration-services/data-flow/integration-services-data-types.md).  
  
#### <a name="use-date-and-time-parameters-with-ole-db-connection-managers"></a>Использование параметров даты и времени с диспетчерами подключений OLE DB  
 При использовании диспетчера соединений OLE DB задача "Выполнение SQL" имеет особые требования по хранению данных типа данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] : **date**, **time**, **datetime**, **datetime2**и **datetimeoffset**. Эти данные необходимо хранить в параметре одного из следующих типов.  
  
-   Входной параметр типа данных NVARCHAR.  
  
-   Выходной параметр соответствующего типа данных, как показано в следующей таблице.  
  
    |Тип параметра**Output**|Тип данных «date»|  
    |-------------------------------|--------------------|  
    |DBDATE|**date**|  
    |DBTIME2|**time**|  
    |DBTIMESTAMP|**datetime**, **datetime2**|  
    |DBTIMESTAMPOFFSET|**datetimeoffset**|  
  
 Если данные не хранятся в соответствующем входном или выходном параметре, выполнение пакета завершается с ошибкой.  
  
#### <a name="use-date-and-time-parameters-with-odbc-connection-managers"></a>Использование параметров даты и времени с диспетчерами подключений ODBC  
 При использовании диспетчера соединений ODBC задача "Выполнение SQL" имеет особые требования по хранению данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] одного из следующих типов: **date**, **time**, **datetime**, **datetime2**или **datetimeoffset**. Эти данные необходимо хранить в параметре одного из следующих типов.  
  
-   Входной параметр **input** типа данных SQL_WVARCHAR.  
  
-   Выходной параметр **output** соответствующего типа данных, как показано в следующей таблице.  
  
    |Тип параметра**Output**|Тип данных «date»|  
    |-------------------------------|--------------------|  
    |SQL_DATE|**date**|  
    |SQL_SS_TIME2|**time**|  
    |SQL_TYPE_TIMESTAMP<br /><br /> -или-<br /><br /> SQL_TIMESTAMP|**datetime**, **datetime2**|  
    |SQL_SS_TIMESTAMPOFFSET|**datetimeoffset**|  
  
 Если данные не хранятся в соответствующем входном или выходном параметре, выполнение пакета завершается с ошибкой.  
  
###  <a name="use-parameters-in-where-clauses"></a><a name="WHERE_clauses"></a> Использование параметров в предложениях WHERE  
 Команды SELECT, INSERT, UPDATE и DELETE часто включают в себя предложение WHERE для задания фильтров, которые определяют условия, которым должна удовлетворять каждая строка в исходной таблице, чтобы попасть под действие команды SQL. Параметры предоставляют значения фильтра в предложениях WHERE.  
  
 Можно использовать маркеры параметров для динамического предоставления значений параметрам. Правила для каждого маркера параметра и имени параметра, которые могут быть использованы в инструкции SQL, зависят от типа диспетчера соединений, который используется задачей «Выполнение SQL».  
  
 В следующей таблице приведен список примеров команды SELECT для разных типов диспетчеров соединений. Те же самые правила относятся и к инструкциям INSERT, UPDATE и DELETE. В примерах инструкции SELECT возвращают из таблицы **Product** базы данных [!INCLUDE[ssSampleDBUserInputNonLocal](../../includes/sssampledbuserinputnonlocal-md.md)] продукты, для которых значение **ProductID** больше и меньше значений, указанных двумя параметрами.  
  
|Тип соединений|Синтаксис SELECT|  
|---------------------|-------------------|  
|EXCEL, ODBC и OLEDB|`SELECT* FROM Production.Product WHERE ProductId > ? AND ProductID < ?`|  
|ADO|`SELECT* FROM Production.Product WHERE ProductId > ? AND ProductID < ?`|  
|[!INCLUDE[vstecado](../../includes/vstecado-md.md)]|`SELECT* FROM Production.Product WHERE ProductId > @parmMinProductID AND ProductID < @parmMaxProductID`|  
  
 Для примеров необходимы параметры со следующими именами.  
  
-   Диспетчеры соединений EXCEL и OLED DB используют параметры с именами 0 и 1. Для типа соединения ODBC понадобятся параметры с именами 1 и 2.  
  
-   Для типа соединения ADO можно использовать любые два имени параметра, такие как Param1 и Param2, но эти параметры должны быть сопоставлены со своими порядковыми номерами в списке параметров.  
  
-   Для типа соединения [!INCLUDE[vstecado](../../includes/vstecado-md.md)] используются имена параметров \@parmMinProductID и \@parmMaxProductID.  
  
###  <a name="use-parameters-with-stored-procedures"></a><a name="Stored_procedures"></a> Использование параметров с хранимыми процедурами  
 В командах SQL, выполняющих хранимые процедуры, тоже может использоваться сопоставление параметров. Правила использования маркеров и имен параметров зависят от типа диспетчера соединений, который используется задачей «Выполнение SQL», точно так же, как и правила для параметризованных запросов.  
  
 В следующей таблице приведен список примеров команды EXEC для разных типов диспетчеров соединений. Примеры выполняют хранимую процедуру **uspGetBillOfMaterials** в базе данных [!INCLUDE[ssSampleDBUserInputNonLocal](../../includes/sssampledbuserinputnonlocal-md.md)]. Хранимая процедура использует параметры `@StartProductID` и `@CheckDate` **input**.  
  
|Тип соединений|Синтаксис EXEC|  
|---------------------|-----------------|  
|EXCEL и OLEDB|`EXEC uspGetBillOfMaterials ?, ?`|  
|ODBC|`{call uspGetBillOfMaterials(?, ?)}`<br /><br /> Дополнительные сведения о синтаксисе вызова ODBC см. в разделе [Параметры процедур](../../odbc/reference/develop-app/procedure-parameters.md)справочника по программированию ODBC в библиотеке MSDN.|  
|ADO|Если для параметра IsQueryStoredProcedure задано значение **False**, `EXEC uspGetBillOfMaterials ?, ?`<br /><br /> Если для параметра IsQueryStoredProcedure задано значение **True**, `uspGetBillOfMaterials`|  
|[!INCLUDE[vstecado](../../includes/vstecado-md.md)]|Если для параметра IsQueryStoredProcedure задано значение **False**, `EXEC uspGetBillOfMaterials @StartProductID, @CheckDate`<br /><br /> Если для параметра IsQueryStoredProcedure задано значение **True**, `uspGetBillOfMaterials`|  
  
 Чтобы использовать выходные параметры, синтаксис требует, чтобы ключевое слово OUTPUT следовало за каждым маркером параметров. Например, следующий синтаксис выходного параметра является верным: `EXEC myStoredProcedure ? OUTPUT`.  
  
 Дополнительные сведения об использовании входных и выходных параметров с хранимыми процедурами Transact-SQL см. в разделе [EXECUTE (Transact-SQL)](../../t-sql/language-elements/execute-transact-sql.md).  
 
### <a name="map-query-parameters-to-variables"></a>Сопоставление параметров запросов с переменными
Этот раздел описывает использование параметризованной инструкции SQL в задаче "Выполнение SQL" и создание сопоставлений между переменными и параметрами в инструкции SQL.  
  
1.  В среде [!INCLUDE[ssBIDevStudioFull](../../includes/ssbidevstudiofull-md.md)]откройте необходимый пакет служб [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] .  
  
2.  Чтобы открыть пакет, дважды щелкните его в обозревателе решений.  
  
3.  Перейдите на вкладку **Поток управления** .  
  
4.  Если пакет не включает задачу «Выполнение SQL», добавьте его к потоку управления пакета. Дополнительные сведения см. в разделе [Добавление задачи или контейнера в поток управления или удаление их из него](../../integration-services/control-flow/add-or-delete-a-task-or-a-container-in-a-control-flow.md).  
  
5.  Дважды щелкните задачу «Выполнение SQL».  
  
6.  Введите параметризированную команду SQL одним из следующих способов.  
  
    -   Используйте прямой ввод и введите команду SQL в свойство SQLStatement.  
  
    -   Используйте прямой ввод, нажмите кнопку **Создать запрос**и создайте команду SQL, используя графические средства, предоставляемые построителем запросов.  
  
    -   Используйте подключение файла и укажите ссылку на файл, содержащий команду SQL.  
  
    -   Используйте переменную и укажите ссылку на переменную, содержащую команду SQL.  
  
     Маркеры параметров, которые используются в параметризованных инструкциях SQL, зависят от типа соединения, используемого задачей «Выполнение SQL».  
  
    |Тип соединений|Маркер параметра|  
    |---------------------|----------------------|  
    |ADO|?|  
    |ADO.NET и SQLMOBILE|\@\<parameter name>|  
    |ODBC|?|  
    |EXCEL и OLE DB|?|  
  
     В следующей таблице приведен список примеров команды SELECT для разных типов диспетчеров соединений. Параметры предоставляют значения фильтра в предложениях WHERE. В примерах инструкции SELECT возвращают из таблицы **Product** базы данных [!INCLUDE[ssSampleDBUserInputNonLocal](../../includes/sssampledbuserinputnonlocal-md.md)] продукты, для которых значение **ProductID** больше и меньше значений, указанных двумя параметрами.  
  
    |Тип соединений|Синтаксис SELECT|  
    |---------------------|-------------------|  
    |EXCEL, ODBC и OLEDB|`SELECT* FROM Production.Product WHERE ProductId > ? AND ProductID < ?`|  
    |ADO|`SELECT* FROM Production.Product WHERE ProductId > ? AND ProductID < ?`|  
    |[!INCLUDE[vstecado](../../includes/vstecado-md.md)]|`SELECT* FROM Production.Product WHERE ProductId > @parmMinProductID AND ProductID < @parmMaxProductID`|  
   
7.  Щелкните **Сопоставление параметров**.  
  
8.  Чтобы добавить сопоставление параметров, нажмите кнопку **Добавить**.  
  
9. Введите имя в поле **Имя параметра** .  
  
     Имена параметров зависят от типа соединения, используемого задачей «Выполнение SQL».  
  
    |Тип соединений|Имя параметра|  
    |---------------------|--------------------|  
    |ADO|Param1, Param2, …|  
    |ADO.NET и SQLMOBILE|\@\<parameter name>|  
    |ODBC|1, 2, 3, ...|  
    |EXCEL и OLE DB|0, 1, 2, 3, ...|  
  
10. Выберите переменную из списка **Имя переменной** . Дополнительные сведения см. в разделе [Добавление, удаление и изменение области определяемой пользователем переменной в пакете](../integration-services-ssis-variables.md).  
  
11. В списке **Направление** укажите, является ли параметр входом, выходом или возвращаемым значением.  
  
12. В списке **Тип данных** укажите тип данных параметра.  
  
    > [!IMPORTANT]  
    >  Тип данных параметра должен быть совместим с типом данных переменной.  
  
13. Повторите шаги с 8 по 11 для каждого параметра инструкции SQL.  
  
    > [!IMPORTANT]  
    >  Порядок сопоставления параметров должен соответствовать порядку, в котором параметры появляются в инструкции SQL.  
  
14. Нажмите кнопку **ОК**.  

##  <a name="get-the-values-of-return-codes"></a><a name="Return_codes"></a> Возвращение значений кодов возврата  
 Хранимая процедура может возвращать целочисленное значение, называемое кодом возврата, чтобы указать состояние выполнения процедуры. Чтобы реализовать коды возврата в задаче «Выполнение SQL», используйте параметры типа **ReturnValue** .  
  
 В следующей таблице приведен список типов соединений с примерами команды EXEC, которая реализует коды возврата. Все примеры используют входной параметр **input** . Правила использования маркеров параметров и имен параметров одинаковы для всех типов параметров: **Input**, **Output** и **ReturnValue**.  
  
 Некоторые типы синтаксиса не поддерживают литералы параметров. В этом случае необходимо предоставить значение параметра с помощью переменной.  
  
|Тип соединений|Синтаксис EXEC|  
|---------------------|-----------------|  
|EXCEL и OLEDB|`EXEC ? = myStoredProcedure 1`|  
|ODBC|`{? = call myStoredProcedure(1)}`<br /><br /> Дополнительные сведения о синтаксисе вызова ODBC см. в разделе [Параметры процедур](../../odbc/reference/develop-app/procedure-parameters.md)справочника по программированию ODBC в библиотеке MSDN.|  
|ADO|Если для параметра IsQueryStoreProcedure задано значение **False**, `EXEC ? = myStoredProcedure 1`<br /><br /> Если для параметра IsQueryStoreProcedure задано значение **True**, `myStoredProcedure`|  
|[!INCLUDE[vstecado](../../includes/vstecado-md.md)]|Для параметра IsQueryStoreProcedure задано значение **True**.<br /><br /> `myStoredProcedure`|  
  
 В описании синтаксиса, показанном в предыдущей таблице, задача «Выполнение SQL» использует для запуска хранимой процедуры тип источника **Прямой ввод** . Задача «Выполнение SQL» может также пользоваться для выполнения хранимой процедуры типом источника **Соединение с файлом** . Независимо от того, какой тип источника использует задача «Выполнение SQL» — **Прямой ввод** или **Соединение с файлом** , для реализации кода возврата используйте параметр типа **ReturnValue** .
  
 Дополнительные сведения об использовании кодов возврата с хранимыми процедурами Transact-SQL см. в разделе [RETURN (Transact-SQL)](../../t-sql/language-elements/return-transact-sql.md).  
  
## <a name="result-sets-in-the-execute-sql-task"></a>Результирующие наборы в задаче "Выполнение SQL"
 В пакете служб [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] возвращение результирующего набора задаче «Выполнение SQL» зависит от типа команды SQL, используемого задачей. Например, инструкция SELECT обычно возвращает результирующий набор, а инструкция INSERT нет.  
  
 Содержимое результирующего набора также различается в зависимости от команды SQL. Например, результирующий набор инструкции SELECT может не содержать ни одной строки, содержать одну строку или несколько строк. Тем не менее результирующий набор инструкции SELECT, возвращающий счетчик или сумму, содержит только одну строку.  
  
 Чтобы работать с результирующими наборами в задаче «Выполнение SQL», требуется большее, чем просто знать, возвращает ли команда SQL результирующий набор и что он содержит. Существуют дополнительные требования и рекомендации для успешного использования результирующих наборов в задаче «Выполнение SQL». В оставшейся части раздела приведены эти требования и рекомендации.  
  
-   [Указание типа результирующего набора](#Result_set_type)  
  
-   [Заполнение переменной из результирующего набора](#Populate_variable_with_result_set)  
  
###  <a name="specify-a-result-set-type"></a><a name="Result_set_type"></a> Указание типа результирующего набора  
 Задание "Выполнение SQL" поддерживает следующие типы наборов результатов:  
  
-   Если запрос не возвращает результатов, используется результирующий набор **Нет** . Например, этот результирующий набор используется для запросов, которые добавляют, изменяют или удаляют записи в таблице.  
  
-   Если запрос возвращает только одну строку, используется результирующий набор **Единственная строка** . Например, этот результирующий набор используется для инструкции SELECT, возвращающей счетчик или сумму.  
  
-   Если запрос возвращает несколько строк, используется результирующий набор **Полный результирующий набор** . Этот результирующий набор используется, например, для инструкции SELECT, получающей все строки таблицы.  
  
-   Если запрос возвращает результат в формате XML, используется результирующий набор **XML** . Этот результирующий набор используется, например, для инструкции SELECT, содержащей предложение FOR XML.  
  
 Если в задаче «Выполнение SQL» используется результирующий набор **Полный результирующий набор** и запрос возвращает несколько наборов строк, задача вернет только первый набор строк. Если этот набор строк формирует ошибку, задача сообщает об ошибке. Если другие наборы строк выдают ошибки, задача не сообщает о них.  
  
###  <a name="populate-a-variable-with-a-result-set"></a><a name="Populate_variable_with_result_set"></a> Заполнение переменной из результирующего набора  
 Результирующий набор, возвращаемый запросом, можно связать с определяемой пользователем переменной, если он содержит одну строку, набор строк или данные в формате XML.  
  
 Если результирующего набора имеет тип **Одна строка**, столбец из возвращаемого результата можно связать с переменной с помощью имени столбца в качестве имени результирующего набора либо в качестве имени результирующего набора можно использовать порядковый номер столбца в списке столбцов. Например, именем результирующего набора в запросе `SELECT Color FROM Production.Product WHERE ProductID = ?` может быть **Color** или **0**. Если запрос возвращает несколько столбцов и необходимо получить доступ к значениям во всех столбцах, необходимо каждый столбец связать с отдельной переменной. Если столбцы сопоставляются с переменными с помощью чисел в качестве имени результирующего набора, эти числа отражают порядок, в котором столбцы расположены в списке столбцов запроса. Например, в запросе `SELECT Color, ListPrice, FROM Production.Product WHERE ProductID = ?`0 используется для столбца **Color** и 1 — для столбца **ListPrice** . Возможность использовать имя столбца в качестве имени результирующего набора зависит от поставщика, для работы с которым настроена задача. Не все поставщики разрешают использовать имена столбцов.  
  
 Некоторые запросы, которые возвращают одно значение, могут не включать имена столбцов. Например, инструкция `SELECT COUNT (*) FROM Production.Product` не возвращает имя столбца. Можно получить доступ к возвращаемому результату, используя порядковый номер позиции 0 в качестве имени результата. Чтобы получить доступ к результату по имени столбца, запрос должен включать предложение AS \<alias name> для предоставления имени столбца. Инструкция `SELECT COUNT (*)AS CountOfProduct FROM Production.Product`предоставляет столбец **CountOfProduct** . Затем можно получить доступ к столбцу возвращенного результата, используя имя столбца **CountOfProduct** или порядковый номер позиции 0.  
  
 Если результирующий набор имеет тип **Полный результирующий набор** или **XML**, то в качестве имени результирующего набора необходимо использовать 0.  
  
 При сопоставлении переменной результирующему набору типа **Единственная строка** тип переменной должен быть совместим с типом данных столбца, содержащегося в результирующем наборе. Например, если результирующий набор содержит столбец с типом данных **String** , его нельзя сопоставить переменной с числовым типом данных. Когда свойству **TypeConversionMode** задается значение **Allowed**, задача «Выполнение SQL» пытается преобразовать выходной параметр и результаты запроса в тип данных переменной, к которой относятся эти результаты.  
  
 Результирующий набор в формате XML может быть сопоставлен только переменной с типом данных **String** или **Object** . Если переменная имеет тип данных **String** , задача «Выполнение SQL» возвращает строковое значение и источник XML может использовать XML-данные. Если переменная имеет тип **Object** , задача "Выполнение SQL" возвращает DOM-объект.  
  
 Тип **Полный результирующий набор** должен быть сопоставлен с типом данных **Object** . Возвращаемый результат является объектом набора строк. Можно использовать контейнер «цикл по каждому элементу», чтобы извлечь значения строк таблицы, которые хранятся в переменной Object, в переменные пакета, а затем с помощью задачи «Сценарий» записать данные, хранящиеся в переменных пакетов, в файл. Демонстрацию этой процедуры с использованием контейнера «цикл по каждому элементу» и задачи «Сценарий» см. в примере CodePlex [Execute SQL Parameters and Result Sets (Параметры задачи «Выполнение SQL» и наборы результатов)](https://go.microsoft.com/fwlink/?LinkId=157863)на веб-сайте msftisprodsamples.codeplex.com.  
  
 В следующей таблице представлены итоговые сведения о типах данных переменных, которые могут быть сопоставлены с результирующими наборами.  
  
|Тип результирующего набора|Тип данных переменной|Тип объекта|  
|---------------------|---------------------------|--------------------|  
|Единственная строка|Любой тип, который совместим с типом столбца в результирующем наборе.|Неприменимо|  
|Полный результирующий набор|**Объект**|Если задача использует собственный диспетчер соединений, в том числе диспетчеры соединений ADO, OLE DB, Excel и ODBC, возвращается объект **Recordset**ADO.<br /><br /> Если задача использует управляемый диспетчер подключений, например [!INCLUDE[vstecado](../../includes/vstecado-md.md)], то возвращается объект **System.Data.DataSet**.<br /><br /> Задачу «Скрипт» можно использовать для доступа к объекту **System.Data.DataSet** , как показано в следующем примере.<br /><br /> `Dim dt As Data.DataTable`<br /><br /> `Dim ds As Data.DataSet = CType(Dts.Variables("Recordset").Value, DataSet) dt = ds.Tables(0)`|  
|XML|**String**|**String**|  
|XML|**Объект**|Если задача использует собственный диспетчер соединений, в том числе диспетчеры соединений ADO, OLE DB, Excel и ODBC, то возвращается объект **MSXML6.IXMLDOMDocument**.<br /><br /> Если задача использует управляемый диспетчер подключений, например [!INCLUDE[vstecado](../../includes/vstecado-md.md)], то возвращается объект **System.Xml.XmlDocument**.|  
  
 Переменную можно определить в области задачи «Выполнение SQL» или пакета. Если переменная определена в области пакета, результирующий набор доступен другим задачам и контейнерам внутри пакета, а так же любым пакетам, запущенным задачами «Выполнение пакета» или «Выполнение пакета служб DTS 2000».  
  
 При сопоставлении переменной с результирующим набором типа **Единственная строка** нестроковые значения, возвращенные инструкцией SQL, могут быть преобразованы в строки при выполнении следующих условий:  
  
-   Свойство **TypeConversionMode** имеет значение «true». Значение свойства задается в окне «Свойства» или с помощью **редактора задачи «Выполнение SQL»** .  
  
-   Преобразование не приведет к усечению данных.  
  
## <a name="map-result-sets-to-variables-in-an-execute-sql-task"></a>Сопоставление результирующих наборов с переменными в задаче «Выполнение SQL»
В этом разделе описывается создание сопоставления между результирующими наборами и переменной в задаче "Выполнение SQL". Сопоставление между результирующим набором и переменной делает результирующий набор доступным для других элементов пакета. Например, скрипт в задаче «Скрипт» может считать переменную, а потом использовать значения из результирующего набора, или источник XML может использовать результирующий набор, сохраненный в переменной. Если результирующий набор создан родительским пакетом, его можно сделать доступным дочернему пакету, вызываемому задачей «Выполнение пакета», сопоставив результирующий набор с переменной в родительском пакете, а затем для хранения значения родительской переменной создав конфигурацию переменных родительского пакета в дочернем пакете.  
  
1.  В среде [!INCLUDE[ssBIDevStudioFull](../../includes/ssbidevstudiofull-md.md)]откройте проект служб [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] , содержащий необходимый пакет.  
  
2.  Чтобы открыть пакет, дважды щелкните его в **обозревателе решений**.  
  
3.  Перейдите на вкладку **Поток управления** .  
  
4.  Если пакет не включает задачу «Выполнение SQL», добавьте его к потоку управления пакета. Дополнительные сведения см. в разделе [Добавление задачи или контейнера в поток управления или удаление их из него](../../integration-services/control-flow/add-or-delete-a-task-or-a-container-in-a-control-flow.md).  
  
5.  Дважды щелкните задачу «Выполнение SQL».  
  
6.  В диалоговом окне **Редактор задачи «Выполнение SQL»** на странице **Общие** выберите в качестве типа результирующего набора **Одиночная строка**, **Полный результирующий набор**или **XML** .  

7.  Щелкните **Результирующий набор**.  
  
8.  Чтобы добавить сопоставление результирующего набора, щелкните **Добавить**.  
  
9. В списке **Имя переменной** выберите переменную либо создайте новую переменную. Дополнительные сведения см. в разделе [Добавление, удаление и изменение области определяемой пользователем переменной в пакете](../integration-services-ssis-variables.md).  
  
10. В списке **Имя результата** при необходимости измените имя результирующего набора.  
  
     Обычно можно использовать имя столбца в качестве имени результирующего набора. Также можно использовать порядковый номер столбца в списке столбцов в качестве результирующего набора. Возможность использовать имя столбца в качестве имени результирующего набора зависит от поставщика, для работы с которым настроена задача. Не все поставщики разрешают использовать имена столбцов.  
  
11. Нажмите кнопку **ОК**.  

## <a name="troubleshoot-the-execute-sql-task"></a>Устранение неполадок, связанных с задачей "Выполнение SQL"  
 Вызовы, сделанные задачей «Выполнение SQL» к внешним источникам данных, можно записывать в журнал. Эта новая возможность протоколирования может быть использована для устранения неполадок, связанных с командами SQL, которые выполняются задачей «Выполнение SQL». Чтобы протоколировать вызовы, которые задача «Выполнение SQL» формирует к внешнему поставщику данных, необходимо разрешить ведение журнала пакета и выбрать событие **Диагностика** на уровне пакета. Дополнительные сведения см. в разделе [Инструменты устранения неполадок при выполнении пакетов](../../integration-services/troubleshooting/troubleshooting-tools-for-package-execution.md).  
  
 Иногда команда SQL или хранимая процедура возвращает несколько результирующих наборов. Эти результирующие наборы включают не только наборы строк, которые являются результатом запросов **SELECT** , но и отдельные значения, являющиеся результатом ошибок инструкций **RAISERROR** или **PRINT** . От типа используемого диспетчера соединений зависит, пропускает ли задача ошибки в результирующих наборах, следующих за первым.  
  
-   Если используются диспетчеры соединений OLE DB и ADO, задача пропускает результирующие наборы, следующие за первым результирующим набором. Поэтому задача с этими диспетчерами соединений не обрабатывает ошибку, возвращенную командой SQL или хранимой процедурой, если эта ошибка не является частью первого результирующего набора.  
  
-   Если используются диспетчеры соединений ODBC и ADO.NET, задача не пропускает результирующие наборы, следующие за первым результирующим набором. Задача с этими диспетчерами соединений завершается ошибкой, если один из результирующих наборов, следующих за первым, содержит ошибку.  
  
### <a name="custom-log-entries"></a>Пользовательские записи журнала  
 В следующей таблице перечислены пользовательские записи журнала для задачи «Выполнение SQL». Дополнительные сведения см. в разделе [Ведение журналов в службах Integration Services (SSIS)](../../integration-services/performance/integration-services-ssis-logging.md).  
  
|Запись журнала|Описание|  
|---------------|-----------------|  
|**ExecuteSQLExecutingQuery**|Предоставляет сведения об этапах выполнения инструкции SQL. Записи журнала формируются в тот момент, когда задача устанавливает соединение с базой данных, когда задача приступает к подготовке инструкции SQL, и после того, как завершается выполнение инструкции SQL. Запись журнала для этапа подготовки содержит инструкцию SQL, которая используется задачей.|