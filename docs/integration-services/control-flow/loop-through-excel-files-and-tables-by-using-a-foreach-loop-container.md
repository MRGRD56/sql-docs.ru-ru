---
description: Просмотр файлов и таблиц Excel с помощью контейнера "Цикл по каждому элементу"
title: Просмотр файлов и таблиц Excel с помощью контейнера "Цикл по каждому элементу" | Документация Майкрософт
ms.custom: ''
ms.date: 05/15/2018
ms.prod: sql
ms.prod_service: integration-services
ms.reviewer: ''
ms.technology: integration-services
ms.topic: conceptual
helpviewer_keywords:
- connections [Integration Services], Excel
- Excel [Integration Services]
- connection managers [Integration Services], Excel
ms.assetid: a5393c1a-cc37-491a-a260-7aad84dbff68
author: chugugrace
ms.author: chugu
ms.openlocfilehash: 7c6e986f032f755f73db249f7ddeff539fca4a8c
ms.sourcegitcommit: cfa04a73b26312bf18d8f6296891679166e2754d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/19/2020
ms.locfileid: "92197179"
---
# <a name="loop-through-excel-files-and-tables-with-a-foreach-loop-container"></a>Просмотр файлов и таблиц Excel с помощью контейнера "Цикл по каждому элементу"

[!INCLUDE[sqlserver-ssis](../../includes/applies-to-version/sqlserver-ssis.md)]


  Процедуры в этом разделе описывают, как выполнить цикл по книгам Excel в папке или цикл по таблицам в книге Excel с помощью контейнера «цикл по каждому элементу» с соответствующим перечислителем.  

> [!IMPORTANT]
> Дополнительные сведения о подключении к файлам Excel, а также об ограничениях и известных проблемах, связанных с загрузкой данных в файлы этого приложения и из них, см. в разделе [Загрузка данных в приложение Excel или из него с помощью служб SQL Server Integration Services (SSIS)](../load-data-to-from-excel-with-ssis.md).
 
## <a name="to-loop-through-excel-files-by-using-the-foreach-file-enumerator"></a>Организация цикла по файлам Excel с помощью перечислителя с циклом по каждому файлу  
  
1.  Создайте строковую переменную, которая будет принимать значение текущего пути и имени файла Excel для каждой итерации цикла. Чтобы избежать проверки данных, присвойте переменной в качестве начального значения путь и имя существующего файла Excel. (Образец выражения, показанный ниже, использует в этой процедуре переменную `ExcelFile`.)  
  
2.  При желании создайте другую строковую переменную, которая будет хранить значение аргумента для дополнительных свойств строки соединения с Excel. Этот аргумент содержит серию значений, которые задают версию Excel и определяют, будет ли первая строка содержать имена столбцов и будет ли использован режим импорта. (Образец выражения, показанный ниже, использует в этой процедуре имя переменной `ExtProperties`с начальным значением "`Excel 12.0;HDR=Yes`".)  
  
     Если в аргументе расширенных свойств не используется переменная, то в выражение, которое содержит строку подключения, ее необходимо добавить вручную.  
  
3.  Добавьте контейнер "цикл по каждому элементу" на вкладку **Поток управления** . Сведения о настройке контейнера "цикл по каждому элементу" см. в разделе [Настройка контейнера "цикл по каждому элементу"](./foreach-loop-container.md).  
  
4.  На странице **Коллекция** в **редакторе циклов Foreach** выберите перечислитель Foreach File, задайте папку, в которой размещаются книги Excel, и фильтр файлов (обычно *.xlsx).  
  
5.  На странице **Сопоставления переменной** сопоставьте Index 0 с определенной пользователем строковой переменной, которая будет принимать значение текущего пути Excel и имени файла на каждой итерации цикла. (Образец выражения, показанный ниже, использует в этой процедуре переменную `ExcelFile`.)  
  
6.  Закройте **Редактор циклов по каждому элементу**.  
  
7.  Добавьте диспетчер подключений к Excel в пакет, как описано в разделе [Добавление, удаление или совместное использование диспетчера соединений в пакете](/previous-versions/sql/sql-server-2016/ms140237(v=sql.130)). Чтобы избежать ошибок проверки, выберите для подключения существующий файл книги Excel.  
  
    > [!IMPORTANT]  
    >  Чтобы избежать ошибок проверки после настройки задач и компонентов потоков данных, которые используют этот диспетчер подключений Excel, выберите существующую книгу Excel в окне **Редакторе диспетчера соединений Excel**. Диспетчер подключений не будет использовать эту книгу во время выполнения, если настроить выражение для свойства **ConnectionString** , как показано ниже. После создания и настройки пакета можно очистить значение свойства **ConnectionString** в окне свойств. Однако если очистить это значение, свойство строки соединения диспетчера соединений Excel не будет действительно до запуска контейнера «цикл по каждому элементу». Следовательно, необходимо присвоить свойству **DelayValidation** значение **True** в задачах, где используется диспетчер подключений, или в пакете, чтобы избежать ошибок проверки.  
    >   
    >  Необходимо также использовать значение по умолчанию **False** для свойства **RetainSameConnection** диспетчера подключений Excel. При изменении этого значения на **True**каждая итерация цикла будет по-прежнему открывать первую книгу Excel.  
  
8.  Выберите новый диспетчер подключений Excel, щелкните свойство **Выражения** в окне свойств и нажмите кнопку с многоточием.  
  
9. В **редакторе выражений свойств**выберите свойство **ConnectionString** и нажмите кнопку с многоточием.  
  
10. В построителе выражения введите следующее выражение.  
  
    ```  
    "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" +  @[User::ExcelFile] + ";Extended Properties=\"" + @[User::ExtProperties] + "\""  
    ```  
  
     Обратите внимание на использование escape-символа "\\" для обозначения внутренних кавычек, в которые должно быть заключено значения аргумента расширенных свойств.  
  
     Аргумент расширенных свойств является обязательным. Если для этого значения не используется переменная, то его необходимо вручную добавить в выражение, как показано в следующем примере:  
  
    ```  
    "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" +  @[User::ExcelFile] + ";Extended Properties=Excel 12.0"  
    ```  
  
11. Создайте задачи в контейнере «цикл по каждому элементу», которые используют диспетчер соединений с Excel для выполнения одинаковых операций для каждой книги Excel, соответствующей заданному положению и шаблону файла.  
  
## <a name="to-loop-through-excel-tables-by-using-the-foreach-adonet-schema-rowset-enumerator"></a>Организация цикла по таблицам Excel с помощью перечислителя по набору строк схемы ADO.NET  
  
1.  Создайте диспетчер подключений ADO.NET, который использует OLE DB-поставщик Microsoft ACE для подключения к книге Excel. В диалоговом окне **Диспетчер подключений** на странице "Все" убедитесь, что в качестве значения расширенных свойств введена версия Excel (в данном случае Excel 12.0). Дополнительные сведения см. в статье [Добавление, удаление или совместное использование диспетчера соединений в пакете](/previous-versions/sql/sql-server-2016/ms140237(v=sql.130)).  
  
2.  Создайте строковую переменную, которая будет принимать имя текущий таблицы на каждой итерации цикла.  
  
3.  Добавьте контейнер "цикл по каждому элементу" на вкладку **Поток управления** . Сведения о настройке контейнера "цикл по каждому элементу" см. в разделе [Настройка контейнера "цикл по каждому элементу"](./foreach-loop-container.md).  
  
4.  На странице **Коллекция** в **редакторе циклов по каждому элементу**выберите перечислитель набора строк схемы ADO.NET.  
  
5.  В качестве значения **Соединение**выберите предварительно созданный диспетчер подключений ADO.NET.  
  
6.  В качестве значения **Схема**выберите "Таблицы".  
  
    > [!NOTE]  
    >  Список таблиц в книге Excel включает в себя и листы (которые имеют суффикс $), и именованные диапазоны. Если нужно отфильтровать список только по листам или только по именованным диапазонам, то, возможно, для этой цели понадобится написать свою программу в задаче «Скрипт». Дополнительные сведения см. в статье [Работа с файлами Excel в задаче "Скрипт"](../../integration-services/extending-packages-scripting-task-examples/working-with-excel-files-with-the-script-task.md).  
  
7.  На странице **Сопоставления переменной** сопоставьте Index 2 со строковой переменной, созданной ранее для хранения имени текущей таблицы.  
  
8.  Закройте **Редактор циклов по каждому элементу**.  
  
9. Создайте задачи в контейнере «цикл по каждому элементу», которые используют диспетчер соединений Excel для выполнения одинаковых операций для каждой таблицы Excel в заданной книге. Если задача "Скрипт" используется для анализа имени перечисляемой таблицы или работы с каждой таблицей, не забудьте добавить строковую переменную к свойству ReadOnlyVariables задачи "Скрипт".  
  
## <a name="see-also"></a>См. также  
 [Загрузка данных в приложение Excel или из него с помощью служб SQL Server Integration Services (SSIS)](../load-data-to-from-excel-with-ssis.md)  
 [Настройка контейнера "цикл по каждому элементу"](./foreach-loop-container.md)   
 [Добавление или изменение выражение свойства](../../integration-services/expressions/add-or-change-a-property-expression.md)   
 [Диспетчер подключений Excel](../../integration-services/connection-manager/excel-connection-manager.md)   
 [Источник Excel](../../integration-services/data-flow/excel-source.md)   
 [Назначение Excel](../../integration-services/data-flow/excel-destination.md)   
 [Работа с файлами Excel в задаче «Скрипт»](../../integration-services/extending-packages-scripting-task-examples/working-with-excel-files-with-the-script-task.md)  
  
