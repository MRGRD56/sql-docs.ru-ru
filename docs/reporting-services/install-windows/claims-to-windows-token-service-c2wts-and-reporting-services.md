---
description: Служба Claims to Windows Token Service (c2WTS) и службы Reporting Services
title: Служба Claims to Windows Token Service (c2WTS) и службы Reporting Services | Документы Майкрософт
author: maggiesMSFT
ms.author: maggies
ms.prod: reporting-services
ms.prod_service: reporting-services-sharepoint
ms.topic: conceptual
ms.date: 09/15/2017
ms.openlocfilehash: 65f2fb2148e1a33aacb9d0b1e82039d594ea3524
ms.sourcegitcommit: e700497f962e4c2274df16d9e651059b42ff1a10
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2020
ms.locfileid: "88396790"
---
# <a name="claims-to-windows-token-service-c2wts-and-reporting-services"></a>Служба Claims to Windows Token Service (C2WTS) и службы Reporting Services

[!INCLUDE [ssrs-appliesto](../../includes/ssrs-appliesto.md)] [!INCLUDE[ssrs-appliesto-2016-and-later](../../includes/ssrs-appliesto-2016-and-later.md)] [!INCLUDE[ssrs-appliesto-sharepoint-2013-2016i](../../includes/ssrs-appliesto-sharepoint-2013-2016.md)] [!INCLUDE[ssrs-appliesto-pbirsi](../../includes/ssrs-appliesto-pbirs.md)]

Служба SharePoint Claims to Windows Token Service (C2WTS) необходима для просмотра отчетов в собственном режиме в [веб-части средства просмотра отчетов служб SQL Server Reporting Services](../report-server-sharepoint/deploy-report-viewer-web-part.md).

Служба SharePoint Claims to Windows Token Service (C2WTS) требуется для служб SQL Server Reporting Services в режиме интеграции с SharePoint в случае, если необходимо использовать проверку подлинности Windows для источников данных, которые находятся за пределами фермы SharePoint. Служба C2WTS необходима, даже если источники данных находятся на одном компьютере с общей службой. Однако в этом случае ограниченное делегирование не требуется.

> [!NOTE]
> Интеграция служб Reporting Services с SharePoint больше не доступна после выхода SQL Server 2016.

## <a name="report-viewer-native-mode-web-part-configuration"></a>Настройка веб-части средства просмотра отчетов (собственный режим)

Веб-часть средства просмотра отчетов можно использовать для внедрения отчетов служб SQL Server Reporting Services в собственном режиме на сайте SharePoint. Эта веб-часть доступна для SharePoint 2013 и SharePoint 2016. В SharePoint 2013 и SharePoint 2016 действует проверка подлинности на основе утверждений. В результате этого C2WTS необходимо настроить соответствующим образом, а в Reporting Services нужно настроить проверку подлинности Kerberos для правильного отображения отчетов.

1. Настройте экземпляр Reporting Services (собственный режим) для проверки подлинности Kerberos, определив учетную запись службы SSRS, настроив имя субъекта-службы и обновив файл rsreportserver.config, чтобы использовать тип проверки подлинности RSWindowsNegotiate. [Регистрация имени субъекта-службы для сервера отчетов](https://docs.microsoft.com/sql/reporting-services/report-server/register-a-service-principal-name-spn-for-a-report-server)

2. Выполните шаги из раздела, посвященного [настройке службы c2WTS](https://docs.microsoft.com/sql/reporting-services/install-windows/claims-to-windows-token-service-c2wts-and-reporting-services?view=sql-server-2017#steps-needed-to-configure-c2wts).
 

## <a name="sharepoint-mode-integration"></a>Интеграция с режимом SharePoint

**Этот раздел относится только к службам SQL Server 2016 Reporting Services и более ранним версиям.**

Служба SharePoint Claims to Windows Token Service (C2WTS) требуется для служб SQL Server Reporting Services в режиме интеграции с SharePoint в случае, если необходимо использовать проверку подлинности Windows для источников данных, которые находятся за пределами фермы SharePoint. Она также требуется, когда пользователь получает доступ к источникам данных с помощью проверки подлинности Windows, так как для связи между интерфейсным веб-сервером и общей службой Reporting Services всегда используется проверка подлинности на основе утверждений.

## <a name="steps-needed-to-configure-c2wts"></a>Основные шаги для настройки службы C2WTS

Токены, созданные службой C2WTS, работают только при наличии ограниченного делегирования (ограничение набором определенных служб) и заданном параметре using any authentication protocol (Использовать любой протокол проверки подлинности) (переход протокола).

Если в среде используется делегирование, ограниченное Kerberos, то внешние источники данных и служба SharePoint Server должны находиться в одном домене Windows. Любая служба, использующая службу токенов Claims to Windows Service (c2WTS), должна применять делегирование, **ограниченное** Kerberos, чтобы разрешить c2WTS использовать передачу протокола Kerberos для перевода утверждений в учетные данные Windows. Эти требования являются достоверными для всех общих служб SharePoint. Дополнительные сведения см. в разделе [Планирование проверки подлинности Kerberos в SharePoint 2013](https://technet.microsoft.com/library/ee806870.aspx).  

1. Настройте учетную запись домена службы C2WTS. 

    **Рекомендуется запускать C2WTS с использованием собственного удостоверения домена.**

    * Создайте учетную запись Active Directory и зарегистрируйте ее как управляемую учетную запись на сервере SharePoint.
   
    * Настройте службу C2WTS для использования управляемой учетной записи, выбрав "Центр администрирования SharePoint > Безопасность > Configure Service Accounts (Настройка учетных записей служб) > Windows Service - Claims to Windows Token Service (Служба Windows — утверждения для службы маркеров Windows)".

    Добавьте учетную запись службы C2WTS в группу локальных администраторов на каждом сервере, где будет использоваться служба C2WTS. Для **веб-части средства просмотра отчетов** это будут интерфейсные веб-серверы (WFE). Для **режима интеграции с SharePoint** это будут серверы приложений, на которых запущена служба Reporting Services.
    * Предоставьте учетной записи службы C2WTS следующие разрешения в локальной политике безопасности в разделе "Локальные политики > Назначение прав пользователя":
        * работа в качества части операционной системы;
        * олицетворение клиента после проверки подлинности;
        * Вход в систему в качестве службы.

    
2. Настройте делегирование для учетной записи службы C2WTS.

    Для учетной записи необходимо настроить ограниченное делегирование со сменой протоколов. Кроме того, ей требуются разрешения на делегирование для служб, с которыми она будет обмениваться данными (например, ядро СУБД SQL Server, службы SQL Server Analysis Services). Для настройки делегирования можно использовать оснастку "Active Directory — пользователи и компьютеры". Также потребуются права администратора домена.

    > [!IMPORTANT]
    > Любые параметры, настраиваемые для учетной записи службы C2WTS на вкладке делегирования, должны соответствовать основной учетной записи службы. Для **веб-части средства просмотра отчетов** это будет учетная запись службы для веб-приложения SharePoint. Для **режима интеграции с SharePoint** это будет учетная запись службы Reporting Services.
    >
    > Например, если разрешить учетной записи службы C2WTS делегировать полномочия службе SQL Service, потребуется выполнить то же самое с учетной записью службы Reporting Services для режима интеграции с SharePoint.

    * Щелкните правой кнопкой мыши каждую учетную запись службы и откройте диалоговое окно свойств. В диалоговом окне перейдите на вкладку **Делегирование** .

        Вкладка делегирования отображается, только если объекту назначено имя субъекта-службы (SPN). Службе C2WTS не требуется имя субъекта-службы для учетной записи службы C2WTS, однако без этого имени вкладка **Делегирование** отображаться не будет. Другой способ настройки ограниченного делегирования заключается в использовании специальной программы, например **ADSIEdit**.

    * Основными параметрами, приведенными на вкладке делегирования, являются следующие:

        * Установка параметра **Доверять этому пользователю делегирование только определенных служб**
        * Установка параметра **Использовать любой протокол проверки подлинности**

    * Выберите **Добавить** , чтобы добавить службу, которая является адресатом делегирования.

    * Выберите **Пользователи или компьютеры...&#42;** и введите учетную запись, в которой размещена служба. Например, если SQL Server выполняется под учетной записью с именем *sqlservice*, введите `sqlservice`. 
      Для **веб-части средства просмотра отчетов** это будет учетная запись службы для экземпляра Reporting Services (собственный режим).

    * Выберите список служб. Отобразятся имена участников-служб, которые доступны в этой учетной записи. Если вы не видите в списке службу для соответствующей учетной записи, возможно, она отсутствует или размещена в другой учетной записи. Для настройки имен SPN можно использовать служебную программу SetSPN. Для **веб-части средства просмотра отчетов** отобразится имя участника-службы HTTP, настроенное в разделе [Настройка веб-части средства просмотра отчетов](https://docs.microsoft.com/sql/reporting-services/install-windows/claims-to-windows-token-service-c2wts-and-reporting-services?view=sql-server-2017#report-viewer-native-mode-web-part-configuration).

    * Нажмите кнопку ОК, чтобы закрыть все диалоговые окна.

3. Настройте параметр *AllowedCallers* службы C2WTS.

    Для службы C2WTS требуется, чтобы идентификаторы вызывающих объектов были явно перечислены в файле конфигурации **C2WTShost.exe.config**. Служба C2WTS принимает запросы от всех пользователей системы, прошедших проверку подлинности, только если она настроена на это. В этом случае вызывающим является группа Windows WSS_WPG. Файл C2WTShost.exe.confi хранится в следующем расположении:

    Изменение учетной записи службы в центре администрирования SharePoint (для службы C2WTS) добавит эту учетную запись в группу WSS_WPG.

    **\Program Files\Windows Identity Foundation\v3.5\c2WTShost.exe.config**

    В следующем примере показан файл конфигурации:

    ```
    <configuration>
      <windowsTokenService>
        <!--  
            By default no callers are allowed to use the Windows Identity Foundation Claims To NT Token Service.  
            Add the identities you wish to allow below.  
          -->
        <allowedCallers>
          <clear/>
          <add value="WSS_WPG" />
        </allowedCallers>
      </windowsTokenService>
    </configuration>
    ```

4. Запустите (перезапустите, если служба уже работает) службу Claims to Windows Token из центра администрирования SharePoint на странице **управления службами на сервере**. Служба должна быть запущена на сервере, который будет выполнять действие. Например, при наличии сервера, который является интерфейсным веб-сервером, и другого сервера, который служит сервером приложений, где работает общая служба SQL Server Reporting Services, службу C2WTS необходимо запустить только на сервере приложений. Если вы используете веб-часть средства просмотра отчетов, служба C2WTS требуется только на веб-сервере.

Остались вопросы? [Посетите форум служб Reporting Services](https://go.microsoft.com/fwlink/?LinkId=620231).
