---
title: Диагностика отказоустойчивого кластера | Документация Майкрософт
description: Сведения об устранении неполадок отказоустойчивых кластеров, включая восстановление после сбоя, устранение распространенных проблем и использование расширенных хранимых процедур/COM-объектов.
ms.custom: ''
ms.date: 10/21/2015
ms.prod: sql
ms.reviewer: ''
ms.technology: high-availability
ms.topic: how-to
helpviewer_keywords:
- troublshooting, failover clustering
- failover clustering, troubleshooting
- cluster troubleshooting
ms.assetid: 84012320-5a7b-45b0-8feb-325bf0e21324
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: f9c54984eb8d1c94176929579043f979aa518672
ms.sourcegitcommit: a41e1f4199785a2b8019a419a1f3dcdc15571044
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2020
ms.locfileid: "91988312"
---
# <a name="failover-cluster-troubleshooting"></a>Диагностика отказоустойчивого кластера
[!INCLUDE [SQL Server](../../../includes/applies-to-version/sqlserver.md)]
  Этот подраздел содержит следующие сведения:  
  
-   основные шаги диагностики;  
  
-   восстановление по журналу после сбоя отказоустойчивого кластера;  
  
-   разрешение наиболее частых проблем отказоустойчивой кластеризации;  
  
-   использование расширенных хранимых процедур и объектов COM.  
  
## <a name="basic-troubleshooting-steps"></a>Основные шаги диагностики  
 Первым шагом диагностики является проверка нового кластера. Сведения о проверке см. в статье [Пошаговое руководство по отказоустойчивому кластеру. Проверка оборудования для отказоустойчивого кластера](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc732035(v=ws.10)).  Эту процедуру можно выполнить без нарушения работы службы, поскольку она не влияет на ресурсы кластера в сети. Проверку можно провести в любое время после установки функции отказоустойчивой кластеризации, включая момент перед развертыванием кластера, во время создания кластера и во время его работы. На самом деле дополнительные тесты выполняются после перевода кластера в рабочий режим и проверяют соблюдение рекомендаций для рабочих нагрузок с высоким уровнем доступности. Из множества тестов лишь немногие повлияют на функционирование рабочих нагрузок кластера. Все они входят в категорию хранилища, поэтому, пропустив эту категорию, можно легко отказаться от тестов с негативными последствиями.  
Отказоустойчивая кластеризация располагает встроенными мерами защиты для предотвращения случайного времени простоев при выполнении тестов хранилища во время проверки. Если при инициации проверки в кластере имеются сетевые группы и выбраны тесты хранилища, будет выведен запрос на подтверждение необходимости запуска всех тестов (и возникновения простоя) или пропуска тестирования дисков сетевых групп, чтобы избежать простоя. Если из тестирования была исключена вся категория хранилища, этот запрос не отображается. Проверка кластера будет выполнена без простоев.  
  
#### <a name="how-to-revalidate-your-cluster"></a>Повторная проверка кластера  
  
1.  В оснастке отказоустойчивого кластера в дереве консоли убедитесь, что выбран параметр **Управление отказоустойчивым кластером** , а затем в разделе **Управление**нажмите кнопку **Проверить конфигурацию**.  
  
2.  Следуйте инструкциям мастера по указанию серверов и тестов, а затем выполните тесты. После выполнения тестов откроется страница **Сводка** .  
  
3.  На странице **Сводка** щелкните **Просмотреть отчет** , чтобы просмотреть результаты теста.  
  
     Чтобы просмотреть результаты тестов после закрытия мастера, см. **%SystemRoot%\Cluster\Reports\Validation Report date and time.html** , где **% SystemRoot %** — это папка, в которой установлена операционная система (например, **C:\Windows**).  
  
4.  Чтобы просмотреть разделы справки, которые помогут интерпретировать результаты, щелкните **Дополнительные сведения о тестах для проверки кластеров**.  
  
 Чтобы просмотреть разделы справки о проверке кластера после закрытия мастера, в оснастке отказоустойчивого кластера щелкните **Справка**, **Разделы справки**, откройте вкладку **Содержимое** , разверните содержимое справки по отказоустойчивому кластеру и щелкните **Проверка конфигурации отказоустойчивого кластера**.  После завершения работы мастера проверки результаты появятся в **сводном отчете** . Все выполненные тесты должны быть отмечены зеленой галочкой или в некоторых случаях желтым треугольником (предупреждение). При поиске проблемных областей (отмеченных красными крестиками X или желтыми вопросительными знаками) в части отчета, где приведена сводка результатов теста, щелкните отдельный тест, чтобы просмотреть подробные сведения. Все проблемы, отмеченные красными крестиками X, необходимо разрешить до устранения неполадок [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .  
  
 **Установка обновлений**  
  
 Установка обновлений является важной частью предотвращения проблем в системе. Полезные ссылки  
  
-   [Рекомендуемые исправления и обновления для отказоустойчивых кластеров Windows Server 2012 R2.](https://support.microsoft.com/kb/2920151)  
  
-   [Рекомендуемые исправления и обновления для отказоустойчивых кластеров Windows Server 2012.](https://support.microsoft.com/kb/2784261)  
  
-   [Рекомендуемые исправления и обновления для отказоустойчивых кластеров Windows Server 2008 R2.](https://support.microsoft.com/kb/980054)  
  
-   [Рекомендуемые исправления и обновления для отказоустойчивых кластеров Windows Server 2008.](https://support.microsoft.com/kb/957311)  
  
## <a name="recovering-from-failover-cluster-failure"></a>Восстановление по журналу после сбоя отказоустойчивого кластера  
 Обычно сбой отказоустойчивого кластера возникает в следующих случаях.  
  
-   Сбой оборудования в одном из узлов двухузлового кластера. Такой сбой оборудования может быть вызван сбоем SCSI-контроллера или ОС.  
  
     Для восстановления после такого сбоя удалите неисправный узел из отказоустойчивого кластера с помощью программы установки [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , устраните сбой оборудования, переключив компьютер в режим «вне сети», восстановите машину и добавьте восстановленный узел снова к экземпляру отказоустойчивого кластера.  
  
     Дополнительные сведения см. в статье [Создание нового отказоустойчивого кластера SQL Server (программа установки)](../../../sql-server/failover-clusters/install/create-a-new-sql-server-failover-cluster-setup.md) и [Восстановление по журналу после сбоя экземпляра отказоустойчивого кластера](../../../sql-server/failover-clusters/windows/recover-from-failover-cluster-instance-failure.md).  
  
-   Ошибка операционной системы. В этом случае данный узел отключен, но не является окончательно неисправным.  
  
     Для восстановления после сбоя ОС восстановите данный узел и проверьте отработку отказа. Если данный экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] не переключается на другой ресурс должным образом, необходимо программой установки [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] удалить [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] из отказоустойчивого кластера, произвести необходимые восстановительные процедуры, восстановить резервную копию и снова добавить восстановленный узел к экземпляру отказоустойчивого кластера.  
  
     Восстановление по журналу после сбоя ОС может занять значительное время. Если восстановить ОС после сбоя можно более простым способом, не прибегайте к этому методу.  
  
     Дополнительные сведения см. в статье [Создание нового отказоустойчивого кластера SQL Server (программа установки)](../../../sql-server/failover-clusters/install/create-a-new-sql-server-failover-cluster-setup.md) и [Как воспроизвести восстановление после сбоя отказоустойчивого кластера в сценарии 2](recover-from-failover-cluster-instance-failure.md).  
  
## <a name="resolving-common-problems"></a>Разрешение общих проблем  
 В следующем списке приведено описание общих проблем и даны объяснения по их устранению.  
  
### <a name="problem-incorrect-use-of-command-prompt-syntax-to-install-sql-server"></a>Проблема. Неверное использование синтаксиса командной строки при установке SQL Server  
 **Причина 1.** Диагностировать проблемы программы установки при использовании в командной строке параметра **/qn** трудно, поскольку параметр **/qn** подавляет все диалоговые окна программы установки и сообщения об ошибках. Если указан параметр **/qn** , все сообщения программы установки, включая сообщения об ошибках, записываются в файлы журналов программы установки. Дополнительные сведения о файлах журналов см. в разделе [Просмотр и чтение файлов журналов программы установки SQL Server](../../../database-engine/install-windows/view-and-read-sql-server-setup-log-files.md).  
  
 **Решение 1**. Используйте параметр **/qb** вместо **/qn**. При использовании параметра **/qb** на каждом шаге отображается интерфейс пользователя, в том числе сообщения об ошибках.  
  
### <a name="problem-sql-server-cannot-log-on-to-the-network-after-it-migrates-to-another-node"></a>Проблема. Серверу SQL Server не удается подключиться к сети после его перемещения на другой узел.  
 **Причина 1.** Учетные записи службы [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] не могут связаться с контроллером домена.  
  
 **Решение 1**. Проверьте журналы событий на наличие записей о проблемах сети, например о сбоях адаптеров или проблемах с DNS. Проверьте контроллер домена командой ping.  
  
 **Причина 2. Пароли к учетным записям службы ** [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] отличаются на разных узлах кластера, или узел не перезапускает службу [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], которая была перенесена с неисправного узла.  
  
 **Решение 2**. Измените пароли учетной записи службы [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] с помощью диспетчера конфигурации [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Если это не было сделано, а пароли учетной записи службы [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] изменены на одном узле, необходимо также изменить их на всех остальных узлах. [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] выполняет это автоматически.  
  
### <a name="problem-sql-server-cannot-access-the-cluster-disks"></a>Проблема. SQL Server не может получить доступ к дискам кластера.  
 **Причина 1**. Встроенное ПО или драйверы обновлены не на всех узлах.  
  
 **Решение 1**. Проверьте, установлены ли на всех узлах правильное встроенное ПО и одинаковые версии драйверов.  
  
 **Причина 2.** Узел не может восстановить диски кластера, перенесенные с неисправного узла на общий диск кластера с другой буквой диска.  
  
 **Решение 2**. Буквы для дисков кластера должны совпадать на обоих серверах. Если это не так, проверьте исходную установку ОС и службы кластеров (MSCS) [!INCLUDE[msCoName](../../../includes/msconame-md.md)] .  
  
### <a name="problem-failure-of-a-sql-server-service-causes-failover"></a>Проблема. Сбой службы SQL Server вызывает отработку отказа.  
 **Решение.** Чтобы сбой определенных служб не вызывал перехода группы [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] на другой ресурс, настройте эти службы при помощи программы администрирования кластеров Windows следующим образом.  
  
-   Сбросьте флажок **Применить к группе** на вкладке **Дополнительно** диалогового окна **Свойства полного текста** . Однако, если [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] вызовет отработку отказа, служба полнотекстового поиска будет перезапущена.  
  
### <a name="problem-sql-server-does-not-start-automatically"></a>Проблема. SQL Server не запускается автоматически.  
 **Решение.** С помощью администратора кластеров в MSCS настройте автоматический запуск отказоустойчивого кластера. Не следует настраивать службу [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] для запуска вручную, нужно настроить приложение «Администратор кластеров» в MSCS для запуска службы [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . Дополнительные сведения см. в разделе [Управление службами](https://msdn.microsoft.com/library/ms178096\(v=sql.105\).aspx).  
  
### <a name="problem-the-network-name-is-offline-and-you-cannot-connect-to-sql-server-using-tcpip"></a>Проблема. Сетевой ресурс, к которому выполняется обращение по имени, находится не в сети, и нельзя подключиться к SQL Server по протоколу TCP/IP.  
 **Причина 1**. Сбой службы DNS, в то время как для ресурсов кластера настроено использование DNS.  
  
 **Решение 1**. Устраните проблемы с DNS.  
  
 **Причина 2**. Повторяющееся имя в сети.  
  
 **Решение 2**. С помощью программы NBSTAT найдите повторяющееся имя и устраните проблему.  
  
 **Причина 3.** Не удается соединиться с [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] с помощью именованных каналов.  
  
 **Решение 3**. Для подключения через именованные каналы создайте псевдоним с помощью диспетчера конфигурации SQL Server, чтобы подключиться к нужному компьютеру. Например, при использовании кластера с двумя узлами (**Узел A** и **Узел B**) и экземпляра отказоустойчивого кластера (**Virtsql**) с экземпляром по умолчанию подключиться к серверу, ресурс сетевого имени которого находится вне сети, можно, выполнив следующие шаги.  
  
1.  При помощи администратора кластеров определите, на каком узле группы запущен экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . Например, это **Узел A**.  
  
2.  Запустите службу [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] на этом компьютере с помощью команды **net start**. Дополнительные сведения об использовании команды **net start**см. в разделе [Запуск SQL Server вручную](https://msdn.microsoft.com/library/ms191193\(v=sql.105\).aspx).  
  
3.  Запустите диспетчер конфигурации [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] на **Узле A**. Просмотрите именованный канал, по которому прослушивает этот сервер. Название будет иметь вид \\\\.\\$$\VIRTSQL\pipe\sql\query.  
  
4.  На клиентском компьютере запустите диспетчер конфигурации SQL Server.  
  
5.  Создайте псевдоним SQLTEST1 для соединения с этим каналом по протоколу именованных каналов. Для этого введите **Узел A** в качестве имени сервера и измените имя канала на \\\\.\pipe\\$$\VIRTSQL\sql\query.  
  
6.  Подключитесь к экземпляру сервера с использованием псевдонима SQLTEST1 в качестве имени сервера.  
  
### <a name="problem-sql-server-setup-fails-on-a-cluster-with-error-11001"></a>Проблема. Программа установки SQL Server в кластере завершилась с кодом ошибки 11001.  
 **Проблема**. Потерян раздел реестра в ветке [HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft SQL Server\MSSQL.X\Cluster].  
  
 **Решение.** Убедитесь в том, что куст реестра MSSQL.X в настоящее время не используется, и удалите этот ключ кластера.  
  
### <a name="problem-cluster-setup-error-the-installer-has-insufficient-privileges-to-access-this-directory-drivemicrosoft-sql-server-the-installation-cannot-continue-log-on-as-an-administrator-or-contact-your-system-administrator"></a>Проблема. Ошибка при установке кластера: "У установщика недостаточно привилегий для доступа к данному каталогу: \<drive>\Microsoft SQL Server. Невозможно продолжить установку. Войдите в систему как администратор или обратитесь к системному администратору»  
 **Проблема**. Эта ошибка произошла из-за неправильного разбиения на разделы общего диска SCSI.  
  
 **Решение.** Создайте повторно один раздел на этом общем диске, выполнив указанные ниже действия.  
  
1.  Удалите данный дисковый ресурс из кластера.  
  
2.  Удалите на этом диске все разделы.  
  
3.  Проверьте в свойствах диска, что он является основным.  
  
4.  Создайте на этом общем диске один раздел, отформатируйте диск и присвойте ему букву.  
  
5.  Добавьте этот диск к кластеру с помощью администратора кластеров (cluadmin).  
  
6.  Запустите программу установки [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .  
  
### <a name="problem-applications-fail-to-enlist-sql-server-resources-in-a-distributed-transaction"></a>Проблема. Приложениям не удается включить ресурсы SQL Server в список в распределенной транзакции.  
 **Причина.** Поскольку координатор распределенных транзакций [!INCLUDE[msCoName](../../../includes/msconame-md.md)] (MS DTC) настроен в Windows не полностью, то приложениям, возможно, не удастся прикрепить ресурсы [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] к распределенной транзакции. Эта проблема касается связанных серверов, распределенных запросов и удаленных хранимых процедур, использующих распределенные транзакции. Дополнительные сведения о настройке MS DTC см. в разделе [Before Installing Failover Clustering](../../../sql-server/failover-clusters/install/before-installing-failover-clustering.md).  
  
 **Решение.** Для предотвращения этой проблемы необходимо полностью включить службы MS DTC на серверах, на которых установлен [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] и настроен MS DTC.  
  
 Для полного включения служб MS DTC выполните следующие шаги.  
  
1.  На панели управления откройте **Администрирование**, затем **Управление компьютером**.  
  
2.  В левой панели окна «Управление компьютером» раскройте **Службы и приложения**и щелкните **Службы**.  
  
3.  В правой панели окна "Управление компьютером" щелкните правой кнопкой мыши **Координатор распределенных транзакций**и выберите **Свойства**.  
  
4.  В окне **Координатор распределенных транзакций** перейдите на вкладку **Общие** и нажмите кнопку **Стоп** , чтобы остановить службы.  
  
5.  В окне **Координатор распределенных транзакций** перейдите на вкладку **Вход в систему** и выберите в качестве учетной записи входа NT AUTHORITY\NetworkService.  
  
6.  Нажмите кнопки **Применить** и **ОК** , чтобы закрыть окно **Координатор распределенных транзакций** . Закройте окно **Управление компьютером** . Закройте окно **Администрирование** .  
  
## <a name="using-extended-stored-procedures-and-com-objects"></a>Использование расширенных хранимых процедур и объектов COM  
 При использовании расширенных хранимых процедур в конфигурациях с отказоустойчивой кластеризацией все такие процедуры должны быть установлены на диск кластера под управлением [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Это обеспечивает возможность использования расширенных хранимых процедур после перехода узла на другой ресурс.  
  
 Если эти расширенные хранимые процедуры используют компоненты COM, администратор должен зарегистрировать эти компоненты на каждом узле кластера. Чтобы компоненты COM можно было создать, сведения для их загрузки и выполнения должны содержаться в реестре активного узла. Иначе эти сведения содержатся в реестре компьютера, на котором эти компоненты COM были зарегистрированы в первый раз.  
  
## <a name="see-also"></a>См. также:  
 [Просмотр и чтение файлов журналов программы установки SQL Server](../../../database-engine/install-windows/view-and-read-sql-server-setup-log-files.md)   
 [Принципы работы расширенных хранимых процедур](../../../relational-databases/extended-stored-procedures-programming/how-extended-stored-procedures-work.md)   
 [Характеристики выполнения расширенных хранимых процедур](../../../relational-databases/extended-stored-procedures-programming/execution-characteristics-of-extended-stored-procedures.md)  
  
