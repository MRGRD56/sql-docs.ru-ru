---
title: Прозрачное шифрование данных
description: Прозрачное шифрование данных (TDE) для параллельного хранилища данных (PDW) выполняет шифрование и расшифровку данных и файлов журналов транзакций в режиме реального времени, а также специальные файлы журнала PDW. "
author: mzaman1
ms.prod: sql
ms.technology: data-warehouse
ms.topic: conceptual
ms.date: 04/17/2018
ms.author: murshedz
ms.reviewer: martinle
ms.custom: seo-dt-2019
ms.openlocfilehash: dc6b582895a684386ed2d14b0c31612dcd0a47d1
ms.sourcegitcommit: 370cab80fba17c15fb0bceed9f80cb099017e000
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/17/2020
ms.locfileid: "97641570"
---
# <a name="transparent-data-encryption"></a>прозрачное шифрование данных.
Можно принять ряд мер предосторожности для защиты базы данных, таких как проектирование безопасной системы, шифрование конфиденциальных ресурсов и создание брандмауэра на серверах базы данных. Однако в случае кражи физического носителя (например, дисков или лент резервных копий) злоумышленник может просто восстановить или подключить базу данных и просмотреть данные. Одним из решений может стать шифрование конфиденциальных данных в базе данных и защита ключей, используемых при шифровании, с помощью сертификата. Это не позволит использовать данные ни одному человеку, не имеющему ключей, но такой тип защиты следует планировать заранее.  
  
*Прозрачное шифрование данных* (TDE) выполняет шифрование и расшифровку данных и файлов журналов транзакций в режиме реального времени, а также специальные файлы журнала PDW. При шифровании используется ключ шифрования базы данных (DEK), который хранится в загрузочной записи базы данных, где можно получить к нему доступ при восстановлении. DEK — это симметричный ключ, защищенный с помощью сертификата, хранящегося в базе данных master SQL Server PDW. Функция прозрачного шифрования данных защищает "неактивные" данные, то есть файлы данных и журналов. Благодаря ей обеспечивается соответствие требованиям различных законов, постановлений и рекомендаций, действующих в разных отраслях. Эта функция позволяет разработчикам программного обеспечения шифровать данные с помощью алгоритмов шифрования AES и 3DES без изменения существующих приложений.  
  
> [!IMPORTANT]  
> TDE не обеспечивает шифрование данных, передаваемых между клиентом и PDW. Дополнительные сведения о шифровании данных между клиентом и SQL Server PDW см. в разделе [подготавливает сертификат](provision-certificate.md).  
>   
> TDE не шифрует данные во время их перемещения или использования. Внутренний трафик между компонентами PDW в SQL Server PDW не зашифрован. Данные, временно хранящиеся в буферах памяти, не шифруются. Чтобы устранить этот риск, контролируйте физический доступ и подключения к SQL Server PDW.  
  
После защиты базы данных ее можно восстановить с помощью правильного сертификата.  
  
> [!NOTE]  
> При создании сертификата для TDE необходимо немедленно создать его резервную копию вместе с соответствующим закрытым ключом. В случае если сертификат окажется недоступен или понадобится восстановить базу данных на другом сервере либо присоединить ее к другому серверу, необходимо иметь копии сертификата и закрытого ключа. Иначе будет невозможно открыть базу данных. Сертификат шифрования следует сохранить, даже если функция прозрачного шифрования в базе данных будет отключена. Даже если база данных не зашифрована, части журнала транзакций могут по-прежнему оставаться защищенными, а для некоторых операций будет требоваться сертификат до выполнения полного резервного копирования базы данных. Сертификат, который превысил свой срок хранения, все еще может быть использован для шифрования и расшифровки данных с помощью прозрачного шифрования данных.  
  
Шифрование файлов базы данных выполняется на уровне страницы. Страницы в зашифрованной базе данных шифруются до записи на диск и дешифруются при чтении в память. Прозрачное шифрование данных не увеличивает размер зашифрованной базы данных.  
  
На следующем рисунке показана иерархия ключей для шифрования TDE:  
  
![Отображает иерархию](media/tde-architecture.png "TDE_Architecture")  
  
## <a name="using-transparent-data-encryption"></a><a name="using-tde"></a>Использование прозрачного шифрования данных  
Чтобы использовать прозрачное шифрование данных, выполните следующие действия. Первые три шага выполняются только один раз при подготовке SQL Server PDW для поддержки TDE.  
  
1.  Создайте главный ключ в базе данных master.  
  
2.  Используйте **sp_pdw_database_encryption** , чтобы включить TDE на SQL Server PDW. Эта операция изменяет временные базы данных, чтобы обеспечить защиту будущих временных данных, и при попытке выполнить все активные сеансы с временными таблицами произойдет сбой. **sp_pdw_database_encryption** включает Маскирование данных пользователя в системных журналах PDW. (Дополнительные сведения о маскировании данных пользователя в системных журналах PDW см. в разделе [sp_pdw_log_user_data_masking](../relational-databases/system-stored-procedures/sp-pdw-log-user-data-masking-sql-data-warehouse.md).)  
  
3.  Используйте [sp_pdw_add_network_credentials](../relational-databases/system-stored-procedures/sp-pdw-add-network-credentials-sql-data-warehouse.md) , чтобы создать учетные данные, которые могут выполнять проверку подлинности и запись в общую папку, где будет храниться резервная копия сертификата. Если учетные данные уже существуют для требуемого сервера хранилища, можно использовать существующие учетные данные.  
  
4.  В базе данных master создайте сертификат, защищенный главным ключом.  
  
5.  Создайте резервную копию сертификата в общей папке хранилища.  
  
6.  В базе данных пользователя создайте ключ шифрования базы данных и защитите его по сертификату, хранящемуся в базе данных master.  
  
7.  Используйте `ALTER DATABASE` инструкцию для шифрования базы данных с помощью TDE.  
  
В следующем примере показано шифрование `AdventureWorksPDW2012` базы данных с помощью сертификата `MyServerCert` , созданного в SQL Server PDW.  
  
**Сначала: Включите TDE на SQL Server PDW.** Это действие требуется только один раз.  
  
```sql  
USE master;  
GO  
  
-- Create a database master key in the master database  
CREATE MASTER KEY ENCRYPTION BY PASSWORD = '<UseStrongPasswordHere>';  
GO  
  
-- Enable encryption for PDW  
EXEC sp_pdw_database_encryption 1;  
GO  
  
-- Add a credential that can write to the share  
-- A credential created for a backup can be used if you wish  
EXEC sp_pdw_add_network_credentials 'SECURE_SERVER', '<domain>\<Windows_user>', '<password>';  
```  
  
**Во-вторых: создание и резервное копирование сертификата в базе данных master.** Это действие требуется только один раз. Для каждой базы данных можно использовать отдельный сертификат (рекомендуется) или можно защитить несколько баз данных с помощью одного сертификата.  
  
```sql  
-- Create certificate in master  
CREATE CERTIFICATE MyServerCert WITH SUBJECT = 'My DEK Certificate';  
GO  
  
-- Back up the certificate with private key  
BACKUP CERTIFICATE MyServerCert   
    TO FILE = '\\SECURE_SERVER\cert\MyServerCert.cer'  
    WITH PRIVATE KEY   
    (   
        FILE = '\\SECURE_SERVER\cert\MyServerCert.key',  
        ENCRYPTION BY PASSWORD = '<UseStrongPasswordHere>'   
    )   
GO  
```  
  
**Last: создание DEK и использование инструкции ALTER DATABASE для шифрования пользовательской базы данных.** Это действие повторяется для каждой базы данных, защищенной с помощью TDE.  
  
```sql  
USE AdventureWorksPDW2012;  
GO  
  
CREATE DATABASE ENCRYPTION KEY  
WITH ALGORITHM = AES_128  
ENCRYPTION BY SERVER CERTIFICATE MyServerCert;  
GO  
  
ALTER DATABASE AdventureWorksPDW2012 SET ENCRYPTION ON;  
GO  
```  
  
Операции шифрования и расшифровки планируются SQL Server в фоновых потоках. Состояние этих операций можно просмотреть с помощью представлений каталога и динамических административных представлений в списке, который приведен далее в этой статье.  
  
> [!CAUTION]  
> Файлы резервных копий баз данных, в которых включено TDE, также шифруются с помощью ключа шифрования базы данных. Поэтому для восстановления таких резервных копий необходимо иметь сертификат, защищающий ключ шифрования базы данных. Это значит, что помимо резервного копирования базы данных обязательно необходимо сохранять резервные копии сертификатов серверов, чтобы не допустить потери данных. Если сертификат станет недоступным, это приведет к потере данных.  
  
## <a name="commands-and-functions"></a>Команды и функции  
Чтобы в следующих инструкциях можно было использовать сертификаты TDE, они должны быть зашифрованы главным ключом базы данных.  
  
В следующей таблице представлены ссылки и объяснения команд и функций TDE.  
  
|Команда или функция|Назначение|  
|-----------------------|-----------|  
|[CREATE DATABASE ENCRYPTION KEY](../t-sql/statements/create-database-encryption-key-transact-sql.md)|Создает ключ, используемый для шифрования базы данных.|  
|[ALTER DATABASE ENCRYPTION KEY](../t-sql/statements/alter-database-encryption-key-transact-sql.md)|Изменяет ключ, используемый для шифрования базы данных.|  
|[DROP DATABASE ENCRYPTION KEY](../t-sql/statements/drop-database-encryption-key-transact-sql.md)|Удаляет ключ, использовавшийся для шифрования базы данных.|  
|[ALTER DATABASE](../t-sql/statements/alter-database-transact-sql.md?tabs=sqlpdw)|Описывает параметр **ALTER DATABASE** , который используется для включения TDE.|  
  
## <a name="catalog-views-and-dynamic-management-views"></a>Представления каталога и динамические административные представления  
В следующей таблице показаны представления каталогов и динамические административные представления TDE.  
  
|Представление каталога или динамическое административное представление|Назначение|  
|-------------------------------------------|-----------|  
|[sys.databases](../relational-databases/system-catalog-views/sys-databases-transact-sql.md)|Представление каталога со сведениями о базе данных.|  
|[sys.certificates](../relational-databases/system-catalog-views/sys-certificates-transact-sql.md)|Представление каталога с сертификатами из базы данных.|  
|[sys.dm_pdw_nodes_database_encryption_keys](../relational-databases/system-dynamic-management-views/sys-dm-pdw-nodes-database-encryption-keys-transact-sql.md)|Динамическое административное представление, предоставляющее сведения для каждого узла, сведения о ключах шифрования, используемых в базе данных, и состоянии шифрования базы данных.|  
  
## <a name="permissions"></a>Разрешения  
Для каждой функции или команды TDE действуют отдельные требования к разрешениям, описанные в таблицах выше.  
  
Для просмотра метаданных, участвующих в TDE, требуется `CONTROL SERVER` разрешение.  
  
## <a name="considerations"></a>Рекомендации  
Во время проверки базы данных на повторное шифрование, выполняемой для операции шифрования, операции обслуживания базы данных отключаются.  
  
Состояние шифрования базы данных можно узнать с помощью динамического административного представления **sys.dm_pdw_nodes_database_encryption_keys** . Дополнительные сведения см. в разделе *представления каталога и динамические административные представления* ранее в этой статье.  
  
### <a name="restrictions"></a>Ограничения  
Во время выполнения инструкций,, или не допускаются следующие операции `CREATE DATABASE ENCRYPTION KEY` `ALTER DATABASE ENCRYPTION KEY` `DROP DATABASE ENCRYPTION KEY` `ALTER DATABASE...SET ENCRYPTION` .  
  
-   Удаление базы данных.  
  
-   С помощью `ALTER DATABASE` команды.  
  
-   Запуск резервного копирования базы данных.  
  
-   Запуск восстановления базы данных.  
  
Следующие операции или условия не позволяют выполнить `CREATE DATABASE ENCRYPTION KEY` инструкции, `ALTER DATABASE ENCRYPTION KEY` , `DROP DATABASE ENCRYPTION KEY` или `ALTER DATABASE...SET ENCRYPTION` .  
  
-   `ALTER DATABASE`Выполняются команды.  
  
-   выполняется какая-либо операция резервного копирования;  
  
При создании файлов базы данных быстрая инициализация файлов недоступна при включенном TDE.  
  
### <a name="areas-not-protected-by-tde"></a>Области, не защищенные TDE  
TDE не защищает внешние таблицы.  
  
TDE не защищает диагностические сеансы. Пользователям следует избегать запросов с конфиденциальными параметрами, пока используются диагностические сеансы. Диагностические сеансы, которые раскрывают конфиденциальную информацию, должны быть удалены сразу после того, как они больше не нужны.  
  
Данные, защищенные TDE, расшифровываются при помещении в SQL Server PDWную память. Дампы памяти создаются при возникновении определенных проблем на устройстве. Файлы дампа представляют содержимое памяти во время внешнего вида проблемы и могут содержать конфиденциальные данные в незашифрованном виде. Содержимое дампов памяти следует проверить до того, как они будут предоставлены другим пользователям.  
  
База данных master не защищена с помощью TDE. Хотя база данных master не содержит пользовательских данных, она содержит такие сведения, как имена входа.  
  
### <a name="transparent-data-encryption-and-transaction-logs"></a>Прозрачное шифрование данных и журналы транзакций  
Включение использования TDE в базе данных приведет к обнулению оставшейся части журнала виртуальных транзакций для принудительного выполнения следующего журнала виртуальных транзакций. Это гарантирует, что после включения шифрования базы данных в журналах транзакций не останется простого текста. Состояние шифрования файла журнала можно найти на каждом узле PDW, просмотрев `encryption_state` столбец в `sys.dm_pdw_nodes_database_encryption_keys` представлении, как показано в следующем примере:  
  
```sql  
WITH dek_encryption_state AS   
(  
    SELECT ISNULL(db_map.database_id, dek.database_id) AS database_id, encryption_state  
    FROM sys.dm_pdw_nodes_database_encryption_keys AS dek  
        INNER JOIN sys.pdw_nodes_pdw_physical_databases AS node_db_map  
           ON dek.database_id = node_db_map.database_id AND dek.pdw_node_id = node_db_map.pdw_node_id  
        LEFT JOIN sys.pdw_database_mappings AS db_map  
            ON node_db_map .physical_name = db_map.physical_name  
        INNER JOIN sys.dm_pdw_nodes AS nodes  
            ON nodes.pdw_node_id = dek.pdw_node_id  
    WHERE dek.encryptor_thumbprint <> 0x  
)  
SELECT TOP 1 encryption_state  
       FROM dek_encryption_state  
       WHERE dek_encryption_state.database_id = DB_ID('AdventureWorksPDW2012 ')  
       ORDER BY (CASE encryption_state WHEN 3 THEN -1 ELSE encryption_state END) DESC;  
```  
  
Все данные, записанные в журнале транзакций до изменения ключа шифрования базы данных, будут зашифрованы с помощью предыдущего ключа шифрования базы данных.  
  
### <a name="pdw-activity-logs"></a>Журналы действий PDW  
SQL Server PDW поддерживает набор журналов, предназначенных для устранения неполадок. (Обратите внимание, что это не журнал транзакций, SQL Server журнал ошибок или журнал событий Windows.) Эти журналы действий PDW могут содержать полные инструкции в виде открытого текста, некоторые из которых могут содержать данные пользователя. Типичными примерами являются инструкции **INSERT** и **Update** . Маскирование пользовательских данных можно включить или отключить явным образом с помощью **sp_pdw_log_user_data_masking**. Включение шифрования в SQL Server PDW автоматически включает маскирование пользовательских данных в журналах действий PDW для их защиты. **sp_pdw_log_user_data_masking** также можно использовать для маскирования инструкций, если не используется TDE, но это не рекомендуется, так как значительно сокращает способность группы служба поддержки Майкрософт анализировать проблемы.  
  
### <a name="transparent-data-encryption-and-the-tempdb-system-database"></a>Прозрачное шифрование данных и системная база данных tempdb  
Системная база данных tempdb шифруется, если шифрование включено с помощью [sp_pdw_database_encryption](../relational-databases/system-stored-procedures/sp-pdw-database-encryption-sql-data-warehouse.md). Это необходимо, прежде чем любая база данных сможет использовать TDE. Это может повлиять на производительность незашифрованных баз данных на том же экземпляре SQL Server PDW.  
  
## <a name="key-management"></a>Управление ключами  
Ключ шифрования базы данных (DEK) защищается сертификатами, хранящимися в базе данных master. Эти сертификаты защищаются с помощью главного ключа базы данных (DMK) базы данных master. DMK должен быть защищен главным ключом службы (SMK), чтобы его можно было использовать для TDE.  
  
Система может получить доступ к ключам, не требуя вмешательства пользователя (например, для предоставления пароля). Если сертификат недоступен, система выводит сообщение об ошибке, объясняющее, что DEK не может быть расшифрован до тех пор, пока не будет доступен соответствующий сертификат.  
  
При перемещении базы данных с одного устройства на другое сертификат, используемый для защиты его DEK, должен быть сначала восстановлен на целевом сервере. Затем базу данных можно восстановить как обычно. Дополнительные сведения см. в стандартной SQL Server документации по [перемещению защищенной базы данных TDE в другую SQL Server](../relational-databases/security/encryption/move-a-tde-protected-database-to-another-sql-server.md).  
  
Сертификаты, используемые для шифрования DEK, должны храниться при условии, что они используют резервные копии базы данных. Резервные копии сертификатов должны включать закрытый ключ сертификата, поскольку без закрытого ключа сертификат нельзя использовать для восстановления базы данных. Резервные копии закрытых ключей сертификатов хранятся в отдельном файле, защищенном паролем, который необходимо указать для восстановления сертификата.  
  
## <a name="restoring-the-master-database"></a>Восстановление базы данных master  
Базу данных master можно восстановить с помощью **DWConfig** в рамках аварийного восстановления.  
  
-   Если узел управления не изменился, то есть база данных master восстанавливается на том же и в неизмененном устройстве, на котором была создана резервная копия базы данных master, DMK и все сертификаты будут доступны для чтения без дополнительных действий.  
  
-   Если база данных master восстанавливается на другом устройстве или если узел управления был изменен с момента создания резервной копии базы данных master, то для повторного создания DMK потребуется выполнить дополнительные действия.  
  
    1.  Откройте DMK:  
  
        ```sql  
        OPEN MASTER KEY DECRYPTION BY PASSWORD = '<password>';  
        ```  
  
    2.  Добавьте шифрование с помощью SMK:  
  
        ```sql  
        ALTER MASTER KEY   
            ADD ENCRYPTION BY SERVICE MASTER KEY;  
        ```  
  
    3.  Перезапустите устройство.  
  
## <a name="upgrade-and-replacing-virtual-machines"></a>Обновление и замена виртуальных машин  
Если DMK существует на устройстве, на котором была выполнена обновление или замена виртуальной машины, в качестве параметра должен быть указан пароль DMK.  
  
Пример действия обновления. Замените `**********` паролем DMK.  
  
`setup.exe /Action=ProvisionUpgrade ... DMKPassword='**********'`  
  
Пример действия для замены виртуальной машины.  
  
`setup.exe /Action=ReplaceVM ... DMKPassword='**********'`  
  
При обновлении, если пользовательская база данных зашифрована и пароль DMK не указан, действие обновления завершится ошибкой. Если при выполнении операции Replace не указан правильный пароль при наличии DMK, операция пропустит шаг восстановления DMK. Все остальные шаги будут выполнены в конце действия заменить виртуальную машину, однако действие сообщит об ошибке в конце, чтобы указать, что требуются дополнительные действия. В журналах установки (которые находятся в папке **\програмдата\микрософт\микрософт SQL Server Parallel Data Warehouse\100\Logs\Setup \\<время-метка> \детаил-сетуп**) в конце будет отображаться следующее предупреждение.  
  
`**_ WARNING \_\*\* DMK is detected in master database, but could not be recovered automatically! The DMK password was either not provided or is incorrect!`
  
Выполните эти инструкции вручную в PDW и перезапустите устройство после этого, чтобы восстановить DMK:  
  
```sql
OPEN MASTER KEY DECRYPTION BY PASSWORD = '<DMK password>';  
ALTER MASTER KEY ADD ENCRYPTION BY SERVICE MASTER KEY;  
```
  
Выполните действия, описанные в разделе Восстановление базы данных **master** , чтобы восстановить базу данных, а затем перезапустите устройство.  
  
Если DMK существовал ранее, но не был восстановлен после выполнения действия, при запросе базы данных будет выдано следующее сообщение об ошибке.  
  
```sql
Msg 110806;  
A distributed query failed: Database '<db_name>' cannot be opened due to inaccessible files or insufficient memory or disk space. See the SQL Server errorlog for details.
```  
  
## <a name="performance-impact"></a>Влияние на производительность  
Влияние TDE зависит от типа данных, способа их хранения и типа активности рабочей нагрузки в SQL Server PDW. При защите с помощью TDE операции чтения и расшифровки данных, а также шифрование и запись данных являются трудоемким действием ЦП и повлияют на то, что другие операции с интенсивным использованием ЦП будут происходить одновременно. Поскольку TDE шифрует `tempdb` , TDE может повлиять на производительность баз данных, которые не шифруются. Чтобы получить точную информацию о производительности, следует протестировать всю систему с помощью данных и действий запросов.  
  
## <a name="related-content"></a>См. также  
Следующие ссылки содержат общие сведения о том, как SQL Server управляет шифрованием. Эти статьи помогут вам разобраться SQL Server шифровании, но в этих статьях нет сведений, относящихся к SQL Server PDW и обсуждаются функции, отсутствующие в SQL Server PDW.  
  
-   [Шифрование SQL Server](../relational-databases/security/encryption/sql-server-encryption.md)  
  
-   [Иерархия средств шифрования](../relational-databases/security/encryption/encryption-hierarchy.md)  
  
-   [SQL Server и ключи шифрования базы данных](../relational-databases/security/encryption/sql-server-and-database-encryption-keys-database-engine.md)  

  
## <a name="see-also"></a>См. также:  
[ALTER DATABASE](../t-sql/statements/alter-database-transact-sql.md?tabs=sqlpdw)  
[CREATE MASTER KEY](../t-sql/statements/create-master-key-transact-sql.md)  
[CREATE DATABASE ENCRYPTION KEY](../t-sql/statements/create-database-encryption-key-transact-sql.md)  
[BACKUP CERTIFICATE](../t-sql/statements/backup-certificate-transact-sql.md)  
[sp_pdw_database_encryption](../relational-databases/system-stored-procedures/sp-pdw-database-encryption-sql-data-warehouse.md)  
[sp_pdw_database_encryption_regenerate_system_keys](../relational-databases/system-stored-procedures/sp-pdw-database-encryption-regenerate-system-keys-sql-data-warehouse.md)  
[sp_pdw_log_user_data_masking](../relational-databases/system-stored-procedures/sp-pdw-log-user-data-masking-sql-data-warehouse.md)  
[sys.certificates](../relational-databases/system-catalog-views/sys-certificates-transact-sql.md)  
[sys.dm_pdw_nodes_database_encryption_keys](../relational-databases/system-dynamic-management-views/sys-dm-pdw-nodes-database-encryption-keys-transact-sql.md)  
