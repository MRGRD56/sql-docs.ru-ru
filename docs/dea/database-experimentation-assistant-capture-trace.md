---
title: Запись трассировки для SQL Server обновлений
description: Используйте Database Experimentation Assistant (ДЕА), чтобы создать файл трассировки с журналом перехваченных событий сервера.
ms.custom: seo-lt-2019
ms.date: 12/12/2019
ms.prod: sql
ms.prod_service: dea
ms.suite: sql
ms.technology: dea
ms.tgt_pltfrm: ''
ms.topic: conceptual
author: pochiraju
ms.author: rajpo
ms.reviewer: mathoma
ms.openlocfilehash: 67b427e7d1d73b072ce2ec319bfc3cbcbbcfddf9
ms.sourcegitcommit: 71d2389cf27156fa0404a6e6f65fb7a61c40789a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/01/2020
ms.locfileid: "91636104"
---
# <a name="capture-a-trace-in-database-experimentation-assistant"></a>Запись трассировки в Database Experimentation Assistant

Database Experimentation Assistant (ДЕА) можно использовать для создания файла трассировки с журналом перехваченных событий сервера. Перехваченное событие сервера — это событие, возникающее на определенном сервере за определенный период времени. Запись трассировки должна выполняться один раз для каждого сервера.

Прежде чем начать запись трассировки, убедитесь, что резервное копирование всех целевых баз данных выполнено.

Кэширование запросов в SQL Server может повлиять на результаты оценки. Рекомендуется перезапустить службу SQL Server (MSSQLSERVER) в приложении "службы", чтобы повысить согласованность результатов оценки.

## <a name="configure-a-trace-capture"></a>Настройка отслеживания трассировки

1. В ДЕА на панели навигации слева щелкните значок камеры, а затем на странице **все записи** выберите **создать запись**.

    ![Создание записи в ДЕА](./media/database-experimentation-assistant-capture-trace/dea-initiate-capture.png)

2. На странице **Новая запись** в разделе **сведения о захвате**введите или выберите следующие сведения.

    - **Имя записи**: введите имя файла трассировки для записи.
    - **Формат**: укажите формат (Trace или XEvents) для записи.
    - **Длительность**: выберите период времени (в минутах), в течение которого должна выполняться запись трассировки.
    - **Расположение для записи**: выберите путь назначения для файла трассировки.

        > [!NOTE]
        > Путь к файлу трассировки должен находиться на компьютере, на котором работает SQL Server. Если служба SQL Server не задана для конкретной учетной записи, для записи файла трассировки службе могут потребоваться разрешения на запись в указанную папку.

3. Убедитесь, что вы выполнили резервное копирование, выбрав **Да, я вручную затратил резервную копию...** .

4. В разделе **сведения о записи**введите или выберите следующие сведения.

    - **Тип сервера**: Укажите тип SQL Server (**SQLServer**, **азуресклдб**, **азуресклманажединстанце**).
    - **Имя сервера**: укажите имя или IP-адрес сервера SQL Server.
    - **Тип проверки подлинности**. Выберите **Windows**в качестве типа проверки подлинности.
    - **Имя базы данных**: введите имя базы данных, в которой должна начаться трассировка базы данных. Если не указать базу данных, трассировка будет захвачена во всех базах данных на сервере.

5. Установите или снимите флажки **Шифровать соединение** и **доверять сертификату сервера** в соответствии с вашими сценариями.

    ![Страница «Создание записи»](./media/database-experimentation-assistant-capture-trace/dea-new-capture.png)

## <a name="start-the-trace-capture"></a>Начать запись трассировки

1. После ввода или выбора требуемой информации выберите **Запуск** , чтобы начать запись трассировки.

    Если введенная информация действительна, начнется процесс отслеживания трассировки. В противном случае текстовые поля с недопустимыми записями выделяются красным цветом. Если возникнут ошибки, исправьте все необходимые записи и нажмите кнопку **запустить** еще раз.

    Пока выполняется запись трассировки, в разделе **сведения о захвате**отображается состояние и ход выполнения процесса отслеживания трассировки.

    ![Ход выполнения отслеживания](./media/database-experimentation-assistant-capture-trace/dea-capture-running.png)

2. После завершения записи трассировки новый файл трассировки (TRC) сохраняется в указанном **месте для записи** , которое вы задаете во время начальной настройки.

    ![Запись трассировки завершена](./media/database-experimentation-assistant-capture-trace/dea-capture-complete.png)

    Файл трассировки содержит результаты трассировки действия SQL Server базы данных. файлы TRC предназначены для предоставления дополнительных сведений об ошибках, обнаруженных и сообщаемых SQL Server.

## <a name="frequently-asked-questions-about-trace-capture"></a>Часто задаваемые вопросы о захвате трассировки

Ниже приведены некоторые часто задаваемые вопросы о захвате трассировки в ДЕА.

**Вопрос. какие события фиксируются при выполнении записи трассировки в рабочей базе данных?**

В следующей таблице перечислены события и соответствующие данные столбцов, которые ДЕА собирает для трассировок.
  
|Имя события|Текстовые данные (1)|Двоичные данные (2)|Идентификатор базы данных (3)|Имя узла (8)|Имя приложения (10)|Имя для входа (11)|SPID (12)|Время начала (14)|Время окончания (15)|Имя базы данных (35)|Последовательность событий (51)|Система (60)|  
|---|---|---|---|---|---|---|---|---|---|---|---|---|  
|**RPC: завершено (10)**||*|*|*|*|*|*|*|*|*|*|*|  
|**RPC: запуск (11)**||*|*|*|*|*|*|*||*|*|*|  
|**Выходной параметр RPC (100)**|*||*|*|*|*|*|*||*|*|*|  
|**SQL: BatchCompleted (12)**|*||*|*|*|*|*|*|*|*|*|*|  
|**SQL: BatchStarting (13)**|*||*|*|*|*|*|*||*|*|*|  
|**Имя входа аудита (14)**|*|*|*|*|*|*|*|*||*|*|*|  
|**Аудит выхода (15)**|*||*|*|*|*|*|*|*|*|*|*|  
|**ExistingConnection (17)**|*|*|*|*|*|*|*|*||*|*|*|  
|**CursorOpen (53)**|*||*|*|*|*|*|*||*|*|*|  
|**CursorPrepare (70)**|*||*|*|*|*|*|*||*|*|*|  
|**Подготовка SQL (71)**|||*|*|*|*|*|*||*|*|*|  
|**Exec Prepared SQL (72)**|||*|*|*|*|*|*||*|*|*|  
|**CursorExecute (74)**|*||*|*|*|*|*|*||*|*|*|  
|**CursorUnprepare (77)**|*||*|*|*|*|*|*||*|*|*|  
|**CursorClose (78)**|*||*|*|*|*|*|*||*|*|*|  

**Вопрос. влияет ли производительность на рабочем сервере при выполнении отслеживания трассировки?**

Да, во время сбора трассировки имеется минимальный результат производительности. В наших тестах мы обнаружили нехватку памяти в 3%.

**Вопрос. какие разрешения требуются для отслеживания трассировок в рабочей нагрузке?**

- Пользователь Windows, выполняющий операцию трассировки в приложении Деа, должен иметь права системного администратора на компьютере, на котором выполняется SQL Server.
- Учетная запись службы, используемая на компьютере, на котором работает SQL Server, должна иметь доступ на запись к указанному пути файла трассировки.

**Вопрос. можно ли записывать трассировки для всего сервера или только для одной базы данных?**

ДЕА можно использовать для захвата трассировок для всех баз данных на сервере или для отдельной базы данных.

**Вопрос. у меня есть связанный сервер, настроенный в рабочей среде. Отображаются ли эти запросы в трассировках?**

Если вы запускаете трассировку трассировки для всего сервера, Трассировка захватывает все запросы, включая запросы связанных серверов. Чтобы запустить запись трассировки для всего сервера, оставьте поле **имя базы данных** в разделе **Новая запись** пустой.

**Вопрос. Каково минимальное рекомендуемое время для трассировок рабочей нагрузки в рабочей нагрузке?**

Рекомендуется выбрать время, которое лучше всего соответствует всей рабочей нагрузке. Таким образом, анализ выполняется для всех запросов в рабочей нагрузке.

**Вопрос. насколько важно сделать резервную копию базы данных непосредственно перед началом записи трассировки?**

Прежде чем начать запись трассировки, убедитесь, что вы создаете резервные копии всех целевых баз данных. Захваченная трассировка в целевом объекте 1 и целевом объекте 2 воспроизводится. Если состояние базы данных не совпадает, результаты эксперимента будут отклонены.

**Вопрос. можно ли получить XEvents вместо трассировок и можно ли воспроизвести XEvents?**

Да. ДЕА поддерживает XEvents. Скачайте последнюю версию ДЕА и придайте ей попытку.

## <a name="troubleshoot-trace-captures"></a>Устранение неполадок при захватах трассировки

Если при выполнении записи трассировки отображается сообщение об ошибке, убедитесь, что:

- Имя компьютера, на котором работает SQL Server, является допустимым. Для подтверждения попробуйте подключиться к компьютеру, на котором работает SQL Server, с помощью SQL Server Management Studio (SSMS).
- Конфигурация брандмауэра не блокирует подключения к компьютеру, на котором работает SQL Server.
- Пользователь имеет разрешения, перечисленные в [разделе часто задаваемые вопросы о воспроизведении](./database-experimentation-assistant-replay-trace.md?view=sql-server-ver15#frequently-asked-questions-about-trace-replay).
- Имя трассировки не соответствует стандартному соглашению о смене ключей (захват \_ 1). Вместо этого попробуйте использовать такие имена трассировок, как Capture \_ 1A или Capture1.

Ниже приведены некоторые возможные ошибки, которые могут возникнуть, и способы их устранения.

|Возможные ошибки|Решение|  
|---|---|  
|Не удалось запустить трассировку на целевом SQL Server, проверьте наличие необходимых разрешений и убедитесь, что учетная запись SQL Server имеет доступ на запись к указанному пути файла трассировки код ошибки SQL (53)|Пользователь, запускающий средство Деа, должен иметь доступ к компьютеру, на котором работает SQL Server. Пользователю должна быть назначена роль sysadmin.|  
|Не удалось запустить трассировку на целевом SQL Server, проверьте наличие необходимых разрешений и убедитесь, что учетная запись SQL Server имеет доступ на запись к указанному пути файла трассировки код ошибки SQL (19062)|Указанный путь трассировки может не существовать, или папка не имеет разрешений на запись для учетной записи, от имени которой работают службы SQL Server (например, СЕТЕВая служба). Путь должен существовать и должен иметь необходимые разрешения для запуска трассировки.|  
|Сейчас на целевом сервере выполняется трассировка ДЕА.|Активная трассировка уже запущена на целевом сервере. Вы не можете начать новую трассировку, если уже выполняется трассировка на уровне сервера.|  
|Не удается открыть запрошенную базу данных для записи трассировки. Эта ошибка может быть вызвана неверным именем базы данных.|Указанная база данных не существует или недоступна текущему пользователю. Используйте правильное имя базы данных.|  

Если вы видите другие ошибки с меткой " *код ошибки SQL*", см. раздел [ядро СУБД Errors](../relational-databases/errors-events/database-engine-events-and-errors.md) For detailed descriptions.

## <a name="see-also"></a>См. также раздел

- Сведения о настройке средств распределенное воспроизведение в SQL Server перед воспроизведением захваченной трассировки см. в разделе [настройка распределенное воспроизведение для Database experimentation Assistant](database-experimentation-assistant-configure-replay.md).