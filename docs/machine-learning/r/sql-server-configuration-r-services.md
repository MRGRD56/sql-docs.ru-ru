---
title: Настройка для использования с языком R
description: В этой статье содержатся рекомендации по настройке параметров оборудования и сети компьютера, используемого для запуска SQL Server R Services.
ms.prod: sql
ms.technology: machine-learning-services
ms.date: 03/29/2019
ms.topic: how-to
author: dphansen
ms.author: davidph
ms.custom: seo-lt-2019
monikerRange: '>=sql-server-2016||>=sql-server-linux-ver15||=sqlallproducts-allversions'
ms.openlocfilehash: f9d4d3eab9f8f6d1d19b107eaf3825e9488df382
ms.sourcegitcommit: 9b41725d6db9957dd7928a3620fe4db41eb51c6e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/13/2020
ms.locfileid: "88180477"
---
# <a name="sql-server-configuration-for-use-with-r"></a>Настройка SQL Server для использования с языком R
[!INCLUDE [SQL Server 2016 and later](../../includes/applies-to-version/sqlserver2016.md)]

Эта статья является второй в серии. В ней описывается оптимизация производительности для служб R Services на примере двух случаев.  В этой статье содержатся рекомендации по настройке параметров оборудования и сети компьютера, который используется для запуска SQL Server R Services. В ней также содержатся сведения о способах настройки экземпляра SQL Server, базы данных и таблиц, используемых в решении. Поскольку использование NUMA в SQL Server размывает границу между оптимизацией оборудования и базы данных, в третьем разделе подробно обсуждается привязка к ЦП и управление ресурсами.

> [!TIP]
> Если вы не знакомы с SQL Server, настоятельно рекомендуем также ознакомиться с руководством по настройке производительности SQL Server: [Наблюдение и настройка производительности](https://docs.microsoft.com/sql/relational-databases/performance/monitor-and-tune-for-performance).

## <a name="hardware-optimization"></a>Оптимизация оборудования

Оптимизация серверного компьютера важна для обеспечения доступности ресурсов для выполнения внешних сценариев. Если ресурсы ограничены, могут проявляться следующие симптомы:

- Выполнение задания откладывается или отменяется в результате более высокого приоритета других операций с базой данных
- Ошибка "превышение квоты", вызывающая преждевременное завершение сценария R
- Усечение данных, загруженных в память R, что ведет к получению неполных результатов

### <a name="memory"></a>Память

Объем доступной памяти может иметь значительное влияние на производительность расширенных аналитических алгоритмов. Недостаток памяти может повлиять на степень параллелизма при использовании контекста вычислений SQL. Это также может повлиять на размер фрагмента данных (строк на каждую операцию чтения), который можно обработать, и поддерживаемое число одновременных сеансов.

Настоятельно рекомендуется установить не менее 32 ГБ. Если у вас больше 32 ГБ памяти, вы можете настроить источник данных SQL так, чтобы использовать большее число строк в каждой операции чтения для улучшения производительности.

Кроме того, можно управлять памятью, используемой экземпляром. По умолчанию при выделении памяти SQL Server имеет больший приоритет, чем процессов внешних сценариев. При установке служб R по умолчанию для R выделяется только 20 % доступной памяти.

Как правило, этого недостаточно для задач обработки и анализа данных, но также не стоит и сильно ограничивать память для SQL Server. Следует поэкспериментировать и точно настроить распределение памяти между ядром СУБД, связанными службами и внешними сценариями, имея ввиду, что оптимальная конфигурация зависит от конкретного случая.

Для модели отбора подходящих резюме использование внешнего скрипта было сопряжено с трудностями, а другие службы ядра СУБД не были запущены. Таким образом, объем ресурсов, выделенных для внешних скриптов, был увеличен до 70 %, что является оптимальной конфигурацией для производительности скриптов.

### <a name="power-options"></a>Параметры питания

В операционной системе Windows должен использоваться параметр питания **Высокая производительность**. Другой параметр приведет к снижению или несогласованности производительности при использовании SQL Server.

### <a name="disk-io"></a>Дисковые операции ввода-вывода

Задания обучения и прогнозирования, в которых используются службы R, являются по определению связанными с операциями ввода-вывода и зависят от скорости дисков, на которых хранится база данных. Повысить эффективность могут более быстрые диски, например твердотельные накопители (SSD).

На дисковые операции ввода-вывода также оказывают влияние и другие приложения, у которых есть доступ к диску, например операции чтения базы данных, выполняемые другими клиентами. На производительность дисковых операций ввода-вывода могут влиять параметры текущей файловой системы, например размер блока, используемый этой системой.

Если доступны несколько дисков, мы советуем хранить базы данных не на том диске, где размещен SQL Server. Это необходимо, чтобы для запросов к ядру СУБД не использовался тот же диск, что и для запросов данных, хранящихся в базе данных.

Дисковые операции ввода-вывода могут оказывать значительное влияние на производительность при выполнении аналитических функций RevoScaleR, использующих несколько итераций во время обучения. Например, функции `rxLogit`, `rxDTree`, `rxDForest` и `rxBTrees` используют несколько итераций. Если источником данных является SQL Server, эти алгоритмы используют временные файлы, оптимизированные для сбора данных. Эти файлы автоматически удаляются после завершения сеанса. Если у вас есть диск с высокой производительностью для операций чтения или записи, это может значительно оптимизировать общее время, необходимое для выполнения этих алгоритмов.

> [!NOTE]
> Ранние версии служб R требовали поддержки формата 8.3 для имен файлов в операционных системах Windows. Это ограничение было снято после выпуска пакета обновления 1 (SP1). Однако, вы можете использовать файл fsutil.exe, чтобы определить, поддерживает ли диск имена файлов 8.3, и включить эту поддержку, если она отключена.

### <a name="paging-file"></a>Файл подкачки

Операционная система Windows использует файл подкачки для управления аварийными дампами и хранения страниц виртуальной памяти. Если обнаружена излишняя подкачка, необходимо увеличить физическую память компьютера. Несмотря на то что больший объем физической памяти не устранит подкачку, это значительно уменьшит потребность в ней.

Скорость диска, на котором хранится файл подкачки, также влияет на производительность. Вы можете улучшить ее, если сохраните файл подкачки на диске SSD или если будете использовать файлы подкачки на нескольких дисках SSD.

Дополнительные сведения об изменении размера файла подкачки см. в статье [Как определить размер файла подкачки для 64-разрядных версий Windows](https://support.microsoft.com/kb/2860880).

## <a name="optimizations-at-instance-or-database-level"></a>Оптимизация на уровне экземпляра или базы данных

Оптимизация экземпляра SQL Server является ключом к эффективному выполнению внешних сценариев.

> [!NOTE]
> Оптимальные параметры различаются в зависимости от размера и типа данных, числа столбцов, используемых для оценки или обучения модели.
> 
> Результаты конкретной оптимизации можно посмотреть в заключительной статье: [Настройка производительности — результаты примеров использования](../../machine-learning/r/performance-case-study-r-services.md)
> 
> Примеры сценариев см. в отдельном [репозитории GitHub](https://github.com/Microsoft/SQL-Server-R-Services-Samples/tree/master/PerfTuning).

### <a name="table-compression"></a>Сжатие таблицы

Производительность операций ввода-вывода часто можно улучшить с помощью сжатия или столбцового хранилища данных. Обычно данные повторяются в нескольких столбцах в таблице. Индекс columnstore позволяет воспользоваться этим при сжатии данных.

Он может быть не слишком эффективен, если в таблицу производятся частые вставки. Если же данные являются статическими или редко изменяются, использование индекса columnstore оправдано. Если хранилище столбцов нельзя использовать по каким-либо причинам, чтобы улучшить операции ввода-вывода, можно включить сжатие для основной таблицы строк.

Дополнительные сведения см. в следующих документах:

+ [Сжатие данных](../../relational-databases/data-compression/data-compression.md)

+ [Включение сжатия таблицы или индекса](../../relational-databases/data-compression/enable-compression-on-a-table-or-index.md)

+ [Руководство по индексам columnstore](../../relational-databases/indexes/columnstore-indexes-overview.md)

### <a name="memory-optimized-tables"></a>Таблицы, оптимизированные для памяти

В настоящее время, память больше не является проблемой для современных компьютеров. По мере того как спецификации оборудования продолжают совершенствоваться, становится достаточно легко получить оперативную память по приемлемым ценам. Однако в то же время данные генерируются быстрее, чем раньше, и их нужно обрабатывать с низкой задержкой.

Оптимизированные для памяти таблицы являются одним из способов решения проблем обработки больших данных, при котором используются большие объемы памяти, доступные в современных компьютерах. Оптимизированные для памяти таблицы в основном находятся в памяти, поэтому данные считываются из памяти и записываются в память. Для обеспечения надежности копия таблицы сохраняется на диске, а данные считываются с диска только во время восстановления базы данных.

Если необходимо часто выполнять чтение и запись в таблицы, оптимизированные для памяти таблицы могут обеспечить высокую масштабируемость и низкую задержку.  В сценарии отбора подходящих резюме оптимизированные для памяти таблицы позволили нам считать все данные резюме из базы данных и сохранить их в основной памяти, чтобы находить соответствия новым вакансиям. Это значительно сокращает число операций ввода-вывода на диск.

Увеличение производительности достигается за счет использования оптимизированной для памяти таблицы в процессе записи прогнозов обратно в базу данных из нескольких параллельных пакетов. Использование оптимизированных для памяти таблиц в SQL Server обеспечивает низкую задержку при чтении и записи таблицы.

Во время разработки этот процесс также был прозрачным. Надежные оптимизированные для памяти таблицы были созданы одновременно с созданием базы данных. Таким образом, для разработки используется один и тот же рабочий процесс независимо от того, где хранятся данные.

### <a name="processor"></a>Процессор

SQL Server может выполнять параллельные задачи, используя доступные ядра на компьютере. Чем больше ядер, тем лучше производительность. Хотя увеличение количество ядер может и не повлиять на скорость операций ввода-вывода, алгоритмы с привязкой к ЦП будут выполняться эффективнее при использовании быстрых ЦП с большим количеством ядер.

Так как сервер обычно использует одновременно несколько пользователей, администратор базы данных должен определить оптимальное количество ядер, необходимых для поддержки в периоды пиковых вычислений рабочих нагрузок.

### <a name="resource-governance"></a>Управление ресурсами

В выпусках, поддерживающих Resource Governor, можно использовать пулы ресурсов для указания того, что для определенных рабочих нагрузок выделяется некоторое количество ЦП. Кроме того, можно управлять объемом памяти, выделяемой для конкретных рабочих нагрузок.

Управление ресурсами в SQL Server позволяет централизовать наблюдение и управление различными ресурсами, используемыми SQL Server и R. Например, можно выделить половину доступной памяти для ядра СУБД, чтобы обеспечить постоянное выполнение основных служб, несмотря на временное возникновение более тяжелых рабочих нагрузок.

Значение по умолчанию для потребления памяти внешними сценариями составляет 20 % от общей памяти, доступной для SQL Server. Это ограничение применяется по умолчанию, чтобы гарантировать, что все задачи, зависящие от сервера базы данных, не будут серьезно затронуты долго выполняющимися заданиями R. Однако администратор базы данных может изменить эти ограничения. Во многих случаях ограничение в 20 % не подходит для поддержки серьезных рабочих нагрузок машинного обучения.

Поддерживаются параметры конфигурации **MAX_CPU_PERCENT**, **MAX_MEMORY_PERCENT** и **MAX_PROCESSES**. Чтобы просмотреть текущие параметры, используйте инструкцию `SELECT * FROM sys.resource_governor_external_resource_pools`

-  Если сервер используется в основном для служб R, тогда потребление ресурсов ЦП (MAX_CPU_PERCENT) можно увеличить до 40 % или 60 %.

-  Если несколько сеансов R должны использовать один и тот же сервер одновременно, необходимо увеличить все три параметра.

Чтобы изменить значения выделенных ресурсов, используйте инструкции T-SQL.

+ Эта инструкция задает потребление памяти на уровне 40 %: `ALTER EXTERNAL RESOURCE POOL [default] WITH (MAX_MEMORY_PERCENT = 40)`

+ Эта инструкция задает значение всех трех настраиваемых параметров: `ALTER EXTERNAL RESOURCE POOL [default] WITH (MAX_CPU_PERCENT = 40, MAX_MEMORY_PERCENT = 50, MAX_PROCESSES = 20)`

+ Если вы изменили значение параметра для памяти, ЦП или максимального количества процессов и хотите применить изменения немедленно, выполните следующую инструкцию: `ALTER RESOURCE GOVERNOR RECONFIGURE`

## <a name="soft-numa-hardware-numa-and-cpu-affinity"></a>Программный и аппаратный NUMA и соответствие процессоров

При использовании SQL Server в качестве контекста вычислений иногда можно добиться лучшей производительности путем настройки параметров, связанных с NUMA и соответствием процессоров. 

Системы с _аппаратным NUMA_ имеют несколько системных шин, каждая из которых обслуживает небольшую группу процессоров. Каждый ЦП может получить доступ к памяти, связанной с другими группами, согласованным образом. Каждая группа называется узлом NUMA. Если имеется оборудование NUMA, оно может быть настроено так, что вместо NUMA используется чередующаяся память. В этом случае Windows и, следовательно, SQL Server, не обнаружат на компьютере аппаратной поддержки NUMA. 

Можно выполнить следующий запрос, чтобы узнать, сколько узлов памяти доступно SQL Server:

```sql
SELECT DISTINCT memory_node_id
FROM sys.dm_os_memory_clerks
```

Если запрос возвращает один узел памяти (узел 0), компьютер либо не имеет оборудования NUMA, либо оборудование настроено на использование чередующейся памяти (не NUMA). SQL Server также игнорирует аппаратную архитектуру NUMA при наличии четырех и менее процессоров или в случае, если хотя бы один узел имеет только один ЦП.

Если на компьютере установлено несколько процессоров, но на нем нет аппаратного NUMA, можно также использовать [Soft-NUMA](https://docs.microsoft.com/sql/database-engine/configure-windows/soft-numa-sql-server) (программный NUMA), чтобы разделить процессоры на мелкие группы.  В SQL Server 2016 и SQL Server 2017 функция Soft-NUMA автоматически включается при запуске службы SQL Server.

При включении функции Soft-NUMA SQL Server управляет узлами автоматически. Однако для оптимизации конкретных рабочих нагрузок можно отключить _мягкое соответствие_ и вручную настроить сопоставление ЦП с программными узлами NUMA. Это обеспечивает более полный контроль над тем, какие рабочие нагрузки назначаются узлам, особенно если используется выпуск SQL Server с поддержкой управления ресурсами. Указав привязку ЦП и распределив пулы ресурсов по группам ЦП, можно сократить задержку и убедиться, что связанные процессы выполняются в пределах одного узла NUMA.

Общий процесс настройки архитектуры Soft-NUMA и установки соответствия ЦП для поддержки рабочих нагрузок R выглядит следующим образом:

1. Включение программной архитектуры NUMA (при наличии)
2. Определение соответствия процессоров
3. Создание пулов ресурсов для внешних процессов с помощью [Resource Governor](../administration/resource-governor.md)
4. Привязка [групп рабочей нагрузки](../../relational-databases/resource-governor/resource-governor-workload-group.md) к конкретным группам ЦП

Дополнительные сведения, включая пример кода, см. в этом руководстве: [SQL Optimization Tips and Tricks (Ke Huang)](https://gallery.cortanaintelligence.com/Tutorial/SQL-Server-Optimization-Tips-and-Tricks-for-Analytics-Services) (Советы и рекомендации по оптимизации SQL (Ке Хуанг))

**Другие ресурсы:**

+ [Архитектура Soft-NUMA в SQL Server](https://docs.microsoft.com/sql/database-engine/configure-windows/soft-numa-sql-server)
    
    Как сопоставить узлы Soft-NUMA с ЦП

## <a name="task-specific-optimizations"></a>Оптимизация для конкретных задач

В этом разделе приводятся сводные сведения о методах, используемых в рассматриваемых примерах, а также в других тестах, для оптимизации конкретных рабочих нагрузок машинного обучения. К типичным рабочим нагрузкам относятся обучение модели, извлечение и формирование признаков, а также существуют различные сценарии оценки: одна строка, малый пакет и крупный пакет.

### <a name="feature-engineering"></a>Проектирование признаков

Одна из проблем использования языка R заключается в том, что он обычно обрабатывается на одном ЦП. Это очень узкое место в плане производительности для многих задач, особенно для формирования признаков. В решении для отбора подходящих резюме только одна задача формирования признаков создала 2500 функций для нескольких продуктов, которые должны быть объединены с исходными 100 функциями. Эта задача займет значительное время, если все это будет выполняться на одном ЦП.

Существует несколько способов повысить производительность формирования признаков. Можно либо оптимизировать код R, чтобы извлекать компоненты в рамках процесса моделирования, либо переместить процесс формирования признаков в SQL.

- Использование языка R. Вы определяете функцию и передаете ее в качестве аргумента в [rxTransform](https://docs.microsoft.com/r-server/r-reference/revoscaler/rxtransform) во время обучения. Если модель поддерживает параллельную обработку, задача проектирования признаков может быть обработана с использованием нескольких процессоров. При таком подходе группа обработки и анализа данных зафиксировала повышение производительности на 16 % с точки зрения выигрыша во времени. Однако для этого подхода требуется модель, которая поддерживает параллелизацию, и запрос, который можно выполнить с помощью параллельного плана.

- Использование языка R с контекстом вычислений в SQL. В многопроцессорной среде с изолированными ресурсами, доступными для выполнения отдельных пакетов, можно повысить эффективность, изолируя запросы SQL, используемые для каждого пакета, для извлечения данных из таблиц и ограничения данных в одной группе рабочей нагрузки. Методы, используемые для изоляции пакетов, включают секционирование и использование PowerShell для параллельного выполнения отдельных запросов.

- Непосредственное параллельное выполнение: В контексте вычислений SQL Server можно полагаться на ядро СУБД SQL, чтобы принудительно применять параллельное выполнение, если это возможно, и если этот вариант будет более эффективным.

- Использование T-SQL в отдельном процессе формирования признаков. Предварительное вычисление данных о признаках с помощью SQL обычно выполняется быстрее.

### <a name="prediction-scoring-in-parallel"></a>Прогнозирование (оценка) в параллельном режиме

Одним из преимуществ SQL Server является возможность параллельной обработки большого объема строк. Это преимущество особенно заметно при выполнении оценки. Обычно модели не требуется доступ ко всем данным для оценки, поэтому можно секционировать входные данные, чтобы каждая группа рабочей нагрузки обрабатывала одну задачу.

Можно также отправить входные данные в виде одного запроса, а затем SQL Server его проанализирует. Если для входных данных можно создать параллельный план запроса, SQL Server автоматически разобьет данные, назначенные узлам, и выполнит необходимые объединения и агрегации в параллельном режиме.

Если вы заинтересованы в получении дополнительной информации о том, как определять хранимую процедуру для использования в оценке, посмотрите пример проекта на [GitHub](https://github.com/Microsoft/SQL-Server-R-Services-Samples/tree/master/SQLOptimizationTips-Resume-Matching/SQLR) и изучите файл "step5_score_for_matching.sql". Пример сценария также отслеживает время начала и окончания запроса и записывает время в консоль SQL, чтобы можно было оценить производительность.

### <a name="concurrent-scoring-using-resource-groups"></a>Параллельная оценка с использованием групп ресурсов

Чтобы увеличить масштаб задачи оценки, рекомендуется применять подход с масштабированием, в котором миллионы элементов делятся на несколько пакетов. Затем несколько заданий оценки выполняются одновременно. При таком подходе пакеты обрабатываются на разных наборах ЦП, а результаты собираются и записываются обратно в базу данных.

Этот подход используется в сценарии отбора подходящих резюме. Тем не менее управление ресурсами в SQL Server имеет большое значение для его реализации. Настроив группы рабочей нагрузки для внешних заданий скриптов, можно направить задания оценки R в разные группы процессоров и повысить пропускную способность.

Управление ресурсами может также помочь в распределении доступных ресурсов на сервере (ЦП и память) для снижения конкуренции рабочих нагрузок. Можно настроить функции-классификаторы для различения различных типов заданий R. Например, можно определить, что оценка, вызываемая из приложения, всегда имеет больший приоритет, а задания переобучения имеют низкий приоритет. Такая изоляция ресурсов потенциально может уменьшить время выполнения и обеспечить более предсказуемую производительность.

### <a name="concurrent-scoring-using-powershell"></a>Параллельная оценка с помощью PowerShell

Если вы решили самостоятельно секционировать данные, можно использовать сценарии PowerShell для выполнения нескольких параллельных задач оценки. Для этого используйте командлет Invoke-SqlCmd и запустите задачи оценки параллельно.

В сценарии отбора подходящих резюме параллельная обработка была реализована следующим образом:

- 20 процессоров делятся на четыре группы из пяти процессоров. Каждая группа ЦП размещается на одном узле NUMA.

- Максимальное число одновременных пакетов равно восьми.

- Каждая группа рабочей нагрузки должна выполнять две задачи оценки. Как только одна задача завершила чтение данных и начинает оценку, другая задача может начать чтение данных из базы данных.

Чтобы просмотреть сценарии PowerShell для этой задачи, откройте файл "experiment.ps1" в [проекте GitHub](https://github.com/Microsoft/SQL-Server-R-Services-Samples/tree/master/SQLOptimizationTips-Resume-Matching).

### <a name="storing-models-for-prediction"></a>Хранение моделей для прогнозирования

После завершения обучения и оценки и выбора оптимальной модели мы рекомендуем сохранить модель в базе данных, чтобы ее можно было использовать для прогнозов. Загрузка предварительно вычисленной модели из базы данных для прогноза является эффективной, поскольку машинное обучение SQL Server использует специальные алгоритмы сериализации для хранения и загрузки моделей при перемещении между R и базой данных.

> [!TIP]
> В SQL Server 2017 можно использовать функцию PREDICT для оценки, даже если R не установлен на сервере. Поддерживаются ограниченные типы моделей из пакета RevoScaleR.

Однако, в зависимости от используемого алгоритма, некоторые модели могут быть довольно большими, особенно при обучении большого набора данных. Например, такие алгоритмы, как **lm** и **glm**, создают множество сводных данных вместе с правилами. Поскольку существуют ограничения на размер модели, которая может храниться в столбце varbinary, рекомендуется удалить ненужные артефакты из модели перед сохранением модели в базе данных для рабочей среды.

## <a name="articles-in-this-series"></a>Статьи в этой серии

[Настройка производительности для R — введение](../r/sql-server-r-services-performance-tuning.md)

[Настройка производительности для R — конфигурация SQL Server](../r/sql-server-configuration-r-services.md)

[Настройка производительности для R — код R и оптимизация данных](../r/r-and-data-optimization-r-services.md)

[Настройка производительности — результаты примеров использования](../r/performance-case-study-r-services.md)
