---
title: Установка в Windows
description: Здесь вы узнаете, как установить Службы машинного обучения SQL Server в Windows. Службы машинного обучения можно использовать для запуска сценариев R или Python в базе данных.
ms.prod: sql
ms.technology: machine-learning-services
ms.date: 02/29/2020
ms.topic: how-to
author: dphansen
ms.author: davidph
ms.custom: seo-lt-2019
monikerRange: '>=sql-server-2017'
ms.openlocfilehash: 592a365024edbbe4ee2743a156ee480b76849ba9
ms.sourcegitcommit: a9e982e30e458866fcd64374e3458516182d604c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/11/2021
ms.locfileid: "98096860"
---
# <a name="install-sql-server-machine-learning-services-python-and-r-on-windows"></a>Установка служб машинного обучения SQL Server (Python и R) в Windows

[!INCLUDE [SQL Server 2017 and later](../../includes/applies-to-version/sqlserver2017.md)]

Здесь вы узнаете, как установить Службы машинного обучения SQL Server в Windows. Службы машинного обучения можно использовать для запуска сценариев R или Python в базе данных.

## <a name="pre-install-checklist"></a><a name="bkmk_prereqs"> </a>Контрольный список перед установкой

+ Необходим экземпляр ядра СУБД. Вы не можете установить только функции Python или R, хотя их можно добавить в существующий экземпляр постепенно.

+ Для обеспечения непрерывности бизнес-процессов [группы доступности Always On](../../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md) поддерживаются для служб машинного обучения. Установите Службы машинного обучения и настройте пакеты на каждом узле.

+ Установка служб машинного обучения *не поддерживается* в [отказоустойчивом кластере (FCI) Always On](../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md) в SQL Server 2017. Она поддерживается в SQL Server 2019 и более поздних версий.
 
+ Не устанавливайте Службы машинного обучения на контроллере домена. Этап установки служб машинного обучения завершится с ошибкой.

+ Не устанавливайте **общие компоненты** > **Сервера машинного обучения (изолированного)** на том же компьютере, на котором выполняется экземпляр в базе данных. Изолированный сервер будет конкурировать за те же ресурсы, снижая производительность обеих установок.

+ Параллельная установка с другими версиями Python и R поддерживается, но не рекомендуется. Она поддерживается, поскольку экземпляр SQL Server использует собственные копии дистрибутивов R и Anaconda с открытым исходным кодом. Параллельная установка не рекомендуется, так как выполнение кода, использующего Python и R на компьютере SQL Server за пределами SQL Server, может привести к различным проблемам:
    
  + Использование другой библиотеки и исполняемых файлов приведет к несогласованным результатам, которые отличаются от ожидаемых в SQL Server.
  + Сценариями R и Python, выполняемыми во внешних библиотеках, нельзя управлять с помощью SQL Server, так как это приведет к конфликту ресурсов.

::: moniker range=">=sql-server-ver15"
> [!NOTE]
> Службы машинного обучения устанавливаются по умолчанию в **кластерах больших данных SQL Server**. Если вы используете **кластеры больших данных**, нет необходимости выполнять действия, описанные в этой статье. Дополнительные сведения см. в разделе [Использование служб машинного обучения (Python и R) в кластерах больших данных](../../big-data-cluster/machine-learning-services.md).
::: moniker-end

> [!IMPORTANT]
> После завершения установки обязательно выполните действия после конфигурации, описанные в этой статье. В их число входят включение SQL Server для использования внешних сценариев и добавление учетных записей, необходимых для того, чтобы SQL Server выполнял задания R и Python от вашего имени. Изменения в конфигурации обычно требуют перезапуска экземпляра или службы панели элементов.

## <a name="get-the-installation-media"></a>Получение установочного носителя

[!INCLUDE[GetInstallationMedia](../../includes/getssmedia.md)]

::: moniker range="=sql-server-2017"
Дополнительные сведения о том, какие выпуски SQL Server поддерживают интеграцию Python и R со Службами машинного обучения, см. в статье [Выпуски и поддерживаемые функции SQL Server 2017](../../sql-server/editions-and-components-of-sql-server-2017.md).
::: moniker-end

::: moniker range="=sql-server-ver15"
Дополнительные сведения о том, какие выпуски SQL Server поддерживают интеграцию Python и R со Службами машинного обучения, см. в статье [о выпусках и поддерживаемых функциях SQL Server 2019 (15.x)](../../sql-server/editions-and-components-of-sql-server-version-15.md).
::: moniker-end

## <a name="run-setup"></a>Запуск программы установки

Для локальных установок необходимо запускать программу установки с правами администратора. При установке [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] из удаленной общей папки необходимо использовать учетную запись домена с разрешениями на чтение и выполнение для удаленной общей папки.

1. Запустите мастер установки SQL Server.
  
1. На вкладке **Установка** выберите параметр **Новая установка изолированного экземпляра SQL Server или добавление компонентов к существующей установке**.

   ::: moniker range="=sql-server-2017"
   ![Новые изолированные установки SQL Server](media/2017setup-installation-page-mlsvcs.png)
   ::: moniker-end

   ::: moniker range="=sql-server-ver15"
   ![Новые изолированные установки SQL Server](media/2019setup-installation-page-mlsvcs.png)
   ::: moniker-end

1. На странице **Выбор компонентов** выберите следующие компоненты:

   ::: moniker range="=sql-server-2017"

   - **Службы ядра СУБД**
     
     Чтобы использовать R и Python с SQL Server, необходимо установить экземпляр ядра СУБД. Можно использовать экземпляр по умолчанию или именованный экземпляр.

   - **Службы машинного обучения (в базе данных)**
     
     Этот параметр устанавливает службы баз данных, поддерживающие выполнение сценариев R и Python.

   ::: moniker-end

   ::: moniker range="=sql-server-ver15"

   - **Службы ядра СУБД**
     
     Чтобы использовать R или Python с SQL Server, необходимо установить экземпляр ядра СУБД. Можно использовать экземпляр по умолчанию или именованный экземпляр.

   - **Службы машинного обучения (в базе данных)**
     
     Этот параметр устанавливает службы баз данных, поддерживающие выполнение сценариев R и Python.

   ::: moniker-end

   - **R**
     
     Установите этот флажок, чтобы добавить пакеты Microsoft R, интерпретатор и R с открытым кодом. 
     
   - **Python**
     
     Установите этот флажок, чтобы добавить пакеты Microsoft Python, исполняемый файл Python 3.5 и выбрать библиотеки из дистрибутива Anaconda.
     
   ::: moniker range="=sql-server-ver15"
   Сведения об установке и использовании Java см. в статье [Установка расширений языка для SQL Server в Windows](../../language-extensions/install/windows-java.md).
   ::: moniker-end
   
   ::: moniker range="=sql-server-2017"
   ![Параметры функции для R и Python](media/2017setup-features-page-mls-rpy.PNG "Параметры установки для R и Python")
   ::: moniker-end
   
   ::: moniker range="=sql-server-ver15"
   ![Параметры функции для R и Python](media/2019setup-features-page-mls-rpy.png "Параметры установки для R и Python")
   ::: moniker-end
   
   > [!NOTE]
   > 
   > Не выбирайте параметр для **Сервера машинного обучения (изолированный)** . Возможность установки сервера машинного обучения в разделе **Общие компоненты**  предназначена для использования на отдельном компьютере.

::: moniker range="=sql-server-2017"

4. На странице **Согласие на установку Microsoft R Open** выберите **Принять**, а затем **Следующий**. 

Лицензионное соглашение охватывает следующее:
+ Microsoft R Open
+ Базовые пакеты и средства R с открытым исходным кодом.
+ Улучшенные пакеты R и поставщики услуг подключения от команды разработчиков Майкрософт.

1. На странице **Согласие на установку Python** выберите **Принять**, а затем **Следующий**. Соглашение о лицензировании с открытым исходным кодом Python включает Anaconda и связанные средства, а также некоторые новые библиотеки Python от команды разработчиков Майкрософт.

   > [!NOTE]
   >  Если используемый компьютер не подключен к Интернету, вы можете поставить на паузу настройку и скачать установщики отдельно. Дополнительные сведения см. в разделе [Установка компонентов машинного обучения без доступа к Интернету](../install/sql-ml-component-install-without-internet-access.md).

1. На странице **Все готово для установки** проверьте, включены ли указанные ниже компоненты, и нажмите **Установить**.
  
   + Службы ядра СУБД
   + Служба машинного обучения (в базе данных)
   + R, Python или оба

   Обратите внимание на расположение папки в каталоге `..\Setup Bootstrap\Log`, где хранятся файлы конфигурации. После завершения установки можно просмотреть установленные компоненты в файле сводки.

1. Если после завершения установки будет предложено перезагрузить компьютер, выполните перезагрузку. После завершения установки важно прочитать сообщение мастера установки. Дополнительные сведения см. в разделе [View and Read SQL Server Setup Log Files](../../database-engine/install-windows/view-and-read-sql-server-setup-log-files.md).

::: moniker-end

::: moniker range="=sql-server-ver15"

1. На странице **Согласие на установку Microsoft R Open** выберите **Принять**, а затем **Следующий**. Принятие лицензионного соглашения включает Microsoft R Open — дистрибутива, содержащего базовые пакеты и средства R с открытым исходным кодом, а также поставщики услуг подключения и расширенные пакеты R от команды разработки Microsoft.

2. На странице **Согласие на установку Python** выберите **Принять**, а затем **Следующий**. Соглашение о лицензировании с открытым исходным кодом Python включает Anaconda и связанные средства, а также некоторые новые библиотеки Python от команды разработчиков Майкрософт.

3. На странице **Все готово для установки** проверьте, включены ли указанные ниже компоненты, и нажмите **Установить**.
  
   + Службы ядра СУБД
   + Служба машинного обучения (в базе данных)
   + R и (или) Python

   Обратите внимание на расположение папки в каталоге `..\Setup Bootstrap\Log`, где хранятся файлы конфигурации. После завершения установки можно просмотреть установленные компоненты в файле сводки.

4. Если после завершения установки будет предложено перезагрузить компьютер, выполните перезагрузку. После завершения установки важно прочитать сообщение мастера установки. Дополнительные сведения см. в разделе [View and Read SQL Server Setup Log Files](../../database-engine/install-windows/view-and-read-sql-server-setup-log-files.md).

::: moniker-end

## <a name="set-environment-variables"></a>Настройка переменных среды

Только для интеграции с R присвойте переменной среды **MKL_CBWR** значение [ensure consistent output](https://software.intel.com/articles/introduction-to-the-conditional-numerical-reproducibility-cnr) из вычислений Intel Math Kernel Library (MKL).

1. На панели управления щелкните **Система и безопасность** > **Система** > **Расширенные параметры системы** > **Переменные среды**.

2. Создайте новую пользовательскую или системную переменную. 

   + Задайте имя переменной как `MKL_CBWR`.
   + Задайте значение переменной как `AUTO`.

Для этого шага требуется перезагрузка сервера. Если вы собираетесь включить выполнение сценариев, можно удерживать его при перезапуске до тех пор, пока не будет выполнена вся настройка.

<a name="bkmk_enableFeature"></a>

## <a name="enable-script-execution"></a>Включение выполнения сценария

1. Откройте среду [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]. 

    > [!TIP]
    > Скачать и установить соответствующую версию можно с этой страницы: [Скачайте SQL Server Management Studio (SSMS)](../../ssms/download-sql-server-management-studio-ssms.md).
    > 
    > Можно также использовать среду [Azure Data Studio](../../azure-data-studio/what-is-azure-data-studio.md), которая поддерживает административные задачи и запросы к SQL Server.
  
2. Подключитесь к экземпляру, в который вы установили службы машинного обучения, нажмите **Создать запрос**, чтобы открыть окно запроса, и выполните следующую команду:

    ```sql
    sp_configure
    ```

    На данном этапе значение для свойства `external scripts enabled` должно быть **0**. Функция отключена по умолчанию. Этот компонент должен быть явно включен администратором, чтобы вы могли выполнять код R или Python.
    
3.  Чтобы включить внешний компонент написания сценариев, выполните следующую инструкцию:
    
    ```sql
    EXEC sp_configure  'external scripts enabled', 1
    RECONFIGURE WITH OVERRIDE
    ```
    
    Если вы уже включили этот компонент для языков R, не выполняйте повторную настройку для Python. Базовая платформа расширяемости поддерживает оба языка.

## <a name="restart-the-service"></a>Перезапустите службу.

После завершения установки перезапустите ядро СУБД.

При перезапуске службы автоматически перезапускается соответствующая служба [!INCLUDE[rsql_launchpad](../../includes/rsql-launchpad-md.md)].

Службу можно перезапустить, щелкнув ее правой кнопкой мыши и выбрав команду **Перезапустить** для экземпляра SSMS, через раздел **Службы** на панели управления или с помощью [диспетчера конфигурации SQL Server](../../relational-databases/sql-server-configuration-manager.md).

## <a name="verify-installation"></a>Проверка установки

Выполните указанные ниже действия, чтобы убедиться в том, что все компоненты, используемые для запуска внешнего скрипта, запущены.

1. Откройте новое окно запроса в SQL Server Management Studio и выполните приведенную ниже команду.
    
   ```sql
   EXECUTE sp_configure  'external scripts enabled'
   ```

   **run_value** имеет значение 1.
    
2. Откройте раздел **Службы** или диспетчер конфигурации SQL Server и убедитесь, что служба **Панель запуска SQL Server** запущена. У вас должно быть по одной службе для каждого экземпляра ядра СУБД с установленными R или Python. Дополнительные сведения об этой службе см. в разделе [Платформа расширяемости](../concepts/extensibility-framework.md). 
   
3. Если запущена панель запуска, вы можете выполнять простые сценарии Python и R, чтобы убедиться, что внешние среды выполнения скриптов могут взаимодействовать с SQL Server.

   Откройте новое окно **запросов** в [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], а затем выполните следующий сценарий:
   + Для R
   
     ```sql
     EXEC sp_execute_external_script  @language =N'R',
     @script=N'
     OutputDataSet <- InputDataSet;
     ',
     @input_data_1 =N'SELECT 1 AS hello'
     WITH RESULT SETS (([hello] int not null));
     GO
     ```
     
   + Для Python
     
     ```sql
     EXEC sp_execute_external_script  @language =N'Python',
     @script=N'
     OutputDataSet = InputDataSet;
     ',
     @input_data_1 =N'SELECT 1 AS hello'
     WITH RESULT SETS (([hello] int not null));
     GO
     ```
   
   **Результаты**

   Выполнение сценария может занять некоторое время при первой загрузке внешней среды выполнения. Результаты должны выглядеть примерно так:

   | hello |
   |----|
   | 1|

> [!NOTE]
> Столбцы или заголовки, используемые в сценарии Python, не возвращаются автоматически. Чтобы добавить имена столбцов для вывода, необходимо указать схему для набора возвращаемых данных. Для этого используйте параметр WITH RESULTS хранимой процедуры, указывая имена столбцов и типы данных SQL.
>
> Например, можно добавить следующую строку для создания произвольного имени столбца: `WITH RESULT SETS ((Col1 AS int))`

::: moniker range="=sql-server-2017"
<!-- There are no updates yet available for 2019, and there's no 2019 update list site. When updates become available, add 2019 information to this section. -->

<a name="apply-cu"></a>

## <a name="apply-updates"></a>Применение обновлений

Мы рекомендуем применить последнее накопительное обновление к компонентам ядра СУБД и машинного обучения.

На устройствах, подключенных к Интернету, накопительные обновления обычно применяются с помощью Центра обновления Windows, но вы также можете использовать приведенные ниже шаги для управления контролируемыми обновлениями. При применении обновления для ядра СУБД программа установки извлекает накопительные обновления для всех компонентов Python или R, установленных в том же экземпляре. 

На отключенных серверах требуются дополнительные действия. Дополнительные сведения см. в разделе [Установка на компьютерах без доступа к Интернету > Применение накопительных обновлений](sql-ml-component-install-without-internet-access.md#apply-cu).

1. Начните с уже установленного базового экземпляра: Начальный выпуск SQL Server 2017

2. Перейдите к списку накопительных обновлений: [Последние обновления для Microsoft SQL Server](../../database-engine/install-windows/latest-updates-for-microsoft-sql-server.md)

3. Загрузите последнее накопительное обновление. Исполняемый файл скачивается и извлекается автоматически.

4. Запустите программу установки. Примите условия лицензионного соглашения и на странице "Выбор компонентов" проверьте компоненты, для которых применяются накопительные пакеты обновления. Вы должны увидеть все компоненты, установленные для текущего экземпляра, включая функции машинного обучения. Программа установки загрузит CAB-файлы, необходимые для обновления всех компонентов.

   ![Сводка установленных компонентов](media/cumulative-update-feature-selection.png)

5. Продолжайте работу с мастером, принимая условия лицензионного соглашения для дистрибутивов R и Python. 

::: moniker-end

## <a name="additional-configuration"></a>Дополнительная настройка

Если проверка внешнего сценария будет пройдена успешно, вы сможете выполнять команды R и Python из SQL Server Management Studio, Visual Studio Code или любого другого клиента, который может отправлять инструкции T-SQL на сервер.

Если при выполнении команды возникнет ошибка, обратитесь к дополнительным шагам настройки, указанным в этом разделе. Возможно, потребуется внести какие-то дополнительные настройки в службу или базу данных.

На уровне экземпляра дополнительная конфигурация может включать следующее:

* [Настройка брандмауэра для служб машинного обучения SQL Server](../../machine-learning/security/firewall-configuration.md)
* [Включение дополнительных сетевых протоколов](../../database-engine/configure-windows/enable-or-disable-a-server-network-protocol.md)
* [Включение удаленных подключений](../../database-engine/configure-windows/configure-the-remote-access-server-configuration-option.md)
* [Создание учетных данных для SQLRUserGroup](../../machine-learning/security/create-a-login-for-sqlrusergroup.md)
* [Управление квотами на диск](/windows/desktop/fileio/managing-disk-quotas) во избежание выполнения внешними сценариями задач, тратящих дисковое пространство

::: moniker range=">=sql-server-ver15"
В SQL Server 2019 в Windows механизм изоляции изменился. Этот механизм влияет на **SQLRUserGroup**, правила брандмауэра, разрешение файла и подразумеваемую проверку подлинности. Дополнительные сведения см. в разделе [Изменения в изоляции служб машинного обучения](sql-server-machine-learning-services-2019.md).
::: moniker-end

<a name="bkmk_configureAccounts"></a> 
<a name="permissions-external-script"></a> 

В базе данных могут потребоваться следующие обновления конфигурации:

* [Предоставление пользователям доступа к службам машинного обучения SQL Server](../../machine-learning/security/user-permission.md)

> [!NOTE]
> Необходимость дополнительной настройки зависит от схемы безопасности, в которой установлен ваш SQL Server, и от того, как ваши пользователи должны подключаться к базе данных и запускать внешние скрипты.

## <a name="suggested-optimizations"></a>Предлагаемые оптимизации

Теперь, когда все работает, также может потребоваться оптимизировать сервер для поддержки машинного обучения или установки предварительно подготовленных моделей машинного обучения.

::: moniker range="=sql-server-2017"
### <a name="add-more-worker-accounts"></a>Добавление рабочих учетных записей

Если вы предполагаете, что множество пользователей будут одновременно выполнять сценарии, вы можете увеличить количество рабочих учетных записей, назначенных службе панели запуска. Дополнительные сведения см. в разделе [Масштабирование параллельного выполнения внешних сценариев в SQL Server службы машинного обучения](../administration/scale-concurrent-execution-external-scripts.md).
::: moniker-end

### <a name="optimize-the-server-for-script-execution"></a>Оптимизация сервера для выполнения сценария

Параметры по умолчанию для программы установки [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] призваны оптимизировать выполнение на сервере различных служб, поддерживаемых ядром СУБД, включая процессы извлечения, преобразования и загрузки, ведение отчетности, аудит и приложения, использующие данные [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. При использовании параметров по умолчанию ресурсы для машинного обучения могут быть ограничены или регулироваться, особенно в случае с операциями с интенсивным использованием памяти.

Чтобы задачам машинного обучения назначались соответствующие приоритеты и выделялись необходимые ресурсы, рекомендуем использовать Resource Governor SQL Server для настройки внешнего пула ресурсов. Кроме того, можно изменить размер памяти, выделяемой ядру СУБД [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], или увеличить количество учетных записей в службе [!INCLUDE[rsql_launchpad](../../includes/rsql-launchpad-md.md)].

- Сведения о настройке пула ресурсов для управления внешними ресурсами см. в разделе [Создание внешнего пула ресурсов](../../t-sql/statements/create-external-resource-pool-transact-sql.md).
  
- Сведения об изменении объема памяти, выделяемой для базы данных, см. в разделе [Параметры конфигурации памяти сервера](../../database-engine/configure-windows/server-memory-server-configuration-options.md).
  
- Чтобы изменить число учетных записей R, которые могут быть запущены [!INCLUDE[rsql_launchpad](../../includes/rsql-launchpad-md.md)], см. раздел [масштабирование параллельного выполнения внешних сценариев в SQL Server службы машинного обучения](../administration/scale-concurrent-execution-external-scripts.md).

Если у вас установлен выпуск Standard Edition, но отсутствует Resource Governor, вы можете использовать для управления ресурсами сервера динамические административные представления и расширенные события, а также мониторинг событий Windows.

### <a name="install-additional-python-and-r-packages"></a>Установка дополнительных пакетов Python и R

Решения Python и R, создаваемые для SQL Server, могут вызывать базовые функции, функции из собственных пакетов, установленных с SQL Server, а также сторонних пакетов, совместимых с версией Python с открытым исходным кодом и R, установленными SQL Server.

Пакеты, которыми вы хотите пользоваться из SQL Server, должны быть установлены в библиотеке по умолчанию, используемой экземпляром. При наличии отдельной установки Python или R на компьютере, а также если вы установили пакеты в библиотеки пользователей, вы не можете использовать их из T-SQL.

Для установки и управления дополнительными пакетами можно настроить группы пользователей для совместного использования пакетов на уровне базы данных или настроить роли базы данных, чтобы разрешить пользователям устанавливать собственные пакеты. Дополнительные сведения см. в статьях [Установка пакетов Python](../package-management/install-additional-python-packages-on-sql-server.md) и [Установка новых пакетов R](../package-management/install-additional-r-packages-on-sql-server.md).

## <a name="next-steps"></a>Дальнейшие действия

Разработчики на языке Python могут узнать, как использовать Python с SQL Server, изучив следующие руководства.

+ [Учебник по Python. Прогнозирование проката лыж с помощью линейной регрессии в Службах машинного обучения SQL Server](../tutorials/python-ski-rental-linear-regression-deploy-model.md)
+ [Учебник по Python. Классификация клиентов на основе кластеризации методом k-средних с помощью служб машинного обучения SQL Server](../tutorials/python-clustering-model.md)

Разработчики на языке R могут ознакомиться с простыми примерами, а также узнать, как код R работает с SQL Server. Дополнительные сведения см. в следующих статьях.

+ [Краткое руководство. Запуск R в T-SQL](../tutorials/quickstart-r-create-script.md)
+ [Руководство. Аналитические функции в базе данных для разработчиков R](../tutorials/r-taxi-classification-introduction.md)