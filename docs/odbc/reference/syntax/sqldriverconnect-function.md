---
title: Функция SQLDriverConnect | Документация Майкрософт
description: Функция SQLDriverConnect является частью стандарта ODBC API, и эта справочная документация предоставляет сведения о его синтаксисе.
ms.custom: ''
ms.date: 08/20/2020
ms.prod: sql
ms.prod_service: connectivity
ms.reviewer: ''
ms.technology: connectivity
ms.topic: reference
apiname:
- SQLDriverConnect
apilocation:
- sqlsrv32.dll
apitype: dllExport
f1_keywords:
- SQLDriverConnect
helpviewer_keywords:
- SQLDriverConnect function [ODBC]
ms.assetid: e299be1d-5c74-4ede-b6a3-430eb189134f
author: David-Engel
ms.author: v-daenge
ms.openlocfilehash: 58c9f2071825c6c7d8f873f300e8e5c3f46af9b6
ms.sourcegitcommit: 33f0f190f962059826e002be165a2bef4f9e350c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/30/2021
ms.locfileid: "99195642"
---
# <a name="sqldriverconnect-function"></a>Функция SQLDriverConnect
**Соответствия**  
 Представленная версия: соответствие стандартам ODBC 1,0: ODBC  
  
 **Сводка**  
 **SQLDriverConnect** является альтернативой **SQLConnect**. Он поддерживает источники данных, для которых требуются дополнительные сведения о соединении, чем три аргумента в **SQLConnect**, диалоговые окна, позволяющие пользователю запрашивать все сведения о соединении, а также источники данных, не определенные в сведениях о системе. Дополнительные сведения см. [в разделе Подключение с помощью SQLDriverConnect](../develop-app/connecting-with-sqldriverconnect.md).  

## <a name="syntax"></a>Синтаксис  
  
```cpp  
  
SQLRETURN SQLDriverConnect(  
     SQLHDBC         ConnectionHandle,  
     SQLHWND         WindowHandle,  
     SQLCHAR *       InConnectionString,  
     SQLSMALLINT     StringLength1,  
     SQLCHAR *       OutConnectionString,  
     SQLSMALLINT     BufferLength,  
     SQLSMALLINT *   StringLength2Ptr,  
     SQLUSMALLINT    DriverCompletion);  
```  
  
## <a name="arguments"></a>Аргументы  
 *коннектионхандле*  
 [Input] Дескриптор подключения  
  
 *WindowHandle*  
 Входной Маркер окна. Приложение может передать маркер родительского окна, если это применимо, или указатель null, если либо маркер окна не применим, либо **SQLDriverConnect** не будет представлять никаких диалоговых окон.  
  
 *Строка подключения*  
 Входной Полная строка подключения (см. синтаксис в комментариях), частичная строка подключения или пустая строка.  
  
 *StringLength1*  
 Входной Длина * в символах, если строка является Юникодом, или *байтов, если* строка имеет кодировку ANSI или DBCS.  
  
 *Строка подключения*  
 Проверки Указатель на буфер для завершенной строки подключения. После успешного подключения к целевому источнику данных этот буфер содержит завершенную строку подключения. Для этого буфера приложения должны выделить не менее 1 024 символов.  
  
 Если параметру *ConnectionString* присвоено значение null, *StringLength2Ptr* будет возвращать общее количество символов (исключая символ завершения null для символьных данных), доступных для возврата в буфер, на который указывает параметр *ConnectionString*.  
  
 *BufferLength*  
 Входной Длина буфера *подключения * в* символах.  
  
 *StringLength2Ptr*  
 Проверки Указатель на буфер, в котором возвращается общее число символов (за исключением символа завершения null), доступного для возврата в \* *ConnectionString*. Если число возвращаемых символов больше или равно значению *BufferLength*, то завершенная строка подключения в параметре \* *ConnectionString* усекается до *BufferLength* с длиной завершающего символа null.  
  
 *DriverCompletion*  
 Входной Флаг, указывающий, должен ли диспетчер драйверов или драйвер запрашивать дополнительные сведения о подключении:  
  
 SQL_DRIVER_PROMPT, SQL_DRIVER_COMPLETE, SQL_DRIVER_COMPLETE_REQUIRED или SQL_DRIVER_NOPROMPT.  
  
 (Дополнительные сведения см. в разделе "Комментарии".)  
  
## <a name="returns"></a>Возвращаемое значение  
 SQL_SUCCESS, SQL_SUCCESS_WITH_INFO, SQL_NO_DATA, SQL_ERROR, SQL_INVALID_HANDLE или SQL_STILL_EXECUTING.  
  
## <a name="diagnostics"></a>Диагностика  
 Если **SQLDriverConnect** возвращает либо SQL_ERROR, либо SQL_SUCCESS_WITH_INFO, связанное значение SQLSTATE может быть получено путем вызова **SQLGetDiagRec** с *фхандлетипе* SQL_HANDLE_DBC и *ххандле* *коннектионхандле*. В следующей таблице перечислены значения SQLSTATE, обычно возвращаемые функцией **SQLDriverConnect** , и объясняется каждый из них в контексте этой функции. Нотация "(DM)" предшествует описаниям SQLSTATE, возвращаемым диспетчером драйверов. Код возврата, связанный с каждым значением SQLSTATE, имеет SQL_ERROR, если не указано иное.  
  
|SQLSTATE|Ошибка|Описание|  
|--------------|-----------|-----------------|  
|01000|Общее предупреждение|Информационное сообщение для конкретного драйвера. (Функция возвращает SQL_SUCCESS_WITH_INFO.)|  
|01004|Строковые данные, усеченные справа|Буферная \* *строка* не достаточно велика, чтобы вернуть всю строку подключения, поэтому строка подключения была усечена. Длина неусеченной строки соединения возвращается в **StringLength2Ptr*. (Функция возвращает SQL_SUCCESS_WITH_INFO.)|  
|01S00|Недопустимый атрибут строки подключения|В строке подключения (*onconnectionstring*) указано недопустимое ключевое слово Attribute, но драйверу удалось подключиться к источнику данных. (Функция возвращает SQL_SUCCESS_WITH_INFO.)|  
|01S02|Значение параметра изменено|Драйвер не поддерживал указанное значение, указываемое аргументом *ValuePtr* в **SQLSetConnectAttr** , и заменяет аналогичное значение. (Функция возвращает SQL_SUCCESS_WITH_INFO.)|  
|01S08|Ошибка при сохранении файлового DSN|Строка в *\* onconnectionstring* содержит ключевое слово **FILEDSN** , но DSN-файл не был сохранен. (Функция возвращает SQL_SUCCESS_WITH_INFO.)|  
|01S09|Недопустимое ключевое слово|(DM) строка в *\* onconnectionstring* содержит ключевое слово **SaveFile** , но не **драйвер** или ключевое слово **FILEDSN** . (Функция возвращает SQL_SUCCESS_WITH_INFO.)|  
|08001|Клиенту не удалось установить подключение|Драйверу не удалось установить соединение с источником данных.|  
|08002|Имя подключения используется|(DM) указанный *коннектионхандле* уже использовался для установления соединения с источником данных, и соединение по-прежнему было открыто.|  
|08004|Сервер отклонил подключение|Источник данных отклонил установку соединения для определенных реализацией причин.|  
|08S01|Сбой канала связи|Не удалось установить связь между драйвером и источником данных, к которому драйвер пытался подключиться, до завершения обработки функции **SQLDriverConnect** .|  
|28000|Недопустимая спецификация авторизации|Либо идентификатор пользователя, либо строка авторизации, либо оба значения, как указано в строке подключения (*onconnectionstring*), нарушают ограничения, определенные источником данных.|  
|HY000|Общая ошибка|Произошла ошибка, для которой нет определенного SQLSTATE и для которого не определен SQLSTATE для конкретной реализации. Сообщение об ошибке, возвращаемое функцией **SQLGetDiagRec** в буфере *\* сзмессажетекст* , описывает ошибку и ее причину.|  
|HY000|Общая ошибка: недопустимое имя DSN файла|(DM) строка в * in *ConnectionString* содержит ключевое слово FILEDSN, но имя DSN-файла не найдено.|  
|HY000|Общая ошибка: не удается создать файловый буфер|(DM) строка в * in *ConnectionString* содержит ключевое слово FILEDSN, но файл DSN был нечитаемым.|  
|HY001|Ошибка выделения памяти|Диспетчеру драйверов не удалось выделить память, необходимую для поддержки выполнения или завершения функции **SQLDriverConnect** .<br /><br /> Драйверу не удалось выделить память, необходимую для поддержки выполнения или завершения функции.|  
|HY008|Operation canceled|Асинхронная обработка включена для *коннектионхандле*. Была вызвана функция, и до ее завершения была вызвана [функция склканцелхандле](../../../odbc/reference/syntax/sqlcancelhandle-function.md) в *коннектионхандле*, а затем в *Коннектионхандле* был вызвана функция **SQLDriverConnect** .<br /><br /> Или была вызвана функция **SQLDriverConnect** , и до ее завершения была вызвана **склканцелхандле** в *коннектионхандле* из другого потока многопоточного приложения.|  
|HY010|Ошибка последовательности функций|(DM) для *коннектионхандле* был вызван другой асинхронно исполняемая функция (не **SQLDriverConnect**) и все еще выполнялась при вызове функции **SQLDriverConnect** .|  
|HY013|Ошибка управления памятью|Не удалось обработать вызов функции **SQLDriverConnect** , так как не удалось получить доступ к базовым объектам памяти, возможно, из-за нехватки памяти.|  
|HY090|Недопустимая длина строки или буфера|(DM) значение, указанное для аргумента *StringLength1* , было меньше 0 и не равно SQL_NTS.<br /><br /> (DM) значение, указанное для аргумента *BufferLength* , было меньше 0.|  
|HY092|Недопустимый идентификатор атрибута или параметра|(DM) аргумент *DriverCompletion* был SQL_DRIVER_PROMPT, а аргумент *WindowHandle* был пустым указателем.|  
|HY110|Недопустимое завершение драйвера|(DM) значение, указанное для аргумента *DriverCompletion* , не равно SQL_DRIVER_PROMPT, SQL_DRIVER_COMPLETE, SQL_DRIVER_COMPLETE_REQUIRED или SQL_DRIVER_NOPROMPT.<br /><br /> Включено использование пулов соединений (DM), и значение, указанное для аргумента *DriverCompletion* , не равно SQL_DRIVER_NOPROMPT.|  
|HYC00|Необязательная функция не реализована|Драйвер не поддерживает версию поведения ODBC, запрашиваемую приложением.|  
|HYT00|Время ожидания истекло|Время ожидания входа истекло до завершения соединения с источником данных. Период ожидания задается через **SQLSetConnectAttr**, SQL_ATTR_LOGIN_TIMEOUT.|  
|HYT01|Время ожидания подключения истекло|Время ожидания соединения истекло до ответа источника данных на запрос. Время ожидания соединения задается через **SQLSetConnectAttr**, SQL_ATTR_CONNECTION_TIMEOUT.|  
|IM001|Драйвер не поддерживает эту функцию|(DM) драйвер, соответствующий указанному имени источника данных, не поддерживает функцию.|  
|IM002|Источник данных не найден, драйвер по умолчанию не указан|(DM) имя источника данных, указанное в строке подключения (*onconnectionstring*), не найдено в системной информации, и спецификация драйвера по умолчанию отсутствует.<br /><br /> (DM) источник данных ODBC и сведения о драйвере по умолчанию не найдены в сведениях о системе.|  
|IM003|Не удалось загрузить указанный драйвер|(DM) драйвер, указанный в спецификации источника данных в сведениях о системе или указанный в ключевом слове **Driver** , не найден или не может быть загружен по какой-либо другой причине.|  
|IM004|Сбой **функцию SQLAllocHandle** драйвера на SQL_HANDLE_ENV|(DM) во время **SQLDriverConnect** диспетчер драйверов вызвал функцию **функцию SQLAllocHandle** драйвера с *фхандлетипе* SQL_HANDLE_ENV и драйвер вернул ошибку.|  
|IM005|Сбой **функцию SQLAllocHandle** драйвера на SQL_HANDLE_DBC.|(DM) во время **SQLDriverConnect** диспетчер драйверов вызвал функцию **функцию SQLAllocHandle** драйвера с *фхандлетипе* SQL_HANDLE_DBC и драйвер вернул ошибку.|  
|IM006|Сбой **SQLSetConnectAttr** драйвера|(DM) во время **SQLDriverConnect** диспетчер драйверов вызвал функцию **SQLSetConnectAttr** драйвера, а драйвер вернул ошибку.|  
|IM007|Не указан источник данных или драйвер. диалоговое окно запрещено|В строке подключения не указан имя или драйвер источника данных, а *DriverCompletion* был SQL_DRIVER_NOPROMPT.|  
|IM008|Сбой диалогового окна|Драйвер попытался отобразить диалоговое окно входа в систему и выполнить его не удалось.<br /><br /> *WindowHandle* был пустым указателем, а *DriverCompletion* не SQL_DRIVER_NO_PROMPT.|  
|IM009|Не удалось загрузить библиотеку DLL для перевода|Драйверу не удалось загрузить библиотеку DLL преобразования, указанную для источника данных или подключения.|  
|IM010|Слишком длинное имя источника данных|(DM) значение атрибута для ключевого слова DSN длиннее SQL_MAX_DSN_LENGTH символов.|  
|IM011|Слишком длинное имя драйвера|(DM) значение атрибута для ключевого слова **Driver** длиннее 255 символов.|  
|IM012|Ошибка синтаксиса ключевого слова DRIVER|(DM) пара "ключевое слово-значение" для ключевого слова **Driver** содержит синтаксическую ошибку.<br /><br /> (DM) строка в *\* onconnectionstring* содержит ключевое слово **FILEDSN** , но файл DSN не содержит ключевое слово **Driver** или ключевое слово **DSN** .|  
|IM014|Указанное имя источника данных содержит несоответствие архитектуры драйвера и приложения|(DM) 32-разрядное приложение использует имя DSN, которое подключается к 64-разрядному драйверу; или наоборот.|  
|IM015|Сбой SQLDriverConnect драйвера на SQL_HANDLE_DBC_INFO_HANDLE|Если драйвер возвращает SQL_ERROR, диспетчер драйверов вернет SQL_ERROR в приложение, и подключение завершится сбоем.<br /><br /> Дополнительные сведения о SQL_HANDLE_DBC_INFO_TOKEN см. [в разделе Разработка осведомленности Connection-Pool в драйвере ODBC](../../../odbc/reference/develop-driver/developing-connection-pool-awareness-in-an-odbc-driver.md).|  
|IM017|Опрос отключен в режиме асинхронного уведомления|При использовании модели уведомления опрос отключен.|  
|IM018|**Склкомплетеасинк** не был вызван для завершения предыдущей асинхронной операции с этим обработчиком.|Если предыдущий вызов функции в обработчике возвращает SQL_STILL_EXECUTING и если включен режим уведомления, то для обработки после обработки и завершения операции необходимо вызвать **склкомплетеасинк** .|  
|S1118|Драйвер не поддерживает асинхронное уведомление|Если драйвер не поддерживает асинхронное уведомление, нельзя задать SQL_ATTR_ASYNC_DBC_EVENT или SQL_ATTR_ASYNC_DBC_RETCODE_PTR.|  
  
## <a name="comments"></a>Комментарии  
 Строка подключения имеет следующий синтаксис:  
  
 *соединение-строка* :: = *Empty-String*[;] &#124; *атрибут*[;] &#124; *атрибут*; *строка соединения*  
  
 *пустой-string* :: =*атрибут* :: = *атрибут-ключевое слово* = *Attribute-Value* &#124; драйвер = [{]*атрибут-значение*[}]  
  
 *атрибут-Keyword* :: = DSN &#124; UID &#124; PWD &#124; *драйвер-defined-Attribute-ключевоеслово*  
  
 *атрибут-value* :: = *символьная строка*  
  
 *драйвер-defined-Attribute-ключевое слово* :: = *идентификатор*  
  
 где *символьная строка* содержит ноль или более символов; *идентификатор* содержит один или несколько символов; *ключевое слово Attribute-* не учитывает регистр; *атрибут — значение* может быть чувствительным к регистру; и значение ключевого слова **DSN** не состоит только из пробелов.  
  
 Из-за грамматики в строке соединения и файла инициализации, ключевых слов и значений атрибутов, содержащих символы **[] {} (),;? \* аргумент =! @** не заключен в фигурные скобки, поэтому следует избегать. Значение ключевого слова **DSN** не может состоять только из пробелов и не должно содержать начальные пробелы. Из-за грамматики в системных сведениях ключевые слова и имена источников данных не могут содержать символ обратной косой черты ( \\ ).  
  
 Приложениям не нужно добавлять фигурные скобки вокруг значения атрибута после ключевого слова **Driver** , если только атрибут не содержит точку с запятой (;), в этом случае требуются фигурные скобки. Если значение атрибута, получаемое драйвером, содержит фигурные скобки, драйвер не должен удалять их, но должен быть частью возвращенной строки подключения.  
  
 ИМЯ DSN или строка подключения, заключенные в фигурные скобки ( {} ), содержащие любой из символов **[] {} (),;? \* =! @** передается драйверу неизменным. Однако при использовании этих символов в ключевом слове диспетчер драйверов возвращает ошибку при работе с файловыми DSN, но передает строку подключения драйверу для обычных строк подключения. Старайтесь не использовать внедренные фигурные скобки в значении ключевого слова.  
  
 Строка подключения может включать любое количество определенных драйвером ключевых слов. Поскольку ключевое слово **Driver** не использует информацию из сведений о системе, драйвер должен определить достаточно ключевых слов, чтобы драйвер мог подключаться к источнику данных, используя только сведения из строки подключения. (Дополнительные сведения см. в подразделе «рекомендации по драйверу» далее в этом подразделе.) Драйвер определяет, какие ключевые слова необходимы для подключения к источнику данных.  
  
 В следующей таблице описаны значения атрибутов для имен **DSN**, **FILEDSN**, **Driver**, **UID**, **PWD** и **SaveFile** .  
  
|Ключевое слово|Описание значения атрибута|  
|-------------|---------------------------------|  
|**DSN**|Имя источника данных, возвращаемое **SQLDataSources** или диалоговое окно "источники данных" для **SQLDriverConnect**.|  
|**FILEDSN**|Имя DSN-файла, из которого будет создана строка подключения для источника данных. Эти источники данных называются источниками файловых данных.|  
|**АУДИОДРАЙВЕРА**|Описание драйвера, возвращаемое функцией **SQLDrivers** . Например, RDB или SQL Server.|  
|**UID**|ИД пользователя.|  
|**PWD**|Пароль, соответствующий ИДЕНТИФИКАТОРу пользователя, или пустая строка, если для идентификатора пользователя нет пароля (PWD =;).|  
|**SAVEFILE**|Имя файла DSN, в котором должны быть сохранены значения атрибутов ключевых слов, используемых для выполнения текущего соединения.|  
  
 Сведения о том, как приложение выбирает источник данных или драйвер, см. [в разделе Выбор источника данных или драйвера](../../../odbc/reference/develop-app/choosing-a-data-source-or-driver.md).  
  
 Если в строке подключения повторяются любые ключевые слова, драйвер использует значение, связанное с первым вхождением ключевого слова. Если ключевые слова **DSN** и **Driver** включены в одну и ту же строку подключения, диспетчер драйверов и драйвер используют любое ключевое слово First.  
  
 Ключевые слова **FILEDSN** и **DSN** являются взаимоисключающими: в начале используется любое ключевое слово, а второе — игнорируется. Ключевые слова **FILEDSN** и **Driver** , с другой стороны, не являются взаимоисключающими. Если какое-либо ключевое слово появляется в строке подключения с **FILEDSN**, то в строке соединения используется значение атрибута ключевого слова, а не значение атрибута того же ключевого слова в DSN-файле.  
  
 Если используется ключевое слово **FILEDSN** , то для создания строки подключения используются ключевые слова, указанные в DSN-файле. (Дополнительные сведения см. в подразделе «файловые источники данных» далее в этом подразделе.) Ключевое слово **UID** является необязательным; DSN-файл может быть создан только с ключевым словом **Driver** . Ключевое слово **PWD** не хранится в DSN-файле. Каталогом по умолчанию для сохранения и загрузки DSN-файла будет сочетание пути, указанного параметром **коммонфиледир** в HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ виндовс\куррентверсион и "одбк\датасаурцес". (Если Коммонфиледир «C:\Program Files\Common Files», каталогом по умолчанию будет «C:\Program Files\Common Филес\одбк\дата sources».)  
  
> [!NOTE]  
>  DSN-файл можно манипулировать напрямую, вызвав функции [склреадфиледсн](../../../odbc/reference/syntax/sqlreadfiledsn-function.md) и [склвритефиледсн](../../../odbc/reference/syntax/sqlwritefiledsn-function.md) в библиотеке DLL установщика.  
  
 Если используется ключевое слово **SaveFile** , то значения атрибутов ключевых слов, используемых для выполнения текущего соединения, будут сохранены в виде DSN-файла с именем значения атрибута ключевого слова **SaveFile** . Ключевое слово **SaveFile** должно использоваться в сочетании с ключевым словом **Driver** , ключевым словом **FILEDSN** или обоими, или функция возвращает SQL_SUCCESS_WITH_INFO с SQLSTATE 01S09 (недопустимое ключевое слово). Ключевое слово **SaveFile** должно предшествовать ключевому слову **Driver** в строке подключения, иначе результаты будут неопределенными.  
  
## <a name="driver-manager-guidelines"></a>Рекомендации по диспетчеру драйверов  
 Диспетчер драйверов формирует строку подключения для передачи в драйвер в аргументе *onconnectionstring* функции **SQLDriverConnect** драйвера. Диспетчер драйверов не изменяет аргумент *Onconnectionstring* , переданный ему приложением.  
  
 Действие диспетчера драйверов основано на значении аргумента *DriverCompletion* :  
  
-   SQL_DRIVER_PROMPT. Если строка подключения не содержит ключевого слова **Driver**, **DSN** или **FILEDSN** , диспетчер драйверов отображает диалоговое окно Источники данных. Она формирует строку подключения из имени источника данных, возвращаемого диалоговым окном, и другими ключевыми словами, передаваемыми ему в приложении. Если имя источника данных, возвращенное диалоговым окном, пустое, диспетчер драйверов задает пару "ключевое слово-значение" DSN = Default. (В этом диалоговом окне не отображается источник данных с именем «Default».)  
  
-   SQL_DRIVER_COMPLETE или SQL_DRIVER_COMPLETE_REQUIRED. Если строка подключения, указанная в приложении, содержит ключевое слово **DSN** , диспетчер драйверов копирует строку подключения, указанную приложением. В противном случае он выполняет те же действия, что и при SQL_DRIVER_PROMPT *DriverCompletion* .  
  
-   SQL_DRIVER_NOPROMPT: Диспетчер драйверов копирует строку подключения, указанную приложением.  
  
 Если строка подключения, указанная в приложении, содержит ключевое слово **Driver** , диспетчер драйверов копирует строку подключения, указанную приложением.  
  
 Используя созданную строку подключения, диспетчер драйверов определяет, какой драйвер следует использовать, подключается к этому драйверу и передает строку подключения, созданную в драйвере. Дополнительные сведения о взаимодействии диспетчера драйверов и драйвера см. в разделе "Комментарии" в [функции SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md). Если строка подключения не содержит ключевого слова **Driver** , диспетчер драйверов определяет, какой драйвер следует использовать следующим образом.  
  
1.  Если строка подключения содержит ключевое слово **DSN** , диспетчер драйверов извлекает драйвер, связанный с источником данных, из сведений о системе.  
  
2.  Если строка подключения не содержит ключевого слова **DSN** или не найден источник данных, диспетчер драйверов извлекает драйвер, связанный с источником данных по умолчанию, из сведений о системе. (Дополнительные сведения см. в разделе [подраздел по умолчанию](../../../odbc/reference/install/default-subkey.md).) Диспетчер драйверов изменяет значение ключевого слова **DSN** в строке подключения на "default".  
  
3.  Если ключевое слово **DSN** в строке подключения имеет значение "default", диспетчер драйверов извлекает драйвер, связанный с источником данных по умолчанию, из сведений о системе.  
  
4.  Если источник данных не найден и источник данных по умолчанию не найден, диспетчер драйверов возвращает SQL_ERROR с параметром SQLSTATE IM002 (источник данных не найден и драйвер по умолчанию не указан).  
  
## <a name="file-data-sources"></a>Файловые источники данных  
 Если строка подключения, заданная приложением в вызове **SQLDriverConnect** , содержит ключевое **слово FILEDSN** , а это ключевое слово не заменяется ключевым словом **DSN** или **Driver** , то диспетчер драйверов создает строку подключения, используя сведения в DSN-файле и аргументе *onconnectionstring* . Диспетчер драйверов выполняет следующие действия.  
  
1.  Проверяет, является ли имя файла DSN допустимым. В противном случае возвращается SQL_ERROR с параметром SQLSTATE IM014 (недопустимое имя файлового DSN). Если имя файла является пустой строкой (""), а SQL_DRIVER_NOPROMPT не указано, откроется диалоговое окно **открытия файла** . Если имя файла содержит допустимый путь, но нет имени файла или недопустимого имени файла, а SQL_DRIVER_NOPROMPT не указано, то откроется диалоговое окно **открытия файла** , в котором для текущего каталога задано значение, указанное в имени файла. Если имя файла является пустой строкой ("") или имя файла содержит допустимый путь, но отсутствует имя файла или недопустимое имя файла, а SQL_DRIVER_NOPROMPT, то SQL_ERROR возвращается с параметром SQLSTATE IM014 (недопустимое имя файлового DSN).  
  
2.  Считывает все ключевые слова в разделе [ODBC] файла DSN. Если ключевое слово **Driver** отсутствует, оно возвращает SQL_ERROR с SQLSTATE IM012 (ошибка синтаксиса ключевых слов драйвера), за исключением случаев, когда DSN-файл является недоступным и, таким словами, содержит только ключевое слово **DSN** .  
  
     Если файловый источник данных недоступен, диспетчер драйверов считывает значение ключевого слова **DSN** и подключается по мере необходимости к источнику данных пользователя или системы, на который указывает недоступный файловый источник данных. Шаги с 3 по 5 не выполняются.  
  
3.  Конструирует строку подключения для драйвера. Строка подключения драйвера представляет собой объединение ключевых слов, указанных в DSN-файле, и тех, которые указаны в исходной строке подключения приложения. Правила создания строки подключения драйвера, в которой перекрываются ключевые слова:  
  
    -   Если ключевое слово **Driver** существует в строке подключения приложения, а драйверы, указанные ключевыми словами **драйвера** , не одинаковы в DSN-файле и строке подключения приложения, сведения о драйвере в DSN-файле игнорируются, и используется информация о драйвере в строке подключения приложения. Если драйверы, указанные в ключевом слове **Driver** , одинаковы в DSN и строке подключения приложения, то при условии, что все ключевые слова перекрываются, они имеют приоритет над параметрами, указанными в файле. DSN.  
  
    -   В новой строке подключения ключевое слово **FILEDSN** исключено.  
  
4.  Загружает драйвер, просмотрев запись реестра HKEY_LOCAL_MACHINE\SOFTWARE\ODBC\ODBCINST.INI\\<имя драйвера \> \Driver, где \<Driver Name> указывается ключевым словом **Driver** .  
  
5.  Передает драйверу новую строку соединений.  
  
 Примеры файлов DSN см. в разделе [подключение с использованием файловых источников данных](../../../odbc/reference/develop-app/connecting-using-file-data-sources.md).  
  
## <a name="savefile-keyword"></a>Ключевое слово SAVEFILE  
 Если строка подключения, указанная в приложении, содержит ключевое слово **SaveFile** , то диспетчер драйверов сохранит строку подключения в DSN-файле. Диспетчер драйверов выполняет следующие действия.  
  
1.  Проверяет, является ли допустимым имя файла DSN, включенного в качестве значения атрибута ключевого слова **SaveFile** . В противном случае возвращается SQL_ERROR с параметром SQLSTATE IM014 (недопустимое имя файлового DSN). Допустимость имени файла определяется стандартными правилами именования системы. Если имя файла является пустой строкой (""), а аргумент *DriverCompletion* не SQL_DRIVER_NOPROMPT, то имя файла является допустимым. Если имя файла уже существует, то если *DriverCompletion* имеет SQL_DRIVER_NOPROMPT, файл перезаписывается. Если *DriverCompletion* имеет значение SQL_DRIVER_PROMPT, SQL_DRIVER_COMPLETE или SQL_DRIVER_COMPLETE_REQUIRED, диалоговое окно предлагает пользователю указать, следует ли перезаписывать файл. Если параметр не указан, откроется диалоговое окно **Сохранение файла** .  
  
2.  Если драйвер возвращает SQL_SUCCESS и имя файла не было пустой строкой, диспетчер драйверов записывает сведения о соединении, возвращенные в аргументе of *ConnectionString* , в указанный файл в формате, указанном в разделе "строки подключения" ранее в этом разделе.  
  
3.  Если драйвер возвращает SQL_SUCCESS и имя файла было пустой строкой (""), диспетчер драйверов вызывает диалоговое окно " **Сохранение файла** " с указанным *HWND* и записывает сведения о соединении, возвращенные в параметре *connectionstring* , в файл, File-Save указанный в разделе "строки подключения" ранее в этом разделе.  
  
4.  Если драйвер возвращает SQL_SUCCESS, то он возвращает аргумент of *ConnectionString* , содержащий строку подключения к приложению.  
  
5.  Если драйвер возвращает SQL_SUCCESS_WITH_INFO или SQL_ERROR, диспетчер драйверов возвращает значение SQLSTATE в приложение.  
  
## <a name="driver-guidelines"></a>Рекомендации по драйверам  
 Драйвер проверяет, содержит ли строка подключения, передаваемая диспетчером драйверов, имя **DSN** или ключевое слово **Driver** . Если строка подключения содержит ключевое слово **Driver** , драйвер не может получить сведения об источнике данных из сведений о системе. Если строка подключения содержит ключевое слово **DSN** или не содержит ключевое слово **DSN** или **Driver** , драйвер может получить сведения об источнике данных из системной информации следующим образом:  
  
1.  Если строка подключения содержит ключевое слово **DSN** , драйвер получает сведения для указанного источника данных.  
  
2.  Если строка подключения не содержит ключевого слова **DSN** , указанный источник данных не найден или для ключевого слова **DSN** установлено значение "default", драйвер получает сведения об источнике данных по умолчанию.  
  
 Драйвер использует любую информацию, полученную от системной информации, для дополнения информации, передаваемой ей в строке подключения. Если информация в системной информации дублирует сведения в строке подключения, драйвер использует сведения в строке подключения.  
  
 В зависимости от значения *DriverCompletion* драйвер запрашивает у пользователя сведения о подключении, такие как идентификатор пользователя и пароль, и подключается к источнику данных:  
  
-   SQL_DRIVER_PROMPT. драйвер отображает диалоговое окно, в котором используются значения из строки подключения и сведения о системе (если таковые имеются) в качестве начальных значений. Когда пользователь закрывает диалоговое окно, драйвер подключается к источнику данных. Она также формирует строку подключения из значения ключевого слова **DSN** или **Driver** в параметре \* *onconnectionstring* и сведений, возвращаемых из диалогового окна. Эта строка подключения размещается в буфере \ \ \*ConnectionString* .  
  
-   SQL_DRIVER_COMPLETE или SQL_DRIVER_COMPLETE_REQUIRED. Если строка подключения содержит достаточно информации и эта информация верна, драйвер подключается к источнику данных и копирует в \* *ConnectionString* \* . Если какая-либо информация отсутствует или неверна, драйвер выполняет те же действия, что и при SQL_DRIVER_PROMPT *DriverCompletion* , за исключением того, что если *DriverCompletion* SQL_DRIVER_COMPLETE_REQUIRED, драйвер отключает элементы управления для любых сведений, не необходимых для подключения к источнику данных.  
  
-   SQL_DRIVER_NOPROMPT. Если строка подключения содержит достаточно сведений, драйвер подключится к источнику данных и скопирует параметр \* *ConnectionString* в параметр \* *ConnectionString*. В противном случае драйвер возвращает SQL_ERROR для **SQLDriverConnect**.  
  
 При успешном подключении к источнику данных драйвер также задает для \* *StringLength2Ptr* длину строки подключения вывода, доступной для возврата в * of *ConnectionString*.  
  
 Если пользователь отменяет диалоговое окно, предоставленное диспетчером драйверов или драйвером, **SQLDriverConnect** возвращает SQL_NO_DATA.  
  
 Сведения о том, как диспетчер драйверов и драйвер взаимодействуют в процессе подключения, см. в разделе [Функция SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md).  
  
 Если драйвер поддерживает **SQLDriverConnect**, раздел "ключевое слово драйвера" системных сведений о драйвере должен содержать ключевое слово **коннектфунктионс** со вторым символом, равным "Y".  
  
## <a name="connecting-when-connection-pooling-is-enabled"></a>Подключение при включенном пуле соединений  
 Пул соединений позволяет приложению повторно использовать уже созданное соединение. При вызове **SQLDriverConnect** диспетчер драйверов пытается установить соединение с помощью соединения, входящего в пул подключений в среде, которая была назначена для пула соединений. Дополнительные сведения о пуле соединений см. в разделе [Функция SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md).  
  
 Приложение может задать SQL_ATTR_RESET_CONNECTION перед вызовом SQLDisconnect для подключения, в котором включена группировка. Дополнительные сведения см. в разделе [функция SQLSetConnectAttr](../../../odbc/reference/syntax/sqlsetconnectattr-function.md).  
  
 Если приложение вызывает **SQLDriverConnect** для подключения к подключению пула, применяются следующие ограничения.  
  
-   Если в строке подключения указано ключевое слово **SaveFile** , обработка пулов соединений не выполняется.  
  
-   Если включено использование пулов соединений, **SQLDriverConnect** можно вызвать только с аргументом *DriverCompletion* SQL_DRIVER_NOPROMPT; Если **SQLDriverConnect** вызывается с любым другим *DriverCompletion*, будет возвращено значение SQLSTATE HY110 (недопустимое завершение драйвера).  
  
## <a name="connection-attributes"></a>Атрибуты соединения  
 Атрибут подключения SQL_ATTR_LOGIN_TIMEOUT, заданный с помощью **SQLSetConnectAttr**, определяет время ожидания (в секундах), по истечении которого запрос на вход завершается с успешным подключением драйвера перед возвратом в приложение. Если пользователю предлагается завершить строку подключения, то период ожидания для каждого запроса на вход начинается, когда драйвер запускает процесс подключения.  
  
 По умолчанию драйвер открывает подключение в режиме SQL_MODE_READ_WRITE доступа. Чтобы установить режим доступа SQL_MODE_READ_ONLY, приложение должно вызвать **SQLSetConnectAttr** с атрибутом SQL_ATTR_ACCESS_MODE перед вызовом **SQLDriverConnect**.  
  
 Если в сведениях о системе для источника данных указана Библиотека преобразования по умолчанию, драйвер загружает его. Другую библиотеку преобразования можно загрузить путем вызова **SQLSetConnectAttr** с помощью атрибута SQL_ATTR_TRANSLATE_LIB. Параметр перевода можно указать, вызвав **SQLSetConnectAttr** с параметром SQL_ATTR_TRANSLATE_OPTION.  
  
 Дополнительные сведения см. [в разделе Подключение с помощью SQLDriverConnect](../../../odbc/reference/develop-app/connecting-with-sqldriverconnect.md).  
  
```cpp  
// SQLDriverConnect_ref.cpp  
// compile with: odbc32.lib user32.lib  
#include <windows.h>  
#include <sqlext.h>  
  
int main() {  
   SQLHENV henv;  
   SQLHDBC hdbc;  
   SQLHSTMT hstmt;  
   SQLRETURN retcode;  
  
   SQLCHAR OutConnStr[255];  
   SQLSMALLINT OutConnStrLen;  
  
   HWND desktopHandle = GetDesktopWindow();   // desktop's window handle  
  
   // Allocate environment handle  
   retcode = SQLAllocHandle(SQL_HANDLE_ENV, SQL_NULL_HANDLE, &henv);  
  
   // Set the ODBC version environment attribute  
   if (retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO) {  
      retcode = SQLSetEnvAttr(henv, SQL_ATTR_ODBC_VERSION, (SQLPOINTER*)SQL_OV_ODBC3, 0);   
  
      // Allocate connection handle  
      if (retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO) {  
         retcode = SQLAllocHandle(SQL_HANDLE_DBC, henv, &hdbc);   
  
         // Set login timeout to 5 seconds  
         if (retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO) {  
            SQLSetConnectAttr(hdbc, SQL_LOGIN_TIMEOUT, (SQLPOINTER)5, 0);  
  
            retcode = SQLDriverConnect( // SQL_NULL_HDBC  
               hdbc,   
               desktopHandle,   
               (SQLCHAR*)"driver=SQL Server",   
               _countof("driver=SQL Server"),  
               OutConnStr,  
               255,   
               &OutConnStrLen,  
               SQL_DRIVER_PROMPT );  
  
            // Allocate statement handle  
            if (retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO) {                 
               retcode = SQLAllocHandle(SQL_HANDLE_STMT, hdbc, &hstmt);   
  
               // Process data  
               if (retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO) {  
                  SQLFreeHandle(SQL_HANDLE_STMT, hstmt);  
               }  
  
               SQLDisconnect(hdbc);  
            }  
  
            SQLFreeHandle(SQL_HANDLE_DBC, hdbc);  
         }  
      }  
      SQLFreeHandle(SQL_HANDLE_ENV, henv);  
   }  
}  
```  
  
 См. также [Пример программы ODBC](../../../odbc/reference/sample-odbc-program.md).  
  
## <a name="related-functions"></a>Связанные функции  
  
|Сведения о|См.|  
|---------------------------|---------|  
|Выделение маркера|[Функция SQLAllocHandle](../../../odbc/reference/syntax/sqlallochandle-function.md)|  
|Обнаружение и перечисление значений, необходимых для подключения к источнику данных|[Функция SQLBrowseConnect](../../../odbc/reference/syntax/sqlbrowseconnect-function.md)|  
|Подключение к источнику данных|[Функция SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md)|  
|Отключение от источника данных|[Функция SQLDisconnect](../../../odbc/reference/syntax/sqldisconnect-function.md)|  
|Возвращение описаний и атрибутов драйверов|[Функция SQLDrivers](../../../odbc/reference/syntax/sqldrivers-function.md)|  
|Освобождение маркера|[SQLFreeHandle, функция](../../../odbc/reference/syntax/sqlfreehandle-function.md)|  
|Установка атрибута соединения|[Функция SQLSetConnectAttr](../../../odbc/reference/syntax/sqlsetconnectattr-function.md)|  
  
## <a name="see-also"></a>См. также:  
 [Справочник по API ODBC](../../../odbc/reference/syntax/odbc-api-reference.md)   
 [Файлы заголовков ODBC](../../../odbc/reference/install/odbc-header-files.md)
