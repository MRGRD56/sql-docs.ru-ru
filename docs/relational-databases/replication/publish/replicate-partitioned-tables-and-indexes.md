---
description: Репликация секционированных таблиц и индексов
title: Репликация секционированных таблиц и индексов | Документация Майкрософт
ms.custom: ''
ms.date: 09/10/2015
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- partitioned indexes [SQL Server], replicating
- partitioned tables [SQL Server], replicating
- replication [SQL Server], partitioned tables
- publishing [SQL Server replication], partitioned tables
- transactional replication, partitioned tables
ms.assetid: c9fa81b1-6c81-4c11-927b-fab16301a8f5
author: MashaMSFT
ms.author: mathoma
monikerRange: =azuresqldb-mi-current||>=sql-server-2016
ms.openlocfilehash: 75c0f38e67fd4d02791c5d2b953f4354a5945dc2
ms.sourcegitcommit: e5664d20ed507a6f1b5e8ae7429a172a427b066c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/19/2020
ms.locfileid: "97697145"
---
# <a name="replicate-partitioned-tables-and-indexes"></a>Репликация секционированных таблиц и индексов
[!INCLUDE[sql-asdbmi](../../../includes/applies-to-version/sql-asdbmi.md)]
  Секционирование делает большие таблицы и индексы более управляемыми, так как позволяет быстро и эффективно получать доступ к подмножествам данных и управлять ими, при этом сохраняя целостность всей коллекции данных. Дополнительные сведения см. в разделе [Partitioned Tables and Indexes](../../../relational-databases/partitions/partitioned-tables-and-indexes.md). Репликация поддерживает секционирование, предоставляя набор свойств, которые указывают, как работать с секционированными таблицами и индексами.  
  
## <a name="article-properties-for-transactional-and-merge-replication"></a>Свойства статьи для репликации слиянием и репликации транзакций  
 В таблице перечислены объекты, применяемые для секционирования данных.  
  
|Объект|Создан с помощью|  
|------------|----------------------|  
|Секционированная таблица или индекс|CREATE TABLE или CREATE INDEX|  
|Функция секционирования|CREATE PARTITION FUNCTION|  
|Схема секционирования|CREATE PARTITION SCHEME|  
  
 Свойства секционирования — это параметры схемы статьи, определяющие, следует ли копировать объекты секционирования в экземпляр подписчика. Эти параметры схемы могут быть установлены следующими способами.  
  
-   На странице **Свойства статьи** мастера создания публикаций или в диалоговом окне «Свойства публикации». Чтобы копировать объекты, перечисленные в предыдущей таблице, задайте значение **true** для свойств **Копировать схемы секционирования таблиц** и **Копировать схемы секционирования индекса**. Сведения о доступе к странице **Свойства статьи** см. в статье [Просмотр и изменение свойств публикации](../../../relational-databases/replication/publish/view-and-modify-publication-properties.md).  
  
-   С помощью параметра *schema_option* одной из следующих хранимых процедур:  
  
    -   [sp_addarticle](../../../relational-databases/system-stored-procedures/sp-addarticle-transact-sql.md) или [sp_changearticle](../../../relational-databases/system-stored-procedures/sp-changearticle-transact-sql.md) для репликации транзакций;  
  
    -   [sp_addmergearticle](../../../relational-databases/system-stored-procedures/sp-addmergearticle-transact-sql.md) или [sp_changemergearticle](../../../relational-databases/system-stored-procedures/sp-changemergearticle-transact-sql.md) для репликации слиянием.  
  
     Чтобы копировать объекты, перечисленные в предыдущей таблице, выберите соответствующие значения параметров схемы. Дополнительные сведения об указании параметров схемы см. в разделе [Specify Schema Options](../../../relational-databases/replication/publish/specify-schema-options.md).  
  
 Репликация копирует объекты на подписчик во время начальной синхронизации. Если схема секционирования использует файловые группы, отличные от PRIMARY, эти файловые группы должны существовать на подписчике до начальной синхронизации.  
  
 После инициализации подписчика изменения данных распространяются на подписчик и применяются к соответствующим секциям. Однако изменения схемы секционирования не поддерживаются. Репликация транзакций и репликация слиянием не поддерживают репликацию следующих команд: ALTER PARTITION FUNCTION, ALTER PARTITION SCHEME, а также инструкции REBUILD WITH PARTITION команды ALTER INDEX. Изменения, связанные с ними, не будут автоматически реплицироваться на подписчика. Пользователь должен вручную внести соответствующие изменения.  
  
## <a name="replication-support-for-partition-switching"></a>Поддержка переключения секций при репликации  
 Одно из главных преимуществ секционирования — способность быстро и эффективно перемещать подмножества данных между секциями. Данные перемещаются командой SWITCH PARTITION. По умолчанию, если таблица включена для репликации, операции SWITCH PARTITION блокированы по следующим причинам.  
  
-   Если данные перемещаются в таблицу или из таблицы, которая существует на издателе, но не на подписчике, издатель и подписчик могут оказаться несогласованными друг с другом. Эта проблема обычно возникает при перемещении данных в промежуточную таблицу или из нее.  
  
-   Если определение секционированной таблицы отличается на подписчике и издателе, агент распространителя завершит свою работу ошибкой при попытке применить изменения на подписчике.  
  
Несмотря на эти возможные проблемы, переключение секций можно включить при репликации транзакций. Прежде чем включить переключение секций, убедитесь, что все таблицы, участвующие в переключении секций, существуют на издателе и на подписчике и что определения таблиц и разделов совпадают.  
  
Если все секции имеют одинаковую схему на издателях и подписчиках, можно включить параметр *allow_partition_switch* вместе с *replication_partition_switch*, что позволит выполнить репликацию только инструкции о переключении секции для подписчика. Можно также включить параметр *allow_partition_switch* без репликации DDL. Это полезно, когда из раздела требуется убрать сведения за прошлые месяцы, однако сохранить реплицированную секцию в течение следующего года в целях резервного копирования на подписчике.  
  
При включении переключения секций в SQL Server 2008 R2 через текущую версию вам могут также потребоваться операции разбиения и слияния в ближайшем будущем. Перед выполнением операций разделения или слияния секций в реплицированной таблице или таблице с поддержкой CDC убедитесь, что нужная секция не содержит реплицированные команды в режиме ожидания. Также следует учитывать, что при разбиении или слиянии в секции не должны выполняться операции DML. Наличие транзакций, необработанных агентом чтения журнала или заданием отслеживания CDC, или выполнение операций DML в секции реплицируемой таблицы с поддержкой CDC во время выполнения операции разделения или слияния (с использованием одной и той же секции) может привести к ошибке обработки (Ошибка 608. No catalog entry found for partition ID (Запись каталога не обнаружена для идентификатора секции)) агентом чтения журнала или заданием отслеживания CDC. Чтобы исправить эту ошибку, может потребоваться повторная инициализация подписки или отключение отслеживания изменения данных для таблицы или базы данных. 

### <a name="unsupported-scenarios"></a>Неподдерживаемые сценарии

При использовании репликации с переключением секций не будут поддерживаться следующие сценарии: 

**Одноранговая репликация**   
Одноранговая репликация не поддерживается при переключении секций. 

**Использование переменных с переключением секций**   

Использование переменных с переключением секций в таблицах, опубликованных с помощью репликации транзакций или отслеживания измененных данных (CDC), не поддерживается для инструкции `ALTER TABLE ... SWITCH TO ... PARTITION ...`.

Например, следующий код переключения секций не будет работать с базой данных, для которой включена функция CDC, или с таблицей А, используемой при публикации транзакций: 

```sql
DECLARE @SomeVariable INT = $PARTITION.pf_test(10);
ALTER TABLE dbo.TableA
SWITCH TO dbo.TableB 
PARTITION @SomeVariable;
```

Вместо этого переключите секцию напрямую с помощью функции секционирования, как показано в следующем примере: 

```sql
ALTER TABLE NonPartitionedTable 
SWITCH TO PartitionedTable PARTITION $PARTITION.pf_test(10);
```


### <a name="enabling-partition-switching"></a>Включение переключения секций  
 Следующие свойства публикации транзакций позволяют пользователям управлять переключением секций в реплицируемой среде.  
  
-   `@allow_partition_switch`. Если его значение равно `true`, команду SWITCH PARTITION можно выполнять в базе данных публикации.  
  
-   `@replicate_partition_switch` определяет, реплицировать ли инструкцию DDL SWITCH PARTITION на подписчик. Этот параметр доступен, если свойство `@allow_partition_switch` имеет значение `true`.  
  
 Эти свойства можно задать с помощью хранимой процедуры [sp_addpublication](../../../relational-databases/system-stored-procedures/sp-addpublication-transact-sql.md) при создании публикации или с помощью процедуры [sp_changepublication](../../../relational-databases/system-stored-procedures/sp-changepublication-transact-sql.md) после создания публикации. Как уже отмечалось, репликация слиянием не поддерживает переключение секций. Чтобы выполнить команду SWITCH PARTITION для таблицы, для которой включена репликация слиянием, удалите эту таблицу из публикации.  
  
## <a name="see-also"></a>См. также  
 [Публикация данных и объектов базы данных](../../../relational-databases/replication/publish/publish-data-and-database-objects.md)  
  
  
