---
title: Руководство по Настройка репликации слиянием
description: В этом учебнике описывается настройка репликации слиянием между SQL Server и мобильным клиентом.
ms.custom: seo-lt-2019
ms.date: 04/03/2018
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: replication
ms.topic: quickstart
helpviewer_keywords:
- replication [SQL Server], tutorials
ms.assetid: af673514-30c7-403a-9d18-d01e1a095115
author: MashaMSFT
ms.author: mathoma
monikerRange: '>=aps-pdw-2016||=azuresqldb-current||=azure-sqldw-latest||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current'
ms.openlocfilehash: a4ffeb0300e8211110ba3a8b303ff21b230626b9
ms.sourcegitcommit: 4d370399f6f142e25075b3714e5c2ce056b1bfd0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91866903"
---
# <a name="tutorial-configure-replication-between-a-server-and-mobile-clients-merge"></a>Руководство по Настройка репликации между сервером и мобильными клиентами (репликация слиянием)
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]
Репликация слиянием является хорошим решением проблемы перемещения данных между центральным сервером и мобильными клиентами, не имеющими постоянного подключения. С помощью мастеров репликации можно легко настроить и администрировать топологию репликации слиянием. 

В этом учебнике демонстрируется, как настроить топологию репликации для мобильных клиентов. Дополнительные сведения о репликации слиянием см. в разделе [Обзор репликации слиянием](./merge/merge-replication.md).
  
## <a name="what-you-will-learn"></a>Новые знания  
В этом учебнике используется репликация слиянием, чтобы опубликовать данные из центральной базы данных для одного пользователя мобильного устройства или нескольких так, что каждый пользователь получит уникальным образом фильтрованное подмножество данных. 

В этом учебнике рассматривается следующее.
> [!div class="checklist"]
> * Настройка издателя для репликации слиянием.
> * Добавление мобильных устройств подписчика для публикации слиянием.
> * Синхронизация подписки на публикацию слиянием.
  
## <a name="prerequisites"></a>Предварительные требования  
Этот учебник предназначен для пользователей, знакомых с основными операциями с базами данных, но имеющих ограниченный опыт работы с репликацией. Перед тем как приступить к работе с этим учебником, необходимо освоить [Учебник. Подготовка SQL Server к репликации](../../relational-databases/replication/tutorial-preparing-the-server-for-replication.md).  
  
Для работы с этим учебником требуется SQL Server, среда SQL Server Management Studio (SSMS) и база данных AdventureWorks. 
  
- На сервере-издателе (источник) установите следующее:  
  
   - Любой выпуск SQL Server, кроме SQL Server Express или SQL Server Compact. Эти выпуски не могут быть издателями репликации.   
   - Образец базы данных [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] . В целях повышения безопасности образцы баз данных по умолчанию не устанавливаются.  
  
- На сервере-подписчике (целевом) установите любой выпуск SQL Server, кроме SQL Server Express или SQL Server Compact. Созданная в рамках этого учебника публикация не поддерживает выпуски SQL Server Express и SQL Server Compact. 

- Установите [SQL Server Management Studio](../../ssms/download-sql-server-management-studio-ssms.md).
- Установите выпуск [SQL Server 2017 Developer Edition](https://www.microsoft.com/sql-server/sql-server-downloads).
- Скачайте [пример базы данных AdventureWorks](https://github.com/Microsoft/sql-server-samples/releases). См. дополнительные сведения о [восстановлении базы данных в среде SSMS](../backup-restore/restore-a-database-backup-using-ssms.md).  
 
  
>[!NOTE]
> - Репликация не поддерживается в экземплярах SQL Server, которые отличаются друг от друга больше, чем на две версии. См. дополнительные сведения о [поддерживаемых версиях SQL Server в топологии репликации](https://blogs.msdn.microsoft.com/repltalk/2016/08/12/suppported-sql-server-versions-in-replication-topology/).
> - В среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] необходимо подключиться к издателю и подписчику с помощью имени входа, которое является членом предопределенной роли сервера **sysadmin**. Дополнительные сведения о роли см. в статье [Роли уровня сервера](../security/authentication-access/server-level-roles.md).  
  
  
**На изучение этого руководства потребуется примерно 60 минут**  
  
## <a name="configure-a-publisher-for-merge-replication"></a>Настройка издателя для репликации слиянием
В этом разделе с помощью среды [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] создается публикация слиянием с целью публикации подмножества таблиц **Employee**, **SalesOrderHeader** и **SalesOrderDetail** в образце базы данных [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)]. Эти таблицы фильтруются с помощью параметризованных фильтров строк, так что каждая подписка содержит уникальную секцию данных. Также в список доступа к публикации добавляется имя для входа [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], используемое агентом слияния.  
  
### <a name="create-merge-publication-and-define-articles"></a>Создание публикации слиянием и определение статей  
  
1. Подключитесь к издателю в среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], а затем раскройте узел сервера.  
  
2. Запустите агент SQL Server. Для этого щелкните правой кнопкой мыши в окне обозревателя объектов и выберите команду **Запустить**. Если агент не запускается, это необходимо сделать вручную в диспетчере конфигурации SQL Server.  
3. Разверните папку **Репликация**, щелкните правой кнопкой мыши элемент **Локальные публикации** и выберите пункт **Создать публикацию**. Запустится мастер создания публикации.  

   ![Выделенные элементы для запуска мастера создания публикации](media/tutorial-replicating-data-between-continuously-connected-servers/newpublication.png)
  
3. На странице **База данных публикации** выберите [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] и нажмите кнопку **Далее**. 

      
4. На странице **Тип публикации** выберите **Публикация слиянием** и нажмите кнопку **Далее**.  
   
5. На странице **Типы подписчиков** убедитесь, что выбран только [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] или более поздняя версия, и нажмите кнопку **Далее**: 

    ![Страницы "Тип публикации" и "Типы подписчиков"](media/tutorial-replicating-data-with-mobile-clients/mergerpl.png)
  
   
6. На странице **Статьи** разверните узел **Таблицы**. Выберите следующие три таблицы: **Employee**, **SalesOrderHeader** и **SalesOrderDetail**. Выберите **Далее**.  

   ![Выбранные таблицы на странице "Статьи"](media/tutorial-replicating-data-with-mobile-clients/mergearticles.png)

   >[!NOTE]
   > Таблица **Employee** содержит столбец (**OrganizationNode**) с типом данных **hierarchyid**. Этот тип данных поддерживается при репликации только в SQL Server 2017. 
   >
   > Если вы используете версию сборки, предшествующую SQL Server 2017, в нижней части экрана появится сообщение о риске потери данных при использовании этого столбца для двусторонней репликации. В рамках этого учебника данное сообщение можно игнорировать. Тем не менее, если вы не используете поддерживаемую сборку в рабочей среде, этот тип данных не должен участвовать в репликации.
   > 
   > Дополнительные сведения о репликации типа данных **hierarchyid** см. в разделе [Использование столбцов Hierarchyid в репликации](../../t-sql/data-types/hierarchyid-data-type-method-reference.md#using-hierarchyid-columns-in-replicated-tables).
    
  
7. На странице **Фильтрация строк таблицы** выберите команду **Добавить**, а затем щелкните пункт **Добавить фильтр**.  
  
8. В диалоговом окне **Добавить фильтр** выберите **Employee (HumanResources)** в поле **Выбрать таблицу для фильтрации**. Щелкните столбец **LoginID**, щелкните стрелку вправо, чтобы добавить столбец в предложение WHERE фильтрующего запроса, и измените предложение WHERE следующим образом:  
  
   ```sql 
    WHERE [LoginID] = HOST_NAME()  
   ```  
  
   Щелкните пункт **Строка из этой таблицы будет отправлена только одной подписке** и нажмите кнопку **ОК**.  
 
   ![Выбранные элементы для добавления фильтра](media/tutorial-replicating-data-with-mobile-clients/mergeaddfilter.png)

    
  
10. На странице **Фильтрация строк таблицы** выберите **Employee (Human Resources)** , нажмите кнопку **Добавить** и выберите команду **Добавить соединение для расширения выбранного фильтра**.  
  
    а. В диалоговом окне **Добавление соединения** выберите **Sales.SalesOrderHeader** в поле **Соединяемая таблица**. Выберите **Записать инструкцию соединения вручную** и завершите инструкцию соединения следующим образом:  
  
    ```sql  
    ON [Employee].[BusinessEntityID] =  [SalesOrderHeader].[SalesPersonID] 
    ```  
  
    b. В поле **Укажите параметры соединения** выберите **Уникальный ключ**, а затем нажмите кнопку **ОК**.

    ![Выбранные элементы для добавления соединения в фильтр](media/tutorial-replicating-data-with-mobile-clients/mergeaddjoin.png)

  
13. На странице **Фильтрация строк таблицы** выберите **SalesOrderHeader**, нажмите кнопку **Добавить** и выберите команду **Добавить соединение для расширения выбранного фильтра**.  
  
    а. В диалоговом окне **Добавление соединения** выберите **Sales.SalesOrderDetail** в поле **Соединяемая таблица**.    
    b. Выберите **Использовать конструктор для создания инструкции**.  
    c. В поле **Предварительный просмотр** убедитесь, что инструкция соединения выглядит следующим образом:  
  
    ```sql  
    ON [SalesOrderHeader].[SalesOrderID] = [SalesOrderDetail].[SalesOrderID] 
    ```  
  
    d. В поле **Укажите параметры соединения** выберите **Уникальный ключ**, а затем нажмите кнопку **ОК**. Выберите **Далее**. 

    ![Выбранные элементы для добавления другого соединения (заказов на продажу)](media/tutorial-replicating-data-with-mobile-clients/joinsalestables.png)
  
21. Установите флажок **Создать моментальный снимок немедленно**, снимите флажок **Запланировать запуск агента моментальных снимков в следующее время** и нажмите кнопку **Далее**:  

    ![Выбор для мгновенного создания моментального снимка](media/tutorial-replicating-data-with-mobile-clients/snapshotagent.png)
  
22. На странице **Безопасность агента** выберите **Параметры безопасности**. Введите <*имя_компьютера_издателя*> **\repl_snapshot** в поле **Учетная запись процесса**, укажите пароль этой учетной записи и нажмите кнопку **ОК**. Выберите **Далее**.  

    ![Выбор для настройки безопасности агента моментальных снимков](media/tutorial-replicating-data-with-mobile-clients/snapshotagentsecurity.png)
  
23. На странице **Завершение работы мастера** введите **AdvWorksSalesOrdersMerge** в поле **Имя публикации** и нажмите кнопку **Готово**:  

    ![Страница "Завершение работы мастера" с именем публикации](media/tutorial-replicating-data-with-mobile-clients/namemergerepl.png)
  
24. По завершении создания публикации нажмите кнопку **Закрыть**. В узле **Репликация** в **обозревателе объектов** щелкните правой кнопкой мыши элемент **Локальные публикации** и выберите **Обновить**, чтобы просмотреть новую репликацию слиянием.  
  
### <a name="view-the-status-of-snapshot-generation"></a>Просмотр состояния создания моментального снимка  
  
1. Подключитесь к издателю в среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], а затем разверните узел сервера и папку **Репликация**.  
  
2. В папке **Локальные публикации** щелкните правой кнопкой мыши публикацию **AdvWorksSalesOrdersMerge** и выберите пункт **Просмотр состояния агента моментальных снимков**.  

   ![Выбор для просмотра состояния агента моментальных снимков](media/tutorial-replicating-data-with-mobile-clients/viewsnapshotagentstatus.png)
  
3. Отобразятся сведения о текущем состоянии задания агента моментальных снимков для публикации. Перед тем как перейти к следующему занятию, убедитесь, что задание моментального снимка выполнено успешно.  
  
### <a name="add-the-merge-agent-login-to-the-pal"></a>Добавление имени для входа агента слияния в список доступа к публикации  
  
1. Подключитесь к издателю в среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], а затем разверните узел сервера и папку **Репликация**.  
  
2. В папке **Локальные публикации** щелкните правой кнопкой мыши публикацию **AdvWorksSalesOrdersMerge** и выберите пункт **Свойства**.  
  
   а. Выберите страницу **Список доступа к публикации** и нажмите кнопку **Добавить**. 
  
   b. В диалоговом окне **Добавление доступа к публикации** выберите <*имя_компьютера_издателя*> **\repl_merge** и нажмите кнопку **ОК**. Нажмите кнопку **ОК** еще раз. 

   ![Выбранные элементы для добавления имени для входа агента слияния](media/tutorial-replicating-data-with-mobile-clients/mergepal.png) 

  
Дополнительные сведения см. в разделе:  
- [Фильтрация опубликованных данных](../../relational-databases/replication/publish/filter-published-data.md) 
- [Параметризованные фильтры строк](../../relational-databases/replication/merge/parameterized-filters-parameterized-row-filters.md)  
- [Определение статьи](../../relational-databases/replication/publish/define-an-article.md)  
  
  
## <a name="create-a-subscription-to-the-merge-publication"></a>Создание подписки на публикацию слиянием
В этом разделе описывается добавление подписки к ранее созданной публикации слиянием. В этом учебнике используется удаленный подписчик (NODE2\SQL2016). После будут заданы разрешения на базу данных подписки и вручную сформирован моментальный снимок отфильтрованных данных для новой подписки.   
  
### <a name="add-a-subscriber-for-merge-publication"></a>Добавление подписчика для публикации слиянием
  
1. Подключитесь к подписчику в [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] и раскройте узел сервера. Разверните папку **Репликация**, щелкните правой кнопкой мыши папку **Локальные подписки** и выберите пункт **Создать подписку**. Запустится мастер создания подписки:

   ![Выбранные элементы для запуска мастера создания подписки](media/tutorial-replicating-data-with-mobile-clients/newsub.png)
  
2. На странице **Публикация** из списка **Издатель** выберите **Найти издатель SQL Server**.  
  
   В диалоговом окне **Подключение к серверу** введите имя экземпляра издателя в поле **Имя сервера**, а затем выберите команду **Подключиться**: 

   ![Выбранные элементы для добавления издателя](media/tutorial-replicating-data-with-mobile-clients/publication.png)
  
4. Щелкните элемент **AdvWorksSalesOrdersMerge**, а затем нажмите кнопку **Далее**.  
  
5. На странице **Расположение агента слияния** выберите команду **Выполнять каждый агент на своем подписчике** и нажмите кнопку **Далее**:  

   ![Параметр "Выполнять каждый агент на своем подписчике"](media/tutorial-replicating-data-with-mobile-clients/pullsub.png)
  
6. На странице **Подписчики** выберите имя экземпляра сервера подписчика. Выберите в списке пункт **Создать базу данных** в разделе **База данных подписки**.  
  
   В диалоговом окне **Новая база данных** в поле **Имя базы данных** введите **SalesOrdersReplica**. Нажмите кнопку **ОК**, а затем кнопку **Далее**. 

   ![Выбранные элементы для добавления базы данных на подписчик](media/tutorial-replicating-data-with-mobile-clients/addsubdb.png)
  
8. На странице **Безопасность агента слияния** выберите кнопку с многоточием ( **…** ). Введите <*имя_компьютера_подписчика*> **\repl_merge** в поле **Учетная запись процесса** и укажите пароль для учетной записи. Нажмите кнопку **ОК**, кнопку **Далее**, а затем — снова **Далее**.  

   ![Выбранные элементы для безопасности агента слияния](media/tutorial-replicating-data-with-mobile-clients/mergeagentsecurity.png)

9. На странице **Расписание синхронизации** присвойте параметру **Расписание агента** значение **Выполнение по запросу**. Выберите **Далее**.  

   ![Выбор "Выполнение по запросу" для агента](media/tutorial-replicating-data-with-mobile-clients/mergesyncschedule.png)
  
9. На странице **Инициализация подписок** выберите пункт **При первой синхронизации** в списке **Когда инициализировать**. Нажмите кнопку **Далее**, чтобы перейти на страницу **Тип подписки**, и выберите соответствующий тип подписки. В этом учебнике используется тип **Клиент**. После выбора типа подписки нажмите кнопку **Далее** еще раз. 

   ![Выбранные элементы для инициализации подписок при первой синхронизации](media/tutorial-replicating-data-with-mobile-clients/firstsync.png)

10. На странице **Значения HOST_NAME** в поле **Значение HOST_NAME** введите **adventure-works\pamela0**. Выберите **Готово**.  

    ![Страница "Значения HOST_NAME"](media/tutorial-replicating-data-with-mobile-clients/hostname.png)
  
11. Выберите **Готово** еще раз. После создания подписки нажмите кнопку **Закрыть**.  

### <a name="set-server-permissions-at-the-subscriber"></a>Задание разрешений сервера на подписчике  
  
1. Подключитесь к подписчику в [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]. Разверните узел **Безопасность**, щелкните правой кнопкой мыши **Имена для входа**, а затем выберите команду **Создать имя для входа**.  
  
   На странице **Общие** выберите **Поиск**, введите <*имя_компьютера_подписчика*> **\repl_merge** в поле **Введите имя объекта**. Выберите команду **Проверить имена** и нажмите кнопку **ОК**. 
    
   ![Выбор для задания имени для входа](media/tutorial-replicating-data-with-mobile-clients/sublogin.png)
  
1. На странице **Сопоставление пользователей** выберите базу данных **SalesOrdersReplica** и роль **db_owner**. На странице **Защищаемые объекты** предоставьте разрешение **Явное** для элемента **Изменение трассировки**. Щелкните **ОК**.

   ![Страницы "Сопоставление пользователей" и "Защищаемые объекты"](media/tutorial-replicating-data-with-mobile-clients/setdbo.png)
  
### <a name="create-the-filtered-data-snapshot-for-the-subscription"></a>Создание моментального снимка отфильтрованных данных подписки  
  
1. Подключитесь к издателю в среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], а затем разверните узел сервера и папку **Репликация**.  
  
2. В папке **Локальные публикации** щелкните правой кнопкой мыши публикацию **AdvWorksSalesOrdersMerge** и выберите пункт **Свойства**.  
   
   а. Выберите страницу **Секции данных** и нажмите кнопку **Добавить**.   
   b. В диалоговом окне **Добавление секции данных** введите значение **adventure-works\pamela0** в поле **Значение HOST_NAME** и нажмите кнопку **ОК**.  
   c. Выберите добавленную секцию, выберите команду **Создать выбранные моментальные снимки** и нажмите кнопку **ОК**. 

   ![Выбранные элементы для добавления секции](media/tutorial-replicating-data-with-mobile-clients/partition.png)
  
  
Дополнительные сведения см. в разделе:  
- [Подписка на публикации](../../relational-databases/replication/subscribe-to-publications.md)  
- [Создание подписки по запросу](../../relational-databases/replication/create-a-pull-subscription.md)  
- [Моментальные снимки для публикаций слиянием с параметризованными фильтрами](../../relational-databases/replication/create-a-snapshot-for-a-merge-publication-with-parameterized-filters.md)  

## <a name="synchronize-the-subscription-to-the-merge-publication"></a>Синхронизация подписки на публикацию слиянием

В этом разделе будет запущен агент слияния для инициализации подписки с помощью среды [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]. Эта процедура также используется для синхронизации с издателем.   
  
### <a name="start-synchronization-and-initialize-the-subscription"></a>Запуск синхронизации и инициализация подписки  
  
1. Подключитесь к подписчику в [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].  
2. Убедитесь, что агент SQL Server запущен. Если это не так, щелкните правой кнопкой мыши "Агент SQL Server" в обозревателе объектов и выберите команду **Запустить**. Если агент не запускается, это необходимо сделать вручную с помощью диспетчера конфигурации SQL Server. 
  
2. Разверните узел **Репликация**. В папке **Локальные подписки** щелкните правой кнопкой мыши подписку в базе данных **SalesOrdersReplica** и выберите пункт **Просмотр состояния синхронизации**.  
  
   Нажмите кнопку **Запустить**, чтобы инициализировать подписку. 

   ![Состояние синхронизации с кнопкой "Запустить"](media/tutorial-replicating-data-with-mobile-clients/mergesyncstatus.png)
    
  
  
## <a name="next-steps"></a>Дальнейшие действия  
Вы настроили издатель и подписчик для репликации слиянием. Кроме того, вы можете сделать следующее:

1. вставить, обновить или удалить данные в таблице **SalesOrderHeader** или **SalesOrderDetail** на издателе или подписчике;
2. повторить эту процедуру, когда будет доступно сетевое соединение, для синхронизации данных между издателем и подписчиком;
3. запросить таблицу **SalesOrderHeader** или **SalesOrderDetail** на другом сервере для просмотра реплицированных изменений.  
  
Дополнительные сведения см. в разделе:   
- [Инициализация подписки с помощью моментального снимка](../../relational-databases/replication/initialize-a-subscription-with-a-snapshot.md)  
- [Синхронизация данных](../../relational-databases/replication/synchronize-data.md)  
- [Синхронизация подписки по запросу](../../relational-databases/replication/synchronize-a-pull-subscription.md)  
  
  
  
