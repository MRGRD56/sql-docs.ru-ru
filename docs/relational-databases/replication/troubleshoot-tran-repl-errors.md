---
title: Поиск ошибок в репликации транзакций
description: Здесь описывается, как найти и распознать ошибки репликации транзакций, а также методы устранения неполадок для решения проблем с репликацией.
ms.custom: seo-lt-2019
ms.date: 07/01/2020
ms.prod: sql
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- replication [SQL Server], tutorials
author: MashaMSFT
ms.author: mathoma
monikerRange: =azuresqldb-mi-current||>=sql-server-2016
ms.openlocfilehash: 62e047a11d62e8c634f0188746a0f901ab26efdc
ms.sourcegitcommit: 1a544cf4dd2720b124c3697d1e62ae7741db757c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2020
ms.locfileid: "97406524"
---
# <a name="troubleshooter-find-errors-with-sql-server-transactional-replication"></a>Средство устранения неполадок: поиск ошибок, связанных с репликацией транзакций SQL Server 
[!INCLUDE [SQL Server SQL MI](../../includes/applies-to-version/sql-asdbmi.md)]

Без понимания того, как работает репликация транзакций, устранение ее ошибок может быть затруднительным. Первым шагом при создании публикации является создание моментального снимка агентом моментальных снимков и его сохранение в папке моментальных снимков. Затем агент распространения применяет моментальный снимок к подписчику. 

В результате этой процедуры публикация создается и переводится в состояние *синхронизации*. Синхронизация осуществляется в три этапа.
1. Транзакции происходят в реплицируемых объектах и помечаются для репликации в журнале транзакций. 
2. Агент чтения журнала просматривает журнал транзакций в поиске транзакций, которые помечены "для репликации". Затем эти транзакции сохраняются в базе данных распространителя. 
3. Агент распространения просматривает базу данных распространителя с помощью потока чтения. Затем с помощью потока записи этот агент подключается к подписчику, чтобы применить к нему изменения.

Ошибки могут возникать на любом этапе этого процесса. Выявление ошибок может быть наиболее сложным аспектом устранения неполадок, возникающих при синхронизации. К счастью, монитор репликации упрощает данный процесс. 

>[!NOTE]
> - Цель этого руководства — научить методам устранения неполадок. Оно призвано не помочь в устранении конкретных ошибок, а предоставить общие указания по выявлению ошибок репликации. В нем приводится ряд конкретных примеров, но их решение может отличаться в зависимости от среды. 
> - Ошибки, приведенные в этом руководстве в качестве примера, основаны на учебнике [Настройка репликации транзакций](../../relational-databases/replication/tutorial-replicating-data-between-continuously-connected-servers.md).



## <a name="troubleshooting-methodology"></a>Методы устранения неполадок 

### <a name="questions-to-ask"></a>Вопросы, на которые нужно ответить
1. На каком этапе синхронизации происходит сбой репликации?
2. В каком агенте возникает ошибка?
1. Когда в последний раз репликация завершилась успешно? Изменилось ли что-нибудь с того момента?  

### <a name="steps-to-take"></a>Действия для выполнения
1. С помощью монитора репликации определите, на каком этапе репликации происходит ошибка (в каком агенте).
   - Если ошибки возникают в разделе **От издателя к распространителю**, проблема связана с агентом чтения журнала. 
   - Если ошибки возникают в разделе **От распространителя к подписчику**, проблема связана с агентом распространения.  
2. Чтобы получить подробные сведения об ошибке, просмотрите журнал заданий соответствующего агента в мониторе активности заданий. Если сведений в журнале заданий недостаточно, можно [включить подробное ведение журнала](#enable-verbose-logging-on-any-agent) для агента.
3. Попробуйте определить решение проблемы.


## <a name="find-errors-with-the-snapshot-agent"></a>Поиск ошибок с помощью агента моментальных снимков
Агент моментальных снимков создает моментальный снимок и записывает его в указанную папку. 

1. Просмотрите состояние агента моментальных снимков.

    а. В обозревателе объектов разверните узел **Локальная публикация** в разделе **Репликация**.

    b. Щелкните публикацию правой кнопкой мыши и выберите пункт **AdvWorksProductTrans** > **Просмотр состояния агента моментальных снимков**. 

    ![Команда "Просмотр состояния агента моментальных снимков" в контекстном меню](media/troubleshooting-tran-repl-errors/view-snapshot-agent-status.png)

1. Если в состоянии агента моментальных снимков присутствует сообщение об ошибке, дополнительные сведения можно найти в журнале заданий агента моментальных снимков.

    а. В обозревателе объектов разверните узел **Агент SQL Server** и откройте элемент "Монитор активности заданий". 

    b. Выполните сортировку по **категории** и определите агент моментальных снимков по категории **REPL: моментальный снимок**.

    c. Щелкните правой кнопкой мыши элемент "Агент моментальных снимков" и выберите пункт **Просмотреть журнал**. 

   ![Выбор для открытия журнала агента моментальных снимков](media/troubleshooting-tran-repl-errors/snapshot-agent-history.png)
    
1. В журнале агента моментальных снимков выберите соответствующую запись журнала. Как правило, она находится за одну или две строки *до* записи с сообщением об ошибке. (Ошибки обозначаются красным значком X.) Ознакомьтесь с текстом сообщения в поле, расположенном под журналами: 

    ![Ошибка отказа в доступе к агенту моментальных снимков](media/troubleshooting-tran-repl-errors/snapshot-access-denied.png)

    ```console
    The replication agent had encountered an exception.
    Exception Message: Access to path '\\node1\repldata.....' is denied.
    ```

Если в Windows неправильно настроены разрешения для папки моментальных снимков, для агента моментальных снимков будет отображаться ошибка "Доступ запрещен". Проверьте разрешения на доступ к папке, где хранится моментальный снимок, и убедитесь в том, что у учетной записи, с которой работает агент моментальных снимков, есть разрешения на доступ к общей папке.  

## <a name="find-errors-with-the-log-reader-agent"></a>Поиск ошибок, связанных с агентом чтения журнала
Агент чтения журнала подключается к базе данных издателя и просматривает журнал транзакций в поиске транзакций, которые помечены "для репликации". После этого агент добавляет эти транзакции в базу данных распространителя. 

1.  Подключитесь к издателю в [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]. Разверните узел сервера, щелкните правой кнопкой мыши папку **Репликация** и выберите пункт **Запустить монитор репликации**:  

    ![Команда "Запустить монитор репликации" в контекстном меню](media/troubleshooting-tran-repl-errors/launch-repl-monitor.png)
  
    Откроется монитор репликации: ![Монитор репликации](media/troubleshooting-tran-repl-errors/repl-monitor.png) 
   
2. Красный значок X указывает на то, что публикация не синхронизируется. Разверните узел **Мои издатели** в левой части экрана, а затем разверните соответствующий сервер издателя.  
  
3.  Выберите публикацию **AdvWorksProductTrans** слева и проверьте наличие красного значка X на одной из вкладок, чтобы определить место возникновения проблемы. В этом случае красный значок X находится на вкладке **Агенты**, что свидетельствует об ошибке одного из агентов: 

    ![Красный значок X на вкладке "Агенты"](media/troubleshooting-tran-repl-errors/agent-error.png)

4. Перейдите на вкладку **Агенты**, чтобы определить, какой агент является источником ошибки: 

    ![Красный значок X на агенте чтения журнала с ошибкой](media/troubleshooting-tran-repl-errors/log-reader-agent-failure.png)


5. В этом представлении показаны два агента: агент моментальных снимков и агент чтения журнала. Агент с ошибкой помечен красным значком X. В этом случае это агент чтения журнала. 

    Дважды щелкните строку с сообщением об ошибке, чтобы открыть журнал агента для агента чтения журнала. В нем будут представлены более подробные сведения об ошибке: 
    
    ![Сведения об ошибке для агента чтения журнала](media/troubleshooting-tran-repl-errors/log-reader-error.png)

    ```console
    Status: 0, code: 20011, text: 'The process could not execute 'sp_replcmds' on 'NODE1\SQL2016'.'.
    The process could not execute 'sp_replcmds' on 'NODE1\SQL2016'.
    Status: 0, code: 15517, text: 'Cannot execute as the database principal because the principal "dbo" does not exist, this type of principal cannot be impersonated, or you do not have permission.'.
    Status: 0, code: 22037, text: 'The process could not execute 'sp_replcmds' on 'NODE1\SQL2016'.'.        
    ```

6. Эта ошибка обычно возникает при неправильной настройке владельца для базы данных издателя. Это может происходить при восстановлении базы данных. Чтобы проверить, так ли это, выполните указанные ниже действия.

    а. В обозревателе объектов разверните узел **Базы данных**.

    b. Щелкните правой кнопкой мыши **AdventureWorks2012** > **Свойства**. 

    c. На странице **Файлы** проверьте наличие владельца. Если это поле пусто, скорее всего это и есть причина проблемы. 

   ![Страница "Файлы" в окне свойств базы данных с пустым полем "Владелец"](media/troubleshooting-tran-repl-errors/db-properties.png)

7. Если поле владельца на странице **Файлы** пусто, откройте **Новое окно запроса** в контексте базы данных AdventureWorks2012. Выполните следующий код T-SQL:

    ```sql
    -- set the owner of the database to 'sa' or a specific user account, without the brackets. 
    EXECUTE sp_changedbowner '<useraccount>'
    -- example for sa: exec sp_changedbowner 'sa'
    -- example for user account: exec sp_changedbowner 'sqlrepro\administrator' 
    ```

8. Может потребоваться перезапустить агент чтения журнала.

    а. Разверните узел **Агент SQL Server** в обозревателе объектов и откройте монитор активности заданий.

    b. Выполните сортировку по **категории** и определите агент чтения журнала по категории **REPL: агент чтения журнала**. 

    c. Щелкните правой кнопкой мыши задание **Агент чтения журнала** и выберите пункт **Запустить задание на шаге**. 

    ![Команда для перезапуска агента чтения журнала](media/troubleshooting-tran-repl-errors/start-job-at-step.png)

9. Проверьте синхронизацию публикации, повторно открыв монитор репликации. Если он еще не открыт, его можно найти, щелкнув правой кнопкой мыши элемент **Репликация** в обозревателе объектов. 
10. Выберите публикацию **AdvWorksProductTrans**, перейдите на вкладку **Агенты** и дважды щелкните агент чтения журнала, чтобы открыть журнал агента. Вы должны увидеть, что агент чтения журнала запущен и выполняет репликацию команд или не имеет реплицируемых транзакций.

    ![Агент чтения журнала без реплицируемых транзакций](media/troubleshooting-tran-repl-errors/log-reader-running.png)

## <a name="find-errors-with-the-distribution-agent"></a>Поиск ошибок, связанных с агентом распространения
Агент распространения находит данные в базе данных распространителя и применяет их к подписчику. 

1. Подключитесь к издателю в [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]. Разверните узел сервера, щелкните правой кнопкой мыши папку **Репликация** и выберите пункт **Запустить монитор репликации**.  
2. В окне **Монитор репликации** выберите публикацию **AdvWorksProductTrans** и перейдите на вкладку **Все подписчики**. Щелкните подписку правой кнопкой мыши и выберите пункт **Просмотреть подробности**:

    ![Команда "Просмотреть подробности" в контекстном меню](media/troubleshooting-tran-repl-errors/view-details.png)

2. Откроется диалоговое окно журнала **От распространителя к подписчику**, в котором будут приведены подробные сведения о возникшей с агентом ошибке: 

     ![Сведения об ошибке для агента распространения](media/troubleshooting-tran-repl-errors/dist-history-error.png)

    ```console
    Error messages:
    Agent 'NODE1\SQL2016-AdventureWorks2012-AdvWorksProductTrans-NODE2\SQL2016-7' is retrying after an error. 89 retries attempted. See agent job history in the Jobs folder for more details.
    ```

3. Эта ошибка указывает, что агент распространения выполняет повторную попытку. Дополнительные сведения см. в журнале заданий для агента распространения. 

    а. В обозревателе объектов разверните узел **Агент SQL Server** и откройте элемент **Монитор активности заданий**. 
    
    b. Выполните сортировку заданий по **категории**. 

    c. Определите агент распространения по категории **REPL: распространение**. Щелкните агент правой кнопкой мыши и выберите пункт **Просмотреть журнал**.

    ![Команда для просмотра журнала агента распространения](media/troubleshooting-tran-repl-errors/view-dist-agent-history.png)

5. Выберите одну из записей ошибок и просмотрите текст ошибки в нижней части окна:  

    ![Текст ошибки, в котором сообщается о неправильном пароле для агента распространения](media/troubleshooting-tran-repl-errors/dist-pw-wrong.png)

    ```console
    Message:
    Unable to start execution of step 2 (reason: Error authenticating proxy NODE1\repl_distribution, system error: The user name or password is incorrect.)
    ```

6. Эта ошибка указывает на то, что агент распространения использует неверный пароль. Чтобы устранить ошибку, выполните указанные ниже действия.

    а. В обозревателе объектов разверните узел **Репликация**.
    
    b. Щелкните подписку правой кнопкой мыши и выберите пункт **Свойства**.
    
    c. Нажмите кнопку с многоточием (...) рядом с элементом **Учетная запись процесса агента** и измените пароль.

    ![Выбор для изменения пароля агента распространения](media/troubleshooting-tran-repl-errors/dist-agent-pw-change.png)

7. Снова проверьте монитор репликации, щелкнув правой кнопкой мыши элемент **Репликация** в обозревателе объектов. Красный значок X рядом с элементом **Все подписки** указывает, что ошибка агента распространения по-прежнему не устранена. 

    Откройте журнал **От распространителя к подписчику**, для чего выберите **Монитор репликации** > **Просмотреть подробности** и щелкните подписку правой кнопкой мыши. В этом случае ошибка будет несколько иной: 

    ![Ошибка, которая указывает, что агенту распространения не удается подключиться](media/troubleshooting-tran-repl-errors/dist-agent-cant-connect.png)

    ```console
    Connecting to Subscriber 'NODE2\SQL2016'        
    Agent message code 20084. The process could not connect to Subscriber 'NODE2\SQL2016'.
    Number:  18456
    Message: Login failed for user 'NODE2\repl_distribution'.
    ```

8. Эта ошибка указывает, что агенту распространения не удалось подключиться к подписчику из-за ошибки входа для пользователя **NODE2\repl_distribution**. Чтобы более детально проанализировать причины ошибки, подключитесь к подписчику и откройте *текущий* журнал ошибок SQL Server в узле **Управление** в обозревателе объектов. 

    ![Ошибка, которая указывает, что подписчику не удалось выполнить вход](media/troubleshooting-tran-repl-errors/login-failed.png)
    
    Если отображается эта ошибка, значит, в подписчике не было предоставлено имя для входа. Сведения об устранении этой ошибки см. в разделе [Разрешения для репликации](../../relational-databases/replication/security/security-role-requirements-for-replication.md).

9. После устранения ошибки со входом снова проверьте монитор репликации. Если все ошибки устранены, рядом с **именем публикации** появится зеленая стрелка, а также будет показано состояние **Выполняется** в разделе **Все подписки**. 

    Щелкните подписку правой кнопкой мыши, чтобы открыть журнал **От распространителя к подписчику** еще раз и проверить успешность выполненных действий. Если агент распространения запущен впервые, вы увидите, что было выполнено массовое копирование моментального снимка в подписчик. 

     ![Агент распространения с состоянием "Выполняется" и сообщением о массовом копировании](media/troubleshooting-tran-repl-errors/dist-agent-success.png)   


## <a name="enable-verbose-logging-on-any-agent"></a>Включение подробного ведения журнала для любого агента
Для просмотра более подробных сведений об ошибках, происходящих с любым агентом в топологии репликации, можно использовать подробное ведение журнала. Действия для всех агентов одинаковы. Просто выберите соответствующий агент в мониторе активности заданий. 

   >[!NOTE]   
   > Агенты могут находиться в издателе или подписчике в зависимости от того, является ли подписка принудительной или подпиской по запросу. Если на сервере не удается найти нужный агент, попробуйте проверить другой сервер.  

1. Решите, где необходимо сохранять данные подробного ведения журнала. Эта папка должна существовать. В этом примере используется папка c:\temp. 
2. Разверните узел **Агент SQL Server** в обозревателе объектов и откройте монитор активности заданий. 

    ![Пункт "Просмотр активности заданий" в контекстном меню монитора активности заданий](media/troubleshooting-tran-repl-errors/job-activity-monitor.png)    

1. Выполните сортировку по **категории** и определите нужный агент. В этом примере используется агент чтения журнала. Щелкните нужный агент правой кнопкой мыши и выберите пункт **Свойства**.

    ![Выбор для открытия свойств агента](media/troubleshooting-tran-repl-errors/log-agent-properties.png)

1. Перейдите на страницу **Шаги** и выделите шаг **Запуск агента**. Выберите команду **Изменить**. 

    ![Выбор для изменения шага "Запуск агента"](media/troubleshooting-tran-repl-errors/edit-steps.png)

1. В поле **Команда** начните новую строку, введите следующий текст и нажмите кнопку **ОК**: 

    ```console
    -Output C:\Temp\OUTPUTFILE.txt -Outputverboselevel 3
    ```

    Расположение и уровень детализации можно изменить в соответствии с конкретными предпочтениями.

    ![Подробные выходные данные в свойствах шага задания](media/troubleshooting-tran-repl-errors/verbose.png)

   > [!NOTE]
   > Указанные ниже проблемы могут привести к сбою агента или отсутствию выходного файла при добавлении параметра подробных выходных данных.
   > - Существует проблема с форматированием, из-за которой тире становится дефисом. 
   > - Папка отсутствует на диске, или у учетной записи, с которой выполняется агент, нет разрешения на запись в указанную папку. 
   > - Между последним параметром и параметром `-Output` отсутствует пробел. 
   > - Разные агенты поддерживают разные уровни детализации. Если вы включили подробное ведение журнала, но агент не запускается, попробуйте снизить уровень детализации на 1. 

1. Перезапустите агент чтения журнала, щелкнув его правой кнопкой мыши и выбрав пункт **Остановить задание на шаге**. Обновите содержимое окна, щелкнув значок **Обновить** на панели инструментов. Щелкните агент правой кнопкой мыши и выберите команду **Запустить задание на шаге**.
2. Просмотрите выходные данные на диске. 

    ![Выходной текстовый файл](media/troubleshooting-tran-repl-errors/output.png)

    
1. Чтобы отключить подробное ведение журнала, выполните описанные выше действия, полностью удалив ранее добавленную строку `-Output`. 

Дополнительные сведения см. в статье [Включение подробного ведения журнала для агентов репликации](https://support.microsoft.com/help/312292/how-to-enable-replication-agents-for-logging-to-output-files-in-sql-se). 


## <a name="see-also"></a>См. также раздел
<br>[Обзор репликации транзакций](../../relational-databases/replication/transactional/transactional-replication.md)
<br>[Учебники по репликации](../../relational-databases/replication/replication-tutorials.md)
<br>[Блог ReplTalk](https://blogs.msdn.microsoft.com/repltalk)

[!INCLUDE[get-help-options](../../includes/paragraph-content/get-help-options.md)]

