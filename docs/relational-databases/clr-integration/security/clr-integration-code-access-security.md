---
title: Безопасность доступа к коду для интеграции со средой CLR | Документация Майкрософт
description: Для SQL Server интеграции со средой CLR среда CLR поддерживает управление доступом для кода для управляемого кода, где разрешения предоставляются сборкам на основе удостоверения кода.
ms.custom: ''
ms.date: 03/17/2017
ms.prod: sql
ms.reviewer: ''
ms.technology: clr
ms.topic: reference
helpviewer_keywords:
- UNSAFE assemblies
- permissions [CLR integration]
- common language runtime [SQL Server], security
- SAFE assemblies
- code access security [CLR integration]
- EXTERNAL_ACCESS assemblies
ms.assetid: 2111cfe0-d5e0-43b1-93c3-e994ac0e9729
author: rothja
ms.author: jroth
ms.openlocfilehash: a241bc50502099cfd2b2a27ffe86a16b035b440e
ms.sourcegitcommit: 708b3131db2e542b1d461d17dec30d673fd5f0fd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/19/2021
ms.locfileid: "107729180"
---
# <a name="clr-integration-code-access-security"></a>Управление доступом для кода на основе интеграции со средой CLR
[!INCLUDE [SQL Server](../../../includes/applies-to-version/sqlserver.md)]
  Среда CLR поддерживает модель безопасности, называемую управлением доступом для кода. В этой модели разрешения предоставляются сборкам на основе идентификатора кода. Дополнительные сведения см. в разделе «Управление доступом для кода» справочной документации пакета средств разработки программного обеспечения .NET Framework.  
  
 Политика безопасности, которая регламентирует разрешения, предоставляемые сборкам, определяется в трех разных местах.  
  
-   Политика компьютера: Эта политика действует для всего управляемого кода, выполняемого на компьютере, на котором [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] установлен.  
  
-   Политика пользователя. это политика, действующая для управляемого кода, размещенного в процессе. Для [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] применяемая политика пользователя зависит от учетной записи Windows, от имени которой работает служба [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].  
  
-   Политика узла. Эта политика настраивается узлом среды CLR (в данном случае [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] ), которая действует для управляемого кода, выполняемого на этом узле.  
  
 Механизм управления доступом к коду, поддерживаемый средой CLR, основан на предположении, что в среде времени выполнения может размещаться код, доверенный полностью или частично. Ресурсы, защищаемые механизмом защиты доступа к коду платформы .NET Framework, обычно окружены оболочкой API-интерфейсов управляемого кода, которые предоставляют доступ к ресурсу только после получения соответствующего разрешения. Требование разрешения удовлетворяется только в том случае, если все вызывающие элементы (на уровне сборки) в стеке вызовов обладают соответствующими ресурсными разрешениями.  
  
 Набор разрешений CAS, которые предоставляются управляемому коду при его выполнении в [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], является пересечением наборов разрешений, предоставляемых на трех указанных уровнях политики. Даже если [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] предоставляет ряд разрешений сборке, загруженной в [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], в конечном итоге набор разрешений, которые предоставлены пользовательскому коду, может быть подвергнут дальнейшему сокращению с учетом политик, заданных на уровне пользователя и компьютера.  
  
## <a name="sql-server-host-policy-level-permission-sets"></a>Наборы разрешений на уровне политики узла SQL Server  
 Набор разрешений CAS, который предоставляется определяемым пользователем сборкам на уровне политики узла [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], определяется набором разрешений, заданным при создании сборки. Существует три набора разрешений: " **Сейф**", " **EXTERNAL_ACCESS** " и " **ненадежный** " (задается с помощью параметра **PERMISSION_SET** [создания сборки &#40;Transact-SQL&#41;](../../../t-sql/statements/create-assembly-transact-sql.md)).  
  
 Среде CLR, размещенной в [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], предоставляется уровень политики безопасности на уровне сервера; данная политика представляет собой дополнительный уровень политики, расположенный ниже двух всегда действующих уровней политики. Данная политика задается для каждого домена приложений, создаваемого службами [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Эта политика не предназначена для домена приложения по умолчанию, который применяется при создании в [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляра среды CLR.  
  
 Политика на уровне узла служб [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] является сочетанием фиксированной политики служб [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] для системных сборок и пользовательской политики для пользовательских сборок.  
  
 Фиксированная политика для сборок CLR и системных сборок [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] предоставляет этим сборкам полное доверие.  
  
 В основе пользовательской части политики сервера [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] лежит указание владельцем сборки одного из трех сегментов разрешений для каждой сборки. Дополнительные сведения о правах доступа, перечисленных ниже, см. в документации пакета SDK для платформы .NET Framework.  
  
### <a name="safe"></a>SAFE  
 Разрешаются только внутренние вычисления и локальный доступ к данным. " **Надежный** " является наиболее узким набором разрешений. Код, выполняемый сборкой с **безнадежными** разрешениями, не может получить доступ к внешним системным ресурсам, таким как файлы, сеть, переменные среды или реестр.  
  
 Сборки **безопасности** имеют следующие разрешения и значения.  
  
|Разрешение|Значения и описание|  
|----------------|-----------------------------|  
|**Сутствовать**|**Выполнение:** Разрешение на выполнение управляемого кода.|  
|**SqlClientPermission**|**Контекстное соединение = true**, **контекстное соединение = Yes**: можно использовать только контекстное соединение, а в строке подключения можно указать только значение "context connection = true" или "Context Connection = Yes".<br /><br /> **Алловбланкпассворд = false:**  Пустые пароли не допускаются.|  
  
### <a name="external_access"></a>EXTERNAL_ACCESS  
 Сборки EXTERNAL_ACCESS имеют те же разрешения, что и **Надежные** сборки, с дополнительной возможностью доступа к внешним системным ресурсам, таким как файлы, сети, переменные среды и реестр.  
  
 **EXTERNAL_ACCESS** сборки также имеют следующие разрешения и значения:  
  
|Разрешение|Значения и описание|  
|----------------|-----------------------------|  
|**DistributedTransactionPermission**|Без **ограничений:** Распределенные транзакции разрешены.|  
|**днспермиссион**|Без **ограничений:** Разрешение на запрос сведений с серверов доменных имен.|  
|**енвиронментпермиссион**|Без **ограничений:** Допускается полный доступ к системным и пользовательским переменным среды.|  
|**EventLogPermission**|**Администрирование:** Разрешены следующие действия: создание источника событий, чтение существующих журналов, удаление источников событий или журналов, реагирование на записи, очистка журнала событий, прослушивание событий и доступ к коллекции всех журналов событий.|  
|**FileIOPermission**|Без **ограничений:** Разрешен полный доступ к файлам и папкам.|  
|**KeyContainerPermission**|Без **ограничений:** Разрешен полный доступ к контейнерам ключей.|  
|**нетворкинформатионпермиссион**|**Доступ:** Разрешена проверка связи.|  
|**RegistryPermission**|Разрешает права на чтение для **HKEY_CLASSES_ROOT**, **HKEY_LOCAL_MACHINE**, **HKEY_CURRENT_USER**, **HKEY_CURRENT_CONFIG** и **HKEY_USERS.**|  
|**Сутствовать**|**Утверждение:** Возможность утверждать, что все вызывающие объекты этого кода имеют необходимое разрешение для операции.<br /><br /> **КонтролпринЦипал:** Возможность управлять объектом Principal.<br /><br /> **Выполнение:** Разрешение на выполнение управляемого кода.<br /><br /> **SerializationFormatter:** Возможность предоставления служб сериализации.|  
|**смтппермиссион**|**Доступ:** Исходящие подключения к порту узла SMTP 25 разрешены.|  
|**SocketPermission**|**Подключение:** Разрешены исходящие подключения (все порты, все протоколы) на транспортном адресе.|  
|**SqlClientPermission**|Без **ограничений:** Разрешен полный доступ к источнику данных.|  
|**сторепермиссион**|Без **ограничений:** Разрешен полный доступ к хранилищам сертификатов X. 509.|  
|**WebPermission**|**Подключение:** Исходящие подключения к веб-ресурсам разрешены.|  
  
### <a name="unsafe"></a>UNSAFE  
 Набор UNSAFE предоставляет сборкам неограниченный доступ к внутренним и внешним ресурсам [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Код, который исполняется из **НЕнадежной** сборки, может также вызывать неуправляемый код.  
  
 **Ненадежные** сборки получают **FullTrust**.  
  
## <a name="recommended-permission-settings"></a>Рекомендуемые параметры разрешений

**Безопасность** — это рекомендуемый параметр разрешений для сборок, выполняющих задачи вычисления и управления данными без доступа к ресурсам вне [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . 

**EXTERNAL_ACCESS** рекомендуется использовать для сборок, обращающихся к ресурсам за пределами [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . **EXTERNAL_ACCESS** сборки по умолчанию выполняются в качестве [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] учетной записи службы. Код **EXTERNAL_ACCESS** может явно олицетворять контекст безопасности проверки подлинности Windows вызывающего объекта. Так как по умолчанию выполняется [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] учетная запись службы, разрешение на выполнение **EXTERNAL_ACCESS** должно предоставляться только именам входа, доверенным для запуска от имени учетной записи службы. 

С точки зрения безопасности **EXTERNAL_ACCESS** и **ненадежные** сборки идентичны. Однако **EXTERNAL_ACCESS** сборки предоставляют различные средства защиты и надежности, которые не находятся в **ненадежных** сборках. 

Указание **unsafe** позволяет коду в сборке выполнять недопустимые операции в [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] пространстве процесса и, следовательно, может повредить надежность и масштабируемость [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . Дополнительные сведения о создании сборок среды CLR в см [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . в разделе [Управление сборками интеграции со средой CLR](../../../relational-databases/clr-integration/assemblies/managing-clr-integration-assemblies.md).  

> [!IMPORTANT]
> [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] содержит сборки CLR, используемые ядром СУБД для предоставления определенных функциональных возможностей. `Microsoft.SQLServer.Types`Сборка, включенная в SQL Server установки, отображается в метаданных как **ненадежная** сборка. Это сделано намеренно. Эти сборки считаются надежными & безопасными по умолчанию.
  
## <a name="accessing-external-resources"></a>Доступ к внешним ресурсам  
 Если определяемый пользователем тип (UDT), хранимая процедура или сборка другого типа регистрируются в наборе разрешений " **Надежные** ", управляемый код, который выполняется в конструкции, не сможет получить доступ к внешним ресурсам. Однако если заданы **EXTERNAL_ACCESS** или **ненадежные** наборы разрешений, а управляемый код пытается получить доступ к внешним ресурсам, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] применяет следующие правила.  
  
|If|Следующее действие|  
|--------|----------|  
|Контекст выполнения соответствует имени входа [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].|Попытки получить доступ к внешним ресурсам отклоняются, и активизируется исключение безопасности.|  
|Контекст выполнения соответствует имени входа Windows, и контекстом выполнения является первоначальный вызывающий объект.|Доступ к внешнему ресурсу предоставляется в контексте безопасности учетной записи [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].|  
|Вызывающий объект не является первоначальным вызывающим объектом.|Доступ запрещается, и активизируется исключение безопасности.|  
|Контекст выполнения соответствует имени входа Windows, контекст выполнения является исходным вызывающим объектом, а к вызывающему объекту применяется олицетворение.|При доступе используется контекст безопасности вызывающего объекта, а не учетная запись службы.|  
  
## <a name="permission-set-summary"></a>Сводные данные о наборе разрешений  
 На следующей диаграмме приведены ограничения и разрешения, предоставленные **защищенным**, **EXTERNAL_ACCESSным** и **ненадежным** наборам разрешений.  
  
|Функциональность|**ПОТОКОБЕЗОПАСНОЙ**|**EXTERNAL_ACCESS**|**UNSAFE**|   
|-|-|-|-|  
|Разрешения управления доступом для кода|Только выполнение|Выполнение и доступ к внешним ресурсам|Неограниченное (включая P/Invoke)|  
|Ограничения модели программирования|Да|Да|Нет ограничений|  
|Требование к проверяемости|Да|Да|Нет|  
|Доступ к локальным данным|Да|Да|Да|  
|Возможность вызова машинного кода|Нет|Нет|Да|  
  
## <a name="see-also"></a>См. также:  
 [Безопасность интеграции со средой CLR](../../../relational-databases/clr-integration/security/clr-integration-security.md)   
 [Атрибуты защиты узла и программирование интеграции со средой CLR](../../../relational-databases/clr-integration-security-host-protection-attributes/host-protection-attributes-and-clr-integration-programming.md)   
 [Ограничения модели программирования интеграции со средой CLR](../../../relational-databases/clr-integration/database-objects/clr-integration-programming-model-restrictions.md)   
 [Среда размещения CLR](../../../relational-databases/clr-integration/clr-integration-architecture-clr-hosted-environment.md)  
  
  
