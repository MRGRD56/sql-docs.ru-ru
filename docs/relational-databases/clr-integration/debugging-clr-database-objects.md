---
title: Отладка объектов базы данных среды CLR
description: SQL Server обеспечивает поддержку отладки объектов Transact-SQL и CLR в базе данных интеграция SQL Server отладчик с Microsoft Visual Studio отладчиком.
ms.date: 10/06/2020
ms.prod: sql
ms.reviewer: ''
ms.technology: clr
ms.topic: how-to
helpviewer_keywords:
- database objects [CLR integration], debugging
- permissions [CLR integration]
- debugging [CLR integration]
- building database objects [CLR integration], debugging
- common language runtime [SQL Server], debugging
ms.assetid: 1332035c-d6ed-424d-8234-46ad21168319
author: rothja
ms.author: jroth
ms.openlocfilehash: 1be293f98a3b78280b16f80ab7dcfcb656f7e0ec
ms.sourcegitcommit: cfa04a73b26312bf18d8f6296891679166e2754d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/19/2020
ms.locfileid: "92196921"
---
# <a name="how-to-debug-clr-database-objects"></a>Отладка объектов базы данных CLR

[!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]
 
В [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] предоставляется поддержка отладки объектов [!INCLUDE[tsql](../../includes/tsql-md.md)] и среды CLR в базе данных. Ключевыми особенностями отладки в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] стали простота установки и использования, а также интеграция отладчика SQL Server с отладчиком Microsoft Visual Studio. Более того, процесс отладки охватывает код на всех применяемых языках: пользователи могут беспрепятственно переходить к коду объектов среды CLR из кода [!INCLUDE[tsql](../../includes/tsql-md.md)] и наоборот. Отладчик Transact-SQL в среде SQL Server Management Studio нельзя использовать для отладки управляемых объектов базы данных, но эти объекты можно отлаживать с помощью отладчиков, входящих в состав среды Visual Studio. Отладка управляемого объекта базы данных в Visual Studio поддерживает все обычные средства отладки, такие как шаг с входом и шаг с выходом в процедурах, выполняющихся на сервере. Отладчики могут задавать точки останова, просматривать стек вызова, проверять значения переменных и изменять значения переменных во время отладки. 

> [!NOTE]
> Visual Studio .NET 2003 нельзя использовать для программирования или отладки интеграции со средой CLR. В состав [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] входит предварительно установленная платформа .NET Framework, а Visual Studio .NET 2003 не может использовать сборки .NET Framework версии 2.0.  
  
## <a name="debugging-permissions-and-restrictions"></a>Отладка разрешений и ограничений

Отладка — это операция с высокой степенью привилегий, и поэтому в могут быть разрешены только члены предопределенной роли сервера **sysadmin** [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .  
  
При отладке применяются следующие ограничения.  
  
- При отладке процедур CLR можно использовать одновременно только один экземпляр отладчика. Это ограничение налагается в связи с тем, что при достижении точки останова выполнение всего кода CLR приостанавливается и возобновляется лишь после прохождения отладчиком этой точки останова. Однако отладку кода [!INCLUDE[tsql](../../includes/tsql-md.md)] можно продолжать в других соединениях. Хотя отладка кода [!INCLUDE[tsql](../../includes/tsql-md.md)] не приводит к приостановке выполнения другого кода на сервере, она может вызывать переход других соединений в состояние ожидания в результате блокировки.  
  
- Отладка может быть выполнена только для новых соединений, так как перед выполнением соединения [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] требуются сведения о среде клиента и отладчика.  
  
С учетом указанных ограничений рекомендуется отлаживать код [!INCLUDE[tsql](../../includes/tsql-md.md)] и CLR на тестовом, а не на рабочем сервере.  
  
## <a name="overview"></a>Обзор

Отладка в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] организована на основе модели с учетом соединений. Отладчик может обнаруживать и отлаживать действия только в том клиентском соединении, к которому он присоединен. Функциональные возможности отладчика не ограничиваются типом соединения, поэтому возможна отладка как соединений с потоком табличных данных (TDS), так и HTTP-соединений. Однако [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не позволяет выполнять отладку существующих соединений. Процесс отладки поддерживает общие функции отладки внутри процедур, выполняемых на сервере. Взаимодействие между отладчиком и сервером [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] происходит через модель DCOM.  
  
Дополнительные сведения и сценарии отладки управляемых хранимых процедур, функций, триггеров, определяемых пользователем типов и статистических выражений см. в разделе [SQL Server отладка базы данных интеграции со средой CLR](/previous-versions/ms165050(v=vs.100)) в документации по Visual Studio.  
  
Чтобы использовать Visual Studio для удаленной разработки, отладки и разработки, в экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] должен быть включен протокол TCP/IP. Дополнительные сведения о включении протокола TCP/IP на сервере см. в разделе [Настройка клиентских протоколов](../../database-engine/configure-windows/configure-client-protocols.md).  
  
## <a name="debugging-steps"></a>Отладка шагов

Чтобы выполнить отладку объекта базы данных CLR в Microsoft Visual Studio, выполните следующие действия.

1. Откройте Microsoft Visual Studio и создайте новый проект SQL Server. Можно использовать экземпляр SQL LocalDB, поставляемый с Visual Studio.

2. Создайте новый тип CLR SQL (C#):

   1. В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите **Добавить**, **новый элемент...**. 
   1. В окне **Добавление нового элемента** выберите **хранимая процедура SQL CLR C#**, **SQL CLR c# User-Defined функция**, **Тип User-Defined**SQL CLR, **триггер C#** SQL CLR, **статистическое выражение SQL CLR c#, агрегатное**значение или **класс**.
   1. Укажите имя исходного файла нового типа, а затем нажмите кнопку **Добавить**.

3. Добавьте в текстовый редактор код для нового типа. Пример кода для примера хранимой процедуры см. в следующем разделе этой статьи.

4. Добавьте скрипт, который проверяет тип: 

   1. В **Обозреватель решений**щелкните правой кнопкой мыши узел проекта и выберите **Добавить**, **создать скрипт...**. 
   1. В окне **Добавление нового элемента** выберите **скрипт (не в сборке)** и укажите имя, например `Test.sql` . Нажмите кнопку **Добавить**.
   1. В **Обозреватель решений**дважды щелкните `Test.sql` узел, чтобы открыть исходный файл скрипта теста по умолчанию.
   1. Добавьте в текстовый редактор скрипт теста (который вызывает код для отладки). Пример скрипта см. в примере в следующем разделе.

5. Поместите одну или несколько точек останова в исходный код. Щелкните правой кнопкой мыши строку кода в текстовом редакторе для функции или подпрограммы, которую требуется отладить. Выберите **точку останова**и **Вставьте точку останова**. Точка останова добавится, а строка кода будет выделена красным цветом.

6. В меню **Отладка** выберите команду **начать отладку** , чтобы скомпилировать, развернуть и протестировать проект. Тестовый скрипт в `Test.sql` выполняется, и вызывается управляемый объект базы данных.

7. Когда в точке останова появляется желтая стрелка (указатель на инструкцию), выполнение кода приостанавливается. Затем можно выполнить отладку управляемого объекта базы данных.

   1. Используйте **Шаг с обходом** в меню **Отладка** , чтобы переместить указатель инструкции на следующую строку кода.
   1. Окно **локальные** используется для отслеживания состояния объектов, выделенных указателем инструкций.
   1. Добавьте переменные в окно **Контрольные значения** . Состояние наблюдаемых переменных можно наблюдать в рамках сеанса отладки, даже если переменная не находится в строке кода, выделенной указателем инструкций. 
   1. Выберите пункт **продолжить** в меню **Отладка** , чтобы переместить указатель инструкции на следующую точку останова или завершить выполнение подпрограммы, если больше нет точек останова.
  
## <a name="example-code"></a>пример кода

Следующий пример возвращает версию [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] участнику.  
  
```csharp
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

public class StoredProcedures
{
    [Microsoft.SqlServer.Server.SqlProcedure]
    public static void GetVersion()
    {
        using (var connection = new SqlConnection("context connection=true"))
        {
            connection.Open();
            var command = new SqlCommand("select @@version", connection);
            SqlContext.Pipe.ExecuteAndSend(command);
        }
    }
}
```

## <a name="example-test-script"></a>Пример тестового скрипта

В следующем скрипте теста показано, как вызвать `GetVersion` хранимую процедуру, определенную в предыдущем примере.  
  
```sql
EXEC GetVersion  
```  

## <a name="next-steps"></a>Дальнейшие действия
  
Дополнительные сведения об отладке управляемого кода с помощью Visual Studio см. в разделе [Отладка управляемого кода](/visualstudio/debugger/debugging-managed-code) в документации по Visual Studio.  

Дополнительные сведения см. в разделе [Основные понятия программирования для интеграции со средой](../../relational-databases/clr-integration/common-language-runtime-clr-integration-programming-concepts.md) CLR  
