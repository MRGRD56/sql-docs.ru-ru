---
description: Обновление базы данных при помощи отсоединения и присоединения (Transact-SQL)
title: Обновление базы данных при помощи отсоединения и присоединения (Transact-SQL)
ms.date: 06/03/2020
ms.prod: sql
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- database attaching [SQL Server]
- upgrading databases
- database upgrades [SQL Server]
- database detaching [SQL Server]
- detaching databases [SQL Server]
- attaching databases [SQL Server]
ms.assetid: 99f66ed9-3a75-4e38-ad7d-6c27cc3529a9
author: stevestein
ms.author: sstein
ms.custom: seo-dt-2019
ms.openlocfilehash: 8dcf9f0c1acf4231d532a25fade340d152d3b6af
ms.sourcegitcommit: c09ef164007879a904a376eb508004985ba06cf0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "104890783"
---
# <a name="upgrade-a-database-using-detach-and-attach-transact-sql"></a>Обновление базы данных при помощи отсоединения и присоединения (Transact-SQL)
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]
В этой теме описывается использование операции отсоединения и присоединения для обновления базы данных в [!INCLUDE[ssnoversion](../../includes/ssnoversion-md.md)]. После присоединения к [!INCLUDE[ssnoversion](../../includes/ssnoversion-md.md)]база данных сразу становится доступной, после чего автоматически обновляется. Это исключает возможность использования базы данных с более старой версией [!INCLUDE[ssde_md](../../includes/ssde_md.md)]. Тем не менее обновление метаданных не влияет на [режим совместимости базы данных](../../relational-databases/databases/view-or-change-the-compatibility-level-of-a-database.md). Дополнительные сведения см. в разделе [уровень базы данных совместимости после обновления](#dbcompat) далее в этой статье.  
  
 **Содержание раздела**  
  
-   **Перед началом работы**  
  
     [Ограничения](#Restrictions)  
  
     [Рекомендации](#Recommendations)  
  
-   **Обновление базы данных SDL Server**  
  
     [Использование операций отсоединения и присоединения](#SSMSProcedure)  
  
-   **Дальнейшие действия.**    

     [После обновления базы данных SQL Server](#FollowUp)  
  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> Перед началом  
  
###  <a name="limitations-and-restrictions"></a><a name="Restrictions"></a> Ограничения  
  
-   Системные базы данных не могут быть присоединены.  
  
-   Присоединение и отсоединение приводят к отмене межбазовых цепочек владения для базы данных с присваиванием параметру **cross db ownership chaining** значения 0. Сведения о том, как включить цепочки владения, см. в статье [Параметр конфигурации сервера "cross db ownership chaining"](../../database-engine/configure-windows/cross-db-ownership-chaining-server-configuration-option.md).  
  
-   Присоединение скопированной, а не отсоединенной реплицируемой базы данных:  
  
    -   если база данных присоединяется к обновленной версии того же экземпляра сервера, необходимо обновить репликацию после завершения присоединения с помощью хранимой процедуры **sp_vupgrade_replication**. Дополнительные сведения см. в статье [sp_vupgrade_replication (Transact-SQL)](../../relational-databases/system-stored-procedures/sp-vupgrade-replication-transact-sql.md).  
  
    -   если база данных присоединяется к другому экземпляру сервера (независимо от версии), необходимо удалить репликацию после завершения присоединения с помощью хранимой процедуры **sp_removedbreplication**. Дополнительные сведения см. в статье [sp_removedbreplication (Transact-SQL)](../../relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql.md).  
  
###  <a name="recommendations"></a><a name="Recommendations"></a> Рекомендации  
Не рекомендуется подключать или восстанавливать базы данных, полученные из неизвестных или ненадежных источников. В этих базах данных может содержаться вредоносный код, вызывающий выполнение непредусмотренных инструкций [!INCLUDE[tsql](../../includes/tsql-md.md)] или появление ошибок из-за изменения схемы или физической структуры базы данных. Перед тем как использовать базу данных, полученную из неизвестного или ненадежного источника, выполните на тестовом сервере инструкцию [DBCC CHECKDB](../../t-sql/database-console-commands/dbcc-checkdb-transact-sql.md) для этой базы данных, а также изучите исходный код в базе данных, например хранимые процедуры и другой пользовательский код.  
  
##  <a name="to-upgrade-a-database-by-using-detach-and-attach"></a><a name="SSMSProcedure"></a> Обновление базы данных при помощи функций отсоединения и присоединения  
  
1.  Отсоединение базы данных. Дополнительные сведения см. в разделе [Отсоединение базы данных](../../relational-databases/databases/detach-a-database.md).  
  
2.  При необходимости переместите отсоединенные файлы баз данных и файлы журналов.  
  
     Файлы журнала и файлы данных следует переместить, даже если планируется создать новые файлы журнала. В некоторых случаях для повторного присоединения базы данных требуются файлы ее существующих журналов. Поэтому всегда храните все файлы отсоединенных журналов, пока база данных не будет успешно присоединена без них.  
  
    > [!NOTE]  
    >  При попытке присоединить базу данных, не указывая файл журнала, операцией присоединения будет произведен поиск файла журнала в его исходном месте. Если первоначальная копия журнала существует в этом расположении, она будет присоединена. Чтобы избежать применения исходного файла журнала, либо укажите путь к новому файлу журнала, либо удалите исходную его копию (после его копирования в новое место).  
  
3.  Присоедините скопированные файлы к экземпляру [!INCLUDE[ssnoversion](../../includes/ssnoversion-md.md)]. Дополнительные сведения см. в статье [Attach a Database](../../relational-databases/databases/attach-a-database.md).  
  
## <a name="example"></a>Пример  
 В следующем примере выполняется обновление копии базы данных предыдущей версии SQL Server. Инструкции [!INCLUDE[tsql](../../includes/tsql-md.md)] выполняются в окне редактора запросов, подключенном к экземпляру сервера, к которому выполнено присоединение.  
  
1.  Отсоедините базу данных, выполнив следующие инструкции [!INCLUDE[tsql](../../includes/tsql-md.md)] .  
  
    ```sql  
    USE master;  
    GO  
    EXEC sp_detach_db @dbname = N'MyDatabase';  
    GO  
    ```  
  
2.  Скопируйте любым способом данные и файлы журнала в новое местоположение.  
  
    > [!IMPORTANT]  
    > При работе с производственными базами данных рекомендуется помещать базу данных и журналы транзакций на отдельные диски. Эти диски имеют разные требования к операциям ввода-вывода и росту файлов, и лучше разделить их.  
  
    При копировании файлов по сети на диск удаленного компьютера укажите имя удаленного места в формате UNC. UNC-имя принимает форму `\\Servername\Sharename\Path\Filename`. Как и при записи файлов на жесткий диск локального компьютера, для записи (или считывания) файла на диск удаленного компьютера учетной запись пользователя, которая используется экземпляром [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], должны быть предоставлены соответствующие разрешения.  
  
3.  Присоедините перемещенную базу данных и, если потребуется, ее журнал, выполнив следующую инструкцию [!INCLUDE[tsql](../../includes/tsql-md.md)] .  
  
    ```sql  
    USE master;  
    GO  
    CREATE DATABASE MyDatabase   
        ON (FILENAME = 'C:\MySQLServer\MyDatabase.mdf'),  
        (FILENAME = 'C:\MySQLServer\Database.ldf')  
        FOR ATTACH;  
    GO  
    ```  
  
    В среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]только что присоединенная база данных отображается в обозревателе объектов не сразу. Чтобы отобразить базу данных, щелкните в обозревателе объектов пункт **Вид** , а затем **Обновить**. Теперь, раскрыв в обозревателе объектов узел **Базы данных** , можно увидеть в списке присоединенную базу данных.  
  
##  <a name="follow-up-after-upgrading-a-sql-server-database"></a><a name="FollowUp"></a> Дальнейшие действия. После обновления базы данных SQL Server  
Если база данных содержит полнотекстовые индексы, то в процессе обновления будет произведен их импорт, сброс или перестроение в зависимости от установленного значения свойства сервера **upgrade_option** . Если при обновлении выбран режим импорта (**upgrade_option** = 2) или перестроения (**upgrade_option** = 0), полнотекстовые индексы во время обновления будут недоступны. В зависимости от объема индексируемых данных процесс импорта может занять несколько часов, а перестроение — в несколько (до десяти) раз больше. Обратите внимание, что если для обновления выбран режим «Импортировать», а полнотекстовый каталог недоступен, то связанные с ним полнотекстовые индексы будут перестроены. Чтобы изменить значение свойства сервера **upgrade_option** , следует использовать процедуру [sp_fulltext_service](../../relational-databases/system-stored-procedures/sp-fulltext-service-transact-sql.md).  
  
### <a name="database-compatibility-level-after-upgrade"></a><a name="dbcompat"></a> Уровень совместимости баз данных после обновления  

После обновления уровень совместимости базы данных останется неизменным, если только он не является в новой версии неподдерживаемым. В последнем случае обновленный уровень совместимости базы данных устанавливается как самый низкий из поддерживаемых.

Например, если подключить к экземпляру [!INCLUDE [sssql19-md](../../includes/sssql19-md.md)] базу данных, имеющую уровень совместимости 90, то после обновления он будет изменен на 100, что является наименьшим поддерживаемым уровнем для [!INCLUDE [sssql19-md](../../includes/sssql19-md.md)]. Дополнительные сведения см. в разделе [Уровень совместимости инструкции ALTER DATABASE (Transact-SQL)](../../t-sql/statements/alter-database-transact-sql-compatibility-level.md).

### <a name="managing-metadata-on-the-upgraded-server-instance"></a>Управление метаданными в экземпляре обновленного сервера  
Чтобы обеспечить согласованное функционирование базы данных для пользователей и приложений, когда она присоединяется к другому экземпляру сервера, на другом экземпляре сервера, возможно, понадобится повторно создать некоторые или все метаданные базы данных, например имена входа, задания и разрешения. Дополнительные сведения см. в статье [Управление метаданными при обеспечении доступности базы данных на другом экземпляре сервера (SQL Server)](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).  
  
### <a name="service-master-key-and-database-master-key-encryption-changes-from-3des-to-aes"></a>Алгоритм шифрования главного ключа службы и главного ключа базы данных изменяется с 3DES на AES  
 [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] и более поздних версиях для защиты главного ключа службы и главного ключа базы данных используется алгоритм шифрования AES. AES - это новый алгоритм шифрования, отличный от алгоритма 3DES, используемого в более ранних версиях. При первом присоединении базы данных к новому экземпляру [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] или ее восстановлении копия главного ключа базы данных (зашифрованная главным ключом службы) еще не хранится на сервере. Необходимо расшифровать главный ключ базы данных с помощью инструкции `OPEN MASTER KEY`. Как только главный ключ базы данных будет расшифрован, появится возможность разрешить автоматическую расшифровку в будущем с помощью инструкции `ALTER MASTER KEY REGENERATE`, чтобы оставить на сервере копию главного ключа базы данных, зашифрованного с помощью главного ключа службы. После обновления базы данных с переходом от более ранней версии главный ключ базы данных должен быть создан повторно для использования нового алгоритма шифрования AES. Дополнительные сведения о повторном создании главного ключа базы данных см. в статье [ALTER MASTER KEY (Transact-SQL)](../../t-sql/statements/alter-master-key-transact-sql.md). Время, необходимое для повторного создания главного ключа базы данных с обновлением до алгоритма шифрования AES, зависит от числа объектов, защищаемых главным ключом базы данных. Повторное создание главного ключа базы данных с обновлением до алгоритма шифрования AES необходимо произвести только один раз. Это никак не повлияет на последующие операции повторного создания, выполняемые в соответствии со стратегией смены ключей.  
  
  
