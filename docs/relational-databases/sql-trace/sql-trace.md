---
title: Трассировка SQL
description: Трассировка SQL
ms.prod: sql
ms.prod_service: database-engine
ms.technology: ''
ms.topic: conceptual
ms.assetid: 83c6d1d9-19ce-43fe-be9a-45aaa31f20cb
author: MashaMSFT
ms.author: mathoma
ms.reviewer: ''
ms.custom: ''
ms.date: 11/27/2018
ms.openlocfilehash: 4ea8d31c58758c7513a3d958ee02f0e5d9f4c5d4
ms.sourcegitcommit: c5078791a07330a87a92abb19b791e950672e198
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/26/2020
ms.locfileid: "94585019"
---
# <a name="sql-trace"></a>Трассировка SQL

[!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]
При трассировке SQL собираются события, классы которых указаны в ее определении. Эти события можно выделить из трассировки или поставить в очередь по своему назначению. В качестве назначения могут выступать файлы и объекты управления (SMO) [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , предоставляющие сведения трассировки приложениям, которые управляют сервером [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].  

> [!IMPORTANT]
> Трассировка SQL и [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] являются устаревшими. Пространство имен *Microsoft.SqlServer.Management.Trace*, которое содержит объекты трассировки Microsoft SQL Server и Replay, также устаревшее. 
> [!INCLUDE[ssNoteDepFutureAvoid](../../includes/ssnotedepfutureavoid-md.md)] 
> Вместо этого используйте расширенные события. Дополнительные сведения о [расширенных событиях](../../relational-databases/extended-events/extended-events.md) см. в разделе [Быстрое начало. Расширенные события в SQL Server](../../relational-databases/extended-events/quick-start-extended-events-in-sql-server.md) и [SSMS XEvent Profiler](../../relational-databases/extended-events/use-the-ssms-xe-profiler.md).

## <a name="benefits-of-sql-trace"></a>Преимущества трассировки SQL  
Для создания трассировок на экземпляре компонента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], Microsoft [!INCLUDE[tsql](../../includes/tsql-md.md)] предоставляет системные хранимые процедуры на языке [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)]. Эти системные хранимые процедуры можно использовать для создания трассировок вручную в рамках пользовательских приложений вместо использования приложения [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)]. Это позволяет писать пользовательские приложения, отвечающие конкретным нуждам предприятия.  
  
## <a name="sql-trace-architecture"></a>Архитектура трассировки SQL  
Источником событий может быть любой источник, вызывающий события трассировки, в том числе пакеты [!INCLUDE[tsql](../../includes/tsql-md.md)] или события [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , например взаимоблокировки. Дополнительные сведения о событиях см. в разделе [SQL Server Event Class Reference](../../relational-databases/event-classes/sql-server-event-class-reference.md). При возникновении события, класс которого содержится в определении трассировки, сведения о нем регистрируются трассировкой. Если определение трассировки содержит фильтры для класса событий, эти фильтры применяются, и сведения о событиях трассировки передается в очередь. Из очереди сведения о трассировке или записываются в файл, или используются объектами управления (SMO) сервера в таких приложениях, как [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)]. Следующая диаграмма демонстрирует сбор событий трассировкой SQL.  
  
![Процесс трассировки событий ядра СУБД](../../relational-databases/sql-trace/media/tracarch.gif "Процесс трассировки событий ядра СУБД")  
  
## <a name="sql-trace-terminology"></a>Терминология, связанная с трассировкой SQL  
Основные понятия трассировки SQL описываются в следующих терминах.  
  
 **Событие**  
 Возникновение действия в экземпляре компонента [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)].  
  
 **Столбец данных**  
 Атрибут события.  
  
 **Класс событий**  
 Тип события, которое можно трассировать. Класс событий содержит все столбцы данных, которые могут возвратить событие.  
  
 **Категория событий**  
 Группа связанных классов событий.  
  
 **Трассировка**  
 Коллекция событий и данных, возвращаемых [!INCLUDE[ssDE](../../includes/ssde-md.md)].  
  
 **Трассировать**  
 Собирать и контролировать события в экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].  
  
 **Определение трассировки**  
 Коллекция классов событий, столбцов данных и фильтров, которые обозначают типы событий, которые нужно собирать при трассировке.  
  
 **Filter**  
 Критерии, которые ограничивают собираемые при трассировке события.  
  
 **Файл трассировки**  
 Файл, созданный при сохранении трассировки.  
  
 **Шаблон**  
 В приложении [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)]— файл, который определяет классы событий и столбцы данных, которые должны собираться при трассировке.  
  
 **Таблица трассировки**  
 В приложении [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)]таблица, создаваемая при сохранении трассировки в таблицу.  
  
## <a name="use-data-columns-to-describe-returned-events"></a>Использование столбцов данных для описания возвращаемых событий  
Приложение трассировки SQL использует столбцы данных в результатах трассировки для описания событий, возвращенных во время работы трассировки. В следующей таблице приводится описание столбцов данных приложения [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] , совпадающих со столбцами данных, используемыми приложением трассировки SQL, а также описание столбцов по умолчанию.  
  
|Столбец данных|Номер столбца|Описание|  
|-----------------|-------------------|-----------------|  
|\* **ApplicationName**|10|Имя клиентского приложения, установившего соединение с экземпляром [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Этот столбец заполняется значениями, передаваемыми приложением, а не отображаемым именем программы.|  
|**BigintData1**|52|Значение (типа **bigint** ), зависящее от класса событий, указанного при трассировке.|  
|**BigintData2**|53|Значение (типа **bigint** ), зависящее от класса событий, указанного при трассировке.|  
|\* **Binary Data**|2|Двоичное значение, зависящее от класса событий, захваченного при трассировке.|  
|\* **ClientProcessID**|9|Идентификатор, присвоенный компьютером сервера процессу, в котором работает клиентское приложение. Этот столбец данных заполняется в том случае, если клиент вводит идентификатор клиентского процесса.|  
|**ColumnPermissions**|44|Указывает, было ли установлено разрешение на доступ к столбцу. Можно выполнить синтаксический анализ текста инструкции, чтобы определить, какие разрешения были применены к каким столбцам.|  
|\* **ЦП**|18|Объем времени ЦП (в миллисекундах), использованного событием.|  
|**Идентификатор базы данных**|3|Идентификатор базы данных, указанной в инструкции USE *database_name* , или базы данных по умолчанию, если для данного экземпляра инструкция USE *database_name* не выполнялась. [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] отображает имя базы данных, если столбец данных **ServerName** захвачен при трассировке и сервер доступен. Определите значение для базы данных, используя функцию DB_ID.|  
|**DatabaseName**|35|Имя базы данных, в которой выполняется инструкция пользователя.|  
|**DBUserName**|40|Имя пользователя [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] клиента.|  
|\* **Длительность**|13|Продолжительность события (в микросекундах).<br /><br /> Сервер сообщает о длительности события в микросекундах (одна миллионная доля секунды, 10<sup>-6</sup>с) и о количестве времени ЦП, затраченного на событие, в миллисекундах (одна тысячная доля секунды, 10<sup>-3</sup>с). В [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] графический пользовательский интерфейс по умолчанию отображает столбец **Продолжительность** в миллисекундах, но, когда данные трассировки сохраняются в файле или таблице базы данных, значение столбца **Продолжительность** записывается в микросекундах.|  
|\* **EndTime**|15|Время окончания события. Этот столбец не заполняется для тех классов событий, которые соответствуют начинающимся событиям, для таких как **SQL:BatchStarting** или **SP:Starting**.|  
|**Error**|31|Номер ошибки для данного события. Зачастую это номер ошибки, хранимый в таблице **sysmessages**.|  
|\* **EventClass**|27|Тип захваченного класса событий.|  
|**EventSequence**|51|Порядковый номер этого события.|  
|**EventSubClass**|21|Тип подкласса событий, предоставляющий дополнительные сведения о каждом классе событий. Например, значения подкласса событий для класса событий **Execution Warning** представляет тип предупреждения при выполнении.<br /><br /> **1** = ожидание запроса. Запрос должен ждать освобождения ресурсов для своего выполнения, например ресурсов памяти.<br /><br /> **2** = истекло время ожидания запроса. При ожидании необходимых для выполнения запроса ресурсов истекло отведенное время. Этот столбец данных заполняется не для всех классов событий.|  
|**GUID**|54|Значение идентификатора GUID, зависящее от класса событий, указанного при трассировке.|  
|**FileName**|36|Логическое имя изменяемого файла.|  
|**Дескриптор**|33|Целочисленное значение, используемое ODBC, OLE DB или DB-Library для координации работы с сервером.|  
|**HostName**|8|Имя компьютера, на котором выполняется клиентская программа. Заполнение этого столбца данных производится в том случае, если клиент предоставляет имя узла. Чтобы определить имя узла, используйте функцию HOST_NAME.|  
|**IndexID**|24|Идентификатор индекса объекта, связанного с событием. Чтобы определить идентификатор индекса для объекта, используйте столбец **indid** в системной таблице **sysindexes** .|  
|**IntegerData**|25|Целочисленное значение, зависящее от класса событий, захваченного при трассировке.|  
|**IntegerData2**|55|Целочисленное значение, зависящее от класса событий, захваченного при трассировке.|  
|**IsSystem**|60|Указывает, в каком процессе произошло событие, в системном или в пользовательском.<br /><br /> **1** = системный процесс<br /><br /> **0** = пользовательский процесс|  
|**LineNumber**|5|Содержит номер строки, в которой имеется ошибка. Для событий, в которых задействованы инструкции языка [!INCLUDE[tsql](../../includes/tsql-md.md)] , например **SP:StmtStarting**, столбец **LineNumber** содержит номер строки инструкции в хранимой процедуре или пакете.|  
|**LinkedServerName**|45|Имя связанного сервера.|  
|\* **LoginName**|11|Имя входа пользователя (имя входа безопасности SQL Server или учетные данные входа Windows в формате ДОМЕН\Имя_пользователя).|  
|**LoginSid**|41|Идентификатор безопасности (SID) подключившегося пользователя. Эти сведения можно найти в представлении **sys.server_principals** базы данных **master** . Каждому имени входа для сервера присваивается уникальный идентификатор.|  
|**MethodName**|47|Имя вызываемого метода OLEDB.|  
|**Режим**|32|Целочисленное значение, используемое различными событиями для описания полученного или запрашиваемого ими состояния.|  
|**NestLevel**|29|Целочисленное представление данных, возвращаемых функцией @@NESTLEVEL.|  
|**NTDomainName**|7|Домен Microsoft Windows, к которому принадлежит пользователь.|  
|\* **NTUserName**|6|Имя пользователя Windows.|  
|**ObjectID**|22|Назначенный системой идентификатор объекта.|  
|**ObjectID2**|56|Идентификатор связанного объекта или сущности, если он доступен.|  
|**ObjectName**|34|Имя объекта, на который имеется ссылка.|  
|\*\***ObjectType**|28|Значение, представляющее тип объекта, который участвует в событии. Это значение соответствует столбцу **type** в таблице **sysobjects**.|  
|**Offset**|61|Начальное смещение инструкции в пределах хранимой процедуры или пакета.|  
|**OwnerID**|58|Только для событий блокировки. Тип объекта, которому принадлежит блокировка.|  
|**OwnerName**|37|Имя пользователя базы данных, владеющего объектом.|  
|**ParentName**|59|Имя схемы, в которой находится объект.|  
|**Разрешения**|19|Целочисленное значение, отражающее тип проверяемых разрешений. Доступны следующие значения:<br /><br /> **1** = SELECT ALL<br /><br /> **2** = UPDATE ALL<br /><br /> **4** = REFERENCES ALL<br /><br /> **8** = INSERT<br /><br /> **16** = DELETE<br /><br /> **32** = EXECUTE (только для процедур)<br /><br /> **4096** = SELECT ANY (как минимум один столбец)<br /><br /> **8192** = UPDATE ANY<br /><br /> **16384** = REFERENCES ANY|  
|**ProviderName**|46|Имя поставщика OLEDB.|  
|\* **Reads**|16|Количество операций чтения с логического диска, выполненных сервером для данного события. Эти операции чтения включают в себя все операции чтения из таблиц и буферов при выполнении данной инструкции.|  
|**RequestID**|49|Идентификатор запроса, содержащего инструкцию.|  
|**RoleName**|38|Имя включаемой роли приложения.|  
|**RowCounts**|48|Количество строк в пакете.|  
|**ServerName**|26|Имя отслеживаемого экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .|  
|**SessionLoginName**|64|Имя входа пользователя, который инициировал сеанс. Например, при подключении к [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] под именем **Имя_входа1** и при выполнении инструкции под именем **Имя_входа2** поле **SessionLoginName** будет содержать **Имя_входа1**, а поле **LoginName** — **Имя_входа2**. В данном столбце отображаются имена входа [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и Windows.|  
|**Уровень серьезности**|20|Уровень серьезности события исключения.|  
|**SourceDatabaseID**|62|Идентификатор базы данных, в которой существует источник объекта.|  
|\* **SPID**|12|Идентификатор серверного процесса (SPID), который [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] присвоил процессу, связанному с клиентом.|  
|**SqlHandle**|63|64-разрядная версия хэша, основанная на тексте нерегламентированного запроса или базы данных и на идентификаторе объекта SQL. Это значение можно передать в функцию **sys.dm_exec_sql_text()** , чтобы получить связанный текст SQL.|  
|\* **StartTime**|14|Время начала события, если доступно.|  
|**Состояние**|30|Код ошибки состояния.|  
|**Успешно**|23|Указывает, было ли событие успешным. К этим значениям относятся следующие.<br /><br /> **1** = успешное завершение.<br /><br /> **0** = неуспешное завершение.<br /><br /> Например, значение **1** означает успешную проверку разрешений, а **0** — неудавшуюся проверку.|  
|**TargetLoginName**|42|Для действий с именем входа (например, при добавлении нового имени входа) — имя этого имени входа.|  
|**TargetLoginSid**|43|Для действий над именем входа (например, при добавлении нового имени входа) — идентификатор SID этого имени входа.|  
|**TargetUserName**|39|Для действий, выполняемых над пользователем базы данных (например, предоставление пользователю разрешений), — имя этого пользователя.|  
|\* **TextData**|1|Текстовое значение, зависящее от класса событий, захваченного при трассировке. Однако при трассировке параметризированного запроса соответствующие переменные не отображаются со значениями типа данных в столбце **TextData** .|  
|**Transaction ID**|4|Назначенный системой идентификатор транзакции.|  
|**Тип**|57|Целочисленное значение, зависящее от класса событий, захваченного при трассировке.|  
|\* **Writes**|17|Количество физических обращений записи на диск, выполненных сервером для данного события.|  
|**XactSequence**|50|Токен, описывающий текущую транзакцию.|  

\* Эти столбцы данных заполняются по умолчанию для всех событий.

\*\* Дополнительные сведения о столбце данных **ObjectType** см. в статье [Столбец события ObjectType Trace](../../relational-databases/event-classes/objecttype-trace-event-column.md).

## <a name="sql-trace-tasks"></a>Задачи трассировки SQL
  
|Описание задачи|Раздел|  
|----------------------|-----------|  
|Описывает создание и запуск трассировки с помощью хранимых процедур Transact-SQL.|[Создание и запуск трассировки с помощью хранимых процедур Transact-SQL](../../relational-databases/sql-trace/create-and-run-traces-using-transact-sql-stored-procedures.md)|  
|Описывает создание и запуск трассировки вручную с помощью хранимых процедур на экземпляре [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)].|[Создание трассировок вручную с помощью хранимых процедур](../../relational-databases/sql-trace/create-manual-traces-using-stored-procedures.md)|  
|Описывает сохранение результатов трассировки в файл, куда они записывались.|[Сохранение результатов трассировки в файл](../../relational-databases/sql-trace/save-trace-results-to-a-file.md)|  
|Описывает улучшение доступа к данным трассировки с помощью пространства в каталоге **temp** .|[Улучшение доступа для трассировки данных](../../relational-databases/sql-trace/improve-access-to-trace-data.md)|  
|Описывает создание трассировки с помощью хранимых процедур.|[Создание трассировки (Transact-SQL)](../../relational-databases/sql-trace/create-a-trace-transact-sql.md)|  
|Описывает создание фильтра, который возвращает только данные необходимые для трассируемого события, с помощью хранимых процедур.|[Создание фильтра трассировки (Transact-SQL)](../../relational-databases/sql-trace/set-a-trace-filter-transact-sql.md)|  
|Описывает изменение существующей трассировки с помощью хранимых процедур.|[Изменение существующей трассировки (Transact-SQL)](../../relational-databases/sql-trace/modify-an-existing-trace-transact-sql.md)|  
|Описывает просмотр сохраненной трассировки с помощью встроенных функций.|[Просмотр сохраненной трассировки (Transact-SQL)](../../relational-databases/sql-trace/view-a-saved-trace-transact-sql.md)|  
|Описывает просмотр сведений фильтра трассировки с помощью встроенных функций.|[Просмотр сведений о фильтре (Transact-SQL)](../../relational-databases/sql-trace/view-filter-information-transact-sql.md)|  
|Описывает удаление трассировки с помощью хранимых процедур.|[Удаление трассировки (Transact-SQL)](../../relational-databases/sql-trace/delete-a-trace-transact-sql.md)|  
|Описывает сокращение потерь производительности, связанных с трассировкой.|[Оптимизация трассировки SQL](../../relational-databases/sql-trace/optimize-sql-trace.md)|  
|Описывает уменьшение дополнительной нагрузки, возникающей при трассировке, с помощью фильтрации.|[Фильтрация трассировки](../../relational-databases/sql-trace/filter-a-trace.md)|  
|Описывает сокращение количества данных, которые собирает трассировка.|[Ограничение размеров файла и таблицы трассировки](../../relational-databases/sql-trace/limit-trace-file-and-table-sizes.md)|  
|Описывает два способа планирования трассировки в Microsoft [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].|[Планирование трассировок](../../relational-databases/sql-trace/schedule-traces.md)|  
  
## <a name="see-also"></a>См. также:  
 [Шаблоны и разрешения приложения SQL Server Profiler](../../tools/sql-server-profiler/sql-server-profiler-templates-and-permissions.md)   
 [Учебник по программированию управляющих объектов SQL Server (SMO)](../../relational-databases/server-management-objects-smo/sql-server-management-objects-smo-programming-guide.md)  
  
  
