---
description: Руководство по архитектуре журнала транзакций SQL Server и управлению им
title: Руководство по архитектуре журналов транзакций и управлению ими
ms.custom: ''
ms.date: 10/23/2019
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- transaction log architecture guide
- guide, transaction log architecture
- vlf
- transaction log guidance
- vlfs
- virtual log files
- virtual log size
- vlf size
- transaction log internals
ms.assetid: 88b22f65-ee01-459c-8800-bcf052df958a
author: rothja
ms.author: jroth
monikerRange: '>=aps-pdw-2016||=azuresqldb-current||=azure-sqldw-latest||>=sql-server-2016||>=sql-server-linux-2017||=azuresqldb-mi-current'
ms.openlocfilehash: a445552a69033bec7564e05d7fc86d7416a5ff47
ms.sourcegitcommit: 1a544cf4dd2720b124c3697d1e62ae7741db757c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2020
ms.locfileid: "97461835"
---
# <a name="sql-server-transaction-log-architecture-and-management-guide"></a>Руководство по архитектуре журнала транзакций SQL Server и управлению им
[!INCLUDE[SQL Server Azure SQL Database Synapse Analytics PDW ](../includes/applies-to-version/sql-asdb-asdbmi-asa-pdw.md)]

  Каждая база данных [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] имеет журнал транзакций, в котором фиксируются все изменения данных, произведенные в каждой из транзакций. Журнал транзакций является критическим компонентом базы данных и в случае системного сбоя может потребоваться для приведения базы данных в согласованное состояние. В этом руководстве приводятся сведения о физической и логической архитектуре журнала транзакций. Понимание архитектуры может помочь в повышении эффективности работы с журналами транзакций.  

  
##  <a name="transaction-log-logical-architecture"></a><a name="Logical_Arch"></a> Логическая архитектура журнала транзакций  
 Логически журнал транзакций [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] работает так, как если бы он являлся последовательностью записей в журнале. Каждая запись журнала идентифицируется регистрационным номером транзакции (номер LSN). Каждая новая запись добавляется в логический конец журнала с номером LSN, который больше номера LSN предыдущей записи. Записи журнала сохраняются в серийной последовательности по мере их создания, таким образом если LSN2 больше, чем LSN1, то изменение, описанное записью журнала, на которую ссылается LSN2, произошло после изменения, описанного записью журнала LSN1. Каждая запись журнала содержит идентификатор транзакции, к которой она относится. Все записи журнала, связанные с определенной транзакцией, с помощью обратных указателей связаны в цепочку, которая предназначена для ускорения отката транзакции.  
  
 Записи журнала для изменения данных содержат либо выполненную логическую операцию, либо исходный и результирующий образ измененных данных. Исходный образ записи — это копия данных до выполнения операции, а результирующий образ — копия данных после ее выполнения.  
  
Действия, которые необходимо выполнить для восстановления операции, зависят от типа журнальной записи:  
  
-   Зарегистрирована логическая операция.  
  
    -   Для наката логической операции выполняется эта операция.  
  
    -   Для отката логической операции выполняется логическая операция, обратная зарегистрированной.  
  
-   Зарегистрированы исходный и результирующий образы записи.  
  
    -   Для наката операции применяется результирующий образ.  
  
    -   Для отката операции применяется исходный образ.  
  
В журнал транзакций записываются различные типы операций, например:  
  
-   начало и конец каждой транзакции;  
  
-   любые изменения данных (вставка, обновление или удаление), включая изменения в любой таблице (в том числе и в системных таблицах), производимые системными хранимыми процедурами или инструкциями языка DDL;  
  
-   любое выделение и освобождение страниц и экстентов;  
  
-   создание и удаление таблиц и индексов.  
  
 Кроме того, регистрируются операции отката. Каждая транзакция резервирует в журнале транзакций место, чтобы при выполнении инструкции отката или возникновения ошибки в журнале было достаточно места для регистрации отката. Объем резервируемого пространства зависит от выполняемых в транзакции операций, но обычно он равен объему, необходимому для регистрации каждой из операций. Все это пространство после завершения транзакции освобождается.  
  
<a name="minlsn"></a> Раздел файла журнала из первой записи, который должен присутствовать для успешного отката всей базы данных к последней зарегистрированной записи называется активной частью журнала, *активным журналом* или *заключительным фрагментом журнала*. Этот раздел журнала необходим для полного [восстановления](../relational-databases/backup-restore/restore-and-recovery-overview-sql-server.md#TlogAndRecovery) базы данных. Ни одна часть активного журнала не может быть усечена. Регистрационный номер транзакции в журнале (LSN) этой первой записи называется **минимальным номером LSN восстановления (*MinLSN*)** . Дополнительные сведения об операциях, поддерживаемых журналом транзакций, см. в разделе [Журнал транзакций (SQL Server)](../relational-databases/logs/the-transaction-log-sql-server.md).  

Разностные резервные копии и резервные копии журналов продвигают восстанавливаемую базу данных к более позднему моменту, которому соответствует больший регистрационный номер транзакции в журнале. 
  
##  <a name="transaction-log-physical-architecture"></a><a name="physical_arch"></a> Физическая архитектура журнала транзакций  
Журнал транзакций в базе данных сопоставляет один или несколько физических файлов. По сути, файл журнала представляет собой строку записей журнала. Физически последовательность записей журнала эффективно хранится в наборе физических файлов, которые образуют журнал транзакций. Для каждой базы данных должен существовать хотя бы один файл журнала.  
  
Внутри системы компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] делит каждый физический файл журнала на несколько виртуальных файлов журнала. Виртуальные файлы журнала не имеют фиксированных размеров. Не существует также и определенного числа виртуальных файлов журнала, приходящихся на один физический файл журнала. Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] динамически определяет размер виртуальных файлов журнала при создании или расширении файлов журнала. Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] стремится обслуживать небольшое число виртуальных файлов. После расширения файла журнала размер виртуальных файлов определяется как сумма размера существующего журнала и размера нового приращения файла. Администраторы не могут настраивать или устанавливать размеры и число виртуальных файлов журнала.  

> [!NOTE]
> Для создания виртуального файла журнала (VLF) используется следующий метод.
> - Если дальнейшее увеличение размера не превышает 1/8 текущего физического размера журнала, создается один виртуальный файл журнала, который покрывает увеличение размера (начиная с [!INCLUDE[ssSQL14](../includes/sssql14-md.md)]).
> - Если дальнейшее увеличение размера превышает 1/8 текущего размера журнала, следует использовать метод, доступный в версиях до 2014.
>    -  Если увеличение размера не превышает 64 МБ, создаются четыре виртуальных файла журнала, которые покрывают увеличение размера (например, для изменения размера в 1 МБ создаются четыре виртуальных файла журнала по 256 КБ каждый).
>    -  Если увеличение размера находится в диапазоне от 64 МБ до 1 ГБ, создаются восемь виртуальных файлов журнала, которые покрывают увеличение размера (например, для изменения размера в 512 МБ создаются восемь виртуальных файлов журнала по 64 МБ каждый).
>    -  Если увеличение размера превышает 1 ГБ, создаются 16 виртуальных файлов журнала, которые покрывают увеличение размера (например, для изменения размера в 8 ГБ создаются 16 виртуальных файлов журнала по 512 МБ каждый).

Если в результате большого числа малых приращений файлы журнала разрастаются до крупных размеров, они будут иметь множество виртуальных файлов журнала. **Это может замедлить запуск базы данных, а также операции резервного копирования и восстановления журналов**. И наоборот, если файлы журнала разрастаются до крупных размеров в результате всего нескольких или даже одного приращения, они будут иметь очень мало виртуальных файлов журнала. Дополнительные сведения о правильной оценке параметра **требуемого размера** и **автоувеличения** для журнала транзакций см. в разделе *Рекомендации* статьи [Управление размером файла журнала транзакций](../relational-databases/logs/manage-the-size-of-the-transaction-log-file.md#Recommendations).

Рекомендуется назначать файлам журнала значение *size*, которое было бы максимально близким к окончательному требуемому размеру, используя требуемые приращения для обеспечения оптимального распределения VLF, а также задавать относительно большое значение *growth_increment*. Воспользуйтесь советом ниже, чтобы определить оптимальное распределение VLF для текущего размера журнала транзакций. 
 - Значение *size*, задаваемое аргументом `SIZE` инструкции `ALTER DATABASE`, характеризует первоначальный размер файла журнала.
 - Значение *growth_increment* (которое также называют значением автоувеличения), задаваемое аргументом `FILEGROWTH` инструкции `ALTER DATABASE`, — это объем пространства, добавляемый в файл каждый раз, когда требуется больше места. 
 
Дополнительные сведения об аргументах `FILEGROWTH` и `SIZE` для `ALTER DATABASE` см. в разделе [Параметры инструкции ALTER DATABASE (Transact-SQL) для файлов и файловых групп](../t-sql/statements/alter-database-transact-sql-file-and-filegroup-options.md).

> [!TIP]
> Чтобы определить оптимальное распределение виртуальных файлов журнала для текущего размера журнала транзакций всех баз данных в определенном экземпляре, а также требуемые приращения для достижения нужного размера, см. следующий [скрипт](https://github.com/Microsoft/tigertoolbox/tree/master/Fixing-VLFs).
  
 Журнал транзакций является оборачиваемым файлом. Рассмотрим пример. Пусть база данных имеет один физический файл журнала, разделенный на четыре виртуальных файла журнала. При создании базы данных логический файл журнала начинается в начале физического файла журнала. Новые записи журнала добавляются в конце логического журнала и приближаются к концу физического файла журнала. Усечение журнала освобождает любые виртуальные журналы, все записи которых находятся перед минимальным регистрационным номером восстановления в журнале транзакций (MinLSN). *MinLSN* — это регистрационный номер транзакции самой старой записи в журнале, которая необходима для успешного отката на уровне всей базы данных. Журнал транзакций рассматриваемой в данном примере базы данных будет выглядеть примерно так же, как на следующей иллюстрации.  
  
 ![Показывает, как физический файл журнала делится на виртуальные журналы](../relational-databases/media/tranlog3.png)  
  
 Когда конец логического журнала достигнет конца физического файла журнала, новые записи журнала будут размещаться в начале физического файла журнала.  
  
![Показывает, как выполняется перенос логического журнала транзакций в физическом файле журнала](../relational-databases/media/tranlog4.png)   
  
 Этот цикл повторяется бесконечно, пока конец логического журнала не совмещается с началом этого логического журнала. Если старые записи журнала усекаются достаточно часто, так что при этом всегда остается место для новых записей журнала, созданных с новой контрольной точки, журнал постоянно остается незаполненным. Однако, если конец логического журнала совмещается с началом этого логического журнала, происходит одно из двух событий, перечисленных ниже.  
  
-   Если для журнала включен параметр `FILEGROWTH` и на диске имеется свободное место, файл расширяется на величину, указанную в параметре *growth_increment*, и новые записи журнала будут добавляться в это расширение. Дополнительные сведения о параметре `FILEGROWTH` см. в статье [Параметры инструкции ALTER DATABASE (Transact-SQL) для файлов и файловых групп](../t-sql/statements/alter-database-transact-sql-file-and-filegroup-options.md).  
  
-   Если параметр `FILEGROWTH` не включен или диск, на котором размещается файл журнала, имеет меньше свободного места, чем указано в параметре *growth_increment*, выдается ошибка 9002. Дополнительные сведения см. в разделе [Устранение неполадок при переполнении журнала транзакций](../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md).  
  
 Если в журнале содержится несколько физических файлов журнала, логический журнал будет продвигаться по всем физическим файлам журнала до тех пор, пока он не вернется на начало первого физического файла журнала. 
 
> [!IMPORTANT]
> Дополнительные сведения об управлении размером журнала транзакций см. в разделе [Управление размером файла журнала транзакций](../relational-databases/logs/manage-the-size-of-the-transaction-log-file.md).
  
### <a name="log-truncation"></a>Усечение журнала  
 Усечение журнала необходимо для предотвращения переполнения журнала. При усечении журнала удаляются неактивные виртуальные файлы журнала из логического журнала транзакций базы данных [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] , что приводит к освобождению пространства в логическом журнале для повторного использования физическим журналом транзакций. Если усечение журнала транзакций не выполняется, со временем он заполняет все доступное место на диске, отведенное для файлов физического журнала. Однако перед усечением журнала должна быть выполнена операция создания контрольной точки. Новая контрольная точка записывает текущие страницы, измененные в памяти (известные как измененные незафиксированные страницы), вместе со сведениями журнала транзакций из памяти на диск. При создании контрольной точки неактивная часть журнала транзакций помечается как неиспользуемая, после чего ее можно освободить путем усечения журнала. Дополнительные сведения о контрольных точках см. в статье [Контрольные точки базы данных &#40;SQL Server&#41;](../relational-databases/logs/database-checkpoints-sql-server.md).  
  
 На следующем рисунке показан журнал транзакций до усечения и после. На первом рисунке показан журнал транзакций, который никогда не усекался. В настоящий момент логический журнал состоит из четырех виртуальных файлов. Логический журнал начинается с первого файла виртуального журнала и заканчивается виртуальным файлом журнала 4. Запись MinLSN находится в виртуальном журнале 3. Виртуальные журналы 1 и 2 содержат только неактивные записи журнала. Эти записи можно усечь. Виртуальный журнал 5 пока не используется и не является частью текущего логического журнала.  
  
![Показывает, как выглядит журнал транзакций до усечения](../relational-databases/media/tranlog2.png)  
  
 На втором рисунке показан журнал после усечения. Виртуальные журналы 1 и 2 усечены и могут использоваться повторно. Логический журнал теперь начинается с виртуального журнала 3. Виртуальный журнал 5 пока не используется и не является частью текущего логического журнала.  
  
![Показывает, как выглядит журнал транзакций после усечения](../relational-databases/media/tranlog3.png)  
  
 За исключением тех случаев, когда усечение журнала по каким-то причинам задерживается, оно выполняется автоматически после наступления следующих событий.  
  
-   В простой модели восстановления — после достижения контрольной точки.  
-   В модели полного восстановления или в модели восстановления с неполным протоколированием — после создания резервной копии журналов, при условии, что со времени предыдущей операции резервного копирования была достигнута контрольная точка.  
  
 Усечение журнала может быть задержано из-за множества факторов. В случае большой задержки усечения журнала возможно заполнение журнала транзакций. См. сведения в разделах [Факторы, которые могут вызвать задержку усечения журнала](../relational-databases/logs/the-transaction-log-sql-server.md#FactorsThatDelayTruncation) и [Устранение неполадок при переполнении журнала транзакций (ошибка SQL Server 9002)](../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md).  
  
##  <a name="write-ahead-transaction-log"></a><a name="WAL"></a> Журнал транзакций с упреждающей записью  
 В этом разделе описана роль, которую журнал транзакций с упреждающей записью играет в записи изменений данных на диск. [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] использует алгоритм с упреждающей записью журнала (WAL), который гарантирует, что сначала на диск будет записана соответствующая запись журнала, и только после этого изменения данных будут записаны на диск. Таким образом обеспечиваются свойства ACID для транзакции.  
  
 Для понимания принципов работы упреждающего ведения журнала важно знать, как измененные данные записываются на диск. [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] Имеет буферный кэш, в который считываются страницы данных, когда требуется получить данные. Если какая-либо из страниц в буферном кэше изменилась, она не записывается сразу на диск, а помечается *грязной*. До момента ее физической записи на диск к странице могла быть применена одна или несколько операций логической записи. При каждой логической операции записи в кэш журнала, который записывает изменения, добавляется запись журнала транзакций. Записи журнала должны быть перенесены на диск до того, как соответствующая «грязная» страница будет удалена из буферного кэша и записана на диск. Заключается в том, что процесс контрольных точек производит периодический просмотр буферного кэша на наличие буферов со страницами определенной базы данных и запись всех «грязных» страниц на диск. Контрольные точки экономят время во время последующего восстановления при помощи создания точки, в которой все «грязные» страницы гарантированно записываются на диск.  
  
 Запись измененной страницы данных из буферного кэша на диск называется сбросом страницы на диск. [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] Имеет логику, которая предотвращает запись на диск "грязной" страницы до записи на него связанной записи журнала. Содержимое журнала записывается на диск при сбросе буферов журнала.  Это происходит при фиксации транзакции или заполнении буферов журнала.  
  
##  <a name="transaction-log-backups"></a><a name="Backups"></a> Резервные копии журналов транзакций  
 Этот раздел содержит основные понятия о создании резервной копии и восстановлении журналов транзакций. В рамках модели полного восстановления или восстановления с неполным протоколированием для восстановления данных важно регулярно создавать резервные копии журнала транзакций (*резервные копии журнала*). Можно создать резервную копию журнала во время выполнения полного резервного копирования. Дополнительные сведения о моделях восстановления см. в статье [Резервное копирование и восстановление баз данных SQL Server](../relational-databases/backup-restore/back-up-and-restore-of-sql-server-databases.md).  
  
 Перед созданием первой резервной копии журнала необходимо создать полную резервную копию данных, например резервную копию базы данных или первую в наборе резервную копию файлов. Восстановить базу данных исключительно из резервных копий файлов может оказаться довольно сложно. Поэтому рекомендуется начинать резервирование с создания полной резервной копии базы данных. После этого необходимо регулярное создание резервных копий журнала транзакций. Это не только уменьшит вероятность потери данных, но и даст возможность производить усечение журнала транзакций. Обычно он усекается после каждого обычного резервного копирования журналов,  
  
> [!IMPORTANT]
> Рекомендуем создавать резервные копии журналов с достаточной периодичностью в соответствии с вашими бизнес-требованиями, в особенности касающимися устойчивости к потере данных, что может произойти из-за повреждения хранилища журналов. Частота создания резервных копий журнала зависит от степени толерантности к возможности потери данных и от того, какое количество резервных копий журнала получится хранить и в потенциале восстанавливать, а также каким количеством управлять. При реализации стратегии восстановления и, в частности, периодичности резервного копирования журнала, определите необходимое [целевое время](https://wikipedia.org/wiki/Recovery_time_objective) и [целевую точку](https://wikipedia.org/wiki/Recovery_point_objective) восстановления.
> Возможно, создания резервных копий журналов один раз в 15-30 минут может оказаться достаточно. Если предприятию необходимо минимизировать вероятность потери данных, следует увеличить частоту создания резервных копий журнала. Более частое создание резервных копий журнала предоставляет преимущество за счет более частого усечения журнала, результатом которого является меньший размер файлов журнала.  
  
> [!IMPORTANT]
> Чтобы ограничить число резервных копий журналов, которые требуется восстановить, важно периодически создавать резервные копии данных. Например, можно запланировать еженедельное создание полной резервной копии базы данных и ежедневное создание разностных резервных копий.  
> Опять же, при реализации стратегии восстановления и, в частности, периодичности полного и разностного резервного копирования базы данных, определите необходимое [целевое время](https://wikipedia.org/wiki/Recovery_time_objective) и [целевую точку](https://wikipedia.org/wiki/Recovery_point_objective) восстановления.

Дополнительные сведения о создании резервных копий журналов транзакций см. в разделе [Резервные копии журналов транзакций (SQL Server)](../relational-databases/backup-restore/transaction-log-backups-sql-server.md).
  
### <a name="the-log-chain"></a>Цепочка журналов  
 Непрерывная последовательность резервных копий журналов называется *цепочкой журналов*. Цепочка журналов начинается с полной резервной копии базы данных. Обычно новая цепочка журналов начинается, только когда создается первая резервная копия базы данных или после переключения модели восстановления с простой на полную или на модель с неполным протоколированием. Существующая цепочка журналов остается без изменений, если не выбрана перезапись существующих наборов резервных копий при создании резервной копии базы данных целиком. Сохраняя неизменность цепочки журналов, базу данных можно восстановить из любой резервной копии полной базы данных в любом наборе носителей и из всех последующих резервных копий журналов до точки восстановления. Точка восстановления может быть концом последней резервной копии журналов или определенной точкой восстановления в любой из резервных копий журналов. Дополнительные сведения см. в разделе [Резервные копии журналов транзакций (SQL Server)](../relational-databases/backup-restore/transaction-log-backups-sql-server.md).  
  
 Чтобы восстановить базу данных на момент точки сбоя, нужна неповрежденная цепочка журналов. Непрерывная последовательность резервных копий журналов должна следовать до точки сбоя. Точка начала этой последовательности зависит от типа восстанавливаемой резервной копии: резервная копия базы данных, частичная резервная копия или резервная копия файлов. В случае резервной копии базы данных или частичной резервной копии последовательность резервных копий журнала должна начинаться от конца резервной копии базы данных или частичной резервной копии. В наборе резервных копий файлов последовательность резервных копий журналов должна следовать от начала полного набора резервных копий файлов. Дополнительные сведения см. в разделе [Применение резервных копий журналов транзакций (SQL Server)](../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md).  
  
### <a name="restore-log-backups"></a>Восстановление резервных копий журнала  
 Восстановление резервной копии журналов выполняет накат изменения, которые записаны в журнале транзакций, для воссоздания точного состояния базы данных на момент начала операции резервного копирования журнала. При восстановлении базы данных необходимо восстанавливать резервные копии журналов, которые были созданы после создания восстановленной полной резервной копии или с начала первой восстановленной резервной копии файлов. Обычно после восстановления последней резервной копии данных или разностной резервной копии необходимо произвести восстановление серии резервных копий журналов до точки восстановления. Затем производится восстановление базы данных. При этом откатываются все незавершенные на момент восстановления транзакции, и база данных переводится в режим «в сети». После восстановления базы данных нельзя более восстанавливать резервные копии. Дополнительные сведения см. в разделе [Применение резервных копий журналов транзакций (SQL Server)](../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md).  

## <a name="checkpoints-and-the-active-portion-of-the-log"></a>Контрольные точки и активная часть журнала  

При достижении контрольных точек измененные страницы данных записываются из буферного кэша текущей базы данных на диск. Это сводит к минимуму активную часть журнала, которую приходится обрабатывать при полном восстановлении базы данных. Во время полного восстановления базы данных выполняются следующие действия.

* Накат записанных в журнал изменений, не записанных на диск до остановки системы.
* Откат всех изменений, связанных с незавершенными транзакциями, такими как транзакции, для которых в журнале нет записи COMMIT или ROLLBACK.

### <a name="checkpoint-operation"></a>Функционирование контрольной точки

Контрольная точка выполняет в базе данных следующее.

* Записывает в файл журнала запись, отмечающую начало контрольной точки.
* Сохраняет данные, записанные для контрольной точки в цепи записей журнала контрольной точки.  
 
    Одним из элементов данных, регистрируемых в записях контрольной точки, является номер LSN первой записи журнала, при отсутствии которой успешный откат в масштабе всей базы данных невозможен. Такой номер LSN называется минимальным номером LSN восстановления (MinLSN). Номер MinLSN является наименьшим значением из: 

    * номера LSN начала контрольной точки;
    * номера LSN начала старейшей активной транзакции;
    * номера LSN начала старейшей транзакции репликации, которая еще не была доставлена базе данных распространителя. 

    Записи контрольной точки содержат также список активных транзакций, изменивших базу данных.

* Если база данных использует простую модель восстановления, помечает для повторного использования пространство, предшествующее номеру MinLSN. 
* Записывает все измененные страницы журналов и данных на диск.
* Записывает в файл журнала запись, отмечающую конец контрольной точки.
* Записывает в страницу загрузки базы данных номер LSN начала соответствующей цепи.

#### <a name="activities-that-cause-a-checkpoint"></a>Действия, приводящие к срабатыванию контрольных точек

Контрольные точки срабатывают в следующих ситуациях.

* При явном выполнении инструкции CHECKPOINT. Контрольная точка срабатывает в текущей базе данных соединения.
* При выполнении в базе данных операции с минимальной регистрацией, например при выполнении операции массового копирования для базы данных, на которую распространяется модель восстановления с неполным протоколированием. 
* При добавлении или удалении файлов баз данных с использованием инструкции ALTER DATABASE.
* При остановке экземпляра SQL Server инструкцией SHUTDOWN или при остановке службы SQL Server (MSSQLSERVER). И в том, и в другом случае будет создана контрольная точка для каждой базы данных на экземпляре SQL Server.
* Экземпляр SQL Server периодически создает для каждой базы данных автоматические контрольные точки с целью сократить время восстановления базы данных.
* При создании резервной копии базы данных.
* При выполнении действия, требующего отключения базы данных. Примерами могут служить присвоение параметру AUTO_CLOSE значения ON и закрытие последнего соединения пользователя с базой данных или изменение параметра базы данных, требующее перезапуска базы данных.

### <a name="automatic-checkpoints"></a>Автоматические контрольные точки

Ядро СУБД SQL Server создает автоматические контрольные точки. Интервал между автоматическими контрольными точками определяется на основе использованного места в журнале и времени, прошедшего с момента создания последней контрольной точки. Интервал времени между автоматическими контрольными точками колеблется в широких пределах и может быть довольно длительным, если база данных изменяется редко. При крупномасштабных изменениях данных частота автоматических контрольных точек может быть гораздо выше.

Используйте параметр конфигурации сервера **recovery interval** , чтобы вычислить интервал между автоматическими контрольными точками для всех баз данных на экземпляре сервера. Значение этого параметра определяет максимальное время, отводимое ядру СУБД на восстановление базы данных при перезапуске системы. Ядро СУБД оценивает число записей журнала, которые оно может обработать за время **recovery interval** в ходе операции восстановления. 

Кроме того, интервал между автоматическими контрольными точками зависит от модели восстановления, как показано ниже.

* Если применяется полная модель восстановления или модель восстановления с неполным протоколированием, то автоматическая контрольная точка создается каждый раз, когда число записей в журнале достигает значения, определенного ядром СУБД в качестве предельного количества записей, которое оно может обработать за время, заданное параметром recovery interval.
* Если используется простая модель восстановления базы данных, автоматическая контрольная точка создается каждый раз, когда число записей в журнале достигает меньшего из двух предельных условий: 

    * журнал заполняется на 70 процентов;
    * число записей в журнале достигает значения, определенного ядром СУБД в качестве количества записей, которое оно может обработать за время, заданное параметром recovery interval.

Информацию о настройке интервала восстановления см. в статье [Настройка параметра конфигурации сервера recovery interval](../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md).

> [!TIP]  
> Параметр расширенной настройки SQL Server, -k, позволяет администратору баз данных регулировать поведение ввода-вывода контрольной точки с учетом скорости обработки подсистемой ввода-вывода некоторых типов контрольных точек. Параметр настройки -k применяется к автоматическим контрольным точкам и любым не отрегулированным иным способом контрольным точкам. 
 
Если используется простая модель восстановления базы данных, то при срабатывании автоматических контрольных точек неиспользуемая часть журнала транзакций удаляется. Однако при использовании модели полного восстановления или модели восстановления с неполным протоколированием журнал в результате срабатывания автоматических контрольных точек не усекается. Дополнительные сведения см. в статье [Журнал транзакций](../relational-databases/logs/the-transaction-log-sql-server.md). 

Инструкция CHECKPOINT теперь поддерживает необязательный аргумент checkpoint_duration, определяющий время (в секундах), отводимое контрольным точкам на завершение. Дополнительные сведения см. в статье [CHECKPOINT](../t-sql/language-elements/checkpoint-transact-sql.md).

### <a name="active-log"></a>активным журналом

Часть файла журнала, начинающаяся с номера MinLSN и заканчивающаяся последней зафиксированной записью, называется активной частью журнала или "активным журналом". Этот раздел журнала необходим для выполнения полного восстановления базы данных. Ни одна часть активного журнала не может быть усечена. Все записи журнала до номера MinLSN должны быть удалены из частей журнала.

На следующем рисунке изображена упрощенная схема журнала завершения транзакций, содержащего две активные транзакции. Записи контрольных точек были сжаты в одну запись.

![Показывает конец журнала транзакций с двумя активными транзакциями и сжатой записью контрольной точки](../relational-databases/media/active-log.png) 

Последней записью в журнале транзакций является запись с номером LSN, равным 148. На момент обработки записанной контрольной точки с номером LSN 147 транзакция 1 уже зафиксирована и единственной активной транзакцией является транзакция 2. В результате первая запись журнала, созданная для транзакции 2, становится старейшей записью активной транзакции на момент последней контрольной точки. Таким образом, номером MinLSN становится номер LSN, равный 142 и соответствующий записи начала транзакции 2.

### <a name="long-running-transactions"></a>Продолжительные транзакции
Активный журнал должен включать в себя все элементы всех незафиксированных транзакций. Приложение, инициирующее транзакцию и не выполняющее ее фиксацию или откат, препятствует [!INCLUDE[ssde_md](../includes/ssde_md.md)] продвигать MinLSN. Это может привести к проблемам двух типов.

* Если система будет выключена после того, как транзакцией было выполнено много незафиксированных изменений, этап восстановления при последующем перезапуске может занять гораздо больше времени, чем задано параметром **recovery interval** .
* Журнал может достичь очень большого объема, потому что после номера MinLSN усечь его нельзя. Это справедливо даже в том случае, если используется простая модель восстановления, когда журнал транзакций обычно усекается при каждой автоматической контрольной точке.

Начиная с [!INCLUDE[sql-server-2019](../includes/sssqlv15-md.md)] и в [!INCLUDE[ssSDSfull](../includes/sssdsfull-md.md)], восстановления длительных транзакций и описанных выше проблем можно избежать с помощью [ускоренного восстановления базы данных](../relational-databases/backup-restore/restore-and-recovery-overview-sql-server.md#adr).  

### <a name="replication-transactions"></a>Транзакции репликации
Агент чтения журнала следит за журналом транзакций всех баз данных, на которых настроена репликация транзакций, и копирует отмеченные для репликации транзакции из журнала транзакций в базу данных распространителя. Активный журнал должен содержать все транзакции, отмеченные для репликации, но еще не доставленные базе данных распространителя. Если эти транзакции не реплицировать в допустимый срок, усечение журнала может оказаться невозможным. Дополнительные сведения см. в статье [Репликация транзакций](../relational-databases/replication/transactional/transactional-replication.md).

## <a name="see-also"></a>См. также раздел 
Мы рекомендуем следующие статьи и книги, которые содержат дополнительные сведения о журнале транзакций и рекомендации по управлению журналами.  
  
[Журнал транзакций (SQL Server)](../relational-databases/logs/the-transaction-log-sql-server.md)    
[Управление размером файла журнала транзакций](../relational-databases/logs/manage-the-size-of-the-transaction-log-file.md)   
[Резервные копии журналов транзакций (SQL Server)](../relational-databases/backup-restore/transaction-log-backups-sql-server.md)   
[Контрольные точки базы данных (SQL Server)](../relational-databases/logs/database-checkpoints-sql-server.md)   
[Настройка интервала восстановления в конфигурации сервера](../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md)    
[Ускоренное восстановление базы данных](../relational-databases/backup-restore/restore-and-recovery-overview-sql-server.md#adr)       
[sys.dm_db_log_info (Transact-SQL)](../relational-databases/system-dynamic-management-views/sys-dm-db-log-info-transact-sql.md)   
[sys.dm_db_log_space_usage (Transact-SQL)](../relational-databases/system-dynamic-management-views/sys-dm-db-log-space-usage-transact-sql.md)    
[Основные сведения о ведении журнала и восстановлении из резервных копий в SQL Server. Автор: Пол Рендел (Paul Randal)](/previous-versions/technet-magazine/dd392031(v=msdn.10))    
[Управление журналом транзакций SQL Server. Авторы: Тони Дэвис (Tony Davis) и Гейл Шоу (Gail Shaw)](https://www.simple-talk.com/books/sql-books/sql-server-transaction-log-management-by-tony-davis-and-gail-shaw/)  
  
