---
description: MSSQLSERVER_17892
title: MSSQLSERVER_17892
ms.custom: ''
ms.date: 08/20/2020
ms.prod: sql
ms.reviewer: ramakoni1, pijocoder, suresh-kandoth, Masha
ms.technology: supportability
ms.topic: language-reference
helpviewer_keywords:
- 17892 (Database Engine error)
ms.assetid: ''
author: suresh-kandoth
ms.author: ramakoni
ms.openlocfilehash: 59cf1ed10d71bf9813f2ce814d88e7f7d64b6b2e
ms.sourcegitcommit: ead0b8c334d487a07e41256ce5d6acafa2d23c9d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/22/2020
ms.locfileid: "92418787"
---
# <a name="mssqlserver_17892"></a>MSSQLSERVER_17892
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

## <a name="details"></a>Сведения

|attribute|Значение|
|---|---|
|Название продукта|SQL Server|
|Идентификатор события|17892|
|Источник события|MSSQLSERVER|
|Компонент|SQLEngine|
|Символическое имя|SRV_LOGON_FAILED_BY_TRIGGER|
|Текст сообщения|Не удалось выполнить вход для имени входа \<Login Name> из-за выполнения триггера.|
||

## <a name="explanation"></a>Пояснение

Ошибка 17892 возникает, когда код триггера входа невозможно выполнить успешно. [Триггеры входа](/sql/relational-databases/triggers/logon-triggers) вызывают срабатывание хранимых процедур в ответ на событие LOGON. Это событие вызывается при установке пользовательского сеанса с экземпляром [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Пользователю выводится сообщение об ошибке наподобие следующего:

> Сообщение 17892, уровень 14, состояние 1, сервер \<Server Name>, строка 1  
Не удалось выполнить вход для имени входа \<Login Name> из-за выполнения триггера.

## <a name="possible-causes"></a>Возможные причины

Проблема может возникнуть, если при выполнении кода триггера для данной учетной записи пользователя имеется ошибка. Вот некоторые возможные сценарии:

- Триггер пытается вставить данные в несуществующую таблицу.
- У имени входа нет разрешений на доступ к объекту, на который ссылается триггер входа.

## <a name="user-action"></a>Рекомендуемые действия

В зависимости от сценария можно использовать одно из описанных ниже решений.

- **Сценарий 1** . У вас есть доступ к открытому сеансу [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] с правами администратора.

  В этом случае можно предпринять корректирующее действие, необходимое для исправления кода триггера.

  - Пример 1: Если объект, на который ссылается код триггера, не существует, создайте его, чтобы триггер входа можно было выполнить успешно.

  - Пример 2. Если объект, на который ссылается код триггера, существует, но у пользователей нет разрешений на доступ к нему, предоставьте им необходимые права.  
  
  Кроме того, можно просто удалить или отключить триггер входа, чтобы пользователи могли по-прежнему входить в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].  

- **Сценарий 2** . Сеанс с правами администратора не открыт, но на сервере [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] включено выделенное административное соединение (DAC).

    В этом случае можно использовать соединение DAC, чтобы выполнить те же действия, что и в случае 1, так как триггеры входа не влияют на соединения DAC. Дополнительные сведения о соединении DAC см. в следующей статье: [Диагностическое соединение для администраторов баз данных](/sql/database-engine/configure-windows/diagnostic-connection-for-database-administrators).

    Чтобы проверить, включено ли соединение DAC в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], поищите в журнале ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] сообщение наподобие следующего:

    > 09.02.2020 16:17:44.150 Сервер. Установлена поддержка выделенных соединений с административными полномочиями для локального прослушивания по порту 1434.  

- **Сценарий 3** . На сервере не включено соединение DAC, и нет сеанса администратора [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].

    В такой ситуации единственным способом устранения проблемы является выполнение указанных ниже действий.
  
    1. Остановите [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и связанные службы.
    2. Запустите [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] из [командной строки](/previous-versions/sql/sql-server-2008-r2/ms180965(v=sql.105)) с использованием параметров запуска `-c`, `-m` и `-f`. Это приведет к отключению триггера входа и позволит выполнить те же действия по устранению проблемы, что и в **случае 1** выше.
  
        > [!NOTE]
        > Для описанной выше процедуры требуется *SA* или эквивалентная учетная запись администратора.
  
         Дополнительные сведения об этих и других параметрах запуска см. в следующей статье: [Параметры запуска службы Database Engine](/sql/database-engine/configure-windows/database-engine-service-startup-options).

## <a name="more-information"></a>Дополнительные сведения

Другой ситуацией, в которой происходит сбой триггеров входа, является использование функции `EVENTDATA`. Эта функция возвращает код XML и учитывает регистр.  Поэтому если вы создаете следующий триггер входа, намереваясь блокировать доступ по IP-адресу, может возникнуть проблема:

``` sql
 CREATE TRIGGER tr_logon_CheckIP  
 ON ALL SERVER  
 FOR LOGON  
 AS
 BEGIN
  IF IS_SRVROLEMEMBER ( 'sysadmin' ) = 1  
     BEGIN
         DECLARE @IP NVARCHAR ( 15 );  
         SET @IP = ( SELECT EVENTDATA ().value ( '(/EVENT_INSTANCE/ClientHost)[1]' , 'NVARCHAR(15)' ));  
         IF NOT EXISTS( SELECT IP FROM DBAWork.dbo.ValidIP WHERE IP = @IP )  
         ROLLBACK ;  
     END ;  
 END ;  
 GO
```

При копировании скрипта из Интернета пользователь не сохранил регистр в этой части триггера:

```sql
 SELECT EVENTDATA ().value ( '(/event_instance/clienthost)[1]' , 'NVARCHAR(15)' ));  
```

В результате функция `EVENTDATA` всегда возвращала значение **NULL** , и всем именам входа, эквивалентным SA, было отказано в доступе. В этом случае соединение DAC не включено, поэтому единственный возможный вариант — перезапустить сервер с приведенными выше параметрами запуска, чтобы удалить триггер.
