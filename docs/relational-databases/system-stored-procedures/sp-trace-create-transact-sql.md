---
description: Хранимая процедура sp_trace_create (Transact-SQL)
title: sp_trace_create (Transact-SQL) | Документация Майкрософт
ms.custom: ''
ms.date: 03/14/2017
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: system-objects
ms.topic: reference
f1_keywords:
- sp_trace_create_TSQL
- sp_trace_create
dev_langs:
- TSQL
helpviewer_keywords:
- sp_trace_create
ms.assetid: f3a43597-4c5a-4520-bcab-becdbbf81d2e
author: markingmyname
ms.author: maghan
ms.openlocfilehash: c63a724ad0b82a1a11145cc559ac52fc2d6f9cc3
ms.sourcegitcommit: 33f0f190f962059826e002be165a2bef4f9e350c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/30/2021
ms.locfileid: "99200620"
---
# <a name="sp_trace_create-transact-sql"></a>Хранимая процедура sp_trace_create (Transact-SQL)
[!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

  Создает определение трассировки. Новая трассировка будет находиться в остановленном состоянии.  
  
> [!IMPORTANT]  
>  [!INCLUDE[ssNoteDepFutureAvoid](../../includes/ssnotedepfutureavoid-md.md)] Вместо этого используйте расширенные события.  
  
 ![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)  
  
## <a name="syntax"></a>Синтаксис  
  
```  
  
sp_trace_create [ @traceid = ] trace_id OUTPUT   
          , [ @options = ] option_value   
          , [ @tracefile = ] 'trace_file'   
     [ , [ @maxfilesize = ] max_file_size ]  
     [ , [ @stoptime = ] 'stop_time' ]  
     [ , [ @filecount = ] 'max_rollover_files' ]  
```  
  
## <a name="arguments"></a>Аргументы  
`[ @traceid = ] trace_id` Номер, присвоенный [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] новой трассировке. Любое значение, предложенное пользователем, не будет учитываться. *trace_id* имеет **тип int** и значение по умолчанию NULL. Пользователь использует *trace_id* значение для определения, изменения и управления трассировкой, определенной этой хранимой процедурой.  
  
`[ @options = ] option_value` Задает параметры, заданные для трассировки. *option_value* имеет **тип int** и не имеет значения по умолчанию. Пользователи могут выбирать сочетания этих параметров путем указания их суммарного значения. Например, чтобы включить параметры TRACE_FILE_ROLLOVER и SHUTDOWN_ON_ERROR, укажите значение **6** для *option_value*.  
  
 В следующей таблице содержится список параметров, их значений и описаний.  
  
|Имя параметра|Значение параметра|Описание|  
|-----------------|------------------|-----------------|  
|TRACE_FILE_ROLLOVER|**2**|Указывает, что при достижении *max_file_size* текущий файл трассировки закрывается и создается новый файл. Все новые записи будут сохраняться в новый файл. Новый файл будет иметь то же имя, что и предыдущий, но в конец имени будет добавлено число, показывающее его порядковый номер. Например, если изначально трассировочный файл назывался filename.trc, то следующий трассировочный файл будет называться filename_1.trc, имя следующего трассировочного файла будет filename_2.trc и т. д.<br /><br /> По мере увеличения количества трассировочных файлов число, добавляемое в конец имени файла, будет также последовательно увеличиваться.<br /><br /> SQL Server использует значение по умолчанию *max_file_size* (5 МБ), если этот параметр задан без указания значения для *max_file_size*.|  
|SHUTDOWN_ON_ERROR|**4**|Указывает, что если трассировка не может быть записана в файл по какой-либо причине, SQL Server останавливается. Этот параметр полезен в случае проведения трассировок по проверке безопасности.|  
|TRACE_PRODUCE_BLACKBOX|**8**|Указывает, что запись последних 5 МБ трассировочных сведений, формируемых сервером, будет сохранена на сервере. Значение параметра TRACE_PRODUCE_BLACKBOX несовместимо со всеми другими.|  
  
`[ @tracefile = ] 'trace_file'` Указывает расположение и имя файла, в который будет записана трассировка. *trace_file* имеет тип **nvarchar (245)** и не имеет значения по умолчанию. *trace_file* может быть локальным каталогом (например, N ' C:\MSSQL\Trace\trace.trc ') или UNC-именем к общей папке или пути (N ' \\ \\ *имя_сервера* \\ *имя_общего_ресурса* \\ *Directory*\trace.trc ').  
  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] добавит расширение **TRC** ко всем именам файлов трассировки. Если указаны параметр TRACE_FILE_ROLLOVER и *max_file_size* , [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] создает новый файл трассировки, когда размер исходного файла трассировки увеличивается до максимального размера. Новый файл имеет то же имя, что и исходный файл, но добавляется _ *n* для обозначения последовательности, начиная с **1**. Например, если первый файл трассировки имеет имя **filename. trc**, второй файл трассировки называется **filename_1. trc**.  
  
 Если используется параметр TRACE_FILE_ROLLOVER, рекомендуется не использовать в имени исходного файла трассировки символы подчеркивания. Если используются символы подчеркивания, выполняются следующие действия.  
  
-   [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] не загружает автоматически или не предлагает загрузить файлы продолжения (если настроен любой из этих параметров переключения на файл продолжения).  
  
-   Функция fn_trace_gettable не загружает файлы продолжения (при указании с помощью аргумента *number_files* ), где исходное имя файла заканчивается символом подчеркивания и числовым значением. (Это не относится к подчеркиваниям и числам, которые автоматически добавляются, когда выполняется переключение на файл продолжения.)  
  
> [!NOTE]  
>  В качестве временного решения в обоих случаях можно переименовать файлы трассировки, исключив подчеркивания из имени исходного файла. Например, если исходный файл называется **my_trace. trc**, а файл продолжения имеет имя **my_trace_1. trc**, можно переименовать файлы в **митраце. trc** и **mytrace_1. trc** перед открытием файлов в [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] .  
  
 невозможно указать *trace_file* , если используется параметр TRACE_PRODUCE_BLACKBOX.  
  
`[ @maxfilesize = ] max_file_size` Указывает максимальный размер файла трассировки в мегабайтах (МБ). *max_file_size* имеет тип **bigint** и значение по умолчанию **5**.  
  
 Если этот параметр указан без параметра TRACE_FILE_ROLLOVER, трассировка прекратит запись в файл, если используемое дисковое пространство превышает объем, указанный в *max_file_size*.  
  
`[ @stoptime = ] 'stop_time'` Указывает дату и время, когда трассировка будет остановлена. *stop_time* имеет тип **DateTime** и значение по умолчанию NULL. Если указано значение NULL, трассировка будет работать до тех пор, пока не будет остановлена вручную или пока не остановится сервер.  
  
 Если указаны и *stop_time* , и *max_file_size* , а TRACE_FILE_ROLLOVER не указаны, то верхние значения трассировки при достижении указанного времени окончания или максимального размера файла. Если указаны *stop_time*, *max_file_size* и TRACE_FILE_ROLLOVER, трассировка останавливается в указанное время остановки, предполагая, что трассировка не заполняет диск.  
  
`[ @filecount = ] 'max_rollover_files'` Указывает максимальное количество файлов трассировки, которые должны поддерживаться с одним и тем же базовым именем файла. *MAX_ROLLOVER_FILES* имеет **тип int**, больше единицы. Этот аргумент имеет смысл только в случае, если указан параметр TRACE_FILE_ROLLOVER. Если указан *MAX_ROLLOVER_FILES* , [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] пытается поддерживать не более *MAX_ROLLOVER_FILES* файлов трассировки путем удаления самого старого файла трассировки перед открытием нового файла трассировки. [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] отслеживает возраст файлов трассировки, добавляя число в конец базового имени файла.  
  
 Например, если параметр *trace_file* указан как "к:\митраце", файл с именем "c:\ mytrace_123. trc" старше, чем файл с именем "c:\ mytrace_124. trc". Если *MAX_ROLLOVER_FILES* имеет значение 2, то SQL Server удаляет файл "c:\ mytrace_123. trc" перед созданием файла трассировки "c:\ mytrace_125. trc".  
  
 Обратите внимание, что [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] пытается удалить файл только один раз и не может удалить файл, используемый другим процессом. Поэтому, если другое приложение работает с файлами трассировки во время трассировки, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] может оставить эти файлы в файловой системе.  
  
## <a name="return-code-values"></a>Значения кода возврата  
 В следующей таблице описаны значения кодов, которые могут быть возвращены пользователю при завершении хранимой процедуры.  
  
|Код возврата|Описание|  
|-----------------|-----------------|  
|0|Нет ошибки.|  
|1|Неизвестная ошибка.|  
|10|Недопустимые параметры. Возвращается, если указанные параметры несовместимы.|  
|12|Файл не создан.|  
|13|Недостаточно памяти. Возвращается, когда для выполнения указанного действия недостаточно памяти.|  
|14|Недопустимое время останова. Возвращается, если указанное время останова уже прошло.|  
|15|Недопустимые аргументы. Возвращается, если пользователь ввел несовместимые аргументы.|  
  
## <a name="remarks"></a>Замечания  
 **sp_trace_create** — это [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] хранимая процедура, которая выполняет многие действия, ранее выполненные **xp_trace_ \* *_ расширенными хранимыми процедурами, доступными в более ранних версиях SQL Server. Используйте* вместо параметра _ sp_trace_create** :  
  
-   **xp_trace_addnewqueue**  
  
-   **xp_trace_setqueuecreateinfo**  
  
-   **xp_trace_setqueuedestination**  
  
 **sp_trace_create** создает только определение трассировки. Эта хранимая процедура не может быть использована для запуска или изменения трассировки.  
  
 Параметры всех хранимых процедур трассировки SQL (**sp_trace_xx**) строго типизированы. Если эти аргументы указываются с неправильными типами данных входных параметров, как указано в описании их аргументов, хранимая процедура возвратит ошибку.  
  
 Для **sp_trace_create** [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] учетная запись службы должна иметь разрешение на запись в папку файла трассировки. Если [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] учетная запись службы не является администратором на компьютере, где находится файл трассировки, необходимо явным образом предоставить [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] учетной записи службы разрешение на запись.  
  
> [!NOTE]  
>  Файл трассировки, созданный с помощью **sp_trace_create** , можно автоматически загрузить в таблицу с помощью системной функции **fn_trace_gettable** . Сведения об использовании этой системной функции см. в разделе [sys.fn_trace_gettable &#40;Transact-SQL&#41;](../../relational-databases/system-functions/sys-fn-trace-gettable-transact-sql.md).  
  
 Пример использования хранимых процедур трассировки см. в разделе [Создание трассировки (Transact-SQL)](../../relational-databases/sql-trace/create-a-trace-transact-sql.md).  
  
 **TRACE_PRODUCE_BLACKBOX** имеет следующие характеристики.  
  
-   Это продолжение трассировки. Значение по умолчанию *file_count* равно 2, но может быть переопределено пользователем с помощью параметра *filecount* .  
  
-   Значение по умолчанию *file_size* , как и для других трассировок, равно 5 МБ и может быть изменено.  
  
-   Не удалось задать имя файла. Файл будет сохранен как: **N '%склдир%\мсскл\дата\блаккбокс.ТРК '**  
  
-   В трассировке будут содержаться только следующие события и их столбцы.  
  
    -   **Запуск RPC**  
  
    -   **Начало пакета**  
  
    -   **Exception**  
  
    -   **Обратит**  
  
-   События или столбцы нельзя добавить или удалить из данной трассировки.  
  
-   Для данной трассировки нельзя указать фильтры.  
  
## <a name="permissions"></a>Разрешения  
 Пользователь должен иметь разрешение ALTER TRACE.  
  
## <a name="see-also"></a>См. также:  
 [sp_trace_generateevent &#40;Transact-SQL&#41;](../../relational-databases/system-stored-procedures/sp-trace-generateevent-transact-sql.md)   
 [Хранимая процедура sp_trace_setevent (Transact-SQL)](../../relational-databases/system-stored-procedures/sp-trace-setevent-transact-sql.md)   
 [sp_trace_setfilter (Transact-SQL)](../../relational-databases/system-stored-procedures/sp-trace-setfilter-transact-sql.md)   
 [Хранимая процедура sp_trace_setstatus (Transact-SQL)](../../relational-databases/system-stored-procedures/sp-trace-setstatus-transact-sql.md)   
 [Трассировка SQL](../../relational-databases/sql-trace/sql-trace.md)  
  
  
