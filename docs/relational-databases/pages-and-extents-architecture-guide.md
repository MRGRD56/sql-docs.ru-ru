---
description: Руководство по архитектуре страниц и экстентов
title: Руководство по архитектуре страниц и экстентов | Документация Майкрософт
ms.custom: ''
ms.date: 03/12/2019
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- page and extent architecture guide
- guide, page and extent architecture
ms.assetid: 83a4aa90-1c10-4de6-956b-7c3cd464c2d2
author: rothja
ms.author: jroth
monikerRange: '>=aps-pdw-2016||=azuresqldb-current||=azure-sqldw-latest||>=sql-server-2016||>=sql-server-linux-2017||=azuresqldb-mi-current'
ms.openlocfilehash: 22e1a4832e3ef02d2b596ecd0dd4af3a08a7ec6e
ms.sourcegitcommit: f29f74e04ba9c4d72b9bcc292490f3c076227f7c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/13/2021
ms.locfileid: "98171876"
---
# <a name="pages-and-extents-architecture-guide"></a>Руководство по архитектуре страниц и экстентов
[!INCLUDE[SQL Server Azure SQL Database Synapse Analytics PDW ](../includes/applies-to-version/sql-asdb-asdbmi-asa-pdw.md)]

Страница — основная единица хранения данных в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]. Экстент — это набор из 8 физически непрерывных страниц. Экстенты помогают эффективно управлять страницами. В этом руководстве описаны структуры данных, используемые для управления страницами и экстентами во всех версиях SQL Server. Понимание архитектуры страниц и экстентов важно для проектирования и разработки эффективных баз данных.

## <a name="pages-and-extents"></a>Страницы и экстенты

Основной единицей хранилища данных в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] является страница. Место на диске, предоставляемое для размещения файла данных (файл MDF или NDF) в базе данных, логически разделяется на страницы с непрерывным перечислением от 0 до n. Дисковые операции ввода-вывода выполняются на уровне страницы. Это означает, что SQL Server считывает или записывает целые страницы данных.

Экстент — это коллекция, состоящая из восьми физически непрерывных страниц; они используются для эффективного управления страницами. Все страницы организуются в экстенты.

### <a name="pages"></a>Страницы

Рассмотрим в качестве примера обычную бумажную книгу, содержимое которой написано на страницах. Аналогичным образом, в SQL Server все строки данных записываются на страницы. Все страницы книги имеют одинаковый физический размер. То же можно сказать и про страницы данных в SQL Server, каждая из которых имеет размер 8 килобайт. Основную часть книги занимают страницы с данными, то есть собственно с содержимым книги. При этом на некоторых страницах могут находиться метаданные о содержимом, например оглавление или алфавитный указатель. И в этом наблюдается сходство с SQL Server, где большая часть страниц содержит фактические строки данных, сохраняемые пользователями. Они называются страницами данных, а в некоторых случаях страницами текста или изображений. На страницах индексов содержатся ссылки на индексы, указывающие на расположение данных. Кроме того, предусмотрены системные страницы, на которых хранятся различные метаданные, относящиеся к организации данных (страницы PFS, GAM, SGAM, IAM, DCM, BCM). В следующей таблице приводятся различные типы страниц с соответствующим им описанием.

Еще раз напомним, что размер страницы в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] составляет 8 КБ. Это значит, что в одном мегабайте базы данных [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] содержится 128 страниц. Каждая страница начинается с 96-байтового заголовка, который используется для хранения системных данных о странице. Эти данные включают номер страницы, тип страницы, объем свободного места на странице и идентификатор единицы распределения объекта, которому принадлежит страница.

В следующей таблице представлены типы страниц, используемые в файлах данных базы данных [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].

|Тип страницы | Содержимое |
|-------|-------|
|Данные |Строки со всеми данными, за исключением типов text, ntext, image, nvarchar(max), varchar(max), varbinary(max) и xml, если для текста в строке установлено значение ON. |
|Индекс |Содержимое индекса. |
|Текст/изображение |Типы данных больших объектов: text, ntext, image, nvarchar(max), varchar(max), varbinary(max) и данные xml. <br> Столбцы переменной длины, когда размер строки данных превышает 8 КБ: varchar, nvarchar, varbinary и sql_variant. |
|Глобальная карта распределения, общая глобальная карта распределения |Сведения о том, размещены ли экстенты. |
|Свободное место на страницах (PFS) |Сведения о размещении страниц и доступном на них свободном месте. |
|Карта распределения индекса |Сведения об экстентах, используемых таблицей или индексом для единицы распределения. |
|Карта массовых изменений данных |Сведения об экстентах, измененных массовыми операциями со времени последнего выполнения инструкции BACKUP LOG для единицы распределения. |
|Карта изменений для разностной резервной копии |Сведения об экстентах, измененных с момента последнего выполнения инструкции BACKUP DATABASE для единицы распределения. |

> [!NOTE]
> Файлы журнала не содержат страниц, в них содержится последовательность записей журнала.

Строки данных заносятся на страницу последовательно, сразу же после заголовка. Таблица смещения строк начинается в конце страницы; каждая таблица смещения строк содержит одну запись для каждой строки на странице. Каждая запись смещения строк регистрирует, насколько далеко от начала страницы находится первый байт строки. Таким образом, функция таблицы смещения строк — помочь SQL Server быстро находить строки на странице. Записи в таблице смещения строк находятся в обратном порядке относительно последовательности строк на странице.

![page_architecture](../relational-databases/media/page-architecture.gif)

#### <a name="large-row-support"></a>Поддержка больших строк  

Строка не может находиться на нескольких страницах, однако часть строки может быть перемещена на другую страницу, поэтому строка действительно может быть очень большой. Максимальный объем данных и служебного кода, содержащихся в одной строке на странице, составляет 8060 байт (8 КБ). Однако сюда не включены данные, хранимые в типе страницы "Текст/изображение". 

Это ограничение смягчается для таблиц, содержащих столбцы varchar, nvarchar, varbinary или sql_variant. Когда общий размер строк всех фиксированных и переменных столбцов в таблице превышает предел в 8060 байт, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] динамически перемещает один или более столбцов переменной длины на страницы в единице распределения ROW_OVERFLOW_DATA, начиная со столбца с наибольшей шириной. 

Это действие выполняется всегда, когда в результате операций вставки или обновления общий размер строки выходит за предел в 8060 байт. Когда происходит перемещение столбца на страницу в единице распределения ROW_OVERFLOW_DATA, 24-байтовый указатель на исходной странице в единице распределения IN_ROW_DATA сохраняется. Если при последующей выполняемой операции размер строки уменьшается, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] динамически перемещает столбцы обратно на исходную страницу данных. 

##### <a name="row-overflow-considerations"></a>Замечания относительно переполнения строк 

Как упоминалось ранее, строка не может располагаться на нескольких страницах и может переполниться, если суммарный размер полей типа данных переменной длины превышает ограничение в 8060 байт. Для иллюстрации можно создать таблицу с двумя столбцами: varchar (7000) и varchar (2000). По отдельности ни один из столбцов не превышает 8060 байт, но вместе они могут превысить лимит, если заполнена вся ширина каждого столбца. SQL Server может динамически перемещать столбец переменной длины varchar (7000) на страницы в единице распределения ROW_OVERFLOW_DATA. При объединении столбцов varchar, nvarchar, varbinary, sql_variant или столбцов определяемого пользователем типа данных CLR, длина которых превышает 8 060 байт на строку, необходимо учитывать следующее:
-  Перемещение больших записей на другую страницу осуществляется динамически, по мере удлинения записей при операциях обновления. Операции обновления, которые укорачивают записи, могут привести к возвращению записей на исходную страницу в единице распределения IN_ROW_DATA. Выполнение запросов и других операций выборки, например сортировки и соединения, в отношении больших записей с превышающими размер страницы данными строки, увеличивает время обработки, поскольку эти записи обрабатываются синхронно, а не асинхронно.   
   Поэтому при построении таблиц с несколькими столбцами varchar, nvarchar, varbinary, sql_variant или столбцами определяемого пользователем типа данных CLR следует учитывать процент строк, в которых возможно переполнение, и вероятную частоту запросов данных переполнения. Если ожидаются частые запросы по многим превышающим размер страницы данным строки, рекомендуется нормализовать таблицу таким образом, чтобы некоторые столбцы переместились в другую таблицу. После этого запросы по таблице можно будет выполнять с помощью асинхронной операции JOIN. 
-  Длина отдельных столбцов varchar, nvarchar, varbinary, sql_variant и столбцов определяемого пользователем типа данных CLR по-прежнему не должна превышать 8 000 байт. И только общая их длина может выходить за предел в 8 060 байт на строку таблицы.
-  Сумма столбцов данных других типов, включая char и nchar, не должна превышать 8 060 байт на строку. Данные больших объектов также могут выходить за предел в 8 060 байт на строку. 
-  Ключ кластеризованного индекса не может включать в себя столбцы varchar, для которых существуют данные в единице размещения ROW_OVERFLOW_DATA. Если кластеризованный индекс создается для столбца типа varchar и существующие данные располагаются в единице размещения IN_ROW_DATA, то все последующие операции вставки или обновления для данного столбца, выталкивающие данные за пределы строки, будут завершаться ошибкой. Дополнительные сведения о единицах распределения см. в разделе "Организация таблиц и индексов".
-  Пользователь может включить столбцы, которые содержат превышающие размер страницы данные строки, в качестве ключевых или неключевых столбцов некластеризованного индекса.
-  Максимальный размер записи в таблицах, в которых используются разреженные столбцы, составляет 8 018 байт. Если суммарная величина преобразуемых данных и существующих данных записи превышает 8 018 байт, то возвращается ошибка [MSSQLSERVER ERROR 576](../relational-databases/errors-events/database-engine-events-and-errors.md). Если выполняется преобразование разреженных и неразреженных типов, то ядро СУБД хранит копию текущих данных записи. В связи с этим удваивается количества места, которое требуется для хранения записи.
-  Для получения сведений о таблицах или индексах, которые могут содержать превышающие размер страницы данные строки, используется функция динамического управления [sys.dm_db_index_physical_stats](../relational-databases/system-dynamic-management-views/sys-dm-db-index-physical-stats-transact-sql.md).

### <a name="extents"></a>Экстенты 

Экстенты являются основными единицами организации пространства. Экстент состоит из восьми непрерывных страниц или 64 КБ. Это означает, что в одном мегабайте базы данных SQL Server содержится 16 экстентов.

В [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] есть два типа экстентов. 

* **Однородные** экстенты принадлежат одному объекту, и все восемь страниц экстента может использовать только этот владеющий объект.
* **Смешанные** экстенты могут находиться в общем пользовании максимум у восьми объектов. Каждая из восьми страниц в экстенте может находиться во владении разных объектов.

![Однородные и смешанные экстенты](../relational-databases/media/extents.gif)

До и включая [!INCLUDE[ssSQL14](../includes/sssql14-md.md)], [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] не размещает целые экстенты в таблицы с небольшим объемом данных. Новая таблица или индекс обычно выделяет страницы из смешанных экстентов. При увеличении размера таблицы или индекса до восьми страниц эти таблица или индекс переходят на использование однородных экстентов для последовательных единиц распределения. При создании индекса для существующей таблицы, в которой содержится достаточно строк, чтобы сформировать восемь страниц в индексе, все единицы распределения для индекса находятся в однородных экстентах. 

Начиная с [!INCLUDE[ssSQL15](../includes/sssql16-md.md)], по умолчанию для большей части распределений в пользовательской базе данных и базе данных tempdb используются однородные экстенты. Это не касается распределений, принадлежащих первым восьми страницам [цепочки IAM](#IAM). Для распределений баз данных master и msdb, а также шаблона базы данных сохраняется предыдущее поведение. 

> [!NOTE]
> До и включая [!INCLUDE[ssSQL14](../includes/sssql14-md.md)], флаг трассировки 1118 может использоваться для изменения распределения по умолчанию таким образом, чтобы всегда использовать однородные экстенты. Дополнительные сведения об этом флаге трассировки см. в статье [DBCC TRACEON — флаги трассировки (Transact-SQL)](../t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql.md).   
>   
> Начиная с [!INCLUDE[ssSQL15](../includes/sssql16-md.md)] возможности, предоставляемые TF 1118, автоматически включаются для tempdb и всех пользовательских баз данных. Для пользовательских баз данных этим поведением управляет параметр `SET MIXED_PAGE_ALLOCATION` команды `ALTER DATABASE` с присвоенным значением OFF (по умолчанию), и флаг трассировки 1118 не действует. Дополнительные сведения см. в статье [Параметры ALTER DATABASE SET (Transact-SQL)](../t-sql/statements/alter-database-transact-sql-set-options.md).

Начиная с [!INCLUDE[ssSQL11](../includes/sssql11-md.md)], системная функция `sys.dm_db_database_page_allocations` может передавать сведения о распределении страниц для базы данных, таблицы, индекса и секции.

> [!IMPORTANT]
> Системная функция `sys.dm_db_database_page_allocations` не задокументирована и может быть изменена. Совместимость не гарантируется. 

Начиная с [!INCLUDE[sql-server-2019](../includes/sssqlv15-md.md)], доступна системная функция [sys.dm_db_page_info](../relational-databases/system-dynamic-management-views/sys-dm-db-page-info-transact-sql.md), которая возвращает сведения о странице в базе данных. Эта функция возвращает одну строку, которая содержит данные заголовка страницы, включая object_id, index_id и partition_id. В большинстве случаев эта функция заменяет потребность в использовании `DBCC PAGE`.

## <a name="managing-extent-allocations-and-free-space"></a>Управление размещением экстента и свободным местом 

Структуры данных [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], управляющие размещением экстента и отслеживанием свободного места, обладают относительно простой структурой. Учтите следующие преимущества: 

* Сведения о свободном месте плотно упакованы, поэтому эти данные содержат относительно небольшое количество страниц.   
  Это приводит к увеличению скорости из-за уменьшения необходимых операций чтения диска для получения сведений о размещении. Также увеличивается вероятность того, что страницы размещения будут оставаться в памяти и повторных операций чтения не потребуется. 

* Большая часть сведений о размещении не связана по цепочке друг с другом. Это упрощает управление сведениями о размещении.    
  Каждое действие по размещению или освобождению страницы может выполняться быстро. Это сокращает состязание между одновременными задачами размещения и освобождения страниц. 

### <a name="managing-extent-allocations"></a>Управление размещением экстента

[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] использует два типа карт распределения для записи размещения экстентов. 

- **Глобальная карта распределения (GAM)**    
  На GAM-страницах записано, какие экстенты были размещены. В каждой карте GAM содержится 64 000 экстентов или почти 4 ГБ данных. В карте GAM приходится по одному биту на каждый экстент в покрываемом им интервале. Если бит равен 1, то экстент свободен; если бит равен 0, то экстент размещен. 

- **Общая глобальная карта распределения (SGAM)**    
  На SGAM-страницах записано, какие экстенты в текущий момент используются в качестве смешанных экстентов и имеют как минимум одну неиспользуемую страницу. В каждой карте SGAM содержится 64 000 экстентов или почти 4 ГБ данных. В карте SGAM приходится по одному биту на каждый экстент в покрываемом им интервале. Если бит равен 1, то экстент используется как смешанный экстент и имеет свободную страницу. Если бит равен 0, то экстент не используется как смешанный экстент, или он является смешанным экстентом, но все его страницы используются. 

Каждый экстент обладает следующими наборами битовых шаблонов в картах GAM и SGAM, основанными на его текущем использовании. 

|Текущее использование экстента | Настройка битов карты GAM | Настройка битов карты SGAM |
|---------|----------|------| 
|Свободно, в текущий момент не используется |1 |0 |
|Однородный экстент или заполненный смешанный экстент |0 |0 |
|Смешанный экстент со свободными страницами |0 |1 |
 
Это дает простые алгоритмы управления экстентами страниц. 
-   Для выделения однородного экстента компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] производит на карте GAM поиск бита 1 и заменяет его на бит 0. 
-   Для поиска смешанного экстента со свободными страницами компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] производит поиск на карте SGAM бита 1. 
-   Для выделения смешанного экстента компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] производит на карте GAM поиск бита 1, заменяет его на бит 0, а затем устанавливает значение соответствующего бита на карте SGAM равным 1. 
-   Для освобождения экстента компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] устанавливает бит GAM равным 1, а соответствующий бит SGAM равным 0. Внутренние алгоритмы, которые на самом деле используются компонентом [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)], более сложны, чем это описано в данной статье, так как компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] распределяет данные в базе данных равномерно. Однако даже настоящие алгоритмы упрощаются из-за того, что отпадает необходимость управления цепочками сведений о размещении экстентов.

### <a name="tracking-free-space"></a>Отслеживание свободного места

Страницы **Page Free Space (PFS)** записывают состояние размещения каждой страницы, информацию о том, была ли размещена конкретная страница, а также количество свободного места на каждой странице. В PFS на каждую страницу приходится по одному байту, хранящему информацию о том, была ли страница размещена или нет, а если была — то пустая она, или ее заполнение находится в промежутке от 1 до 50 процентов, от 51 до 80 процентов, от 81 до 95 процентов или от 96 до 100 процентов.

После размещения экстента на объект компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] использует PFS-страницы для записи информации о том, какие страницы в экстенте размещены, а какие свободны. Эти сведения используются компонентом [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] при размещении новой страницы. Количеством свободного места на странице можно управлять только в случае кучи и страниц Text/Image. Это используется при поиске страницы компонентом [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)], обладающей свободным местом, достаточным для сохранения в ней новой добавляемой строки. Для индексов не требуется, чтобы отслеживалось свободное место на странице, так как место, в которое будет вставляться новая строка, назначается значениями ключа индекса.

В файл данных добавляется новая страница PFS, GAM или SGAM для каждого дополнительного диапазона, который отслеживается. Таким образом, после первой PFS-страницы находится новая PFS-страница с 8088 страницами, а также дополнительные PFS-страницы с последующими интервалами в 8088 страниц. Допустим, страница с идентификатором 1 является PFS-страницей, страница с идентификатором 8088 является PFS-страницей, страница с идентификатором 16176 является PFS-страницей и т. д. После первой GAM-страницы имеется новая GAM-страница с 64 000 экстентов, которая отслеживает 64 000 экстентов за ней. Последовательность продолжится с интервалом в 64 000. Аналогичным образом после первой SGAM-страницы стоит новая SGAM-страница с 64 000 экстентов, и SGAM-страницы добавляются каждые 64 000 экстентов. На следующей иллюстрации показана последовательность страниц, используемая компонентом [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] для выделения экстентов и управления ими.

![manage_extents](../relational-databases/media/manage-extents.gif)

## <a name="managing-space-used-by-objects"></a><a name="IAM"></a> Управление дисковым пространством, используемым объектами 

Страница **карты распределения индекса (Index Allocation Map, IAM)** сопоставляет экстенты в 4-гигабайтном фрагменте файла базы данных с единицей размещения, использующей этот фрагмент. Единица распределения может иметь один из трех типов.

- IN_ROW_DATA   
    Содержит секцию кучи или индекса.

- LOB_DATA   
   Содержит типы данных больших объектов (LOB), включая XML, VARBINARY(max) и VARCHAR(max).

- ROW_OVERFLOW_DATA   
   Содержит данные переменной длины, которые хранятся в столбцах VARCHAR, NVARCHAR, VARBINARY и SQL_VARIANT и превышают допустимый размер строки в 8060 байт. 

В каждой секции кучи или индекса содержится по крайней мере одна единица распределения IN_ROW_DATA. Кроме того, в зависимости от схемы кучи или индекса, там могут содержаться единицы распределения LOB_DATA или ROW_OVERFLOW_DATA.

IAM-страница охватывает в файле диапазон 4 ГБ, то есть столько же, сколько и GAM- или SGAM-страница. Если в единице распределения содержатся экстенты из более чем одного файла или фрагмент файла размером более 4 ГБ, то несколько IAM-страниц будут объединены в IAM-цепочку. Таким образом, каждая единица распределения содержит как минимум одну IAM-страницу для каждого из файлов, в которых содержатся ее экстенты. Для файла может существовать несколько IAM-страниц, если размер экстентов файла, назначенного единице распределения, превышает объем, который может быть записан в одной IAM-странице. 

![iam_pages](../relational-databases/media/iam-pages.gif)

IAM-страницы для каждой единицы распределения выделяются по необходимости и располагаются в файле в случайном порядке. Системное представление `sys.system_internals_allocation_units` указывает на первую страницу IAM единицы размещения. Все страницы IAM, относящиеся к одной единице размещения, объединяются в цепочку IAM.

> [!IMPORTANT]
> Системное представление `sys.system_internals_allocation_units` предназначено только для внутреннего использования и может быть изменено. Совместимость не гарантируется. Это представление недоступно в [!INCLUDE[ssSDSfull](../includes/sssdsfull-md.md)]. 

![iam_chain](../relational-databases/media/iam-chain.gif)
 
IAM-страницы, связанные в цепочки для единиц распределения IAM-страница имеет заголовок, который отображает первый экстент из диапазона, сопоставленного с IAM-страницей. IAM-страница также имеет большую битовую карту, в которой каждый бит представляет экстент. Первый бит схемы представляет первый экстент диапазона, второй бит — второй экстент и т. д. Если бит равен 0, то соответствующий ему экстент не привязан к единице распределения, которой принадлежит IAM-страница. Если он равен 1, то соответствующий ему экстент привязан к единице распределения, которой принадлежит IAM-страница.

Когда требуется вставить новую строку, но на текущей странице нет свободного места, компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] через IAM- и PFS-страницу ищет страницу для выделения или (для страниц кучи или текста и изображения) страницу, в которой достаточно места для хранения строки данных. Используя IAM-страницы, компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] находит экстенты, привязанные к единице распределения. Для каждого экстента компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] просматривает PFS-страницы, чтобы определить наличие доступных страниц. Огромное число страниц данных содержатся в сравнительно небольшом числе IAM- и PFS-страниц. Поэтому обычно IAM- и PFS-страницы находятся в памяти буферного пула [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], и поиск в них осуществляется очень быстро. Для индексов точка вставки новой строки определяется ключом индекса, но если нужна новая страница, происходит описанный выше процесс.

Компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] размещает новый экстент для единицы распределения только в том случае, когда в существующем экстенте невозможно быстро найти страницу, в которой достаточно места для вставляемой строки. 

<a name="ProportionalFill"></a>[!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] распределяет экстенты для файловой группы, используя **алгоритм распределения с пропорциональным заполнением**. Если файловая группа состоит из двух файлов и в одном из них свободного места вдвое больше, чем в другом, то во втором файле будет размещаться по одной странице на каждые две страницы в первом. Это означает, что процент заполнения для каждого из файлов в группе будет примерно одинаковым. 

## <a name="tracking-modified-extents"></a>Отслеживание измененных экстентов 

[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] использует две структуры внутренних данных, чтобы отслеживать экстенты, измененные операциями массового копирования, и экстенты, измененные со времени последнего полного резервного копирования. Эти структуры данных существенно ускоряют разностные резервные копии. Они также ускоряют операции записи в журнал массового копирования, если база данных использует модель восстановления с неполным протоколированием. Подобно страницам глобальной карты распределения (GAM) и общей общей глобальной карты распределения (SGAM), эти структуры являются битовыми картами, в которых каждый бит представляет один экстент. 

- **Схема разностных изменений (Differential Changed Map, DCM)**    
   Эта схема отслеживает экстенты, которые были изменены со времени последнего выполнения инструкции `BACKUP DATABASE`. Если бит экстента равен 1, с момента последнего выполнения `BACKUP DATABASE` экстент был изменен. Если бит равен 0, то экстент не был изменен. Чтобы определить, какие экстенты были изменены, разностные резервные копии считывают только страницы DCM. Это существенно сокращает количество страниц, которые должна просмотреть разностная резервная копия. Количество времени, которое затрачивает разностная резервная копия, пропорционально количеству экстентов, измененных со времени последнего выполнения инструкции BACKUP DATABASE, а не размеру всей базы данных. 

- **Схема массовых изменений (Bulk Changed Map, BCM)**    
   Эта схема отслеживает экстенты, измененные операциями с неполным протоколированием со времени последнего выполнения инструкции `BACKUP LOG`. Если бит экстента равен 1, после последнего выполнения `BACKUP LOG` экстент был изменен операцией неполного протоколирования. Если бит равен 0, то экстент не был изменен операциями с неполным протоколированием. Несмотря на то, что страницы BCM существуют во всех базах данных, они соответствуют только в том случае, если база данных использует модель восстановления с неполным протоколированием. В этой модели восстановления при выполнении инструкции `BACKUP LOG` процесс резервного копирования проверяет схемы BCM на наличие измененных экстентов. Затем она включает в себя экстенты из резервной копии журнала. Это позволяет восстановиться операциям с неполным протоколированием, если база данных восстанавливается из резервной копии журнала и последовательности резервных копий журнала транзакции. Страницы BCM в базе данных, которая использует простую модель восстановления, не соответствуют, потому что не произведена запись в журнал ни одной операции с неполным протоколированием. Они не соответствуют базе данных, которая использует модель полного восстановления, потому что эта модель восстановления принимает операции с неполным протоколированием за операции с полным протоколированием. 

Интервал между DCM- и BCM-страницами равен интервалу между GAM- и SGAM-страницами — 64 000 экстентов. DCM- и BCM-страницы расположены за GAM- и SGAM-страницами в физическом файле:

![special_page_order](../relational-databases/media/special-page-order.gif)

## <a name="see-also"></a>См. также:
[sys.allocation_units (Transact-SQL)](../relational-databases/system-catalog-views/sys-allocation-units-transact-sql.md)     
[Кучи (таблицы без кластеризованных индексов)](../relational-databases/indexes/heaps-tables-without-clustered-indexes.md#heap-structures)       
[sys.dm_db_page_info](../relational-databases/system-dynamic-management-views/sys-dm-db-page-info-transact-sql.md)     
[Считывание страниц](../relational-databases/reading-pages.md)   
[Запись страниц](../relational-databases/writing-pages.md)   
