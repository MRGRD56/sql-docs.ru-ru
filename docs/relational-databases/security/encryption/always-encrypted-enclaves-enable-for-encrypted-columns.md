---
description: Включение Always Encrypted с безопасными анклавами для существующих зашифрованных столбцов
title: Включение Always Encrypted с безопасными анклавами для существующих зашифрованных столбцов | Документация Майкрософт
ms.custom: ''
ms.date: 01/15/2021
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: vanto
ms.technology: security
ms.topic: conceptual
author: jaszymas
ms.author: jaszymas
monikerRange: '>= sql-server-ver15'
ms.openlocfilehash: 03a57949624897b2cd2e0552892803c21a408b52
ms.sourcegitcommit: 8ca4b1398e090337ded64840bcb8d6c92d65c29e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/16/2021
ms.locfileid: "98534813"
---
# <a name="enable-always-encrypted-with-secure-enclaves-for-existing-encrypted-columns"></a>Включение Always Encrypted с безопасными анклавами для существующих зашифрованных столбцов 
[!INCLUDE [sqlserver2019-windows-only-asdb](../../../includes/applies-to-version/sqlserver2019-windows-only-asdb.md)]

В этой статье приводятся сведения о разблокировке функциональности Always Encrypted с безопасными анклавами и включении вычислений анклава для существующих зашифрованных столбцов.  

Если существующие столбцы зашифрованы с помощью ключей без поддержки анклава, их можно преобразовать в столбцы, зашифрованные с помощью ключей с поддержкой анклава. Это позволит использовать безопасный анклав в запросах к столбцам.

Существует несколько разных способов включить вычисления анклава для существующих зашифрованных столбцов. Выбор метода зависит от нескольких факторов.

- **Область или степень детализации**. Вы хотите включить функцию анклава для подмножества столбцов или для всех столбцов, защищенных данным главным ключом столбцов?
- **Размер данных**. Каков размер таблиц, содержащих столбцы, для которых нужно реализовать поддержку анклава?
- Вы также хотите изменить тип шифрования для своих столбцов? Помните, что только случайное шифрование поддерживает полнофункциональные вычисления (сопоставление шаблонов, операторы сравнения). Если столбец зашифрован с использованием детерминированного шифрования, придется повторно зашифровать его с помощью случайного шифрования, чтобы разблокировать возможности вычислений.

В следующих разделах описываются три способа реализации поддержки анклавов для существующих столбцов.

## <a name="method-1-rotate-the-column-master-key-to-replace-it-with-an-enclave-enabled-column-master-key"></a>Метод 1. Замена главного ключа столбца на главный ключ столбца с поддержкой анклава
Процесс замены существующего главного ключа столбца, который не поддерживает анклав, на новый главный ключ столбца, который поддерживает анклав, эффективно реализует поддержку анклава для всех ключей шифрования столбцов, связанных с главным ключом столбца.

- Преимущества.
  - Не требуется повторное шифрование данных, то есть обычно это самый быстрый подход. Это рекомендуемый подход для содержащих большие объемы данных столбцов, которые уже включены для полнофункциональных вычислений и используют детерминированное шифрование.
  - Позволяет включить функциональность анклава для нескольких столбцов в масштабе. Процесс замены главного ключа столбца на главный ключ столбца с поддержкой анклава реализует поддержку анклава для всех ключей шифрования столбцов и всех зашифрованных столбцов, связанных с исходным главным ключом столбца.
  
- Недостатки.
  - Не поддерживает изменение типа шифрования с детерминированного на случайное. Хотя этот вариант разблокирует шифрование на месте для столбцов, использующих детерминированное шифрование, он не включает полнофункциональные вычисления. Необходимо повторно зашифровать столбцы с помощью случайного шифрования.
  - Не позволяет выборочно преобразовывать некоторые столбцы, связанные с данным главным ключом столбца.
  - Вводит накладные расходы на управление ключами. Необходимо создать новый главный ключ столбца и сделать его доступным для приложений, которые запрашивают затрагиваемые столбцы.

Сведения о замене главного ключа столбца см. в статье [Смена ключей с поддержкой анклава](always-encrypted-enclaves-rotate-keys.md).

## <a name="method-2-rotate-the-column-master-key-and-re-encrypt-columns-using-randomized-encryption-in-place"></a>Метод 2. Замена главного ключа столбца и повторное шифрование столбцов с использованием случайного шифрования на месте
В качестве первого шага здесь необходимо выполнить метод 1, а затем зашифровать столбцы повторно. К столбцам сначала применяется детерминированное шифрование, а затем они повторно шифруются с использованием случайного шифрования для поддержки выполнения расширенных запросов.

- Преимущества.
  - Повторно шифрует данные на месте. Этот метод рекомендуется, если требуется использовать расширенные запросы для детерминированно зашифрованных столбцов, содержащих большие объемы данных. Шаг 1 (смена главного ключа столбца) разблокирует шифрование на месте для столбцов, использующих детерминированное шифрование, поэтому шаг 2 (повторное шифрование столбцов) можно выполнить на месте.
  - Позволяет включить функциональность анклава для нескольких столбцов в масштабе.
  
- Недостатки.
  - Не позволяет выборочно преобразовывать некоторые столбцы, связанные с данным главным ключом столбца.
  - Вводит накладные расходы на управление ключами. Необходимо создать новый главный ключ столбца и сделать его доступным для приложений, которые запрашивают затрагиваемые столбцы.

Сведения о смене главного ключа столбца и повторном шифровании столбца на месте для смены ключа шифрования столбца см. в статье [Смена ключей с поддержкой анклава](always-encrypted-enclaves-rotate-keys.md).

## <a name="method-3-re-encrypt-a-selected-column-with-an-enclave-enabled-column-encryption-key-on-the-client-side"></a>Метод 3. Повторное шифрование выбранного столбца с помощью ключа шифрования столбца с поддержкой анклава на стороне клиента
Этот метод предусматривает повторное шифрование столбца с помощью ключа шифрования столбца с поддержкой анклава, а также включение расширенных запросов со случайным шифрованием. Поскольку текущий ключ шифрования столбца не поддерживает анклав, повторное шифрование столбца на месте невозможно. Чтобы повторно зашифровать столбец за пределами базы данных, воспользуйтесь мастером Always Encrypted или выполните командлет Set-SqlColumnEncryption.

- Преимущества.
  - Позволяет выборочно включить функциональность анклава (шифрование на месте и расширенные запросы — при повторном шифровании столбца с помощью случайного шифрования) для одного столбца или небольшого подмножества столбцов.
  - Он может включать полнофункциональные вычисления для столбцов за один шаг.
  - Он не требует создания нового главного ключа столбца, поэтому оказывает меньшее влияние на приложения.
  
- Недостатки.
  - Чтобы повторно зашифровать данные, средство переместит их за пределы базы данных, что может занять много времени и стать причиной ошибок в сети.

Дополнительные сведения о смене шифрования столбцов с помощью клиентского средства см. в статьях [Смена ключей Always Encrypted с помощью SQL Server Management Studio](rotate-always-encrypted-keys-using-ssms.md) и [Смена ключей Always Encrypted с помощью PowerShell](rotate-always-encrypted-keys-using-powershell.md).

## <a name="next-steps"></a>Next Steps
- [Выполнение инструкций Transact-SQL с помощью безопасных анклавов](always-encrypted-enclaves-query-columns.md)
- [Разработка приложений с помощью Always Encrypted с безопасными анклавами](always-encrypted-enclaves-client-development.md)
