---
title: Устранение распространенных неполадок Always Encrypted с безопасными анклавами
description: Устранение распространенных неполадок Always Encrypted с безопасными анклавами
ms.custom: ''
ms.date: 01/15/2021
ms.reviewer: vanto
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.technology: security
ms.topic: how-to
author: jaszymas
ms.author: jaszymas
monikerRange: '>= sql-server-ver15 || = sqlallproducts-allversions'
ms.openlocfilehash: dc6bcbecdb29cdf0cf1fca8c41e971463bb0d6b9
ms.sourcegitcommit: b1cec968b919cfd6f4a438024bfdad00cf8e7080
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2021
ms.locfileid: "99236359"
---
# <a name="troubleshoot-common-issues-for-always-encrypted-with-secure-enclaves"></a>Устранение распространенных неполадок Always Encrypted с безопасными анклавами

В этой статье описывается, как определить и устранить распространенные проблемы, которые могут возникнуть при выполнении инструкций Transact-SQL (TSQL) с использованием [Always Encrypted с безопасными анклавами](always-encrypted-enclaves.md).

Сведения о том, как выполнять запросы с использованием безопасных анклавов, см. в разделе [Выполнение инструкций Transact-SQL с помощью безопасных анклавов](always-encrypted-enclaves-query-columns.md).

## <a name="database-connection-errors"></a>Ошибки при подключении к базе данных

Чтобы выполнить инструкции с использованием безопасного анклава, необходимо включить Always Encrypted и указать URL-адрес аттестации для подключения к базе данных, как это описано в разделе [Необходимые условия для выполнения инструкций, использующих безопасные анклавы](always-encrypted-enclaves-query-columns.md#prerequisites-for-running-statements-using-secure-enclaves). Однако подключение завершится ошибкой, если указать URL-адрес аттестации, но база данных в [!INCLUDE[ssSDSfull](../../../includes/sssdsfull-md.md)] или целевом экземпляре [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] не поддерживает безопасные анклавы или настройка выполнена неверно.

- Если вы используете [!INCLUDE[ssSDSfull](../../../includes/sssdsfull-md.md)], убедитесь, что в базе данных используется конфигурация оборудования [серии DC](https://docs.microsoft.com/azure/azure-sql/database/service-tiers-vcore?tabs=azure-portal#dc-series). Дополнительные сведения см. в статье [Включение Intel SGX для базы данных SQL Azure](/azure/azure-sql/database/always-encrypted-enclaves-enable-sgx).
- Если вы используете [!INCLUDE[sql-server-2019](../../../includes/sssql19-md.md)], проверьте правильность настройки безопасного анклава для вашего экземпляра. Дополнительные сведения см. в статье [Настройка безопасного анклава в SQL Server](always-encrypted-enclaves-configure-enclave-type.md).

## <a name="attestation-errors-when-using-microsoft-azure-attestation"></a>Ошибки аттестации при использовании Аттестации Microsoft Azure

> [!NOTE]
> Этот раздел применим только к [!INCLUDE[ssSDSfull](../../../includes/sssdsfull-md.md)].

Прежде чем драйвер клиента отправит инструкцию T-SQL на логический сервер Azure SQL для выполнения, драйвер активирует следующий рабочий процесс аттестации анклава с помощью Аттестации Microsoft Azure.

1. Драйвер клиента передает URL-адрес аттестации, указанный в подключении к базе данных, на логический сервер Azure SQL.
2. Логический сервер Azure SQL собирает свидетельства об анклаве, среде его размещения и коде, выполняемом в анклаве. Затем сервер отправляет поставщику аттестации запрос на аттестацию, указанный в URL-адресе аттестации.
3. Поставщик аттестации проверяет свидетельство на соответствие настроенной политике и выдает токен аттестации логическому серверу Azure SQL. Поставщик аттестации подписывает токен аттестации с помощью закрытого ключа.
4. Логический сервер Azure SQL отправляет токен аттестации драйверу клиента.
5. Клиент обращается к поставщику аттестации по указанному URL-адресу аттестации для получения открытого ключа и проверяет подпись в токене аттестации.

Неверные настройки могут привести к тому, что на различных этапах указанного выше рабочего процесса будут происходить ошибки. Ниже приведены распространенные ошибки аттестации, их первопричины и рекомендуемые действия по их устранению.

- Логическому серверу Azure SQL не удается подключиться к поставщику аттестации в службе "Аттестация Azure" (шаг 2 указанного выше рабочего процесса), указанному в URL-адресе аттестации. Причины могут быть следующими.
  - Неверный или неполный URL-адрес аттестации. Дополнительные сведения см. в разделе [Определение URL-адреса аттестации для политики аттестации](/azure/azure-sql/database/always-encrypted-enclaves-configure-attestation#determine-the-attestation-url-for-your-attestation-policy).
  - Поставщик аттестации был случайно удален.
  - Брандмауэр разрешает доступ к поставщику аттестации, но запрещает доступ к службам Майкрософт.
  - Временная ошибка сети, которая приводит к недоступности поставщика аттестации.
- Логический сервер Azure SQL не имеет прав на отправку запросов аттестации поставщику аттестации. Убедитесь, что администратор поставщика аттестации добавил серверу базы данных роль "Читатель аттестации". Дополнительные сведения см. в статье [Предоставление серверу базы данных SQL Azure доступа к поставщику аттестации](/azure/azure-sql/database/always-encrypted-enclaves-configure-attestation#grant-your-azure-sql-database-server-access-to-your-attestation-provider).
- Сбой проверки политики аттестации (на шаге 3 приведенного выше рабочего процесса).
  - Наиболее вероятной основной причиной является неверная политика аттестации. Убедитесь, что вы используете политику, рекомендованную Майкрософт. Дополнительные сведения см. в разделе [Создание и настройка поставщика аттестации](/azure/azure-sql/database/always-encrypted-enclaves-configure-attestation#create-and-configure-an-attestation-provider).
  - Сбой проверки политики может также происходить из-за нарушения безопасности, приводящего к компрометации анклава на стороне сервера.
- Клиентскому приложению не удается подключиться к поставщику аттестации и получить открытый ключ подписи (на шаге 5). Причины могут быть следующими.
  - Настройка брандмауэров между приложением и поставщиком аттестации может блокировать подключения. Чтобы устранить неполадки с заблокированным подключением, проверьте, что вы можете подключиться к конечной точке OpenID поставщика аттестации. Например, используйте веб-браузер на компьютере, на котором размещено приложение, чтобы узнать, можно ли подключиться к конечной точке OpenID. Дополнительные сведения см. в разделе [Конфигурация метаданных — Get](https://docs.microsoft.com/rest/api/attestation/metadataconfiguration/get).

## <a name="attestation-errors-when-using-host-guardian-service"></a>Ошибки аттестации при использовании службы защиты узла

> [!NOTE]
> Этот раздел применим только к [!INCLUDE[sql-server-2019](../../../includes/sssql19-md.md)].

Прежде чем драйвер клиента отправит инструкцию T-SQL на [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] для выполнения, драйвер активирует следующий рабочий процесс аттестации анклава с помощью службы защиты узла (HGS).

1. Драйвер клиента вызывает [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] для инициации аттестации.
2. [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] собирает свидетельства об анклаве, среде его размещения и коде, выполняемом в анклаве. [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] запрашивает сертификат работоспособности у экземпляра HGS, в котором зарегистрирован компьютер с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)]. Дополнительные сведения см. в статье [Регистрация компьютера в службе защиты узла](always-encrypted-enclaves-host-guardian-service-register.md).
3. HGS проверяет свидетельство и выдает [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] сертификат работоспособности. HGS подписывает сертификат работоспособности с помощью своего закрытого ключа.
4. [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] отправляет сертификат работоспособности драйверу клиента.
5. Драйвер клиента обращается в HGS по URL-адресу аттестации, указанному для подключения к базе данных, чтобы получить открытый ключ HGS. Драйвер клиента проверяет подпись в сертификате работоспособности.

Неверные настройки могут привести к тому, что на различных этапах указанного выше рабочего процесса будут происходить ошибки. Ниже приведены некоторые распространенные ошибки аттестации, их первопричины и рекомендуемые действия по их устранению.

- [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] не может подключиться к службе HGS (шаг 2 указанного выше рабочего процесса) из-за временной ошибки сети. Для устранения проблемы с подключением администратор компьютера с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] должен проверить, может ли компьютер подключиться к компьютеру HGS.
- Сбой проверки на шаге 3. Чтобы устранить проблему с проверкой, необходимо выполнить следующее.
  - Администратор компьютера с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] должен совместно с администратором клиентского приложения проверить, что компьютер с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] зарегистрирован в том же экземпляре HGS, что и экземпляр, указанный в URL-адресе аттестации на стороне клиента.
  - Администратор компьютера с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] должен подтвердить успешную аттестацию компьютера с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)], следуя инструкциям на [шаге 5. Проверка успешной аттестации узла](always-encrypted-enclaves-host-guardian-service-register.md#step-5-confirm-the-host-can-attest-successfully).
- Клиентскому приложению не удается подключиться к HGS и получить открытый ключ подписи (на шаге 5). Причины могут быть следующими.
  - Настройка одного из брандмауэров между приложением и поставщиком аттестации может блокировать подключения. Убедитесь, что компьютер, на котором размещается приложение, может подключиться к компьютеру HGS.

## <a name="in-place-encryption-errors"></a>Ошибки шифрования на месте

В этом разделе перечислены распространенные ошибки, которые могут возникнуть при использовании инструкций `ALTER TABLE`/`ALTER COLUMN` для шифрования на месте (в дополнение к ошибкам аттестации, описанным в предыдущих разделах). Дополнительные сведения см. в статье [Настройка шифрования столбцов на месте с помощью Always Encrypted с безопасными анклавами](always-encrypted-enclaves-configure-encryption.md).

- Ключ шифрования столбца, который вы пытаетесь использовать для шифрования, расшифровки или повторного шифрования данных, не является ключом с поддержкой анклава. Дополнительные сведения о предварительных требованиях для шифрования на месте см. в разделе о [предварительных требованиях](always-encrypted-enclaves-configure-encryption.md#prerequisites). Сведения о подготовке ключей с поддержкой анклава см. в статье [Подготовка ключей с поддержкой анклава](always-encrypted-enclaves-provision-keys.md).
- Вы не включили Always Encrypted и вычисления анклава для подключения к базе данных. См. раздел [Необходимые условия для выполнения инструкций, использующих безопасные анклавы](always-encrypted-enclaves-query-columns.md#prerequisites-for-running-statements-using-secure-enclaves).
- Инструкция `ALTER TABLE`/`ALTER COLUMN` активирует криптографическую операцию и изменяет тип данных столбца или задает параметры сортировки с кодовой страницей, отличной от текущей кодовой страницы параметров сортировки. Объединение криптографических операций с изменениями на странице типа данных или параметров сортировки не допускается. Чтобы устранить эту проблему, используйте отдельные инструкции: одну инструкцию для изменения типа данных или кодовой страницы параметров сортировки и вторую для шифрования на месте.

## <a name="errors-when-running-confidential-dml-queries-using-secure-enclaves"></a>Ошибки при выполнении конфиденциальных запросов DML с использованием безопасных анклавов

В этом разделе перечислены распространенные ошибки, которые могут возникнуть при выполнении конфиденциальных запросов DML с использованием безопасных анклавов (в дополнение к ошибкам аттестации, описанным в предыдущих разделах).

- Ключ шифрования столбца, настроенный для запрашиваемого столбца, не является ключом с поддержкой анклава.
- Вы не включили Always Encrypted и вычисления анклава для подключения к базе данных. Дополнительные сведения см. в разделе [Необходимые условия для выполнения инструкций, использующих безопасные анклавы](always-encrypted-enclaves-query-columns.md#prerequisites-for-running-statements-using-secure-enclaves).
- Столбец, к которому выполняется запрос, использует детерминированное шифрование. Конфиденциальные запросы DML, использующие безопасные анклавы, не поддерживают работу с детерминированным шифрованием. Сведения о том, как изменить тип шифрования на случайный, см. в статье [Включение Always Encrypted с безопасными анклавами для существующих зашифрованных столбцов](always-encrypted-enclaves-enable-for-encrypted-columns.md).
- Столбец строки, для которого выполняется запрос, использует параметры сортировки, отличные от BIN2 или UTF-8. Измените параметры сортировки на BIN2 или UTF-8. Дополнительные сведения см. в разделе [Инструкции DML с использованием безопасных анклавов](always-encrypted-enclaves-query-columns.md#dml-statements-using-secure-enclaves).
- Запрос активирует неподдерживаемую операцию. Список операций, поддерживаемых внутри анклавов, см. в разделе [Инструкции DML с использованием безопасных анклавов](always-encrypted-enclaves-query-columns.md#dml-statements-using-secure-enclaves).
## <a name="next-steps"></a>Next Steps

- [Разработка приложений с помощью Always Encrypted с безопасными анклавами](always-encrypted-enclaves-client-development.md)

## <a name="see-also"></a>См. также раздел

- [Выполнение инструкций Transact-SQL с помощью безопасных анклавов](always-encrypted-enclaves-query-columns.md)
- [Настройка шифрования столбцов на месте с помощью Always Encrypted с безопасными анклавами](always-encrypted-enclaves-configure-encryption.md)
- [Создание и использование индексов в столбцах с помощью Always Encrypted с безопасными анклавами](always-encrypted-enclaves-create-use-indexes.md)