---
title: Настройка шифрования столбцов с помощью мастера Always Encrypted | Документация Майкрософт
description: Узнайте, как настроить конфигурацию Always Encrypted для столбцов базы данных с помощью мастера Always Encrypted в SQL Server.
ms.custom: ''
ms.date: 10/30/2019
ms.prod: sql
ms.reviewer: vanto
ms.technology: security
ms.topic: conceptual
f1_keywords:
- sql13.swb.alwaysencryptedwizard.encryption.f1
- sql13.swb.alwaysencryptedwizard.f1
- sql13.swb.alwaysencryptedwizard.masterkey.f1
helpviewer_keywords:
- Wizard, Always Encrypted
ms.assetid: 68daddc9-ce48-49aa-917f-6dec86ad5af5
author: jaszymas
ms.author: jaszymas
monikerRange: =azuresqldb-current||>=sql-server-2016||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: 27af6771eeccf660b1eac623f80e663d93e411b8
ms.sourcegitcommit: 1a544cf4dd2720b124c3697d1e62ae7741db757c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2020
ms.locfileid: "97406035"
---
# <a name="configure-column-encryption-using-always-encrypted-wizard"></a>Настройка шифрования столбцов с помощью мастера Always Encrypted
[!INCLUDE [SQL Server Azure SQL Database](../../../includes/applies-to-version/sql-asdb.md)]

Мастер Always Encrypted представляет собой эффективное средство, позволяющее задать нужную конфигурацию [Always Encrypted](always-encrypted-database-engine.md) для выбранных столбцов базы данных. В зависимости от текущей конфигурации и необходимой целевой конфигурации мастер может зашифровать столбец, расшифровать его (снять шифрование) или зашифровать его повторно (например, с помощью нового ключа шифрования столбца или типа шифрования, который отличается от текущего типа, настроенного для столбца). В рамках одного запуска мастера можно настроить несколько столбцов.

Мастер позволяет шифровать столбцы с существующими ключами шифрования столбцов, создать новый ключ шифрования столбцов или как новый ключ шифрования столбцов, так и новый главный ключ столбцов. 

Мастер перемещает данные из базы данных и выполняет криптографические операции в процессе SSMS. Мастер создает новую таблицу (или таблицы) с требуемой конфигурацией шифрования в базе данных, загружает все данные из исходных таблиц, выполняет запрошенные операции шифрования, передает данные в новые таблицы, а затем меняет местами исходные таблицы с новыми.

> [!NOTE]
> Выполнение криптографических операций может занимать много времени. В течение этого периода база данных недоступна для записи транзакций. PowerShell — это рекомендуемое средство для криптографических операций в больших таблицах. См. [Настройка шифрования столбцов с помощью мастера Always Encrypted с PowerShell](configure-column-encryption-using-powershell.md).

::: moniker range=">=sql-server-ver15"

> [!NOTE]
> Если вы используете [!INCLUDE [sssqlv15-md](../../../includes/sssqlv15-md.md)] и для экземпляра SQL Server настроен безопасный анклав, можно выполнять криптографические операции на месте без перемещения данных из базы данных. См. статью [Настройка шифрования столбцов на месте с помощью Always Encrypted с безопасными анклавами](always-encrypted-enclaves-configure-encryption.md). Обратите внимание, что мастер не поддерживает шифрование на месте.

::: moniker-end

Рекомендуется использовать PowerShell. 

 - Дополнительные сведения о настройке Always Encrypted с помощью мастера и его использовании в клиентском приложении см. в следующих учебниках по базе данных SQL Azure.
    - [Защита конфиденциальных данных в базе данных SQL Azure с помощью Always Encrypted и главных ключей столбцов в хранилище сертификатов Windows](/azure/azure-sql/database/always-encrypted-certificate-store-configure)
    - [Защита конфиденциальных данных в базе данных SQL Azure с помощью Always Encrypted и главных ключей столбцов в Azure Key Vault](/azure/sql-database/sql-database-always-encrypted-azure-key-vault)

 - Видео, в котором демонстрируется использование мастера, можно просмотреть на странице [Keeping Sensitive Data Secure with Always Encrypted (Безопасное хранение конфиденциальных данных с помощью постоянного шифрования)](https://channel9.msdn.com/events/DataDriven/SQLServer2016/AlwaysEncrypted). Кроме того, в блоге группы безопасности [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] есть запись [Мастер шифрования SSMS — несколько простых шагов для включения постоянного шифрования](https://techcommunity.microsoft.com/t5/SQL-Server/SSMS-Encryption-Wizard-Enabling-Always-Encrypted-in-a-Few-Easy/ba-p/384545).  
 - Дополнительные сведения о ключах Always Encrypted см. в разделе [Общие сведения об управлении ключами для Always Encrypted](overview-of-key-management-for-always-encrypted.md).
 - Дополнительные сведения о типах шифрования, поддерживаемых в Always Encrypted, см. в разделе [Выбор детерминированного или случайного шифрования](always-encrypted-database-engine.md#selecting--deterministic-or-randomized-encryption).
 
 ## <a name="permissions"></a>Разрешения
Чтобы выполнять криптографические операции с помощью мастера, требуются разрешения **VIEW ANY COLUMN MASTER KEY DEFINITION** и **VIEW ANY COLUMN ENCRYPTION KEY DEFINITION**. Кроме того, необходимо иметь разрешения на доступ к главным ключам столбцов, которые вы используете, в хранилищах ключей, содержащих ключи:
- **Хранилище сертификатов — локальный компьютер** — требуется доступ на чтение к сертификату, который используется в качестве главного ключа столбца, либо необходимо быть администратором компьютера.
- **Хранилище ключей Azure** — требуются разрешения get, unwrapKey и verify к хранилищу, содержащему главный ключ столбца.
- **Поставщик хранилища ключей (CNG)** — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и KSP.
- **Поставщик служб шифрования (CAPI)** — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и CSP.

Кроме того, при создании новых ключей с помощью мастера необходимо иметь дополнительные разрешения, перечисленные в разделах [Подготовка главных ключей столбцов с помощью диалогового окна "Создать главный ключ столбца"](configure-always-encrypted-keys-using-ssms.md#provision-column-master-keys-with-the-new-column-master-key-dialog) и [Подготовка ключей шифрования столбцов с помощью диалогового окна "Создать ключ шифрования столбцов"](configure-always-encrypted-keys-using-ssms.md#provision-column-encryption-keys-with-the-new-column-encryption-key-dialog).

## <a name="open-the-always-encrypted-wizard"></a>Запуск мастера Always Encrypted
Мастер можно запустить на трех разных уровнях. 
- На уровне базы данных — если необходимо зашифровать несколько столбцов, расположенных в разных таблицах.
- На уровне таблицы — если необходимо зашифровать несколько столбцов, расположенных в одной таблице.
- На уровне столбца — если требуется зашифровать один конкретный столбец.
 
 1. Подключитесь к своему серверу [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] с помощью обозревателя объектов [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)].  
   
 2. Чтобы зашифровать следующие элементы:
     1. Несколько столбцов, расположенных в разных таблицах в базе данных, — щелкните правой кнопкой мыши базу данных, наведите указатель на **Задачи**, а затем выберите **Шифрование столбцов**.
     1. Несколько столбцов, расположенных в одной таблице, — перейдите к таблице, щелкните ее правой кнопкой мыши и выберите **Шифрование столбцов**.
     1. Отдельный столбец — перейдите к столбцу, щелкните его правой кнопкой мыши и выберите **Шифрование столбцов**.


   
 ## <a name="column-selection-page"></a>Страница выбора столбцов
На этой странице выбираются столбцы, которые необходимо зашифровать, повторно зашифровать или расшифровать, а также определяется целевая конфигурация шифрования для выбранных столбцов.

Для шифрования столбца с открытым текстом (незашифрованный столбец) выберите тип шифрования (**Детерминированный** или **Случайный**) и ключ шифрования. 

Чтобы изменить тип шифрования или сменить ключ шифрования столбца для уже зашифрованного столбца, выберите нужный тип шифрования и ключ. 

Если вы хотите, чтобы мастер зашифровал или повторно зашифровал один или несколько столбцов с помощью нового ключа шифрования столбца, выберите ключ, содержащий **(New)** в имени. Мастер создаст ключ.

Чтобы расшифровать зашифрованный столбец, выберите вариант **Открытый текст** в качестве типа шифрования.


> [!NOTE]
> Мастер не поддерживает криптографические операции с темпоральными таблицами и таблицами в памяти. Можно создать пустые темпоральные таблицы или таблицы в памяти с помощью Transact-SQL и вставить данные через приложение.

## <a name="master-key-configuration-page"></a>Страница конфигурации главного ключа
Если для любого столбца на предыдущей странице был выбран автоматически созданный ключ шифрования столбца, на этой странице необходимо выбрать существующий главный ключ столбца или настроить новый главный ключ столбца, который зашифрует ключ шифрования столбца. 

При настройке нового главного ключа столбца можно выбрать существующий ключ в хранилище сертификатов Windows или в Azure Key Vault и создать в мастере только объект метаданных для ключа в базе данных, или вы можете создать как ключ, так и объект метаданных, описывающий ключ в базе данных. 

Дополнительные сведения о создании и хранении главных ключей столбцов в хранилище сертификатов Windows, Azure Key Vault или других хранилищах ключей см. в разделе [Создание и хранение главных ключей столбцов для Always Encrypted](../../../relational-databases/security/encryption/create-and-store-column-master-keys-always-encrypted.md).

> [!TIP]
> Мастер позволяет просматривать и создавать ключи только в хранилище сертификатов Windows и Azure Key Vault. Он также создает имена для новых ключей и объектов метаданных базы данных, описывающих ключи. Если вам требуется больший контроль над процессом подготовки ключей (и дополнительные варианты хранилищ ключей, содержащих главный ключ столбца), можно воспользоваться диалоговыми окнами **Новый главный ключ столбца** и **Новый ключ шифрования столбца**, чтобы сначала создать ключи, а затем запустить мастер и выбрать созданные ключи. См. разделы [Подготовка главных ключей столбцов с помощью диалогового окна "Создать главный ключ столбца"](configure-always-encrypted-keys-using-ssms.md#provision-column-master-keys-with-the-new-column-master-key-dialog) и [Подготовка ключей шифрования столбцов с помощью диалогового окна "Создать ключ шифрования столбцов"](configure-always-encrypted-keys-using-ssms.md#provision-column-encryption-keys-with-the-new-column-encryption-key-dialog). 

## <a name="next-steps"></a>Next Steps
- [Выполнение запросов к столбцам с помощью Always Encrypted с использованием SQL Server Management Studio](always-encrypted-query-columns-ssms.md)
- [Разработка приложений с помощью Always Encrypted](always-encrypted-client-development.md)

## <a name="see-also"></a>См. также:  
 - [Always Encrypted](../../../relational-databases/security/encryption/always-encrypted-database-engine.md)
 - [Общие сведения об управлении ключами для Always Encrypted](overview-of-key-management-for-always-encrypted.md) 
 - [Настройка функции Always Encrypted с помощью SQL Server Management Studio](configure-always-encrypted-using-sql-server-management-studio.md)
 - [Подготовка ключей Always Encrypted с помощью PowerShell](configure-always-encrypted-keys-using-powershell.md)
 - [Настройка шифрования столбцов с помощью Always Encrypted с PowerShell](configure-column-encryption-using-powershell.md)
 - [Настройка шифрования столбцов с помощью Always Encrypted с пакетом приложения уровня данных](configure-always-encrypted-using-dacpac.md)