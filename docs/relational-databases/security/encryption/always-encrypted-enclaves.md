---
title: Always Encrypted с безопасными анклавами.
description: Сведения о функции Always Encrypted с безопасными анклавами для SQL Server.
ms.custom: seo-lt-2019
ms.date: 10/31/2019
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: vanto
ms.technology: security
ms.topic: conceptual
author: jaszymas
ms.author: jaszymas
monikerRange: '>= sql-server-ver15 || = sqlallproducts-allversions'
ms.openlocfilehash: 64680ae71e34d1da94bf0ec8b2ab1ef75cd3c4d3
ms.sourcegitcommit: 22e97435c8b692f7612c4a6d3fe9e9baeaecbb94
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/27/2020
ms.locfileid: "92679020"
---
# <a name="always-encrypted-with-secure-enclaves"></a>Always Encrypted с безопасными анклавами.
[!INCLUDE [sqlserver2019-windows-only](../../../includes/applies-to-version/sqlserver2019-windows-only.md)]
 
Always Encrypted с безопасными анклавами предоставляет дополнительные функциональные возможности для компонента [Always Encrypted](always-encrypted-database-engine.md).

Представленный в SQL Server 2016 компонент Always Encrypted защищает конфиденциальные данные от вредоносных программ и *неавторизованных* пользователей SQL Server, обладающих очень высокими правами доступа. Неавторизованные пользователи с очень высокими правами доступа — это администраторы баз данных, администраторы компьютеров, администраторы облака или другие пользователи, у которых есть санкционированный доступ к экземплярам сервера, оборудованию и т. д., но эти пользователи не должны иметь доступ к некоторым или всем фактическим данным.  

Без улучшений, описанных в этой статье, Always Encrypted защищает данные, шифруя их на стороне клиента, и не допускает отображение данных и соответствующих криптографических ключей в виде обычного текста в ядре SQL Server. Таким образом, функциональные возможности для зашифрованных столбцов в базе данных строго ограничены. Единственные операции, которые SQL Server может выполнять с зашифрованными данными — это сравнения на равенство (доступны только при использовании детерминированного шифрования). Все остальные операции, включая криптографические операции (начальное шифрование данных или смена ключа) и (или) полнофункциональные вычисления (например, сопоставления шаблонов), в базе данных не поддерживаются. Пользователям необходимо переместить данные за пределы базы данных, чтобы выполнить эти операции на стороне клиента.

Always Encrypted *с безопасными анклавами* устраняет эти ограничения, позволяя выполнять вычисления с данными в виде обычного текста внутри безопасного анклава на стороне сервера. Безопасный анклав — это защищенная область памяти в процессе SQL Server. Он также выступает в качестве доверенной среды выполнения для обработки конфиденциальных данных в ядре SQL Server. Безопасный анклав представляет собой "черный ящик" на фоне остальной части SQL Server и других процессов на главном компьютере. Просмотреть данные или код внутри анклава извне невозможно, даже с помощью отладчика.  


Always Encrypted использует безопасные анклавы, как показано на следующей схеме:

![поток данных](./media/always-encrypted-enclaves/ae-data-flow.png)



При синтаксическом анализе запроса приложения ядро SQL Server определяет, содержит ли запрос любые операции с зашифрованными данными, для которых требуется использовать безопасный анклав. Для запросов, где требуется доступ к безопасному анклаву:

- Драйвер клиента отправляет ключи шифрования столбцов, необходимые для выполнения операций, в безопасный анклав (через защищенный канал). 
- Затем драйвер клиента отправляет запрос для выполнения, а также зашифрованные параметры запроса.

При обработке запроса данные или ключи шифрования столбцов не отображаются в виде обычного текста в ядре SQL Server за пределами безопасного анклава. Ядро SQL Server делегирует криптографические операции и вычисления в зашифрованных столбцах безопасному анклаву. При необходимости безопасный анклав расшифровывает параметры запроса и/или данные, хранящиеся в зашифрованных столбцах, и выполняет запрошенные операции.

В [!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)] Always Encrypted с безопасными анклавами использует безопасные анклавы памяти [безопасности на основе виртуализации (VBS)](https://www.microsoft.com/security/blog/2018/06/05/virtualization-based-security-vbs-memory-enclaves-data-protection-through-isolation/) (это также называется виртуальным безопасным режимом или анклавами VSM) в Windows.

## <a name="why-use-always-encrypted-with-secure-enclaves"></a>Почему следует использовать Always Encrypted с безопасными анклавами?

С помощью безопасных анклавов Always Encrypted защищает конфиденциальные данные, предоставляя следующие преимущества:

- **Шифрование на месте** — криптографические операции с конфиденциальными данными, например начальное шифрование данных или смена ключа шифрования столбца, выполняются внутри безопасного анклава и не требуют перемещения данных за пределы базы данных. Шифрование на месте можно выполнять с помощью инструкции Transact-SQL ALTER TABLE, и для этого не нужно использовать средства, такие как мастер Always Encrypted в SSMS или командлет PowerShell Set-SqlColumnEncryption.

- **Полнофункциональные вычисления**  — операции в зашифрованных столбцах, включая сопоставление шаблонов (предикат LIKE) и сравнения диапазонов, поддерживаются в безопасном анклаве, благодаря чему Always Encrypted можно использовать в широком диапазоне приложений и сценариев, в которых требуется, чтобы такие вычисления выполнялись в системе базы данных.

## <a name="secure-enclave-attestation"></a>Аттестация безопасного анклава

Безопасный анклав в ядре SQL Server может получать доступ к конфиденциальным данным, хранящимся в зашифрованных столбцах базы данных, и соответствующим ключам шифрования столбцов в виде обычного текста. Прежде чем отправить запрос, который включает в себя вычисления анклава, в SQL Server, драйвер клиента в приложении должен проверить, является ли безопасный анклав подлинным анклавом на основе заданной технологии (например, VBS), а также зарегистрирован ли выполняемый в анклаве код для выполнения внутри анклава. 

Процесс проверки анклава называется **аттестацией анклава**. В нем задействованы драйвер клиента в приложении и SQL Server, обращающийся к внешней службе аттестации. Особенности процесса аттестации зависят от технологии анклава и службы аттестации.

Процесс аттестации, который SQL Server поддерживает для безопасных анклавов VBS в [!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)], — это аттестация среды выполнения System Guard в Защитнике Windows, которая использует службу защиты узла (HGS) в качестве службы аттестации. Необходимо настроить HGS в вашей среде и зарегистрировать компьютер, на котором размещен экземпляр SQL Server, в HGS. Кроме того, необходимо настроить клиентские приложения и средства (например, SQL Server Management Studio) с применением аттестации HGS.

## <a name="supported-client-drivers"></a>Поддерживаемые драйверы клиента

Чтобы использовать Always Encrypted с безопасными анклавами, приложению необходимо использовать драйвер клиента, который поддерживает эту функцию. Чтобы включить вычисления анклава и аттестацию анклава, необходимо настроить приложение и драйвер клиента. Дополнительные сведения, включая список поддерживаемых клиентских драйверов, см. в разделе [Разработка приложений с помощью Always Encrypted](always-encrypted-client-development.md).

## <a name="enclave-enabled-keys"></a>Ключи с поддержкой анклава

В Always Encrypted с безопасными анклавами реализованы ключи с поддержкой анклава:

- **Главный ключ столбца с поддержкой анклава**  — главный ключ столбца со свойством ENCLAVE_COMPUTATIONS, указанным в объекте метаданных главного ключа столбца в базе данных. Объект метаданных главного ключа столбца также должен содержать допустимую подпись свойств метаданных.
- **Ключ шифрования столбца с поддержкой анклава**  — ключ шифрования столбца, зашифрованный с помощью главного ключа столбца с поддержкой анклава.

Если ядро SQL Server определяет операции, которые указаны в запросе и которые необходимо выполнить внутри безопасного анклава, ядро SQL Server запрашивает, чтобы драйвер клиента отправил ключи шифрования столбцов, необходимые для вычислений, в безопасный анклав. Драйвер клиента отправляет ключи шифрования столбцов только в том случае, если ключи поддерживают анклав (то есть зашифрованы с помощью главных ключей столбцов с поддержкой анклава) и подписаны должным образом. В противном случае запрос завершится ошибкой.

Дополнительные сведения см. в статье [Управление ключами в Always Encrypted с безопасными анклавами](always-encrypted-enclaves-manage-keys.md).

## <a name="enclave-enabled-columns"></a>Столбцы с поддержкой анклава

Столбец с поддержкой анклава — это столбец базы данных, зашифрованный с помощью ключа шифрования столбца с поддержкой анклава. Функциональные возможности, доступные для столбца с поддержкой анклава, зависят от типа шифрования, используемого в столбце.

- **Детерминированное шифрование.** Столбцы с поддержкой анклава, использующие детерминированное шифрование, поддерживают шифрование на месте, но не поддерживают остальные операции внутри безопасного анклава. Сравнение на равенство поддерживается, но оно выполняется путем сравнения зашифрованных данных за пределами анклава.  
- **Случайное шифрование.** Столбцы с поддержкой анклава, использующие случайное шифрование, поддерживают шифрование на месте, а также полнофункциональные вычисления внутри безопасного анклава. Поддерживаемые полнофункциональные вычисления — это сопоставления шаблонов и [операторы сравнения](../../../t-sql/language-elements/comparison-operators-transact-sql.md), включая сравнение на равенство.

Дополнительные сведения о типах шифрования см. в статье [Системы шифрования c технологиями постоянного шифрования](always-encrypted-cryptography.md).

В следующей таблице перечислены функциональные возможности, доступные для зашифрованных столбцов в зависимости от того, используются ли в столбцах ключи шифрования столбцов с поддержкой анклава, и от типа шифрования.

| **Операция**| **Столбец НЕ поддерживает анклав** |**Столбец НЕ поддерживает анклав**| **Столбец поддерживает анклав**  |**Столбец поддерживает анклав** |
|:---|:---|:---|:---|:---|
| | **Случайное шифрование**  | **Детерминированное шифрование**     | **Случайное шифрование**      | **Детерминированное шифрование**     |
| **Шифрование на месте** | Не поддерживается  | Не поддерживается   | Поддерживается         | Поддерживается    |
| **Сравнение на равенство**   | Не поддерживается | Поддерживается вне анклава | Поддерживается (внутри анклава) | Поддерживается вне анклава |
| **Операторы сравнения помимо проверки на равенство** | Не поддерживается  | Не поддерживается   | Поддерживается      | Не поддерживается     |
| **LIKE**    | Не поддерживается      | Не поддерживается    | Поддерживается     | Не поддерживается    |

Шифрование на месте поддерживает следующие операции внутри анклава:

- Первоначальное шифрование данных, хранящихся в имеющемся столбце.
- Повторное шифрование имеющихся данных в столбце, например:
  
  - смена ключа шифрования столбца (повторное шифрование столбца с использованием нового ключа);
  - изменение типа шифрования.  

- Расшифровка данных, хранящихся в зашифрованном столбце (преобразование столбца в столбец с обычным текстом).

Для шифрования на месте ключ (или ключи) шифрования столбца, участвующий в криптографических операциях, должен поддерживать анклав:

- первоначальное шифрование — ключ шифрования столбца для шифрования столбца должен поддерживать анклав;
- повторное шифрование — текущий и целевой ключи шифрования столбца (если отличается от текущего ключа) должны поддерживать анклав;
- расшифровка — текущий ключ шифрования столбца должен поддерживать анклав.

### <a name="indexes-on-enclave-enabled-columns-using-randomized-encryption"></a>Индексы в столбцах с поддержкой анклава с использованием случайного шифрования
Вы можете создать некластеризованные индексы по столбцам с поддержкой анклава с использованием случайного шифрования, чтобы полнофункциональные запросы выполнялись быстрее. Чтобы индекс столбца, зашифрованного с помощью случайного шифрования, не приводил к утечке конфиденциальных данных, но при этом оставался полезным для обработки запросов в анклаве, значения ключей в структуре данных индекса (сбалансированное дерево) шифруются и сортируются по значениям в формате открытого текста. Когда исполнитель запроса в ядре SQL Server применяет индекс по зашифрованному столбцу для вычислений внутри анклава, он выполняет по индексу поиск конкретных значений, хранящихся в этом столбце. Каждый поиск может включать несколько операций сравнения. Исполнитель запросов делегирует каждое сравнение анклаву, который расшифровывает сохраненное в столбце значение и переданное для сравнения значение ключа индекса, затем сравнивает их в формате обычного текста и возвращает в исполнитель результат этого сравнения. 

Индексы для столбцов, которые используют случайное шифрование и не поддерживают анклав, создавать пока нельзя.

Дополнительные сведения см. в статье [Создание и использование индексов в столбцах с помощью Always Encrypted с безопасными анклавами](always-encrypted-enclaves-create-use-indexes.md). Общие сведения о работе индексирования в SQL Server, не имеющие прямого отношения к Always Encrypted, см. в статье [Описание кластеризованных и некластеризованных индексов](../../indexes/clustered-and-nonclustered-indexes-described.md).

#### <a name="database-recovery"></a>Восстановление базы данных

Если происходит сбой экземпляра SQL Server, его базы данных могут оказаться в состоянии, когда файлы данных содержат частичные изменения из-за незаконченных транзакций. Запущенный экземпляр выполняет процесс [восстановления базы данных](../../logs/the-transaction-log-sql-server.md#recovery-of-all-incomplete-transactions-when--is-started), который включает откат каждой незавершенной транзакции, найденной в журнале транзакций, что позволяет сохранить целостность базы данных. Если незавершенная транзакция вносила изменения в индекс, такие изменения также должны быть отменены. Например, придется удалить или восстановить некоторые значения ключа в индексе.

> [!IMPORTANT]
> Корпорация Майкрософт настоятельно рекомендует вам включить для базы данных [Ускоренное восстановление баз данных (ADR)](../../backup-restore/restore-and-recovery-overview-sql-server.md#adr), **прежде** чем создавать первый индекс по столбцу с поддержкой анклава с использованием случайного шифрования.

[Традиционный процесс восстановления базы данных](/azure/sql-database/sql-database-accelerated-database-recovery#the-current-database-recovery-process) (который соответствует модели восстановления [ARIES](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf)) предусматривает, что для отмены изменений в индексе SQL Server ожидает, пока приложение не предоставит в анклав ключ шифрования соответствующего столбца, а это может занять много времени. Ускоренное восстановление баз данных значительно сокращает число операций отката, которые откладываются из-за отсутствия ключа шифрования столбца во внутреннем кэше анклава. В результате существенно увеличивается доступность базы данных, ведь вероятность блокировки новых транзакций будет минимальной. При включении ускоренного восстановления баз данных SQL Server по-прежнему может потребовать ключ шифрования столбца для завершения очистки устаревших данных, но он выполняет это в фоновой задаче, которая не влияет на доступность базы данных или транзакций пользователя. Но вы можете увидеть в журнале ошибок сообщения об ошибках, которые обозначают сбои операций очистки из-за отсутствия ключа шифрования столбца.

### <a name="indexes-on-enclave-enabled-columns-using-deterministic-encryption"></a>Индексы в столбцах с поддержкой анклава с использованием детерминированного шифрования

Индекс по столбцу, зашифрованному с помощью детерминированного шифрования, сортируется по значению в формате зашифрованного текста (не открытого текста), независимо от наличия поддержки анклава для этого столбца.

## <a name="security-considerations"></a>Соображения безопасности

К функции Always Encrypted с безопасными анклавами применимы следующие соображения по безопасности.

- Безопасность данных внутри анклава зависит от используемых протокола аттестации и службы аттестации. Это означает, что службой и политиками аттестации, которые поддерживает эта служба, должен управлять доверенный администратор. Кроме того, службы аттестации обычно поддерживают разные политики и протоколы аттестации, некоторые из которых выполняют минимальную проверку анклава и его среды. Такие варианты предназначены только для тестирования и разработки. Внимательно следуйте рекомендациям по работе с конкретной службой аттестации, чтобы гарантировать правильные конфигурации и политики для вашего рабочего развертывания. 
- Шифрование столбца с помощью случайного шифрования с ключом CEK с поддержкой анклава может привести к утечке порядка хранящихся в столбце данных, поскольку эти столбцы поддерживают сравнение по диапазонам. Например, если зашифрованный столбец с информацией о заработной плате сотрудников имеет индекс, злонамеренный администратор базы данных может просканировать индекс для поиска максимального значения заработной платы и определить сотрудника с максимальной заработной платой (если имена сотрудников в этой базе данных не шифруются). 
- Если вы используете Always Encrypted для защиты конфиденциальных данных от несанкционированного доступа администраторами баз данных, не передавайте администраторам главные ключи столбцов и (или) ключи шифрования столбцов. Администратор базы данных может управлять индексами по зашифрованным столбцам без прямого доступа к этим ключам, используя внутренний кэш ключей шифрования столбцов в анклаве.

## <a name="considerations-for-availability-groups-and-database-migration"></a><a name="anchorname-1-considerations-availability-groups-db-migration"></a> Рекомендации по группам доступности и миграции базы данных

При настройке группы доступности AlwaysOn, которая потребуется для поддержки запросов с использованием анклавов, необходимо убедиться, что все экземпляры SQL Server, на которых размещены базы данных в группе доступности, поддерживают Always Encrypted с безопасными анклавами и для них настроены анклавы. Если база данных-источник поддерживает анклавы, но вторичная реплика их не поддерживает, любой запрос, который пытается использовать функцию Always Encrypted с безопасными анклавами, завершится ошибкой.

При восстановлении из файла резервной копии базы данных, которая использует функцию Always Encrypted с безопасными анклавами, на экземпляре SQL Server с настроенным анклавом, операция восстановления пройдет успешно и будут доступны все функции, которые не зависят от анклава. Но все последующие запросы, которые используют функциональность анклава, завершатся сбоем, а также станут недействительными все индексы для столбцов с поддержкой анклава, которые используют случайное шифрование. Это же относится к ситуации, когда вы присоединяете базу данных с использованием Always Encrypted и безопасных анклавов к экземпляру, на котором не настроен анклав.

Если база данных содержит индексы по столбцам с поддержкой анклава и использованием случайного шифрования, не забудьте включить [ускорение восстановления базы данных (ADR)](../../backup-restore/restore-and-recovery-overview-sql-server.md#adr) для этой базы данных перед созданием ее резервной копии. ADR обеспечит мгновенную доступность базы данных и всех ее индексов сразу после восстановления базы данных. Дополнительные сведения см. в разделе [Восстановление базы данных](#database-recovery).

При миграции базы данных с помощью BACPAC-файла необходимо убедиться, что вы удалили все индексы по столбцам с поддержкой анклава и использованием случайного шифрования, прежде чем создавать BACPAC-файл.

## <a name="known-limitations"></a>Известные ограничения
Always Encrypted с безопасным анклавами устраняет некоторые ограничения Always Encrypted, предоставляя следующие возможности:

- Криптографические операции на месте.
- Сопоставление шаблонов (LIKE) и операторы сравнения для столбца, зашифрованного с помощью случайного шифрования.
    > [!NOTE]
    > Указанные выше операции поддерживаются для символьных столбцов, которые используют параметры сортировки с порядком сортировки binary2 (BIN2). Столбцы со строковыми значениями и порядком сортировки, отличным от BIN2, могут шифроваться с помощью случайного шифрования и ключей шифрования столбцов с поддержкой анклава. Однако единственной новой функцией, которая включена для таких столбцов, является шифрование на месте.
- Создание некластеризованных индексов и статистики по столбцам с использованием случайного шифрования.

Все остальные ограничения Always Encrypted, описанные в разделе [Подробные сведения о возможностях](always-encrypted-database-engine.md#feature-details), также применяются к Always Encrypted с безопасными анклавами.

Отдельно к Always Encrypted с безопасными анклавами применяются следующие ограничения.

- Невозможно создание индексов по столбцами с поддержкой анклава с использованием случайного шифрования
- Столбцы с поддержкой анклава с использованием случайного шифрования не могут быть первичными ключами и (или) участвовать в ограничениях внешних ключей или уникальных ключей.
- Для столбцов с поддержкой анклавов, в которых используется случайное шифрование, поддерживаются только вложенные циклы соединения (с использованием индексов, если они доступны). Хэш-соединения и соединения слиянием не поддерживаются. 
- Криптографические операции на месте нельзя сочетать с другими изменениями метаданных столбцов, за исключением изменения параметров сортировки с сохранением значений кодовой страницы и допустимости значений NULL. Например, вы не можете зашифровать, повторно зашифровать или расшифровать столбец и изменить тип данных столбца в одной инструкции Transact-SQL `ALTER TABLE`/`ALTER COLUMN`. Используйте для этого две отдельных инструкции.
- Использование ключей с поддержкой анклава для столбцов в таблицах в памяти не поддерживается.
- Выражения, определяющие вычисляемые столбцы, не могут выполнять вычисления со столбцами с поддержкой анклава, в которых используется случайное шифрование (даже если это операции LIKE и операции сравнения диапазонов).
- Escape-символы не поддерживаются в параметрах оператора LIKE для столбцов с поддержкой анклава, в которых используется случайное шифрование.
- Запросы с оператором LIKE или оператором сравнения, которые включают параметр запроса с одним из следующих типов данных (которые после шифрования становятся большими объектами), игнорируют индексы и выполняют полное сканирование таблицы.
    - `nchar[n]` и `nvarchar[n]`, если n больше 3967.
    - `char[n]`, `varchar[n]`, `binary[n]`, `varbinary[n]`, если n больше 7935.
- Ограничения инструментов:
  - Единственные поддерживаемые хранилища ключей для хранения главных ключей столбцов с поддержкой анклава — хранилище сертификатов Windows и Azure Key Vault.
  - Не поддерживается импорт и экспорт баз данных, которые содержат ключи с поддержкой анклавов.
  - Для запуска криптографической операции на месте с помощью инструкции `ALTER TABLE`/`ALTER COLUMN` необходимо запустить инструкцию в окне запроса в среде SSMS или написать собственную программу, которая выполняет инструкцию. Командлет Set-SqlColumnEncryption в модуле SqlServer PowerShell и мастер Always Encrypted в SQL Server Management Studio еще не поддерживают шифрование на месте. Сейчас обе эти программы перемещают данные из базы данных для криптографических операций, даже если ключи шифрования столбцов, используемые для операций, поддерживают анклавы.

## <a name="next-steps"></a>Дальнейшие действия
- [Руководство. Начало работы с Always Encrypted с безопасными анклавами с использованием SSMS](../tutorial-getting-started-with-always-encrypted-enclaves.md)
- [Настройка и использование Always Encrypted с безопасными анклавами](configure-always-encrypted-enclaves.md)

## <a name="see-also"></a>См. также раздел
- [Управление ключами для Always Encrypted с безопасными анклавами](always-encrypted-enclaves-manage-keys.md)
- [Настройка шифрования столбцов на месте с помощью Always Encrypted с безопасными анклавами](always-encrypted-enclaves-configure-encryption.md)
- [Выполнение запросов к столбцам с помощью Always Encrypted с безопасными анклавами](always-encrypted-enclaves-query-columns.md)
- [Включение Always Encrypted с безопасными анклавами для существующих зашифрованных столбцов](always-encrypted-enclaves-enable-for-encrypted-columns.md)
- [Создание и использование индексов в столбцах с помощью Always Encrypted с безопасными анклавами](always-encrypted-enclaves-create-use-indexes.md)
