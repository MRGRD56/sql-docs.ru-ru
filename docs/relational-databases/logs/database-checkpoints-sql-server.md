---
title: Контрольные точки базы данных (SQL Server) | Документация Майкрософт
description: Сведения о контрольных точках, т. е. известных хороших точках, из которых ядро СУБД SQL Server может начать применение изменений, содержащихся в журнале, во время восстановления.
ms.date: 04/23/2019
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: ''
ms.custom: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- automatic checkpoints
- transaction logs [SQL Server], checkpoints
- logs [SQL Server], active
- pages [SQL Server], dirty
- MinLSN
- checkpoints [SQL Server]
- pages [SQL Server], flushing
- dirty pages
- transaction logs [SQL Server], active logs
- recovery interval option [SQL Server]
- buffer cache [SQL Server]
- logs [SQL Server], checkpoints
- Minimum Recovery LSN
- flushing pages
- active logs
ms.assetid: 98a80238-7409-4708-8a7d-5defd9957185
author: MashaMSFT
ms.author: mathoma
monikerRange: =azuresqldb-current||>=sql-server-2016||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: 9277d551762afcff062a6a1e1fc389009e5ea2ed
ms.sourcegitcommit: 917df4ffd22e4a229af7dc481dcce3ebba0aa4d7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/10/2021
ms.locfileid: "100351207"
---
# <a name="database-checkpoints-sql-server"></a>Контрольные точки базы данных (SQL Server)
[!INCLUDE [SQL Server Azure SQL Database](../../includes/applies-to-version/sql-asdb.md)]
 *Контрольная точка* создает известную надежную точку, с которой [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] может начать применение изменений, содержащихся в журнале, во время восстановления после непредвиденного отключения или аварии.

##  <a name="overview"></a><a name="Overview"></a> Обзор   
Из соображений производительности [!INCLUDE[ssDE](../../includes/ssde-md.md)] выполняет изменения страниц базы данных в памяти (в буферном кэше) и не записывает эти страницы на диск после каждого изменения. Вместо этого [!INCLUDE[ssDE](../../includes/ssde-md.md)] периодически выдает контрольную точку на каждой базе данных. Новая *контрольная точка* записывает текущие страницы, измененные в памяти (известные как *измененные незафиксированные страницы*), вместе со сведениями журнала транзакций из памяти на диск, а также сведения о журнале транзакций.  
  
 [!INCLUDE[ssDE](../../includes/ssde-md.md)] поддерживает несколько типов контрольных точек: автоматические, косвенные, ручные и внутренние. Следующая таблица содержит сводку типов **контрольных точек**.
  
|Имя|[!INCLUDE[tsql](../../includes/tsql-md.md)] Интерфейс|Описание|  
|----------|----------------------------------|-----------------|  
|Автоматически|EXEC sp_configure **'** recovery interval **','** _seconds_ **'**|Выдаются автоматически в фоновом режиме для обеспечения соответствия верхнему пределу времени, предлагаемому параметром конфигурации сервера **recovery interval** . Автоматические контрольные точки выполняются до их завершения.  Автоматические контрольные точки регулируются в зависимости от числа необработанных операций записи и от того, обнаруживает ли [!INCLUDE[ssDE](../../includes/ssde-md.md)] увеличение задержки при записи более чем на 50 миллисекунд.<br /><br /> Дополнительные сведения см. в статье [Configure the recovery interval Server Configuration Option](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md).|  
|Косвенные|ALTER DATABASE ... SET TARGET_RECOVERY_TIME **=** _target\_recovery\_time_ { SECONDS &#124; MINUTES }|Выдаются в фоновом режиме для обеспечения соответствия пользовательскому целевому времени восстановления для конкретной базы данных. Начиная с версии [!INCLUDE[ssSQL15_md](../../includes/sssql16-md.md)], значение по умолчанию равно 1 минуте. Для более старых версий по умолчанию установлено значение 0, при котором базой данных используются автоматические контрольные точки, а их частота зависит от параметра для интервала восстановления экземпляра сервера.<br /><br /> Дополнительные сведения см. в разделе [Изменение целевого времени восстановления базы данных (SQL Server)](../../relational-databases/logs/change-the-target-recovery-time-of-a-database-sql-server.md).|  
|Вручную|CHECKPOINT [*checkpoint_duration*]|Выдаются при выполнении команды [!INCLUDE[tsql](../../includes/tsql-md.md)] CHECKPOINT. Ручная контрольная точка срабатывает в текущей базе данных для конкретного соединения. По умолчанию ручная контрольная точка выполняется до ее завершения. Регулирование работает так же, как и для автоматической контрольной точки.  При необходимости параметр *checkpoint_duration* указывает требуемое время в секундах для завершения контрольной точки.<br /><br /> Дополнительные сведения см. в статье [CHECKPOINT (Transact-SQL)](../../t-sql/language-elements/checkpoint-transact-sql.md).|  
|Внутренние|Нет.|Выдаются различными операциями сервера, такими как резервное копирование и создание моментального снимка базы данных, для обеспечения соответствия образа диска текущему состоянию журнала.|  
  
> [!NOTE]
> Параметр расширенной настройки **-k** [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] позволяет администратору базы данных регулировать поведение ввода-вывода контрольной точки с учетом пропускной способности подсистемы ввода-вывода для некоторых типов контрольных точек. Параметр настройки **-k** применяется к автоматическим контрольным точкам и любым другим регулируемым ручным и внутренним контрольным точкам.  
  
 Для автоматических, ручных и внутренних контрольных точек в процессе восстановления базы данных следует произвести накат только тех изменений, которые выполнены после последней контрольной точки. Это способствует сокращению времени, необходимому для восстановления базы данных.  
  
> [!IMPORTANT]
> Длительные незафиксированные транзакции увеличивают время восстановления для всех типов контрольных точек.   
  
##  <a name="interaction-of-the-target_recovery_time-and-recovery-interval-options"></a><a name="InteractionBwnSettings"></a> Взаимодействие параметров TARGET_RECOVERY_TIME и «recovery interval»  
 Следующая таблица описывает связь между параметром сервера **sp_configure'** recovery interval **'** и соответствующим базе данных параметром `ALTER DATABASE ... TARGET_RECOVERY_TIME`.  
  
|target_recovery_time|«recovery interval»|Тип используемой контрольной точки|  
|----------------------------|-------------------------|-----------------------------|  
|0|0|автоматические контрольные точки, для которых целевой интервал восстановления равен 1 минуте.|  
|0|> 0|Автоматические контрольные точки, целевой интервал восстановления которых указан с помощью пользовательского параметра **sp_configure 'recovery interval'** .|  
|> 0|Неприменимо.|Косвенные контрольные точки, для которых целевое время восстановления определяется параметром TARGET_RECOVERY_TIME, выраженным в секундах.|  
  
##  <a name="automatic-checkpoints"></a><a name="AutomaticChkpt"></a> Автоматические контрольные точки  
Автоматическая контрольная точка создается каждый раз, когда число записей в журнале достигает значения, определенного [!INCLUDE[ssDE](../../includes/ssde-md.md)] в качестве предельного количества записей, которое может быть обработано за время, заданное параметром конфигурации сервера **recovery interval** . Дополнительные сведения см. в статье [Configure the recovery interval Server Configuration Option](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md).
 
В каждой базе данных без определяемого пользователем целевого времени восстановления [!INCLUDE[ssDE](../../includes/ssde-md.md)] создает автоматические контрольные точки. Частота зависит от параметра расширенной конфигурации сервера **recovery interval** , указывающего максимальное время, которое должен использовать данный экземпляр сервера для восстановления базы данных при перезагрузке системы. [!INCLUDE[ssDE](../../includes/ssde-md.md)] определяет максимальное число записей журнала, которое он может обработать в пределах интервала восстановления. Когда база данных, использующая автоматические контрольные точки, достигает данного максимального числа записей журнала, [!INCLUDE[ssDE](../../includes/ssde-md.md)] выдает контрольную точку базы данных. 
 
Интервал времени между автоматическими контрольными точками может **сильно** изменяться. В базе данных со значительной транзакционной рабочей нагрузкой контрольные точки будут устанавливаться более часто, чем в базе данных, используемой преимущественно для операций только для чтения. Кроме того, в простой модели восстановления автоматическая контрольная точка становится в очередь, если журнал заполняется на 70 процентов.  
  
В простой модели восстановления применение автоматической контрольной точки приводит к усечению неиспользуемого раздела журнала транзакций, если усечение журнала не откладывается под действием какого-то фактора. В отличие от этого, в полной модели восстановления и модели восстановления с неполным протоколированием после установления цепочки резервных копий журнала применение автоматических контрольных точек не вызывает усечение журнала. Дополнительные сведения см. в статье [Журнал транзакций (SQL Server)](../../relational-databases/logs/the-transaction-log-sql-server.md).  
  
После сбоя системы продолжительность времени, требуемого для восстановления данной базы данных, в большой степени зависит от непредсказуемо изменяющегося количества операций ввода-вывода, требуемых для повтора измененных страниц, которые не были зафиксированы ко времени сбоя. Это означает, что параметр **recovery interval** является ненадежным. Он не позволяет определить точную продолжительность восстановления. Более того, при выполнении автоматической контрольной точки общее количество операций ввода-вывода, относящихся к данным, увеличивается значительно и довольно непредсказуемо.  
   
###  <a name="impact-of-recovery-interval-on-recovery-performance"></a><a name="PerformanceImpact"></a> Влияние интервала восстановления на производительность восстановления  
Для системы оперативной обработки транзакций (OLTP) при использовании коротких транзакций параметр **recovery interval** является основным фактором, определяющим время восстановления. Тем не менее параметр **recovery interval** не влияет на количество времени, необходимого для отмены длительной транзакции. Восстановление базы данных с длительной транзакцией может потребовать гораздо больше времени, чем указано в параметре **recovery interval**. 
 
Например, если в длительной транзакции потребовалось бы два часа для проведения обновлений до того, как экземпляр сервера станет недоступным, то для фактического восстановления потребуется значительно больше времени, чем обозначено параметром **recovery interval** , на восстановление этой длительной транзакции. Дополнительные сведения о влиянии длительных транзакций на время восстановления см. в статье [Журнал транзакций (SQL Server)](../../relational-databases/logs/the-transaction-log-sql-server.md). Дополнительные сведения о процессе восстановления см. в статье [Обзор процессов восстановления (SQL Server)](../../relational-databases/backup-restore/restore-and-recovery-overview-sql-server.md#TlogAndRecovery).
  
Как правило, значения по умолчанию обеспечивают оптимальную производительность восстановления. Однако изменение интервала восстановления может способствовать повышению производительности в следующих случаях.  
  
-   Если восстановление обычно занимает намного больше 1 минуты при отсутствии отката длительных транзакций.  
  
-   Если обнаружено, что из-за более частого выполнения контрольных точек производительность базы данных снижается.  
  
Если принято решение увеличить параметр **recovery interval** , то рекомендуется увеличивать его постепенно с небольшими приращениями и оценивать влияние каждого приращения на производительность восстановления. Этот подход важен, потому что при увеличении значения параметра **recovery interval** время восстановления базы данных увеличивается пропорционально указанному значению. Например, если изменяется значение параметра **recovery interval** , равное 10 минутам, то время выполнения восстановления увеличится приблизительно в 10 раз по сравнению со значением **recovery interval** , установленным равным 1 минуте.  
  
##  <a name="indirect-checkpoints"></a><a name="IndirectChkpt"></a> Косвенные контрольные точки
Косвенные контрольные точки, которые были впервые введены в [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)], предоставляют настраиваемую на уровне баз данных альтернативу автоматическим контрольным точкам. Их можно настроить, задав параметр конфигурации базы данных **целевое время восстановления**. Дополнительные сведения см. в разделе [Изменение целевого времени восстановления базы данных (SQL Server)](../../relational-databases/logs/change-the-target-recovery-time-of-a-database-sql-server.md).
В случае сбоя системы косвенные контрольные точки обеспечивают восстановление за потенциально меньшее и более предсказуемое время, чем автоматические контрольные точки. Косвенные контрольные точки имеют следующие преимущества.  
  
-   В базе данных, которая настроена на использование косвенных контрольных точек, может снизиться производительность обработки транзакционной нагрузки в режиме "в сети". Косвенные конечные точки сохраняют количество "грязных" страниц ниже определенного порогового значения, чтобы восстановление базы данных выполнялось в течение заданного времени восстановления. 

  Параметр конфигурации **recovery interval** использует количество транзакций для определения времени восстановления вместо **косвенных контрольных точек**, которые основываются на количестве "грязных" страниц. Если косвенные конечные точки включены в базе данных, получающей большое число операций DML, средство фоновой записи может начать агрессивно сбрасывать «грязные» буферы обмена на диск, чтобы гарантировать, что время, необходимое для выполнения восстановления, находится в пределах целевого периода восстановления базы данных. Это может вызвать дополнительную активность операций ввода-вывода в определенных системах, что способно привести к созданию узких мест с точки зрения производительности, если подсистема диска превысила пороговое значение операций ввода-вывода или приближается к нему.  
  
-   Косвенные контрольные точки позволяют надежно управлять временем восстановления базы данных, поскольку устраняются затраты времени на ввод-вывод с непредсказуемым объемом при выполнении операций REDO. Это позволяет экземпляру сервера оставаться в пределах верхних границ времени восстановления для каждой конкретной базы данных (кроме тех случаев, когда из-за длительной транзакции чрезмерно возрастает время выполнения операций UNDO).  
  
-   При использовании косвенных контрольных точек снижаются пиковые объемы ввода-вывода, вызванные выполнением контрольных точек, поскольку измененные незафиксированные страницы постоянно записываются на диск в фоновом режиме.  
  
При этом в базе данных, которая настроена на использование косвенных контрольных точек, может снизиться производительность обработки транзакционной нагрузки в режиме "в сети". Это происходит из-за того, что фоновый модуль записи, используемый косвенной контрольной точкой, иногда увеличивает общую, связанную с записью нагрузку для экземпляра сервера.  
 
> [!IMPORTANT]
> Косвенные контрольные точки используются по умолчанию для всех новых баз данных (включая шаблоны и TempDB), созданных в [!INCLUDE[sssql16-md](../../includes/sssql16-md.md)].          
> Базы данных, которые были обновлены по месту или восстановлены из предыдущих версий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], будут использовать прежний режим автоматических контрольных точек, пока он не будет явно изменен на режим косвенных контрольных точек.       

### <a name="improved-indirect-checkpoint-scalability"></a><a name="ctp23"></a> Улучшена масштабируемость косвенных контрольных точек.
В версиях до [!INCLUDE[ssNoVersion](../../includes/sssql19-md.md)] пользователи могут сталкиваться с ошибками невыполнения в планировщике при наличии базы данных, которая создает большое количество "грязных" страниц, такой как `tempdb`. [!INCLUDE[sql-server-2019](../../includes/sssql19-md.md)] предоставляет улучшенную масштабируемость косвенных контрольных точек, что должно помочь избежать подобных ошибок в базах данных с высокой рабочей нагрузкой вида `UPDATE`/`INSERT`.
  
##  <a name="internal-checkpoints"></a><a name="EventsCausingChkpt"></a> Внутренние контрольные точки  
Внутренние контрольные точки создаются различными компонентами сервера для обеспечения того, чтобы образ диска соответствовал текущему состоянию журнала. Внутренние контрольные точки создаются в ответ на следующие события.  
  
-   При добавлении или удалении файлов баз данных с использованием инструкции ALTER DATABASE.  
  
-   При создании резервной копии базы данных.  
  
-   Явное или внутреннее создание моментального снимка базы данных для команды DBCC CHECKDB.  
  
-   При выполнении действия, требующего отключения базы данных. Примерами могут служить присвоение параметру AUTO_CLOSE значения ON и закрытие последнего соединения пользователя с базой данных или изменение параметра базы данных, требующее перезапуска базы данных.  
  
-   Экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] останавливается путем остановки службы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (MSSQLSERVER). И в том и в другом случае будет создана контрольная точка для каждой базы данных в экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].  
  
-   Перевод экземпляра отказоустойчивого кластера [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (FCI) в режим «вне сети».      
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> Related tasks  
 **Изменение интервала восстановления на экземпляре сервера**  
  
-   [Configure the recovery interval Server Configuration Option](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md)  
  
 **Настройка косвенных контрольных точек в базе данных**  
  
-   [Изменение целевого времени восстановления базы данных (SQL Server)](../../relational-databases/logs/change-the-target-recovery-time-of-a-database-sql-server.md)  
  
 **Выдача команды на создание контрольной точки в базе данных вручную**  
  
-   [CHECKPOINT (Transact-SQL)](../../t-sql/language-elements/checkpoint-transact-sql.md)  

## <a name="see-also"></a>См. также раздел  
[Журнал транзакций (SQL Server)](../../relational-databases/logs/the-transaction-log-sql-server.md)            
[Руководство по архитектуре журнала транзакций SQL Server и управлению им](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md)      
 
