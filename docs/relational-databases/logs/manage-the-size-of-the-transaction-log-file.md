---
title: Управление размером файла журнала транзакций | Документация Майкрософт
description: Сведения о мониторинге размера журнала транзакций SQL Server, сжатии журнала, увеличении журнала, оптимизации скорости роста журнала tempdb и управлении ростом журнала транзакций.
ms.custom: ''
ms.date: 01/05/2018
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- transaction logs [SQL Server], size management
- manage log size
- log size, manage
ms.assetid: 3a70e606-303f-47a8-96d4-2456a18d4297
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 699052eedf2a32faac9f3bf849f5f4aaa4c43b4c
ms.sourcegitcommit: b1cec968b919cfd6f4a438024bfdad00cf8e7080
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2021
ms.locfileid: "99237695"
---
# <a name="manage-the-size-of-the-transaction-log-file"></a>Управление размером файла журнала транзакций
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]
В этой статье рассказывается о мониторинге размера журнала транзакций [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], сжатии журнала транзакций, добавлении или увеличении файла журнала транзакций, оптимизации скорости роста журнала транзакций **tempdb**, а также об управлении размером файла журнала транзакций.  

##  <a name="monitor-log-space-use"></a><a name="MonitorSpaceUse"></a>Мониторинг используемого пространства журнала  
Для мониторинга используемого пространства журнала используйте [sys.dm_db_log_space_usage](../../relational-databases/system-dynamic-management-views/sys-dm-db-log-space-usage-transact-sql.md). Это динамическое административное представление возвращает сведения об используемом сейчас журналом объеме пространства и сообщает, когда журнал транзакций требует усечения. 

Для получения сведений о текущем размере файла журнала, его максимальном размере и параметре автоматического увеличения файла вы можете также использовать столбцы **size**, **max_size** и **growth** для данного файла журнала в представлении [sys.database_files](../../relational-databases/system-catalog-views/sys-database-files-transact-sql.md).  
  
> [!IMPORTANT]
> Избегайте переполнения содержащего журналы диска. Хранилище журналов должно отвечать требованиям к [числу операций ввода-вывода в секунду](https://wikipedia.org/wiki/IOPS) и низкой задержке для транзакционной нагрузки. 
  
##  <a name="shrink-log-file-size"></a><a name="ShrinkSize"></a> Уменьшение размера файла журнала  
 Для уменьшения реального размера физического файла журнала необходимо выполнить его сжатие. Это полезно, если файл журнала транзакций содержит неиспользованное пространство. Вы можете сжать файл журнала, только если база данных активна и хотя бы один [виртуальный файл журнала (VLF)](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md#physical_arch) свободен. В ряде случаев сжатие невозможно до тех пор, пока не выполнена следующая операция усечения журнала.  
  
> [!NOTE]
> Такие факторы, как долго выполняемые транзакции, из-за которых [виртуальные файлы журналов](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md#physical_arch) длительное время остаются в активном состоянии, могут ограничить или вовсе не допустить возможность сжатия журнала. Дополнительные сведения см. в разделе [Факторы, которые могут вызвать задержку усечения журнала](../../relational-databases/logs/the-transaction-log-sql-server.md#FactorsThatDelayTruncation).  
  
Сжатие файла журнала удаляет [виртуальные файлы журнала](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md#physical_arch), которые не содержат частей логического журнала (то есть, *неактивные виртуальные файлы журнала*). При сжатии файла журнала транзакций неактивные виртуальные файлы журнала в конце удаляются, чтобы журнал уменьшился приблизительно до целевого размера. 

> [!IMPORTANT]
> Перед сжатием следует учесть [факторы, которые могут вызвать задержку усечения журнала](../../relational-databases/logs/the-transaction-log-sql-server.md#FactorsThatDelayTruncation). Если после сжатия журнала снова потребуется дисковое пространство, размер журнала транзакций снова будет увеличиваться, что повлияет на производительность во время операций увеличения. Дополнительные сведения см. в разделе [Рекомендации](#Recommendations) этой статьи.
  
 **Сжатие файла журнала (без сжатия файлов базы данных)**  
  
-   [DBCC SHRINKFILE (Transact-SQL)](../../t-sql/database-console-commands/dbcc-shrinkfile-transact-sql.md)  
  
-   [Сжатие файла](../../relational-databases/databases/shrink-a-file.md)  
  
 **Мониторинг событий сжатия файла журнала**  
  
-   [Log File Auto Shrink Event Class](../../relational-databases/event-classes/log-file-auto-shrink-event-class.md).  
  
 **Мониторинг пространства журнала**  
  
-   [sys.dm_db_log_space_usage (Transact-SQL)](../../relational-databases/system-dynamic-management-views/sys-dm-db-log-space-usage-transact-sql.md)  
  
-   [sys.database_files (Transact-SQL)](../../relational-databases/system-catalog-views/sys-database-files-transact-sql.md) (См. столбцы **size**, **max_size** и **growth** файла или файлов журнала.)  
  
##  <a name="add-or-enlarge-a-log-file"></a><a name="AddOrEnlarge"></a> Добавление или увеличение размера файла журнала  
Вы можете выделить дополнительное место на диске, увеличив существующий файл журнала (если для этого достаточно места на диске) либо добавив файл журнала в базу данных, как правило, на другом диске. До тех пор, пока в журнале и на содержащем его дисковом томе достаточно свободного места, будет достаточного одного файла журнала транзакций.   
  
-   Чтобы добавить файл журнала в базу данных, используйте предложение `ADD LOG FILE` инструкции `ALTER DATABASE`. Это позволяет увеличить размер файла.  
-   Чтобы увеличить размер файла журнала, используйте предложение `MODIFY FILE` инструкции `ALTER DATABASE` с указанием синтаксиса `SIZE` и `MAXSIZE`. Дополнительные сведения см. в разделе [Параметры инструкции ALTER DATABASE (Transact-SQL) для файлов и файловых групп](../../t-sql/statements/alter-database-transact-sql-file-and-filegroup-options.md).  

Дополнительные сведения см. в разделе [Рекомендации](#Recommendations) этой статьи.
    
##  <a name="optimize-tempdb-transaction-log-size"></a><a name="tempdbOptimize"></a> Оптимизация размера журнала транзакций tempdb  
 При перезапуске экземпляра сервера размер журнала транзакций базы данных **tempdb** изменяется и становится равным исходному размеру, который был до применения параметра автоматического увеличения файла. Это может понизить производительность журнала транзакций базы данных **tempdb** . 
 
 Этого можно избежать с помощью увеличения размера журнала транзакций базы данных **tempdb** после запуска или перезапуска экземпляра сервера. Дополнительные сведения см. в статье [tempdb Database](../../relational-databases/databases/tempdb-database.md).  
  
##  <a name="control-transaction-log-file-growth"></a><a name="ControlGrowth"></a> Управление увеличением размера файла журнала транзакций  
 Для управления увеличением файла журнала транзакций используйте инструкцию [ALTER DATABASE (Transact-SQL) с параметрами для файлов и файловых групп](../../t-sql/statements/alter-database-transact-sql-file-and-filegroup-options.md). Следует отметить следующее.  
  
-   Чтобы изменить текущий размер файла в КБ, МБ, ГБ и ТБ, используйте параметр `SIZE`.  
-   Чтобы изменить шаг приращения размера, используйте параметр `FILEGROWTH`. Значение 0 указывает, что автоматическое приращение выключено и дополнительное пространство для файла не разрешено.  
-   Чтобы установить максимальный размер файла журнала в КБ, МБ, ГБ и ТБ или задать неограниченный размер (UNLIMITED), используйте параметр `MAXSIZE`.  

Дополнительные сведения см. в разделе [Рекомендации](#Recommendations) этой статьи.

## <a name="recommendations"></a><a name="Recommendations"></a> Рекомендации
Далее приведены некоторые общие рекомендации по работе с файлами журналов транзакций.

-   Шаг приращения автоматического увеличения журнала транзакций, задаваемый параметром `FILEGROWTH`, должен быть достаточно большим, чтобы с запасом соответствовать потребностям транзакций рабочих нагрузок. Во избежание слишком частых увеличений размера файла журнала следует задать достаточно большое значение шагу роста файла журнала. Чтобы подбирать оптимальный размер журнала транзакций, рекомендуем отслеживать объем журнала, занимаемый в следующих случаях.
    -  Во время, необходимое для выполнения полного резервного копирования, так как резервные копии журнала создаются только после его завершения.
    -  Во время, необходимое для самых продолжительных операций обслуживания индекса.
    -  Во время, необходимое для выполнения наибольшего пакета в базе данных.

-   При активации **autogrow** для файлов журналов и данных с помощью параметра `FILEGROWTH` может быть лучше задать рост журнала через размер (**size**), а не процент (**percentage**). Это позволит более эффективно контролировать увеличение, так как процент будет характеризовать постоянно растущую величину.
    -  Учитывайте, что журналы транзакций не могут использовать [мгновенную инициализацию файлов](../../relational-databases/databases/database-instant-file-initialization.md), поэтому особо продолжительное время их роста имеет критическую важность. 
    -  Рекомендуется не устанавливать для журналов транзакций значение параметра `FILEGROWTH` выше 1024 МБ. Значения для параметра `FILEGROWTH` по умолчанию.  
  
      |Версия|Значения по умолчанию|  
      |-------------|--------------------|  
      |Начиная с [!INCLUDE[sssql16-md](../../includes/sssql16-md.md)]|Данные — 64 МБ. Файлы журналов — 64 МБ.|  
      |Начиная с [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]|Данные — 1 МБ. Файлы журналов — 10 %.|  
      |До [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]|Данные — 10 %. Файлы журналов — 10 %.|  

-   При небольшом шаге приращения может формироваться слишком много [виртуальных файлов журнала](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md#physical_arch) малого размера и снижаться производительность. Чтобы определить оптимальное распределение виртуальных файлов журнала для текущего размера журнала транзакций всех баз данных в определенном экземпляре, а также требуемые приращения для достижения нужного размера, см. следующий [скрипт](https://github.com/Microsoft/tigertoolbox/tree/master/Fixing-VLFs).

-   При большом шаге приращения может формироваться слишком мало крупных [виртуальных файлов журнала](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md#physical_arch), что также повлияет на производительность. Чтобы определить оптимальное распределение виртуальных файлов журнала для текущего размера журнала транзакций всех баз данных в определенном экземпляре, а также требуемые приращения для достижения нужного размера, см. следующий [скрипт](https://github.com/Microsoft/tigertoolbox/tree/master/Fixing-VLFs). 

-   Даже если включено автоматическое увеличение, вы можете получить сообщение, что журнал транзакций заполнен, если его размер не может достаточно быстро увеличиваться под нужды вашего запроса. Дополнительные сведения об изменении шага приращения см. в разделе [Параметры инструкции ALTER DATABASE (Transact-SQL) для файлов и файловых групп](../../t-sql/statements/alter-database-transact-sql-file-and-filegroup-options.md)

-   Наличие множества файлов журнала в базе данных не способствует повышению производительности, так как файлы журнала транзакций не используют [пропорциональное заполнение](../../relational-databases/pages-and-extents-architecture-guide.md#ProportionalFill), как файлы данных в одной файловой группе.  

-   Вы можете настроить автоматическое сжатие файлов журналов. Но делать это **не рекомендуется**, и параметру базы данных **auto_shrink** по умолчанию задано значение FALSE. Если параметру **auto_shrink** задано значение TRUE, автоматическое сжатие уменьшает размер файла, только если в нем не использовано более 25 % объема. 
    -   Файл будет сжат либо до размера, в котором 25 % пространства не используется, либо до исходного размера, каким бы большим он ни был. 
    -   Сведения об изменении свойства **auto_shrink** см. в разделах [Просмотр или изменение свойств базы данных](../../relational-databases/databases/view-or-change-the-properties-of-a-database.md) и [Параметры ALTER DATABASE SET (Transact-SQL)](../../t-sql/statements/alter-database-transact-sql-set-options.md). 
  
## <a name="see-also"></a>См. также раздел  
[BACKUP (Transact-SQL)](../../t-sql/statements/backup-transact-sql.md)   
[Устранение неполадок при переполнении журнала транзакций (ошибка SQL Server 9002)](../../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md)    
[Раздел "Резервные копии журналов транзакций" в руководстве по архитектуре журнала транзакций SQL Server и управлению им](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md#Backups)    
[Резервные копии журналов транзакций (SQL Server)](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md)    
[Параметры инструкции ALTER DATABASE (Transact-SQL) для файлов и файловых групп](../../t-sql/statements/alter-database-transact-sql-file-and-filegroup-options.md)
