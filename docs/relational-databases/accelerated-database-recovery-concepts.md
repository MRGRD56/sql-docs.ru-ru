---
description: Ускоренное восстановление базы данных
title: Ускоренное восстановление баз данных | Документация Майкрософт
ms.date: 05/20/2020
ms.prod: sql
ms.prod_service: backup-restore
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- accelerated database recovery [SQL Server], recovery-only
- database recovery [SQL Server]
author: mashamsft
ms.author: mathoma
ms.reviewer: kfarlee
monikerRange: '>=sql-server-ver15'
ms.openlocfilehash: 70b68fa62c523a4c65bb4e70538e1882bc67290d
ms.sourcegitcommit: 917df4ffd22e4a229af7dc481dcce3ebba0aa4d7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/10/2021
ms.locfileid: "100350073"
---
# <a name="accelerated-database-recovery"></a>Ускоренное восстановление базы данных

[!INCLUDE [SQL Server ASDB, ASDBMI, ASDW ](../includes/applies-to-version/sql-asdb-asdbmi-asa.md)]

Ускорение восстановления баз данных (ADR) повышает доступность баз данных, особенно при наличии продолжительных транзакций, за счет перепроектирования процесса восстановления ядра СУБД SQL. ADR — это новая функция в SQL Server 2019. 

ADR также может использоваться для баз данных в Базе данных SQL Azure, Управляемом экземпляре SQL Azure и Azure Synapse SQL. В Базе данных SQL и Управляемом экземпляре SQL функция ADR включена по умолчанию и не может быть отключена. 

## <a name="overview"></a>Обзор

Основные преимущества ADR

- **Быстрое и согласованное восстановление баз данных**

  При использовании ADR длительные транзакции не влияют на общее время восстановления, благодаря чему обеспечивается быстрое и согласованное восстановление базы данных независимо от количества активных транзакций в системе или их размеров.

- **Мгновенный откат транзакции**

  При использовании ADR откат транзакций совершается мгновенно независимо от времени активности транзакции или количества выполненных обновлений.

- **Агрессивное усечение журнала**

  При использовании ADR журнал транзакций агрессивно усекается даже при наличии активных длительных транзакций, что предотвращает неконтролируемое увеличение его размера.

## <a name="the-current-database-recovery-process"></a>Текущий процесс восстановления базы данных

Если ADR не применяется, восстановление базы данных в SQL Server производится согласно модели восстановления [ARIES](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf) в три этапа, которые показаны на приведенной ниже схеме и более подробно описаны далее.

![текущий процесс восстановления](./media/accelerated-database-recovery-concepts/current-recovery-process.png)

- **Стадия анализа**

  SQL Server выполняет прямой просмотр журнала транзакций от начала последней успешной контрольной точки (или номера LSN самой старой "грязной" страницы) до конца, чтобы определить состояние каждой транзакции на момент остановки SQL Server.

- **Стадия повтора**

  SQL Server выполняет прямой просмотр журнала транзакций от самой старой незафиксированной транзакции до конца, чтобы перевести базу данных в состояние, которое она имела в момент сбоя, путем повторного выполнения всех зафиксированных операций.

- **Стадия отката**

  Для каждой транзакции, которая была активна в момент сбоя, SQL Server выполняет обратный проход по журналу, отменяя операции, совершенные этой транзакцией.

Согласно этой схеме время, необходимое ядру СУБД для восстановления после неожиданной перезагрузки, зависит от размера самой длительной активной транзакции в системе на момент сбоя. Для восстановления требуется откат всех незавершенных транзакций. Необходимое время пропорционально объему работы, выполненному транзакцией, и времени ее активности. Таким образом, при наличии длительных транзакций (например, больших операций массовой вставки или операций построения индекса для большой таблицы) процесс восстановления SQL Server может занимать много времени.

Кроме того, отмена или откат большой транзакции в соответствии с такой схемой может занимать много времени, так как при этом также требуется стадия отмены.

Кроме того, ядро СУБД не может усекать журнал транзакций, если имеются длительные транзакции, так как соответствующие записи журнала необходимы для процессов восстановления и отката. В результате некоторые журналы транзакций становятся очень большими и занимают очень много места на диске.

## <a name="the-accelerated-database-recovery-process"></a>Процесс ускоренного восстановления базы данных

ADR решает описанные выше проблемы благодаря полной перестройке процесса восстановления ядра СУБД.

- Процесс длится фиксированное время или производится мгновенно благодаря тому, что не приходится проверять журнал от начала самой старой активной транзакции. При использовании ADR журнал транзакций обрабатывается только от последней успешной контрольной точки (или регистрационного номера транзакции в журнале (LSN), принадлежащего самой старой "грязной" странице). В результате длительные транзакции не влияют на время восстановления.
- Уменьшается место, которое требуется для журнала транзакций, так как больше не нужно обрабатывать журнал для всей транзакции. В результате журнал транзакций может агрессивно усекаться при наличии контрольных точек и резервных копий.

На самом общем уровне ADR обеспечивает быстрое восстановление баз данных благодаря управлению версиями всех физических изменений базы данных и отмене только логических операций, которая может производиться почти мгновенно. Все транзакции, которые были активны во время сбоя, помечаются как прерванные. Поэтому все версии, созданные этими транзакциями, могут игнорироваться параллельными пользовательскими запросами.

Процесс восстановления ADR состоит из тех же трех этапов, что и текущий процесс восстановления. На схеме ниже показано, как происходят эти этапы в случае с ADR.

![Процесс восстановления ADR](./media/accelerated-database-recovery-concepts/adr-recovery-process.png)

- **Стадия анализа**

  Процесс аналогичен текущему, но кроме этого воссоздается sLog и копируются записи журнала для операций без версий.
  
- **Стадия повтора**

  Разбивается на два промежуточных этапа.
  - Промежуточный этап 1

      Повтор из sLog (от самой старой незафиксированной транзакции до последней контрольной точки). Повтор — это быстрая операция, так как требует обработки всего нескольких записей из sLog.

  - Промежуточный этап 2

     Повтор из журнала транзакций начинается с последней контрольной точки (а не с самой старой незафиксированной транзакции).
     
- **Стадия отката**

   Стадия отката при использовании ADR выполняется практически мгновенно благодаря применению sLog для отката операций без версий и постоянного хранилища версий (PVS) с логической отменой изменений для отката на основе версий на уровне строк.

Вы также можете просмотреть следующее 8-минутное видео, в котором объясняется работа ускоренного восстановления базы данных

> [!VIDEO https://channel9.msdn.com/Shows/Data-Exposed/Advanced-Database-Recovery--Data-Exposed/player?WT.mc_id=dataexposed-c9-niner]

## <a name="adr-recovery-components"></a>Компоненты восстановления ADR

Ниже приведены четыре основных компонента ADR.

- **Постоянное хранилище версий (PVS)**

  Постоянное хранилище версий — это механизм ядра СУБД для сохранения создаваемых версий строк в самой базе данных, а не в традиционном хранилище версий `tempdb`. PVS обеспечивает изоляцию ресурсов и повышает доступность вторичных реплик для чтения.

- **Логическая отмена изменений**

  Логическая отмена изменений — это асинхронный процесс, цель которого — откат на основе версий на уровне строк. Он обеспечивает мгновенный откат транзакций и отмену операций с управлением версиями.

  - Отслеживание всех аварийно завершенных транзакций
  - Выполнение отката с помощью PVS для всех пользовательских транзакций
  - Снятие всех блокировок сразу после аварийного завершения транзакции

- **sLog**

  sLog — это дополнительный поток журнала в памяти, в котором хранятся записи журнала для операций без версий (таких как перевод кэша метаданных в недействительное состояние, получение блокировки и т. д.). sLog обладает следующими особенностями:

  - малый объем и размещение в памяти;
  - сохраняется на диске путем сериализации во время обработки контрольных точек;
  - периодическое усекается при фиксации транзакций;
  - ускоряет повтор и отмену благодаря обработке только операций без версий;  
  - обеспечивает агрессивное усечение журнала транзакций за счет сохранения только необходимых записей журнала.

- **Очистка**

  Очистка — это асинхронный процесс, который периодически активируется и очищает ненужные версии страниц.

## <a name="who-should-consider-accelerated-database-recovery"></a>Когда следует использовать ускоренное восстановление баз данных

Функция ADR рекомендована для следующих категорий клиентов:

- клиенты с рабочими нагрузками, включающими длительные транзакции;
- клиенты, которые сталкивались с ситуацией, когда активные транзакции вызывают значительное увеличение размера журнала транзакций;  
- клиенты, у которых базы данных были долго недоступны из-за длительного восстановления SQL Server (например, вследствие непредвиденного перезапуска SQL Server или отката транзакций вручную).

>[!IMPORTANT]
>ADR не поддерживается для баз данных, развертываемых в зеркальном отображении базы данных.

## <a name="see-also"></a>См. также:  

[Управление ускоренным восстановлением баз данных](accelerated-database-recovery-management.md)
