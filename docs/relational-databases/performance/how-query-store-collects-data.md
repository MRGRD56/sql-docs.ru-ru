---
title: Как хранилище запросов собирает данные | Документация Майкрософт
description: Хранилище запросов SQL Server сохраняет связанные с запросами данные во внутренних таблицах и предоставляет их пользователям с помощью набора представлений.
ms.custom: ''
ms.date: 11/29/2018
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- Query Store, data collection
ms.assetid: 8d5eec36-0013-480a-9c11-183e162e4c8e
author: WilliamDAssafMSFT
ms.author: wiassaf
monikerRange: =azuresqldb-current||>=sql-server-2016||= azure-sqldw-latest||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: b534aefadb3e81e4ab889d04c1eebc1d9b2aef9e
ms.sourcegitcommit: 1a544cf4dd2720b124c3697d1e62ae7741db757c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2020
ms.locfileid: "97464835"
---
# <a name="how-query-store-collects-data"></a>Сбор данных в хранилище запросов
[!INCLUDE [SQL Server ASDB, ASDBMI, ASDW ](../../includes/applies-to-version/sql-asdb-asdbmi-asa.md)]

Хранилище запросов SQL Server работает подобно бортовому регистратору данных в самолете, непрерывно собирая сведения о компиляции и времени выполнения, связанные с запросами и планами. Связанные с запросами данные сохраняются во внутренних таблицах и предоставляются пользователям с помощью набора представлений.
  
## <a name="views"></a>Представления 
 На схеме ниже показаны представления хранилища запросов и их логические связи. Сведения о времени компиляции показаны в виде элементов синего цвета.
  
 ![Представления процессов хранилища запросов](../../relational-databases/performance/media/query-store-process-2views.png "query-store-process-2views")  
**Описания представлений**  
  
|Просмотр|Описание|  
|----------|-----------------|  
|**sys.query_store_query_text**|Показывает тексты уникальных запросов к базе данных. Комментарии и пробелы до и после текста запроса игнорируются. Комментарии и пробелы внутри текста учитываются. Каждая инструкция в пакете создает текстовую запись отдельного запроса.|  
|**sys.query_context_settings**|Показывает уникальные комбинации влияющих на план параметров, при которых выполняются запросы. Тот же текст запроса, выполненного с другими влияющими на план параметрами, создает запись отдельного запроса в хранилище запросов, так как элемент `context_settings_id` является частью ключа запроса.|  
|**sys.query_store_query**|Записи запросов, которые отслеживаются и принудительно выполняются отдельно в хранилище запросов. Текст одного запроса может создать несколько записей, если он выполняется при других контекстных параметрах или вне одних модулей [!INCLUDE[tsql](../../includes/tsql-md.md)] и внутри других (например, хранимые процедуры, триггеры).|  
|**sys.query_store_plan**|Показывает предполагаемый план запроса со статистикой времени компиляции. Хранимый план эквивалентен плану, получаемому при использовании `SET SHOWPLAN_XML ON`.|  
|**sys.query_store_runtime_stats_interval**|Хранилище запросов делит время на автоматически создаваемые интервалы времени и сохраняет сводные статистические данные в таких интервалах для каждого выполненного плана. Размер интервала регулируется параметром конфигурации **Интервал сбора статистики** (в [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)]) или параметром `INTERVAL_LENGTH_MINUTES` с помощью [параметров ALTER DATABASE SET (Transact-SQL)](../../t-sql/statements/alter-database-transact-sql-set-options.md).|  
|**sys.query_store_runtime_stats**|Сводная статистика времени выполнения для выполненных планов. Все собранные показатели выражаются в виде четырех статистических функций: Average (среднее), Maximum (максимум), Minimum (минимум), Standard Deviation (стандартное отклонение).|  
  
 Дополнительные сведения о представлениях хранилища запросов см. в разделе "Связанные представления, функции и процедуры" статьи [Мониторинг производительности с использованием хранилища запросов](monitoring-performance-by-using-the-query-store.md). 
  
## <a name="query-processing"></a>Обработка запросов
 Хранилище запросов взаимодействует с конвейером обработки запросов в следующих ключевых моментах:
  
1.  При первой компиляции запросов текст запроса и исходный план отправляются в хранилище запросов.
  
2.  При перекомпиляции запроса план обновляется в хранилище запросов. Если создается новый план, хранилище запросов добавляет новую запись плана для запроса, сохраняя предыдущие записи вместе со статистикой их выполнения.
  
3.  При выполнении запроса статистика времени выполнения отправляется в хранилище запросов. Хранилище запросов поддерживает точность сводной статистики для каждого плана, выполненного в течение активного на данный момент интервала. 
  
4.  Во время этапов компиляции и проверки на перекомпиляцию [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] определяет, есть ли в хранилище запросов план, который должен применяться к выполняемому в данный момент запросу. Если существует принудительный план и план в кэше процедур отличается от принудительного плана, то выполняется перекомпиляция запроса именно так, как если бы указание PLAN HINT было применено к этому запросу. Этот процесс происходит прозрачно для пользовательского приложения. 
  
 На следующей схеме показаны точки интеграции, описанные выше:
  
 ![Процессы хранилища запросов](../../relational-databases/performance/media/query-store-process-2processor.png "query-store-process-2processor") 

## <a name="remarks"></a>Remarks
 Чтобы свести к минимуму издержки ввода-вывода, новые данные записываются в память. Операции записи ставятся в очередь и записываются на диск позже. Сведения о запросах и планах (на схеме ниже это Plan Store) записываются на диск с минимальной задержкой. Статистика времени выполнения (Runtime Stats) хранится в памяти в течение времени, заданного параметром `DATA_FLUSH_INTERVAL_SECONDS` инструкции `SET QUERY_STORE`. Вы можете использовать диалоговое окно хранилища запросов [!INCLUDE[ssManStudio](../../includes/ssManStudio-md.md)], чтобы ввести значение для параметра **Интервал сброса записи данных на диск (мин)** , который внутри преобразуется в секунды. 
  
 ![План процесса хранилища запросов](../../relational-databases/performance/media/query-store-process-3.png "query-store-process-3plan") 
  
 В случае сбоя или завершения работы системы при использовании флага [trace 7745](../../relational-databases/performance/best-practice-with-the-query-store.md#Recovery) хранилище запросов может потерять данные среды выполнения, которые были собраны, но еще не сохранены, до временного окна, определенного через `DATA_FLUSH_INTERVAL_SECONDS`. Значение по умолчанию — 900 секунд (15 минут) — представляет собой рекомендуемое соотношение между эффективностью отслеживания запросов и доступностью данных.
 
 > [!IMPORTANT] 
 > Ограничение **Максимальный размер (МБ)** не применяется строго. Размер хранилища проверяется только в том случае, если хранилище запросов записывает данные на диск. Этот интервал задается параметром **Интервал записи данных на диск**. Если хранилище запросов нарушило ограничение максимального размера между проверками размера хранилища, оно будет переведено в режим только для чтения. Если параметр **Режим очистки на основе размера** включен, также активируется механизм очистки для принудительного применения ограничения максимального размера.
 
 > [!NOTE]
 > Если система испытывает недостаток памяти, статистика времени выполнения может быть сохранена на диске до наступления времени, определенного параметром `DATA_FLUSH_INTERVAL_SECONDS`.
 
 Во время чтения данных хранилища запросов данные из памяти и с диска прозрачно объединяются. 
 
 Если сеанс прерывается или клиентское приложение перезапускается или аварийно завершает работу, статистика запросов не будет записана. 
  
 ![Сведения о плане процесса хранилища запросов](../../relational-databases/performance/media/query-store-process-4planinfo.png "query-store-process-4planinfo")    

## <a name="see-also"></a>См. также раздел
 [Мониторинг производительности с использованием хранилища запросов](../../relational-databases/performance/monitoring-performance-by-using-the-query-store.md)  
 [Рекомендации по хранилищу запросов](../../relational-databases/performance/best-practice-with-the-query-store.md)  
 [Представления каталога хранилища запросов (Transact-SQL)](../../relational-databases/system-catalog-views/query-store-catalog-views-transact-sql.md) 
  
  
