---
title: Обновление баз данных посредством помощника по настройке запросов
description: Сведения о том, как помощник по настройке запросов поможет вам выполнить рекомендованный рабочий процесс для обеспечения стабильной производительности во время обновления до более новых версий SQL Server.
ms.custom: seo-dt-2019
ms.date: 02/13/2019
ms.prod: sql
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
f1_keywords:
- sql13.swb.querytuning.f1
helpviewer_keywords:
- query statistics [SQL Server] live query stats
- live query statistics
- debugging [SQL Server], live query stats
- statistics [SQL Server], live query statistics
- query profiling
- lightweight query profiling
- lightweight profiling
ms.assetid: 07f8f594-75b4-4591-8c29-d63811e7753e
author: pmasl
ms.author: pelopes
manager: amitban
ms.openlocfilehash: aafbba1fe5c4d7fe8c20b1d50d97bbd8a4277bae
ms.sourcegitcommit: 783b35f6478006d654491cb52f6edf108acf2482
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91890974"
---
# <a name="upgrading-databases-by-using-the-query-tuning-assistant"></a>Обновление баз данных с помощью помощника по настройке запросов

[!INCLUDE[tsql-appliesto-ss2016-xxxx-xxxx-xxx-md.md](../../includes/tsql-appliesto-ss2016-xxxx-xxxx-xxx-md.md)]

При миграции со старых версий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] на [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] или более новые версии и при [обновлении уровня совместимости базы данных](../../relational-databases/databases/view-or-change-the-compatibility-level-of-a-database.md) до последнего доступного выполнение рабочей нагрузки может замедляться. Такая ситуация наблюдается в меньшей степени при обновлении с [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] на более новую версию.

Начиная с [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] и с каждым выходом новой версии все изменения в оптимизаторе запросов привязаны к последнему уровню совместимости базы данных, поэтому планы выполнения изменяются не в момент обновления, а когда пользователь изменяет параметр базы данных `COMPATIBILITY_LEVEL` на последний доступный. Дополнительные сведения об изменениях в оптимизаторе запросов, представленных в [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)], см. в статье об [оценке кратности](../../relational-databases/performance/cardinality-estimation-sql-server.md). Дополнительные сведения об уровнях совместимости и их влиянии на обновления см. в разделе [Уровни совместимости и обновления ядра СУБД](../../t-sql/statements/alter-database-transact-sql-compatibility-level.md#compatibility-levels-and-database-engine-upgrades).

Эта возможность привязки, предоставляемая на уровне совместимости базы данных, в сочетании с хранилищем запросов обеспечивает высокий уровень контроля над производительностью запросов в процессе обновления, если обновление реализуется в рамках приведенного ниже рабочего процесса. Дополнительные сведения о рекомендуемом рабочем процессе для обновления уровня совместимости см. в статье [Изменение режима совместимости базы данных и использование хранилища запросов](../../database-engine/install-windows/change-the-database-compatibility-mode-and-use-the-query-store.md). 

![Рекомендуемый рабочий процесс обновления базы данных с использованием хранилища запросов](../../relational-databases/performance/media/query-store-usage-5.png "Рекомендуемый рабочий процесс обновления базы данных с использованием хранилища запросов") 

Контроль над обновлениями был усовершенствован в [!INCLUDE[ssSQL17](../../includes/sssql17-md.md)], где появилась возможность [автоматической настройки](../../relational-databases/automatic-tuning/automatic-tuning.md), которая позволяет автоматизировать последний шаг в указанном рекомендуемом рабочем процессе.

Начиная с [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] версии 18, используя новый **помощник по настройке запросов (QTA)** , пользователи смогут выполнять рекомендуемые действия для поддержки стабильной производительности во время обновлений до более новых версий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], как описано в разделе *Поддержание стабильной производительности во время обновления до новой версии SQL Server* статьи [Сценарии использования хранилища запросов](../../relational-databases/performance/query-store-usage-scenarios.md#CEUpgrade). Тем не менее QTA не выполняет откат к ранее известному удачному плану, как показано на предыдущем шаге рекомендуемого рабочего процесса. Вместо этого QTA будет отслеживать регрессии, обнаруженные в представлении [**запросов со сниженной производительностью** хранилища запросов](../../relational-databases/performance/monitoring-performance-by-using-the-query-store.md#Regressed), перебирая возможные перестановки вариантов применимой модели оптимизатора, чтобы создать новый улучшенный план.

> [!IMPORTANT]
> QTA не создает рабочую нагрузку пользователя. Если QTA выполняется в среде, которая не используется приложениями, убедитесь в том, что вы можете по-прежнему выполнять репрезентативную тестовую рабочую нагрузку в целевом [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] с помощью других средств.

## <a name="the-query-tuning-assistant-workflow"></a>Рабочий процесс помощника по настройке запросов

В начале работы QTA предполагается, что база данных из предыдущей версии [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] перемещается (с помощью [CREATE DATABASE … FOR ATTACH](../..//relational-databases/databases/attach-a-database.md) или [RESTORE](../../t-sql/statements/restore-statements-transact-sql.md)) в более новую версию [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)], а уровень совместимости базы данных перед обновлением изменяется не сразу. QTA поможет выполнить следующие действия.

1. Настройка хранилища запросов в соответствии с рекомендуемыми параметрами для заданной пользователем продолжительности рабочей нагрузки (в днях). Продолжительность рабочей нагрузки следует определять так, чтобы она соответствовала стандартному бизнес-циклу.
2. Запрос на запуск необходимой рабочей нагрузки, чтобы хранилище запросов могло собрать базовые данные рабочей нагрузки (если их еще нет).
3. Обновление до целевого уровня совместимости базы данных, выбранного пользователем.
4. Запрос на второй сбор данных рабочей нагрузки для сравнения и обнаружения регрессии.
5. Итерация по регрессиям, найденным на основе представления [Регрессионные запросы  **хранилища запросов**](../../relational-databases/performance/monitoring-performance-by-using-the-query-store.md#Regressed), экспериментирование путем сбора статистики времени выполнения в возможных перестановках применимых вариантов модели оптимизатора и оценка результата. 
6. Сообщение об измеренных улучшениях и сохранение этих изменений с помощью [структур планов](../../relational-databases/performance/plan-guides.md) (при необходимости).

Дополнительные сведения о присоединении базы данных см. в статье [Присоединение и отсоединение базы данных](../../relational-databases/databases/database-detach-and-attach-sql-server.md#AttachDb).

Ниже показано, как QTA меняет только последние этапы рекомендуемого рабочего процесса для обновления уровня совместимости с помощью упоминаемого выше хранилища запросов. Вместо возможности выбора между текущим неэффективным планом выполнения и последним известным удачным планом выполнения QTA представляет параметры настройки, соответствующие выбранным регрессионным запросам, чтобы создать новое улучшенное состояние с настроенными планами выполнения.

![Рекомендуемый рабочий процесс обновления базы данных с использованием QTA](../../relational-databases/performance/media/qta-usage.png "Рекомендуемый рабочий процесс обновления базы данных с использованием QTA")

### <a name="qta-tuning-internal-search-space"></a>Внутренняя область поиска QTA

QTA предназначен только для запросов `SELECT`, которые могут выполняться из хранилища запросов. Параметризованные запросы используются в том случае, если известен скомпилированный параметр. Запросы, которые зависят от конструкций среды выполнения, таких как временные таблицы или табличные переменные, сейчас недоступны.

Из-за изменений в версиях [модуля оценки кратности (CE)](../../relational-databases/performance/cardinality-estimation-sql-server.md) QTA работает с известными возможными шаблонами регрессий запросов. Например, при обновлении базы данных с [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] и уровнем совместимости 110 до [!INCLUDE[ssSQL17](../../includes/sssql17-md.md)] и уровнем совместимости 140 производительность некоторых запросов может снизиться, так как они были разработаны специально для поддержки версии CE, существовавшей в [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] (CE 70). Это не значит, что единственным вариантом является возврат с CE 140 на CE 70. Если регрессия происходит только из-за определенного изменения в более новой версии, можно указать этому запросу использовать лишь соответствующую часть предыдущей версии CE, которая хорошо работала для конкретного запроса, и при этом применять все остальные усовершенствования новых версий CE. Кроме того, можно разрешить другим запросам в рабочей нагрузке, которые не подверглись регрессии, использовать улучшения, доступные в более новых версиях CE.

Ниже перечислены шаблоны CE, поиск в которых выполнял QTA.

- **Независимость и корреляция**. Если допущение о независимости предоставляет лучшие оценки для конкретного запроса, то указание запроса `USE HINT ('ASSUME_MIN_SELECTIVITY_FOR_FILTER_ESTIMATES')` приводит к тому, что [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] создает план выполнения с использованием минимальной избирательности при оценке предикатов `AND` для фильтров, учитываемых для корреляции. Дополнительные сведения см. в разделах [Указания запроса USE HINT](../../t-sql/queries/hints-transact-sql-query.md#use_hint) и [Версии CE](../../relational-databases/performance/cardinality-estimation-sql-server.md#versions-of-the-ce).
- **Простая автономность и базовая автономность**. Если другое допущение соединения дает более точные оценки для конкретного запроса, то указание запроса `USE HINT ('ASSUME_JOIN_PREDICATE_DEPENDS_ON_FILTERS')` приводит к тому, что [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] создает план выполнения с использованием допущения простой автономности вместо допущения базовой автономности по умолчанию. Дополнительные сведения см. в разделах [Указания запроса USE HINT](../../t-sql/queries/hints-transact-sql-query.md#use_hint) и [Версии CE](../../relational-databases/performance/cardinality-estimation-sql-server.md#versions-of-the-ce).
- **Фиксированная оценка кратности для возвращающей табличные значения функции с несколькими инструкциями (MSTVF)** , равная 100 строкам или 1 строке. Если фиксированная оценка по умолчанию для возвращающих табличные значения функций, равная 100 строкам, не приводит к формированию более эффективного плана, чем тот, который создается при использовании фиксированной оценки для возвращающих табличные значения функций, равной 1 строке (соответствующей значению по умолчанию в модели CE оптимизатора запросов [!INCLUDE[ssKilimanjaro](../../includes/ssKilimanjaro-md.md)] и более ранних версий), то для формирования плана выполнения используется указание запроса `QUERYTRACEON 9488`. Дополнительные сведения о функциях MSTVF см. в статье [Создание определяемых пользователем функций (ядро СУБД)](../../relational-databases/user-defined-functions/create-user-defined-functions-database-engine.md#TVF).

> [!NOTE]
> В крайнем случае, если ограниченные указания не возвращают приемлемые результаты для соответствующих шаблонов запросов, можно принять во внимание полную поддержку CE 70 с использованием указания запроса `USE HINT ('FORCE_LEGACY_CARDINALITY_ESTIMATION')` для формирования плана выполнения.

> [!IMPORTANT]
> Любое указание приводит к определенным последствиям, которые могут быть рассмотрены в будущих обновлениях [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Рекомендуется применять указания только в тех случаях, когда не существует других вариантов. Кроме того, нужно запланировать пересмотр кода при каждом новом обновлении. Из-за принудительной реализации поведений на вашу рабочую нагрузку могут не распространяться улучшения, добавленные в новые версии [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].

## <a name="starting-query-tuning-assistant-for-database-upgrades"></a>Запуск помощника по настройке запросов для обновлений базы данных

QTA — это компонент на основе сеансов, который сохраняет состояние сеанса в схеме `msqta` базы данных пользователя, где сеанс был создан в первый раз. Со временем в одной базе данных можно создать несколько сеансов настройки, но для заданной базы данных может существовать только один активный сеанс.

### <a name="creating-a-database-upgrade-session"></a>Создание сеанса обновления базы данных

1. В [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] откройте обозреватель объектов и подключитесь к [!INCLUDE[ssDE](../../includes/ssde-md.md)].

2. Щелкните правой кнопкой мыши имя базы данных, уровень совместимости которой требуется обновить, выберите **Задачи**, **Обновление базы данных** и щелкните **Создать сеанс обновления базы данных**.

3. В окне мастера QTA необходимо выполнить два действия для настройки сеанса.

    1. В окне **Настройка** настройте хранилище запросов для записи эквивалента одного полного бизнес-цикла данных рабочей нагрузки для анализа и настройки.
        - Введите ожидаемую продолжительность рабочей нагрузки в днях (минимальное значение — 1 день). Это значение будет использоваться, чтобы предлагать рекомендуемые параметры хранилища запросов для предварительного разрешения на сбор всех базовых данных. Сбор подходящих базовых данных имеет важное значение для возможности анализа регрессионных запросов, обнаруженных после изменения уровня совместимости базы данных. 
        - Задайте намеченный целевой уровень совместимости базы данных, который должен быть у базы данных пользователя после завершения рабочего процесса QTA.
        После завершения нажмите кнопку **Далее**.

       ![Окно настройки нового сеанса обновления базы данных](../../relational-databases/performance/media/qta-new-session-setup.png "Окно настройки обновления базы данных")  
  
    2. В окне **Параметры** в двух столбцах отображаются **Текущие** настройки хранилища запросов в целевой базе данных, а также **Рекомендуемые** параметры. 
        - По умолчанию выбраны рекомендуемые параметры, но если установить переключатель над столбцом текущих параметров, они будут приняты, после чего можно будет точно настроить текущую конфигурацию хранилища запросов.
        - Предлагаемый параметр *Порог устаревания запросов* имеет значение, в два раза превышающее ожидаемую продолжительность рабочей нагрузки в днях. Это обусловлено тем, что хранилищу запросов потребуется хранить сведения о базовой рабочей нагрузке и рабочей нагрузке, выполняемой после обновления базы данных.
        После завершения нажмите кнопку **Далее**.

       ![Окно параметров обновления базы данных](../../relational-databases/performance/media/qta-new-session-settings.png "Окно параметров обновления базы данных")

       > [!IMPORTANT]
       > Предлагаемый параметр *Максимальный размер* имеет произвольное значение, которое может подойти для кратковременной рабочей нагрузки.
       > Однако следует иметь в виду, что для ресурсоемких рабочих нагрузок, а именно используемых при создании множества различных планов, хранение сведений о базовых и выполняемых после обновления базы данных рабочих нагрузках может оказаться недостаточным.
       > Если вы допускаете такую ситуацию, введите более высокое подходящее значение.

4. В окне **Настройка** выполняются заключительные шаги конфигурации сеанса и содержатся сведения о дальнейших действиях по открытию сеанса и работе с ним. После завершения нажмите кнопку **Готово**.

    ![Окно настройки обновления базы данных](../../relational-databases/performance/media/qta-new-session-tuning.png "Окно настройки обновления базы данных")

> [!NOTE]
> Возможный альтернативный сценарий начинается с восстановления резервной копии базы данных с рабочего сервера, где для базы данных уже выполнен рекомендуемый рабочий процесс обновления уровня совместимости, на тестовый сервер.

### <a name="executing-the-database-upgrade-workflow"></a>Выполнение рабочего процесса обновления базы данных

1. Щелкните правой кнопкой мыши имя базы данных, уровень совместимости которой требуется обновить, выберите **Задачи**, **Обновление базы данных** и щелкните **Отслеживать сеансы**.

2. На станице **Управление сеансами** указаны текущие и прошлые сеансы для базы данных. Выберите нужный сеанс и щелкните **Сведения**.

    > [!NOTE]
    > Если текущий сеанс отсутствует, нажмите кнопку **Обновить**.

    Список содержит следующие данные.
    - **Идентификатор сеанса**
    - **Имя сеанса**: созданное системой имя, состоящее из имени базы данных, даты и времени создания сеанса.
    - **Состояние**: состояние сеанса (активный или закрытый).
    - **Описание**: созданное системой описание, включающее выбранный пользователем целевой уровень совместимости базы данных и число дней для рабочей нагрузки бизнес-цикла.
    - **Время начала**: дата и время создания сеанса.

    ![Страница управления сеансом QTA](../../relational-databases/performance/media/qta-session-management.png "Страница управления сеансом QTA")

    > [!NOTE]
    > Кнопка **Удалить сеанс** служит для удаления всех данных, сохраненных для выбранного сеанса.
    > Однако при удалении закрытого сеанса **не** удаляются все ранее развернутые структуры планов.
    > При удалении сеанса, имеющего развернутые структуры планов, будет невозможно использовать QTA для отката.
    > Вместо этого найдите структуры планов с помощью системной таблицы [sys.plan_guides](../../relational-databases/system-catalog-views/sys-plan-guides-transact-sql.md) и удалите их вручную, используя [sp_control_plan_guide](../../relational-databases/system-stored-procedures/sp-control-plan-guide-transact-sql.md).
  
3. Отправной точкой для нового сеанса является шаг **Сбор данных**.

    > [!NOTE]
    > Кнопка **Сеансы** служит для возврата на страницу **управления сеансами**, а активный сеанс остается в текущем состоянии.

    Этот шаг состоит из трех этапов.

    1. **Сбор базовых данных** — пользователю отправляется запрос на запуск репрезентативного цикла рабочей нагрузки, чтобы хранилище данных могло собрать базовые данные. После завершения этой рабочей нагрузки установите флажок **Done with workload run** (Выполнено с помощью запуска рабочей нагрузки) и нажмите кнопку **Далее**.

        > [!NOTE]
        > Во время выполнения рабочей нагрузки окно QTA можно закрыть. При возвращении к сеансу, который остается в активном состоянии, работа будет возобновлена с того момента, когда она была остановлена. 

        ![QTA. Шаг 2, вложенный шаг 1](../../relational-databases/performance/media/qta-step2-substep1.png "QTA. Шаг 2, вложенный шаг 1")

    2. **Обновление базы данных** — вывод запроса на разрешение обновления уровня совместимости базы данных до нужного целевого уровня. Чтобы перейти к следующему вложенному шагу, нажмите кнопку **Да**.

        ![QTA. Шаг 2, вложенный шаг 2 — повышение уровня совместимости базы данных](../../relational-databases/performance/media/qta-step2-substep2-prompt.png "QTA. Шаг 2, вложенный шаг 2 — повышение уровня совместимости базы данных")

        На следующей странице подтверждается успешное обновление уровня совместимости базы данных.

        ![QTA. Шаг 2, вложенный шаг 2](../../relational-databases/performance/media/qta-step2-substep2.png "QTA. Шаг 2, вложенный шаг 2")

    3. **Наблюдаемый сбор данных** — запрос на повторный запуск репрезентативного цикла рабочей нагрузки, чтобы хранилище запросов могло собрать сравнительные базовые данные, которые будут использоваться для поиска возможностей оптимизации. При выполнении рабочей нагрузки нажимайте кнопку **Обновить**, чтобы обновлять список регрессионных запросов (если они будут найдены). Измените значение **Queries to show** (Число отображаемых запросов), чтобы ограничить число отображаемых запросов. Порядок элементов в списке зависит от значений параметров **Метрика** ("Продолжительность" или "Время ЦП") и **Статистическая обработка** ("Среднее" — значение по умолчанию). Кроме того, задайте значение параметра **Queries to show** (Число отображаемых запросов). После завершения этой рабочей нагрузки установите флажок **Done with workload run** (Выполнено с помощью запуска рабочей нагрузки) и нажмите кнопку **Далее**.

        ![QTA. Шаг 2, вложенный шаг 3](../../relational-databases/performance/media/qta-step2-substep3.png "QTA. Шаг 2, вложенный шаг 3")

        Список содержит следующие данные.
        - **Идентификатор запроса** 
        - **Текст запроса** — инструкция [!INCLUDE[tsql](../../includes/tsql-md.md)], развернуть которую можно с помощью кнопки с многоточием **...** .
        - **Запуски**: число выполнений этого запроса для всей коллекции рабочих нагрузок.
        - **Базовая метрика**: выбранная метрика ("Продолжительность" или "Время ЦП") в мс для сбора базовых данных до обновления уровня совместимости базы данных.
        - **Наблюдаемая метрика**: выбранная метрика ("Продолжительность" или "Время ЦП") в мс для сбора базовых данных после обновления уровня совместимости базы данных.
        - **% изменения**: выраженное в процентах изменение для выбранной метрики между состояниями до и после обновления уровня совместимости базы данных. Отрицательное число означает объем измеренной регрессии для запроса.
        - **Настраиваемые**: значение *True* или *False* в зависимости от того, подходит ли запрос для экспериментирования.

4. **Просмотр анализа** — выбор запросов для экспериментирования и поиска возможностей оптимизации. Значение **Queries to show** (Число отображаемых запросов) указывает на число подходящих для экспериментов запросов. После выбора нужных запросов нажмите кнопку **Далее**, чтобы начать экспериментирование.

    > [!NOTE]
    > Запросы, для которых параметр "Настраиваемые" имеет значение "False", нельзя выбирать для экспериментирования.

    > [!IMPORTANT]
    > Появится сообщение о том, что после перехода QTA на этап экспериментирования вернуться на страницу "Просмотр анализа" будет невозможно.   
    > Если перед переходом на этап экспериментирования вы не выбрали все подходящие запросы, потребуется позднее создать сеанс и повторить рабочий процесс. Для этого нужно сбросить уровень совместимости базы данных к предыдущему значению.

    ![QTA. Шаг 3](../../relational-databases/performance/media/qta-step3.png "QTA. Шаг 3")

5. **Просмотр результатов** — выбор запросов для развертывания предлагаемого решения в качестве структуры плана. 

    Список содержит следующие данные.
    - **Идентификатор запроса**
    - **Текст запроса** — инструкция [!INCLUDE[tsql](../../includes/tsql-md.md)], развернуть которую можно с помощью кнопки с многоточием **...** .
    - **Состояние**: отображение текущего состояния экспериментирования для запроса.
    - **Базовая метрика** — выбранная метрика ("Продолжительность" или "Время ЦП") в мс для запроса, как указано на **шаге 2, вложенном шаге 3**, представляющая регрессионный запрос после обновления уровня совместимости базы данных.
    - **Наблюдаемая метрика**: выбранная метрика ("Продолжительность" или "Время ЦП") в мс для запроса после экспериментирования для достаточной предложенной оптимизации.
    - **% изменения**: выраженное в процентах изменение для выбранной метрики между состояниями до и после экспериментирования, представляющее объем измеренного улучшения для запроса с предлагаемой оптимизацией.
    - **Параметр запроса**: ссылка на предлагаемое указание, которое улучшает метрику выполнения запроса.
    - **Можно развернуть**: значение *True* или *False* в зависимости от того, можно ли развернуть предлагаемую оптимизацию запроса в виде структуры плана.

    ![QTA. Шаг 4](../../relational-databases/performance/media/qta-step4.png "QTA. Шаг 4")

6. На шаге **Проверка** отображается состояние развертывания ранее выбранных запросов для этого сеанса. Список на этой странице отличается от предыдущей страницы тем, что здесь вместо столбца **Можно развернуть** находится столбец **Можно откатить**. Этот столбец может иметь значение *True* или *False* в зависимости от того, можно ли откатить развернутую оптимизацию запроса и удалить ее структуру плана.

    ![QTA. Шаг 5](../../relational-databases/performance/media/qta-step5.png "QTA. Шаг 5")

    Если в дальнейшем возникнет необходимость выполнить откат к предложенной оптимизации, выберите соответствующий запрос и нажмите кнопку **Откат**. Эта структура плана запроса удаляется, а список обновляется для удаления запроса, откат которого выполнен. Обратите внимание, что на рисунке ниже был удален запрос 8.

    ![QTA. Шаг 5 — откат](../../relational-databases/performance/media/qta-step5-rollback.png "QTA. Шаг 5 — откат")

    > [!NOTE]
    > При удалении закрытого сеанса **не** удаляются все ранее развернутые структуры планов.
    > При удалении сеанса, имеющего развернутые структуры планов, будет невозможно использовать QTA для отката.
    > Вместо этого найдите структуры планов с помощью системной таблицы [sys.plan_guides](../../relational-databases/system-catalog-views/sys-plan-guides-transact-sql.md) и удалите их вручную, используя [sp_control_plan_guide](../../relational-databases/system-stored-procedures/sp-control-plan-guide-transact-sql.md).
  
## <a name="permissions"></a>Разрешения

Необходимо быть членом роли **db_owner**.
  
## <a name="see-also"></a>См. также:

- [Уровни совместимости и обновления ядра СУБД](../../t-sql/statements/alter-database-transact-sql-compatibility-level.md#compatibility-levels-and-database-engine-upgrades)
- [Средства контроля и настройки производительности](../../relational-databases/performance/performance-monitoring-and-tuning-tools.md)
- [Мониторинг производительности с использованием хранилища запросов](../../relational-databases/performance/monitoring-performance-by-using-the-query-store.md)
- [Изменение режима совместимости базы данных и использование хранилища запросов](../../database-engine/install-windows/change-the-database-compatibility-mode-and-use-the-query-store.md)
- [Флаги трассировки](../../t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql.md)
- [Указания запросов USE HINT](../../t-sql/queries/hints-transact-sql-query.md#use_hint)
- [Модуль оценки кратности](../../relational-databases/performance/cardinality-estimation-sql-server.md)
- [Автоматическая настройка](../../relational-databases/automatic-tuning/automatic-tuning.md)   
- [Использование помощника по настройке запросов SQL Server](https://docs.microsoft.com/learn/modules/use-sql-server-query-tuning-assistant/)
