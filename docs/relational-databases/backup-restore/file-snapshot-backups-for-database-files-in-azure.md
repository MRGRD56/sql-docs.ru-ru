---
title: Резервные копии моментальных снимков файлов базы данных в Azure | Документация Майкрософт
description: Функция резервного копирования моментальных снимков файлов в SQL Server использует моментальные снимки Azure для быстрого создания резервных копий и еще более быстрого восстановления файлов баз данных, сохраненных с помощью службы хранилища BLOB-объектов Azure.
ms.custom: ''
ms.date: 05/23/2016
ms.prod: sql
ms.prod_service: backup-restore
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: 17a81fcd-8dbd-458d-a9c7-2b5209062f45
author: cawrites
ms.author: chadam
ms.openlocfilehash: 64eced0d45854db8d970c9cfbd15132ef00f070a
ms.sourcegitcommit: 917df4ffd22e4a229af7dc481dcce3ebba0aa4d7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/10/2021
ms.locfileid: "100345571"
---
# <a name="file-snapshot-backups-for-database-files-in-azure"></a>Резервные копии моментальных снимков файлов для файлов базы данных в Azure
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]
  [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Функция резервного копирования моментальных снимков файлов в Azure использует моментальные снимки Azure для практически мгновенного создания резервных копий и более быстрого восстановления файлов баз данных, сохраненных с помощью службы хранилища BLOB-объектов. Это позволяет упростить политики архивации и восстановления политик. Работа функции показана в [видеоролике, посвященном восстановлению до точки во времени](https://channel9.msdn.com/Blogs/Windows-Azure/File-Snapshot-Backups-Demo). Дополнительные сведения о сохранении файлов базы данных с помощью службы хранилища BLOB-объектов Azure см. в статье [Файлы данных SQL Server в Microsoft Azure](../../relational-databases/databases/sql-server-data-files-in-microsoft-azure.md).  
  
 ![Схема архитектуры резервного копирования моментальных снимков](../../relational-databases/backup-restore/media/snapshotbackups.PNG "Схема архитектуры резервного копирования моментальных снимков")  
  
 **Загрузить**  
  
-   Чтобы скачать [!INCLUDE[sssql16-md](../../includes/sssql16-md.md)], перейдите на сайт  **[Evaluation Center](https://www.microsoft.com/evalcenter/evaluate-sql-server-2016)** .  
  
-   Есть учетная запись Azure?  Тогда перейдите **[сюда](https://azure.microsoft.com/services/virtual-machines/sql-server/)** , чтобы запустить виртуальную машину с уже установленным [!INCLUDE[ssnoversion](../../includes/ssnoversion-md.md)] .  
  
## <a name="using-azure-snapshots-to-back-up-database-files-stored-in-azure"></a>Использование моментальных снимков для резервного копирования файлов базы данных, хранящихся в Azure  
  
### <a name="what-is-a-ssnoversion-file-snapshot-backup"></a>Что представляет собой резервная копия моментальных снимков файлов [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]  
 Резервная копия моментальных снимков файлов состоит из набора моментальных снимков Azure BLOB-объектов, содержащих файлы базы данных, а также файла резервной копии, содержащего указатели на эти снимки файлов. Каждый моментальный снимок файла хранится в контейнере с базовым BLOB-объектом. Вы можете настроить запись файла резервной копии на URL-адрес, диск или ленту. Рекомендуется выполнять резервное копирование на URL-адрес. Дополнительные сведения о резервном копировании см. в статье [BACKUP (Transact-SQL)](../../t-sql/statements/backup-transact-sql.md), а сведения резервном копировании на URL-адрес — в статье [Резервное копирование в SQL Server по URL-адресу](../../relational-databases/backup-restore/sql-server-backup-to-url.md).  
  
 ![Архитектура создания моментальных снимков](../../relational-databases/backup-restore/media/snapshotbackups-flat.png "Архитектура создания моментальных снимков")  
  
 При удалении базового большого двоичного объекта резервный набор данных становится недействительным, поэтому удаление BLOB-объекта, содержащего снимки файлов, заблокировано (однако вы можете явно выбрать удаление BLOB-объекта со всеми моментальными снимками файлов). Кроме того, удаление базы данных или файла данных не приводит к удалению базового большого двоичного объекта или любого из его снимков файлов. Удаление файла резервной копии также не приводит к удалению снимков файлов в резервном наборе данных. Чтобы удалить резервный набор данных моментальных снимков файлов, используйте системную хранимую процедуру **sys.sp_delete_backup** .  
  
 **Полное резервное копирование базы данных:** при выполнении полного резервного копирования базы данных с помощью моментальных снимков файлов создается моментальный снимок Azure всех файлов данных и журналов, из которых состоит база данных; формируется цепочка резервных копий журнала транзакций, а сведения о расположении снимков файлов записываются в файл резервной копии.  
  
 **Резервное копирование журнала транзакций:** при резервном копировании журнала транзакций с помощью резервного копирования моментальных снимков файлов создаются моментальные снимки всех файлов базы данных (а не только журнала транзакций), сведения о расположении снимков файлов записываются в файл резервной копии и журнал транзакций усекается.  
  
> [!IMPORTANT]  
>  После первоначального полного резервного копирования, необходимого для формирования цепочки резервных копий журнала транзакций (которая может быть резервной копией моментальных снимков файлов), останется только создать резервные копии журнала транзакций, поскольку каждый резервный набор данных моментальных снимков файлов журнала содержит снимки всех файлов базы данных и может использоваться для восстановления журнала или базы данных. После первоначального полного резервного копирования базы данных не требуется выполнять дополнительное полное или разностное резервное копирование, так как служба хранилища BLOB-объектов Azure обрабатывает различия между каждым моментальным снимком файла и текущим состоянием базового большого двоичного объекта для каждого файла базы данных.  
  
> [!NOTE]  
>  Учебник по использованию SQL Server 2016 со службой хранилища больших двоичных объектов Microsoft Azure см. в разделе [Учебник. Использование службы хранилища больших двоичных объектов Microsoft Azure с базами данных SQL Server 2016](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)  
  
### <a name="restore-using-file-snapshot-backups"></a>Восстановление с помощью резервных копий моментальных снимков файлов  
 Поскольку каждый резервный набор данных снимков файлов содержит моментальные снимки всех файлов базы данных, для восстановления потребуется не более двух смежных резервных наборов данных снимков файлов. Это верно независимо от того, создан ли резервный набор данных при полном резервном копировании базы данных или резервном копировании журнала. Этот процесс сильно отличается от процесса восстановления с помощью традиционного потокового резервного копирования. В ходе традиционного потокового резервного копирования процесс восстановления требует использования всей цепочки резервных наборов данных: полной резервной копии, разностной резервной копии и одной или нескольких резервных копий журнала транзакций. Этап восстановления в рамках этого процесса остается неизменным независимо от того, основан ли процесс на использовании резервной копии моментальных снимков файлов или набора данных потокового резервного копирования.  
  
 **До точки во времени любого резервного набора данных:** для выполнения операции RESTORE DATABASE для восстановления базы данных на момент времени определенного резервного набора данных моментальных снимков файлов требуется только такой резервный набор данных, а также собственно базовые BLOB-объекты. Поскольку для выполнения операции RESTORE DATABASE можно использовать резервный набор данных моментальных снимков файлов журнала транзакций, как правило, именно этот набор данных используется вместо полной резервной копии базы данных. В конце раздела приведен пример, демонстрирующий этот способ.  
  
 **До точки во времени между двумя резервными наборами данных моментальных снимков файлов:** для выполнения операции RESTORE DATABASE для восстановления базы данных на определенный момент времени между двумя резервными наборами данных смежных журналов транзакций требуются только два этих набора данных (до и после момента времени, на который предполагается восстановить базу данных). Для этого необходимо выполнить операцию RESTORE DATABASE с аргументом WITH NORECOVERY с использованием более раннего резервного набора данных моментальных снимков файлов журнала транзакций и операцию RESTORE LOG с аргументом WITH RECOVERY с использованием более позднего резервного набора данных журнала транзакций, а затем использовать аргумент STOPAT, чтобы указать момент времени для остановки восстановления из резервной копии журнала транзакций. В конце раздела приведен пример, демонстрирующий этот способ. Работа функции показана в [видеоролике, посвященном восстановлению до точки во времени](https://channel9.msdn.com/Blogs/Windows-Azure/File-Snapshot-Backups-Demo).  
  
### <a name="file-backup-set-maintenance"></a>Обслуживание резервной копии файлов  
 **Удаление резервного набора данных моментальных снимков файлов:** вы не можете перезаписать резервный набор данных моментальных снимков файлов с помощью аргумента FORMAT. Использование аргумента FORMAT запрещено, чтобы избежать появления потерянных моментальных снимков файлов, которые были созданы во время первоначального резервного копирования снимков файлов. Чтобы удалить резервный набор данных моментальных снимков файлов, используйте системную хранимую процедуру **sys.sp_delete_backup** . Эта хранимая процедура удаляет файл резервной копии и снимки файлов, из которых состоит резервный набор данных. Использование другого способа удаления резервного набора данных моментальных снимков файлов может привести к удалению файла резервной копии без удаления снимков файлов в резервном наборе данных.  
  
 **Удаление потерянных резервных копий моментальных снимков файлов:** потерянные снимки файлов могут появиться, если файл резервной копии был удален без использования системной хранимой процедуры **sys.sp_delete_backup** или если база данных или файл базы данных были удалены при наличии резервных копий моментальных снимков файлов, связанных с BLOB-объектами, которые содержат эту базу данных или файл базы данных. Чтобы обнаружить снимки файлов, которые могут быть потеряны, используйте системную функцию **sys.fn_db_backup_file_snapshots** для вывода списка всех моментальных снимков файлов базы данных. Чтобы обнаружить снимки файлов, которые входят в определенный резервный набор данных моментальных снимков файлов, используйте системную хранимую процедуру RESTORE FILELISTONLY. Затем можно использовать системную хранимую процедуру **sys.sp_delete_backup_file_snapshot** для удаления отдельных резервных копий моментальных снимков файлов, которые были потеряны. Примеры использования этой системной функции и системных хранимых процедур приведены в конце этого раздела. Дополнительные сведения см. в разделах [sp_delete_backup (Transact-SQL)](../../relational-databases/system-stored-procedures/snapshot-backup-sp-delete-backup.md), [sys.fn_db_backup_file_snapshots (Transact-SQL)](../../relational-databases/system-functions/sys-fn-db-backup-file-snapshots-transact-sql.md), [sp_delete_backup_file_snapshot (Transact-SQL)](../../relational-databases/system-stored-procedures/snapshot-backup-sp-delete-backup-file-snapshot.md) и [RESTORE FILELISTONLY (Transact-SQL)](../../t-sql/statements/restore-statements-filelistonly-transact-sql.md).  
  
### <a name="considerations-and-limitations"></a>Рекомендации и ограничения  
 **Хранилище класса Premium:** при использовании хранилища класса Premium применяются следующие ограничения:  
  
-   файл резервной копии нельзя сохранить в хранилище Premium;  
  
-   резервное копирование нельзя выполнять чаще 10 минут;  
  
-   максимальное количество сохраняемых моментальных снимков — 100;  
  
-   обязательно использование RESTORE WITH MOVE.  
  
-   Дополнительные сведения о хранилище класса Premium см. в статье [Хранилище класса Premium: высокопроизводительное хранилище для рабочих нагрузок виртуальных машин Azure](/azure/virtual-machines/disks-types).  
  
 **Одна учетная запись хранения:** для моментальных снимков файлов и BLOB-объектов назначения нужно использовать одну учетную запись хранения.  
  
 **Модель восстановления с неполным протоколированием:** если при работе с резервной копией журнала транзакций, содержащей транзакции с минимальным протоколированием, используется модель восстановления с неполным протоколированием, восстановление журнала (включая восстановление на определенный момент времени) невозможно выполнить с помощью резервной копии журнала транзакций. Вместо этого выполняется восстановление базы данных до момента времени резервного набора данных моментальных снимков файлов. Это ограничение аналогично ограничению для потокового резервного копирования.  
  
 **Оперативное восстановление:** при использовании резервных копий моментальных снимков файлов невозможно выполнить оперативное восстановление. Дополнительные сведения об оперативном восстановлении см. в статье [Оперативное восстановление (SQL Server)](../../relational-databases/backup-restore/online-restore-sql-server.md).  
  
 **Выставление счетов.** при использовании резервного копирования моментальных снимков файлов SQL Server по мере изменения данных будет взиматься дополнительная плата. Дополнительные сведения см. в статье [Основные сведения о том, как моментальные снимки увеличивают плату](/rest/api/storageservices/Understanding-How-Snapshots-Accrue-Charges).  
  
 **Архивация:** если требуется архивировать резервную копию моментальных снимков файлов, можно использовать хранилище BLOB-объектов или потоковое резервное копирование. Для архивации в хранилище BLOB-объектов скопируйте моментальные снимки в резервном наборе данных моментальных снимков файлов в отдельные BLOB-объекты. Для архивации в режиме потокового резервного копирования восстановите резервную копию моментальных снимков файлов как новую базу данных, а затем выполните обычное потоковое резервное копирование со сжатием и (или) шифрованием и храните копию в течение любого времени, независимо от базовых BLOB-объектов.  
  
> [!IMPORTANT]  
>  Обслуживание нескольких резервных копий моментальных снимков файлов незначительно влияет на производительность. Тем не менее обслуживание чрезмерного количества резервных копий снимков файлов может влиять на производительность операций ввода-вывода в базе данных. Мы рекомендуем обслуживать только те резервные копии моментальных снимков файлов, которые необходимы для поддержки целевой точки восстановления.  
  
## <a name="backing-up-the-database-and-log-using-a-file-snapshot-backup"></a>Резервное копирование базы данных и журнала с помощью резервной копии моментальных снимков файлов  
 В следующем примере резервное копирование снимков файлов используется для резервного копирования примера базы данных AdventureWorks2016 на URL-адрес.  
  
```  
-- To permit log backups, before the full database backup, modify the database   
-- to use the full recovery model.  
USE master;  
GO  
ALTER DATABASE AdventureWorks2016  
   SET RECOVERY FULL;  
GO  
-- Back up the full AdventureWorks2016 database.  
BACKUP DATABASE AdventureWorks2016   
TO URL = 'https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>/AdventureWorks2016.bak'   
WITH FILE_SNAPSHOT;  
GO  
-- Back up the AdventureWorks2016 log using a time stamp in the backup file name.  
DECLARE @Log_Filename AS VARCHAR (300);  
SET @Log_Filename = 'https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>/AdventureWorks2016_Log_'+   
REPLACE (REPLACE (REPLACE (CONVERT (VARCHAR (40), GETDATE (), 120), '-','_'),':', '_'),' ', '_') + '.trn';  
BACKUP LOG AdventureWorks2016  
 TO URL = @Log_Filename WITH FILE_SNAPSHOT;  
GO  
```  
  
## <a name="restoring-from-a-ssnoversion-file-snapshot-backup"></a>Восстановление из резервной копии моментальных снимков файлов [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]  
 В следующем примере выполняется восстановление базы данных AdventureWorks2016 с помощью резервного набора данных моментальных снимков файлов журнала транзакций и демонстрируется операция восстановления. Обратите внимание, что базу данных можно восстановить из одного резервного набора данных моментальных снимков файлов журнала транзакций.  
  
```  
RESTORE DATABASE AdventureWorks2016 FROM URL = 'https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>/AdventureWorks2016_2015_05_18_16_00_00.trn'   
WITH RECOVERY, REPLACE;  
GO  
```  
  
## <a name="restoring-from-a-ssnoversion-file-snapshot-backup-to-a-point-in-time"></a>Восстановление из резервной копии моментальных снимков файлов [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] до точки во времени  
 В следующем примере выполняется восстановление AdventureWorks2016 до состояния на указанный момент времени с помощью двух резервных наборов данных снимков файлов журнала транзакций и демонстрируется операция восстановления.  
  
```  
RESTORE DATABASE AdventureWorks2016 FROM URL = 'https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>/AdventureWorks2016_2015_05_18_16_00_00.trn'   
WITH NORECOVERY,REPLACE;  
GO   
  
RESTORE LOG AdventureWorks2016 FROM URL = 'https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>/AdventureWorks2016_2015_05_18_18_00_00.trn'   
WITH RECOVERY,STOPAT = 'May 18, 2015 5:35 PM';  
GO  
```  
  
## <a name="deleting-a-database-file-snapshot-backup-set"></a>Удаление резервного набора данных моментальных снимков файлов базы данных  
 Чтобы удалить резервный набор данных моментальных снимков файлов, используйте системную хранимую процедуру **sys.sp_delete_backup** . Укажите имя базы данных, чтобы система могла подтвердить, что указанный резервный набор данных моментальных снимков файлов действительно является резервной копией указанной базы данных. Если имя базы данных не указано, заданный резервный набор данных вместе со снимками файлов будет удален без проверки. Дополнительные сведения см. в разделе [sp_delete_backup (Transact-SQL)](../../relational-databases/system-stored-procedures/snapshot-backup-sp-delete-backup.md).  
  
> [!WARNING]  
>  Попытка удалить резервный набор данных моментальных снимков файлов другим способом, например с помощью портала управления Microsoft Azure или средства просмотра хранилищ Azure в SQL Server Management Studio, не приведет к удалению снимков файлов в резервном наборе данных. Эти средства удаляют только сам файл резервной копии, содержащий указатели на снимки файлов в резервном наборе данных моментальных снимков. Для обнаружения резервных копий моментальных снимков файлов, оставшихся после некорректного удаления файла резервной копии, используйте системную функцию **sys.fn_db_backup_file_snapshots** , а затем системную хранимую процедуру **sys.sp_delete_backup_file_snapshot** для удаления отдельных резервных копий снимков файлов.  
  
 В следующем примере демонстрируется удаление указанного резервного набора данных снимков файлов, включая файл резервной копии и снимки файлов, из которых состоит указанный резервный набор данных.  
  
```  
sys.sp_delete_backup 'https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>/AdventureWorks2016.bak', 'adventureworks2016' ;  
GO  
  
```  
  
## <a name="viewing-database-backup-file-snapshots"></a>Просмотр резервных копий моментальных снимков файлов базы данных  
 Чтобы просмотреть моментальные снимки файлов базового BLOB-объекта для каждого файла базы данных, используйте системную функцию **sys.fn_db_backup_file_snapshots** . Эта системная функция позволяет просматривать все резервные копии снимков файлов каждого базового BLOB-объекта для базы данных, сохраненной службой хранилища BLOB-объектов. Основная сфера применения этой функции — выявление резервных копий снимков файлов базы данных, оставшихся после удаления файла резервной копии для резервного набора данных снимков файлов с помощью механизма, отличного от системной хранимой процедуры **sys.sp_delete_backup** . Чтобы обнаружить копии моментальных снимков файлов, которые являются частью неизменных резервных наборов данных, и копии, которые не являются частью неизменных резервных наборов данных, используйте системную хранимую процедуру **RESTORE FILELISTONLY**  для получения списка снимков файлов, принадлежащих каждому файлу резервной копии. Дополнительные сведения см. в разделах [sys.fn_db_backup_file_snapshots (Transact-SQL)](../../relational-databases/system-functions/sys-fn-db-backup-file-snapshots-transact-sql.md) и [RESTORE FILELISTONLY (Transact-SQL)](../../t-sql/statements/restore-statements-filelistonly-transact-sql.md).  
  
 Следующий пример кода возвращает список всех резервных копий моментальных снимков файлов для указанной базы данных.  
  
```  
--Either specify the database name or set the database context  
USE AdventureWorks2016  
select * from sys.fn_db_backup_file_snapshots (null) ;  
GO  
select * from sys.fn_db_backup_file_snapshots ('AdventureWorks2016') ;  
GO  
  
```  
  
## <a name="deleting-an-individual-database-backup-file-snapshot"></a>Удаление отдельной резервной копии моментальных снимков файлов базы данных  
 Чтобы удалить отдельную резервную копию снимков файлов базового BLOB-объекта базы данных, используйте системную хранимую процедуру **sys.sp_delete_backup_file_snapshot** . Основная сфера применения этой системной хранимой процедуры — удаление потерянных моментальных снимков файлов, оставшихся после удаления файла резервной копии, способом, отличным от системной хранимой процедуры **sys.sp_delete_backup** . Дополнительные сведения см. в разделе [sp_delete_backup_file_snapshot (Transact-SQL)](../../relational-databases/system-stored-procedures/snapshot-backup-sp-delete-backup-file-snapshot.md).  
  
> [!WARNING]  
>  Если удалить отдельный моментальный снимок файла, который является частью резервного набора данных снимков файлов, такой резервный набор данных становится недействительным.  
  
 В следующем примере демонстрируется удаление указанной резервной копии снимков файлов. URL-адрес для указанной резервной копии был получен с помощью системной функции **sys.fn_db_backup_file_snapshots** .  
  
```  
sys.sp_delete_backup_file_snapshot N'adventureworks2016', N'https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>/AdventureWorks2016Data.mdf?snapshot=2015-05-29T21:31:31.6502195Z';  
GO  
```  
  
## <a name="see-also"></a>См. также:  
 [Руководство. Использование службы хранилища больших двоичных объектов Microsoft Azure с базами данных SQL Server 2016](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)  
  
