---
title: Шифрование резервной копии | Документация Майкрософт
description: В этой статье описываются варианты шифрования для резервных копий SQL Server, включая использование, преимущества и рекомендуемые методики шифрования во время резервного копирования.
ms.custom: ''
ms.date: 03/14/2017
ms.prod: sql
ms.prod_service: backup-restore
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: 334b95a8-6061-4fe0-9e34-b32c9f1706ce
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: a73fde3a0d1c254709d63a85f7a7028c8da30891
ms.sourcegitcommit: c74bb5944994e34b102615b592fdaabe54713047
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/22/2020
ms.locfileid: "90989840"
---
# <a name="backup-encryption"></a>Шифрование резервной копии
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]
  В этом разделе приводится общее описание параметров шифрования для резервного копирования [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] . Он содержит сведения об использовании, преимуществах и рекомендациях для шифрования при резервном копировании.  

## <a name="overview"></a><a name="Overview"></a> Обзор  
 Начиная с [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)], в SQL Server имеется возможность шифровать данные при создании резервных копий. Указав алгоритм шифрования и шифратор (сертификат или асимметричный ключ), можно задать для резервных копий создание зашифрованного файла резервной копии. Все назначения хранилища: поддерживаются локальное хранилище и хранилище Windows Azure. Кроме того, можно настроить параметры шифрования для операций служб [!INCLUDE[ss_smartbackup](../../includes/ss-smartbackup-md.md)] (новая функция, введенная в [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)]).  
  
 Для шифрования резервной копии необходимо указать алгоритм шифрования и шифратор для защиты ключа шифрования. Поддерживаются следующие варианты шифрования:  
  
- **Алгоритм шифрования:** поддерживаются следующие алгоритмы шифрования: AES 128, AES 192, AES 256 и Triple DES.  
  
- **Шифратор:** сертификат или асимметричный ключ.  
  
> [!CAUTION]  
> Очень важно создать резервную копию сертификата или асимметричного ключа и предпочтительно в ином местоположении, чем зашифрованный ими файл резервной копии. Без сертификата или асимметричного ключа резервную копию нельзя будет восстановить, т. е. файл резервной копии будет непригоден для использования.  
  
 **Восстановление из зашифрованной резервной копии**. Восстановление SQL Server не требует указания никаких параметров шифрования во время восстановления. Для него требуется, чтобы сертификат или асимметричный ключ, использованный при шифровании файла резервной копии, был доступен в экземпляре, на который производится восстановление. Учетная запись пользователя, выполняющего восстановление, должна иметь разрешения **VIEW DEFINITION** на сертификат или ключ. Если зашифрованная резервная копия восстанавливается на другой экземпляр, необходимо убедиться, что сертификат доступен на этом экземпляре.  
Восстанавливать зашифрованную базу данных в новое расположение нужно в следующей последовательности:

1. [BACKUP CERTIFICATE (Transact-SQL)](../../t-sql/statements/backup-certificate-transact-sql.md) в старой базе данных;
1. [CREATE MASTER KEY (Transact-SQL)](../../t-sql/statements/create-master-key-transact-sql.md) в базе данных master в новом расположении;
1. [CREATE CERTIFICATE (Transact-SQL)](../../t-sql/statements/create-certificate-transact-sql.md) с использованием резервного сертификата старой базы данных, который импортируется в расположение на новом сервере;
1. [Восстановление базы данных в новое место (SQL Server)](../../relational-databases/backup-restore/restore-a-database-to-a-new-location-sql-server.md)

 При восстановлении резервной копии из базы данных c прозрачным шифрованием сертификат TDE должен быть доступен на экземпляре, на который производится восстановление. Дополнительные сведения см. в разделе [Перемещение базы данных, защищаемой прозрачным шифрованием, в другой экземпляр SQL Server](../../relational-databases/security/encryption/move-a-tde-protected-database-to-another-sql-server.md).
  
##  <a name="benefits"></a><a name="Benefits"></a> Преимущества  
  
1. Шифрование резервных копий базы данных помогает обезопасить данные: SQL Server предоставляет возможность шифрования данных при создании резервных копий.  
  
1. Шифрование можно также использовать для баз данных, зашифрованных с помощью прозрачного шифрования.  
  
1. Шифрование поддерживается для резервных копий, созданных с помощью служб [!INCLUDE[ss_smartbackup](../../includes/ss-smartbackup-md.md)], предоставляющих дополнительную защиту для сторонних резервных копий.  
  
1. Эта функция поддерживает несколько алгоритмов шифрования вплоть до 256-битного AES. Это дает возможность выбрать алгоритм, соответствующий требованиям.  
  
1. Ключи шифрования можно интегрировать с поставщиками расширенного управления ключами (EKM).  
 
##  <a name="prerequisites"></a><a name="Prerequisites"></a> Предварительные требования  
 Предварительные требования, обязательные для шифрования резервной копии:  
  
1. **Создайте главный ключ базы данных для базы данных master**. Главный ключ базы данных — это симметричный ключ, который применяется для защиты закрытых ключей сертификатов и асимметричный ключей, которые есть в базе данных. Дополнительные сведения см. в разделе [Ключи шифрования базы данных и SQL Server (компонент Database Engine)](../../relational-databases/security/encryption/sql-server-and-database-encryption-keys-database-engine.md).  
  
1. Создайте сертификат или асимметричный ключ для шифрования резервной копии. Дополнительные сведения о создании сертификата см. в разделе [CREATE CERTIFICATE (Transact-SQL)](../../t-sql/statements/create-certificate-transact-sql.md). Дополнительные сведения о создании асимметричного ключа см. в разделе [CREATE ASYMMETRIC KEY (Transact-SQL)](../../t-sql/statements/create-asymmetric-key-transact-sql.md).  
  
    > [!IMPORTANT]  
    >  Поддерживаются только асимметричные ключи, относящиеся к расширенному управлению ключами (EKM).  
  
##  <a name="restrictions"></a><a name="Restrictions"></a> Ограничения  
 К параметрам шифрования применяются следующие ограничения.  
  
- При шифровании резервной копии с помощью асимметричного ключа поддерживаются только асимметричные ключи, находящиеся в поставщике расширенного управления ключами.  
  
- SQL Server Express и SQL Server Web не поддерживают шифрование при резервном копировании. Однако восстановление из зашифрованной резервной копии в экземпляр SQL Server Express или SQL Server Web поддерживается.  
  
- В предыдущих версиях [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] считывание зашифрованных резервных копий не поддерживается.  
  
- Присоединение к существующему резервному набору данных для зашифрованных резервных копий не поддерживается.  

##  <a name="permissions"></a><a name="Permissions"></a> Permissions  

Для учетной записи, которая выполняет операции резервного копирования в зашифрованной базе данных, требуются определенные разрешения. 

- Роль уровня базы данных **db_backupoperator** для базы данных, для которой выполняется резервное копирование. Это необходимо, независимо от шифрования. 
- Требует разрешения **VIEW DEFINITION** на сертификат в базе данных `master`.

   В следующем примере предоставляются соответствующие разрешения для сертификата. 
   
   ```tsql
   USE [master]
   GO
   GRANT VIEW DEFINITION ON CERTIFICATE::[<SERVER_CERT>] TO [<db_account>]
   GO
   ```

> [!NOTE]  
> Доступ к сертификату TDE для резервного копирования или восстановления базы данных, защищенной прозрачным шифрованием, не требуется.  
  
## <a name="backup-encryption-methods"></a><a name="Methods"></a> Методы шифрования резервной копии  
 В разделах ниже представлен краткий обзор шагов шифрования данных при резервном копировании. Полное пошаговое руководство по различным этапам шифрования резервных копий с помощью Transact-SQL см. в разделе [Создание зашифрованной резервной копии](../../relational-databases/backup-restore/create-an-encrypted-backup.md).  
  
### <a name="using-sql-server-management-studio"></a>Использование среды SQL Server Management Studio  
 Резервную копию базы данных можно зашифровать при ее создании в одном из следующих диалоговых окон:  
  
1. [Резервное копирование базы данных (страница "Параметры резервного копирования")](../../relational-databases/backup-restore/back-up-database-backup-options-page.md) На странице **Параметры резервного копирования** можно выбрать **Шифрование** и указать алгоритм шифрования и сертификат или асимметричный ключ, используемый для него.  
  
1. [Использование мастера планов обслуживания](../../relational-databases/maintenance-plans/use-the-maintenance-plan-wizard.md#SSMSProcedure) При выборе задачи резервного копирования на вкладке **Параметры** страницы **Определение задач резервного копирования** можно выбрать **Шифрование резервной копии**и указать алгоритм шифрования и ключ или сертификат, используемый для него.  
  
### <a name="using-transact-sql"></a>Использование Transact-SQL  
 Ниже приведен пример инструкции T-SQL для шифрования файла резервной копии.  
  
```sql  
BACKUP DATABASE [MYTestDB]  
TO DISK = N'C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\Backup\MyTestDB.bak'  
WITH  
  COMPRESSION,  
  ENCRYPTION   
   (  
   ALGORITHM = AES_256,  
   SERVER CERTIFICATE = BackupEncryptCert  
   ),  
  STATS = 10  
GO  
```  
  
 Полный синтаксис инструкции Transact-SQL см. в разделе [BACKUP (Transact-SQL)](../../t-sql/statements/backup-transact-sql.md).  
  
### <a name="using-powershell"></a>Использование PowerShell  
 В этом примере создаются параметры шифрования, которые используются в качестве значения параметра в командлете **Backup-SqlDatabase** для создания зашифрованной резервной копии.  
  
```powershell
$encryptionOption = New-SqlBackupEncryptionOption -Algorithm Aes256 -EncryptorType ServerCertificate -EncryptorName "BackupCert"  

Backup-SqlDatabase -ServerInstance . -Database "<myDatabase>" -BackupFile "<myDatabase>.bak" -CompressionOption On -EncryptionOption $encryptionOption  
```  
  
##  <a name="recommended-practices"></a><a name="RecommendedPractices"></a> Рекомендации  
 Создавайте резервную копию сертификата и ключей шифрования в каталоге, отличном от локального компьютера, где установлен экземпляр. С учетом сценариев аварийного восстановления рекомендуется сохранять резервную копию сертификата или ключа в стороннем местоположении. Восстановить зашифрованную резервную копию без сертификата, использованного при ее шифровании, нельзя.  
  
 Для восстановления зашифрованной резервной копии первоначальный сертификат, используемый при создании резервной копии, а также соответствующий ему отпечаток должны быть доступны на экземпляре, где производится восстановление. Поэтому сертификат не должен быть возобновлен по истечении срока или изменен каким-либо образом. Возобновление может привести к обновлению сертификата, запускающему изменение отпечатка сертификата, из-за чего сертификат станет недействительным для файла резервной копии. Учетная запись, выполняющая восстановление, должна иметь разрешения VIEW DEFINITION на сертификат или асимметричный ключ, использованные для шифрования резервной копии.  
  
 Резервное копирование баз данных группы доступности обычно выполняется на предпочитаемой резервной реплике.  При восстановлении резервной копии на реплике, отличной от той, на которой эта резервная копия была сделана, убедитесь, что исходный сертификат для резервной копии доступен на той реплике, где производится восстановление.  
  
 Если в базе данных включено TDE, выберите различные сертификаты или асимметричные ключи для шифрования базы данных и резервной копии для повышения безопасности.  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> Связанные задачи  
  
|Раздел или задача|Описание|  
|-----------------|-----------------|  
|[Создание зашифрованной резервной копии](../../relational-databases/backup-restore/create-an-encrypted-backup.md)|Описывает основные шаги, которые необходимо выполнить, чтобы создать зашифрованную резервную копию.|  
|[Расширенное управление ключами с помощью хранилища ключей Azure (SQL Server)](../../relational-databases/security/encryption/extensible-key-management-using-azure-key-vault-sql-server.md)|Предоставлен пример создания зашифрованной резервной копии, защищенной ключами в хранилище ключей Azure.|  
  
## <a name="see-also"></a>См. также:  
 [Общие сведения о резервном копировании (SQL Server)](../../relational-databases/backup-restore/backup-overview-sql-server.md)  
