---
title: Создание резервной копии журнала транзакций | Документация Майкрософт
description: В этой статье описано, как создать резервную копию журнала транзакций в SQL Server с помощью SQL Server Management Studio, Transact-SQL или PowerShell.
ms.custom: ''
ms.date: 02/02/2017
ms.prod: sql
ms.prod_service: backup-restore
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- transaction log backups [SQL Server], SQL Server Management Studio
- backups [SQL Server], creating
- backing up transaction logs [SQL Server], SQL Server Management Studio
ms.assetid: 3426b5eb-6327-4c7f-88aa-37030be69fbf
author: cawrites
ms.author: chadam
ms.openlocfilehash: 57c864996d15886eb69ef7caf0f000349b238b9c
ms.sourcegitcommit: 5a1ed81749800c33059dac91b0e18bd8bb3081b1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/23/2020
ms.locfileid: "96130580"
---
# <a name="back-up-a-transaction-log"></a>Создание резервной копии журнала транзакций
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]
  В этом разделе описано, как создать резервную копию журнала транзакций в [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] с помощью среды [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../includes/tsql-md.md)]или PowerShell.  

## <a name="before-you-begin"></a>Перед началом
### <a name="limitations-and-restrictions"></a><a name="Restrictions"></a> Ограничения  
  
Инструкция `BACKUP` не разрешена в явных и [неявных](../../t-sql/statements/set-implicit-transactions-transact-sql.md) транзакциях. Явными транзакциями являются транзакции, для которых явно назначаются запуск и остановка.

### <a name="recommendations"></a><a name="Recommendations"></a> Рекомендации  
  
- Если в базе данных используется полная модель восстановления или [модель восстановления](recovery-models-sql-server.md) с неполным протоколированием, то необходимо регулярно создавать резервную копию журнала транзакций, чтобы защитить данные и предотвратить [переполнение журнала транзакций](../logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md). При этом журнал усекается и поддерживает восстановление базы данных на определенный момент времени. 
  
- По умолчанию каждая успешная операция резервного копирования добавляет запись в журнал ошибок служб [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и в журнал системных событий. Если создание резервной копии журналов производится очень часто, сообщения об успешном завершении накапливаются очень быстро. Это приводит к увеличению журналов ошибок, затрудняя поиск других сообщений. Если работа существующих скриптов не зависит от этих записей, то их можно отключить с помощью флага трассировки 3226. См. статью [Флаги трассировки &#40;Transact-SQL&#41;](../../t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql.md).  
  
### <a name="permissions"></a><a name="Permissions"></a> Permissions

Нужные разрешения `BACKUP DATABASE` и `BACKUP LOG` назначаются по умолчанию членам предопределенной роли сервера **sysadmin** и предопределенным ролям базы данных **db_owner** и **db_backupoperator**. Перед началом убедитесь в наличии необходимых разрешений.
  
 Проблемы, связанные с владельцем и разрешениями у физических файлов на устройстве резервного копирования, могут помешать операции резервного копирования. [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] должен иметь возможность считывать и записывать данные на устройстве; учетная запись, от имени которой выполняется служба [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , должна иметь разрешения на запись. Однако процедура [sp_addumpdevice](../../relational-databases/system-stored-procedures/sp-addumpdevice-transact-sql.md), добавляющая запись для устройства резервного копирования в системные таблицы, не проверяет разрешения на доступ к файлу. Проблемы доступа к физическому файлу устройства резервного копирования могут не проявляться до обращения к [физическому ресурсу](backup-devices-sql-server.md) при попытке резервного копирования или восстановления. Поэтому обязательно убедитесь в наличии необходимых разрешений, прежде чем начать.

## <a name="using-sql-server-management-studio"></a>Использование среды SQL Server Management Studio

1. После подключения к соответствующему экземпляру компонента [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)]в обозревателе объектов разверните дерево сервера, щелкнув его имя.  
  
1. Раскройте узел **Базы данных** и в зависимости от типа восстанавливаемой базы данных выберите пользовательскую базу данных или раскройте узел **Системные базы данных** и выберите системную базу данных.  
  
1. Щелкните правой кнопкой мыши базу данных, выберите пункт **Задачи**, а затем команду **Создать резервную копию**. Откроется диалоговое окно **Резервное копирование базы данных** .  
 
1. В списке **База данных** проверьте имя базы данных. При необходимости можно выбрать другую базу данных из списка.  
  
1. Убедитесь в том, что используется либо модель восстановления **FULL** , либо **BULK_LOGGED**.  
  
1. Выберите **Журнал транзакций** в списке **Тип резервного копирования**.  
  
1. (Необязательно) Выберите вариант **Копировать только резервные копии**, чтобы создать резервную копию только для копирования. *Резервная копия только для копирования* — это резервная копия [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], которая не зависит от последовательности создания традиционных резервных копий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. См. статью [Резервные копии только для копирования &#40;SQL Server&#41;](../../relational-databases/backup-restore/copy-only-backups-sql-server.md).  
  
    > [!NOTE]
    > Если выбран параметр **Разностная** , то резервную копию только для копирования создать не удастся.  
  
1. Оставьте имя резервного набора данных, предложенное по умолчанию в текстовом поле **Имя** , или введите другое имя резервного набора данных.  
  
1. (Необязательно) В текстовом поле **Описание** введите описание резервного набора данных.  
  
1. Укажите, когда истекает срок действия резервного набора данных.  
  
    - Чтобы задать срок действия резервного набора данных, выберите пункт **После** (параметр по умолчанию) и введите срок действия набора в днях с момента его создания. Это значение может быть задано в диапазоне от 0 до 99 999 дней. Значение 0 означает, что срок действия резервного набора данных не ограничен.  
  
         Значение по умолчанию задается в параметре **Срок хранения носителей резервных копий по умолчанию (дней)** диалогового окна **Свойства сервера** (страница **Параметры базы данных** ). Для этого щелкните правой кнопкой мыши имя сервера в обозревателе объектов и выберите его свойства, затем страницу **Параметры базы данных** .  
  
    - Чтобы указать дату истечения срока действия резервного набора данных, выберите пункт **На** и введите дату истечения срока действия резервного набора данных.  
  
1. Чтобы выбрать тип назначения резервной копии, выберите пункт **Диск**, **URL-адрес** или **Лента**. Чтобы выбрать пути к 64 (или менее) дискам или накопителям на магнитной ленте, содержащим один набор носителей, нажмите кнопку **Добавить**. Выбранные пути отображаются в списке **Создать резервную копию в** .  
  
     Чтобы удалить носитель резервной копии, выберите его и нажмите кнопку **Удалить**. Чтобы просмотреть содержимое носителя резервной копии, выберите его и щелкните **Содержимое**.  
  
1. Чтобы просмотреть или выбрать дополнительные параметры, нажмите кнопку **Параметры** на панели **Выбор страницы** .  
  
1. Выберите параметр **Переписать носитель** , указав один из следующих вариантов:  
  
    - **Создать резервную копию в существующем наборе носителей**  
  
         Для этого параметра выберите вариант **Добавить в существующий резервный набор данных** или **Перезаписать все существующие резервные наборы данных**. См. статью [Наборы носителей, семейства носителей и резервные наборы данных &#40;SQL Server&#41;](../../relational-databases/backup-restore/media-sets-media-families-and-backup-sets-sql-server.md).  
  
         - (Необязательно) Выберите **Проверить имя набора носителей и срок действия резервного набора данных**, чтобы при выполнении операции резервного копирования проверялся срок действия набора носителей и резервного набора данных.  
  
         - (Необязательно) Введите имя в текстовом поле **Имя набора носителей**. Если имя не указано, создается набор носителей с пустым именем. Если имя набора носителей указано, то для носителя (ленточного или дискового) проверяется совпадение введенного и существующего имени.  
  
         Если оставить имя носителя пустым и установить рядом с ним флажок для проверки, имя носителя при успешном завершении также станет пустым.  
  
    - **Создать резервную копию в новом наборе носителей и удалить все существующие резервные наборы данных**  
  
         Для этого параметра введите имя в текстовом поле **Имя нового набора носителей** и при необходимости введите описание набора носителей в текстовом поле **Описание нового набора носителей**. См. статью [Наборы носителей, семейства носителей и резервные наборы данных &#40;SQL Server&#41;](../../relational-databases/backup-restore/media-sets-media-families-and-backup-sets-sql-server.md).  
  
1. В разделе **Надежность** можно установить следующие флажки.  
  
    - **Проверить резервную копию после завершения**.  
  
    - **Рассчитать контрольную сумму перед записью на носитель** и (необязательно) **Продолжить при ошибке контрольной суммы**.
    
       Дополнительные сведения см. в разделе [Возможные ошибки носителей во время резервного копирования и восстановления (SQL Server)](../../relational-databases/backup-restore/possible-media-errors-during-backup-and-restore-sql-server.md).  
  
1. В разделе **Журнал транзакций** можно установить следующие флажки.  
  
    - Для повседневного резервного копирования журналов оставьте вариант по умолчанию **Обрезать журнал транзакций путем удаления неактивных записей**.  
  
    - Для создания резервной копии заключительного фрагмента журнала (активного журнала) включите параметр **Выполнять резервное копирование заключительного фрагмента журнала, оставляя базу данных в состоянии восстановления**.  
  
         Резервное копирование заключительного фрагмента журнала выполняется после сбоя, чтобы предотвратить потерю сделанной работы. Резервное копирование активного журнала (резервное копирование заключительного фрагмента журнала) следует выполнять как после сбоя, так и перед началом восстановления базы данных, а также при сбое базы данных-получателя. Выбор этого параметра равносилен применению параметра NORECOVERY в инструкции BACKUP LOG языка Transact-SQL.
         
         Дополнительные сведения о резервных копиях заключительного фрагмента журнала см. в разделе [Резервные копии заключительного фрагмента журнала (SQL Server)](../../relational-databases/backup-restore/tail-log-backups-sql-server.md).  
  
1. При резервном копировании на накопитель на магнитной ленте (как указано в разделе **Назначение** страницы **Общие** ) активен параметр **Выгрузить ленту после резервного копирования** . Щелкните этот параметр, чтобы активировать параметр **Перемотать ленту перед выгрузкой** .  
  
1. [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)] и более поздние версии поддерживают [сжатие резервных копий](../../relational-databases/backup-restore/backup-compression-sql-server.md). По умолчанию сжатие резервных копий зависит от значения параметра конфигурации сервера **backup-compression default** . Однако независимо от текущего значения по умолчанию на уровне сервера можно сжать резервные копии, установив параметр **Сжимать резервные копии**, или отказаться от сжатия резервных копий, установив параметр **Не сжимать резервные копии**.  
  
     Сведения о том, как просмотреть текущую настройку сжатия резервных копий по умолчанию, см. в разделе [Параметр конфигурации сервера "Просмотр или настройка параметра сжатия резервных копий по умолчанию"](../../database-engine/configure-windows/view-or-configure-the-backup-compression-default-server-configuration-option.md).
  
     Для шифрования файла резервной копии установите флажок **Зашифровать файл резервной копии** . Выберите алгоритм шифрования файла резервной копии и выберите сертификат или асимметричный ключ. Доступны следующие алгоритмы шифрования:  
  
   - AES 128  
  
   - AES 192  
  
   - AES 256  
  
   - Triple DES  

## <a name="using-transact-sql"></a>Использование Transact-SQL  
  
Выполните инструкцию BACKUP LOG для создания резервной копии журнала транзакций, указав следующее:  
  
- имя базы данных, которой принадлежит журнал транзакций, резервную копию которого необходимо создать;  
  
- Устройство резервного копирования, на которое записывается резервная копия журнала транзакций.  
  
> [!IMPORTANT]
> В этом примере используется база данных [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] , которая опирается на простую модель восстановления. Чтобы разрешить создание резервных копий журналов, перед созданием полной резервной копии база данных должна быть настроена на использование модели полного восстановления.
>
> Дополнительные сведения см. в разделе [Просмотр или изменение модели восстановления базы данных (SQL Server)](../../relational-databases/backup-restore/view-or-change-the-recovery-model-of-a-database-sql-server.md).  
  
 В этом примере создается резервная копия журнала транзакций для базы данных [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] на созданном ранее устройстве резервного копирования, имеющая имя `MyAdvWorks_FullRM_log1`.  
  
```sql  
BACKUP LOG AdventureWorks2012  
   TO MyAdvWorks_FullRM_log1;  
GO  
```  
  
##  <a name="using-powershell"></a><a name="PowerShellProcedure"></a> Использование PowerShell

Настройка и использование [поставщика SQL Server PowerShell](../../powershell/sql-server-powershell-provider.md). Используйте командлет **Backup-SqlDatabase** и укажите **Log** в качестве значения параметра **-BackupAction** .  
  
В следующем примере создается полная резервная копия журналов базы данных `<myDatabase>` в заданном по умолчанию расположении резервного копирования на экземпляре сервера `Computer\Instance`.  
  
```powershell
Backup-SqlDatabase -ServerInstance Computer\Instance -Database <myDatabase> -BackupAction Log  
```
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> Related tasks  
  
- [Восстановление резервной копии журнала транзакций (SQL Server)](../../relational-databases/backup-restore/restore-a-transaction-log-backup-sql-server.md)  
  
- [Восстановление базы данных SQL Server до определенного момента времени (модель полного восстановления)](../../relational-databases/backup-restore/restore-a-sql-server-database-to-a-point-in-time-full-recovery-model.md)  
  
- [Устранение неполадок при переполнении журнала транзакций (ошибка SQL Server 9002)](../../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md)  
  
## <a name="see-also"></a>См. также раздел

 [BACKUP (Transact-SQL)](../../t-sql/statements/backup-transact-sql.md)   
 [Применение резервных копий журналов транзакций (SQL Server)](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md)   
 [Планы обслуживания](../../relational-databases/maintenance-plans/maintenance-plans.md)   
 [Полные резервные копии файлов (SQL Server)](../../relational-databases/backup-restore/full-file-backups-sql-server.md)