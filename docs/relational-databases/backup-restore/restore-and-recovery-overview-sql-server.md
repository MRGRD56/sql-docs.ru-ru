---
title: Обзор процессов восстановления (SQL Server) | Документация Майкрософт
description: В этой статье приводится обзор операций, связанных с восстановлением базы данных SQL Server из-за сбоя, путем последовательного восстановления набора резервных копий SQL Server.
ms.custom: ''
ms.date: 04/23/2019
ms.prod: sql
ms.prod_service: backup-restore
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- restoring tables [SQL Server]
- backups [SQL Server], restore scenarios
- database backups [SQL Server], restore scenarios
- database restores [SQL Server]
- restoring [SQL Server]
- restores [SQL Server]
- table restores [SQL Server]
- restoring databases [SQL Server], about restoring databases
- database restores [SQL Server], scenarios
- accelerated database recovery
ms.assetid: e985c9a6-4230-4087-9fdb-de8571ba5a5f
author: cawrites
ms.author: chadam
ms.openlocfilehash: edc2a92b260e85c2de1ff5b4fc1758748643d174
ms.sourcegitcommit: 917df4ffd22e4a229af7dc481dcce3ebba0aa4d7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/10/2021
ms.locfileid: "100346758"
---
# <a name="restore-and-recovery-overview-sql-server"></a>Обзор процессов восстановления (SQL Server)
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

  Чтобы восстановить базу данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] после сбоя, администратор базы данных должен восстановить набор резервных копий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] в составе логически верной и содержательной последовательности восстановления. [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] поддерживает восстановление данных из резервных копий целой базы данных, файла данных или страниц данных следующим образом.  
  
-   База данных ( *полное восстановление базы данных*)  
  
     Вся база данных возвращается в прежнее состояние и восстанавливается, при этом база данных находится в режиме вне сети во время операций возврата и восстановления.  
  
-   Файл данных ( *восстановление файла*)  
  
     Файл данных или набор файлов данных возвращается в исходное состояние и восстанавливается. Во время восстановления файлов файловые группы, содержащие обрабатываемые файлы, автоматически переводятся в режим вне сети на время восстановления. Любые попытки подключения и работы с файловой группой вне сети приведут к ошибке.  
  
-   Страница данных ( *восстановление страницы*)  
  
     При использовании модели полного восстановления или модели восстановления с неполным протоколированием можно восстановить отдельные базы данных. Восстановление страниц может применяться для любой базы данных вне зависимости от числа файловых групп.  
  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] работает во всех поддерживаемых операционных системах. Дополнительные сведения о поддерживаемых операционных системах см. в разделе [Требования к оборудованию и программному обеспечению для установки SQL Server 2016](../../sql-server/install/hardware-and-software-requirements-for-installing-sql-server.md). Сведения о поддержке резервных копий более ранних версий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]см. в подразделе "Поддержка совместимости" раздела [RESTORE (Transact-SQL)](../../t-sql/statements/restore-statements-transact-sql.md).  
  
##  <a name="overview-of-restore-scenarios"></a><a name="RestoreScenariosOv"></a> Общие сведения о сценариях восстановления  
 *Сценарий восстановления* в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] — процесс восстановления данных из одной или более резервных копий и возврат в исходное состояние базы данных. Поддерживаемые сценарии восстановления зависят от модели восстановления базы данных и выпуска [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].  
  
 Следующая таблица предоставляет возможные сценарии восстановления, которые поддерживаются различными моделями восстановления.  
  
|Сценарий восстановления|Простая модель восстановления|Модель полного восстановления или модель восстановления с неполным протоколированием|  
|----------------------|---------------------------------|----------------------------------------------|  
|полное восстановление базы данных|Это базовая стратегия восстановления. Полное восстановление базы данных может содержать простые операции возврата и восстановления из полной резервной копии. Также полное восстановление базы данных может проводиться на основе полной резервной копии базы данных с ее последующим обновлением по журналу.<br /><br /> Дополнительные сведения см. в разделе [Полное восстановление базы данных (простая модель восстановления)](../../relational-databases/backup-restore/complete-database-restores-simple-recovery-model.md).|Это базовая стратегия восстановления. Восстановление всей базы данных включает в себя восстановление полной резервной копии, возможно, разностных резервных копий (если они есть) и восстановления всех последующих резервных копий журналов (последовательно). Восстановление всей базы данных завершается восстановлением из последней резервной копии журнала и возвратом в исходное состояние (RESTORE WITH RECOVERY).<br /><br /> Дополнительные сведения см. в статье [Выполнение полного восстановления базы данных (модель полного восстановления)](../../relational-databases/backup-restore/complete-database-restores-full-recovery-model.md).|  
|File restore **\***|Восстановление одного или более поврежденных файлов с атрибутом «только для чтения» без восстановления всей базы данных. Восстановление файла возможно только при наличии в базе данных хотя бы одной файловой группы с атрибутом «только для чтения».|Восстановление одного или нескольких файлов без восстановления всей базы данных. Восстановление файлов может выполняться, когда база данных находится в режиме «вне сети» или в некоторых выпусках [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]«в сети». Во время восстановления файла файловые группы, содержащие обрабатываемый файл, всегда находятся в режиме вне сети.|  
|Восстановление страницы|Неприменимо|Восстановление одной или нескольких поврежденных страниц. Восстановление страницы может выполняться, когда база данных находится в режиме «вне сети» или в некоторых выпусках [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]«в сети». Во время восстановления страницы всегда находятся в режиме вне сети.<br /><br /> Должна быть доступна непрерывная цепочка резервных копий журналов вплоть до текущего файла журнала, и они должны быть применены для приведения страницы в соответствие текущему журналу.<br /><br /> Дополнительные сведения см. в разделе [Восстановление страниц (SQL Server)](../../relational-databases/backup-restore/restore-pages-sql-server.md).|  
|Поэтапное восстановление **\***|Поэтапное восстановление базы данных на уровне файловой группы, начиная с групп файлов, доступных для чтения и записи, вторичных файловых групп.|Восстановление и перевод базы данных в режим в сети по этапам на уровне файловой группы, начиная с первичной файловой группы.<br /><br /> Дополнительные сведения см. в разделе [Поэтапное восстановление &#40;SQL Server&#41;](../../relational-databases/backup-restore/piecemeal-restores-sql-server.md)|  
  
 **\*** Восстановление в сети поддерживается только в выпуске Enterprise Edition.  

### <a name="steps-to-restore-a-database"></a>Шаги по восстановлению базы данных
Для восстановления файла [!INCLUDE[ssde_md](../../includes/ssde_md.md)] выполняет два шага: 

-   создает любой недостающий файл базы данных;

-   копирует данные с устройств резервного копирования в файл(ы) базы данных.

Для восстановления базы данных [!INCLUDE[ssde_md](../../includes/ssde_md.md)] выполняет три шага: 

-   создает базы данных и файлы журнала транзакций, если они еще не созданы;

-   копирует все данные, журналы и страницы индексов с резервной копии базы данных в файлы базы данных; 

-   применяет журнал транзакций в так называемом [процессе восстановления](#TlogAndRecovery).

 Независимо от способа восстановления данных, перед восстановлением базы данных [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] обеспечивает логическую согласованность всей базы данных. Например, если файл был возвращен в исходное состояние, то нельзя восстановить его и вернуть в режим в сети, пока в нем не будет выполнено достаточное количество транзакций, чтобы он согласовывался с базой данных.  
  
### <a name="advantages-of-a-file-or-page-restore"></a>Преимущества восстановления файлов или страниц  
 Восстановление файлов и страниц вместо восстановления всей базы данных целиком дает следующие преимущества.  
  
-   Восстановление данных меньшего объема данных уменьшает время, затрачиваемое на копирование и восстановление.  
  
-   В среде [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] восстановление файлов или страниц позволяет другим данным в базе данных оставаться в режиме «в сети» во время операции восстановления.  

## <a name="recovery-and-the-transaction-log"></a><a name="TlogAndRecovery"></a> Восстановление и журнал транзакций
Для большинства сценариев восстановления необходимо применить резервную копию журналов транзакций и позволить [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] запустить **процесс восстановления** для подключения базы данных к сети. Восстановление — это процесс, используемый [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] для запуска каждой базы данных в транзакционно-согласованном (чистом) состоянии.

В случае отработки отказа или другого неясного завершения работы, базы данных могут оставаться в состоянии, в котором часть изменений не была записана из буферного кэша в файлы данных, и могут существовать некоторые изменения в файлах данных, вызванные незавершенными транзакциями. При запуске экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выполняется восстановление каждой базы данных, состоящее из трех этапов, на основе последней [контрольной точки базы данных](../../relational-databases/logs/database-checkpoints-sql-server.md):

-   На **этапе анализа** выполняется анализ журнала транзакций для определения последней контрольной точки и создается таблица "грязных" страниц (ТГС) и таблица активных транзакций (ТАТ). ТГС содержит записи о страницах, которые были "грязными" на момент завершения работы базы данных. TАT содержит записи транзакций, которые оставались активными на момент некорректного завершения работы базы данных.

-   На **стадии повтора** выполняется накат всех изменений, записанных в журнале, которые, возможно, не были записаны в файлы данных на момент завершения работы базы данных. [Минимальный регистрационный номер транзакции в журнале](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md#minlsn) (minLSN), необходимый для успешного восстановления всей базы данных, находится в ТГС и отмечает начало операций восстановления, необходимых для всех "грязных" страниц. На этом этапе [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] записывает на диск все "грязные" страницы, принадлежащие подтвержденным транзакциям.

-   На **стадии отката** выполняется откат незавершенных транзакций, обнаруженных в TАT, чтобы убедиться в сохранении целостности базы данных. После отката база данных включается в режим «в сети», и больше никакие резервные копии журнала транзакций не могут быть применены.

Сведения о ходе каждой стадии восстановления базы данных заносятся в [журнал ошибок](../../tools/configuration-manager/viewing-the-sql-server-error-log.md) [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Ход восстановления базы данных также можно отслеживать с помощью расширенных событий. Дополнительные сведения см. в записи блога [New extended events for database recovery progress](/archive/blogs/sql_server_team/new-extended-events-for-database-recovery-progress) (Новые расширенные события для процесса восстановления базы данных).

> [!NOTE]
> Для сценария поэтапного восстановления, если файловая группа доступна только для чтения с момента, предшествующего созданию резервной копии файловых групп, использование резервных копий журналов не требуется и эта группа пропускается при восстановлении файлов. 

<a name="FastRecovery"></a>
> [!NOTE]
> Чтобы максимально увеличить доступность баз данных в корпоративной среде, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выпуск Enterprise может перевести базу данных в действие после стадии повтора, в то время как стадия отката все еще будет выполняться. Это также называется быстрым восстановлением.

##  <a name="recovery-models-and-supported-restore-operations"></a><a name="RMsAndSupportedRestoreOps"></a> Модели восстановления и поддерживаемые операции восстановления  
 Модель восстановления определяет перечень операций, доступных при восстановлении базы данных. В следующей таблице указано, какие сценарии восстановления и в какой степени поддерживаются в каждой из моделей восстановления.  
  
|Операция восстановления|Модель полного восстановления|Модель восстановления с неполным протоколированием|Простая модель восстановления|  
|-----------------------|-------------------------|---------------------------------|---------------------------|  
|Восстановление данных|Полное восстановление (при наличии журнала).|С некоторыми потерями данных.|Будут потеряны все данные с момента создания последней полной или разностной резервной копии.|  
|Восстановление на момент времени|На любое время, сохранившееся в резервных копиях журналов.|Запрещено, если резервная копия журналов содержит какие-либо изменения с неполным протоколированием.|Не поддерживается.|  
|Восстановление файла * *\** _|Поддерживается полностью.|Иногда._ *\*\** *|Только для вторичных файлов, доступных только для чтения.|  
|Восстановление страницы * *\** _|Поддерживается полностью.|Иногда._ *\*\** *|Нет.|  
|Поэтапное (на уровне файловой группы) восстановление * *\** _|Поддерживается полностью.|Иногда._ *\*\** *|Только для вторичных файлов, доступных только для чтения.|  
  
 **\*** Доступно только в выпуске Enterprise [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]  
  
 **\*\*** Сведения о необходимых условиях см. в подразделе [Ограничения для восстановления по простой модели восстановления](#RMsimpleScenarios)далее в этом разделе.  
  
> [!IMPORTANT]  
> Независимо от модели восстановления базы данных, резервную копию [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] нельзя восстановить до версии [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)], более старой, чем версия, создавшая резервную копию.  
  
## <a name="restore-scenarios-under-the-simple-recovery-model"></a><a name="RMsimpleScenarios"></a> Сценарии восстановления по простой модели восстановления  
 В простой модели восстановления предусмотрены следующие ограничения для операции восстановления.  
  
-   Восстановление файлов и поэтапное восстановление доступны только для вторичных файловых групп, предназначенных только для чтения. Дополнительные сведения об этих сценариях восстановления см. в статьях [Восстановление файлов (простая модель восстановления)](../../relational-databases/backup-restore/file-restores-simple-recovery-model.md) и [Поэтапное восстановление (SQL Server)](../../relational-databases/backup-restore/piecemeal-restores-sql-server.md).  
  
-   Запрещено восстановление страниц.  
  
-   Запрещено восстановление до заданной точки.  
  
 Если приведенные выше ограничения противоречат задачам восстановления, рекомендуется использовать модель полного восстановления. Дополнительные сведения см. в разделе [Общие сведения о резервном копировании (SQL Server)](../../relational-databases/backup-restore/backup-overview-sql-server.md).  
  
> [!IMPORTANT]  
> Независимо от модели восстановления базы данных, резервная копия [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не может быть восстановлена на [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , имеющем версию, предшествующую версии, создавшей резервную копию.  
  
##  <a name="restore-under-the-bulk-logged-recovery-model"></a><a name="RMblogRestore"></a> Восстановление в модели восстановления с неполным протоколированием  
 В этом разделе рассматриваются вопросы, относящиеся исключительно к модели восстановления с неполным протоколированием, которая разработана исключительно в дополнение к модели полного восстановления.  
  
> [!NOTE]  
> Основные сведения о модели восстановления с неполным протоколированием см. в разделе [Журнал транзакций (SQL Server)](../../relational-databases/logs/the-transaction-log-sql-server.md).  
  
 В целом модель восстановления с неполным протоколированием схожа с моделью полного восстановления, поэтому все, что касается одной модели, также можно применить к другой. Однако модель восстановления с неполным протоколированием влияет на восстановление к моменту времени и на оперативное восстановление.  
  
### <a name="restrictions-for-point-in-time-recovery"></a>Ограничения для восстановления на момент времени  
 Если в модели восстановления с неполным протоколированием в резервной копии журналов содержатся изменения с неполным протоколированием, восстановление до момента времени невозможно. Попытка восстановления до момента времени из резервной копии журнала, содержащей массовые изменения, приводит к сбою операции восстановления.  
  
### <a name="restrictions-for-online-restore"></a>Ограничения восстановления в сети  
 Последовательность восстановления в сети работает только при выполнении следующих условий:  
  
-   все необходимые резервные копии журналов должны быть сделаны до начала последовательности восстановления;  
  
-   резервные копии массовых изменений были созданы до начала последовательности восстановления в сети;  
  
-   Если в базе данных существуют массовые изменения, все файлы должны быть либо подключены к сети, либо [уничтожены](../../relational-databases/backup-restore/remove-defunct-filegroups-sql-server.md). (Это означает, что они больше не являются частью базы данных.)  
  
 Если эти условия не выполняются, последовательность восстановления в сети завершается сбоем.  
  
> [!NOTE]  
>  Перед тем, как начать восстановление в сети, рекомендуется переключиться к модели полного восстановления. Дополнительные сведения см. в разделе [Модели восстановления (SQL Server)](../../relational-databases/backup-restore/recovery-models-sql-server.md).  
  
 Дополнительные сведения о выполнении восстановления в сети см. в разделе [Восстановление в сети (SQL Server)](../../relational-databases/backup-restore/online-restore-sql-server.md).  
  
##  <a name="database-recovery-advisor-sql-server-management-studio"></a><a name="DRA"></a> Помощник по восстановлению базы данных (среда SQL Server Management Studio)  
Помощник по восстановлению базы данных облегчает создание планов восстановления, реализующих оптимально правильные последовательности восстановления. Решено большинство известных проблем восстановления баз данных, и внедрены предложенные клиентами усовершенствования. Основные усовершенствования, появившиеся в помощнике по восстановлению баз данных:  
  
-   **Алгоритм плана восстановления**:  значительно улучшен алгоритм, используемый при создании планов восстановления, особенно для сложных сценариев восстановления. Многие крайние случаи, включая разветвляющиеся сценарии восстановления на момент времени, обрабатываются более эффективно, чем в предыдущих версиях [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].  
  
-   **Восстановление на определенный момент времени**:  помощник по восстановлению баз данных значительно упрощает восстановление базы данных до определенного момента времени. Визуальная временная шкала резервного копирования значительно улучшает поддержку для выполнения восстановления на момент времени. Эта визуальная временная шкала позволяет определять подходящий момент времени в качестве целевой точки восстановления для базы данных. Временная шкала облегчает обзор разветвленного пути восстановления (пути, который покрывает вилки восстановления). Заданный план восстановления на момент времени автоматически включает резервные копии, относящиеся к восстановлению на целевой момент времени (дата и время). Дополнительные сведения см. в статье [Восстановление базы данных SQL Server до определенного момента времени (модель полного восстановления)](../../relational-databases/backup-restore/restore-a-sql-server-database-to-a-point-in-time-full-recovery-model.md).  
  
Дополнительные сведения о помощнике по восстановлению баз данных см. в блогах по управлению [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] :  
  
-   [Помощник по восстановлению: общие сведения](/archive/blogs/managingsql/recovery-advisor-an-introduction)  
  
-   [Помощник по восстановлению: использование среды SSMS для создания и восстановления раздельных резервных копий](/archive/blogs/managingsql/recovery-advisor-using-ssms-to-createrestore-split-backups)  

## <a name="accelerated-database-recovery"></a><a name="adr"></a> Ускоренное восстановление баз данных.
[Ускоренное восстановление базы данных](/azure/sql-database/sql-database-accelerated-database-recovery/) доступно в [!INCLUDE[sql-server-2019](../../includes/sssql19-md.md)] и [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)]. Ускоренное восстановление базы данных значительно улучшает доступность базы данных, особенно при наличии продолжительных транзакций, за счет перепроектирования [процесса восстановления](#TlogAndRecovery) [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)]. База данных, для которой было включено ускоренное восстановление, значительно быстрее восстанавливается после отработки отказа или другого неясного завершения работы. Если включено, ускоренное восстановление базы данных также значительно быстрее завершает откат отмененных продолжительных транзакций.

Ускоренное восстановление можно включить для каждой базы данных в [!INCLUDE[sql-server-2019](../../includes/sssql19-md.md)], используя следующий синтаксис:

```sql
ALTER DATABASE <db_name> SET ACCELERATED_DATABASE_RECOVERY = ON;
```

> [!NOTE]
> Ускоренное восстановление базы данных включено по умолчанию на [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)].

## <a name="see-also"></a><a name="RelatedContent"></a> См. также:  
 [Общие сведения о резервном копировании (SQL Server)](../../relational-databases/backup-restore/backup-overview-sql-server.md)      
 [Журнал транзакций (SQL Server)](../../relational-databases/logs/the-transaction-log-sql-server.md)     
 [Руководство по архитектуре журнала транзакций SQL Server и управлению им](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md)     
 [Резервное копирование и восстановление баз данных SQL Server](../../relational-databases/backup-restore/back-up-and-restore-of-sql-server-databases.md)     
 [Применение резервных копий журналов транзакций (SQL Server)](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md)