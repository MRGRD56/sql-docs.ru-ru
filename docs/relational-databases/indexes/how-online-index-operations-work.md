---
description: Об операциях с индексом в сети
title: Как работают операции с индексами | Документация Майкрософт
ms.custom: ''
ms.date: 02/17/2017
ms.prod: sql
ms.reviewer: ''
ms.technology: table-view-index
ms.topic: conceptual
helpviewer_keywords:
- online index operations
- source indexes [SQL Server]
- pre-existing indexes [SQL Server]
- target indexes [SQL Server]
- temporary mapping index [SQL Server]
- index temporary mappings [SQL Server]
ms.assetid: eef0c9d1-790d-46e4-a758-d0bf6742e6ae
author: MikeRayMSFT
ms.author: mikeray
ms.prod_service: database-engine, sql-database
monikerRange: =azuresqldb-current||>=sql-server-2016||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: 2287549579373e8d4e00833ca29fe1d862b2ffb4
ms.sourcegitcommit: 1a544cf4dd2720b124c3697d1e62ae7741db757c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2020
ms.locfileid: "97465315"
---
# <a name="how-online-index-operations-work"></a>Об операциях с индексом в сети
[!INCLUDE [SQL Server Azure SQL Database](../../includes/applies-to-version/sql-asdb.md)]

  В этом разделе описываются возникающие во время операции с индексами структуры в сети, а также работа служб, связанных с этими структурами.  
  
## <a name="online-index-structures"></a>Структуры индексов в сети  
 Для осуществления одновременной работы пользователей во время операций языка DDL необходимо во время операций с индексами в сети использовать следующие структуры: индекс источника и существующий индекс, индекс назначения, а для перестроения кучи или удаления кластеризованного индекса — временный индекс сопоставления.  
  
-   **Индексы источника и существующие индексы**  
  
     Источник — это исходная таблица или данные кластеризованного индекса. Существующие индексы — это любые некластеризованные индексы, связанные с исходной структурой. Например, если операция с индексами в сети перестраивает кластеризованный индекс, с которым связаны четыре некластеризованных индекса, то источником является существующий кластеризованный индекс, а существующими индексами являются некластеризованные индексы.  
  
     Существующие индексы доступны пользователям для одновременных операций выборки, вставки, обновления или удаления. К ним относятся операции массовой вставки (поддерживаемые, но не рекомендуемые к использованию) и неявного обновления при помощи триггеров и ограничений ссылочной целостности. Все существующие индексы доступны для запросов и операций поиска. Из этого следует, что они могут быть выбраны оптимизатором запросов и в случае необходимости заданы в указаниях индекса.  
  
-   **Цель**  
  
     Назначение или назначения являются новым индексом (или кучей) или набором новых индексов, которые были либо созданы, либо перестроены. Пользовательские операции вставки, обновления и удаления над источником применяются к назначению компонентом [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] во время операции с индексами. Например, если операция с индексами в сети перестраивает кластеризованный индекс, то назначением является перестроенный кластеризованный индекс; компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] не перестраивает некластеризованные индексы при перестроении кластеризованного.  
  
     При выполнении инструкции SELECT в индексе назначения не производится поиск до подтверждения операции с индексами. Внутри системы индекс является доступным только для записи.  
  
-   **Временный индекс сопоставления**  
  
     Операциям с индексами в сети, создающим, удаляющим или перестраивающим кластеризованный индекс, необходим также временный индекс сопоставления. Этот временный индекс используется одновременно выполняемыми транзакциям для определения того, какие записи должны быть удалены во время перестроения новых индексов при удалении или обновлении строк в базовой таблице. Данный некластеризованный индекс создается на том же этапе, что и новый кластеризованный индекс (или куча) и для него не требуется отдельной операции сортировки. Одновременно выполняемые транзакции поддерживают временный индекс сопоставления во всех операциях вставки, обновления или удаления.  
  
## <a name="online-index-activities"></a>Работа служб в сети с использованием индексов  
 Во время простой операции с индексами в сети, например во время создания кластеризованного индекса в неиндексированной таблице (куче), источник и назначение проходят три фазы: подготовка, сборка и завершение.  
  
 На следующем рисунке показан процесс создания исходного кластеризованного индекса в сети. Для исходного объекта (кучи) другие индексы не определены. Работа служб со структурами источника и назначения показана для каждой фазы; также показаны одновременные пользовательские операции выборки, вставки, обновления или удаления. Фазы подготовки, сборки, и завершения отображаются вместе с режимами блокировки, используемыми для каждой фазы.  
  
 ![Действия, выполняющиеся во время операции с индексами в сети](../../relational-databases/indexes/media/online-index.gif "Действия, выполняющиеся во время операции с индексами в сети")  
  
## <a name="source-structure-activities"></a>Работа служб со структурами источника  
 В следующей таблице приведена работа служб со структурами источника во время каждой фазы операции с индексами, а также соответствующие стратегии блокировки.  
  
|Этап|Работа служб источника|Блокировки источника|  
|-----------|---------------------|------------------|  
|Подготовка<br /><br /> Короткая фаза|Подготовка системных метаданных для создания пустой структуры индекса.<br /><br /> Определяется моментальный снимок таблицы. То есть используется управление версиями строк для обеспечения согласованности считывания на уровне транзакций.<br /><br /> Одновременные пользовательские операции записи в источник блокируются на короткий промежуток времени.<br /><br /> Запрещаются все одновременные операции DDL, кроме операции создания множества некластеризованных индексов.|S (совмещаемая) на таблицу*<br /><br /> IS (с намерением совмещаемого доступа)<br /><br /> INDEX_BUILD_INTERNAL_RESOURCE\*\*|  
|Сборка<br /><br /> Главная фаза|Данные просматриваются, сортируются, сливаются и вставляются в назначение во время операций массовой загрузки.<br /><br /> Одновременные пользовательские операции выборки, вставки, обновления и удаления применяются и к существовавшим индексам, и к новым создаваемым индексам.|IS<br /><br /> INDEX_BUILD_INTERNAL_RESOURCE**|  
|Завершение<br /><br /> Короткая фаза|Все незафиксированные транзакции обновления должны быть завершены до начала этой фазы. В зависимости от полученной блокировки все новые пользовательские транзакции записи или чтения блокируются на короткий промежуток времени до завершения этой фазы.<br /><br /> Системные метаданные обновляются для замены источника на назначение.<br /><br /> При необходимости источник может быть удален. Например, после перестроения или удаления кластеризованного индекса.|INDEX_BUILD_INTERNAL_RESOURCE**<br /><br /> S на таблицу в случае создания некластеризованного индекса.\*<br /><br /> SCH-M (изменение схемы) в случае удаления любой структуры источника (индекса или таблицы).\*|  
  
 \* Перед установкой блокировки S или SCH-M для таблицы операция с индексами будет ожидать завершения выполнения всех незафиксированных транзакций обновления. Если выполняется длительный запрос, операция с индексами в сети ожидает завершения запроса.
  
 ** Блокировка ресурса INDEX_BUILD_INTERNAL_RESOURCE предотвращает одновременное выполнение операций языка описания данных DDL в источнике и существовавших структурах во время выполнения операции с индексами. Например, данная блокировка предотвращает одновременное перестроение двух индексов в одной таблице. Хотя данная блокировка ресурса связана с блокировкой Sch-M, она не предотвращает выполнение инструкций по обработке данных.  
  
 В предыдущей таблице показана одна совмещаемая (S) блокировка, установленная во время фазы сборки операции с индексами в сети, включающей в себя один индекс. При создании или перестроении кластеризованных и некластеризованных индексов в одной операции с индексами в сети (например во время создания исходного кластеризованного индекса в таблице, содержащей один или несколько некластеризованных индексов) во время фазы сборки создаются две краткосрочные совмещаемые (S) блокировки, а затем две долгосрочные блокировки с намерением совмещаемого доступа (IS). Одна блокировка S сначала устанавливается во время создания кластеризованного индекса, а затем при завершении его создания, а вторая краткосрочная блокировка S устанавливается при создании некластеризованных индексов. После создания некластеризованных индексов блокировка S снова сменяется блокировкой IS до начала фазы завершения операции с индексами в сети.  

Дополнительные сведения о том, как используются блокировки и как можно управлять ими, см. в разделе [arguments](../../t-sql/statements/alter-table-index-option-transact-sql.md#arguments).

### <a name="target-structure-activities"></a>Работа служб со структурами назначения  
 В следующей таблице приведена работа служб со структурами назначения во время каждой фазы операции с индексами, а также соответствующие стратегии блокировки.  
  
|Этап|Работа служб назначения|Блокировка назначения|  
|-----------|---------------------|------------------|  
|Подготовка|Создается новый индекс, доступный только для записи.|IS|  
|Сборка|Вставляются данные из источника.<br /><br /> Применяются пользовательские изменения (вставки, обновления, удаления), уже выполненные на источнике.<br /><br /> Это действие прозрачно для пользователя.|IS|  
|Завершение|Обновляются метаданные индекса.<br /><br /> Индекс переводится в состояние чтения/записи.|S<br /><br /> или диспетчер конфигурации служб<br /><br /> Блокировка SCH-M|  
  
 До завершения операции с индексами назначение не доступно для инструкций SELECT, заданных пользователем.  
  
 После выполнения фаз подготовки и завершения хранящихся в кэше процедур планы запросов и обновлений становятся недействительными. В последующих запросах используется новый индекс.  
  
 Время жизни заданного в таблице курсора, использующегося в операциях с индексами в сети, ограничено оперативными фазами индекса. На каждой фазе курсоры обновления являются недействительными. Доступные только для чтения курсоры становятся недействительными только после фазы завершения.  
  
## <a name="related-content"></a>См. также  
 [Выполнение операций с индексами в оперативном режиме](../../relational-databases/indexes/perform-index-operations-online.md)  
  
 [Рекомендации по операциям с индексами в оперативном режиме](../../relational-databases/indexes/guidelines-for-online-index-operations.md)  
  
## <a name="next-steps"></a>Дальнейшие действия

[Параметры индекса ALTER TABLE](../../t-sql/statements/alter-table-index-option-transact-sql.md#arguments)
