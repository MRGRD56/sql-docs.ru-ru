---
description: Кучи (таблицы без кластеризованных индексов)
title: Кучи (таблицы без кластеризованных индексов) | Документация Майкрософт
ms.custom: ''
ms.date: 11/01/2016
ms.prod: sql
ms.prod_service: table-view-index, sql-database
ms.reviewer: ''
ms.technology: table-view-index
ms.topic: conceptual
helpviewer_keywords:
- heaps
- forward record
- forwarded record
- forwarding pointer
- RID
ms.assetid: df5c4dfb-d372-4d0f-859a-a2d2533ee0d7
author: MikeRayMSFT
ms.author: mikeray
monikerRange: =azuresqldb-current||>=sql-server-2016||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: be2a84e21cc55340d675041cdd353dab887531c2
ms.sourcegitcommit: 1a544cf4dd2720b124c3697d1e62ae7741db757c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2020
ms.locfileid: "97465295"
---
# <a name="heaps-tables-without-clustered-indexes"></a>Кучи (таблицы без кластеризованных индексов)
[!INCLUDE [SQL Server Azure SQL Database](../../includes/applies-to-version/sql-asdb.md)]

  Кучей является таблица без кластеризованного индекса. Для таблиц, сохраненных как куча, может быть создан один или несколько некластеризованных индексов. Данные хранятся в куче без указания порядка. Обычно данные первоначально сохраняются в порядке, в котором строки вставлены в таблицу, но компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] может перемещать данные в куче для более эффективного хранения строк. Поэтому порядок данных нельзя прогнозировать. Чтобы гарантировать порядок строк, возвращаемых из кучи, необходимо использовать предложение `ORDER BY`. Чтобы указать постоянный логический порядок хранения строк, создайте кластеризованный индекс для таблицы, чтобы таблица не была кучей.  
  
> [!NOTE]  
> Иногда бывают достаточные основания для того, чтобы оставить таблицу в виде кучи, не создавая кластеризованный индекс, однако эффективное использование куч требует высокой квалификации. Большинству таблиц следует создать кластеризованный индекс, если не существует веских оснований, чтобы оставить таблицу в виде кучи.  
  
## <a name="when-to-use-a-heap"></a>Когда следует использовать кучу  
Если таблица сохранена как куча, отдельные строки идентифицируются по ссылке на 8-байтовый идентификатор строки (RID), состоящий из номера файла, номера страницы данных и слота на странице (FileID:PageID:SlotID). Идентификатор строки является небольшой и эффективной структурой. 

Кучи можно использовать в качестве промежуточных таблиц для больших неупорядоченных операций вставки. Поскольку данные вставляются без применения строгого порядка, операция вставки обычно выполняется быстрее, чем эквивалентная вставка в кластеризованный индекс. Если данные кучи будут считываться и обрабатываться в конечном расположении, может быть полезно создать узкий некластеризованный индекс, охватывающий предикат поиска, используемый запросом чтения. 

> [!NOTE]  
> Данные извлекаются из кучи в порядке страниц данных, но не обязательно в порядке вставки данных. 

Иногда специалисты данных используют кучи, если доступ к данным осуществляется только через некластеризованные индексы, а идентификатор RID меньше ключа кластеризованного индекса. 

Если таблица является кучей и не имеет некластеризованных индексов, требуется прочитать всю таблицу (выполнить сканирование таблицы), чтобы найти любую строку. [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не может выполнить поиск RID непосредственно в куче. Это может быть допустимо, если таблица невелика.  
  
## <a name="when-not-to-use-a-heap"></a>Когда не нужно использовать кучу  
 Не следует использовать кучу, если данные часто возвращаются в отсортированном порядке. Кластеризованный индекс для столбца сортировки поможет избежать операции сортировки.  
  
 Не используйте кучу для часто группируемых данных. Данные необходимо сортировать перед группировкой, и кластеризованный индекс для столбца сортировки поможет избежать операции сортировки.  
  
 Не следует использовать кучу, когда из таблицы часто запрашиваются диапазоны данных. Кластеризованный индекс для гистограммы диапазонов позволит избежать сортировки всей кучи.  
  
 Не используйте кучу, если нет некластеризованных индексов, а таблица имеет большой размер, если только не планируется возвратить содержимое всей таблицы без заданного порядка. В куче, чтобы можно было найти любую строку, должны считываться все строки кучи.  
 
 Не используйте кучу, если данные часто обновляются. Если вы изменяете запись и обновление занимает больше места на страницах данных, чем текущая версия, запись должна быть перемещена на страницу данных, имеющую достаточно свободного места. При этом создается **перенаправленная запись**, указывающая на новое расположение данных, и **указатель перенаправления** должен быть записан на странице, где раньше находились данные, чтобы указать новое физическое расположение. Это приводит к фрагментации в куче. При сканировании кучи необходимо учитывать эти указатели, что ограничивает производительность упреждающего чтения и может повлечь дополнительные операции ввода-вывода, что приводит к замедлению сканирования. 
  
## <a name="managing-heaps"></a>Управление кучами  
 Чтобы создать кучу, создайте таблицу без кластеризованного индекса. Если в таблице уже содержится кластеризованный индекс, удалите кластеризованный индекс, чтобы преобразовать таблицу в кучу.  
  
 Чтобы удалить кучу, создайте кластеризованный индекс в ней.  
  
 Перестроение кучи для освобождения неиспользуемого пространства:
 -  Создайте в куче кластеризованный индекс, а затем удалите его.  
 -  Используйте команду `ALTER TABLE ... REBUILD` для перестроения кучи.
  
> [!WARNING]  
> Создание или удаление кластеризованных индексов требует перезаписи всей таблицы. Если у таблицы есть некластеризованные индексы, то все они должны быть созданы повторно при каждом изменении кластеризованного индекса. Таким образом, для перехода с кучи на кластеризованный индекс и обратно может потребоваться продолжительное время и дополнительное место на диске — для переупорядочения данных в базе данных tempdb.  

## <a name="heap-structures"></a>Структуры кучи
Кучей является таблица без кластеризованного индекса. Для каждой кучи существует одна строка в представлении [sys.partitions](../../relational-databases/system-catalog-views/sys-partitions-transact-sql.md)с `index_id = 0` для каждой секции, используемой кучей. По умолчанию у кучи есть одна секция. Если куча имеет несколько секций, каждая из них имеет структуру кучи, содержащую данные для этой определенной секции. Например, если у кучи четыре секции, имеются четыре структуры кучи, по одной на каждую секцию.

В зависимости от типов данных в куче, каждая структура кучи имеет одну или несколько единиц распределения для хранения и управления данными определенной секции. У каждой кучи есть не менее одной единицы распределения `IN_ROW_DATA` на каждую секцию. У кучи также будет одна единица распределения `LOB_DATA` на каждую секцию, если в этой секции есть столбцы больших объектов (LOB). Кроме того, для хранения строк переменной длины, превышающих ограничение на размер строки, равное 8060 байтам, для каждой секции требуется одна единица распределения `ROW_OVERFLOW_DATA` .

Столбец `first_iam_page` в системном представлении `sys.system_internals_allocation_units` указывает на первую IAM-страницу в цепочке IAM-страниц, которые управляют пространством, выделенным для кучи в определенной секции. [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] использует страницы IAM для перемещения по куче. Страницы данных и строки в этих страницах не расположены в каком-либо порядке и не связаны. Единственным логическим соединением страниц данных являются данные, записанные в IAM-страницы.

> [!IMPORTANT]  
> Системное представление `sys.system_internals_allocation_units` зарезервировано только для внутреннего использования [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Совместимость с будущими версиями не гарантируется.
 
Просмотр таблиц или последовательное считывание в куче может выполняться просмотром IAM-страниц для нахождения экстентов, хранящих страницы кучи. Так как карта IAM представляет экстенты в том же порядке, в котором они существуют в файлах данных, это означает, что последовательный просмотр кучи выполняется последовательно в каждом файле. Использование IAM-страниц для определения последовательности просмотра означает также, что строки из кучи обычно возвращаются не в том порядке, в котором они вставлялись.

На следующей иллюстрации демонстрируется, как [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] использует IAM-страницы для получения строк данных из кучи с одной секцией. 

![куча_iam](../../relational-databases/indexes/media/iam-heap.gif)
  
## <a name="related-content"></a>См. также  
[CREATE INDEX (Transact-SQL)](../../t-sql/statements/create-index-transact-sql.md)     
[DROP INDEX (Transact-SQL)](../../t-sql/statements/drop-index-transact-sql.md)     
[Описание кластеризованных и некластеризованных индексов](../../relational-databases/indexes/clustered-and-nonclustered-indexes-described.md)     
  
  
