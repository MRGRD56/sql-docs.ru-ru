---
description: Рекомендации по операциям с индексами в режиме "в сети"
title: Рекомендации по операциям с индексами | Документация Майкрософт
ms.custom: ''
ms.date: 11/12/2019
ms.prod: sql
ms.reviewer: ''
ms.technology: table-view-index
ms.topic: conceptual
helpviewer_keywords:
- clustered indexes, online operations
- online index operations
- indexes [SQL Server], online operations
- disk space [SQL Server], indexes
- nonclustered indexes [SQL Server], online operations
- transaction logs [SQL Server], indexes
ms.assetid: d82942e0-4a86-4b34-a65f-9f143ebe85ce
author: MikeRayMSFT
ms.author: mikeray
ms.prod_service: table-view-index, sql-database
monikerRange: =azuresqldb-current||>=sql-server-2016||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: 17c91b53c786934d292692493fa886698128b34d
ms.sourcegitcommit: 1a544cf4dd2720b124c3697d1e62ae7741db757c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2020
ms.locfileid: "97465305"
---
# <a name="guidelines-for-online-index-operations"></a>Рекомендации по операциям с индексами в режиме "в сети"

[!INCLUDE [SQL Server Azure SQL Database](../../includes/applies-to-version/sql-asdb.md)]

При выполнении операций с индексами в сети придерживайтесь следующих правил.  

- Кластеризованные индексы должны создаваться, перестраиваться или удаляться в режиме вне сети, если базовая таблица содержит следующие типы данных больших объектов: **image**, **ntext** и **text**.  
- Неуникальные некластеризованные индексы могут создаваться в режиме в сети, если таблица содержит типы данных больших объектов (LOB), но при этом, ни один из этих столбцов не участвует в определении индекса, ни в качестве ключевого, ни в качестве неключевого столбца.  
- Индексы локальных временных таблиц не могут создаваться, перестраиваться и удаляться в режиме в сети. Это ограничение не относится к индексам глобальных временных таблиц.
- Индексы можно возобновить с места остановки после непредвиденного сбоя, отработки отказа базы данных или команды **PAUSE**. Ознакомьтесь со сведениями об инструкциях [Create Index](../../t-sql/statements/create-index-transact-sql.md) и [Alter Index](../../t-sql/statements/alter-index-transact-sql.md).

> [!NOTE]  
> Операции с индексами в сети доступны не во всех выпусках [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Список функций, поддерживаемых различными выпусками [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], см. в [этой статье](../../sql-server/editions-and-components-of-sql-server-2016.md).  

В следующей таблице перечислены операции с индексами, которые могут быть выполнены в сети, а также индексы, которые исключаются из этих операций, и ограничения для возобновляемого индекса. Кроме того, в ней указаны дополнительные ограничения.  

| Операция с индексами в сети | Исключенные индексы | Другие ограничения |  
|----------------------------|----------------------|------------------------|  
|ALTER INDEX REBUILD|Отключенный кластеризованный индекс или отключенное индексированное представление<br /><br /> XML-индекс<br /><br />Индекс columnstore <br /><br /> Индекс локальной временной таблицы|Указание ключевого слова ALL может привести к ошибке выполнения операции, если таблица содержит исключенный индекс.<br /><br /> На перестроение отключенных индексов налагаются дополнительные ограничения. Дополнительные сведения см. в статье [Отключение индексов и ограничений](../../relational-databases/indexes/disable-indexes-and-constraints.md).|  
|CREATE INDEX|XML-индекс<br /><br /> Исходные уникальные кластеризованные индексы представлений.<br /><br /> Индекс локальной временной таблицы||  
|CREATE INDEX WITH DROP_EXISTING|Отключенный кластеризованный индекс или отключенное индексированное представление<br /><br /> Индекс локальной временной таблицы<br /><br /> XML-индекс||  
|DROP INDEX|Отключенный индекс<br /><br /> XML-индекс<br /><br /> Некластеризованный индекс<br /><br /> Индекс локальной временной таблицы|В одной инструкции не может быть указано несколько индексов.|  
|ALTER TABLE ADD CONSTRAINT (PRIMARY KEY или ограничение UNIQUE)|Индекс локальной временной таблицы<br /><br /> Кластеризованный индекс|Допускается только одно вложенное предложение за раз. Например: нельзя добавлять и удалять ограничения PRIMARY KEY и UNIQUE в одной и той же инструкции ALTER TABLE.|  
|ALTER TABLE DROP CONSTRAINT (PRIMARY KEY или ограничение UNIQUE)|Кластеризованный индекс||  
  
 Базовая таблица не может быть изменена, усечена или удалена, пока не завершилась операция с индексами в сети.  
  
 Настройка параметра ONLINE (ON или OFF), указанная при создании или удалении кластеризованного индекса, относится ко всем перестраиваемым некластеризованным индексам. Например: если кластеризованный индекс построен в режиме в сети с помощью инструкции CREATE INDEX WITH DROP_EXISTING, ONLINE=ON, все связанные с ним некластеризованные индексы также повторно создаются в режиме в сети.  
  
 При создании или перестроении в сети индекса UNIQUE построитель индексов и выполняющаяся одновременно пользовательская транзакция могут попытаться добавить одно и то же значение ключа, нарушая его уникальность. Если строка, введенная пользователем, вставляется в новый индекс прежде, чем исходная строка из таблицы-источника перемещается в новый индекс, операция с индексами вне сети завершится ошибкой.  
  
 С небольшой вероятностью операция с индексами в сети может вызвать взаимоблокировку при работе с базой данных, вызванную работой пользователя или приложения. В этих редких случаях компонент [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] определит жертвой взаимоблокировки активность пользователя или приложения.  
  
 Можно выполнять одновременные фоновые DLL-операции индекса одной таблицы или представления только при создании нескольких некластеризованных индексов либо при реорганизации некластеризованных индексов. Все остальные попытки выполнения операций с индексами в сети завершаются ошибкой. Например: нельзя в режиме в сети создавать новый индекс во время перестроения существующего индекса для этой же таблицы.  
  
 Операцию в сети нельзя выполнить, если индекс содержит столбец с типом больших объектов, и операции в сети в той же транзакции предшествует операция обновления. Для решения этой проблемы проводите операцию в сети либо вне такой транзакции, либо в транзакции, но перед операциями обновления.  
  
## <a name="disk-space-considerations"></a>Рекомендации по месту на диске

Операции с индексами в режиме "в сети" требуют больше дискового пространства, чем автономные операции с индексами.

- Для операций создания и перестроения индексов требуется дополнительное пространство.
- Кроме того, дисковое пространство используется для временного индекса сопоставления. Этот временный индекс применяется в операциях с индексами в сети при создании, перестроении или удалении кластеризованных индексов.
- Удаление кластеризованного индекса в режиме "в сети" требует столько же места, сколько и его создание (или перестроение) в режиме "в сети".

Дополнительные сведения см. в статье [Disk Space Requirements for Index DDL Operations](../../relational-databases/indexes/disk-space-requirements-for-index-ddl-operations.md).  
  
## <a name="performance-considerations"></a>Вопросы производительности

Хотя операции с индексами в сети допускают одновременную работу пользователей, в этом случае они выполняются тем дольше, чем интенсивнее происходит обновление данных. Обычно операции с индексами в сети выполняются медленнее, чем аналогичные операции вне сети, независимо от текущей интенсивности обновления данных.  
  
Поскольку и исходная, и целевая структуры обслуживаются во время выполнения операции с индексами в сети, увеличивается потребление ресурсов при вставке, обновлении и удалении, и это увеличение может доходить до двукратного. Это может привести к снижению производительности и повышению нагрузки на систему, особенно ресурсов ЦП. Операции с индексами в сети полностью записываются в журнал.  
  
Несмотря на то, что рекомендуется выполнять операции с индексами в сети, необходимо предварительно оценить среду и определенные требования. Возможно, оптимальным решением может оказаться переключение в режим вне сети. При этом на время выполнения операции пользователи будут иметь ограниченный доступ к данным, но она быстрее закончится и в итоге займет меньше ресурсов.  
  
На многопроцессорных компьютерах с SQL Server 2016 индексные инструкции, как и любые другие запросы, могут использовать несколько процессоров для операций просмотра и сортировки, связанных с индексной инструкцией. Можно использовать параметр индекса MAXDOP с целью управления максимальным количеством процессоров, используемых для операции с индексами в сети. В этом случае можно распределить потребляемые операцией с индексом ресурсы таким образом, чтобы не пострадали одновременно работающие пользователи. Дополнительные сведения см. в статье [Настройка параллельных операций с индексами](../../relational-databases/indexes/configure-parallel-index-operations.md). Дополнительные сведения о выпусках SQL Server, поддерживающих параллельные операции с индексами, см. в [этой статье](../../sql-server/editions-and-components-of-sql-server-2016.md).  
  
Поскольку на финальной фазе удерживаются блокировки S-lock и Sch-M, будьте внимательны при выполнении операций с индексами в сети внутри явно объявленных пользовательских транзакций (например: в блоке BEGIN TRANSACTION...COMMIT), поскольку в этом случае блокировка будет удерживаться до окончания транзакции, мешая одновременной работе пользователей.  
  
Перестроение индекса в сети может привести к увеличению фрагментации, когда оно выполняется с параметрами `MAX DOP > 1` и `ALLOW_PAGE_LOCKS = OFF` . Дополнительные сведения см. в статье [Как это работает. Перестроение индекса в сети может привести к увеличению фрагментации](/archive/blogs/psssql/how-it-works-online-index-rebuild-can-cause-increased-fragmentation).  
  
## <a name="transaction-log-considerations"></a>Рекомендации по журналу транзакций

Масштабные операции с индексами, выполняемые в режиме в сети или вне сети, могут привести к формированию больших объемов данных, которые вызовут переполнение журнала транзакций. Для гарантии возможности отката операций с индексами журнал транзакций не может быть усечен до завершения операции с индексом, однако может быть выполнено его резервное копирование. Иными словами, журнал транзакций должен иметь достаточно места для сохранения и транзакции операции с индексом и текущих пользовательских транзакций на весь период выполнения операции с индексом. Дополнительные сведения см. в статье [Transaction Log Disk Space for Index Operations](../../relational-databases/indexes/transaction-log-disk-space-for-index-operations.md).  

## <a name="resumable-index-considerations"></a>Рекомендации по возобновляемому индексу

> [!NOTE]
> Параметр возобновляемого индекса для создания и перестроения индекса применяется к SQL Server (перестроение индекса поддерживается с SQL Server 2017; создание индекса также поддерживается в SQL Server 2019) и базе данных SQL. Ознакомьтесь со сведениями об инструкциях [Create Index](../../t-sql/statements/create-index-transact-sql.md) и [Alter Index](../../t-sql/statements/alter-index-transact-sql.md).

При создании или перестроении возобновляемого индекса в режиме "в сети" следует учитывать следующие рекомендации:

- Управление, планирование и разворачивание окна обслуживания индексов. Операцию создания и перестроения индексов в периоды обслуживания можно многократно приостанавливать и запускать повторно.
- Восстановление после сбоев при создании и перестроении индекса (например, при переходе на другую базу данных или нехватке места на диске).
- При приостановке операции с индексами исходный и вновь созданный индекс требуют места на диске и обновления во время операций DML.
- Появляется возможность усекать журналы транзакций во время операции создания или перестроения индекса.
- Параметр SORT_IN_TEMPDB = ON не поддерживается.

> [!IMPORTANT]
> Создание или перестроение возобновляемого индекса не требует открытых долгосрочных транзакций, что позволяет усекать журналы во время этой операции и управлять пространством в журнале более эффективно. Новая структура позволяет хранить необходимые данные в базе данных вместе со всеми ссылками, необходимыми для перезапуска возобновляемой операции.

Как правило, возобновляемые и невозобновляемые операции перестроения индекса в режиме "в сети" выполняются с одинаковой производительностью. Создание возобновляемого индекса предусматривает постоянные накладные расходы, из-за чего операции создания возобновляемых и невозобновляемых индексов выполняются с несколько разной производительностью. В большинстве случаев это различие заметно только для небольших таблиц.

Если возобновляемый индекс обновляется, пока операция индексирования приостановлена:

- Для рабочей нагрузки, связанной в основном с чтением, производительность существенно не снижается.
- Для рабочей нагрузки, связанной с большим объемом обновлений, пропускная способность может упасть (наши тесты показали снижение производительности менее чем на 10 %).

Как правило, качество дефрагментации при создании или перестроении возобновляемых и невозобновляемых индексов в режиме "в сети" одинаково.

## <a name="online-default-options"></a>Параметры режима "в сети" по умолчанию

> [!IMPORTANT]
> Эти параметры предоставляются в общедоступной предварительной версии для [!INCLUDE[ssNoVersion](../../includes/sssqlv15-md.md)].

Задать настройки по умолчанию для режима "в сети" или возобновляемых операций на уровне базы данных можно с помощью параметров конфигурации ELEVATE_ONLINE или ELEVATE_RESUMABLE, областью действия которых является база данных. Параметры по умолчанию позволяют избежать случайного выполнения операций, из-за которых таблица базы данных может стать недоступна. Оба параметра предписывают ядру автоматически перевести определенные операции в режим выполнения "в сети" или режим возобновляемого выполнения.  
Вы можете задать значение параметра FAIL_UNSUPPORTED, WHEN_SUPPORTED или OFF с помощью команды [ALTER DATABASE SCOPED CONFIGURATION](../../t-sql/statements/alter-database-scoped-configuration-transact-sql.md). Для режима "в сети" и возобновляемого выполнения можно настроить разные значения.

Параметры ELEVATE_ONLINE и ELEVATE_RESUMABLE применяются только к инструкциям DDL, которые поддерживают синтаксис выполнения "в сети" и возобновляемого выполнения соответственно. Например, при попытке создать XML-индекс с параметром ELEVATE_ONLINE=FAIL_UNSUPORTED операция будет выполняться "вне сети", так как XML-индексы не поддерживают синтаксис ONLINE=. Параметры действуют только для инструкций DDL, для которых не указан параметр ONLINE или RESUMABLE. Например, передав инструкцию с параметром ONLINE=OFF или RESUMABLE=OFF, пользователь может переопределить параметр FAIL_UNSUPPORTED и выполнить инструкцию в режиме "вне сети" или в невозобновляемом режиме.

> [!NOTE]
> Параметры ELEVATE_ONLINE и ELEVATE_RESUMABLE не применяются к операциям с XML-индексом.

## <a name="related-content"></a>Связанное содержимое

- [Об операциях с индексом в сети](../../relational-databases/indexes/how-online-index-operations-work.md)  
- [Выполнение операций с индексами в оперативном режиме](../../relational-databases/indexes/perform-index-operations-online.md)  
- [ALTER INDEX](../../t-sql/statements/alter-index-transact-sql.md)  
- [CREATE INDEX](../../t-sql/statements/create-index-transact-sql.md)