---
description: Триггеры DML
title: Триггеры DML | Документация Майкрософт
ms.custom: ''
ms.date: 03/14/2017
ms.prod: sql
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- triggers [SQL Server], about triggers
- DML triggers, about DML triggers
- triggers [SQL Server]
ms.assetid: 298eafca-e01f-4707-8c29-c75546fcd6b0
author: rothja
ms.author: jroth
monikerRange: =azuresqldb-current||>=sql-server-2016||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: 4105a3c3b0ba43d3ed142cba31b2f991f6dc5287
ms.sourcegitcommit: 1a544cf4dd2720b124c3697d1e62ae7741db757c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2020
ms.locfileid: "97461565"
---
# <a name="dml-triggers"></a>Триггеры DML
[!INCLUDE [SQL Server SQL Database](../../includes/applies-to-version/sql-asdb.md)]
  Триггеры DML — это хранимые процедуры особого типа, автоматически вступающие в силу, если происходит событие языка обработки данных DML, которое затрагивает таблицу или представление, определенное в триггере. События DML включают инструкции INSERT, UPDATE или DELETE. Триггеры DML могут использоваться для предписания бизнес-правил и правил целостности данных, выполнения запросов к другим таблицам и включения сложных инструкций [!INCLUDE[tsql](../../includes/tsql-md.md)] . Триггер и инструкция, при выполнении которой он срабатывает, считаются одной транзакцией, которую можно откатить назад внутри триггера. При обнаружении серьезной ошибки (например, нехватки места на диске) вся транзакция автоматически откатывается назад.  
  
## <a name="dml-trigger-benefits"></a>Преимущества триггеров DML  
 Триггеры DML аналогичны ограничениям в том, что могут предписывать целостность сущностей или целостность домена. Вообще говоря, целостность сущностей должна всегда предписываться на самом нижнем уровне с помощью индексов, являющихся частью ограничений PRIMARY KEY и UNIQUE или создаваемых независимо от ограничений. Целостность домена должна быть предписана через ограничения CHECK, а ссылочная целостность — через ограничения FOREIGN KEY. Триггеры DML наиболее полезны в тех случаях, когда функции ограничений не удовлетворяют функциональным потребностям приложения.  
  
 В следующем списке приведено сравнение триггеров DML с ограничениями и указано, в чем триггеры DML имеют преимущества.  
  
-   Триггеры DML позволяют каскадно проводить изменения через связанные таблицы в базе данных; но эти изменения могут осуществляться более эффективно с использованием каскадных ограничений ссылочной целостности. Ограничения FOREIGN KEY могут проверить значения столбца только на предмет точного совпадения со значениями другого столбца, за исключением случаев, когда с помощью предложения REFERENCES задаются каскадные ссылочные действия.  
  
-   Для предотвращения случайных или неверных операций INSERT, UPDATE и DELETE и реализации других более сложных ограничений, чем те, которые определены при помощи ограничения CHECK.  
  
     В отличие от ограничений CHECK, DML-триггеры могут ссылаться на столбцы других таблиц. Например, триггер может использовать инструкцию SELECT для сравнения вставленных или обновленных данных и выполнения других действий, например изменения данных или отображения пользовательского сообщения об ошибке.  
  
-   Чтобы оценить состояние таблицы до и после изменения данных и предпринять действия на основе этого различия.  
  
-   Несколько DML-триггеров одинакового типа (INSERT, UPDATE или DELETE) для таблицы позволяют предпринять несколько различных действий в ответ на одну инструкцию изменения данных.  
  
-   Ограничения могут сообщать об ошибках только с помощью соответствующих стандартных системных сообщений. Если для пользовательского приложения требуются более сложные методы управления ошибками и, соответственно, пользовательские сообщения, то необходимо использовать триггер.  
  
-   При использовании триггеров DML может произойти откат изменений, нарушающих ссылочную целостность, что приводит к запрету модификации данных. Подобные триггеры могут применяться при изменении внешнего ключа в случаях, когда новое значение не соответствует первичному ключу. Обычно в указанных случаях используются ограничения FOREIGN KEY.  
  
-   Если в таблице триггеров существуют ограничения, то их проверка осуществляется между выполнением триггеров INSTEAD OF и AFTER. В случае нарушения ограничений выполняется откат действий триггеров INSTEAD OF, а триггер AFTER не срабатывает.  
  
## <a name="types-of-dml-triggers"></a>Типы триггеров DML  
 Триггер AFTER  
 Триггеры AFTER выполняются после выполнения действий инструкции INSERT, UPDATE, MERGE или DELETE. Триггеры AFTER никогда не выполняются, если происходит нарушение ограничения, поэтому эти триггеры нельзя использовать для какой-либо обработки, которая могла бы предотвратить нарушение ограничения. Для каждой из операций INSERT, UPDATE или DELETE в указанной инструкции MERGE соответствующий триггер вызывается для каждой операции DML.  
  
 Триггер INSTEAD OF  
 Триггеры INSTEAD OF переопределяют стандартные действия инструкции, вызывающей триггер. Поэтому они могут использоваться для проверки на наличие ошибок или проверки значений на одном или нескольких столбцах и выполнения дополнительных действий перед вставкой, обновлением или удалением одной или нескольких строк. Например, если обновляемое значение в столбце почасовой оплаты в таблице учетной ведомости начинает превышать определенное значение, то с помощью этого триггера можно либо задать вывод сообщения об ошибке и откатить транзакцию, либо сделать вставку новой записи в след аудита до вставки записи в таблицу учетной ведомости. Главное преимущество триггеров INSTEAD OF в том, что они позволяют поддерживать обновления для таких представлений, которые обновлять невозможно. Например, в представлении, основанном на нескольких базовых таблицах, должен использоваться триггер INSTEAD OF для поддержки операций вставки, обновления и удаления, которые ссылаются на данные больше чем в одной таблице. Другое преимущество триггера INSTEAD OF состоит в том, что он обеспечивает логику кода, при которой можно отвергать одни части пакета и принимать другие.  
  
 Функциональность триггеров AFTER и INSTEAD OF сравнивается в следующей таблице.  
  
|Функция|Триггер AFTER|Триггер INSTEAD OF|  
|--------------|-------------------|------------------------|  
|Сущности, к которым применяется триггер|Таблицы|Таблицы и представления|  
|Количество триггеров на таблицу или представление|Несколько триггеров на одно запускающее триггеры действие (UPDATE, DELETE или INSERT).|Один триггер на одно запускающее триггеры действие (UPDATE, DELETE или INSERT).|  
|Каскадные ссылки|Нет ограничений.|Триггеры INSTEAD OF UPDATE и DELETE нельзя определять для таблиц, на которые распространяются каскадные ограничения ссылочной целостности.|  
|Выполнение|После следующих операций.<br /><br /> Обработка ограничений.<br /><br /> Декларативные ссылочные действия.<br /><br /> Создание таблиц **inserted** и **deleted** .<br /><br /> Действие, запускающее триггер.|До: обработка ограничений<br /><br /> Вместо: действие, запускающее триггер<br /><br /> После: создание таблиц  **inserted** и **deleted**|  
|Порядок выполнения|Можно задать выполнение в первую и в последнюю очередь.|Неприменимо|  
|Ссылки на столбцы **varchar(max)**, **nvarchar(max)** и **varbinary(max)** в таблицах **inserted** и **deleted**|Разрешено|Разрешено|  
|Ссылки на столбцы **text**, **ntext** и **image** в таблицах **inserted** и **deleted**|Нельзя использовать|Допускается|  
  
 Триггеры CLR  
 Триггер CLR может быть либо триггером AFTER, либо триггером INSTEAD OF. Триггер CLR может также являться триггером DDL. Вместо вызова хранимой процедуры на языке [!INCLUDE[tsql](../../includes/tsql-md.md)] триггер CLR вызывает один или несколько методов управляемого кода, являющихся членами сборки, созданной с помощью среды .NET Framework и загружены в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].  
  
## <a name="related-tasks"></a>Связанные задачи  
  
|Задача|Раздел|  
|----------|-----------|  
|Описывает, как создать триггер DML.|[Создание триггеров DML](../../relational-databases/triggers/create-dml-triggers.md)|  
|Описывает, как создать триггер CLR.|[Создание триггеров CLR](../../relational-databases/triggers/create-clr-triggers.md)|  
|Описывает, как создать триггер DML для выполнения и однострочных, и многострочных операций модификации данных.|[Создание триггеров DML для обработки нескольких строк данных](../../relational-databases/triggers/create-dml-triggers-to-handle-multiple-rows-of-data.md)|  
|Описывает, как вкладывать триггеры.|[Создание вложенных триггеров](../../relational-databases/triggers/create-nested-triggers.md)|  
|Описывает, как указывать порядок, в котором активируются триггеры AFTER.|[Указание первого и последнего триггеров](../../relational-databases/triggers/specify-first-and-last-triggers.md)|  
|Описывает, как использовать специальные таблицы inserted и deleted в коде триггера.|[Использование вставленных и удаленных таблиц](../../relational-databases/triggers/use-the-inserted-and-deleted-tables.md)|  
|Описывает, как изменить или переименовать триггер DML.|[Изменение или переименование триггеров DML](../../relational-databases/triggers/modify-or-rename-dml-triggers.md)|  
|Описывает, как просматривать сведения о триггерах DML.|[Получение сведений о триггерах DML](../../relational-databases/triggers/get-information-about-dml-triggers.md)|  
|Описывает, как удалять или отключать триггеры DML.|[Удаление или отключение триггеров DML](../../relational-databases/triggers/delete-or-disable-dml-triggers.md)|  
|Описывает, как управлять безопасностью триггеров.|[Управление безопасностью триггеров](../../relational-databases/triggers/manage-trigger-security.md)|  
  
## <a name="see-also"></a>См. также:  
 [CREATE TRIGGER (Transact-SQL)](../../t-sql/statements/create-trigger-transact-sql.md)   
 [ALTER TRIGGER (Transact-SQL)](../../t-sql/statements/alter-trigger-transact-sql.md)   
 [DROP TRIGGER (Transact-SQL)](../../t-sql/statements/drop-trigger-transact-sql.md)   
 [DISABLE TRIGGER (Transact-SQL)](../../t-sql/statements/disable-trigger-transact-sql.md)   
 [Функции триггеров (Transact-SQL)](../../t-sql/functions/trigger-functions-transact-sql.md)  
  
  
