---
description: Очередность параметров сортировки
title: Приоритет параметров сортировки | Документация Майкрософт
ms.custom: ''
ms.date: 03/15/2017
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.reviewer: ''
ms.technology: t-sql
ms.topic: language-reference
dev_langs:
- TSQL
helpviewer_keywords:
- coercible-default collation label
- precedence [SQL Server], collations
- collation sensitive
- collations [SQL Server], precedence
- explicit collation label [SQL Server]
- implicit collation label
- no-collation label
- collation insensitive
- operators [Transact-SQL], collations
- collation labels
- collation coercion rules
- rules [SQL Server], collations
ms.assetid: 58c4e64b-5634-4c29-aa22-33193282dd27
author: WilliamDAssafMSFT
ms.author: wiassaf
monikerRange: '>=aps-pdw-2016||=azuresqldb-current||=azure-sqldw-latest||>=sql-server-2016||>=sql-server-linux-2017||=azuresqldb-mi-current'
ms.openlocfilehash: c06bf7aa0ec45150f657e5822d1d5b1387ef18df
ms.sourcegitcommit: a9e982e30e458866fcd64374e3458516182d604c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/11/2021
ms.locfileid: "98098500"
---
# <a name="collation-precedence"></a>Очередность параметров сортировки
[!INCLUDE [sql-asdb-asdbmi-asa-pdw](../../includes/applies-to-version/sql-asdb-asdbmi-asa-pdw.md)]

  Очередность параметров сортировки, также называемая правилами приведения параметров сортировки, определяет следующее.  
  
-   Параметры сортировки итоговых результатов выражения, возвращающего символьную строку.  
  
-   Параметры сортировки, используемые теми операторами с учетом параметров сортировки, которые принимают в качестве параметра символьную строку, но не возвращают ее, например операторы LIKE и IN.  
  
Правила очередности параметров сортировки распространяются только на типы данных символьных строк: **char**, **varchar**, **text**, **nchar**, **nvarchar** и **ntext**. Объекты, содержащие данные других типов, не принимают участия в оценке параметров сортировки.  
  
## <a name="collation-labels"></a>Метки параметров сортировки  
В следующей таблице перечислены и описаны четыре категории, в которых обозначены параметры сортировки для всех объектов. Имя каждой категории также называется меткой параметров сортировки.  
  
|Метка параметров сортировки|Типы объектов|  
|---------------------|----------------------|  
|Приводимые по умолчанию|Любая переменная типа символьной строки языка [!INCLUDE[tsql](../../includes/tsql-md.md)], параметр, литерал, выходное значение каталога встроенной функции или встроенная функция несимвольного аргумента, выходом которой является строка.<br /><br /> Если объект объявлен внутри пользовательской функции, хранимой процедуры или триггера, то ему присваиваются параметры сортировки по умолчанию, принятые для базы данных, в которой указанная функция, хранимая процедура или триггер были созданы. Если объект объявлен внутри пакета, то ему присваиваются параметры сортировки по умолчанию, принятые для текущей базы данных для этого соединения.|  
|Неявные X|Ссылка на столбец. Параметры сортировки для выражения (X) принимаются как параметры сортировки, определенные для столбцов таблицы или представления.<br /><br /> Даже в том случае, когда параметры сортировки для столбца были явно заданы с помощью предложения COLLATE в инструкции CREATE TABLE или CREATE VIEW, ссылка на столбец рассматривается как неявная.|  
|Явные X|Выражение, которое явно приводится к указанным параметрам сортировки (X) с помощью предложения COLLATE в выражении.|  
|Без параметров сортировки|Показывает, что значением выражения являются результаты операции над двумя строками с несовместимыми параметрами сортировки неявных меток параметров сортировки. Результат выражения определяется как не имеющий параметров сортировки.|  
  
## <a name="collation-rules"></a>Правила параметров сортировки  
Меткой параметров сортировки простого выражения, ссылающегося на объект только одной символьной строки, является метка параметров сортировки этого объекта.  
  
Меткой параметров сортировки сложного выражения, ссылающегося на выражения с двумя операндами с одинаковой меткой параметров сортировки, является метка этих выражений операндов.  
  
Метка параметров сортировки для результата выполнения сложного выражения, ссылающегося на выражения с двумя операндами с разными метками параметров сортировки, основана на следующих правилах.  
  
-   Явно указанные имеют приоритет над указанными неявно. Неявно указанные имеют приоритет над приводимыми по умолчанию:  
  
     Явные > Неявные > Приводимые по умолчанию  
  
-   Объединение двух выражений, имеющих разные явно указанные параметры сортировки, приведет к ошибке:  
  
     Явные X + явные Y = ошибка  
  
-   Объединение двух выражений, имеющих разные неявно указанные параметры сортировки, приведет к результату без параметров сортировки:  
  
     Неявные X + неявные Y = без параметров сортировки  
  
-   Объединение выражения без параметров сортировки и выражения с любой меткой, кроме метки явно указанных параметров сортировки (см. следующее правило), приведет к результату с меткой без параметров сортировки:  
  
     Без параметров сортировки + любое = без параметров сортировки  
  
-   Объединение выражения без параметров сортировки и выражения с меткой явно указанных параметров сортировки приведет к результату с меткой явно указанных параметров сортировки:  
  
     Без параметров сортировки + явные X = явные  
  
Следующая таблица содержит сводку возможных значений.  
  
|Метка приведения операнда|Явные X|Неявные X|Приводимые по умолчанию|Без параметров сортировки|  
|----------------------------|----------------|----------------|------------------------|-------------------|  
|**Явные Y**|Ошибка|Результат — «Явные Y»|Результат — «Явные Y»|Результат — «Явные Y»|  
|**Неявные Y**|Результат — «Явные X»|Результат — «Без параметров сортировки»|Результат — «Неявные Y»|Результат — «Без параметров сортировки»|  
|**Приводимые по умолчанию**|Результат — «Явные X»|Результат — «Неявные X»|Результат — «Приводимые по умолчанию»|Результат — «Без параметров сортировки»|  
|**Без параметров сортировки**|Результат — «Явные X»|Результат — «Без параметров сортировки»|Результат — «Без параметров сортировки»|Результат — «Без параметров сортировки»|  
  
Очередность параметров сортировки также подчиняется следующим дополнительным правилам.  
  
-   Нельзя указать несколько предложений COLLATE для выражения с явно заданным параметром сортировки. Например, следующее предложение `WHERE` недопустимо, так как для выражения с уже явно указанным параметром сортировки применяется предложение `COLLATE`:  
  
     `WHERE ColumnA = ( 'abc' COLLATE French_CI_AS) COLLATE French_CS_AS`  
  
-   Преобразование кодовой страницы для данных типа **text** невозможно. Выражения типа **text** нельзя приводить из одних параметров сортировки в другие, если они имеют разные кодовые страницы. Нельзя пользоваться оператором присвоения для двух текстовых операндов, имеющих различные кодовые страницы в параметрах сортировки.  
  
Очередность параметров сортировки определяется после преобразования типов данных. Параметры сортировки конечного результата могут быть от одного операнда, а тип конечного результата — от другого. Например, рассмотрим следующий пакет:  
  
```sql  
CREATE TABLE TestTab  
   (PrimaryKey int PRIMARY KEY,  
    CharCol char(10) COLLATE French_CI_AS  
   )  
  
SELECT *  
FROM TestTab  
WHERE CharCol LIKE N'abc'  
```  
  
Тип данных Юникода для простого выражения `N'abc'` имеет более высокую очередность. Поэтому результирующее выражение имеет тип данных Юникода, присвоенный строке `N'abc'`. Однако для выражения `CharCol` задана метка Implicit (неявные параметры сортировки), а для выражения `N'abc'` — метка Coercible-default (приводимые параметры сортировки по умолчанию) с более низкой очередностью. Поэтому применяются параметры сортировки `French_CI_AS`, заданные для `CharCol`.  
  
### <a name="examples-of-collation-rules"></a>Примеры правил параметров сортировки  
 В приведенных ниже примерах поясняется работа правил параметров сортировки. Чтобы запустить примеры, создайте следующую тестовую таблицу.  
  
```sql  
USE tempdb;  
GO  
  
CREATE TABLE TestTab (  
   id int,   
   GreekCol nvarchar(10) collate greek_ci_as,   
   LatinCol nvarchar(10) collate latin1_general_cs_as  
   )  
INSERT TestTab VALUES (1, N'A', N'a');  
GO  
```  
  
#### <a name="collation-conflict-and-error"></a>Конфликты и ошибки параметров сортировки  
 Предикат в приведенном ниже запросе приводит к конфликту параметров сортировки и вызывает ошибку.  
  
```sql  
SELECT *   
FROM TestTab   
WHERE GreekCol = LatinCol;  
```  
  
 [!INCLUDE[ssResult](../../includes/ssresult-md.md)]  
  
```  
Msg 448, Level 16, State 9, Line 2  
Cannot resolve collation conflict between 'Latin1_General_CS_AS' and 'Greek_CI_AS' in equal to operation.  
```  
  
#### <a name="explicit-label-vs-implicit-label"></a>Сравнение меток «Явный» и «Неявный»  
 Предикату в приведенном ниже запросе назначаются параметры сортировки `greek_ci_as`, так как выражение справа имеет метку «Явный». Указанная метка имеет более высокую очередность, чем метка «Неявный» выражения слева.  
  
```sql  
SELECT *   
FROM TestTab   
WHERE GreekCol = LatinCol COLLATE greek_ci_as;  
```  
  
 [!INCLUDE[ssResult](../../includes/ssresult-md.md)]  
  
```  
id          GreekCol             LatinCol  
----------- -------------------- --------------------  
          1 A                    a  
  
(1 row affected)  
```  
  
#### <a name="no-collation-labels"></a>Метка «Без параметров сортировки»  
Выражениям `CASE` приведенных ниже запросов присвоена метка «Без параметров сортировки», поэтому они не могут отображаться в списке выбора или обрабатываться операторами с учетом параметров сортировки. Подобные выражения могут обрабатываться операторами без учета параметров сортировки.  
  
```sql  
SELECT (CASE WHEN id > 10 THEN GreekCol ELSE LatinCol END)   
FROM TestTab;  
```  
  
 [!INCLUDE[ssResult](../../includes/ssresult-md.md)]  
  
```  
Msg 451, Level 16, State 1, Line 1  
Cannot resolve collation conflict for column 1 in SELECT statement.  
```  
  
```sql  
SELECT PATINDEX((CASE WHEN id > 10 THEN GreekCol ELSE LatinCol END), 'a')  
FROM TestTab;  
```  
  
 [!INCLUDE[ssResult](../../includes/ssresult-md.md)]  
  
```  
Msg 446, Level 16, State 9, Server LEIH2, Line 1  
Cannot resolve collation conflict for patindex operation.  
```  
  
```sql  
SELECT (CASE WHEN id > 10 THEN GreekCol ELSE LatinCol END) COLLATE Latin1_General_CI_AS   
FROM TestTab;  
```  
  
 [!INCLUDE[ssResult](../../includes/ssresult-md.md)]  
  
```  
--------------------  
a  
  
(1 row affected)  
```  
  
## <a name="collation-sensitive-and-collation-insensitive"></a>С учетом параметров сортировки или без учета параметров сортировки  
Операторы и функции могут быть с учетом параметров сортировки и без учета.  
  
С учетом параметров сортировки  
Это означает, что указание операнда «Без параметров сортировки» вызывает ошибку при компиляции. Результат выражения не может быть «Без параметров сортировки».  
  
Без учета параметров сортировки  
Это означает, что операнд и результат могут быть «Без параметров сортировки».  
  
### <a name="operators-and-collation"></a>Операторы и параметры сортировки  
Операторы сравнения и операторы MAX, MIN, BETWEEN, LIKE, IN выполняются с учетом параметров сортировки. Строке, используемой операторами, присваивается метка параметров сортировки операнда с более высокой очередностью. Инструкция UNION также учитывает параметры сортировки. Всем строковым операндам и конечному результату присваиваются параметры сортировки операнда с наивысшей очередностью. Очередность параметров сортировки для операндов и результата UNION вычисляется по столбцам.  
  
Оператор присвоения выполняется без учета параметров сортировки, так как выражение справа приводится к параметрам сортировки выражения слева.  
  
При выполнении операции конкатенации строк учитываются заданные параметры сортировки. Двум строковым операндам и результату назначается метка параметров сортировки операнда с самой высокой очередностью параметров сортировки. Инструкции UNION ALL и CASE выполняются без учета параметров сортировки. Всем строковым операндам и конечным результатам присваивается метка параметров сортировки операнда с наивысшей очередностью. Очередность параметров сортировки операндов и результатов UNION ALL вычисляется по столбцам.  
  
### <a name="functions-and-collation"></a>Функции и параметры сортировки  
Функции CAST, CONVERT и COLLATE учитывают параметры сортировки при работе с данными типов **char**, **varchar** и **text**. Если входными и выходными значениями функций CAST и CONVERT являются символьные строки, то выходной строке присваивается метка параметров сортировки входной строки. Если входное значение не является символьной строкой, то выходная строка имеет метку «Приведение по умолчанию», и ей присваиваются параметры сортировки текущей базы данных для этого соединения или базы данных, содержащей пользовательскую функцию, хранимую процедуру или триггер, из которых производится вызов функции CAST или CONVERT.  
  
 Для встроенных функций несимвольных аргументов, возвращающих строковые переменные, выходная строка имеет метку «Приведение по умолчанию» и ей присваиваются параметры сортировки текущей базы данных или параметры сортировки базы данных, содержащей пользовательскую функцию, хранимую процедуру или триггер, из которых производится вызов данной функции.  
  
 Ниже представлены функции, работающие с учетом параметров сортировки, у которых выходным строкам присваивается метка параметров сортировки входной строки.  

:::row:::
    :::column:::
        CHARINDEX
    :::column-end:::
    :::column:::
        REPLACE
    :::column-end:::
:::row-end:::
:::row:::
    :::column:::
        DIFFERENCE
    :::column-end:::
    :::column:::
        REVERSE
    :::column-end:::
:::row-end:::
:::row:::
    :::column:::
        ISNUMERIC
    :::column-end:::
    :::column:::
        RIGHT
    :::column-end:::
:::row-end:::
:::row:::
    :::column:::
        LEFT
    :::column-end:::
    :::column:::
        SOUNDEX
    :::column-end:::
:::row-end:::
:::row:::
    :::column:::
        LEN
    :::column-end:::
    :::column:::
        STUFF
    :::column-end:::
:::row-end:::
:::row:::
    :::column:::
        LOWER
    :::column-end:::
    :::column:::
        SUBSTRING
    :::column-end:::
:::row-end:::
:::row:::
    :::column:::
        PATINDEX
    :::column-end:::
    :::column:::
        UPPER
    :::column-end:::
:::row-end:::
  
## <a name="see-also"></a>См. также:  
 [COLLATE (Transact-SQL)](~/t-sql/statements/collations.md)   
 [Преобразование типов данных (ядро СУБД)](../../t-sql/data-types/data-type-conversion-database-engine.md)   
 [Операторы (Transact-SQL)](../../t-sql/language-elements/operators-transact-sql.md)   
 [Выражения (Transact-SQL)](../../t-sql/language-elements/expressions-transact-sql.md)  
  
  
