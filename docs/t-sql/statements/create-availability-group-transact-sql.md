---
description: CREATE AVAILABILITY GROUP (Transact-SQL)
title: CREATE AVAILABILITY GROUP (Transact-SQL) | Документы Майкрософт
ms.custom: ''
ms.date: 10/16/2017
ms.prod: sql
ms.prod_service: sql-database
ms.reviewer: ''
ms.technology: t-sql
ms.topic: reference
f1_keywords:
- AVAILABILITY GROUP
- CREATE_AVAILABILITY_TSQL
- CREATE_AVAILABILITY_GROUP_TSQL
- CREATE AVAILABILITY GROUP
- CREATE AVAILABILITY
- AVAILABILITY_GROUP_TSQL
dev_langs:
- TSQL
helpviewer_keywords:
- Availability Groups [SQL Server], listeners
- CREATE AVAILABILITY GROUP statement
- Availability Groups [SQL Server], creating
- Availability Groups [SQL Server], Transact-SQL statements
ms.assetid: a3d55df7-b4e4-43f3-a14b-056cba36ab98
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 1a2878025e3b5b6aa8d303ebf94e7215c5590992
ms.sourcegitcommit: 8dc7e0ececf15f3438c05ef2c9daccaac1bbff78
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/13/2021
ms.locfileid: "100344072"
---
# <a name="create-availability-group-transact-sql"></a>CREATE AVAILABILITY GROUP (Transact-SQL)

[!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

Создание новой группы доступности при условии, что экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] включен для функции [!INCLUDE[ssHADR](../../includes/sshadr-md.md)].  
  
> [!IMPORTANT]  
>  Выполните CREATE AVAILABILITY GROUP в экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], который предполагается использовать в качестве начальной первичной реплики создаваемой группы доступности. Этот экземпляр сервера должен располагаться на узле отказоустойчивого кластера Windows Server (WSFC).  
  
 ![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)  
  
## <a name="syntax"></a>Синтаксис  
  
```syntaxsql
  
CREATE AVAILABILITY GROUP group_name  
   WITH (<with_option_spec> [ ,...n ] )  
   FOR [ DATABASE database_name [ ,...n ] ]  
   REPLICA ON <add_replica_spec> [ ,...n ]  
   AVAILABILITY GROUP ON <add_availability_group_spec> [ ,...2 ]  
   [ LISTENER 'dns_name' ( <listener_option> ) ]  
[ ; ]  
  
<with_option_spec>::=   
    AUTOMATED_BACKUP_PREFERENCE = { PRIMARY | SECONDARY_ONLY| SECONDARY | NONE }  
  | FAILURE_CONDITION_LEVEL  = { 1 | 2 | 3 | 4 | 5 }   
  | HEALTH_CHECK_TIMEOUT = milliseconds  
  | DB_FAILOVER  = { ON | OFF }   
  | DTC_SUPPORT  = { PER_DB | NONE }  
  | [ BASIC | DISTRIBUTED ]
  | REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT = { integer }
  | CLUSTER_TYPE = { WSFC | EXTERNAL | NONE } 
  
<add_replica_spec>::=  
  <server_instance> WITH  
    (  
       ENDPOINT_URL = 'TCP://system-address:port',  
       AVAILABILITY_MODE = { SYNCHRONOUS_COMMIT | ASYNCHRONOUS_COMMIT | CONFIGURATION_ONLY },  
       FAILOVER_MODE = { AUTOMATIC | MANUAL | EXTERNAL }  
       [ , <add_replica_option> [ ,...n ] ]  
    )   
  
  <add_replica_option>::=  
       SEEDING_MODE = { AUTOMATIC | MANUAL }  
     | BACKUP_PRIORITY = n  
     | SECONDARY_ROLE ( {   
            [ ALLOW_CONNECTIONS = { NO | READ_ONLY | ALL } ]   
        [,] [ READ_ONLY_ROUTING_URL = 'TCP://system-address:port' ]  
     } )  
     | PRIMARY_ROLE ( {   
            [ ALLOW_CONNECTIONS = { READ_WRITE | ALL } ]   
        [,] [ READ_ONLY_ROUTING_LIST = { ( '<server_instance>' [ ,...n ] ) | NONE } ]  
        [,] [ READ_WRITE_ROUTING_URL = { ( '<server_instance>' ) ] 
     } )  
     | SESSION_TIMEOUT = integer  
  
<add_availability_group_spec>::=  
 <ag_name> WITH  
    (  
       LISTENER_URL = 'TCP://system-address:port',  
       AVAILABILITY_MODE = { SYNCHRONOUS_COMMIT | ASYNCHRONOUS_COMMIT },  
       FAILOVER_MODE = MANUAL,  
       SEEDING_MODE = { AUTOMATIC | MANUAL }  
    )  
  
<listener_option> ::=  
   {  
      WITH DHCP [ ON ( <network_subnet_option> ) ]  
    | WITH IP ( { ( <ip_address_option> ) } [ , ...n ] ) [ , PORT = listener_port ]  
   }  
  
  <network_subnet_option> ::=  
     'ip4_address', 'four_part_ipv4_mask'    
  
  <ip_address_option> ::=  
     {   
        'ip4_address', 'pv4_mask'  
      | 'ipv6_address'  
     }  
  
```  
  
[!INCLUDE[sql-server-tsql-previous-offline-documentation](../../includes/sql-server-tsql-previous-offline-documentation.md)]

## <a name="arguments"></a>Аргументы

*group_name*  
Указывает имя новой группы доступности. Аргумент *group_name* должен быть допустимым [идентификатором](../../relational-databases/databases/database-identifiers.md)[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и являться уникальным во всех группах доступности в кластере WSFC. Максимальная длина имени группы доступности составляет 128 символов.  

AUTOMATED_BACKUP_PREFERENCE **=** { PRIMARY \| SECONDARY_ONLY \| SECONDARY \| NONE }  
 Указывает приоритет, согласно которому задание резервного копирования вычисляет первичную реплику при выборе места для создания резервных копий. Вы можете написать скрипт для того, чтобы задание резервного копирования учитывало приоритет автоматического резервного копирования. Важно понимать, что приоритет не определяется [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], поэтому он не влияет на выполнение нерегламентированного резервного копирования.  
  
 Поддерживаются следующие значения:  
  
 PRIMARY  
 Указывает, что резервное копирования должно всегда выполняться на первичной реплике. Данный параметр является полезным, если вам требуются такие функции резервного копирования, как создание разностных резервных копий, которые не поддерживаются при выполнении резервного копирования на вторичной реплике.  
  
> [!IMPORTANT]  
>  Если планируется использовать доставку журналов для подготовки баз данных-получателей для группы доступности, задайте параметру автоматизированного резервного копирования значение **Первичная** до тех пор, пока все базы данных-получатели не будут подготовлены и присоединены к группе доступности.  
  
 SECONDARY_ONLY  
 Указывает, что резервное копирование никогда не выполняется на первичной реплике. Если первичная реплика является единственной репликой, находящейся в режиме «в сети», резервное копирование не будет выполняться.  
  
 SECONDARY  
 Указывает, что резервное копирование должно выполняться на вторичной реплике, за исключением тех случаев, когда в режиме «в сети» находится только первичная реплика. В этом случае резервное копирование будет выполняться на первичной реплике. Это поведение по умолчанию.  
  
 None  
 Указывает, что вы предпочитаете, чтобы задания резервного копирования пропускали реплики доступности при выборе реплики для создания резервных копий. Примечание. Задания резервного копирования могут учитывать другие факторы, например приоритет резервного копирования каждой реплики доступности в сочетании с ее состоянием работоспособности и соединения.  
  
> [!IMPORTANT]  
>  Принудительного применения параметра AUTOMATED_BACKUP_PREFERENCE не существует. Интерпретация данного приоритета зависит от логики (при ее наличии), которая внесена в задания резервного копирования для баз данных в указанной группе доступности. Параметр автоматического резервного копирования не влияет на выполнение нерегламентированного резервного копирования. Дополнительные сведения см. в разделе [Настройка резервного копирования в репликах доступности (SQL Server)](../../database-engine/availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).  
  
> [!NOTE]  
>  Для просмотра приоритета автоматического резервного копирования существующей группы доступности необходимо выбрать столбец **automated_backup_preference** или **automated_backup_preference_desc** представления каталога [sys.availability_groups](../../relational-databases/system-catalog-views/sys-availability-groups-transact-sql.md). Кроме того, приоритет реплики резервного копирования можно просмотреть в представлении [sys.fn_hadr_backup_is_preferred_replica (Transact-SQL)](../../relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql.md).  Эта функция возвращает значение 1 при наличии хотя бы одной реплики, даже если `AUTOMATED_BACKUP_PREFERENCE = NONE`.  
  
 FAILURE_CONDITION_LEVEL **=** { 1 \| 2 \| **3** \| 4 \| 5 }  
 Указывает, какие условия сбоя могут запустить автоматический переход на другой ресурс в этой группе доступности. Параметр FAILURE_CONDITION_LEVEL задается на уровне группы, однако он действует только в отношении реплик доступности, настроенных в режиме доступности синхронной фиксации (AVAILABILITY_MODE **=** SYNCHRONOUS_COMMIT). Более того, условия сбоя могут запустить автоматический переход на другой ресурс только в том случае, если и первичная, и вторичная реплики настроены на режим автоматического перехода на другой ресурс (FAILOVER_MODE **=** AUTOMATIC), при этом вторичная реплика должна в данный момент быть синхронизирована с первичной.  
  
 Уровни условий сбоя (1–5) варьируются от наименее ограничительного уровня 1 до наиболее ограничительного уровня 5. Заданный уровень условий включает в себя ограничения всех предыдущих уровней. Таким образом, наиболее строгий уровень 5 включает в себя ограничения уровней с 1 по 4, уровень 4 содержит ограничения уровней с 1 по 3 и т. д. Уровни условий сбоя описаны в следующей таблице.  
  
|Level|Условия сбоя|  
|-----------|-----------------------|  
|1|Указывает, что следует запустить автоматический переход на другой ресурс при возникновении любой из следующих ситуаций.<br /><br /> \- Служба [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] остановлена.<br /><br /> \- Аренда группы доступности для подключения к кластеру WSFC истекла, поскольку от экземпляра сервера не было получено сообщение ACK. Дополнительные сведения см. в разделе [Как это работает: время ожидания аренды Always On в SQL Server](/archive/blogs/psssql/how-it-works-sql-server-alwayson-lease-timeout).|  
|2|Указывает, что следует запустить автоматический переход на другой ресурс при возникновении любой из следующих ситуаций.<br /><br /> \- Экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не подключается к кластеру, а определяемый пользователем порог HEALTH_CHECK_TIMEOUT для группы доступности превышен.<br /><br /> \- Реплика доступности находится в неисправном состоянии.|  
|3|Указывает, что следует запустить автоматический переход на другой ресурс в случае появления критических внутренних ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], таких как потерянные спин-блокировки, серьезные нарушения доступа для записи или формирование слишком больших дампов.<br /><br /> Это поведение по умолчанию.|  
|4|Указывает, что следует запустить автоматический переход на другой ресурс в случае появления не столь серьезных внутренних ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], например устойчивое состояние нехватки памяти в пуле внутренних ресурсов [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].|  
|5|Указывает, что следует запустить автоматический переход на другой ресурс при любом удовлетворяющим условиям состоянии сбоя, включая:<br /><br /> \- Исчерпание рабочих потоков ядра SQL.<br /><br /> \- Обнаружение неразрешимой взаимоблокировки.|  
  
> [!NOTE]  
>  Отсутствие ответа экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] на клиентские запросы не является существенным для групп доступности.  
  
 Значения FAILURE_CONDITION_LEVEL и HEALTH_CHECK_TIMEOUT определяют *гибкую политику отработки отказа* для заданной группы. Данная гибкая политика отработки отказа предоставляет гранулярное управление условиями, которые могут вызвать автоматический переход на другой ресурс. Дополнительные сведения см. в разделе [Гибкая политика отработки отказа для автоматического перехода на другой ресурс группы доступности (SQL Server)](../../database-engine/availability-groups/windows/configure-flexible-automatic-failover-policy.md).  
  
 HEALTH_CHECK_TIMEOUT **=** *milliseconds*  
 Указывает время ожидания (в миллисекундах) возвращения сведений о состоянии сервера системной хранимой процедурой [sp_server_diagnostics](../../relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql.md) перед тем, как кластер WSFC признает, что экземпляр сервера не отвечает на запросы или его работа замедлена. Параметр HEALTH_CHECK_TIMEOUT задается на уровне группы, но применяется только в репликах доступности, настроенных для работы в режиме доступности синхронной фиксации с автоматическим переходом на другой ресурс (AVAILABILITY_MODE **=** SYNCHRONOUS_COMMIT).  Более того, время ожидания для проверки состояния системы может запустить автоматический переход на другой ресурс только в том случае, если первичная и вторичная реплики настроены на режим автоматического перехода на другой ресурс (FAILOVER_MODE **=** AUTOMATIC), при этом вторичная реплика должна быть в данный момент синхронизирована с первичной.  
  
 Значение параметра HEALTH_CHECK_TIMEOUT по умолчанию — 30 000 миллисекунд (30 секунд). Минимальное значение — 15 000 миллисекунд (15 секунд), а максимальное значение — 4 294 967 295 миллисекунд.  
  
> [!IMPORTANT]  
>  **sp_server_diagnostics** не выполняет проверку работоспособности на уровне базы данных.  
  
 DB_FAILOVER **=** { ON | OFF }  
 Задает реакцию в случае, когда база данных в первичной реплике находится в автономном режиме. Если задано значение ON, любое состояние базы данных в группе доступности, отличное от ONLINE, инициирует автоматический переход на другой ресурс. Если этот параметр имеет значение OFF, для запуска автоматического перехода на другой ресурс учитывается только работоспособность экземпляра.  
  
  Дополнительные сведения об этом параметре см. в разделе [Параметр определения уровня работоспособности баз данных](../../database-engine/availability-groups/windows/sql-server-always-on-database-health-detection-failover-option.md) 
  
 DTC_SUPPORT  **=** { PER_DB | NONE }  
 Указывает, поддерживаются ли межбазовые транзакции с помощью координатора распределенных транзакций (DTC). Межбазовые транзакции поддерживаются только начиная с версии [!INCLUDE[sssql16-md](../../includes/sssql16-md.md)]. PER_DB создает группу доступности с поддержкой этих транзакций. Дополнительные сведения см. в статье [Транзакции между базами данных и распределенные транзакции для групп доступности AlwaysOn и зеркального отображения базы данных (SQL Server)](../../database-engine/availability-groups/windows/transactions-always-on-availability-and-database-mirroring.md).  
  
 BASIC  
 Используется для создания базовой группы доступности. Базовые группы доступности ограничиваются одной базы данных и двумя репликами: одной первичной и одной вторичной. Этот параметр заменяет нерекомендуемую функцию зеркального отображения базы данных в SQL Server Standard Edition. Дополнительные сведения см. в разделе [Базовые группы доступности (группы доступности AlwaysOn)](../../database-engine/availability-groups/windows/basic-availability-groups-always-on-availability-groups.md). Базовые группы доступности поддерживаются начиная с версии [!INCLUDE[sssql16-md](../../includes/sssql16-md.md)].  

 DISTRIBUTED  
 Используется для создания распределенной группы доступности. Этот параметр используется с параметром AVAILABILITY GROUP ON для подключения двух групп доступности в отдельных отказоустойчивых кластерах Windows Server.  Дополнительные сведения см. в разделе [Распределенные группы доступности (группы доступности AlwaysOn)](../../database-engine/availability-groups/windows/distributed-availability-groups.md). Распределенные группы доступности поддерживаются начиная с версии [!INCLUDE[sssql16-md](../../includes/sssql16-md.md)]. 

 REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT   
 Впервые представлено в SQL Server 2017. Позволяет задать минимальное число синхронных вторичных реплик, необходимых для фиксации, прежде чем первичная реплика зафиксирует транзакцию. Гарантирует, что транзакции SQL Server будут ожидать, пока журналы транзакций не будут обновлены минимальным числом вторичных реплик. Значение по умолчанию — 0, что дает ту же реакцию на событие, как и в SQL Server 2016. Минимальное значение — 0. Максимальное значение — число реплик минус 1. Этот параметр относится к репликам в режиме синхронной фиксации. Когда реплики находятся в режиме синхронной фиксации, операции записи на первичной реплике ждут, пока операции записи на вторичных синхронных репликах не будут зафиксированы в журнале транзакций базы данных реплики. Если SQL Server, на котором размещена вторичная синхронная реплика, перестает отвечать, SQL Server, на котором размещена первичная реплика, отметит вторичную реплику как NOT SYNCHRONIZED и продолжит. Когда недоступная база данных снова подключается к сети, она находится в состоянии "не синхронизировано", и реплика отмечена как неработоспособная, пока снова не синхронизируется с первичной репликой. Данный параметр гарантирует, что первичная реплика будет ждать, пока минимальное число реплик не зафиксирует каждую транзакцию. Если минимальное число реплик недоступно, фиксация в первичной реплике завершается ошибкой. В кластере типа `EXTERNAL` этот параметр меняется при добавлении группы доступности в кластерный ресурс. См. [Высокий уровень доступности и защита данных для конфигураций группы доступности](../../linux/sql-server-linux-availability-group-ha.md).

 CLUSTER_TYPE  
 Впервые представлено в SQL Server 2017. Используется, чтобы определить, находится ли группа доступности на отказоустойчивом кластере Windows Server (WSFC).  Укажите WSFC, если группа доступности находится на экземпляре отказоустойчивого кластера в отказоустойчивом кластере Windows. Укажите EXTERNAL, если кластер управляется диспетчером кластера, но не отказоустойчивым кластером Windows Server, например Linux Pacemaker. Укажите NONE, если группа доступности не использует WSFC для координации кластера. Например, если группа доступности включает серверы Linux без диспетчера кластеров. 

 DATABASE *database_name*  
 Задает список из одной или нескольких пользовательских баз данных на локальном экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (то есть на экземпляре сервера, на котором создается группа доступности). Можно указать несколько баз данных для группы доступности, но каждая база данных может принадлежать только к одной группе доступности. Дополнительные сведения о типе баз данных, который поддерживают группы доступности, см. в разделе [Предварительные требования, ограничения и рекомендации для групп доступности AlwaysOn (SQL Server)](../../database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability.md). Чтобы узнать, какие локальные базы данных уже принадлежат группе доступности, просмотрите столбец **replica_id** в представлении каталога [sys.databases](../../relational-databases/system-catalog-views/sys-databases-transact-sql.md).  
  
 Предложение DATABASE не является обязательным. Если параметр не указывается, новая группа доступности будет пустой.  
  
 После создания группы доступности подключитесь к каждому экземпляру сервера, где размещается вторичная реплика, а затем подготовьте каждую базу данных-получатель и включите ее в группу доступности. Дополнительные сведения см. в статье [Запуск перемещения данных для базы данных-получателя AlwaysOn (SQL Server)](../../database-engine/availability-groups/windows/start-data-movement-on-an-always-on-secondary-database-sql-server.md).  
  
> [!NOTE]  
>  Затем можно добавлять готовые базы данных в экземпляре сервера, где размещается текущая первичная реплика, в группу доступности. Также можно удалять базу данных из группы доступности. Дополнительные сведения см. в разделе [ALTER AVAILABILITY GROUP (Transact-SQL)](../../t-sql/statements/alter-availability-group-transact-sql.md).  
  
 REPLICA ON  
 Указывает от одного до пяти экземпляров SQL Server для размещения реплик доступности в новой группе доступности.  Каждая реплика задается по адресу экземпляра своего сервера, за которым следует предложение WITH (…). Как минимум необходимо указать экземпляр локального сервера, который станет начальной первичной репликой. Дополнительно можно указать до четырех вторичных реплик.  
  
 Необходимо включить каждую вторичную реплику в группу доступности. Дополнительные сведения см. в разделе [ALTER AVAILABILITY GROUP (Transact-SQL)](../../t-sql/statements/alter-availability-group-transact-sql.md).  
  
> [!NOTE]  
>  Если при создании группы доступности будут заданы не все четыре вторичные реплики, дополнительные вторичные реплики можно добавить в любое время с помощью инструкции [ALTER AVAILABILITY GROUP](../../t-sql/statements/alter-availability-group-transact-sql.md)[!INCLUDE[tsql](../../includes/tsql-md.md)]. Эту инструкцию также можно использовать для удаления любой вторичной реплики из существующей группы доступности.  
  
 \<server_instance> Задает адрес экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], на котором размещена реплика. Формат адреса зависит от вида экземпляра (именованный или по умолчанию) и типа экземпляра (изолированный или экземпляр отказоустойчивого кластера):  
  
 { '*системное_имя*[\\*имя_экземпляра*]' | '*сетевое_имя_FCI*[\\*имя_экземпляра*]' }  
  
 Этот адрес состоит из следующих компонентов:  
  
 *системное_имя*  
 Имя NetBIOS компьютера, на котором расположен целевой экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Этот компьютер должен быть узлом кластера WSFC.  
  
 *сетевое_имя_FCI*  
 Это сетевое имя, используемое для доступа к отказоустойчивому кластеру [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Используйте его, если экземпляр сервера является участником — партнером по обеспечению отработки отказа [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Выполнение SELECT [@@SERVERNAME](../../t-sql/functions/servername-transact-sql.md) на экземпляре сервера FCI возвращает всю его строку '*FCI_network_name*[\\*instance_name*]' (то есть полное имя реплики).  
  
 *instance_name*  
 Имя экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], размещенного на *system_name* или *FCI_network_name* с включенной службой HADR. Для экземпляра сервера по умолчанию указывать параметр *имя_экземпляра* не обязательно. В именах экземпляров не учитывается регистр символов. На именованном экземпляре это имя значения совпадает со значением, возвращаемым при выполнении `select ServerProperty(N'InstanceName');`.  
  
 \  
 Разделитель, используемый только при указании значения *instance_name* для отделения от аргументов *system_name* или *FCI_network_name*.  
  
 Дополнительные сведения о предварительных требованиях для узлов WSFC и экземпляров серверов см. в статье [Предварительные требования, ограничения и рекомендации для групп доступности AlwaysOn (SQL Server)](../../database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability.md).  
  
 ENDPOINT_URL **='** TCP **://** _system-address_ **:** _port_ **'**  
 Указывает путь URL для [конечной точки зеркального отображения базы данных](../../database-engine/database-mirroring/the-database-mirroring-endpoint-sql-server.md) на экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], на котором размещается реплика доступности, заданная в текущем предложении REPLICA ON.  
  
 Предложение ENDPOINT_URL является обязательным. Дополнительные сведения см. в разделе [Указание URL-адреса конечной точки при добавлении или изменении реплики доступности (SQL Server)](../../database-engine/availability-groups/windows/specify-endpoint-url-adding-or-modifying-availability-replica.md).  
  
 **'** TCP **://** _system-address_ **:** _port_ **'**  
 Задает URL-адрес для конечной точки или URL-адрес маршрутизации, доступный только для чтения. Параметры URL-адреса:  
  
 *system-address*  
 Это строка, такая как адрес системы, полное доменное имя или IP-адрес, однозначно идентифицирующий целевую компьютерную систему.  
  
 *port*  
 Номер порта, связанный с конечной точкой зеркального отображения экземпляра сервера-участника (для параметра ENDPOINT_URL), или номер порта, используемый компонентом [!INCLUDE[ssDE](../../includes/ssde-md.md)] в экземпляре сервера (для параметра READ_ONLY_ROUTING_URL).  
  
 AVAILABILITY_MODE **=** { {SYNCHRONOUS_COMMIT | ASYNCHRONOUS_COMMIT | CONFIGURATION_ONLY }  
 SYNCHRONOUS_COMMIT или ASYNCHRONOUS_COMMIT Указывает, должна ли первичная реплика ждать подтверждения фиксации (записи) записей журнала на диск от вторичной реплики перед тем, как фиксировать транзакцию в указанной базе данных. Фиксация транзакций в других базах данных, расположенных в этой первичной реплике, может выполняться независимо. В SQL Server 2017 с накопительным пакетом обновления 1 доступен новый вариант CONFIGURATION_ONLY. Реплика CONFIGURATION_ONLY применяется только к группам доступности с CLUSTER_TYPE = EXTERNAL или CLUSTER_TYPE = NONE. 
  
 SYNCHRONOUS_COMMIT  
 Указывает, что первичная реплика может фиксировать транзакции только после их записи на данной вторичной реплике (режим синхронной фиксации). Вы можете указать SYNCHRONOUS_COMMIT не более чем для трех реплик, включая первичную.  
  
 ASYNCHRONOUS_COMMIT  
 Указывает, что первичная реплика фиксирует транзакции без ожидания записи журнала на данной вторичной реплике (режим доступности синхронной фиксации). Вы можете указать ASYNCHRONOUS_COMMIT не более чем для пяти реплик доступности, включая первичную реплику.  

 CONFIGURATION_ONLY указывает, что первичная реплика синхронно фиксирует метаданные конфигурации группы доступности в базе данных master этой реплики. Реплика не будет содержать данные пользователя. Этот параметр:

- Может размещаться в любом выпуске SQL Server, включая экспресс-выпуск.
- Требует, чтобы конечная точка зеркального отображения данных реплики CONFIGURATION_ONLY имела тип `WITNESS`.
- Не может быть изменен.
- Недопустим, когда `CLUSTER_TYPE = WSFC`.
- Параметры `failover_mode` и `seeding_mode` не поддерживаются, если для реплики в качестве `availability_mode` задано значение `configuration_only`. Пример показан [здесь](../../linux/sql-server-linux-availability-group-configure-ha.md).

   Дополнительные сведения см. в разделе [Реплика только с конфигурацией](../../linux/sql-server-linux-availability-group-ha.md).
  
 Предложение AVAILABILITY_MODE является обязательным. Дополнительные сведения см. в разделе [Режимы доступности (группы доступности AlwaysOn)](../../database-engine/availability-groups/windows/availability-modes-always-on-availability-groups.md).  
  
 FAILOVER_MODE **=** { AUTOMATIC | MANUAL }  
 Указывает режим отработки отказов определяемой реплики доступности.  
  
 AUTOMATIC  
 Включает автоматический переход на другой ресурс. Этот параметр поддерживается только в том случае, если также указывается AVAILABILITY_MODE = SYNCHRONOUS_COMMIT. Значение AUTOMATIC можно задать для двух реплик доступности, включая первичную.  
  
> [!NOTE]  
>  Экземпляры отказоустойчивого кластера SQL Server не поддерживают автоматический переход на другой ресурс с учетом групп доступности, поэтому любая реплика доступности, размещенная в них, должна быть настроена для перехода на другой ресурс вручную.  
  
 MANUAL  
 Позволяет администратору базы данных осуществлять переход на другой ресурс вручную по плану или принудительно (обычно это называется *принудительным переходом на другой ресурс*).  
  
 Предложение FAILOVER_MODE является обязательным. Существует два вида перехода на другой ресурс вручную: переход на другой ресурс вручную без потери данных и принудительный переход на другой ресурс (с возможной потерей данных), которые поддерживаются в зависимости от различных условий. Дополнительные сведения см. далее в подразделе [Отработка отказа и режимы отработки отказа (группы доступности AlwaysOn)](../../database-engine/availability-groups/windows/failover-and-failover-modes-always-on-availability-groups.md).  
  
 SEEDING_MODE **=** { AUTOMATIC | MANUAL }  
 Указывает, как вторичная реплика изначально заполняется данными.  
  
 AUTOMATIC  
 Включает прямое первоначальное заполнение. Этот метод заполняет вторичную реплику начальными значениями по сети. Этот метод не требует резервного копирования и восстановления копии базы данных-источника в реплике.  
  
> [!NOTE]  
>  Для прямого присвоения начальных значений необходимо разрешить создание базы данных в каждой вторичной реплике с помощью инструкции **ALTER AVAILABILITY GROUP** с параметром **GRANT CREATE ANY DATABASE**.  
  
 MANUAL  
 Указывает на присвоение начальных значений вручную (по умолчанию). В этом методе вы создаете резервную копию базы данных на первичной реплике и вручную восстанавливаете эту резервную копию на вторичной реплике.  
  
 BACKUP_PRIORITY **=** *n*  
 Указывает приоритет выполнения резервного копирования на данной реплике по отношению к другим репликам из той же группы доступности. Значение представляет собой целое число в диапазоне от 0 до 100. Данные величины имеют следующие значения:  
  
-   1..100 показывает, что реплику доступности можно выбрать для выполнения резервного копирования. 1 указывает минимальный приоритет, 100 — наивысший приоритет. При BACKUP_PRIORITY = 1 реплика доступности будет выбрана для создания резервных копий только в том случае, если реплики доступности с более высоким приоритетом отсутствуют.  
  
-   Значение 0 указывает, что эта реплика доступности не используется для создания резервных копий. Этот параметр может быть полезным, например, для исключения удаленной реплики доступности, создание резервных копий на которой нежелательно.  
  
 Дополнительные сведения см. в статье [Активные вторичные реплики: резервное копирование во вторичных репликах (группы доступности Always On)](../../database-engine/availability-groups/windows/active-secondaries-backup-on-secondary-replicas-always-on-availability-groups.md).  
  
 SECONDARY_ROLE **(** ... **)**  
 Задает параметры роли, которые будут действовать, если эта реплика доступности в данный момент имеет вторичную роль (то есть когда реплика является вторичной). В скобках укажите один или два параметра вторичной роли. Если указываются оба параметра, используйте список с разделителями-запятыми.  
  
 Параметры вторичной роли:  
  
 ALLOW_CONNECTIONS **=** { NO | READ_ONLY | ALL }  
 Указывает, могут ли базы данных заданной реплики доступности, играющей роль вторичной (т. е. служащей вторичной репликой), принимать соединения от клиентов. Может принимать одно из следующих значений:  
  
 NO  
 Для баз данных-получателей этой реплики соединения пользователя не разрешаются. Для них не разрешен доступ для чтения. Это поведение по умолчанию.  
  
 READ_ONLY  
 Разрешаются только соединения с базами данных во вторичной реплике, у которых свойство "Назначение приложения" имеет значение **ReadOnly**. Дополнительные сведения об этом свойстве см. в разделе [Using Connection String Keywords with SQL Server Native Client](../../relational-databases/native-client/applications/using-connection-string-keywords-with-sql-server-native-client.md).  
  
 ALL  
 К базам данных во вторичной реплике разрешаются все соединения на доступ только для чтения.  
  
 Дополнительные сведения см. в статье [Активные вторичные реплики: вторичные реплики для чтения (группы доступности Always On)](../../database-engine/availability-groups/windows/active-secondaries-readable-secondary-replicas-always-on-availability-groups.md).  
  
 READ_ONLY_ROUTING_URL **='** TCP **://** _system-address_ **:** _port_ **'**  
 Указывает URL-адрес, используемый для маршрутизации запросов на соединение с намерением чтения к этой реплике доступности. Этот URL-адрес прослушивается компонентом ядра СУБД SQL Server. Обычно экземпляр по умолчанию компонента ядра СУБД SQL Server прослушивает TCP-порт 1433.  
  
 Номер порта для именованного экземпляра вы можете получить, запросив столбцы **port** и **type_desc** динамического административного представления [sys.dm_tcp_listener_states](../../relational-databases/system-dynamic-management-views/sys-dm-tcp-listener-states-transact-sql.md). Экземпляр сервера использует прослушиватель Transact-SQL (**type_desc='TSQL'** ).  
  
 Дополнительные сведения о вычислении URL-адреса маршрутизации только для чтения для реплики см. в разделе [Вычисление значения read_only_routing_url для AlwaysOn](/archive/blogs/mattn/calculating-read_only_routing_url-for-alwayson).  
  
> [!NOTE]  
>  Для именованного экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] прослушиватель Transact-SQL должен быть настроен для использования определенного порта. Дополнительные сведения см. в разделе [Настройка сервера для прослушивания указанного TCP-порта (диспетчер конфигурации SQL Server)](../../database-engine/configure-windows/configure-a-server-to-listen-on-a-specific-tcp-port.md).  
  
 PRIMARY_ROLE **(** ... **)**  
 Задает параметры роли, которые будут действовать, если эта реплика доступности в данный момент имеет первичную роль (то есть когда реплика является первичной). В скобках укажите один или два параметра первичной роли. Если указываются оба параметра, используйте список с разделителями-запятыми.  
  
 Параметры первичной роли:  
  
 ALLOW_CONNECTIONS **=** { READ_WRITE | ALL }  
 Указывает тип соединений, которые принимаются от клиентов базами данных заданной реплики доступности, которая играет роль первичной. Это может быть один из следующих типов:  
  
 READ_WRITE  
 Соединения, у которых свойство "Назначение приложения" равно **ReadOnly** , не разрешены.  Если свойство «Назначение приложения» имеет значение **ReadWrite** или не задано, то соединение разрешено. Дополнительные сведения о свойстве соединения «Назначение приложения» см. в разделе [Using Connection String Keywords with SQL Server Native Client](../../relational-databases/native-client/applications/using-connection-string-keywords-with-sql-server-native-client.md).  
  
 ALL  
 Разрешаются все соединения с базами данных в первичной реплике. Это поведение по умолчанию.  
  
 READ_ONLY_ROUTING_LIST **=** { **('** \<server_instance> **'** [ **,** ...*n* ] **)** | NONE }. Задает список экземпляров сервера (с разделителями-запятыми), на которых будут размещаться реплики доступности для этой группы доступности, удовлетворяющие следующим требованиям при работе во вторичной роли.  
  
-   Настроены для разрешения всех соединений или соединений только для чтения (см. выше аргумент ALLOW_CONNECTIONS параметра SECONDARY_ROLE).  
  
-   Определен URL-адрес маршрутизации только для чтения (см. выше аргумент READ_ONLY_ROUTING_URL параметра SECONDARY_ROLE).  
  
 READ_ONLY_ROUTING_LIST имеет следующие значения.  
  
 \<server_instance> Задает адрес экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], где размещается вторичная реплика доступности, которая доступна для чтения при работе во вторичной роли.  
  
 Используйте список с разделителями-запятыми, чтобы указать все экземпляры сервера, где может размещаться доступная для чтения вторичная реплика. При маршрутизации только для чтения будет учитываться порядок, в котором экземпляры сервера заданы в списке. Если включить экземпляр сервера, где размещается реплика, в список маршрутизации только для чтения, то обычно рекомендуется поместить этот экземпляр сервера в конец списка, чтобы подключения с намерением чтения направлялись на вторичную реплику, если она доступна.  
  
 Начиная с версии [!INCLUDE[sssql16-md](../../includes/sssql16-md.md)] вы можете сбалансировать нагрузку запросов на чтение на вторичных репликах для чтения. Для этого поместите реплики во вложенный набор с круглыми скобками в список маршрутизации только для чтения. Дополнительные сведения и примеры см. в разделе [Настройка балансировки нагрузки между репликами только для чтения](../../database-engine/availability-groups/windows/configure-read-only-routing-for-an-availability-group-sql-server.md#loadbalancing).  
  
 None  
 Указывает, что, когда эта реплика доступности является первичной, маршрутизация только для чтения не поддерживается. Это поведение по умолчанию.  

 READ_WRITE_ROUTING_URL **=** { **('** \<server_instance> **')** }  
 Область применения: SQL Server (начиная с версии SQL Server 2019 (15.x)) 

 Определяет экземпляры сервера, на которых размещаются реплики доступности для этой группы доступности в соответствии со следующими требованиями при выполнении в первичной роли.
-   Спецификация реплики PRIMARY_ROLE содержит READ_WRITE_ROUTING_URL.
-   Строке подключения задается значение ReadWrite. Для этого параметру ApplicationIntent задается значение ReadWrite или не задается ничего, чтобы использовалось значение по умолчанию (ReadWrite).

Дополнительные сведения см. в статье [Перенаправление подключения с правами на чтение и запись с вторичной на первичную реплику (группы доступности AlwaysOn)](../../database-engine/availability-groups/windows/secondary-replica-connection-redirection-always-on-availability-groups.md).

 SESSION_TIMEOUT **=** *integer*  
 Указывает интервал времени ожидания сеанса в секундах. Если этот параметр не определить, интервал времени по умолчанию — 10 секунд. Минимальное значение составляет 5 секунд.  
  
> [!IMPORTANT]  
>  Рекомендуется установить интервал времени ожидания в 10 секунд или более.  
  
 Дополнительные сведения о периоде времени ожидания сеанса см. в разделе [Обзор групп доступности AlwaysOn (SQL Server)](../../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md).  
  
 AVAILABILITY GROUP ON  
 Указывает две группы доступности, составляющие *распределенную группу доступности*. Каждая группа доступности является частью своего отказоустойчивого кластера Windows Server (WSFC). Когда вы создаете распределенную группу доступности, группа доступности на текущем экземпляре SQL Server становится первичной группой доступности. Вторая группа доступности становится вторичной группой доступности.  
  
 Присоедините вторичную группу доступности к распределенной группе доступности. Дополнительные сведения см. в разделе [ALTER AVAILABILITY GROUP (Transact-SQL)](../../t-sql/statements/alter-availability-group-transact-sql.md).  
  
 \<ag_name> Указывает имя группы доступности, составляющей половину распределенной группы доступности.  
  
 LISTENER **='** TCP **://** _system-address_ **:** _port_ **'**  
 Указывает URL-адрес пути для прослушивателя, связанного с группой доступности.  
  
 Требуется предложение LISTENER.  
  
 **'** TCP **://** _system-address_ **:** _port_ **'**  
 Указывает URL-адрес для прослушивателя, связанного с группой доступности. Параметры URL-адреса:  
  
 *system-address*  
 Это строка, такая как имя системы, полное доменное имя или IP-адрес, однозначно идентифицирующая прослушивателя.  
  
 *port*  
 Номер порта, связанный с конечной точкой зеркального отображения группы доступности. Это не порт прослушивателя.  
  
 AVAILABILITY_MODE **=** { SYNCHRONOUS_COMMIT | ASYNCHRONOUS_COMMIT | CONFIGURATION_ONLY }  
 Указывает, должна ли первичная реплика ждать подтверждения фиксации (записи) записей журнала на диск от вторичной группы доступности перед тем, как фиксировать транзакцию в указанной базе данных.  
  
 SYNCHRONOUS_COMMIT  
 Указывает, что первичная реплика может фиксировать транзакции только после их записи во вторичной группе доступности. Вы можете указать SYNCHRONOUS_COMMIT не более чем для двух групп доступности, включая первичную группу доступности.  
  
 ASYNCHRONOUS_COMMIT  
 Указывает, что первичная реплика фиксирует транзакции без ожидания записи журнала от вторичной группы доступности. Вы можете указать ASYNCHRONOUS_COMMIT не более чем для двух групп доступности, включая первичную группу доступности.  
  
 Предложение AVAILABILITY_MODE является обязательным.  
  
 FAILOVER_MODE **=** { MANUAL }  
 Указывает режим отработки отказа распределенной группы доступности.  
  
 MANUAL  
 Позволяет администратору базы данных осуществлять переход на другой ресурс вручную по плану или принудительно (обычно это называется *принудительным переходом на другой ресурс*).  
  
 Предложение FAILOVER_MODE является обязательным, а единственный параметр — MANUAL. Во вторичной группе доступности автоматический переход на другой ресурс не поддерживается.  
  
 SEEDING_MODE **=** { AUTOMATIC | MANUAL }  
 Указывает, как вторичная группа доступности изначально заполняется данными.  
  
 AUTOMATIC  
 Включает прямое первоначальное заполнение. Этот метод будет заполнять вторичную группу доступности начальными значениями по сети. Этот метод не требует резервного копирования и восстановления копии базы данных-источника в репликах вторичной группы доступности.  
  
 MANUAL  
 Указывает на присвоение начальных значений вручную (по умолчанию). В этом методе вы создаете резервную копию базы данных на первичной реплике и вручную восстанавливаете эту резервную копию на репликах вторичной группы доступности.  
  
 LISTENER **'** _dns\_имя_ **'(** \<listener_option\> **)** Определяет новый прослушиватель группы доступности. Аргумент LISTENER является необязательным.  
  
> [!IMPORTANT]
>  Перед созданием первого прослушивателя настоятельно рекомендуется ознакомиться со статьей [Создание или настройка прослушивателя группы доступности (SQL Server)](../../database-engine/availability-groups/windows/create-or-configure-an-availability-group-listener-sql-server.md).  
> 
>  После создания прослушивателя для заданной группы доступности настоятельно рекомендуется выполнить следующие действия.  
> 
>  -   Попросите сетевого администратора зарезервировать IP-адрес, который будет использоваться только этим прослушивателем.  
> -   Передайте имя узла DNS прослушивателя разработчикам приложения для использования в строке подключения при запросе клиентских соединений к данной группе доступности.  
  
 *dns_name*  
 Указывает имя узла DNS для прослушивателя группы доступности. Имя DNS прослушивателя должно быть уникальным в домене и в NetBIOS.  
  
 *dns_name* является строковым значением. Это имя может содержать только буквы, цифры, дефисы (-) и знаки подчеркивания (_) в любом порядке. В именах узлов DNS учитывается регистр. Максимальная длина равна 63 символам.  
  
 Мы рекомендуем указывать строку, которая поддается толкованию. Например, для группы доступности с именем `AG1`понятным именем узла DNS будет `ag1-listener`.  
  
> [!IMPORTANT]  
>  NetBIOS распознает только первые 15 символов в dns_name. При наличии двух кластеров WSFC, которые управляются одной службой Active Directory, и попытке создать в обоих кластерах прослушивателей группы доступности с именами, содержащими более 15 символов, и одинаковым префиксом из 15 символов возникнет ошибка, указывающая, что не удалось подключиться к ресурсу с именем виртуальной сети. Дополнительные сведения о правилах именования префиксов для имен DNS см. в разделе [Присвоение имен доменов](https://technet.microsoft.com/library/cc731265\(WS.10\).aspx).  
  
 \<listener_option> LISTENER принимает один из следующих параметров \<listener_option>. 
  
 WITH DHCP [ ON { **('** _four\_part\_ipv4\_address_ **','** _four\_part\_ipv4\_mask_ **')** } ]  
 Указывает, что прослушиватель группы доступности использует протокол DHCP.  Дополнительно можно использовать предложение ON, чтобы определить сеть, для которой создается прослушиватель. Протокол DHCP имеет ограничение на работу только с одной подсетью для каждого экземпляра сервера, на котором размещается реплика в группе доступности.  
  
> [!IMPORTANT]  
>  Использовать протокол DHCP в производственной среде не рекомендуется. Если во время простоя аренда IP-адреса протокола DHCP истечет, то на регистрацию нового сетевого IP-адреса протокола DHCP, связанного с именем DNS-прослушивателя, уйдет дополнительное время, что скажется на производительности клиента. Однако протокол DHCP полезен при настройке среды разработки и проверки и позволяет проверить базовые функции групп доступности и их интеграцию с приложениями.  
  
 Пример:  
  
 `WITH DHCP ON ('10.120.19.0','255.255.254.0')`  
  
 WITH IP **(** { **('** _four\_part\_ipv4\_address_ **','** _four\_part\_ipv4\_mask_ **')**  |  **('** _ipv6\_address_ **')** } [ **,** ...*n* ] **)** [ **,** PORT **=** _listener\_port_ ]  
 Указывает, что вместо использования протокола DHCP прослушиватель группы доступности использует один или несколько статических IP-адресов. Чтобы создать группу доступности, охватывающую несколько подсетей, в конфигурации прослушивателя должен присутствовать один статический IP-адрес для каждой подсети. Для конкретной подсети статический IP-адрес может иметь формат IPv4 или IPv6. Свяжитесь с администратором сети, чтобы получить статический IP-адрес для каждой подсети, в которой будет размещена реплика для новой группы доступности.  
  
 Пример:  
  
 `WITH IP ( ('10.120.19.155','255.255.254.0') )`  
  
 *ip4_address*  
 Задает IPv4-адрес, состоящий из четырех частей, для прослушивателя группы доступности. Например, `10.120.19.155`.  
  
 *ipv4_mask*  
 Задает IPv4-маску, состоящую из четырех частей, для прослушивателя группы доступности. Например, `255.255.254.0`.  
  
 *ipv6_address*  
 Задает IPv6-адрес для прослушивателя группы доступности. Например, `2001::4898:23:1002:20f:1fff:feff:b3a3`.  
  
 PORT **=** *listener_port*  
 Указывает номер порта *listener_port* для использования прослушивателем группы доступности, который задается предложением WITH IP. Параметр PORT является необязательным.  
  
 По умолчанию поддерживается номер порта 1433. Однако из соображений безопасности, рекомендуется использовать другой номер порта.  
  
 Например: `WITH IP ( ('2001::4898:23:1002:20f:1fff:feff:b3a3') ) , PORT = 7777`  
  
## <a name="prerequisites-and-restrictions"></a>Требования и ограничения  
 Сведения о предварительных требованиях к созданию групп доступности см. в разделе [Предварительные требования, ограничения и рекомендации для групп доступности AlwaysOn (SQL Server)](../../database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability.md).  
  
 Сведения об ограничениях на инструкции AVAILABILITY GROUP языка Transact-SQL см. в разделе [Общие сведения об инструкциях Transact-SQL для групп доступности AlwaysOn (SQL Server)](../../database-engine/availability-groups/windows/transact-sql-statements-for-always-on-availability-groups.md).  
  
## <a name="security"></a>Безопасность  
  
### <a name="permissions"></a>Разрешения  
 Требуется членство в фиксированной роли сервера **sysadmin** и одно из разрешений: CREATE AVAILABILITY GROUP, ALTER ANY AVAILABILITY GROUP или CONTROL SERVER.  
  
## <a name="examples"></a>Примеры  
  
### <a name="a-configuring-backup-on-secondary-replicas-flexible-failover-policy-and-connection-access"></a>A. Настройка резервного копирования на вторичных репликах, гибкие политики обработки отказов и доступ к соединению  
 В следующем примере создается группа доступности `MyAg` для двух пользовательских баз данных, `ThisDatabase` и `ThatDatabase`. В следующей таблице представлена сводка значений для параметров, установленных для группы доступности в целом.  
  
|Параметр группы|Параметр|Описание|  
|------------------|-------------|-----------------|  
|AUTOMATED_BACKUP_PREFERENCE|SECONDARY|Параметр предпочтения автоматического резервного копирования указывает, что резервное копирование должно выполняться на вторичной реплике, за исключением тех случаев, когда в режиме «в сети» находится только первичная реплика (это режим по умолчанию). Чтобы параметр AUTOMATED_BACKUP_PREFERENCE как-то влиял на работу, необходимо создать скрипт заданий резервного копирования для баз данных доступности, чтобы они принимали в расчет предпочтения автоматического резервного копирования.|  
|FAILURE_CONDITION_LEVEL|3|Настройка уровня условия сбоя указывает, что следует запустить автоматический переход на другой ресурс в случае появления критических внутренних ошибок SQL Server, таких как потерянные спин-блокировки, серьезные нарушения доступа для записи или формирование слишком больших дампов.|  
|HEALTH_CHECK_TIMEOUT|600 000|Значение времени ожидания проверки работоспособности в 60 секунд указывает, что кластер WSFC будет ожидать в течение 60 000 миллисекунд, пока системная хранимая процедура [sp_server_diagnostics](../../relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql.md) не вернет сведения о работоспособности экземпляра сервера, на котором размещена реплика с синхронной фиксацией с автоматическим копированием, а затем кластер предположит, что экземпляр основного сервера работает медленно или завис. (Значение по умолчанию — 30 000 миллисекунд).|  
  
 Три реплики доступности должны быть размещены на экземплярах сервера по умолчанию на компьютерах с именами `COMPUTER01`, `COMPUTER02` и `COMPUTER03`. В следующей таблице приведена сводка значений, указанных в качестве параметров каждой реплики.  
  
|Параметр реплики|Настройка на `COMPUTER01`|Настройка на `COMPUTER02`|Настройка на `COMPUTER03`|Описание|  
|--------------------|-----------------------------|-----------------------------|-----------------------------|-----------------|  
|ENDPOINT_URL|TCP://*COMPUTER01:5022*|TCP://*COMPUTER02:5022*|TCP://*COMPUTER03:5022*|В этом примере системы находятся в одном домене, поэтому URL-адреса конечной точки могут использовать имена компьютерной системы в качестве системного адреса.|  
|AVAILABILITY_MODE|SYNCHRONOUS_COMMIT|SYNCHRONOUS_COMMIT|ASYNCHRONOUS_COMMIT|Две реплики используют режим синхронной фиксации. При синхронизации они поддерживают отработку отказа без потери данных. Третья реплика использует режим доступности с асинхронной фиксацией.|  
|FAILOVER_MODE|AUTOMATIC|AUTOMATIC|MANUAL|Реплики с синхронной фиксацией поддерживают автоматический переход на другой ресурс и запланированный переход на другой ресурс вручную. Реплика режима доступности с синхронной фиксацией поддерживает только принудительный переход на другой ресурс вручную.|  
|BACKUP_PRIORITY|30|30|90|Более высокий приоритет со значением 90 назначается реплике с асинхронной фиксацией, а не репликам с синхронной фиксацией. События резервного копирования чаще происходят на том экземпляре сервера, на котором размещена реплика с асинхронной фиксацией.|  
|SECONDARY_ROLE|( ALLOW_CONNECTIONS = NO,<br /><br /> READ_ONLY_ROUTING_URL = 'TCP://COMPUTER01:1433' )|( ALLOW_CONNECTIONS = NO,<br /><br /> READ_ONLY_ROUTING_URL = 'TCP://COMPUTER02:1433' )|( ALLOW_CONNECTIONS = READ_ONLY, <br />READ_ONLY_ROUTING_URL = 'TCP://COMPUTER03:1433' )|В качестве вторичной реплики с доступом для чтения может служить только реплика с асинхронной фиксацией.<br /><br /> Указывает имя компьютера и номер порта компонента ядра СУБД по умолчанию (1433).<br /><br /> Этот аргумент является необязательным.|  
|PRIMARY_ROLE|( ALLOW_CONNECTIONS = READ_WRITE, <br />READ_ONLY_ROUTING_LIST = (COMPUTER03) )|( ALLOW_CONNECTIONS = READ_WRITE, <br />READ_ONLY_ROUTING_LIST = (COMPUTER03) )|( ALLOW_CONNECTIONS = READ_WRITE, <br />READ_ONLY_ROUTING_LIST = NONE )|В основной роли все реплики отвергают попытки подключения, направленные на чтение данных.<br /><br /> Запросы на соединение с намерением чтения направляются на компьютер COMPUTER03, если локальная реплика работает с вторичной ролью. Если эта реплика работает с первичной ролью, то маршрутизация только для чтения отключается.<br /><br /> Этот аргумент является необязательным.|  
|SESSION_TIMEOUT|10|10|10|В этом примере указано значение времени ожидания завершения сеанса по умолчанию (10). Этот аргумент является необязательным.|  
  
 И наконец, в примере указано необязательное предложение LISTENER, предназначенное для создания прослушивателя группы доступности для новой группы доступности. Для этого прослушивателя задается уникальное имя DNS — `MyAgListenerIvP6`. Две реплики находятся в разных подсетях, поэтому прослушивателю необходимо использовать статические IP-адреса. Для каждой из двух реплик доступности предложение WITH IP указывает статический IP-адрес `2001:4898:f0:f00f::cf3c` и `2001:4898:e0:f213::4ce2`, использующий формат IPv6. В этом примере также указывается и используется необязательный параметр PORT, указывающий порт `60173` в качестве порта прослушивателя.  
  
```SQL
CREATE AVAILABILITY GROUP MyAg   
   WITH (  
      AUTOMATED_BACKUP_PREFERENCE = SECONDARY,  
      FAILURE_CONDITION_LEVEL  =  3,   
      HEALTH_CHECK_TIMEOUT = 600000  
       )  
  
   FOR   
      DATABASE  ThisDatabase, ThatDatabase   
   REPLICA ON   
      'COMPUTER01' WITH   
         (  
         ENDPOINT_URL = 'TCP://COMPUTER01:5022',  
         AVAILABILITY_MODE = SYNCHRONOUS_COMMIT,  
         FAILOVER_MODE = AUTOMATIC,  
         BACKUP_PRIORITY = 30,  
         SECONDARY_ROLE (ALLOW_CONNECTIONS = NO,   
            READ_ONLY_ROUTING_URL = 'TCP://COMPUTER01:1433' ),
         PRIMARY_ROLE (ALLOW_CONNECTIONS = READ_WRITE,   
            READ_ONLY_ROUTING_LIST = (COMPUTER03) ),  
         SESSION_TIMEOUT = 10  
         ),   
  
      'COMPUTER02' WITH   
         (  
         ENDPOINT_URL = 'TCP://COMPUTER02:5022',  
         AVAILABILITY_MODE = SYNCHRONOUS_COMMIT,  
         FAILOVER_MODE = AUTOMATIC,  
         BACKUP_PRIORITY = 30,  
         SECONDARY_ROLE (ALLOW_CONNECTIONS = NO,   
            READ_ONLY_ROUTING_URL = 'TCP://COMPUTER02:1433' ),  
         PRIMARY_ROLE (ALLOW_CONNECTIONS = READ_WRITE,   
            READ_ONLY_ROUTING_LIST = (COMPUTER03) ),  
         SESSION_TIMEOUT = 10  
         ),   
  
      'COMPUTER03' WITH   
         (  
         ENDPOINT_URL = 'TCP://COMPUTER03:5022',  
         AVAILABILITY_MODE = ASYNCHRONOUS_COMMIT,  
         FAILOVER_MODE =  MANUAL,  
         BACKUP_PRIORITY = 90,  
         SECONDARY_ROLE (ALLOW_CONNECTIONS = READ_ONLY,   
            READ_ONLY_ROUTING_URL = 'TCP://COMPUTER03:1433' ),  
         PRIMARY_ROLE (ALLOW_CONNECTIONS = READ_WRITE,   
            READ_ONLY_ROUTING_LIST = NONE ),  
         SESSION_TIMEOUT = 10  
         );
GO  
ALTER AVAILABILITY GROUP [MyAg]
  ADD LISTENER 'MyAgListenerIvP6' ( WITH IP ( ('2001:db88:f0:f00f::cf3c'),('2001:4898:e0:f213::4ce2') ) , PORT = 60173 );   
GO  
```  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> Связанные задачи  
  
-   [Создание группы доступности (Transact-SQL)](../../database-engine/availability-groups/windows/create-an-availability-group-transact-sql.md)  
  
-   [Использование мастера групп доступности (среда SQL Server Management Studio)](../../database-engine/availability-groups/windows/use-the-availability-group-wizard-sql-server-management-studio.md)  
  
-   [Использование диалогового окна "Создание группы доступности" (среда SQL Server Management Studio)](../../database-engine/availability-groups/windows/use-the-new-availability-group-dialog-box-sql-server-management-studio.md)  
  
-   [Использование мастера групп доступности (среда SQL Server Management Studio)](../../database-engine/availability-groups/windows/use-the-availability-group-wizard-sql-server-management-studio.md)  
  
## <a name="see-also"></a>См. также:  
 [ALTER AVAILABILITY GROUP (Transact-SQL)](../../t-sql/statements/alter-availability-group-transact-sql.md)   
 [ALTER DATABASE SET HADR (Transact-SQL)](../../t-sql/statements/alter-database-transact-sql-set-hadr.md)   
 [DROP AVAILABILITY GROUP (Transact-SQL)](../../t-sql/statements/drop-availability-group-transact-sql.md)   
 [Поиск и устранение неисправностей конфигурации групп доступности AlwaysOn (SQL Server)](../../database-engine/availability-groups/windows/troubleshoot-always-on-availability-groups-configuration-sql-server.md)   
 [Обзор групп доступности AlwaysOn (SQL Server)](../../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md)   
 [Прослушиватели групп доступности, возможность подключения клиентов и отработка отказа приложений (SQL Server)](../../database-engine/availability-groups/windows/listeners-client-connectivity-application-failover.md)
