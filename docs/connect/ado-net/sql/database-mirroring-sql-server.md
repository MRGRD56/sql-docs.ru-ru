---
title: Зеркалирование баз данных в SQL Server
description: Сведения о зеркалировании баз данных и необходимости принятия во внимание таких событий, как отработка отказа, при разработке приложений ADO.NET.
ms.date: 09/30/2019
dev_langs:
- csharp
ms.assetid: 89befaff-bb46-4290-8382-e67cdb0e3de9
ms.prod: sql
ms.prod_service: connectivity
ms.technology: connectivity
ms.topic: conceptual
author: David-Engel
ms.author: v-daenge
ms.reviewer: v-kaywon
ms.openlocfilehash: afa10c2c657ba2f67d6a3521768a364e89f7268b
ms.sourcegitcommit: 524a0f0cc9533188f4b14d2e78ba1cfe816b3b9a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2021
ms.locfileid: "105633234"
---
# <a name="database-mirroring-in-sql-server"></a>Зеркалирование баз данных в SQL Server

[!INCLUDE[Driver_ADONET_Download](../../../includes/driver_adonet_download.md)]

Зеркальное отображение базы данных в SQL Server позволяет сохранять копию или зеркальную копию базы данных SQL Server на резервном сервере. Зеркальное отображение гарантирует, что две отдельные копии данных существуют постоянно, обеспечивая высокий уровень доступности и избыточности данных. Поставщик SqlClient (Майкрософт) для SQL Server предоставляет неявную поддержку зеркального отображения базы данных. Разработчику не надо предпринимать никаких действий, если клиент настроен для работы с базой данных SQL Server. Кроме того, объект <xref:Microsoft.Data.SqlClient.SqlConnection> поддерживает явный режим подключения, который позволяет указать имя сервера-партнера по обеспечению отработки отказа в <xref:Microsoft.Data.SqlClient.SqlConnection.ConnectionString%2A>.

Следующая упрощенная последовательность событий возникает для объекта <xref:Microsoft.Data.SqlClient.SqlConnection>, предназначенного для базы данных, которая настроена для зеркального отображения:

1. Клиентское приложение успешно подключается к основной базе данных, а сервер отправляет обратно имя сервера-партнера, которое кэширует клиент.
2. Если на сервере с основной базой данных происходит сбой или подключение прерывается, состояние подключения и транзакции будет утеряно. Клиентское приложение пытается восстановить подключение к основной базе данных, и происходит сбой.
3. Затем клиентское приложение прозрачно пытается установить подключение к зеркальной базе данных на сервере-партнере. В случае успешной установки подключение перенаправляется в зеркальную базу данных, которая затем становится новой основной базой данных.

## <a name="specifying-the-failover-partner-in-the-connection-string"></a>Указание партнера по обеспечению отработки отказа в строке подключения

Если в строке подключения указать имя сервера-партнера по обеспечению отработки отказа и основная база данных недоступна при подключении клиентского приложения, клиент будет прозрачно пытаться подключиться к партнеру по обеспечению отработки отказа.

```csharp
";Failover Partner=PartnerServerName"
```

Если не указано имя сервера-партнера по обеспечению отработки отказа и основная база данных недоступна при первом подключении клиентского приложения, возникает <xref:Microsoft.Data.SqlClient.SqlException>.

При успешном открытии <xref:Microsoft.Data.SqlClient.SqlConnection> сервер возвращает имя партнера по обеспечению отработки отказа, которое заменяет все значения, указанные в строке подключения.

> [!NOTE]
> Необходимо явно указать имя исходного каталога или базы данных в строке подключения для сценариев зеркального отображения базы данных. Если клиент получает сведения о переходе на другой ресурс во время соединения, которое не содержит явно указанного исходного каталога или базы данных, эти сведения не кэшируются и приложение не делает попытку перехода на другой ресурс в случае выхода основного сервера из строя. Если строка подключения имеет значение для партнера по обеспечению отработки отказа, но не имеет значения для исходного каталога или базы данных, возникает `InvalidArgumentException`.

## <a name="retrieving-the-current-server-name"></a>Получение текущего имени сервера

При отработке отказа можно получить имя сервера, с которым установлено текущее подключение. Для этого используется свойство <xref:Microsoft.Data.SqlClient.SqlConnection.DataSource%2A> объекта <xref:Microsoft.Data.SqlClient.SqlConnection>. Следующий фрагмент кода извлекает имя активного сервера, предполагая, что переменная подключения ссылается на открытый элемент <xref:Microsoft.Data.SqlClient.SqlConnection>.

При возникновении события отработки отказа и переключении подключения на зеркальный сервер свойство **DataSource** обновляется для отображения имени этого сервера.

```csharp
string activeServer = connection.DataSource;
```

## <a name="sqlclient-mirroring-behavior"></a>Поведение SqlClient при зеркальном отображении

Клиент всегда пытается подключиться к основному серверу. В случае сбоя он пытается обратиться к партнеру по обеспечению отработки отказа. Если зеркальная база данных уже переключена на основную роль на сервере-партнере, подключение будет установлено успешно, а новое сопоставление зеркального отображения-субъекта отправляется клиенту и кэшируется на время существования вызова <xref:System.AppDomain>. Оно не сохраняется в постоянном хранилище и недоступно для последующих подключений в другом домене приложения **AppDomain** или процессе. Однако оно доступно для последующих подключений внутри того же домена приложения **AppDomain**. Другой домен приложения **AppDomain** или процесс, выполняемый на том же или другом компьютере, всегда имеет свой пул подключений и эти подключения не сбрасываются. В этом случае, если база данных-источник выходит из строя, каждый процесс или домен приложения **AppDomain** заканчивается ошибкой и пул автоматически очищается.

> [!NOTE]
> Поддержка зеркального отображения на сервере настраивается отдельно для каждой базы данных. Если операции обработки данных выполняются для других баз данных, не входящих в основной или зеркальный набор, с помощью составных имен либо путем изменения текущей базы данных, изменения в этих базах данных не распространяются в случае сбоя. При изменении данных в незеркальной базе данных ошибка не возникает. Разработчик должен оценить возможное воздействие таких операций.

## <a name="next-steps"></a>Дальнейшие действия

### <a name="database-mirroring-resources"></a>Ресурсы по зеркальному отображению баз данных

Основную документацию и сведения о настройке, развертывании и администрировании зеркального подключения см. в приведенных ниже ресурсах документации по SQL Server.

|Ресурс|Описание|
|--------------|-----------------|
|[Зеркальное отображение базы данных](../../../database-engine/database-mirroring/database-mirroring-sql-server.md)|Описывается установка и настройка зеркального отображения в SQL Server.|
