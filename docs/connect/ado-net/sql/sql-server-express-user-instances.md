---
title: Пользовательские экземпляры SQL Server Express
description: В этой статье описывается поддержка пользовательских экземпляров SQL Server Express.
ms.date: 08/15/2019
dev_langs:
- csharp
ms.assetid: 00c12376-cb26-4317-86ad-e6e9c089be57
ms.prod: sql
ms.prod_service: connectivity
ms.technology: connectivity
ms.topic: conceptual
author: David-Engel
ms.author: v-daenge
ms.reviewer: v-kaywon
ms.openlocfilehash: f44991b2ea59d3f6cf6e1cf5a2bd653f270aa1ad
ms.sourcegitcommit: c7f40918dc3ecdb0ed2ef5c237a3996cb4cd268d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/05/2020
ms.locfileid: "91725585"
---
# <a name="sql-server-express-user-instances"></a>Пользовательские экземпляры SQL Server Express

[!INCLUDE[Driver_ADONET_Download](../../../includes/driver_adonet_download.md)]

Выпуск Microsoft SQL Server Express Edition (SQL Server Express) поддерживает пользовательские экземпляры, которые доступны только при использовании поставщика данных Microsoft SqlClient для SQL Server. Пользовательский экземпляр — это отдельный экземпляр ядра СУБД SQL Server Express, созданный родительским экземпляром. С помощью пользовательских экземпляров пользователи, не являющиеся администраторами на локальных компьютерах, могут присоединяться базы данных SQL Server Express и подключаться к ним. Каждый экземпляр выполняется в контексте безопасности отдельного пользователя на основе модели "один экземпляр на пользователя".  
  
## <a name="user-instance-capabilities"></a>Возможности пользовательского экземпляра  
Пользовательские экземпляры необходимы для пользователей, которые используют Windows с учетной записью пользователя с минимальными правами (LUA), так как каждый пользователь имеет привилегии системного администратора SQL Server (`sysadmin`) для экземпляра, работающего на компьютере, без необходимости запуска в качестве администратора Windows. Программное обеспечение, выполняемое в пользовательском экземпляре с ограниченными разрешениями, не может вносить изменения на уровне системы, так как экземпляр SQL Server Express работает под учетной записью пользователя Windows без прав администратора, а не как служба. Каждый пользовательский экземпляр изолирован от родительского и любых других пользовательских экземпляров, выполняющихся на том же компьютере. Базы данных, запущенные в пользовательском экземпляре, открываются только в однопользовательском режиме. Таким образом несколько пользователей не могут подключаться к базам данных, запущенным в пользовательском экземпляре. Репликация и распределенные запросы также отключены для пользовательских экземпляров.  
  
Дополнительные сведения см. в разделе "Пользовательские экземпляры" электронной документации на SQL Server.  
  
> [!NOTE]
>  Пользовательские экземпляры не требуются для пользователей, которые уже являются администраторами на своих компьютерах, или для сценариев, включающих несколько пользователей базы данных.  
  
## <a name="enabling-user-instances"></a>Разрешение пользовательских экземпляров  
Для создания пользовательских экземпляров требуется запуск родительского экземпляра SQL Server Express. Пользовательские экземпляры по умолчанию включаются, если установлен SQL Server Express, и они могут быть явно включаться или отключаться системным администратором, выполняющим системную хранимую процедуру **sp_configure** в родительском экземпляре.  
  
```sql
-- Enable user instances.  
sp_configure 'user instances enabled','1'   
  
-- Disable user instances.  
sp_configure 'user instances enabled','0'  
```  
  
Для пользовательских экземпляров поддерживается только сетевой протокол локальных именованных каналов. Пользовательский экземпляр невозможно запустить на удаленном экземпляре SQL Server, а учетные данные SQL Server запрещено использовать.  
  
## <a name="connecting-to-a-user-instance"></a>Подключение к пользовательскому экземпляру  
Ключевые слова `User Instance` и `AttachDBFilename`<xref:Microsoft.Data.SqlClient.SqlConnection.ConnectionString%2A> разрешают подключение <xref:Microsoft.Data.SqlClient.SqlConnection> к пользовательскому экземпляру. Пользовательские экземпляры также поддерживаются свойствами <xref:Microsoft.Data.SqlClient.SqlConnectionStringBuilder>`UserInstance` и `AttachDBFilename`.  
  
Обратите внимание на следующие сведения о приведенном ниже примере строки подключения.  
  
- Ключевое слово `Data Source` относится к родительскому экземпляру SQL Server Express, создающему пользовательский экземпляр. Экземпляр по умолчанию — .\sqlexpress.  
  
- `Integrated Security` задан как `true`. Для подключения к пользовательскому экземпляру требуется проверка подлинности Windows. Учетные данные SQL Server не поддерживаются.  
  
- `User Instance` имеет значение `true`. В этом случае вызывается пользовательский экземпляр. (Значение по умолчанию — `false`.)  
  
- Ключевое слово строки подключения `AttachDbFileName` используется для приподключения файла базы данных-источника (MDF) и должно включать полный путь. `AttachDbFileName` также соответствует ключам "Расширенные свойства" и "Исходное имя файла" в строке подключения <xref:Microsoft.Data.SqlClient.SqlConnection>.  
  
- Строка подстановки `|DataDirectory|`, заключенная в символы вертикальной черты, ссылается на каталог данных приложения, открывающего подключение, и предоставляет относительный путь, указывающий расположение файлов базы данных и журнала MDF и LDF. Если вы хотите разместить эти файлы в других расположениях, необходимо указать полный путь к ним.  
  
```console
Data Source=.\\SQLExpress;Integrated Security=true;  
User Instance=true;AttachDBFilename=|DataDirectory|\InstanceDB.mdf;  
Initial Catalog=InstanceDB;  
```  
  
> [!NOTE]
>  Для создания строки подключения во время выполнения можно также использовать свойства <xref:Microsoft.Data.SqlClient.SqlConnectionStringBuilder><xref:Microsoft.Data.SqlClient.SqlConnectionStringBuilder.UserInstance%2A> и <xref:Microsoft.Data.SqlClient.SqlConnectionStringBuilder.AttachDBFilename%2A>.  
  
### <a name="using-the-124datadirectory124-substitution-string"></a>Использование строки подстановки &#124;DataDirectory&#124;  
Строка подстановки `DataDirectory` в сочетании со свойством `AttachDbFileName` позволяет указать относительный путь к файлу данных, тем самым позволяя разработчикам создавать строки соединения относительно пути к источнику данных.  
  
Физическое расположение, на которое указывает `DataDirectory`, зависит от типа приложения. В этом примере вкладываемый файл Northwind.mdf находится в папке \app_data приложения.  
  
```console
Data Source=.\\SQLExpress;Integrated Security=true;  
User Instance=true;  
AttachDBFilename=|DataDirectory|\app_data\Northwind.mdf;  
Initial Catalog=Northwind;  
```  
  
При использовании `DataDirectory` путь к результирующему файлу не может быть выше в структуре каталога, чем каталог, на который указывает строка подстановки. Например, если полностью развернутая строка `DataDirectory` — C:\AppDirectory\app_data, то показанный выше пример строки подключения подойдет, так как он ниже c:\AppDirectory. Но попытка задать `DataDirectory` как `|DataDirectory|\..\data` завершится ошибкой, потому что \data не является подкаталогом \AppDirectory.  
  
Если строка подключения имеет неверно отформатированную строку подстановки, будет вызвано исключение <xref:System.ArgumentException>.  
  
> [!NOTE]
>  <xref:Microsoft.Data.SqlClient> разрешает строки подстановки в полные пути в файловой системе локального компьютера. Исходя из сказанного выше, имена путей удаленного сервера, HTTP и UNC не поддерживаются. Если сервер не находится на локальном компьютере, во время открытия подключения вызывается исключение.  
  
При открытии подключения <xref:Microsoft.Data.SqlClient.SqlConnection> оно перенаправляется с экземпляра SQL Server Express по умолчанию на экземпляр, запущенный во время выполнения, который выполняется под учетной записью вызывающего объекта.  
  
> [!NOTE]
>  В некоторых случаях может потребоваться увеличить значение <xref:Microsoft.Data.SqlClient.SqlConnection.ConnectionTimeout%2A>, так как для загрузки пользовательских экземпляров может потребоваться больше времени, чем для обычных экземпляров.  
  
Следующий фрагмент кода открывает новый объект `SqlConnection`, отображает строку подключения в окне консоли, а затем закрывает подключение при выходе из блока кода `using`.  
  
```csharp  
private static void OpenSqlConnection()  
{  
    // Retrieve the connection string.  
    string connectionString = GetConnectionString();  
  
    using (SqlConnection connection =   
        new SqlConnection(connectionString))  
    {  
        connection.Open();  
        Console.WriteLine("ConnectionString: {0}",   
             connection.ConnectionString);  
    }  
}  
```  
  
> [!NOTE]
>  Пользовательские экземпляры не поддерживаются в коде среды CLR, который выполняется в SQL Server. Если для объекта <xref:System.InvalidOperationException>, в котором в строке подключения указано значение `Open`, вызывается <xref:Microsoft.Data.SqlClient.SqlConnection>, выдается исключение `User Instance=true`.  
  
## <a name="lifetime-of-a-user-instance-connection"></a>Время существования подключения пользовательского экземпляра  
В отличие от версий SQL Server, которые запускаются как службы, экземпляры SQL Server Express не нужно запускать и останавливать вручную. Каждый раз, когда пользователь входит в систему и подключается к пользовательскому экземпляру, экземпляр запускается, если он еще не запущен. Для баз данных пользовательских экземпляров задан параметр `AutoClose`. Это позволяет автоматически завершать работу базы данных по истечении периода бездействия. Запущенный процесс sqlservr.exe выполняется в течение ограниченного времени ожидания после закрытия последнего подключения с экземпляром. Таким образом его не нужно перезапускать при открытии другого подключения до истечения времени ожидания. Пользовательский экземпляр автоматически завершает работу, если до истечения времени ожидания не будет открыто новое подключение. Администратор системы на родительском экземпляре может устанавливать длительность времени ожидания для пользовательского экземпляра при помощи процедуры **sp_configure**, которая изменяет параметр **user instance timeout**. Значение по умолчанию — 60 минут.  
  
> [!NOTE]
>  Если в строке подключения используется `Min Pool Size` со значением больше нуля, то пул подключений всегда будет поддерживать несколько открытых подключений, и пользовательский экземпляр не завершит работу автоматически.  
  
## <a name="how-user-instances-work"></a>Принцип работы пользовательских экземпляров  
При первом создании пользовательского экземпляра для любого пользователя системные базы данных **master** и **msdb** копируются из папки Template Data в локальный пользовательский каталог-репозиторий для монопольного использования пользовательским экземпляром. Этот путь обычно выглядит следующим образом: `C:\Documents and Settings\<UserName>\Local Settings\Application Data\Microsoft\Microsoft SQL Server Data\SQLEXPRESS`. При запуске пользовательского экземпляра база данных **tempdb** журнал и файлы трассировки также записываются в этот каталог. Для экземпляра создается имя, которое гарантированно будет уникальным для каждого пользователя.  
  
По умолчанию всем участникам группы Builtin\Users Windows предоставляются разрешения на подключение к локальному экземпляру, а также разрешения на чтение и выполнение для двоичных файлов SQL Server. После проверки учетных данных вызывающего пользователя, размещающего пользовательский экземпляр, этот пользователь станет `sysadmin` на этом экземпляре. Для пользовательских экземпляров включена только общая память, то есть возможны только операции на локальном компьютере.  
  
Пользователи должны иметь разрешения на чтение и запись для файлов MDF и LDF, указанных в строке подключения.  
  
> [!NOTE]
>  MDF и LDF представляют файлы базы данных и журнала соответственно. Эти два файла являются сопоставленным набором. Таким образом во время операций резервного копирования и восстановления необходимо соблюдать осторожность. Файл базы данных содержит сведения о точной версии файла журнала. База данных не будет открываться, если она связана с неверным файлом журнала.  
  
Чтобы избежать повреждения данных, база данных в пользовательском экземпляре открывается с монопольным доступом. Если два разных пользовательских экземпляра совместно используют одну и ту же базу данных на одном компьютере, пользователь первого экземпляра должен закрыть базу данных, прежде чем ее можно будет открыть во втором экземпляре.  
  
## <a name="user-instance-scenarios"></a>Сценарии пользовательских экземпляров  
Пользовательские экземпляры предоставляют разработчикам приложений баз данных хранилище данных SQL Server. Это хранилище не зависит от разработчиков, имеющих административные учетные записи на компьютерах разработки. Пользовательские экземпляры основаны на модели Access/Jet, где приложение базы данных просто подключается к файлу и пользователь автоматически получает полный набор разрешений на все объекты базы данных без необходимости предоставления разрешений администратором. Эта модель предназначена для ситуаций, когда пользователь работает с учетной записью с минимальными правами (LUA) и не имеет прав администратора на сервере или на локальном компьютере, но требует создания объектов базы данных и приложений. Благодаря пользовательским экземплярам пользователи могут создавать экземпляры во время выполнения, которые запускаются в собственном контексте безопасности, а не в контексте безопасности более привилегированной системной службы.  
  
> [!IMPORTANT]
>  Пользовательские экземпляры следует использовать только в сценариях, где все использующие их приложения являются полностью доверенными.  
  
Ниже приведены поддерживаемые сценарии пользовательских экземпляров.  
  
- Любое приложение с одним пользователем, в котором не требуется совместное использование данных.  
  
- Развертывание ClickOnce. Если .NET Framework 2.0 (или более поздняя версия) либо .NET Core 1.0 (или более поздняя версия), а также SQL Server Express уже установлены на целевом компьютере, пакет установки, загруженный как результат действия ClickOnce, может быть установлен и использован пользователями, не имеющими административных привилегий. Обратите внимание, что администратор должен установить SQL Server Express, если он является частью процесса установки. Дополнительные сведения см. в статье [ClickOnce Deployment for Windows Forms](/dotnet/framework/winforms/clickonce-deployment-for-windows-forms) (Развертывание ClickOnce для Windows Forms).
  
- Выделенное размещение ASP.NET с использованием проверки подлинности Windows. В интрасети может размещаться один экземпляр SQL Server Express. Приложение подключается с помощью учетной записи ASP.NET Windows, а не с использованием олицетворения. Пользовательские экземпляры не следует использовать для сценариев сторонних разработчиков или совместного размещения, где все приложения совместно используют один пользовательский экземпляр и больше не изолированы друг от друга.  
  
## <a name="next-steps"></a>Дальнейшие действия
- [SQL Server и ADO.NET](index.md)