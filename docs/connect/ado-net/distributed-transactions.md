---
title: Распределенные транзакции
description: Описание выполнения распределенных транзакций в ADO.NET
ms.date: 11/25/2020
ms.prod: sql
ms.prod_service: connectivity
ms.technology: connectivity
ms.topic: conceptual
author: David-Engel
ms.author: v-daenge
ms.reviewer: v-chmalh
ms.openlocfilehash: 77ed8486f8b059f12fe7178826d81a743a97bbc4
ms.sourcegitcommit: 866554663ca3191748b6e4eb4d8d82fa58c4e426
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/16/2020
ms.locfileid: "97559236"
---
# <a name="distributed-transactions"></a>Распределенные транзакции

[!INCLUDE[appliesto-netfx-netcore-netst-md](../../includes/appliesto-netfx-netcore-netst-md.md)]

[!INCLUDE[Driver_ADONET_Download](../../includes/driver_adonet_download.md)]

Транзакция - это набор связанных задач, который, помимо всего прочего, завершается успешно (фиксация) или с ошибкой (отмена) как единое целое. *Распределенная транзакция* — это транзакция, затрагивающая несколько ресурсов. Для фиксации распределенной транзакции все участники должны гарантировать, что любое изменение данных будет постоянным. Изменения должны сохраняться даже в случае фатального сбоя системы или других непредвиденных событий. Если хоть один из участников не сможет предоставить такую гарантию, вся транзакция завершится с ошибкой и будет выполнен откат любых изменений данных внутри области транзакции. 

> [!NOTE]
> Если `DataReader` запускается во время активной транзакции, то при попытке зафиксировать или выполнить откат транзакции возникнет исключение.

## <a name="working-with-systemtransactions"></a>Работа с System.Transactions

В .NET управление распределенными транзакциями осуществляется с помощью API в пространстве имен <xref:System.Transactions>. При участии нескольких постоянных диспетчеров ресурсов API-интерфейс <xref:System.Transactions> делегирует обработку распределенной транзакции средству наблюдения за транзакциями, такому как координатор распределенных транзакций (Майкрософт) (MSDTC). Дополнительные сведения см. в разделе [Основные сведения о транзакциях](/dotnet/framework/data/transactions/transaction-fundamentals).

В ADO.NET 2.0 появилась поддержка прикрепления распределенных транзакций с помощью метода `EnlistTransaction`, который прикрепляет подключение к экземпляру <xref:System.Transactions.Transaction>. В предыдущих версиях ADO.NET явное прикрепление к распределенной транзакции выполнялось с помощью метода соединения `EnlistDistributedTransaction` для прикрепления соединения к экземпляру <xref:System.EnterpriseServices.ITransaction>, который поддерживался в целях обратной совместимости. Дополнительные сведения о транзакциях в Enterprise Services см. в статье [Взаимодействие с транзакциями Enterprise Services и COM+](/dotnet/framework/data/transactions/interoperability-with-enterprise-services-and-com-transactions).

При использовании транзакции <xref:System.Transactions> с поставщиком данных Microsoft SqlClient для SQL Server для базы данных SQL Server автоматически будет использована упрощенная <xref:System.Transactions.Transaction>. Затем по мере необходимости транзакция может стать полной распределенной транзакцией. Дополнительные сведения см. в разделе [Интеграция System.Transactions с SQL Server](system-transactions-integration-with-sql-server.md).

## <a name="automatically-enlisting-in-a-distributed-transaction"></a>Автоматическое прикрепление распределенных транзакций

Автоматическое прикрепление является способом интеграции соединений ADO.NET по умолчанию (и предпочитаемым) с `System.Transactions`. В случае определения активной транзакции (что, с точки зрения `System.Transaction`, означает, что `Transaction.Current` отлична от значения типа NULL) объект соединения автоматически будет прикреплен к существующей распределенной транзакции. Автоматическое прикрепление транзакции происходит при открытии соединения. Оно не произойдет после открытия, даже если команда выполняется внутри области транзакций. Вы можете отключить автоматическое прикрепление для существующих транзакций, указав `Enlist=false` в качестве параметра строки подключения для <xref:Microsoft.Data.SqlClient.SqlConnection.ConnectionString%2A?displayProperty=nameWithType>.

## <a name="manually-enlisting-in-a-distributed-transaction"></a>Прикрепление распределенных транзакций вручную

Если автоматическое прикрепление отключено или требуется прикрепить транзакцию, которая была запущена после открытия подключения, вы можете выполнить прикрепление к существующей распределенной транзакции, используя метод `EnlistTransaction` объекта <xref:Microsoft.Data.SqlClient.SqlConnection> для поставщика данных Microsoft SqlClient для SQL Server. Прикрепление к существующей распределенной транзакции гарантирует, что в случае фиксации или отката транзакции изменения, выполненные кодом в источнике данных, будут также зафиксированы или откатаны назад.

Прикрепление к распределенным транзакциям обычно применяется при объединении бизнес-объектов в пул. Если бизнес-объект заносится в пул с открытым соединением, автоматическое прикрепление происходит только при открытии этого соединения. При выполнении нескольких транзакций с помощью занесенного в пул бизнес-объекта открытое для этого объекта соединение не будет автоматически прикрепляться к новым транзакциям. В этом случае можно отключить для соединения автоматическое прикрепление транзакций и прикреплять его к транзакциям с помощью `EnlistTransaction`.

`EnlistTransaction` принимает один аргумент типа <xref:System.Transactions.Transaction>, который является ссылкой на существующую транзакцию. После вызова метода соединения `EnlistTransaction` все изменения в источнике данных, выполненные с помощью соединения, включаются в транзакцию. Передача значения NULL исключает соединение из прикрепления к текущей распределенной транзакции. Обратите внимание, что соединение должно быть открыто до вызова `EnlistTransaction`.

> [!NOTE]
> После явного прикрепления соединения к транзакции нельзя отменить его прикрепление или прикрепить к другой транзакции до завершения первой транзакции.

> [!CAUTION]
> Если соединение уже запустило транзакцию с помощью метода соединений `EnlistTransaction`, то <xref:Microsoft.Data.SqlClient.SqlConnection.BeginTransaction%2A> вызовет исключение. Однако, если транзакция является локальной и запущенной из источника данных (например, явно выполнив инструкцию BEGIN TRANSACTION с помощью <xref:Microsoft.Data.SqlClient.SqlCommand>), `EnlistTransaction` выполнит откат локальной транзакции и прикрепит к существующей распределенной транзакции. Уведомления об откате локальной транзакции не высылается, и управление любыми незапущенными локальными транзакциями осуществляется с помощью <xref:Microsoft.Data.SqlClient.SqlConnection.BeginTransaction%2A>. При использовании поставщика данных Microsoft SqlClient для SQL Server с SQL Server попытка прикрепления вызовет исключение. Все остальные случаи исключений не вызовут.  

## <a name="promotable-transactions-in-sql-server"></a>Повышаемые транзакции в SQL Server

SQL Server поддерживает повышаемые транзакции, в которых локальная упрощенная транзакция может быть автоматически повышена до распределенной, если потребуется. Повышаемая транзакция не вызывает дополнительную нагрузку распределенной транзакции, если таковая не требуется. Дополнительные сведения и пример кода см. в разделе [Интеграция System.Transactions с SQL Server](system-transactions-integration-with-sql-server.md).

## <a name="configuring-distributed-transactions"></a>Настройка распределенных транзакций

 Для использования распределенных транзакций возможна необходимость включения в сети MS DTC. Если включен межсетевой экран Windows, необходимо разрешить службе MS DTC использовать сеть или открыть порт MS DTC.  
  
## <a name="see-also"></a>См. также раздел

- [Транзакции и параллельность](transactions-and-concurrency.md)
- [Интеграция System.Transactions с SQL Server](system-transactions-integration-with-sql-server.md)
- [Microsoft ADO.NET для SQL Server](microsoft-ado-net-sql-server.md)
