---
title: Группы доступности для SQL Server на Linux
description: Сведения о характеристиках групп доступности Always On для SQL Server на Linux.
ms.custom: seo-lt-2019
author: VanMSFT
ms.author: vanto
ms.reviewer: vanto
ms.date: 04/17/2019
ms.topic: conceptual
ms.prod: sql
ms.technology: linux
ms.assetid: e37742d4-541c-4d43-9ec7-a5f9b2c0e5d1
ms.openlocfilehash: 7573e1faa9d6cb4bbf75dc4e516da22344523bff
ms.sourcegitcommit: f29f74e04ba9c4d72b9bcc292490f3c076227f7c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/13/2021
ms.locfileid: "98172026"
---
# <a name="always-on-availability-groups-on-linux"></a>Группы доступности Always On на Linux

[!INCLUDE [SQL Server - Linux](../includes/applies-to-version/sql-linux.md)]

В этой статье описываются характеристики групп доступности Always On (групп доступности) при установке [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] на Linux. Здесь рассматриваются также различия между группами доступности на основе отказоустойчивых кластеров Linux и Windows Server (WSFC). См. [документацию на основе Windows](../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md) для получения основных сведений о группах доступности, так как они работают в Windows и Linux одинаково, за исключением WSFC.

С высокоуровневой точки зрения группы доступности с [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] в Linux аналогичны реализациям на основе WSFC. Это означает, что все ограничения и функции одинаковы, за некоторыми исключениями. Ниже приведены основные отличия.

-   Координатор распределенных транзакций Майкрософт (DTC) поддерживается в Linux начиная с версии SQL Server 2017 с накопительным пакетом обновления 16. Однако координатор распределенных транзакций пока не поддерживается в группах доступности в Linux. Если вашим приложениям требуется использование распределенных транзакций и группа доступности, разверните [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] в Windows.
-   В развертываниях на основе Linux, которым требуется высокий уровень доступности, для кластеризации вместо WSFC используется Pacemaker.
-   В отличие от большинства конфигураций групп доступности в Windows, за исключением сценария работы с кластером рабочей группы, для Pacemaker не требуется домен Active Directory Services (AD DS).
-   Переход с одного узла на другой в Linux и Windows различается.
-   Некоторые параметры, такие как `required_synchronized_secondaries_to_commit`, могут быть изменены только через Pacemaker в Linux, в то время как установка на основе WSFC использует Transact-SQL.

## <a name="number-of-replicas-and-cluster-nodes"></a>Число реплик и узлов кластера

Группа доступности в [!INCLUDE[ssstandard-md](../includes/ssstandard-md.md)] может иметь две общие реплики: одну первичную и одну вторичную. Последнюю можно использовать только для обеспечения доступности. Она не может использоваться для чего бы то ни было еще, например для чтения запросов. Группа доступности в [!INCLUDE[ssenterprise-md](../includes/ssenterprise-md.md)] может иметь до девяти реплик: одна основная и до восьми вторичных (включая первичную), из которых до трех могут быть синхронными. При использовании базового кластера общее количество узлов может быть не более 16, если используется Corosync. Группа доступности может охватывать не более девяти узлов из 16 с [!INCLUDE[ssenterprise-md](../includes/ssenterprise-md.md)], и двух — с [!INCLUDE[ssstandard-md](../includes/ssstandard-md.md)].

Конфигурация с двумя репликами, для которой требуется возможность автоматического перехода на другую реплику, требует использования реплики, предназначенной только для конфигурации, как описано в разделе [Реплика и кворум только для конфигурации](#configuration-only-replica-and-quorum). Реплики только для конфигурации были введены в [!INCLUDE[sssql17-md](../includes/sssql17-md.md)] с накопительным обновлением 1 (CU1), поэтому для такой конфигурации это минимальная развертываемая версия.

Если используется Pacemaker, он должен быть правильно настроен, чтобы оставаться работоспособным. Это означает, что кворум и STONITH должны быть правильно реализованы с точки зрения Pacemaker в дополнение к любым требованиям [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)], таким как реплика только для конфигурации.

Доступные для чтения вторичные реплики поддерживаются только в [!INCLUDE[ssenterprise-md](../includes/ssenterprise-md.md)].

## <a name="cluster-type-and-failover-mode"></a>Тип кластера и режим отработки отказа

Новое в [!INCLUDE[sssql17-md](../includes/sssql17-md.md)] — это введение типа кластера для групп доступности. Для Linux существует два допустимых значения: External (внешний) и None (нет). Тип внешнего кластера означает, что Pacemaker будет использоваться в основе группы доступности. Использование режима External для типа кластера требует, чтобы режим отработки отказа был также установлен как внешний (также появился в [!INCLUDE[sssql17-md](../includes/sssql17-md.md)]). Автоматическая отработка отказа поддерживается, но, в отличие от WSFC, при использовании Pacemaker режим отработки отказа устанавливается как External, а не автоматический. В отличие от WSFC, часть группы доступности в Pacemaker создается после настройки группы доступности.

Тип кластера None означает, что никаких требований для группы доступности по наличию Pacemaker нет и он не будет использоваться. Даже на серверах с настроенным Pacemaker, если группа доступности настроена с типом кластера None, Pacemaker не будет видеть эту группу доступности или управлять ею. Тип кластера None поддерживает переход на другой ресурс вручную с первичной на вторичную реплику. Группа доступности, созданная с помощью None, в основном нацелена на сценарии чтения и горизонтального увеличения масштаба, а также на обновления. Хотя она может работать в таких сценариях, как аварийное восстановление или локальная доступность, при которой не требуется автоматическая отработка отказа, использовать ее в таких случаях не рекомендуется. Настройка прослушивателя также будет более сложной без Pacemaker.

Тип кластера хранится в [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]динамическом административном представлении (DMV)`sys.availability_groups` в столбцах `cluster_type` и `cluster_type_desc`.

## <a name="required_synchronized_secondaries_to_commit"></a>required\_synchronized\_secondaries\_to\_commit

В [!INCLUDE[sssql17-md](../includes/sssql17-md.md)] появился параметр групп доступности с именем `required_synchronized_secondaries_to_commit`. Он указывает группе доступности количество вторичных реплик, которые должны быть в локстепе с базой данных-источником. Это позволяет выполнять такие действия, как автоматическая отработка отказа (только при интеграции с Pacemaker с типом внешнего кластера), и управляет поведением базы данных-источника, если нужное число вторичных реплик находится в режиме "в сети" или "вне сети". Подробные сведения см. в разделе [Высокий уровень доступности и защита данных для конфигураций группы доступности](sql-server-linux-availability-group-ha.md). Значение `required_synchronized_secondaries_to_commit` по умолчанию задается и сохраняется в Pacemaker/[!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]. Это значение можно переопределить вручную.

Сочетание `required_synchronized_secondaries_to_commit` и нового порядкового номера (который хранится в `sys.availability_groups`) информирует Pacemaker и [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] о том, например, что может произойти автоматический переход на другой ресурс. В этом случае вторичная реплика будет иметь тот же порядковый номер, что и первичная, то есть все последние сведения о конфигурации будут актуальны.

Для `required_synchronized_secondaries_to_commit` можно задать следующие три значения: 0, 1 или 2. Они управляют поведением в случае, когда реплика становится недоступной. Числа соответствуют количеству вторичных реплик, которые должны быть синхронизированы с базой данных-источником. В Linux это поведение выглядит следующим образом:

-   0 — вторичные реплики необязательно должны находиться в состоянии синхронизации с первичной. Однако если вторичные реплики не синхронизированы, автоматическая отработка отказа не выполняется. 
-   1 — одна вторичная реплика должна находиться в состоянии синхронизации с источником; возможен автоматический переход на другой ресурс. База данных-источник недоступна, пока не будет доступна вторичная синхронная реплика.
-   2 — обе вторичные реплики в трех конфигурациях группы доступности узла или более должны быть синхронизированы с базой данных-источником; возможен автоматический переход на другой ресурс.

`required_synchronized_secondaries_to_commit` управляет не только поведением отработки отказа с помощью синхронных реплик, но и потерей данных. При значении 1 или 2 вторичная реплика всегда должна быть синхронизирована, поэтому всегда будет использоваться избыточность данных. Это означает отсутствие потери данных.

Чтобы изменить значение `required_synchronized_secondaries_to_commit`, используйте следующий синтаксис:

>[!NOTE]
>Изменение значения приводит к перезапуску ресурса, что подразумевает кратковременный простой. Единственный способ избежать этого — временно отменить для ресурса управление кластером.

**Red Hat Enterprise Linux (RHEL) и Ubuntu**

```bash
sudo pcs resource update <AGResourceName> required_synchronized_secondaries_to_commit=<Value>
```

**SUSE Linux Enterprise Server (SLES)**

```bash
sudo crm resource param ms-<AGResourceName> set required_synchronized_secondaries_to_commit <value>
```

где *AGResourceName* — имя ресурса, настроенного для группы доступности, а значение *Value* — 0, 1 или 2. Чтобы восстановить ситуацию по умолчанию, когда Pacemaker управляет этим параметром, выполните ту же инструкцию без значения.

Автоматическая отработка отказа группы доступности возможна, если выполняются следующие условия.

-   Для первичной и вторичной реплики задано синхронное перемещение данных.
-   База данных-получатель синхронизирована (не синхронизируется), что означает, что обе базы находятся в одной и той же точке.
-   Тип кластера установлен как External. Автоматическая отработка отказа невозможна для типа кластера None.
-   Во вторичной реплике, которая станет первичной, `sequence_number` имеет наибольший порядковый номер — иными словами, `sequence_number` вторичной реплики соответствует значению исходной первичной реплики.

Если эти условия выполнены и сервер, на котором размещается первичная реплика, терпит сбой, группа доступности изменит владельца на синхронную реплику. Поведение синхронных реплик (которых может быть всего три: одна первичная и две вторичные реплики) может далее контролироваться с помощью `required_synchronized_secondaries_to_commit`. Это работает с группами доступности как в Windows, так и в Linux, но настраиваются они совершенно по-разному. В Linux значение автоматически настраивается кластером в самом ресурсе группы доступности.

## <a name="configuration-only-replica-and-quorum"></a>Реплика и кворум только для конфигурации

Кроме того, в [!INCLUDE[sssql17-md](../includes/sssql17-md.md)] с версии CU1 появились реплики только для конфигурации. Так как Pacemaker отличается от WSFC, особенно когда дело доходит до кворума и требования STONITH, наличия конфигурации с двумя узлами не будет достаточно, когда дело доходит до группы доступности. Для FCI механизмы кворума, предоставляемые Pacemaker, могут быть достаточны, так как арбитраж при отработке отказа FCI происходит на уровне кластера. Для группы доступности арбитраж в Linux происходит в [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)], где хранятся все метаданные. Именно здесь вступает в дело реплика, предназначенная только для конфигурации.

Без дополнительных мер потребуется третий узел и хотя бы одна синхронизированная реплика. Реплика только для конфигурации сохраняет конфигурацию группы доступности в базе данных master, аналогично другим репликам в конфигурации группы доступности. Реплика только для конфигурации не содержит пользовательские базы данных, участвующие в группе доступности. Данные конфигурации отправляются синхронно из первичной реплики. Эти данные конфигурации затем используются во время отработки отказа независимо от того, автоматическая она или ручная.

Чтобы группа доступности поддерживала кворум и допускала автоматический переход на другой ресурс с типом кластера External, она должна:

-   либо включать три синхронные реплики (только в [!INCLUDE[ssenterprise-md](../includes/ssenterprise-md.md)]);
-   либо иметь две реплики (первичную и вторичную), а также реплику только для конфигурации.

Отработка отказа вручную может происходить при использовании типа кластера External или None для конфигураций группы доступности. Хотя реплика только для конфигурации может быть настроена для группы доступности с типом кластера None, делать так не рекомендуется, так как она усложняет развертывание. Для таких конфигураций вручную измените значение `required_synchronized_secondaries_to_commit` по крайней мере на 1, чтобы существовала хотя бы одна синхронизированная реплика.

Реплика только для конфигурации может размещаться в любом выпуске [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)], включая [!INCLUDE[ssexpress-md](../includes/ssexpress-md.md)]. Это снизит затраты на лицензирование и обеспечит поддержку групп доступности в [!INCLUDE[ssstandard-md](../includes/ssstandard-md.md)]. Это означает, что третьему обязательному серверу достаточно соответствовать минимальной спецификации для [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)], так как он не получает трафик транзакций пользователя для группы доступности.

Если используется реплика только для конфигурации, она реализует следующее поведение.

-   По умолчанию параметр `required_synchronized_secondaries_to_commit` имеет значение 0. При необходимости это значение можно изменить вручную на 1.
-   Если происходит сбой сервера-источника и `required_synchronized_secondaries_to_commit` имеет значение 0, вторичная реплика станет новой базой данных-источником и будет доступна для чтения и записи. Если значение равно 1, произойдет автоматический переход на другой ресурс, но новые транзакции не будут приниматься, пока другая реплика не будет подключена к сети.
-   Если вторичная реплика терпит сбой и `required_synchronized_secondaries_to_commit` имеет значение 0, первичная реплика по-прежнему принимает транзакции, но если на этом этапе происходит сбой первичной, то защиты данных нет и отработка отказа (ручная или автоматическая) невозможна, так как вторичная реплика недоступна.
-   Если реплики только для конфигурации терпят сбой, группа доступности будет работать нормально, но автоматическая отработка отказа невозможна.
-   Если синхронная вторичная реплика и реплика только для конфигурации одновременно терпят сбой, то первичная база данных не может принимать транзакции и нет первичной реплики для отработки отказа.

В CU1 есть известная ошибка в журнале corosync.log, создаваемом с помощью `mssql-server-ha`. Если вторичная реплика не может стать первичной из-за количества требуемых доступных реплик, в текущем сообщении отображается сообщение "Ожидалось получение 1 порядковых номеров, но получен только 2. Недостаточно реплик в сети для безопасного повышения уровня локальной реплики". Номера должны стоять в обратном порядке: "Ожидалось получение 2 порядковых номеров, но получен только 1. Недостаточно реплик в сети для безопасного повышения уровня локальной реплики". 

## <a name="multiple-availability-groups"></a>Множественные группы доступности 

Для каждого кластера или набора серверов Pacemaker можно создать несколько групп доступности. Единственное ограничение — системные ресурсы. Владелец группы доступности отображается в главном экземпляре. Разные группы доступности могут принадлежать разным узлам; они не обязаны выполняться на одном узле.

## <a name="drive-and-folder-location-for-databases"></a>Расположение диска и папки для баз данных

Как и в случае с группами доступности на основе Windows, диск и структура папок для пользовательских баз данных, участвующих в группе доступности, должны быть идентичными. Например, если пользовательские базы данных находятся в `/var/opt/mssql/userdata` на сервере А, то эта папка должна существовать на сервере B. Единственное исключение указано в разделе [Взаимодействие с группами доступности и репликами, основанными на Windows](#interoperability-with-windows-based-availability-groups-and-replicas).

## <a name="the-listener-under-linux"></a>Прослушиватель в Linux

Прослушиватель является необязательным компонентом для группы доступности. Он предоставляет единую точку входа для всех подключений (чтение и запись в первичной реплике или только для чтения на вторичные реплики), чтобы приложениям и конечным пользователям не нужно было знать, на каком сервере размещены данные. В кластере WSFC это сочетание ресурса сетевого имени и ресурса IP, которое затем регистрируется в AD DS (при необходимости), а также в DNS. В сочетании с самим ресурсом AG оно и предоставляет эту абстракцию. Дополнительные сведения см. в разделе [Прослушиватели групп доступности, возможность подключения клиентов и отработка отказа приложений](../database-engine/availability-groups/windows/listeners-client-connectivity-application-failover.md).

Прослушиватель в Linux настраивается иначе, но его функциональные возможности аналогичны. В Pacemaker нет концепции ресурса сетевого имени, а также объекта, созданного в AD DS; в Pacemaker можно создать только ресурс IP-адреса, который может выполняться на любом из узлов. Для прослушивателя в DNS необходимо создать запись с понятным именем, связанную с ресурсом IP. Ресурс IP для прослушивателя будет активным только на сервере, на котором размещается первичная реплика для этой группы доступности.

Если используется Pacemaker и создается ресурс IP-адреса, связанный с прослушивателем, то независимо от того, используется ли автоматическая или ручная отработка отказа, произойдет короткий сбой, так как IP-адрес останавливается на одном сервере и запускается на другом. Хотя это поведение обеспечивает абстракцию через сочетание имени и IP-адреса, оно не маскирует сбой. Приложение должно иметь возможность пережить отключение, предоставляя функциональные возможности для обнаружения этой ситуации и повторного подключения.

Однако сочетания DNS-имени и IP-адреса по-прежнему недостаточно для предоставления всех функций прослушивателя в WSFC, например маршрутизации вторичных реплик только для чтения. При настройке группы доступности в [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] все равно необходимо настроить прослушиватель. Это можно сделать в мастере, а также в синтаксисе Transact-SQL. Существует два способа настройки этого поведения так же, как в Windows:

-   Для группы доступности с типом внешнего кластера IP-адрес, связанный с прослушивателем, созданным в [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)], должен быть IP-адресом ресурса, созданного в Pacemaker.
-   Для группы доступности, созданной с типом кластера None, используйте IP-адрес, связанный с первичной репликой.

Экземпляр, связанный с предоставленным IP-адресом, преобразуется в координатор для таких событий, как запросы маршрутизации только для чтения из приложений.

## <a name="interoperability-with-windows-based-availability-groups-and-replicas"></a>Взаимодействие с группами доступности и репликами, основанными на Windows 

Группа доступности, имеющая тип кластера External или WSFC, не может располагать свои реплики на разных платформах. Это верно как для групп доступности [!INCLUDE[ssstandard-md](../includes/ssstandard-md.md)], так и для [!INCLUDE[ssenterprise-md](../includes/ssenterprise-md.md)]. Это означает, что в традиционной конфигурации группы доступности с базовым кластером одна реплика не может находиться в WSFC, а другая — в Linux с Pacemaker.

Группа доступности с типом кластера None может сочетать реплики между разными операционными системами, поэтому в одной группе доступности могут присутствовать реплики на основе Linux и Windows. Пример показан здесь, где первичная реплика основана на Windows, а база данных-получатель — на одном из дистрибутивов Linux.

![Гибридный режим None](./media/sql-server-linux-availability-group-overview/image1.png)

Распределенная группа доступности может также пересекать границы ОС. Базовые группы доступности связаны правилами, определяющими, как они настраиваются, например, одна может быть настроена как External только с Linux, но группа доступности, к которой она присоединена, может быть настроена как WSFC. Рассмотрим следующий пример:

![Гибридная распределенная группа доступности](./media/sql-server-linux-availability-group-overview/image2.png)

<!-- Distributed AGs are also supported for upgrades from [!INCLUDE[sssql15-md](../includes/sssql16-md.md)] to [!INCLUDE[sssql17-md](../includes/sssql17-md.md)]. For more information on how to achieve this, see [the article "x"].

If using automatic seeding with a distributed availability group that crosses OSes, it can handle the differences in folder structure. How this works is described in [the documentation for automatic seeding].
-->
 
## <a name="next-steps"></a>Дальнейшие действия
[Настройка группы доступности для SQL Server на Linux](sql-server-linux-availability-group-configure-ha.md)

[Настройка группы доступности для чтения и масштабирования в SQL Server на Linux](sql-server-linux-availability-group-configure-rs.md)

[Добавление ресурса кластера группы доступности в RHEL](sql-server-linux-availability-group-cluster-rhel.md)

[Добавление ресурса кластера группы доступности в SLES](sql-server-linux-availability-group-cluster-sles.md)

[Добавление ресурса кластера группы доступности в Ubuntu](sql-server-linux-availability-group-cluster-ubuntu.md)

[Настройка кроссплатформенной группы доступности](sql-server-linux-availability-group-cross-platform.md)

