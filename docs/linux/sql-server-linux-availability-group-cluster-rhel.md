---
title: RHEL. Настройка группы доступности для SQL Server на Linux
description: Узнайте, как настроить группу доступности при запуске Red Hat Enterprise Linux (RHEL) для SQL Server.
ms.custom: seo-lt-2019
author: VanMSFT
ms.author: vanto
ms.reviewer: vanto
ms.date: 01/23/2020
ms.topic: conceptual
ms.prod: sql
ms.technology: linux
ms.assetid: b7102919-878b-4c08-a8c3-8500b7b42397
ms.openlocfilehash: 2790bbe9eb648a2d599d1b0bad8f514ab72eda50
ms.sourcegitcommit: 917df4ffd22e4a229af7dc481dcce3ebba0aa4d7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/10/2021
ms.locfileid: "100338378"
---
# <a name="configure-rhel-cluster-for-sql-server-availability-group"></a>Настройка кластера RHEL для группы доступности SQL Server

[!INCLUDE [SQL Server - Linux](../includes/applies-to-version/sql-linux.md)]

Этот документ описывает, как создать кластер группы доступности с тремя узлами для SQL Server на Red Hat Enterprise Linux. Для обеспечения высокого уровня доступности группе доступности в Linux требуется три узла — см. статью [Высокий уровень доступности и защита данных для конфигураций групп доступности](sql-server-linux-availability-group-ha.md). Уровень кластеризации основан на [надстройке высокого уровня доступности](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/pdf/High_Availability_Add-On_Overview/Red_Hat_Enterprise_Linux-6-High_Availability_Add-On_Overview-en-US.pdf) Red Hat Enterprise Linux (RHEL), созданной на базе [Pacemaker](https://clusterlabs.org/). 

> [!NOTE] 
> Для доступа к полной документации по Red Hat требуется действительная подписка. 

Дополнительные сведения о конфигурации кластера, параметрах агентов ресурсов и управлении см. в [справочной документации по RHEL](https://access.redhat.com/documentation/Red_Hat_Enterprise_Linux/7/html/High_Availability_Add-On_Reference/index.html).

> [!NOTE] 
> SQL Server интегрирован с Pacemaker в Linux не так тесно, как с отказоустойчивой кластеризацией Windows Server. Экземпляр SQL Server не располагает сведениями о кластере. Pacemaker обеспечивает оркестрацию ресурсов кластера. Кроме того, имя виртуальной сети относится только к отказоустойчивой кластеризации Windows Server, в Pacemaker его эквивалент отсутствует. Динамические административные представления группы доступности, запрашивающие сведения о кластере, возвращают пустые строки для кластеров Pacemaker. Чтобы создать прослушиватель для прозрачного переподключения после отработки отказа, вручную зарегистрируйте имя прослушивателя в DNS с IP, использованным для создания ресурса виртуального IP-адреса. 

В следующих разделах описаны шаги по настройке кластера Pacemaker и добавлению группы доступности в качестве ресурса в кластер для обеспечения высокой доступности.

## <a name="roadmap"></a>Схема действий

Действия по созданию группы доступности на серверах Linux для обеспечения высокой доступности отличаются от действий, выполняемых в отказоустойчивом кластере Windows Server. Ниже описывается общий порядок действий. 

1. [Настройте SQL Server в узлах кластера](sql-server-linux-setup.md).

2. [Создайте группу доступности](sql-server-linux-availability-group-configure-ha.md). 

3. Настройте диспетчер ресурсов кластера, например Pacemaker. Эти инструкции приведены в этом документе.
   
   Способ настройки диспетчера ресурсов кластера зависит от конкретного дистрибутива Linux. 

   >[!IMPORTANT]
   >Для обеспечения высокого уровня доступности в рабочих средах требуется агент ограждения, например STONITH. В примерах в этой документации агенты ограждения не используются. Примеры приводятся только для тестирования и проверки.
   
   >Кластер Linux использует ограждение для возврата кластера в известное состояние. Способ настройки ограждения зависит от дистрибутива и среды. Сейчас ограждение недоступно в некоторых облачных средах. Дополнительные сведения см. в статье о [политиках поддержки для кластеров RHEL с высоким уровнем доступности на платформах виртуализации](https://access.redhat.com/articles/29440).

4. [Добавьте группу доступности в виде ресурса в кластере](sql-server-linux-availability-group-cluster-rhel.md#create-availability-group-resource).  

## <a name="configure-high-availability-for-rhel"></a>Настройка высокой доступности для RHEL

Чтобы настроить высокую доступность для RHEL, включите подписку высокой доступности, а затем настройте Pacemaker.

### <a name="enable-the-high-availability-subscription-for-rhel"></a>Включение подписки высокой доступности для RHEL

Каждый узел в кластере должен иметь соответствующую подписку для RHEL и надстройку высокой доступности. Ознакомьтесь с требованиями в статье [Установка пакетов кластера высокой доступности в Red Hat Enterprise Linux](https://access.redhat.com/solutions/45930). Выполните следующие действия, чтобы настроить подписку и репозитории.

1. Зарегистрируйте систему.

   ```bash
   sudo subscription-manager register
   ```

   Укажите имя пользователя и пароль.   

1. Перечислите доступные пулы для регистрации.

   ```bash
   sudo subscription-manager list --available
   ```

   В списке доступных пулов запишите идентификатор пула для подписки высокой доступности.

1. Измените приведенный ниже скрипт. Замените `<pool id>` идентификатором пула для высокой доступности из предыдущего шага. Запустите скрипт, чтобы подключить подписку.

   ```bash
   sudo subscription-manager attach --pool=<pool id>
   ```

1. Включите репозиторий.

   **RHEL 7**

   ```bash
   sudo subscription-manager repos --enable=rhel-ha-for-rhel-7-server-rpms
   ```

   **RHEL 8**

   ```bash
   sudo subscription-manager repos --enable=rhel-8-for-x86_64-highavailability-rpms
   ```

Дополнительные сведения см. в статье [Pacemaker — кластер с открытым исходным кодом и высокой доступностью](https://clusterlabs.org/pacemaker/). 

После настройки подписки выполните следующие действия, чтобы настроить Pacemaker.

### <a name="configure-pacemaker"></a>Настройка Pacemaker

После регистрации подписки выполните следующие действия, чтобы настроить Pacemaker.
   
[!INCLUDE [RHEL-Configure-Pacemaker](../includes/ss-linux-cluster-pacemaker-configure-rhel.md)]

После настройки Pacemaker используйте `pcs` для взаимодействия с кластером. Выполните все команды на одном узле из кластера. 

## <a name="configure-fencing-stonith"></a>Настройка ограждения (STONITH)

Поставщики кластера Pacemaker требуют, чтобы STONITH был включен, а устройство ограждения настроено для поддерживаемой установки кластера. STONITH расшифровывается как "застрелить другой узел". Если диспетчер ресурсов кластера не может определить состояние узла или ресурса на нем, ограждение переводит кластер в известное состояние.

Устройство STONITH предоставляет агент ограждения. В статье [Настройка кластера Pacemaker в Red Hat Enterprise Linux в Azure](/azure/virtual-machines/workloads/sap/high-availability-guide-rhel-pacemaker/#1-create-the-stonith-devices) приводится пример создания устройства STONITH для этого кластера в Azure. Измените инструкции для своей среды.

Ограждение на уровне ресурсов гарантирует отсутствие повреждений данных в случае сбоя за счет настройки ресурса. Например, вы можете использовать ограждение на уровне ресурсов, чтобы пометить диск на узле как устаревший при отключении канала связи. 

Ограждение на уровне узлов гарантирует, что в узле не выполняются никакие ресурсы. Это осуществляется путем сброса узла. Pacemaker поддерживает множество разных устройств ограждения, например источник бесперебойного питания или карты интерфейса управления для серверов.

Дополнительные сведения о STONITH и ограждении см. в следующих статьях.

* [Кластеры Pacemaker с нуля](https://clusterlabs.org/pacemaker/doc/en-US/Pacemaker/1.1/html/Clusters_from_Scratch/index.html)
* [Ограждение и STONITH](https://clusterlabs.org/doc/crm_fencing.html)
* [Надстройка высокой доступности Red Hat с Pacemaker: ограждение](https://access.redhat.com/documentation/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/ch-fencing-HAAR.html)

>[!NOTE]
>Так как конфигурация ограждения на уровне узлов сильно зависит от вашей среды, отключите ее для этого руководства (ее можно настроить позже). Следующий скрипт отключает ограждение на уровне узла.
>
>```bash
>sudo pcs property set stonith-enabled=false
>``` 
>
>Отключение STONITH выполняется только в целях тестирования. Если вы планируете использовать Pacemaker в рабочей среде, следует спланировать реализацию STONITH с учетом особенностей среды и поддерживать ее в рабочем состоянии.

## <a name="set-cluster-property-cluster-recheck-interval"></a>Задание свойства кластера cluster-recheck-interval

`cluster-recheck-interval` указывает интервал опроса, с которым кластер проверяет наличие изменений в параметрах ресурсов, ограничениях или других параметрах кластера. Если реплика выходит из строя, кластер пытается перезапустить ее с интервалом, который связан со значениями `failure-timeout` и `cluster-recheck-interval`. Например, если для `failure-timeout` установлено значение 60 с, а для `cluster-recheck-interval` — 120 с, то повторная попытка перезапуска предпринимается с интервалом, который больше 60 с, но меньше 120 с. Мы рекомендуем установить для failure-timeout значение, равное 60 с, а для cluster-recheck-interval значение больше 60 с. Задавать для cluster-recheck-interval небольшое значение не рекомендуется.

Чтобы изменить значение свойства на `2 minutes`, выполните следующую команду:

```bash
sudo pcs property set cluster-recheck-interval=2min
```

> [!IMPORTANT] 
> Все дистрибутивы (включая RHEL 7.3 и 7.4), использующие последний доступный пакет Pacemaker 1.1.18-11.el7, вносят изменение в поведение для параметра start-failure-is-fatal cluster, когда его значение равно false. Это изменение влияет на рабочий процесс отработки отказа. В случае сбоя первичной реплики ожидается, что будет выполнена отработка отказа кластера на одну из доступных вторичных реплик. Вместо этого пользователи увидят, что кластер продолжает попытки запустить первичную реплику с ошибкой. Если первичная реплика не включается (из-за постоянного сбоя), кластер не выполняет отработку отказа на другую доступную вторичную реплику. Из-за этого изменения рекомендуемая ранее конфигурация для установки параметра start-failure-is-fatal больше не действительна, и для этого параметра нужно вернуть значение по умолчанию `true`. Кроме того, нужно обновить ресурс группы доступности для включения свойства `failover-timeout`. 

Чтобы изменить значение свойства на `true`, выполните следующую команду:

```bash
sudo pcs property set start-failure-is-fatal=true
```

Чтобы изменить значение свойства `failure-timeout` ресурса `ag_cluster` на `60s`, выполните следующую команду.

```bash
pcs resource update ag_cluster meta failure-timeout=60s
```


Сведения о свойствах кластера Pacemaker см. в статье [Свойства кластеров Pacemaker](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/High_Availability_Add-On_Reference/ch-clusteropts-HAAR.html).

## <a name="create-a-sql-server-login-for-pacemaker"></a>Создание учетных данных SQL Server для Pacemaker

[!INCLUDE [SQL-Create-SQL-Login](../includes/ss-linux-cluster-pacemaker-create-login.md)]

## <a name="create-availability-group-resource"></a>Создание ресурса группы доступности

Чтобы создать ресурс группы доступности, используйте команду `pcs resource create` и задайте свойства ресурса. Приведенная ниже команда `ocf:mssql:ag` создает ресурс типа «основной/подчиненный» для группы доступности `ag1`.

**RHEL 7**

```bash
sudo pcs resource create ag_cluster ocf:mssql:ag ag_name=ag1 meta failure-timeout=60s master notify=true
```

**RHEL 8**

С выходом **RHEL 8** был изменен синтаксис Create. Если вы используете **RHEL 8**, терминология `master` изменилась на `promotable`. Используйте следующую команду Create вместо приведенной выше команды: 

```bash
sudo pcs resource create ag_cluster ocf:mssql:ag ag_name=ag1 meta failure-timeout=60s promotable notify=true
```

[!INCLUDE [required-synchronized-secondaries-default](../includes/ss-linux-cluster-required-synchronized-secondaries-default.md)]

<a name="createIP"></a>

## <a name="create-virtual-ip-resource"></a>Создание ресурса виртуального IP-адреса

Чтобы создать ресурс виртуального IP-адреса, выполните указанную ниже команду на одном узле. Используйте доступный статический IP-адрес из сети. Замените IP-адрес между `<10.128.16.240>` на допустимый IP-адрес.

```bash
sudo pcs resource create virtualip ocf:heartbeat:IPaddr2 ip=<10.128.16.240>
```

В Pacemaker эквивалент имени виртуального сервера отсутствует. Чтобы использовать строку подключения, указывающую на строковое имя сервера, вместо IP-адреса, зарегистрируйте виртуальный IP-адрес ресурса и требуемое имя виртуального сервера в DNS. Для конфигураций аварийного восстановления зарегистрируйте имя и IP-адрес нужного виртуального сервера на DNS-серверах на основном сайте и сайте аварийного восстановления.

## <a name="add-colocation-constraint"></a>Добавление ограничения совместного размещения

Почти каждое решение в кластере Pacemaker, например выбор места запуска ресурса, принимается путем сравнения оценок. Оценки вычисляются для каждого ресурса. Диспетчер кластерных ресурсов выбирает узел с наивысшей оценкой для конкретного ресурса. Если узел имеет отрицательную оценку для ресурса, последний не может выполняться на этом узле.

В кластере Pacemaker можно управлять решениями для кластера с помощью ограничений. Ограничения имеют оценку. Если ограничение имеет оценку меньше `INFINITY`, Pacemaker считает его рекомендацией. Оценка, равная `INFINITY`, указывает на обязательный характер.

Чтобы убедиться, что первичная реплика и ресурсы виртуального IP-адреса выполняются на одном узле, определите ограничение совместного размещения с оценкой INFINITY. Чтобы добавить ограничение совместного размещения, выполните приведенную ниже команду на одном узле.

### <a name="rhel-7"></a>RHEL 7

При создании ресурса `ag_cluster` в RHEL 7 он создает ресурс как `ag_cluster-master`. Используйте следующий формат команды в RHEL 7:

```bash
sudo pcs constraint colocation add virtualip ag_cluster-master INFINITY with-rsc-role=Master
```

### <a name="rhel-8"></a>RHEL 8

При создании ресурса `ag_cluster` в RHEL 8 он создает ресурс как `ag_cluster-clone`. Используйте следующий формат команды в RHEL 8:

```bash
sudo pcs constraint colocation add virtualip with master ag_cluster-clone INFINITY with-rsc-role=Master
```

## <a name="add-ordering-constraint"></a>Добавление ограничения упорядочения

Ограничение совместного размещения имеет неявное ограничение упорядочения. Оно перемещает ресурс виртуального IP-адреса перед перемещением ресурса группы доступности. Последовательность событий по умолчанию:

1. Пользователь выполняет команду `pcs resource move` с узла node1 на узел node2 для первичной реплики группы доступности.
1. Ресурс виртуального IP-адреса останавливается в узле 1.
1. Ресурс виртуального IP-адреса запускается в узле 2.
  
   >[!NOTE]
   >На этом этапе IP-адрес временно указывает на узел 2, пока узел 2 все еще является вторичной репликой перед отработкой отказа. 
   
1. Первичная реплика группы доступности на узле 1 понижается до вторичной.
1. Вторичная реплика группы доступности на узле 2 повышается до первичной. 

Чтобы предотвратить ситуацию, когда IP-адрес временно указывает на узел с вторичной репликой перед отработкой отказа, добавьте ограничение упорядочения. 

Чтобы добавить ограничение упорядочения, выполните приведенную ниже команду в одном узле.

### <a name="rhel-7"></a>RHEL 7

```bash
sudo pcs constraint order promote ag_cluster-master then start virtualip
```

### <a name="rhel-8"></a>RHEL 8

```bash
sudo pcs constraint order promote ag_cluster-clone then start virtualip
```

>[!IMPORTANT]
>После настройки кластера и добавления группы доступности в качестве ресурса кластера вы не можете использовать Transact-SQL для отработки отказа ресурсов группы доступности. Ресурсы кластера SQL Server в Linux не так сильно зависят от операционной системы, как если бы они находились в отказоустойчивом кластере Windows Server (WSFC). Служба SQL Server не имеет сведений о наличии кластера. Вся оркестрация осуществляется с помощью средств управления кластерами. В RHEL или Ubuntu используйте `pcs`, а в SLES — `crm`. 

Вручную выполните отработку отказа группы доступности с помощью `pcs`. Не инициируйте отработку отказа с помощью Transact-SQL. Инструкции см. в статье [Отработка отказа](sql-server-linux-availability-group-failover-ha.md#failover).

## <a name="next-steps"></a>Дальнейшие действия

[Использование высокодоступной группы доступности](sql-server-linux-availability-group-failover-ha.md)
