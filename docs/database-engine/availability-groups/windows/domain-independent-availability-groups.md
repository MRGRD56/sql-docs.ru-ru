---
title: Создание группы доступности, независимой от домена
description: Инструкции по созданию группы доступности, использующей кластер рабочей группы. Позволяет SQL Server 2016 (и более поздних версий) развернуть группу доступности Always On в отказоустойчивом кластере Windows Server, которому не требуются доменные службы Active Directory, вследствие чего не нужно, чтобы каждый сервер входил в один и тот же домен.
ms.custom: seodec18
ms.date: 09/25/2017
ms.prod: sql
ms.reviewer: ''
ms.technology: high-availability
ms.topic: how-to
helpviewer_keywords:
- Availability Groups [SQL Server], domain independent
ms.assetid: ''
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: a0bcf32babdb30c59a43305edffd3f1718354ac0
ms.sourcegitcommit: c7f40918dc3ecdb0ed2ef5c237a3996cb4cd268d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/05/2020
ms.locfileid: "91727897"
---
# <a name="create-a-domain-independent-availability-group"></a>Создание группы доступности, независимой от домена
[!INCLUDE [SQL Server](../../../includes/applies-to-version/sqlserver.md)]

Группы доступности AlwaysOn должны находиться в отказоустойчивом кластере Windows Server (WSFC). Развертывание WSFC с помощью Windows Server 2012 R2 всегда требует, чтобы серверы, участвующие в WSFC (также называются узлами), были присоединены к одному и тому же домену. Дополнительные сведения о доменных службах Active Directory (AD DS) см. [здесь](/previous-versions/windows/it-pro/windows-server-2003/cc759073(v=ws.10)).

Зависимость от AD DS и WSFC имеет более комплексный характер, чем в развернутой ранее конфигурации зеркального отображения базы данных, поскольку зеркальное отображение базы данных может быть развернуто сразу в нескольких центрах обработки данных с сертификатами без подобной зависимости.  Традиционная группа доступности, охватывающая больше одного центра обработки данных, требует, чтобы все серверы были присоединены к одному и тому же домену Active Directory — разные домены не будут работать, даже если они доверенные. Все серверы должны быть узлами одного и того же кластера WSFC. Данная конфигурация показана на следующем рисунке. В SQL Server 2016 имеются также распределенные группы доступности, решающие эту задачу иначе.


![WSFC с двумя центрами обработки данных, подключенными к одному и тому же домену][1]

В Windows Server 2012 R2 появился [кластер, отсоединенный от Active Directory](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn265970(v=ws.11)) и представляющий собой особый вид отказоустойчивого кластера Windows Server, который можно использовать с группами доступности. Этот тип WSFC также требует, чтобы узлы, которые должны присоединяться к домену, были присоединены к одному и тому же домену Active Directory, однако в данном случае WSFC использует DNS, но не использует домен. Поскольку домен здесь также имеет значение, кластер, отсоединенный от Active Directory, все еще не позволяет работать независимо от домена.

В Windows Server 2016 появился новый тип отказоустойчивого кластера, основанный на кластере, отсоединенном от Active Directory, — кластере рабочей группы. Кластер рабочей группы позволяет SQL Server 2016 развернуть группу доступности в WSFC, которому не требуется AD DS. SQL Server требует использования сертификатов для защиты конечных точек точно так же, как сценарии зеркального отражения базы данных.  Этот тип группы доступности называется группой доступности, независимой от домена. Развертывание группы доступности на базе кластера рабочей группы поддерживает следующие комбинации узлов, составляющих WSFC:
- Ни один из узлов не присоединен к домену.
- Все узлы присоединены к разным доменам.
- Смешанные узлы — одни из них подключены к домену, другие нет.

Ниже показан пример независимой от домена группы доступности, в которой узлы в центре обработки данных 1 присоединены к домену, а узлы в центре обработки данных 2 используют только DNS. В этом случае задайте DNS-суффикс на всех серверах, которые будут служить узлами WSFC. Каждое приложение и сервер, которые обращаются к группе доступности, должны получать одни и те же данные DNS.


![Кластер рабочей группы с двумя узлами, присоединенными к домену][2]

Группу доступности, независимую от домена, можно использовать не только в многосайтовом развертывании или в сценариях аварийного восстановления. Ее можно развернуть в одном-единственном центре обработки данных, а также использовать с[основной группой доступности](basic-availability-groups-always-on-availability-groups.md) (так называемой группой доступности Standard Edition) для получения такой же архитектуры, которая раньше достигалась путем зеркального отображения базы данных с использованием сертификатов.


![Высокоуровневое представление группы доступности в выпуске Standard Edition][3]

При развертывании группы доступности, независимой от домена, следует учитывать несколько моментов:
- Для установки кворума можно использовать только такие типы свидетелей, как диск и [облако](/windows-server/failover-clustering/deploy-cloud-witness). Эта возможность появилась только в Windows Server 2016. Диск создает проблемы, поскольку общие диски для группы доступности, как правило, не подходят.
- Базовый кластер рабочей группы WSFC можно создать только с помощью PowerShell, а для последующего управления этим кластером можно использовать диспетчер отказоустойчивости кластеров.
- Если требуется Kerberos, необходимо развернуть стандартный WSFC, присоединенный к домену Active Directory, а значит, группа доступности, независимая от домена, в данном случае не подходит.
- Несмотря на то, что прослушиватель доступен для настройки, его можно будет использовать только после регистрации в DNS. Как указано выше, для прослушивателя Kerberos не поддерживается.
- Приложения, которые подключаются к SQL Server, должны в первую очередь использовать проверку подлинности SQL Server, поскольку домены могут быть не настроены для совместной работы или не существовать. 
- В конфигурации группы доступности будут использоваться сертификаты.

## <a name="set-and-verify-the-dns-suffix-on-all-replica-servers"></a>Задание и проверка DNS-суффикса на всех серверах-репликах

Для кластера рабочей группы в группе доступности, независимой от домена, требуется общий DNS-суффикс. Чтобы задать и проверить DNS-суффикс на каждом сервере Windows, где будет размещаться реплика группы доступности, выполните следующие действия:

1. С помощью комбинации клавиш Windows+X выберите пункт "Система".
2. Если имя компьютера и полное имя компьютера совпадают, значит, DNS-суффикс не задан. Например, если компьютер имеет имя ALLAN, полное имя этого компьютера должно быть другим (не ALLAN). Оно должно иметь вид ALLAN.SQLHA.LAB. SQLHA.LAB — это DNS-суффикс. Для рабочей группы должно быть указано значение WORKGROUP. Если вам нужно задать DNS-суффикс, выберите пункт "Изменить параметры".
3. В диалоговом окне "Системные свойства" нажмите кнопку "Изменить" на вкладке "Имя компьютера".
4. В диалоговом окне "Изменение имени компьютера или домена" нажмите кнопку "Дополнительно".
5. В диалоговом окне "DNS-суффикс и NetBIOS-имя компьютера" введите в качестве основного DNS-суффикса общий DNS-суффикс. 
6. Нажмите кнопку "ОК", чтобы закрыть диалоговое окно "DNS-суффикс и NetBIOS-имя компьютера".
7. Нажмите кнопку "ОК", чтобы закрыть диалоговое окно "Изменение имени компьютера или домена".
8. Вам будет предложено перезагрузить сервер, чтобы изменения вступили в силу. Нажмите кнопку "ОК", чтобы закрыть диалоговое окно "Изменение имени компьютера или домена".
9. Нажмите кнопку "Закрыть", чтобы закрыть окно "Системные свойства".
10. Вам будет предложено перезагрузить компьютер. Если вы не хотите выполнять перезагрузку компьютера незамедлительно, нажмите кнопку "Перезагрузить позже"; в противном случае нажмите кнопку "Перезагрузить сейчас".
11. После перезагрузки сервера откройте диалоговое окно "Система" еще раз и убедитесь, что общий DNS-суффикс настроен.

![Успешная настройка DNS-суффикса][4]

  > [!NOTE]
  > Если вы используете несколько подсетей и статический DNS, вам нужно обновить запись DNS, связанную с прослушивателем, прежде чем выполнять отработку отказа, иначе имя сети не будет предоставляться через Интернет.

## <a name="create-a-domain-independent-availability-group"></a>Создание группы доступности, независимой от домена

На данный момент создать группу доступности, независимую от домена, используя только SQL Server Management Studio, нельзя. Несмотря на то, что создание группы доступности, независимой от домена, практически не отличается от создания обычной группы доступности, некоторые действия (например, создание сертификатов) можно выполнить только с помощью Transact-SQL. Приведенный ниже пример предполагает конфигурацию группы доступности с двумя репликами — одной первичной и одной вторичной. 

1. [С помощью инструкций, указанных по этой ссылке](https://techcommunity.microsoft.com/t5/Failover-Clustering/Workgroup-and-Multi-domain-clusters-in-Windows-Server-2016/ba-p/372059), разверните кластер рабочей группы, состоящий из всех серверов, которые будут участвовать в группе доступности. Перед настройкой кластера рабочей группы убедитесь, что общий DNS-суффикс уже настроен.
2. [Включите функцию "Группы доступности AlwaysOn"](./enable-and-disable-always-on-availability-groups-sql-server.md) на каждом экземпляре, который будет участвовать в группе доступности. Для этого каждый экземпляр SQL Server нужно будет перезапустить.
3. Каждому экземпляру, где будет размещаться первичная реплика, требуется главный ключ базы данных. Если главный ключ еще не существует, выполните следующую команду:

   ```sql
   CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'Strong Password';
   GO
   ```

4. На том экземпляре, где будет размещаться первичная реплика, создайте сертификат, который будет использоваться как для входящих подключений во вторичных репликах, так и для защиты конечной точки в первичной реплике.

   ```sql
   CREATE CERTIFICATE InstanceA_Cert 
   WITH SUBJECT = 'InstanceA Certificate';
   GO
   ``` 

5. Создайте резервную копию сертификата. При желании защиту можно укрепить с помощью закрытого ключа. В этом примере закрытый ключ не используется.

   ```sql
   BACKUP CERTIFICATE InstanceA_Cert 
   TO FILE = 'Backup_path\InstanceA_Cert.cer';
   GO
   ```

6. Повторите шаги 4 и 5, чтобы создать сертификаты и их резервные копии для каждой вторичной реплики, указав для сертификатов соответствующие имена, например InstanceB_Cert.
7. В первичной реплике необходимо создать имя входа для каждой вторичной реплики группы доступности. Этому имени входа будут предоставлены разрешения для подключения к конечной точке, используемой группой доступности, независимой от домена. В этом примере для реплики с именем InstanceB:

   ```sql
   CREATE LOGIN InstanceB_Login WITH PASSWORD = 'Strong Password';
   GO
   ```

8. В каждой вторичной реплике создайте имя входа для первичной реплики. Этому имени входа будут предоставлены разрешения для подключения к конечной точке. В этом примере в реплике с именем InstanceB:

   ```sql
   CREATE LOGIN InstanceA_Login WITH PASSWORD = 'Strong Password';
   GO
   ```

9. На всех экземплярах создайте пользователя для каждого созданного имени входа. Он будет использоваться при восстановлении сертификатов. Например, чтобы создать пользователя для первичной реплики, выполните следующие действия:

   ```sql
   CREATE USER InstanceA_User FOR LOGIN InstanceA_Login;
   GO
   ```

10. Для любой реплики, которая может быть основной, создайте имя входа и пользователя во всех соответствующих вторичных репликах.
11. На каждом экземпляре восстановите сертификаты для других экземпляров, в которых вы создали имя входа и пользователя. В первичной реплике восстановите все сертификаты вторичных реплик. В каждой вторичной реплике восстановите сертификат первичной реплики, а также выполните это действие в любой другой реплике, которая может служить первичной. Пример:

   ```sql
   CREATE CERTIFICATE [InstanceB_Cert]
   AUTHORIZATION InstanceB_User
   FROM FILE = 'Restore_path\InstanceB_Cert.cer'
   ```

12. Создайте конечную точку, которая будет использоваться группой доступности в каждом экземпляре, выступающем в качестве реплики. Для групп доступности конечная точка должна иметь тип DATABASE_MIRRORING. Конечная точка использует для проверки подлинности сертификат, созданный для этого экземпляра при выполнении шага 4. Ниже представлен синтаксис для создания конечной точки с применением сертификата. Выберите соответствующий метод шифрования и другие параметры, относящиеся к вашей среде. Дополнительные сведения о доступных параметрах см. в статье [СОЗДАНИЕ КОНЕЧНОЙ ТОЧКИ (Transact-SQL)](../../../t-sql/statements/create-endpoint-transact-sql.md).

   ```sql
   CREATE ENDPOINT DIAG_EP
   STATE = STARTED
   AS TCP (   
    LISTENER_PORT = 5022,
    LISTENER_IP = ALL
         )
   FOR DATABASE_MIRRORING (
    AUTHENTICATION = CERTIFICATE InstanceX_Cert,
    ROLE = ALL
         )
   ```

13. Назначьте каждому пользователю, созданному в этом экземпляре при выполнении шага 9, права, необходимые для подключения к конечной точке. 

   ```sql
   GRANT CONNECT ON ENDPOINT::DIAG_EP TO [InstanceX_User];
   GO
   ```

14. После настройки базовых сертификатов и защиты конечной точки создайте группу доступности любым удобным способом. Рекомендуем создать резервную копию, скопировать ее и применить для инициализации вторичной реплики вручную либо воспользоваться [автоматическим заполнением](automatically-initialize-always-on-availability-group.md). Инициализация вторичных реплик с помощью мастера предполагает обращение к файлам SMB, что может не сработать при использовании кластера рабочей группы, не присоединенного к домену.
15. При создании прослушивателя убедитесь, что его имя и IP-адрес зарегистрированы в DNS.

### <a name="next-steps"></a>Дальнейшие действия 

- [Использование мастера добавления базы данных в группу доступности (среда SQL Server Management Studio)](use-the-availability-group-wizard-sql-server-management-studio.md)

- [Использование диалогового окна "Создание группы доступности" (SQL Server Management Studio)](use-the-new-availability-group-dialog-box-sql-server-management-studio.md)
 
- [Создание группы доступности с помощью Transact-SQL](create-an-availability-group-transact-sql.md)

<!--Image references-->
[1]: ./media/diag-wsfc-two-data-centers-same-domain.png
[2]: ./media/diag-workgroup-cluster-two-nodes-joined.png
[3]: ./media/diag-high-level-view-ag-standard-edition.png
[4]: ./media/diag-successful-dns-suffix.png