---
title: Улучшенная отработка отказа для группы доступности
description: Инструкции по включению улучшенной отработки отказа базы данных, которая инициируется, если база данных в группе доступности Always On больше не может записывать транзакции.
ms.custom: seodec18
ms.date: 06/03/2020
ms.prod: sql
ms.technology: availability-groups
ms.topic: conceptual
helpviewer_keywords:
- Availability Groups [SQL Server], enhanced database failover
- Availability Groups [SQL Server], failover
ms.assetid: ''
author: cawrites
ms.reviewer: mikeray
ms.author: chadam
ms.openlocfilehash: d26d584c4a644d9ff712f7bf1ac5a82e87302f83
ms.sourcegitcommit: 370cab80fba17c15fb0bceed9f80cb099017e000
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/17/2020
ms.locfileid: "97643570"
---
# <a name="enable-enhanced-database-failover-to-a-database-in-an-always-on-availability-group"></a>Включение улучшенной отработки отказа для базы данных в группе доступности Always On
[!INCLUDE [SQL Server](../../../includes/applies-to-version/sqlserver.md)]

В SQL Server 2012 и 2014 в случае, если база данных, участвующая в группе доступности в первичной реплике, теряет возможность записывать транзакции, она не сможет запустить отработку отказа, даже если реплики синхронизированы и настроены на автоматическую отработку отказа.

SQL Server 2016 представляет новую функцию под названием *улучшенная отработка отказа базы данных*, которую можно настроить с помощью мастера или Transact-SQL. Если этот параметр включен, а автоматическая отработка отказа настроена, то в случае, если одна база данных, участвующая в группе доступности, лишится возможности записи транзакций, отработка отказа с переходом на синхронизированную вторичную реплику выполняться не будет.

**Сценарий 1**

Группа доступности настраивается между экземпляром А и экземпляром В, содержащим только одну базу данных с именем DB1. Файл данных DB1 хранится на диске E, а соответствующий журнал транзакций — на диске F. В качестве режима доступности выбрана синхронная фиксация с автоматической отработкой отказа. Новый параметр улучшенной отработки отказа базы данных настраивается в группе доступности. В настоящее время обе реплики находятся в синхронизированном состоянии. Проблема приводит к сбою диска E. Этот сценарий не вызывает улучшенную отработку отказа базы данных, поскольку диск E не содержит журнал транзакций.  

**Сценарий 2**

В данном случае используется такая же конфигурации группы доступности, как и в сценарии 1. Однако в данном случае вместо диска Е сбой возникает на диске F, где хранится журнал транзакций. Это приводит к запуску отработки отказа, поскольку отвечает условиям применения улучшенной отработки отказа базы данных: если журнал транзакций недоступен, значит, база данных не может записывать транзакции.

**Сценарий 3**

Группа доступности настраивается между экземпляром А и экземпляром В, содержащим две базы данных с именами DB1 и DB2. В качестве режима доступности устанавливается синхронная фиксация с автоматическим переходом в режим отработки отказа и активируется улучшенная отработка отказа базы данных. Доступ к диску, содержащему данные DB2 и файлы журнала транзакций, будет утерян. При обнаружении проблемы группа доступности будет автоматически переведена на экземпляр B.

## <a name="configure-enhanced-failover"></a>Настройка расширенной отработки отказа

Улучшенную отработку отказа базы данных можно настроить с помощью SQL Server Management Studio или Transact-SQL. Командлеты PowerShell пока не дают такой возможности. По умолчанию улучшенная отработка отказа базы данных отключена.

### <a name="sql-server-management-studio"></a>SQL Server Management Studio

Улучшенную отработку отказа базы данных можно включить при создании группы доступности с помощью SQL Server Management Studio. После создания группы доступности включить или отключить эту функцию можно только с использованием Transact-SQL.

*Создание группы доступности вручную*

Инструкции по созданию группы доступности см. в статье [Использование диалогового окна "Создание группы доступности" (SQL Server Management Studio)](use-the-new-availability-group-dialog-box-sql-server-management-studio.md). Чтобы включить улучшенную отработку отказа базы данных, установите соответствующий флажок рядом с пунктом *Определение исправности на уровне базы данных*.

*Использование мастера групп доступности*

Инструкции см. в статье [Использование мастера групп доступности (SQL Server Management Studio)](use-the-availability-group-wizard-sql-server-management-studio.md). Включить улучшенную отработку отказа базы данных можно в диалогом окне "Укажите имя группы доступности". Для этого установите флажок рядом с пунктом *Определение исправности на уровне базы данных*.

### <a name="transact-sql"></a>Transact-SQL

Для настройки поведения улучшенной отработки отказа базы во время создания группы доступности необходимо задать для параметра DB_FAILOVER значение ON следующим образом:

```SQL
CREATE AVAILABILITY GROUP [AGNAME]
WITH ( DB_FAILOVER = ON)
...
```
Чтобы добавить это поведение после настройки группы доступности, используйте команду ALTER AVAILABILITY GROUP:
```SQL
ALTER AVAILABILITY GROUP [AGNAME] SET (DB_FAILOVER = ON)
```
Чтобы отключить это поведение, выполните следующую команду ALTER AVAILABILITY GROUP:
```SQL
ALTER AVAILABILITY GROUP [AGNAME] SET (DB_FAILOVER = OFF)
```
### <a name="dynamic-management-view"></a>Динамическое административное представление
Чтобы узнать, включена ли в группе доступности улучшенная отработка отказа базы данных, запросите динамическое административное представление `sys.availability_groups`. Если данная функция отключена, в столбце `db_failover` будет указано значение 0, а если включена — значение 1. 

## <a name="next-steps"></a>Дальнейшие действия 

- [Настройка определения исправности базы данных](sql-server-always-on-database-health-detection-failover-option.md)

- [Использование мастера добавления базы данных в группу доступности (среда SQL Server Management Studio)](use-the-availability-group-wizard-sql-server-management-studio.md)

- [Использование диалогового окна "Создание группы доступности" (SQL Server Management Studio)](use-the-new-availability-group-dialog-box-sql-server-management-studio.md)
 
- [Создание группы доступности с помощью Transact-SQL](create-an-availability-group-transact-sql.md)

