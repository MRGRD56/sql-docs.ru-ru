---
title: Автоматическое заполнение для вторичных реплик
description: Узнайте, как использовать автоматическое заполнение для инициализации вторичных реплик в составе группы доступности Always On в SQL 2016 и более поздних версий.
ms.custom: seo-lt-2019
ms.date: 03/05/2021
ms.prod: sql
ms.reviewer: ''
ms.technology: availability-groups
ms.topic: how-to
helpviewer_keywords:
- Automatic seeding [SQL Server], secondary replica
ms.assetid: ''
author: cawrites
ms.author: chadam
ms.openlocfilehash: aff27fc13795c83ac196a2f4ae431bb6d459bca2
ms.sourcegitcommit: 14f2051d329b69a7b5ff7bce1d136cf7f25bb219
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2021
ms.locfileid: "106232211"
---
# <a name="use-automatic-seeding-to-initialize-a-secondary-replica-for-an-always-on-availability-group"></a>Инициализация вторичной реплики группы доступности Always On с помощью автоматического заполнения
[!INCLUDE [SQL Server](../../../includes/applies-to-version/sqlserver.md)]

В SQL Server 2012 и 2014 единственным способом инициализации вторичной реплики в группе доступности SQL Server Always On является использование операций резервного копирования, копирования и восстановления. В SQL Server 2016 появилась новая функция для инициализации вторичной реплики — *автоматическое заполнение*. Автоматическое заполнение использует транспортный поток журнала для потокового резервного копирования с помощью VDI на вторичную реплику для каждой базы данных группы доступности, применяющую настроенные конечные точки. Эту новую функцию можно использовать во время первоначального создания группы доступности или при добавлении базы данных в группу доступности. Автоматическое заполнение доступно во всех выпусках SQL Server, поддерживающих группы доступности AlwaysOn, и может использоваться как с традиционными группами доступности, так и с [распределенными группами доступности](distributed-availability-groups.md).

## <a name="security"></a>Безопасность

Разрешения безопасности зависят от типа инициализируемой реплики.

* Для традиционной группы доступности разрешения должны быть предоставлены группе доступности на вторичной реплике после ее присоединения к группе доступности. В Transact-SQL используйте команду `ALTER AVAILABILITY GROUP [<AGName>] GRANT CREATE ANY DATABASE`.
* Для распределенной группы доступности, в которой создаваемые базы данных реплики находятся на первичной реплике второй группы доступности, дополнительные разрешения не требуются, так как она уже является первичной.
* Для вторичной реплики во второй группе доступности в составе распределенной группы доступности необходимо использовать команду `ALTER AVAILABILITY GROUP [<2ndAGName>] GRANT CREATE ANY DATABASE`. Эта вторичная реплика будет заполняться данными из первичной реплики второй группы доступности.

## <a name="performance-and-transaction-log-impact-on-the-primary-replica"></a>Влияние производительности и журнала транзакций на первичную реплику

Для инициализации вторичной реплики может быть удобно автоматическое заполнение. Это зависит от размера базы данных, скорости сетевого подключения и расстояния между первичной и вторичной репликами. Например, если учитывать, что:

* размер базы данных составляет 5 ТБ;
* скорость сетевого подключения — 1 Гбит/с;
* расстояние между двумя сайтами — 1600 километров.

Если доступна полная пропускная способность, то сеть со скоростью сетевого подключения 1 Гбит/с может предоставить устойчивую пропускную способность в 125 МБ/с. В этом примере для автоматического заполнения может потребоваться чуть более 11 часов. На практике процесс автоматического заполнения выполняется медленнее, так как на больших расстояниях качество сигнала снижается и канал используется совместно с другими ресурсами в сети. Во время заполнения журнал транзакций в базе данных на первичной реплике продолжает расти. Он не может быть усечен вплоть до завершения автоматического заполнения этой базы данных.  Затем журнал транзакций может быть усечен с помощью резервной копии журнала транзакций.

Автоматическое заполнение является однопоточным процессом, который может обрабатывать до пяти баз данных. Однопоточность влияет на производительность, особенно в том случае, если в группе доступности есть несколько баз данных.

Для автоматического заполнения можно использовать сжатие, но оно отключено по умолчанию. При включении сжатия снижается пропускная способность сети и, возможно, ускоряется процесс, но компромисс достигается за счет издержек на дополнительный процессор. Чтобы использовать сжатие во время автоматического заполнения, установите флаг трассировки 9567 — см. раздел [Настройка сжатия для группы доступности](tune-compression-for-availability-group.md).

## <a name="disk-layout"></a><a name = "disklayout"></a> Разметка диска

В SQL Server 2016 и более ранних версиях папка, в которой будет создана база данных с помощью автоматического заполнения, уже должна существовать, и путь к ней должен совпадать с путем в первичной реплике. 

В SQL Server 2017 корпорация Майкрософт рекомендует использовать одни и те же пути к данным и файлам журналов во всех репликах, входящих в группу доступности. Но при необходимости можно использовать разные пути. Например, в кроссплатформенной группе доступности один экземпляр SQL Server находится в Windows, а другой — в Linux. Пути на различных платформах будут разными. SQL Server 2017 поддерживает реплики группы доступности на экземплярах SQL Server с различными путями по умолчанию.

В следующей таблице представлены примеры разметки диска, которые поддерживают автоматическое заполнение.

|Основной экземпляр</br>Путь к данным по умолчанию|Вторичный экземпляр</br>Путь к данным по умолчанию|Основной экземпляр</br>Расположение исходного файла|Вторичный экземпляр</br> Расположение целевого файла
|:------|:------|:------|:------
|c:\\data\\ |/var/opt/mssql/data/ |c:\\data\\ |/var/opt/mssql/data/|
|c:\\data\\ |/var/opt/mssql/data/ |c:\\data\\group1\\ |/var/opt/mssql/data/group1/|
|c:\\data\\ |d:\\data\\ |c:\\data\\ |d:\\data\\
|c:\\data\\ |d:\\data\\ |c:\\data\\group1\\ |d:\\data\\group1\

Это изменение не влияет на сценарии, в которых расположение баз данных для первичной и вторичной реплики не совпадает с путями для экземпляров по умолчанию. При этом пути к файлам для вторичной реплики по-прежнему должны соответствовать путям к файлам для первичной реплики.

|Основной экземпляр</br>Путь к данным по умолчанию|Вторичный экземпляр</br>Путь к данным по умолчанию|Основной экземпляр</br>Размещение файла|Вторичный экземпляр</br> Размещение файла
|:------|:------|:------|:------
|c:\\data\\ |c:\\data\\ |d:\\group1\\ |d:\\group1\\
|c:\\data\\ |c:\\data\\ |d:\\data\\ |d:\\data\\
|c:\\data\\ |c:\\data\\ |d:\\data\\group1\\ |d:\\data\\group1\\

Если в первичной и вторичной репликах используются как пути по умолчанию, так и отличные от них пути, поведение SQL Server 2017 будет отличаться от поведения предыдущих выпусков. Поведение SQL Server 2017 описано в следующей таблице.

|Основной экземпляр</br>Путь к данным по умолчанию |Вторичный экземпляр</br>Путь к данным по умолчанию |Основной экземпляр</br>Размещение файла |SQL Server 2016 </br>Вторичный экземпляр</br>Размещение файла |SQL Server 2017 </br>Вторичный экземпляр</br>Размещение файла
|:------|:------|:------|:------|:------
|c:\\data\\ |d:\\data\\ |c:\\data\\ |c:\\data\\ |d:\\data\\ 
|c:\\data\\ |d:\\data\\ |c:\\data\\group1\\ |c:\\data\\group1\\ |d:\\data\\group1\\

Чтобы вернуться к поведению для SQL Server 2016 и более ранней версии, установите флаг трассировки 9571. Сведения об установке флагов трассировки см. в разделе [DBCC TRACEON (Transact-SQL)](../../../t-sql/database-console-commands/dbcc-traceon-transact-sql.md).


## <a name="create-an-availability-group-with-automatic-seeding"></a>Создание группы доступности с помощью автоматического заполнения

Для создания группы доступности с помощью автоматического заполнения используется Transact-SQL или среда SQL Server Management Studio (SSMS 17 или более поздней версии). Чтобы воспользоваться мастером групп доступности в среде SSMS, выполните [следующие инструкции](use-the-availability-group-wizard-sql-server-management-studio.md). Когда вы дойдете до шага 9, то увидите, что автоматическое заполнение — это самый первый, используемый по умолчанию вариант.

![Выбор начальной синхронизации данных][1]

В следующем примере создается группа доступности с автоматическим заполнением с помощью Transact-SQL. См. также раздел [Создание группы доступности (Transact-SQL)](create-an-availability-group-transact-sql.md). Для включения заполнения во вторичной реплике параметр `SEEDING_MODE` установлен равным `AUTOMATIC`. По умолчанию используется поведение `MANUAL`, которое присуще версиям SQL Server вплоть до SQL Server 2016. Это поведение включает резервное копирование базы данных в первичной реплике, копирование файла резервной копии на вторичную реплику и восстановление из резервной копии `WITH NORECOVERY`.

```sql
CREATE AVAILABILITY GROUP [<AGName>]
  FOR DATABASE db1
  REPLICA ON N'Primary_Replica'
WITH (
  ENDPOINT_URL = N'TCP://Primary_Replica.Contoso.com:5022', 
  FAILOVER_MODE = AUTOMATIC, 
  AVAILABILITY_MODE = SYNCHRONOUS_COMMIT, 
),
  N'Secondary_Replica' WITH (
    ENDPOINT_URL = N'TCP://Secondary_Replica.Contoso.com:5022', 
    FAILOVER_MODE = AUTOMATIC, 
    SEEDING_MODE = AUTOMATIC);
 GO
```

Установка параметра `SEEDING_MODE` на первичной реплике во время выполнения инструкции `CREATE AVAILABILITY GROUP` ни на что не влияет, так как первичная реплика уже содержит основную копию базы данных, доступную для чтения и записи. `SEEDING_MODE` будет применяться только в том случае, если другая реплика была сделана первичной и была добавлена база данных. Режим заполнения можно изменить позднее — см. подраздел [Изменение режима заполнения реплики](#change-the-seeding-mode-of-a-replica).

После присоединения экземпляра, который стал вторичной репликой, в журнал SQL Server добавляется следующее сообщение:

>Локальной реплике доступности для группы доступности "AGName" не было предоставлено разрешение на создание баз данных, но параметр `SEEDING_MODE` был установлен равным `AUTOMATIC`. Используйте `ALTER AVAILABILITY GROUP ... GRANT CREATE ANY DATABASE`, чтобы разрешить создание баз данных, которые заполняются первичной репликой доступности.

### <a name="grant-create-database-permission-on-secondary-replica-to-availability-group"></a><a name = "grantCreate"></a> Предоставление группе доступности разрешения на создание базы данных во вторичной реплике

После соединения предоставьте группе доступности разрешение на создание баз данных в экземпляре вторичной реплики SQL Server. Для работы автоматического заполнения группе доступности необходимо предоставить разрешение на создание базы данных. 

>[!TIP]
>Когда группа доступности создает базу данных во вторичной реплике, она задает sa (учетную запись с идентификатором безопасности 0x01) в качестве владельца базы данных. 
>
>Чтобы изменить владельца базы данных после того, как вторичная реплика автоматически создает базу данных, используйте `ALTER AUTHORIZATION`. См. раздел [ALTER AUTHORIZATION (Transact-SQL)](../../../t-sql/statements/alter-authorization-transact-sql.md).
 
В следующем примере это разрешение предоставляется группе доступности с именем AGName.

```sql
ALTER AVAILABILITY GROUP [<AGName>] 
    GRANT CREATE ANY DATABASE
 GO
```

При необходимости установите владельца базы данных для вторичной реплики. 

### <a name="verify-automatic-seeding"></a>Проверка автоматического заполнения

В случае успешного выполнения базы данных автоматически создаются на вторичной реплике с одним из следующих состояний:

* SYNCHRONIZED (синхронизировано), если вторичная реплика настроена как синхронная и данные синхронизированы.
* SYNCHRONIZING (синхронизируется), если вторичная реплика настроена с асинхронным перемещением данных или настроена с синхронным, но еще не синхронизирована с первичной репликой.

<a name="sql-server-log"></a> В дополнение к [динамическим административным представлениям](#dynamic-management-views), описанным ниже, запуск и завершение автоматического заполнения можно увидеть в журнале SQL Server.

![журнал SQL Server][2]

## <a name="combine-backup-and-restore-with-automatic-seeding"></a>Объединение резервного копирования и восстановление с автоматическим заполнением

Можно объединить традиционные операции резервного копирования и восстановления с автоматическим заполнением. В этом случае сначала следует восстановить базу данных на вторичной реплике, включая все доступные журналы транзакций. Затем нужно включить автоматическое заполнение при создании группы доступности, чтобы "догнать" базу данных вторичной реплики, как если бы была восстановлена резервная копия заключительного фрагмента журнала (см. раздел [Резервные копии заключительного фрагмента журнала (SQL Server)](../../../relational-databases/backup-restore/tail-log-backups-sql-server.md)).

## <a name="add-a-database-to-an-availability-group-with-automatic-seeding"></a>Добавление базы данных в группу доступности с помощью автоматического заполнения

Для добавления базы данных в группу доступности с помощью автоматического заполнения используется Transact-SQL или среда SQL Server Management Studio (SSMS 17 или более поздней версии).
Если вторичная реплика использовала автоматическое заполнение, когда она была добавлена в группу доступности, никакие дополнительные действия не требуются. Если во вторичной реплике использовались операции резервного копирования, копирования и восстановления, сначала измените режим заполнения (см. следующий подраздел), а затем при добавлении базы данных воспользуйтесь инструкцией `GRANT` — см. раздел [Добавление базы данных в группу доступности](availability-group-add-a-database.md).

## <a name="change-the-seeding-mode-of-a-replica"></a>Изменение режима заполнения реплики

Режим заполнения реплики можно изменить после создания группы доступности, поэтому автоматическое заполнение можно включать или отключать. Включение автоматического заполнения после создания позволяет добавить базу данных в группу доступности с помощью автоматического заполнения, если она была создана с функциями резервного копирования, копирования и восстановления. Пример:

```sql
ALTER AVAILABILITY GROUP [AGName]
  MODIFY REPLICA ON 'Replica_Name'
  WITH (SEEDING_MODE = AUTOMATIC)
```

Чтобы отключить автоматическое заполнение, используйте значение MANUAL.

## <a name="prevent-automatic-seeding-after-an-availability-group-is-created"></a>Запрет автоматического заполнения после создания группы доступности

Если вы не хотите полностью отключать автоматическое заполнение для вторичной реплики, но хотите временно запретить вторичной реплике автоматически создавать базы данных, отклоните разрешение CREATE для группы доступности. Это имеет место, когда новая база данных добавляется в группу доступности, но группе доступности должно быть запрещено создание базы данных на вторичной реплике.

```sql
ALTER AVAILABILITY GROUP [AGName] 
    DENY CREATE ANY DATABASE
GO
```

## <a name="monitor-automatic-seeding"></a>Мониторинг автоматического заполнения

Существует четыре способа мониторинга и устранения неполадок автоматического заполнения.

* [Журнал SQL Server](#sql-server-log), как уже описано
* [Динамические административные представления](#dynamic-management-views)
* [Таблицы журнала резервного копирования](#backup-history-tables)
* [Расширенные события](#extended-events)

### <a name="dynamic-management-views"></a>Динамические административные представления

Существует два динамических административных представления для мониторинга заполнения: `sys.dm_hadr_automatic_seeding` и `sys.dm_hadr_physical_seeding_stats`.

* `sys.dm_hadr_automatic_seeding` содержит сведения об общем состоянии автоматического заполнения и сохраняет журнал для каждого заполнения (было ли оно завершено успешно). В столбце `current_state` будет указано значение COMPLETED или FAILED. Если указано значение FAILED, используйте значение в `failure_state_desc` для диагностики проблемы. Чтобы увидеть, что пошло не так, вам может потребоваться объединить его со значением в [журнале SQL Server](#sql-server-log). Это динамическое административное представление заполняется на первичной и всех вторичных репликах.

* В `sys.dm_hadr_physical_seeding_stats` отображается состояние операции автоматического заполнения по мере ее выполнения. Как и в `sys.dm_hadr_automatic_seeding`, будут возвращены значения для первичных и вторичных реплик, но журнал сохраняться не будет. Значения приводятся только для текущего выполнения и не сохраняются. Необходимые столбцы включают `start_time_utc`, `end_time_utc`, `estimate_time_complete_utc`, `total_disk_io_wait_time_ms`, `total_network_wait_time_ms` и столбец failure_message, если операция заполнения завершается сбоем.

### <a name="backup-history-tables"></a>Таблицы журнала резервного копирования

Автоматическое заполнение также помещает данные в таблицы `msdb`, где хранится журнал для резервного копирования и восстановления. На вторичной реплике, которая получает автоматическое заполнение, столбец physical_device_name таблицы `backupmediafamily` содержит идентификатор GUID для его значения, а соответствующая запись в `backupset` носит имя первичной реплики для server_name и machine_name.

### <a name="extended-events"></a>Расширенные события

Автоматическое заполнение добавляет новые расширенные события для отслеживания изменения состояния, сбоев и статистики производительности во время инициализации.
Например, следующий скрипт создает сеанс расширенных событий, который фиксирует события, связанные с автоматическим заполнением.

```sql
CREATE EVENT SESSION [AlwaysOn_autoseed] ON SERVER 
    ADD EVENT sqlserver.hadr_automatic_seeding_state_transition,
    ADD EVENT sqlserver.hadr_automatic_seeding_timeout,
    ADD EVENT sqlserver.hadr_db_manager_seeding_request_msg,
    ADD EVENT sqlserver.hadr_physical_seeding_backup_state_change,
    ADD EVENT sqlserver.hadr_physical_seeding_failure,
    ADD EVENT sqlserver.hadr_physical_seeding_forwarder_state_change,
    ADD EVENT sqlserver.hadr_physical_seeding_forwarder_target_state_change,
    ADD EVENT sqlserver.hadr_physical_seeding_progress,
    ADD EVENT sqlserver.hadr_physical_seeding_restore_state_change,
    ADD EVENT sqlserver.hadr_physical_seeding_submit_callback
    ADD TARGET package0.event_file(
        SET filename=N'autoseed.xel',
        max_file_size=(5),
        max_rollover_files=(4)
        )
    WITH (
        MAX_MEMORY=4096 KB,
        EVENT_RETENTION_MODE=ALLOW_SINGLE_EVENT_LOSS,
        MAX_DISPATCH_LATENCY=30 SECONDS,
        MAX_EVENT_SIZE=0 KB,
        MEMORY_PARTITION_MODE=NONE,
        TRACK_CAUSALITY=OFF,
        STARTUP_STATE=ON
        )
GO

ALTER EVENT SESSION AlwaysOn_autoseed ON SERVER STATE=START
GO
```

В таблице ниже перечислены расширенные события, связанные с автоматическим заполнением.

|Имя|Описание|
|----|-----------|
|hadr_db_manager_seeding_request_msg|Заполнение сообщения запроса.|
|hadr_physical_seeding_backup_state_change|Изменение состояния на стороне резервного копирования при физическом заполнении.|
|hadr_physical_seeding_restore_state_change|Изменение состояния на стороне восстановления при физическом заполнении.|
|hadr_physical_seeding_forwarder_state_change|Изменение состояния на стороне сервера пересылки при физическом заполнении.|
|hadr_physical_seeding_forwarder_target_state_change|Изменение состояния на стороне цели сервера пересылки при физическом заполнении.|
|hadr_physical_seeding_submit_callback|Событие обратного вызова при фиксации физического заполнения.|
|hadr_physical_seeding_failure|Событие сбоя физического заполнения.|
|hadr_physical_seeding_progress|Событие хода выполнения физического заполнения.|
|hadr_physical_seeding_schedule_long_task_failure|Событие сбоя длительной задачи с расписанием физического заполнения.|
|hadr_automatic_seeding_start|Происходит при отправке операции автоматического заполнения.|
|hadr_automatic_seeding_state_transition|Происходит при изменении состояния операции автоматического заполнения.|
|hadr_automatic_seeding_success|Происходит при успешном выполнении операции автоматического заполнения.|
|hadr_automatic_seeding_failure|Происходит при сбое операции автоматического заполнения.|
|hadr_automatic_seeding_timeout|Происходит при истечении времени ожидания операции автоматического заполнения.|

## <a name="see-also"></a>См. также раздел

[ALTER AVAILABILITY GROUP (Transact-SQL)](../../../t-sql/statements/alter-availability-group-transact-sql.md)

[CREATE AVAILABILITY GROUP (Transact-SQL)](../../../t-sql/statements/create-availability-group-transact-sql.md)

[Руководство по мониторингу и устранению неполадок в группах доступности AlwaysOn](/previous-versions/sql/sql-server-guides/dn135328(v=sql.110))

<!--Image references-->
[1]: ./media/auto-seed-new-availability-group.png
[2]: ./media/auto-seed-sql-server-log.png
