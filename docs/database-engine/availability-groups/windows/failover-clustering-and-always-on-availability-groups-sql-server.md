---
title: Экземпляр отказоустойчивого кластера с группами доступности
description: Повысьте уровень доступности и эффективность аварийного восстановления, используя возможности экземпляра отказоустойчивого кластера SQL Server и группы доступности Always On.
ms.custom: seo-lt-2019
ms.date: 07/02/2017
ms.prod: sql
ms.reviewer: ''
ms.technology: availability-groups
ms.topic: conceptual
helpviewer_keywords:
- clustering [SQL Server]
- Availability Groups [SQL Server], WSFC clusters
- Failover Cluster Instances [SQL Server], see failover clustering [SQL Server]
- quorum [SQL Server]
- failover clustering [SQL Server], AlwaysOn Availability Groups
- Availability Groups [SQL Server], Failover Cluster Instances
ms.assetid: 613bfbf1-9958-477b-a6be-c6d4f18785c3
author: cawrites
ms.author: chadam
monikerRange: '>=sql-server-2016'
ms.openlocfilehash: 31cef60a33505278791d296aab1022be9b4bc06b
ms.sourcegitcommit: 917df4ffd22e4a229af7dc481dcce3ebba0aa4d7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/10/2021
ms.locfileid: "100353883"
---
# <a name="failover-clustering-and-always-on-availability-groups-sql-server"></a>Отказоустойчивая кластеризация и группы доступности AlwaysOn (SQL Server)

[!INCLUDE[sql windows only](../../../includes/applies-to-version/sql-windows-only.md)]

   [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] — решение высокого уровня доступности и аварийного восстановления, появившееся в [!INCLUDE[sssql11](../../../includes/sssql11-md.md)]. Требует наличия отказоустойчивого кластера Windows Server (WSFC). Кроме того, хотя [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] не зависит от отказоустойчивого кластера [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , на экземпляре отказоустойчивого кластера (FCI) можно размещать реплику для группы доступности. При проектировании среды [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] важно знать роль каждой из технологий кластеризации, а также иметь представления о необходимых требованиях.  
  
> [!NOTE]  
>  Сведения о концепциях [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] см. в разделе [Обзор групп доступности AlwaysOn (SQL Server)](../../../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md).  
  
  
##  <a name="windows-server-failover-clustering-and-availability-groups"></a><a name="WSFC"></a> Кластер WSFC и группы доступности  
 Для развертывания [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] требуется кластер WSFC. Чтобы экземпляр [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]можно было использовать в [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], необходимо, чтобы он размещался на узле WSFC, а кластер WSFC и узел были работоспособны. Также все реплики доступности в заданной группе доступности должны располагаться на разных узлах одного кластера WSFC. Единственное исключение состоит в том, что при переносе в другой кластер WSFC группа доступности может временно находиться в двух кластерах.  
  
 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] использует кластер WSFC для наблюдения за текущими ролями реплик доступности, принадлежащих к данной группе доступности, и управления ими, а также для определения влияния отработки отказа на реплики доступности. Группа ресурсов WSFC создается для каждой создаваемой группы доступности. Кластер WSFC отслеживает данную группу ресурсов для оценки работоспособности первичной реплики.  
  
 Кворум для [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] рассчитывается на всех узлах в кластере WSFC вне зависимости от того, хранится ли на данном узле кластера какая-либо реплика доступности. В отличие от процесса зеркального отображения базы данных, в [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] нет роли следящего объекта.  
  
 Общая работоспособность кластера WSFC определяется голосами на кворуме узлов в кластере. Если кластер WSFC перешел в автономный режим в результате непредвиденной аварийной ситуации, постоянно возникающего сбоя в оборудовании или ошибки связи, то требуется вмешательство администратора. Администратор кластера Windows Server или WSFC должен будет создать принудительный кворум, а затем перевести работоспособные узлы кластера обратно в автономный режим в неотказоустойчивой конфигурации.  
  
> [!IMPORTANT]  
>  [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] — это подразделы кластера WSFC. При удалении и повторном создании кластера WSFC необходимо отключить и повторно включить функцию [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] в каждом экземпляре [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], где была размещена реплика доступности в исходном кластере WSFC.  
  
 Дополнительные сведения о запуске [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] в узлах кластера WSFC и кворуме WSFC см. в разделе [Отказоустойчивая кластеризация Windows Server (WSFC) с SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md).  
  
##  <a name="ssnoversion-failover-cluster-instances-fcis-and-availability-groups"></a><a name="SQLServerFC"></a> [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Экземпляры отказоустойчивого кластера (FCI) и группы доступности  
 Можно настроить второй уровень отказоустойчивости на уровне экземпляра сервера путем реализации FCI [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] совместно с кластером WSFC. Реплика доступности может размещаться либо с помощью отдельного экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] или экземпляра FCI. Только партнер FCI может размещать реплику для данной группы доступности. Во время работы реплики доступности на экземплярах отказоустойчивого кластера (FCI) список возможных владельцев для группы доступности будет содержать только активный узел FCI.  
  
 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] не зависит от формы общего хранилища. Однако при использовании экземпляра отказоустойчивого кластера [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] для размещения одной или нескольких реплик доступности для каждого из этих экземпляров потребуется общее хранилище в соответствии со стандартной установкой экземпляра отказоустойчивого кластера SQL Server.  
  
 Дополнительные сведения о других предварительных требованиях см. в подразделе "Предварительные требования и ограничения, связанные с использованием экземпляра отказоустойчивого кластера SQL Server (FCI) для размещения реплики доступности" раздела [Предварительные условия и ограничения, связанные с использованием экземпляра отказоустойчивого кластера SQL Server для размещения реплики доступности (SQL Server)](../../../database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability.md).  
  
### <a name="comparison-of-failover-cluster-instances-and-availability-groups"></a>Сравнение экземпляров отказоустойчивого кластера и групп доступности  
 Независимо от количества узлов в FCI, во всем FCI размещается одна реплика в группе доступности. В следующей таблице описаны различия концепций узлов в FCI и репликах в группе доступности.  
  
||Узлы в FCI|Реплики в группе доступности|  
|-|-------------------------|-------------------------------------------|  
|**Использует WSFC**|Да|Да|  
|**Уровень защиты**|Экземпляр|База данных|  
|**Тип хранилища**|Совмещаемая блокировка|Не общее<br /><br /> Хотя реплики в группе доступности не используют общее хранилище, реплика, размещенная FCI, использует решение общего хранилища, в соответствии с требованиями этого FCI. Решение хранения данных совместно используется только узлами в FCI, но не между репликами группы доступности.|  
|**Решения хранения данных**|Прямое подключение, SAN, точки подключения, SMB|Зависит от типа узла|  
|**Доступные для чтения вторичные**|Нет*|Да|  
|**Применимые параметры политики отработки отказа**|Кворум WSFC<br /><br /> Связанный с FCI<br /><br /> Параметры группы доступности**|Кворум WSFC<br /><br /> Параметры группы доступности|  
|**Ресурсы для перехода в случае сбоя**|Сервер, экземпляр и база данных|Только база данных|  
  
 *Хотя синхронные вторичные реплики в группе доступности всегда запускаются в соответствующих экземплярах [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , соответствующие экземпляры [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] на вторичных узлах в FCI не запущены и, следовательно, недоступны для чтения. В FCI вторичный узел запускает экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] только при передаче группы ресурсов во владение при отработке отказа FCI. Однако на активном узле FCI в случаях, когда база данных, размещенная FCI, принадлежит группе доступности, если локальная реплика доступности запускается как вторичная реплика, доступная для чтения, база данных также доступна для чтения.  
  
 **Параметры политики перехода на другой ресурс для группы доступности применимы ко всем репликам, независимо от того, размещаются ли они в автономном экземпляре или экземпляре FCI.  
  
> [!NOTE]  
>  Дополнительные сведения о **числе узлов** в FCI и **группах доступности Always On** для разных выпусков [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] см. в разделе [Функции, поддерживаемые выпусками SQL Server 2012](/previous-versions/sql/sql-server-2012/cc645993(v=sql.110)) (https://go.microsoft.com/fwlink/?linkid=232473).  
  
### <a name="considerations-for-hosting-an-availability-replica-on-an-fci"></a>Рекомендации для размещения реплики доступности на FCI  
  
> [!IMPORTANT]  
>  При необходимости в размещении реплики доступности в экземпляре отказоустойчивого кластера SQL Server убедитесь, что узлы Windows Server 2008 соответствуют предварительным требованиям AlwaysOn и ограничениям для экземпляров отказоустойчивого кластера. Дополнительные сведения см. в разделе [Предварительные требования, ограничения и рекомендации для групп доступности AlwaysOn (SQL Server)](../../../database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability.md).  
  
 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Экземпляры отказоустойчивого кластера (FCI) не поддерживают автоматический переход на другой ресурс с учетом групп доступности, поэтому любая реплика доступности, размещенная в них, должна быть настроена для перехода на другой ресурс вручную.  
  
 Может потребоваться настройка кластера WSFC для включения общих дисков, которые доступны не на всех узлах. Например, рассмотрим кластер WSFC между двумя центрами обработки данных с тремя узлами. На двух узлах размещается экземпляр отказоустойчивой кластеризации SQL Server в основном центре обработки данных; им предоставлен доступ к одним и тем же общим дискам. На третьем узле размещается автономный экземпляр SQL Server в другом центре обработки данных и отсутствует доступ к общим дискам от основного центра обработки данных. Эта конфигурация кластера WSFC поддерживает развертывание группы доступности, если на экземпляре отказоустойчивого кластера размещена первичная реплика и на автономном экземпляре находится вторичная реплика.  
  
 При выборе FCI для размещения реплики доступности для данной группы доступности убедитесь, что отработка отказа FCI не может привести к попытке отдельного узла WSFC размещения двух реплик доступности для одной группы доступности.  
  
 В следующем примере сценария показано, как подобная конфигурация может вызывать проблемы.  
  
 Марцелл настраивает два отказоустойчивых кластера WSFC, состоящие из двух узлов каждый: `NODE01` и `NODE02`. Он устанавливает экземпляр отказоустойчивого кластера [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , `fciInstance1`на `NODE01` и `NODE02` , где `NODE01` является текущим владельцем для `fciInstance1`.  
 На `NODE02`Марцелл устанавливает еще один экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], `Instance3`, который является автономным.  
 На узле `NODE01`Марцелл включает fciInstance1 для [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]. В `NODE02`он включает `Instance3` для [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]. Затем он настраивает группу доступности, для которой `fciInstance1` размещает первичную реплику, а `Instance3` размещает вторичную реплику.  
 В какой-то момент экземпляр `fciInstance1` становится недоступным на `NODE01`, и кластер WSFC вызывает отработку отказа `fciInstance1` на `NODE02`. После отработки отказа экземпляр `fciInstance1` является экземпляром с [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], запущенным в основной роли на узле `NODE02`. Однако экземпляр `Instance3` теперь находится на том же узле кластера WSFC, что и `fciInstance1`. Это нарушает ограничение [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] .  
 Чтобы проблема, описанная в этом сценарии, не возникала, изолированный экземпляр `Instance3`должен находиться на отдельном узле в том же кластере WSFC, что и узлы `NODE01` и `NODE02`.  
  
 Дополнительные сведения об FCI [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] см. в разделе [Экземпляры отказоустойчивого кластера (режим Always On) (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md).  
  
##  <a name="restrictions-on-using-the-wsfc-failover-cluster-manager-with-availability-groups"></a><a name="FCMrestrictions"></a> Ограничения на использование диспетчера отказоустойчивости кластеров WSFC с группами доступности  
 Не используйте диспетчер отказоустойчивости кластеров для управления группами доступности, например:  
  
-   Нельзя добавлять или удалять ресурсы в службе, поддерживающей работу в кластере (группе ресурсов) для группы доступности.  
  
-   Не изменяйте свойства групп доступности, такие как возможные владельцы и предпочтительные владельцы. Эти свойства устанавливаются автоматически группой доступности.  
  
-   **Не используйте диспетчер отказоустойчивого кластеров для перемещения групп доступности на другие узлы или резервные группы доступности.** Диспетчер отказоустойчивого кластера не имеет сведений о состоянии синхронизации реплик доступности, и это может привести к длительному простою. Необходимо использовать [!INCLUDE[tsql](../../../includes/tsql-md.md)] или среду [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)].  

  >[!WARNING]
  > Если с помощью диспетчера отказоустойчивости кластеров переместить *экземпляр отказоустойчивого кластера* с группой доступности на узел, который *уже* содержит реплику той же группы доступности, это может привести к потере этой реплики. Таким образом, эта реплика не будет включена на целевом узле. Один узел отказоустойчивого кластера не может содержать более одной реплики той же группы доступности. Дополнительные сведения о том, как это происходит, и шаги восстановления см. в записи блога [Issue: Replica Unexpectedly Dropped in Availability Group](/archive/blogs/alwaysonpro/issue-replica-unexpectedly-dropped-in-availability-group) (Проблема: неожиданное удаление реплики в группе доступности). 
  
##  <a name="related-content"></a><a name="RelatedContent"></a> См. также  
  
-   **Блоги**  
  
     [Настроить отказоустойчивую кластеризацию Windows для SQL Server (группы доступности или экземпляр отказоустойчивого кластера) с ограниченной безопасностью](/archive/blogs/sqlalwayson/configure-windows-failover-clustering-for-sql-server-availability-group-or-fci-with-limited-security)  
  
     [Блоги команды разработчиков SQL Server AlwaysOn: официальный блог по SQL Server AlwaysOn](/archive/blogs/sqlalwayson/)  
  
     [Блоги инженеров CSS SQL Server](/archive/blogs/psssql/)  
  
-   **Технические документы**  
  
     [Руководство по архитектуре AlwaysOn. Построение решения для обеспечения высокого уровня доступности и аварийного восстановления с помощью экземпляров отказоустойчивого кластера и групп доступности](/previous-versions/sql/sql-server-2012/jj215886(v=msdn.10))  
  
     [Руководство по решениям режима AlwaysOn в Microsoft SQL Server для обеспечения высокой доступности и аварийного восстановления](/previous-versions/sql/sql-server-2012/hh781257(v=msdn.10))  
  
     [Технические документы Майкрософт Microsoft по SQL Server 2012](https://msdn.microsoft.com/library/hh403491.aspx)  
  
     [Технические документы группы консультантов по SQL Server](https://techcommunity.microsoft.com/t5/DataCAT/bg-p/DataCAT/)  
  
## <a name="see-also"></a>См. также:  
 [Обзор групп доступности AlwaysOn (SQL Server)](../../../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md)   
 [Включение и отключение групп доступности AlwaysOn (SQL Server)](../../../database-engine/availability-groups/windows/enable-and-disable-always-on-availability-groups-sql-server.md)   
 [Отслеживание групп доступности (Transact-SQL)](../../../database-engine/availability-groups/windows/monitor-availability-groups-transact-sql.md)   
 [Экземпляры отказоустойчивого кластера (режим AlwaysOn) (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md)  
  
