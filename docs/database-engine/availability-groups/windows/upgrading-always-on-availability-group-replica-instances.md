---
title: Обновление реплик группы доступности
description: Узнайте, как сократить время простоя первичной реплики во время обновлений SQL Server путем выполнения последовательного обновления.
ms.custom: seo-lt-2019
ms.date: 01/10/2018
ms.prod: sql
ms.reviewer: ''
ms.technology: availability-groups
ms.topic: conceptual
ms.assetid: f670af56-dbcc-4309-9119-f919dcad8a65
author: cawrites
ms.author: chadam
ms.openlocfilehash: 785c8421a1ca689e39852401165c4b0249128e8c
ms.sourcegitcommit: 370cab80fba17c15fb0bceed9f80cb099017e000
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/17/2020
ms.locfileid: "97641839"
---
# <a name="upgrading-always-on-availability-group-replica-instances"></a>Обновление экземпляров реплики группы доступности AlwaysOn
[!INCLUDE [SQL Server](../../../includes/applies-to-version/sqlserver.md)]

При обновлении экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], на котором размещается группа доступности AlwaysOn, до новой версии [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)], нового пакета обновления [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] или накопительного пакета обновления, а также при установке нового пакета обновления Windows или накопительного пакета обновления Windows) вы можете выполнить последовательное обновление. Это позволит сократить время простоя первичной реплики до одной операции перехода на другой ресурс вручную (или двух таких операций, если нужно перейти на исходную первичную реплику). При обновлении вторичная реплика будет недоступна для отработки отказа или операций только для чтения. После обновления для синхронизации между вторичной репликой и узлом первичной реплики может потребоваться некоторое время; кроме того, может отмечаться значительное увеличение сетевого трафика (в зависимости от объема действий на узле первичной реплики). Также обратите внимание, что после начальной отработки отказа во вторичную реплику, где работает более новая версия SQL Server, базы данных в этой группе доступности будут обновлены до последней версии. При этом для таких баз данных не будут доступны реплики для чтения. Время простоя после первоначальной отработки отказа будет зависеть от количества баз данных в группе доступности. Если вы планируете восстановить размещение в исходной первичной реплике, этот шаг не будет повторяться при восстановлении.
  
>[!NOTE]  
>В этой статье мы ограничимся обсуждением обновления только SQL Server. Здесь не рассматривается обновление операционной системы с отказоустойчивым кластером Windows Server (WSFC). Обновление операционной системы Windows, на которой размещен отказоустойчивый кластер, не поддерживается для операционных систем ниже Windows Server 2012 R2. Обновление узла кластера под управлением Windows Server 2012 R2 описано в статье [Cluster Operating System Rolling Upgrade](/windows-server/failover-clustering/cluster-operating-system-rolling-upgrade) (Последовательное обновление операционной системы в кластере).  
  
## <a name="prerequisites"></a>Предварительные требования  
Перед установкой ознакомьтесь со следующими важными сведениями.  
  
- [Поддерживаемые обновления версий и выпусков](../../../database-engine/install-windows/supported-version-and-edition-upgrades.md). Убедитесь, что текущая версия операционной системы Windows позволяет обновить текущую версию SQL Server до версии SQL Server 2016. Например, вы не можете напрямую обновить экземпляр SQL Server 2005 до [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].  
  
- [Выбор метода обновления ядра СУБД](../../../database-engine/install-windows/choose-a-database-engine-upgrade-method.md). Чтобы обеспечить правильный порядок обновления, выберите подходящий метод и этапы обновления с учетом поддерживаемой версии, доступных обновлений выпусков и других компонентов, установленных в вашей среде.  
  
- [Составление и тестирование плана обновления ядра СУБД](../../../database-engine/install-windows/plan-and-test-the-database-engine-upgrade-plan.md). Просмотрите заметки о выпуске и известные проблемы, связанные с обновлением, изучите контрольный список предварительных требований, а затем разработайте и протестируйте план обновления.  
  
- [Требования к оборудованию и программному обеспечению для установки SQL Server](../../../sql-server/install/hardware-and-software-requirements-for-installing-sql-server.md).  Изучите требования к программному обеспечению для установки [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)]. Если требуется дополнительное программное обеспечение, установите его на каждом узле перед запуском обновления, чтобы минимизировать время простоя.  

- [Проверьте, используется ли отслеживание измененных данных или репликация для баз данных групп доступности](#special-steps-for-change-data-capture-or-replication). Если в каких-то базах группы доступности включено отслеживание измененных данных (CDC), выполните [эти инструкции](#special-steps-for-change-data-capture-or-replication).

>[!NOTE]  
>Использование различных версий экземпляров SQL Server в одной и той же группе доступности не поддерживается вне последовательного обновления; такое состояние не должно возникать на длительное время, так как обновление должно осуществляться быстро. Другой вариант обновления SQL Server 2016 и более поздних версий — использование распределенной группы доступности.

## <a name="rolling-upgrade-basics-for-always-on-ags"></a>Основные сведения о последовательном обновлении для групп доступности AlwaysOn  
При модернизации или обновлении сервера, следует руководствоваться следующими рекомендациями, чтобы минимизировать время простоя и потерю данных для групп доступности.  
  
- Перед запуском последовательного обновления сделайте вот что.  
  
    - Выполните тестовый переход на другой ресурс вручную по крайней мере для одного из экземпляров реплик синхронной фиксации.  
  
    - Защитите данные, выполнив полное резервное копирование базы данных на каждой базе данных доступности.  
  
    - Выполните команду DBCC CHECKDB на каждой базе данных доступности.  
  
-   Всегда сначала обновляйте удаленные экземпляры вторичных реплик, затем локальные экземпляры вторичных реплик, и только в последнюю очередь — экземпляр первичной реплики.  
  
-   Резервное копирование базы данных, которая находится в процессе обновления, не может быть выполнено.  Перед обновлением вторичных реплик настройте автоматическое резервное копирование так, чтобы оно создавало резервные копии только первичной реплики.  При обновлении до новой версии реплики недоступны для чтения или резервного копирования. При обновлении в рамках одной версии перед запуском обновления первичной реплики можно настроить автоматическое резервное копирование на вторичных репликах.  
  
-   При обновлении до новой версии доступные для чтения вторичные реплики будут недоступными после запуска обновления каждой из вторичных реплик — вплоть до перехода на обновленную вторичную реплику или завершения обновления первичной реплики.  
  
-   Чтобы предотвратить для групп доступности непреднамеренный переход на другой ресурс при обновлении, перед началом операции удалите на всех репликах с синхронной фиксацией конфигурацию перехода на другой ресурс для групп доступности.  
  
-   Не обновляйте экземпляр первичной реплики, пока для группы доступности не будет выполнен переход на обновленный ресурс (вторичную реплику). В противном случае время простоя клиентских приложений, запущенных на обновляемом экземпляре первичной реплики, может увеличиться.  
  
-   Обязательно выполняйте для группы доступности переход на другой ресурс (экземпляр вторичной реплики с синхронной фиксацией). Использование режима асинхронной фиксации связано с риском потери данных в базах данных и приведет к автоматической приостановке перемещения данных (возобновление выполняется вручную).  
  
-   Не обновляйте экземпляр первичной реплики, пока не будет завершено обновление всех экземпляров вторичной реплики. Обновленная первичная реплика не сможет передавать журналы вторичным репликам, экземпляр [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] которых еще не был обновлен до соответствующей версии. Если перемещение данных к вторичной реплике приостанавливается, то для этой реплики не может осуществляться автоматический переход на другой ресурс, а базы данных доступности становятся подверженными потере данных. Это также относится к последовательному обновлению, когда вы выполняете переход со старой первичной реплики на новую вручную. Таким образом, после обновления старой первичной реплики может потребоваться возобновить синхронизацию.
  
-   Перед возобновлением работы группы доступности проверьте, чтобы состоянием синхронизации для цели перехода на другой ресурс было SYNCHRONIZED.  

  > [!WARNING]
  > Установка нового экземпляра или новой версии SQL Server на сервере, где установлена более старая версия SQL Server, может непреднамеренно привести к **сбою группы доступности, размещенной в старой версии SQL Server.** Это происходит из-за того, что во время установки экземпляра или версии SQL Server происходит обновление модуля высокого уровня доступности SQL Server (RHS.EXE) В результате временно прерывается работа существующих групп доступности в первичной роли на сервере. Таким образом, при установке новой версии SQL Server в системе, где уже размещена более старая версия SQL Server с группой доступности, настоятельно рекомендуется выполнить одно из следующих действий:
  > - установить новую версию SQL Server во время периода обслуживания; 
  > - отработать отказ группы доступности на вторичную реплику, чтобы во время установки нового экземпляра SQL Server она не была первичной. 
  
## <a name="rolling-upgrade-process"></a>Процесс последовательного обновления  
 На практике способ организации процесса зависит от многих факторов, в том числе топологии развертывания групп доступности и режима фиксации каждой реплики. Но даже в рамках простейшего сценария последовательное обновление — это процесс с несколькими этапами:  
  
 ![Обновление группы доступности в сценарии HADR](../../../database-engine/availability-groups/windows/media/alwaysonupgrade-ag-hadr.gif "Обновление группы доступности в сценарии HADR")  
  
1.  Удаление конфигурации автоматического перехода на другой ресурс на всех репликах с синхронной фиксацией  
  
2.  Обновление всех экземпляров вторичной реплики с асинхронной фиксацией. 
  
3.  Обновление всех удаленных экземпляров вторичной реплики с синхронной фиксацией. 

4.  Обновление всех локальных экземпляров вторичной реплики с синхронной фиксацией. 
  
4.  Выполнение для группы доступности перехода на другой ресурс (обновленную локальную вторичную реплику с синхронной фиксацией) вручную.  
  
5.  Обновление локального экземпляра реплики, на котором ранее размещалась первичная реплика.  
  
6.  Настройка участников автоматического перехода на другой ресурс желаемым образом.
  
 В случае необходимости можно выполнить дополнительный переход на другой ресурс вручную, чтобы возвратить группу доступности к ее исходной конфигурации.  
 
   > [!NOTE]
   > - При обновлении реплики с синхронной фиксацией и переводе ее в автономный режим транзакции в первичной реплике не откладываются. После отключения вторичной реплики транзакции фиксируются в первичной реплике без ожидания записи журнала во вторичной реплике. 
   > - Если параметр `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` имеет значение `1` или `2`, первичная реплика может быть недоступна для чтения и записи, если в процессе обновления недоступно соответствующее количество синхронных вторичных реплик. 
  
## <a name="ag-with-one-remote-secondary-replica"></a>Группа доступности с одной удаленной вторичной репликой  
 Если группа доступности развернута только для аварийного восстановления, то может потребоваться возобновить работу группы доступности для вторичной реплики с асинхронной фиксацией. Такая конфигурация показана на следующем рисунке.  
  
 ![Обновление группы доступности в сценарии DR](../../../database-engine/availability-groups/windows/media/agupgrade-ag-dr.gif "Обновление группы доступности в сценарии DR")  
  
 В этом сценарии при последовательном обновлении следует выполнить для группы доступности переход на другой ресурс (вторичную реплику с асинхронной фиксацией). Чтобы предотвратить потерю данных, измените режим фиксации на синхронную фиксацию и ожидайте, пока вторичная реплика не будет синхронизирована, прежде чем возобновить работу группы доступности. Следовательно, процесс последовательного обновления может выглядеть так:  
  
1.  Обновление экземпляра вторичной реплики на удаленном сайте.  
  
2.  Изменение режима фиксации на синхронную фиксацию  
  
3.  Ожидание достижения состояния синхронизации SYNCHRONIZED  
  
4.  Выполнение для группы доступности перехода на другой ресурс (удаленную реплику на вторичном сайте).  
  
5.  Обновление локального (на первичном сайте) экземпляра реплики.  
  
6.  Выполнение для группы доступности обратного перехода на другой ресурс (первичный сайт).  
  
7.  Изменение режима фиксации на асинхронную фиксацию  
  
 Режим синхронной фиксации не представляет собой рекомендуемую настройку для синхронизации данных на удаленном узле, поэтому в клиентских приложениях может обнаруживаться непосредственное увеличение задержки базы данных после изменения этого параметра. Кроме того, выполнение перехода на другой ресурс приводит к тому, что все неподтвержденные сообщения журнала будут отброшены. Количество отброшенных сообщений журнала может быть значительным из-за высокой задержки сети между этими двумя сайтами, а это приведет к тому, что клиенты столкнутся с увеличением количества сбоев транзакций. Можно свести к минимуму отрицательное воздействие на клиентские приложения, выполнив следующие действия.  
  
-   Тщательный выбор перерыва на профилактическое техобслуживание в период снижения клиентского трафика  
  
-   При обновлении [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] на первичном сайте снова включите режим асинхронной фиксации. Когда вы будете готовы снова выполнить переход на другой ресурс (первичный сайт), вернитесь к синхронной фиксации.  
  
## <a name="ag-with-failover-cluster-instance-nodes"></a>Группа доступности с узлами экземпляра отказоустойчивого кластера  
 Если группа доступности содержит узлы экземпляра отказоустойчивого кластера (FCI), сначала нужно обновлять неактивные узлы, а затем — активные. На приведенном ниже рисунке показан обычный сценарий для групп доступности с использованием экземпляров FCI для достижения локального высокого уровня доступности и асинхронной фиксации между экземплярами FCI для удаленного аварийного восстановления, а также последовательность обновления.  
  
 ![Обновление группы доступности с FCI](../../../database-engine/availability-groups/windows/media/agupgrade-ag-fci-dr.gif "Обновление группы доступности с FCI")  
  
1.  Обновление REMOTE2.  
  
2.  Возобновление работы FCI2 на REMOTE2  
  
3.  Обновление REMOTE1.  
  
4.  Обновление PRIMARY2.  
  
5.  Возобновление работы FCI1 на PRIMARY2  
  
6.  Обновление PRIMARY1.  
  
## <a name="upgrade-or-update-sql-server-instances-with-multiple-ags"></a>Обновление или повышение уровня экземпляров SQL Server с несколькими группами доступности  
 Если вы используете несколько групп доступности с первичными репликами на разных узлах (режим "активный — активный"), процесс обновления будет включать больше циклов перехода на другие ресурсы. Это позволит сохранить высокий уровень доступности на протяжении всей операции. Предположим, что эксплуатируются три группы доступности на трех узлах сервера, а все реплики работают в режиме синхронной фиксации, как показано в следующей таблице.  
  
|ГД|Узел1|Узел2|Node3|  
|------------------------|-----------|-----------|-----------|  
|ГД1|Первичная|||  
|ГД2||Первичная||  
|ГД3|||Первичная|  
  
 Иногда уместно будет выполнить последовательное обновление с балансировкой нагрузки. Операция будет включать следующие шаги:  
  
1.  Возобновление работы ГД2 на Узле3 (для освобождения Узла2)  
  
2.  Обновление Node2.  
  
3.  Возобновление работы ГД1 на Узле2 (для освобождения Узла1)  
  
4.  Обновление Node1.  
  
5.  Возобновление работы обеих групп доступности, ГД2 и ГД3, на Узле1 (для освобождения Узла3)  
  
6.  Обновление Node3.  
  
7.  Возобновление работы ГД3 на Узле3  
  
 Такая последовательность обновления обеспечит более короткое среднее время простоя, чем при двух переходах на другой ресурс для каждой группы доступности. Результирующая конфигурация показана в приведенной ниже таблице.  
  
|ГД|Узел1|Узел2|Node3|  
|------------------------|-----------|-----------|-----------|  
|ГД1||Первичная||  
|ГД2|Первичная|||  
|ГД3|||Первичная|  
  
 Фактический процесс обновления (как и время простоя клиентских приложений) может отличаться в зависимости от особенностей реализации вашей системы.  
  
> [!NOTE]  
>  Во многих случаях после завершения последовательного обновления будет выполнен переход на другой ресурс (исходную первичную реплику). 

## <a name="rolling-upgrade-of-a-distributed-availability-group"></a>Последовательное обновление распределенной группы доступности
Чтобы выполнить последовательное обновление распределенной группы доступности, сначала обновите все вторичные реплики. Далее проведите отработку отказа сервера пересылки и обновите оставшийся экземпляр второй группы доступности. После обновления всех вторичных реплик проведите отработку отказа глобальной первичной реплики и обновите последний экземпляр первой группы доступности. Ниже приводится подробная схема с пошаговыми инструкциями. 

 Фактический процесс обновления (как и время простоя клиентских приложений) может отличаться в зависимости от особенностей реализации вашей системы.  
  
> [!NOTE]  
>  Во многих случаях после завершения последовательного обновления будет выполнен переход на другой ресурс (исходную первичную реплику). 

### <a name="general-steps-to-upgrade-a-distributed-availability-group"></a>Общие шаги для обновления распределенной группы доступности
1. Создайте резервную копию всех баз данных, включая системные и входящие в группу доступности. 
2. Обновите и перезапустите все вторичные реплики второй группы доступности (подчиненные). 
3. Обновите и перезапустите все вторичные реплики первой группы доступности (вышестоящие). 
4. Проведите отработку отказа первичной реплики сервера пересылки в обновленную вторичную реплику второй группы доступности.
5. Дождитесь синхронизации данных. Базы данных должны отображаться как синхронизированные во всех репликах с синхронной фиксаций, и глобальная первичная реплика должна быть синхронизирована с сервером пересылки.  
6. Обновите и перезапустите последний экземпляр второй группы доступности. 
7. Проведите отработку отказа глобальной первичной реплики в обновленную вторичную реплику первой группы доступности.  
8. Обновите последний экземпляр первой группы доступности.
9. Перезапустите обновленный сервер. 
10. (Необязательно) Восстановите в обеих группах доступности исходные первичные реплики.  

>[!IMPORTANT]
>- Между всеми шагами проверяйте, что синхронизация выполнена. Прежде чем перейти к следующему шагу, убедитесь, что реплики с синхронной фиксацией синхронизированы в группе доступности, а глобальная первичная реплика синхронизирована с сервером пересылки в распределенной группе доступности. 
>- **Рекомендация**. При каждой проверке синхронизации рекомендуется обновлять узел базы данных и узел распределенной группы доступности в SQL Server Management Studio. Когда все будет синхронизировано, создайте снимок экрана состояний каждой реплики. С его помощью вы сможете отслеживать, на каком шаге находитесь; перед переходом к следующему шагу он послужит подтверждением того, что все работает правильно, а при возникновении проблем поможет в устранении неполадок. 


### <a name="diagram-example-for-a-rolling-upgrade-of-a-distributed-availability-group"></a>Пример схемы последовательного обновления распределенной группы доступности

| группа доступности | Первичная реплика | Вторичная реплика|
| :------ | :----------------------------- |  :------ |
| ГД1 | УЗЕЛ1\ГД_SQL | УЗЕЛ2\ГД_SQL|
| ГД2 | УЗЕЛ3\ГД_SQL | УЗЕЛ4\ГД_SQL|
| Распределенная_ГД| Группа доступности 1 (глобальная) | Группа доступности 2 (сервер пересылки) |
| &nbsp; | &nbsp; | &nbsp; |

![Пример схемы распределенной группы доступности](media/upgrading-always-on-availability-group-replica-instances/rolling-upgrade-dag-diagram.png)


Инструкции по обновлению экземпляров по этой схеме 

1. Создайте резервную копию всех баз данных, включая системные и входящие в группу доступности. 
2. Обновите УЗЕЛ4\ГД_SQL (вторичную реплику группы доступности 2) и перезагрузите сервер. 
3. Обновите УЗЕЛ2\ГД_SQL (вторичную реплику группы доступности 1) и перезагрузите сервер. 
4. Проведите отработку отказа группы доступности 2 из УЗЕЛ3\ГД_SQL в УЗЕЛ4\ГД_SQL. 
5. Обновите УЗЕЛ3\ГД_SQL и перезагрузите сервер. 
6. Проведите отработку отказа группы доступности 1 из УЗЕЛ1\ГД_SQL в УЗЕЛ2\ГД_SQL. 
7. Обновите УЗЕЛ1\ГД_SQL и перезагрузите сервер. 
8. (Необязательно) Восстановите исходные первичные реплики.
    1. Проведите отработку отказа группы доступности 2 из УЗЕЛ4\ГД_SQL обратно в УЗЕЛ3\ГД_SQL.  
    2. Проведите отработку отказа группы доступности 1 из УЗЕЛ2\ГД_SQL обратно в УЗЕЛ1\ГД_SQL. 

Если в обеих группах доступности существует третья реплика, она будет обновлена до УЗЕЛ3\ГД_SQL и УЗЕЛ1\ГД_SQL. 

>[!IMPORTANT]
>- Между всеми шагами проверяйте, что синхронизация выполнена. Прежде чем перейти к следующему шагу, убедитесь, что реплики с синхронной фиксацией синхронизированы в группе доступности, а глобальная первичная реплика синхронизирована с сервером пересылки в распределенной группе доступности. 
>- Рекомендация. При каждой проверке синхронизации рекомендуется обновлять узел базы данных и узел распределенной группы доступности в SQL Server Management Studio. Когда все будет синхронизировано, создайте снимок экрана состояний каждой реплики. С его помощью вы сможете отслеживать, на каком шаге находитесь; перед переходом к следующему шагу он послужит подтверждением того, что все работает правильно, а при возникновении проблем поможет в устранении неполадок. 


## <a name="special-steps-for-change-data-capture-or-replication"></a>Особые действия для записи измененных данных или репликации

В зависимости от применяемого обновления для баз данных реплики группы доступности, включенных для записи измененных данных или репликации, могут потребоваться дополнительные действия. См. заметки о выпуске для обновления, чтобы определить необходимость выполнения приведенных далее шагов.

1. Обновление каждой вторичной реплики.

1. Перенос группы доступности на обновленный экземпляр после обновления всех вторичных реплик. 

1. Выполнение следующего запроса Transact-SQL на экземпляре, где размещена первичная реплика.

   ```sql
   EXECUTE [master].[sys].[sp_vupgrade_replication];
   ```

   >[!NOTE]
   >Выполнение этой команды может занять несколько минут. 

1. Обновление экземпляра, который изначально был первичной репликой.

Дополнительные сведения см. в статье [CDC functionality may break after upgrading to the latest](/archive/blogs/sql_server_team/cdc-functionality-may-break-after-upgrading-to-the-latest-cu-for-sql-server-2012-2014-and-2016) (Возможное нарушение функциональности записи измененных данных после обновления до последнего накопительного обновления).

  
## <a name="see-also"></a>См. также:  
 [Обновление до SQL Server 2016 с помощью мастера установки (программа установки)](../../../database-engine/install-windows/upgrade-sql-server-using-the-installation-wizard-setup.md)   

 [Установка SQL Server 2016 из командной строки](../../install-windows/install-sql-server-from-the-command-prompt.md)  
  
