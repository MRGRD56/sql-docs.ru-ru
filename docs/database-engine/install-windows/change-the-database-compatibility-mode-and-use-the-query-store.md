---
title: Использование хранилища запросов после обновления
description: В этой статье содержатся сведения об использовании хранилища запросов для определения базовых показателей и изменения уровня совместимости базы данных при обновлении SQL Server.
ms.custom: seo-lt-2019
ms.date: 12/13/2019
ms.prod: sql
ms.reviewer: ''
ms.technology: install
ms.topic: conceptual
helpviewer_keywords:
- query plans [SQL Server], migrating
- upgrading SQL Server, migrating query plans
- plan guides [SQL Server], migrating query plans
ms.assetid: 7e02a137-6867-4f6a-a45a-2b02674f7e65
author: cawrites
ms.author: chadam
monikerRange: '>=sql-server-2016||=sqlallproducts-allversions'
ms.openlocfilehash: a327b5aa82c11b3c0192b054e9b242f854b43818
ms.sourcegitcommit: 5a1ed81749800c33059dac91b0e18bd8bb3081b1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/23/2020
ms.locfileid: "96126032"
---
# <a name="change-the-database-compatibility-level-and-use-the-query-store"></a>Изменение уровня совместимости базы данных и использование хранилища запросов

[!INCLUDE [SQL Server -Windows Only](../../includes/applies-to-version/sql-windows-only.md)]

В [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)] и выше некоторые изменения становятся доступны только после того, как изменится [уровень совместимости базы данных](../../t-sql/statements/alter-database-transact-sql-compatibility-level.md). Это сделано по нескольким причинам:  
  
- Так как обновление является однократной операцией (версию формата файла понизить нельзя), выделение операции включения новых возможностей в отдельное действие является осмысленным. Впоследствии можно вернуть значение параметра на предыдущий уровень совместимости базы данных.  Новая модель сокращает количество операций, которые должны быть выполнены во время отказа системы.  
  
- Изменения в обработчике запросов могут иметь сложные последствия. Даже небольшое "удобное" изменение в системе, которое подойдет большинству рабочих нагрузок, может привести к неприемлемой регрессии в каком-либо важном запросе для других нагрузок. Отделение этой логики от процесса обновления позволяет таким компонентам, как хранилище запросов, быстро нивелировать регрессию, связанную с выбором плана, и даже полностью избежать подобных проблем в рабочей среде.  
  
> [!IMPORTANT]  
> При подключении или восстановлении базы данных, а также после обновления на месте в [!INCLUDE[ssSQL17](../../includes/sssql17-md.md)] ожидается описанное ниже поведение.
> - Если уровень совместимости пользовательской базы данных до обновления был 100 или выше, после обновления он останется таким же.    
> - Если уровень совместимости пользовательской базы данных до обновления был равен 90, в обновленной базе данных он получает значение 100, что соответствует минимальному поддерживаемому уровню совместимости в [!INCLUDE[ssSQL17](../../includes/sssql17-md.md)].    
> - После обновления уровням совместимости баз данных tempdb, model, msdb и Resource задается значение текущего уровня.   
> - Системная база данных master сохраняет уровень совместимости, который она имела до обновления.    
  
Процесс обновления для включения нового обработчика запросов относится к модели обслуживания, которая предназначена для периода после выпуска продукта.  Некоторые из этих исправлений выпущены под [флагом трассировки 4199](../../t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql.md#4199).  Клиенты, которым нужны эти исправления, могут принять их без риска непредвиденной регрессии для других клиентов. Модель обслуживания, предназначенная для периода после выпуска исправления обработчика запросов, описана [здесь](https://support.microsoft.com/kb/974006). Начиная с [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)], перемещение на новый уровень совместимости подразумевает ненужность флага трассировки 4199, так как эти исправления включаются по умолчанию в последнем режиме совместимости. Таким образом, в рамках процесса обновления важно убедиться, что после завершения обновления флаг 4199 не включен.  

> [!NOTE]
> Но флаг трассировки 4199 все еще нужен для внесения в обработчик запросов любых новых исправлений, выпущенных после RTM (если применимо).
  
Рекомендуемый рабочий процесс для установки последней версии кода в обработчике запросов представлен в разделе [Обеспечение стабильной производительности во время обновления до более новой версии раздела SQL Server "Сценарии использования хранилища запросов"](../../relational-databases/performance/query-store-usage-scenarios.md#CEUpgrade) ниже.  
  
![Схема рекомендуемого рабочего процесса для обновления до последней версии обработчика запросов.](../../relational-databases/performance/media/query-store-usage-5.png "хранилище запросов-использование-5") 

Начиная с [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] v18, помощник по настройке запросов может помочь пользователям в следовании рекомендуемому рабочему процессу. Дополнительные сведения: [Обновление баз данных с помощью помощника по настройке запросов](../../relational-databases/performance/upgrade-dbcompat-using-qta.md).
 
## <a name="see-also"></a>См. также:  
[Просмотр или изменение уровня совместимости базы данных](../../relational-databases/databases/view-or-change-the-compatibility-level-of-a-database.md)     
[Сценарии использования хранилища запросов](../../relational-databases/performance/query-store-usage-scenarios.md)     
[Уровень совместимости инструкции ALTER DATABASE &#40;Transact-SQL&#41;](../../t-sql/statements/alter-database-transact-sql-compatibility-level.md)     
[Обновление баз данных с помощью помощника по настройке запросов](../../relational-databases/performance/upgrade-dbcompat-using-qta.md)        
  
