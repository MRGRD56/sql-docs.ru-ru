---
title: Устранение неполадок при соединении с ядром СУБД SQL Server | Документы Майкрософт
description: Узнайте, как устранять неполадки подключения к инфраструктуре RHUI в Azure. Просмотрите действия, которые необходимо выполнить, если не удается использовать протокол TCP/IP для подключения к ядру СУБД SQL Server на одном сервере.
ms.custom: sqlfreshmay19
ms.date: 11/25/2019
ms.prod: sql
ms.prod_service: high-availability
ms.reviewer: ''
ms.technology: configuration
ms.topic: troubleshooting
helpviewer_keywords:
- troubleshooting, connecting to Database Engine
- connecting to Database Engine, troubleshooting
ms.assetid: 474c365b-c451-4b07-b636-1653439f4b1f
author: markingmyname
ms.author: maghan
ms.openlocfilehash: ceca51cf35e1a2e061d841336f0ab7a91b97dc9a
ms.sourcegitcommit: 2f868a77903c1f1c4cecf4ea1c181deee12d5b15
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/02/2020
ms.locfileid: "91670737"
---
# <a name="troubleshoot-connecting-to-the-sql-server-database-engine"></a>Устранение неполадок при соединении с ядром СУБД SQL Server.
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

В этой статье описаны методы поиска и устранения неполадок, при которых не удается подключиться к экземпляру ядра СУБД SQL Server на одиночном сервере.

>[!NOTE]
>Для других сценариев см. такие материалы:
>- [Прослушиватель группы доступности](../availability-groups/windows/listeners-client-connectivity-application-failover.md)
>- [Экземпляры отказоустойчивого кластера](../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md)

Порядок этих действий не соответствует последовательности, в которой решаются наиболее вероятные проблемы. Сначала указываются шаги по устранению базовых ошибок, а затем рассматриваются более сложные вопросы. При выполнении этих действий предполагается, что вы подключаетесь к экземпляру SQL Server с другого компьютера по протоколу TCP/IP — такая ситуация является наиболее распространенной.

Эти инструкции предназначены для устранения неполадок, связанных с ошибкой "**Подключение к серверу**" (например, `Error Number: 11001 (or 53), Severity: 20, State: 0`). В следующем примере показано сообщение об ошибке:

> `A network-related or instance-specific error occurred while establishing a connection to SQL Server. The server was not found or was not accessible. Verify that the instance name is correct and that SQL Server is configured to allow remote connections.`
>
> `(provider: Named Pipes Provider, error: 40 - Could not open a connection to SQL Server) (Microsoft SQL Server, Error: 53)`
>
> `(provider: TCP Provider, error: 0 - No such host is known.) (Microsoft SQL Server, Error: 11001)`

Эта ошибка обычно означает, что клиенту не удается найти экземпляр SQL Server. Обычно это происходит при наличии хотя бы одной из следующих проблем.

- Имя компьютера, на котором размещен SQL Server
- Экземпляр не разрешает правильный IP-адрес
- Номер TCP-порта указан неправильно

> [!TIP]
> Интерактивную страницу по устранению неполадок можно найти на сайте службы технической поддержки [!INCLUDE[msCoName_md](../../includes/msconame-md.md)] на странице [Solving Connectivity errors to SQL Server](https://support.microsoft.com/help/4009936/solving-connectivity-errors-to-sql-server) (Устранение ошибок подключения к SQL Server).

### <a name="not-included"></a>Ошибки, не описанные в статье

- В этой статье отсутствуют сведения об ошибках SSPI. Сведения об ошибках SSPI см. в разделе [How to troubleshoot the "Cannot generate SSPI context" error message](https://support.microsoft.com/kb/811889)(Исправление ошибки "Не удается создать контекст SSPI").
- В этой статье отсутствуют сведения об ошибках Kerberos. Справочные сведения см. в разделе [Диспетчер конфигурации Microsoft Kerberos для SQL Server](https://www.microsoft.com/download/details.aspx?id=39046).
- В этой статье отсутствуют сведения о подключении к базе данных SQL Azure. Справочные сведения см. в разделе [Устранение неполадок подключения с базой данных SQL Microsoft Azure](/azure/sql-database/troubleshoot-connectivity-issues-microsoft-azure-sql-database).

## <a name="get-instance-name-from-configuration-manger"></a>Получение имени экземпляра из диспетчера конфигурации

На сервере, на котором размещен экземпляр SQL Server, проверьте имя экземпляра. Используйте [диспетчер конфигурации SQL Server](../../relational-databases/sql-server-configuration-manager.md).

Диспетчер конфигурации автоматически устанавливается на компьютер при установке SQL Server. Инструкции по запуску диспетчера конфигурации могут незначительно отличаться в зависимости от версии SQL Server и Windows. Подробные сведения об определенных версиях см. в статье [Диспетчер конфигурации SQL Server](../../relational-databases/sql-server-configuration-manager.md).

1. Войдите на компьютер, на котором размещен экземпляр SQL Server.
1. Запустите диспетчер конфигурации SQL Server.
1. На левой панели выберите **Службы SQL Server**.
1. На правой панели проверьте имя экземпляра ядра СУБД.

   - `SQL SERVER (MSSQLSERVER)` — это экземпляр SQL Server по умолчанию. `<computer name>` — имя экземпляра по умолчанию.
   - `SQL SERVER (<instance name>)` — это именованный экземпляр SQL Server. `<computer name>\<instance name>` — имя именованного экземпляра.

## <a name="verify---the-instance-is-running"></a>Проверка выполнения экземпляра

Проверить, выполняется ли экземпляр, позволяет значок около экземпляра SQL Server в диспетчере конфигурации.

- Если экземпляр выполняется, отображается зеленая стрелка.
- Красный квадрат означает, что экземпляр остановлен.

Если экземпляр остановлен, щелкните его правой кнопкой мыши и выберите команду **Запустить**. Экземпляр будет запущен, и красный квадрат поменяется на зеленую стрелку.

## <a name="verify---sql-server-browser-service-is-running"></a><a name = "startbrowser"></a> Убедитесь, что служба обозревателя SQL Server запущена

Чтобы подключиться к именованному экземпляру, нужно запустить службу обозревателя SQL Server. В диспетчере конфигурации найдите службу **Обозреватель SQL Server** и проверьте, запущена ли она. Если нет, запустите ее. Служба обозревателя SQL Server не нужна для экземпляров по умолчанию.

Экземпляр SQL Server по умолчанию не требует службы обозревателя SQL Server.

## <a name="testing-a-local-connection"></a>Тестирование локального подключения

Перед устранением неполадки, связанной с подключением с другого компьютера, нужно проверить возможность подключения из клиентского приложения, установленного локально на компьютере, на котором запущен SQL Server. Локальное подключение позволяет избежать проблем, связанных с сетями и брандмауэрами. 

В этой процедуре используется среда SQL Server Management Studio. Если среда Management Studio не установлена, см. раздел [Скачивание SQL Server Management Studio (SSMS)](../../ssms/download-sql-server-management-studio-ssms.md). Если установить Management Studio не получается, вы можете проверить соединение с использованием служебной программы `sqlcmd.exe`. `sqlcmd.exe` устанавливается вместе с ядром СУБД. Дополнительные сведения о `sqlcmd.exe`см. в разделе [Программа sqlcmd](../../tools/sqlcmd-utility.md).)

1. Войдите на компьютер, на котором установлен SQL Server, с помощью имени входа с разрешением на доступ к SQL Server. (Во время установки для SQL Server требуется задать по меньшей мере одно имя входа в качестве администратора SQL Server. Если администратор неизвестен, см. сведения в статье [Подключение к SQL Server в случае, если доступ системных администраторов заблокирован](connect-to-sql-server-when-system-administrators-are-locked-out.md).)
1. На начальной странице введите **SQL Server Management Studio**. В более старых версиях Windows в меню "Пуск" выберите **Все программы**, **Microsoft SQL Server**, а затем щелкните **SQL Server Management Studio**.
1. В диалоговом окне **Соединение с сервером** в списке **Тип сервера** выберите **Ядро СУБД**. В поле **Проверка подлинности** выберите **Проверка подлинности Windows**. В поле **Имя сервера** задайте один из следующих типов подключения:

   |Подключение к|Тип|Пример|
   |:-----------------|:---------------|:-----------------|
   |Экземпляр по умолчанию|`<computer name>`|`ACCNT27`|
   |Именованный экземпляр|`<computer name\instance name>`|`ACCNT27\PAYROLL`|

   > [!NOTE]
   > При подключении к SQL Server из клиентского приложения на том же компьютере используется протокол общей памяти. Общая память — это тип локального именованного канала, поэтому иногда возникают ошибки, связанные с каналами.

   Если на данном этапе происходит ошибка, ее необходимо устранить и только затем продолжать работу. Существует целый ряд потенциальных проблем. Имя входа может не иметь разрешений для подключения. Может отсутствовать база данных по умолчанию.

   > [!NOTE]
   > В некоторых сообщениях об ошибках, передаваемых клиенту, намеренно отсутствуют сведения, необходимые для устранения неполадок. Это связано с обеспечением безопасности, так как в этом случае злоумышленник не может получить данные о SQL Server. Чтобы просмотреть полные сведения об ошибке, обратитесь к журналу ошибок SQL Server. Там вы найдете все подробности. 

1. Если возникает ошибка `18456 Login failed for user`, дополнительные сведения о кодах ошибки см. в описании ошибки [MSSQLSERVER_18456](../../relational-databases/errors-events/mssqlserver-18456-database-engine-error.md). Очень большой список кодов ошибок приведен в блоке Аарона Бертрана (Aaron Bertrand) в статье [Troubleshooting Error 18456](https://sqlblog.org/2011/01/14/troubleshooting-error-18456). Журнал ошибок можно просмотреть помощью среды SSMS (при наличии соединения) в разделе "Управление" обозревателя объектов. В противном случае журнал можно просмотреть с помощью программы Блокнот Windows. Расположение по умолчанию зависит от версии и может быть изменено во время установки. Расположением по умолчанию для [!INCLUDE[ssSQL15_md](../../includes/sssqlv15-md.md)] является `C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\Log\ERRORLOG`. 

1. Если соединение устанавливается с помощью общей памяти, проверьте его с использованием TCP. Вы можете принудительно задать TCP-подключение, указав `tcp:` перед именем. Пример:

   |Подключение к|Тип:|Пример|
   |-----------------|---------------|-----------------|
   |Экземпляр по умолчанию|`tcp:<computer name>`|`tcp:ACCNT27`|
   |Именованный экземпляр|`tcp:<computer name/instance name>`|`tcp:ACCNT27\PAYROLL`|

1. Если соединение устанавливается с помощью общей памяти, но не TCP, необходимо устранить проблему с TCP. Скорее всего, проблема в том, что TCP-протокол отключен. Сведения о включении TCP см. в разделе [Включение протоколов](#enableprotocols) выше.

1. Если вы хотите установить соединение с использованием учетной записи, отличной от учетной записи администратора, после соединения с правами администратора повторите попытку, используя имя входа для проверки подлинности Windows или имя входа для проверки подлинности SQL Server, которое будет применять клиентское приложение.

## <a name="get-the-ip-address-of-the-server"></a>Получение IP-адреса сервера

Получите IP-адрес компьютера, на котором размещен экземпляр SQL Server.

1. В меню "Пуск" щелкните **Выполнить**. В окне **Выполнить** введите **cmd**, а затем нажмите кнопку **ОК**.
1. В окне командной строки введите `ipconfig` и нажмите клавишу ВВОД. Запишите **IPv4** -адрес и **IPv6** -адрес.

  >SQL Server может использовать для подключения IP-протокол версии 4 или версии 6. В вашей сети может быть разрешен один из них или оба. Большинство пользователей начинает устранение неполадок с **IPv4** -адреса. Он короче и проще для ввода.

## <a name="get-the-sql-server-instance-tcp-port"></a><a name = "getTCP"></a>Получение данных о номере TCP-порта для экземпляра SQL Server

В большинстве случаев соединение с ядром СУБД SQL Server с другого компьютера устанавливается по протоколу TCP.

1. Используя SQL Server Management Studio на компьютере с SQL Server, подключитесь к экземпляру SQL Server. В обозревателе объектов разверните узел **Управление**, разверните **Журналы SQL Server**, а затем дважды щелкните текущий журнал.
2. В средстве просмотра журнала нажмите кнопку **Фильтр** на панели инструментов. В поле **Сообщение содержит текст** введите `server is listening on`, щелкните **Применить фильтр**, а затем — **ОК**.
3. Должно отобразится сообщение, подобное этому: `Server is listening on [ 'any' <ipv4> 1433]`. 

Сообщение означает, что этот экземпляр SQL Server прослушивает все IP-адреса на этом компьютере (для IP-протокола версии 4) и TCP-порт 1433. (TCP-порт 1433 — это порт, обычно используемый ядром СУБД или экземпляром SQL Server по умолчанию. Использовать порт может только один экземпляр SQL Server, поэтому если установлено несколько экземпляров SQL Server, некоторые из них должны работать с другими номерами портов.) Запишите номер порта, используемого экземпляром [!INCLUDE[ssNoVersion_md](../../includes/ssnoversion-md.md)], к которому вы пытаетесь подключиться.

  > [!NOTE]
  > Вероятно, что будет указан `IP address 127.0.0.1`. Это петлевой адрес адаптера. Использовать его для подключения могут только процессы, выполняющиеся на одном компьютере. Он может быть полезен при устранения неполадок, но не подходит для соединения с другого компьютера.

## <a name="enable-protocols"></a><a name = "enableprotocols"></a>Включение протоколов

В некоторых установках SQL Server соединение с компонентом Database Engine с другого компьютера не включено. Администратор может разрешить соединение с помощью диспетчера конфигурации. Чтобы разрешить соединения с других компьютеров, нужно выполнить указанные ниже действия.

1. Запустите диспетчер конфигурации SQL Server, как описано выше.
1. В диспетчере конфигурации на левой панели разверните узел **Сетевая конфигурация SQL Server**, а затем выберите экземпляр SQL Server, к которому нужно подключиться. На правой панели перечислены доступные протоколы соединений. Как правило, включена общая память. Ее можно использовать только на том же компьютере, поэтому в большинстве установок общая память остается включенной. Для подключения к SQL Server с другого компьютера обычно используется протокол TCP/IP. Если TCP/IP не включен, правой кнопкой мыши щелкните **TCP/IP**и выберите команду **Включить**.
1. Если включенный параметр для протокола был изменен, необходимо перезапустить ядро СУБД. На левой панели щелкните **Службы SQL Server**. На правой панели щелкните экземпляр Database Engine правой кнопкой мыши и выберите команду **Перезапустить**.

## <a name="testing-tcpip-connectivity"></a><a name="testTCPIP"></a>Тестирование подключения TCP/IP

Для подключения к SQL Server по протоколу TCP/IP требуется возможность установки соединения в Windows. Для тестирования TCP-подключения воспользуйтесь средством `ping` .

1. В меню "Пуск" щелкните **Выполнить**. В окне **Выполнить** введите **cmd**, а затем нажмите кнопку **ОК**. 
1. В окне командной строки введите `ping <ip address>` и IP-адрес компьютера, на котором запущен SQL Server. Пример:

    - IPv4: `ping 192.168.1.101`
    - IPv6: `ping fe80::d51d:5ab5:6f09:8f48%11`

1. Если сеть настроена правильно, команда `ping` возвращает `Reply from <IP address>` и некоторые дополнительные сведения. Если `ping` возвращает `Destination host unreachable` или `Request timed out`, TCP/IP настроен неправильно. На этом этапе ошибка может указывать на проблему с клиентским компьютером, компьютером сервера или сетевую проблему, например ошибку маршрутизатора. Сведения об устранении неполадок сети см в статье [Advanced troubleshooting for TCP/IP issues](/windows/client-management/troubleshoot-tcpip) (Устранение проблем TCP/IP повышенной сложности).
1. Затем, в случае успешной проверки связи с использованием IP-адреса, убедитесь, что имя компьютера может быть разрешено в TCP/IP-адрес. На клиентском компьютере в окне командной строки введите `ping` и имя компьютера, на котором запущен SQL Server. Например `ping newofficepc`. 
1. Если команда `ping` для IP-адреса выполняется успешно, но `ping` по имени компьютера возвращает `Destination host unreachable` или `Request timed out`, причиной могут быть устаревшие сведения о разрешении имен, сохраненные в кэше клиентского компьютера. Введите `ipconfig /flushdns` , чтобы очистить кэш DNS. Затем проверьте связь с компьютером по имени еще раз. Клиентский компьютер с пустым кэшем DNS будет проверять наличие последних сведения об IP-адресе компьютера сервера. 
1. Если сеть настроена правильно, команда `ping` возвращает `Reply from <IP address>` и некоторые дополнительные сведения. Если проверка связи с компьютером сервера по IP-адресу выполняется успешно, а при проверке связи по имени компьютера выдается сообщение об ошибке `Destination host unreachable.` или `Request timed out.`, разрешение имен настроено неправильно. (Дополнительные сведения см. в упомянутой ранее статье 2006 г. [How to Troubleshoot Basic TCP/IP Problems](https://support.microsoft.com/kb/169790) (Устранение основных проблем с TCP/IP).) Для подключения к SQL Server успешное разрешение имен не требуется, но если не удается разрешить имя компьютера в IP-адрес, выполнять подключения следует с указанием IP-адреса. Разрешение имен можно исправить позже.

## <a name="open-a-port-in-the-firewall"></a>Открытие порта в брандмауэре

По умолчанию брандмауэр Windows включен и блокирует подключения с другого компьютера. Чтобы подключиться с использованием протокола TCP/IP с другого компьютера, на компьютере SQL Server необходимо настроить брандмауэр для разрешения подключений к TCP-порту, используемому компонентом Database Engine. Экземпляр по умолчанию прослушивает по умолчанию TCP-порт 1433. Если запущены именованные экземпляры или вы изменили значение по умолчанию, TCP-порт [!INCLUDE[ssNoVersion_md](../../includes/ssnoversion-md.md)] может прослушивать другой порт. См. раздел [Получение данных о номере TCP-порта для экземпляра SQL Server](#getTCP).

При подключении к именованному экземпляру или порту, отличному от TCP-порта 1433, необходимо также открыть UDP-порт 1434 для службы обозревателя SQL Server. Пошаговые инструкции об открытии порта в брандмауэре Windows см. в разделе [Настройка брандмауэра Windows для доступа к компоненту Database Engine](configure-a-windows-firewall-for-database-engine-access.md).

## <a name="test-the-connection"></a>Проверка подключения

После того как появилась возможность соединения с использованием TCP на том же компьютере, нужно проверить подключение с клиентского компьютера. Теоретически можно использовать любое клиентское приложение, но чтобы избежать дополнительных сложностей, установите средства управления SQL Server на клиентском компьютере и попытайтесь запустить среду SQL Server Management Studio.

1. На клиентском компьютере с помощью среды SQL Server Management Studio попробуйте подключиться, используя IP-адрес и номер TCP-порта в формате "IP-адрес, номер порта". Например, `192.168.1.101,1433`. Если этот вариант не работает, вероятно, возникла одна из таких проблем:

   - Запрос `ping` по IP-адресу не работает, что указывает на наличие общей проблемы конфигурации TCP. Вернитесь к разделу [Тестирование подключения TCP/IP](#testTCPIP).
   - SQL Server не прослушивает протокол TCP. Вернитесь к разделу [Включение протоколов](#enableprotocols).
   - SQL Server прослушивает порт, отличный от указанного порта. Вернитесь к разделу [Получение данных о номере TCP-порта для экземпляра SQL Server](#getTCP).
   - TCP-порт SQL Server блокируется брандмауэром. Вернитесь к разделу [Открытие порта в брандмауэре](#open-a-port-in-the-firewall).

2. Если вы можете подключиться с помощью IP-адреса и номера порта, попробуйте подключиться, используя IP-адрес без указания номера порта. Для экземпляра по умолчанию просто используйте IP-адрес. Для именованного экземпляра используйте IP-адрес и имя экземпляра в формате "IP-адрес\имя экземпляра", например `192.168.1.101\<instance name>`. Если этот вариант не работает, вероятно, возникла одна из следующих проблем:

   - Если вы подключаетесь к экземпляру по умолчанию, оно может прослушивать порт, отличный от TCP-порта 1433, и клиент не пытается подключиться к правильному номеру порта.
   - Если вы подключаетесь к именованному экземпляру, номер порта не возвращается клиенту.

   Обе эти проблемы связаны со службой обозревателя SQL Server, которая предоставляет клиенту номер порта. Далее приводятся возможные решения.

   - Запустите службу обозревателя SQL Server. См. инструкции по [запуску обозревателя в диспетчере конфигурации SQL Server](#startbrowser).
   - Служба обозревателя SQL Server блокируется брандмауэром. Откройте UDP-порт 1434 в брандмауэре. Вернитесь к разделу [Открытие порта в брандмауэре](#open-a-port-in-the-firewall). Убедитесь, что вы открываете UDP-порт, а не TCP-порт.
   - Данные о UDP-порте 1434 блокируются маршрутизатором. UDP-соединения (протокол UDP) не предназначены для передачи через маршрутизаторы. Это исключает попадание трафика с низким приоритетом в сеть. Вы можете настроить маршрутизатор для пересылки UDP-трафика или же всегда указывать номер порта при подключении.
   - Если клиентский компьютер работает под управлением Windows 7 или Windows Server 2008 (или более поздней операционной системы), ОС может отбрасывать UDP-трафик, поскольку ответ с сервера возвращается с IP-адреса, отличного от запрошенного. Это функция безопасности, блокирующая свободное сопоставление источника. Дополнительные сведения см. в разделе **Сервер с несколькими IP-адресами** статьи электронной документации [Устранение неполадок. Время ожидания истекло](/previous-versions/sql/sql-server-2008-r2/ms190181(v=sql.105)). Это статья о SQL Server 2008 R2, но ее основные тезисы можно применить также к рассматриваемому вопросу. Вы можете настроить клиент для использования правильного IP-адреса или же всегда указывать номер порта при подключении.

3. Если вы можете установить соединение с помощью IP-адреса (или IP-адреса и имени экземпляра именованного экземпляра), попробуйте подключиться с помощью имени компьютера (или имени компьютера и имени экземпляра именованного экземпляра). Чтобы принудительно установить подключение TCP/IP, укажите `tcp:` перед именем компьютера. Например, для экземпляра по умолчанию на компьютере с именем `ACCNT27`используйте `tcp:ACCNT27` . Для именованного экземпляра `PAYROLL`на этом компьютере используйте `tcp:ACCNT27\PAYROLL` . Если можно подключиться с помощью IP-адреса, но не имени компьютера, то существует проблема с разрешением имени. Вернитесь к разделу **Тестирование подключения TCP/IP**, подраздел 4.

4. Если вы можете подключиться с помощью имени компьютера, активирующего TCP, попробуйте подключиться с использованием имени компьютера, но без принудительной активации TCP. Например, для экземпляра по умолчанию используйте только имя компьютера, например `CCNT27`. Для именованного экземпляра используйте имя компьютера и имя экземпляра, например `ACCNT27\PAYROLL`. Если вы можете установить соединение с активацией TCP, но не можете без активации TCP, возможно, клиент использует другой протокол (например, именованные каналы).

    1. На клиентском компьютере в левой панели диспетчера конфигурации SQL Server разверните узел **Конфигурация** клиента **SQL Native Client** *версия*, а затем выберите **Клиентские протоколы**.
    2. Убедитесь, что протокол TCP/IP на правой панели включен. Если протокол TCP/IP не включен, правой кнопкой мыши щелкните **TCP/IP** и выберите команду **Включить**.
    3. Убедитесь в том, что в последовательности протоколов TCP/IP используются значения, меньше чем для протоколов именованных каналов (или протоколов VIA в более старых версиях). Обычно общая память должна быть указана как первый порядок, а TCP/IP — как второй. Общая память используется только в том случае, когда клиент и сервер SQL выполняются на том же компьютере. Все включенные протоколы опрашиваются в указанном порядке до получения успешного результата. Следует отметить, что при установке соединения с другим компьютером общая память пропускается.