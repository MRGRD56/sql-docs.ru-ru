---
title: Обновление доставки журналов до SQL Server 2016 и более поздних версий
description: Изучите соответствующий порядок, чтобы сохранить решение аварийного восстановления доставки журналов при обновлении до SQL Server 2016 и более поздних версий с предыдущей версии.
ms.custom: seo-lt-2019
ms.date: 02/01/2016
ms.prod: sql
ms.reviewer: ''
ms.technology: log-shipping
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], upgrading
ms.assetid: b1289cc3-f5be-40bb-8801-0e3eed40336e
author: cawrites
ms.author: chadam
ms.openlocfilehash: 0b3e98cc2f5ce76093f3710f6f49e1b186219c04
ms.sourcegitcommit: 370cab80fba17c15fb0bceed9f80cb099017e000
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/17/2020
ms.locfileid: "97643856"
---
# <a name="upgrading-log-shipping-to-sql-server-2016-transact-sql"></a>Обновление доставки журналов до SQL Server 2016 (Transact-SQL)
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]
  Если вы обновляете конфигурацию доставки журналов [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] до новой версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] либо устанавливаете новый пакет обновления [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] или накопительный пакет обновления [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], обновление серверов доставки журналов в правильном порядке позволит сохранить ваше решение для аварийного восстановления доставки журналов.  
  
> [!NOTE]  
>  [Сжатие резервной копии](../../relational-databases/backup-restore/backup-compression-sql-server.md) было введено в выпуске [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)]. В обновленной конфигурации доставки журналов используется параметр **стандартного сжатия резервных копий** уровня сервера, который управляет применением сжатия резервной копии к файлам резервной копии журнала транзакций. Режим сжатия резервной копии журналов можно указать отдельно для каждой конфигурации доставки журналов. Дополнительные сведения см. в разделе [Настройка доставки журналов (SQL Server)](../../database-engine/log-shipping/configure-log-shipping-sql-server.md).  
  
 **В этом разделе:**  
  
-   [Предварительные требования](#Prerequisites)  
  
-   [Защита данных перед обновлением](#ProtectData)  
  
-   [Обновление экземпляра сервера мониторинга](#UpgradeMonitor)  
  
-   [Обновление экземпляра сервера-получателя](#UpgradeSecondaries)  
  
-   [Обновление экземпляра сервера-источника](#UpgradePrimary)  
  
##  <a name="prerequisites"></a><a name="Prerequisites"></a> Предварительные требования  
 Перед установкой ознакомьтесь со следующими важными сведениями.  
  
-   [Supported Version and Edition Upgrades](../../database-engine/install-windows/supported-version-and-edition-upgrades.md). Убедитесь, что текущая версия операционной системы Windows позволяет обновить текущую версию SQL Server до версии SQL Server 2016. Например, вы не можете напрямую обновить экземпляр SQL Server 2005 до [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].  
  
-   [Choose a Database Engine Upgrade Method](../../database-engine/install-windows/choose-a-database-engine-upgrade-method.md). Выберите подходящий метод обновления с учетом сведений о поддерживаемых версиях и обновлениях выпуска, а также компонентах, установленных в среде и требующих обновления (это нужно, чтобы обеспечить правильный порядок обновления этих компонентов).  
  
-   [Составление и тестирование плана обновления Database Engine](../../database-engine/install-windows/plan-and-test-the-database-engine-upgrade-plan.md). Просмотрите заметки о выпуске и известные проблемы, связанные с обновлением, изучите контрольный список предварительных требований, а затем разработайте и протестируйте план обновления.  
  
-   [Требования к оборудованию и программному обеспечению для установки SQL Server 2016](../../sql-server/install/hardware-and-software-requirements-for-installing-sql-server.md). Ознакомьтесь с требованиями к оборудованию и ПО для установки [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]. Если требуется дополнительное программное обеспечение, установите его на каждом узле перед запуском обновления, чтобы минимизировать время простоя.  
  
##  <a name="protect-your-data-before-the-upgrade"></a><a name="ProtectData"></a> Защита данных перед обновлением  
 Рекомендуется защищать данные перед обновлением доставки журналов.  
  
 **Защита данных**  
  
1.  Создайте полную резервную копию каждой базы данных-источника.  
  
     Дополнительные сведения см. в разделе [Создание полной резервной копии базы данных (SQL Server)](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md).  
  
2.  Выполните команду [DBCC CHECKDB](../../t-sql/database-console-commands/dbcc-checkdb-transact-sql.md) в каждой базе данных-источнике.  
  
> [!IMPORTANT]  
>  Убедитесь, что на сервере-источнике достаточно места для хранения резервных копий журналов в течение всего периода возможного обновления серверов-получателей.  При отработке отказа на сервер-получатель аналогичные требования распространяются и на сервер-получатель (новый сервер-источник).  
  
##  <a name="upgrading-the-optional-monitor-server-instance"></a><a name="UpgradeMonitor"></a> Обновление экземпляра сервера мониторинга (необязательное)  
 Существующий экземпляр сервера мониторинга можно обновить в любой момент. Тем не менее нет необходимости обновлять необязательный сервер мониторинга при обновлении сервера-источника и сервера-получателя.  
  
 При обновлении сервера мониторинга конфигурация доставки журналов продолжает работать, но ее состояние не записывается в таблицы мониторинга. В процессе обновления сервера мониторинга не будут срабатывать никакие настроенные предупреждения. После обновления можно обновить сведения в таблицах наблюдения. Для этого следует выполнить системную хранимую процедуру [sp_refresh_log_shipping_monitor](../../relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql.md).   Дополнительные сведения о сервере мониторинга см. в статье [Сведения о доставке журналов](../../database-engine/log-shipping/about-log-shipping-sql-server.md){3}(SQL Server){4}.  
  
##  <a name="upgrading-the-secondary-server-instances"></a><a name="UpgradeSecondaries"></a> Обновление экземпляра сервера-получателя  
 Перед обновлением экземпляра сервера-источника экземпляры сервера-получателя [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] обновляются до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] . Всегда обновляйте сначала экземпляры сервера-получателя [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] . Доставка журналов продолжается и во время обновления, поскольку экземпляры обновленных серверов-получателей продолжают восстанавливать журналы из резервных копий с экземпляра сервера-источника [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] . Если экземпляр сервера-источника обновить до обновления экземпляра сервера-получателя, то доставка журналов станет невозможна, так как более старую версию [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] нельзя восстановить из резервной копии, созданной в новой версии [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Обновлять экземпляры серверов-получателей можно одновременно или последовательно, но все экземпляры серверов-получателей должны быть обновлены до начала обновления экземпляра сервера-источника, иначе возможны сбои доставки журналов.  
  
 Пока идет обновление экземпляра сервера-получателя, копия доставки журналов и задания восстановления не выполняются. Это означает накопление невосстановленных резервных копий журналов транзакций на сервере-источнике. В результате потребуется предусмотреть достаточно места для хранения этих невосстановленных копий. Количество этих копий зависит от частоты планового резервного копирования на экземпляре сервера-источника, а также от последовательности обновления экземпляров серверов-получателей. Кроме того, если настроен отдельный сервер мониторинга, то могут возникать предупреждения о том, что восстановление не выполнялось дольше установленного интервала.  
  
 Сразу после обновления экземпляров серверов-получателей задания агентов доставки журналов возобновляют работу и продолжают копирование и восстановление резервных копий журналов с экземпляра сервера-источника на экземпляр сервера-получателя. Время, которое необходимо экземпляру сервера-получателя для перевода базы данных сервера-получателя в актуальное состояние, зависит от времени, затраченного на обновление экземпляра сервера-получателя и частоты резервного копирования на сервере-источнике.  
  
> [!NOTE]  
>  В процессе обновления сервера база данных-получатель не обновляется до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] . База данных обновится, только если подключить ее к сети путем запуска отработки отказа для базы данных, в которую доставляются журналы. Теоретически это условие может сохраняться бесконечно. Для обновления метаданных базы данных после запуска отработки отказа требуется немного времени.  
  
> [!IMPORTANT]  
>  Параметр RESTORE WITH STANDBY не поддерживается для базы данных, требующей обновления. Если обновленная база данных-получатель была настроена при помощи RESTORE WITH STANDBY, то журналы транзакций нельзя восстановить после обновления. Чтобы возобновить доставку журналов на базу данных-получатель, необходимо заново настроить доставку журналов на резервном сервере. Дополнительные сведения о параметре STANDBY см. в статье [Восстановление резервной копии журнала транзакций (SQL Server)](../../relational-databases/backup-restore/restore-a-transaction-log-backup-sql-server.md).  
  
##  <a name="upgrading-the-primary-server-instance"></a><a name="UpgradePrimary"></a> Обновление экземпляра сервера-источника  
 Так как доставка журналов в первую очередь является решением для аварийного восстановления, то простейшим и наиболее распространенным сценарием является обновление экземпляра сервера-источника на месте. При этом база данных просто становится недоступной на время обновления. Как только обновление сервера завершается, база данных автоматически переводится обратно в режим «в сети», в результате чего обновляется сама. После обновления базы данных возобновляют работу задания доставки журналов.  
  
> [!NOTE]  
>  Доставка журналов также поддерживает возможность [перехода на вторичный сервер доставки журналов (SQL Server)](../../database-engine/log-shipping/fail-over-to-a-log-shipping-secondary-sql-server.md), а также [обмена ролями между сервером-источником и сервером-получателем доставки журналов (SQL Server)](../../database-engine/log-shipping/change-roles-between-primary-and-secondary-log-shipping-servers-sql-server.md). Но поскольку доставка журналов в настоящее время редко настраивается как решение высокой доступности (новые подходы являются гораздо более устойчивыми), отработка отказа не сокращает время простоя. Это связано с тем, что системные объекты базы данных не синхронизируются, а предоставление клиентам простого поиска резервного сервера-получателя и подключения к нему может стать проблемой.  
  
## <a name="see-also"></a>См. также:  
 [Обновление до SQL Server 2016 с помощью мастера установки (программа установки)](../../database-engine/install-windows/upgrade-sql-server-using-the-installation-wizard-setup.md)   
 [Установка SQL Server 2016 из командной строки](../install-windows/install-sql-server-from-the-command-prompt.md)   
 [Настройка доставки журналов (SQL Server)](../../database-engine/log-shipping/configure-log-shipping-sql-server.md)   
 [Наблюдение за доставкой журналов (Transact-SQL)](../../database-engine/log-shipping/monitor-log-shipping-transact-sql.md)   
 [Таблицы доставки журналов и хранимые процедуры](../../database-engine/log-shipping/log-shipping-tables-and-stored-procedures.md)  
  
