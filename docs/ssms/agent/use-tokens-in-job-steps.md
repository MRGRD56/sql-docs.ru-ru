---
description: Использование токенов в шагах задания
title: Использование токенов в шагах задания
ms.custom: seo-lt-2019
ms.date: 01/19/2017
ms.prod: sql
ms.prod_service: sql-tools
ms.technology: ssms
ms.topic: conceptual
helpviewer_keywords:
- job steps [SQL Server Agent]
- security [SQL Server Agent], enabling alert job step tokens
- SQL Server Agent jobs, job steps
- tokens [SQL Server]
- escape macros [SQL Server Agent]
ms.assetid: 105bbb66-0ade-4b46-b8e4-f849e5fc4d43
author: markingmyname
ms.author: maghan
ms.reviewer: ''
monikerRange: = azuresqldb-mi-current || >= sql-server-2016 || = sqlallproducts-allversions
ms.openlocfilehash: f222f011015f4cf23cf4640b7c4bc2136d338583
ms.sourcegitcommit: 22dacedeb6e8721e7cdb6279a946d4002cfb5da3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/14/2020
ms.locfileid: "92037267"
---
# <a name="use-tokens-in-job-steps"></a>Использование токенов в шагах задания
[!INCLUDE [SQL Server SQL MI](../../includes/applies-to-version/sql-asdbmi.md)]

> [!IMPORTANT]  
> В [Управляемом экземпляре Azure SQL](/azure/sql-database/sql-database-managed-instance) в настоящее время поддерживается большинство функций агента SQL Server (но не все). Подробные сведения см. в статье [Различия в T-SQL между Управляемым экземпляром SQL Azure и SQL Server](/azure/sql-database/sql-database-managed-instance-transact-sql-information#sql-server-agent).

[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Агент позволяет применять токены в скриптах шагов заданий на языке [!INCLUDE[tsql](../../includes/tsql-md.md)] . Применение токенов при написании шагов заданий обеспечивают такую же гибкость, какую дают переменные при написании программ. После добавления токена в скрипт шага задания агент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] замещает токен во время выполнения, до того как шаг задания выполняется подсистемой [!INCLUDE[tsql](../../includes/tsql-md.md)]  
  
  
## <a name="understanding-using-tokens"></a>Основные сведения об использовании токенов  
  
> [!IMPORTANT]  
> Все пользователи Windows с разрешением на запись в журнал событий Windows могут получить доступ к шагам заданий, которые активированы предупреждениями агента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] или инструментария WMI. Чтобы избежать этого нарушения безопасности, в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] токены агента, которые могут использоваться в заданиях, активированных предупреждениями, по умолчанию отключены. Такими токенами являются **A-DBN**, **A-SVR**, **A-ERR**, **A-SEV**, **A-MSG** и **WMI(** _property_ **)** . Обратите внимание, что в этом выпуске использование токенов распространяется на все оповещения.  
>   
> Если необходимо использовать эти токены, убедитесь, что только члены доверенных групп безопасности Windows, таких как группа «Администраторы», обладают разрешением на работу с журналом событий компьютера, на котором находится [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] . Затем, чтобы включить эти токены, щелкните правой кнопкой мыши элемент **Агент SQL Server** в обозревателе объектов, выберите пункт меню **Свойства**и на странице **Система предупреждений** установите флажок **Заменить токены всех ответов заданий на предупреждения** .  
  
[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Замена токена агента выполняется просто и эффективно: агент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] заменяет токен точным строковым литералом. Все токены обрабатываются с учетом регистра. Шаги заданий должны это учитывать для учетной записи и правильно заключать в кавычки применяемые токены или преобразовывать замещающие строки к верному типу данных.  
  
Например, чтобы напечатать имя базы данных в шаге задания, можно использовать следующую инструкцию:  
  
`PRINT N'Current database name is $(ESCAPE_SQUOTE(A-DBN))' ;`  
  
В этом примере макрос **ESCAPE_SQUOTE** добавляется с токеном **A-DBN** . Во время выполнения токен **A-DBN** будет заменен соответствующим именем базы данных. Управляющий макрос экранирует все одиночные кавычки, которые случайно передаются в строку замещения токена. [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Агент заместит символ одиночной кавычки двумя одиночными кавычками в конечной строке.  
  
Например, если замещающая токен строка `AdventureWorks2012'SELECT @@VERSION --`, то команда, выполняемая агентом [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] имеет вид:  
  
`PRINT N'Current database name is AdventureWorks2012''SELECT @@VERSION --' ;`  
  
В этом случае добавленная инструкция `SELECT @@VERSION`не выполняется. Вместо этого, дополнительный символ одинарной кавычки заставляет сервер анализировать передаваемую инструкцию как строку. Если замещающая токен строка не содержит одинарных кавычек, то никакие символы не экранируются и шаг задания, содержащий токен, выполняется так, как и планировалось.  
  
Чтобы отладить использование токенов в шагах заданий, используйте инструкции вывода на печать, такие как `PRINT N'$(ESCAPE_SQUOTE(SQLDIR))'` и сохраняйте выходные данные шага задания в файл или таблицу. Используйте страницу **Дополнительно** диалогового окна **Свойства шага задания** , чтобы указать выходной файл или таблицу для шага задания.  
  
## <a name="sql-server-agent-tokens-and-macros"></a>Токены и макросы агента SQL Server  
В следующей таблице перечислены и описаны токены и макросы, которые поддерживает агент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .  
  
### <a name="sql-server-agent-tokens"></a>Токены агента SQL Server  
  
|Токен|Описание|  
|---------|---------------|  
|**(A-DBN)**|имя базы данных. Если задание запускается в результате предупреждения, то имя базы данных автоматически замещает в шаге задания этот токен.|  
|**(A-SVR)**|Имя сервера. Если задание запускается в результате предупреждения, то имя сервера автоматически замещает в шаге задания этот токен.|  
|**(A-ERR)**|Номер ошибки. Если задание запускается в результате предупреждения, то номер ошибки автоматически замещает в шаге задания этот токен.|  
|**(A-SEV)**|Серьезность ошибки. Если задание запускается в результате предупреждения, то степень серьезности ошибки автоматически замещает в шаге задания этот токен.|  
|**(A-MSG)**|Текст сообщения. Если задание запускается в результате предупреждения, то текст сообщения автоматически замещает в шаге задания этот токен.|  
|**(JOBNAME)**|Имя задания. Этот токен доступен только в SQL Server 2016 и более поздних версиях.|  
|**(STEPNAME)**|Имя шага этапа. Этот токен доступен только в SQL Server 2016 и более поздних версиях.|  
|**(DATE)**|Текущая дата (в формате ГГГГММДД).|  
|**(INST)**|Имя экземпляра. Для экземпляра по умолчанию этот токен будет иметь имя экземпляра по умолчанию, а именно MSSQLSERVER.|  
|**(JOBID)**|Идентификатор задания.|  
|**(MACH)**|Имя компьютера.|  
|**(MSSA)**|Имя главной службы SQLServerAgent.|  
|**(OSCMD)**|Префикс для программы, используемой для запуска шагов задания **CmdExec** .|  
|**(SQLDIR)**|Каталог, в котором установлен [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] . Значение по умолчанию — «C:\Program Files\Microsoft SQL Server\MSSQL».|  
|**(SQLLOGDIR)**|Токен замены для пути к папке журнала ошибок SQL Server, например $(ESCAPE_SQUOTE(SQLLOGDIR)). Этот токен доступен только в SQL Server 2014 и более поздних версиях.|  
|**(STEPCT)**|Количество выполнений этого шага (кроме повторных попыток). Может применяться командой шага для принудительного прекращения цикла из нескольких шагов.|  
|**(STEPID)**|Идентификатор шага.|  
|**(SRVR)**|Имя компьютера, на котором выполняется [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. В случае именованного экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] имя компьютера включается в имя экземпляра.|  
|**(TIME)**|Текущее время (в формате ЧЧММСС).|  
|**(STRTTM)**|Время запуска задания (в формате ЧЧММСС).|  
|**(STRTDT)**|Дата запуска задания (в формате ГГГГММДД).|  
|**(WMI(** _свойство_ **))**|Для заданий, запускаемых в ответ на предупреждение инструментария WMI, значение свойства указывается параметром *свойство*. Например, маркер `$(WMI(DatabaseName))` предоставляет значение для свойства **DatabaseName** в событии инструментария WMI, которое вызвало предупреждение.|  
  
### <a name="sql-server-agent-escape-macros"></a>Экранирующие макросы агента SQL Server  
  
|Экранирующие макросы|Описание|  
|-----------------|---------------|  
|**$(ESCAPE_SQUOTE(** _token\_name_ **))**|Экранирует символы одинарных кавычек (') в строке замещения токена. Замещает символ одинарной кавычки двумя символами одинарной кавычки.|  
|**$(ESCAPE_DQUOTE(** _token\_name_ **))**|Экранирует символы двойных кавычек (") в строке замещения токена. Замещает символ двойных кавычек двумя символами двойных кавычек.|  
|**$(ESCAPE_RBRACKET(** _token\_name_ **))**|Экранирует символы правой квадратной скобки (]) в строке замещения токена. Замещает один символ правой квадратной скобки двумя символами правой квадратной скобки.|  
|**$(ESCAPE_NONE(** _token\_name_ **))**|Замещает токен, не экранируя никакие символы строки. Этот макрос предоставлен для поддержки обратной совместимости в окружениях, где строки замещения токена ожидаются только от надежных пользователей. Дополнительные сведения см. в подразделе «Обновление шагов заданий для использования маркеров» далее в этом разделе.|  
  
## <a name="updating-job-steps-to-use-macros"></a>Обновление шагов заданий для использования маркеров  
Следующая таблица показывает, каким образом замена токенов обрабатывается агентом [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] . Чтобы включить или отключить замену токенов предупреждений, щелкните правой кнопкой мыши элемент **Агент SQL Server** в обозревателе объектов, выберите пункт меню **Свойства**и на странице **Система предупреждений** установите или снимите флажок **Заменить токены всех ответов заданий на предупреждения** .  
  
|Синтаксис токена|Предупреждение о замене токенов включено|Предупреждение о замене токенов отключено|  
|----------------|------------------------------|-------------------------------|  
|Управляющие макросы используются|Все токены в заданиях заменяются успешно.|Токены, активированные предупреждениями, не заменяются. К этим токенам относятся: **A-DBN**, **A-SVR**, **A-ERR**, **A-SEV**, **A-MSG**и **WMI(** _свойство_ **)** . Другие статические токены заменяются успешно.|  
|Управляющие макросы не используются|Все задания, содержащие токены, завершаются сбоем.|Все задания, содержащие токены, завершаются сбоем.|  
  
## <a name="token-syntax-update-examples"></a>Примеры обновления синтаксиса токенов  
  
### <a name="a-using-tokens-in-non-nested-strings"></a>A. Использование токенов в невложенных строках  
В следующем примере показано, как обновить простой скрипт без вложенных строк соответствующим управляющим маркером. До выполнения обновляющего скрипта следующий скрипт шага задания использует токен шага задания, чтобы напечатать соответствующее имя базы данных:  
  
`PRINT N'Current database name is $(A-DBN)' ;`  
  
После выполнения обновляющего скрипта макрос `ESCAPE_NONE` добавляется перед токеном `A-DBN` . Так как для отделения строки печати используются одинарные кавычки, необходимо обновить шаг задания, добавив макрос `ESCAPE_SQUOTE` следующим образом:  
  
`PRINT N'Current database name is $(ESCAPE_SQUOTE(A-DBN))' ;`  
  
### <a name="b-using-tokens-in-nested-strings"></a>Б. Использование токенов во вложенных строках  
В скриптах шагов заданий, где токены используются во вложенных строках или инструкциях, перед добавлением соответствующих управляющих токенов следует переписать вложенные инструкции в виде нескольких инструкций.  
  
Например, рассмотрим следующий шаг задания, в котором используется токен `A-MSG` и который не был обновлен с помощью управляющего макроса:  
  
`PRINT N'Print ''$(A-MSG)''' ;`  
  
После выполнения обновляющего скрипта макрос `ESCAPE_NONE` добавляется с токеном. Однако в этом случае необходимо переписать скрипт, чтобы не использовалось вложение, как показано ниже, и добавить макрос `ESCAPE_SQUOTE` , чтобы правильным образом экранировать разделители, которые могут быть переданы в строку замены токена:  
  
```sql
DECLARE @msgString nvarchar(max);
SET @msgString = '$(ESCAPE_SQUOTE(A-MSG))';
SET @msgString = QUOTENAME(@msgString,'''');
PRINT N'Print ' + @msgString;
```
  
Имейте в виду, что функция QUOTENAME устанавливает символ кавычки.  
  
### <a name="c-using-tokens-with-the-escape_none-macro"></a>В. Использование токенов с макросом ESCAPE_NONE  
Следующий пример является частью скрипта, который извлекает `job_id` из таблицы `sysjobs` и использует токен `JOBID` , чтобы заполнить переменную `@JobID` , которая была объявлена как бинарный тип данных ранее в скрипте. Имейте в виду, что с токеном `ESCAPE_NONE` используется макрос `JOBID` , так как для бинарного типа данных разделители не требуются. После выполнения скрипта обновления не нужно обновлять этот шаг задания.  
  
```sql
SELECT * FROM msdb.dbo.sysjobs  
WHERE @JobID = CONVERT(uniqueidentifier, $(ESCAPE_NONE(JOBID)));
```
  
## <a name="see-also"></a>См. также:  
[Реализация заданий](../../ssms/agent/implement-jobs.md)  
[Управление шагами задания](../../ssms/agent/manage-job-steps.md)  
