---
title: Развертывание нескольких кластеров в домене Active Directory
titleSuffix: SQL Server Big Data Cluster
description: Узнайте, как развернуть несколько кластеров больших данных SQL Server в одном домене Active Directory.
author: cloudmelon
ms.author: melqin
ms.reviewer: mikeray
ms.date: 09/30/2020
ms.topic: conceptual
ms.prod: sql
ms.technology: big-data-cluster
ms.openlocfilehash: a8b82b4a5802467841ca345ac24c83e1356a79f8
ms.sourcegitcommit: 917df4ffd22e4a229af7dc481dcce3ebba0aa4d7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/10/2021
ms.locfileid: "100040134"
---
# <a name="deploy-multiple-big-data-clusters-2019-in-the-same-active-directory-domain"></a>Развертывание нескольких [!INCLUDE[big-data-clusters-2019](../includes/ssbigdataclusters-ss-nover.md)] в одном домене Active Directory

[!INCLUDE[SQL Server 2019](../includes/applies-to-version/sqlserver2019.md)]

В этой статье описываются обновления для SQL Server 2019 CU5, которые позволяют развертывать и интегрировать несколько кластеров больших данных SQL Server 2019 с одним доменом Active Directory.

До пакета обновлений SQL 2019 CU5 существовали две проблемы, которые мешали развертыванию нескольких кластеров больших данных в домене AD.

- Конфликт имен субъектов-служб и домена DNS
- Имена субъекта учетной записи домена

## <a name="object-name-collisions"></a>Конфликты имен объектов

### <a name="service-principal-names-spn-and-dns-domain-naming-conflict"></a>Конфликт имен субъектов-служб и доменов DNS

Доменное имя, указанное во время развертывания, используется как домен DNS AD. Это означает, что модули pod могут подключаться друг к другу во внутренней сети с помощью этого домена DNS. Кроме того, пользователи подключаются к конечным точкам кластера больших данных, используя этот домен DNS. В результате для любого имени субъекта-службы, созданного для службы в кластере больших данных, будет установлено имя модуля pod Kubernetes, службы или конечной точки, действующее в этом домене DNS AD. Если пользователь развертывает второй кластер в домене, создаваемые имена субъектов-служб будут иметь то же полное доменное имя, так как имена pod и доменное имя DNS не различаются между двумя кластерами. В качестве примера рассмотрим случай, когда домен DNS AD — `contoso.local`. Одно из имен субъектов-служб, созданных для SQL Server главного пула в pod `master-0`, будет `MSSQLSvc/master-0.contoso.local:1433`. Во втором кластере, который пользователь попытается развернуть, имя pod для `master-0` будет тем же, и пользователь предоставит тот же домен DNS AD (``contoso.local``), что приводит к той же строке имени субъекта-службы. Active Directory запрещает создание конфликтующих имен субъектов-служб, ведущих к сбою развертывания, для второго кластера.

### <a name="domain-account-principal-names"></a>Имена субъекта учетной записи домена

Во время развертывания кластера больших данных с доменом Active Directory для служб, выполняющихся внутри кластера больших данных, создается несколько субъектов учетных записей. Это, по сути, учетные записи пользователей AD. До пакета обновлений SQL 2019 CU5 имена этих учетных записей не были уникальными между кластерами. Это приводило к попытке создать одинаковое имя учетной записи пользователя для конкретной службы в кластере больших данных в двух разных кластерах. Кластер, который развертывается вторым, столкнется с конфликтом в AD и не сможет создать учетную запись.

## <a name="resolution-for-collisions"></a>Разрешение конфликтов

### <a name="solution-to-solve-the-problem-with-spns-and-dns-domain---sql-2019-cu5"></a>Решение проблемы с именами субъектов-служб и доменом DNS — пакет обновлений SQL 2019 CU5

Поскольку имена субъектов-служб должны различаться в двух кластерах, доменное имя DNS, передаваемое во время развертывания, должно быть другим. Вы можете указать разные DNS-имена, используя новый параметр в файле конфигурации развертывания: `subdomain`. Если поддомен отличается в двух кластерах и через этот поддомен осуществляется внутренняя связь, имена субъектов-служб будут включать поддомен, чтобы обеспечить необходимую уникальность.

>[!NOTE]
>Значение, передаваемое через параметр поддомена, является не новым доменом AD, а DNS-доменом, который используется для внутренних целей.

В качестве примера снова рассмотрим имя субъекта-службы SQL Server главного пула. Если поддомен — `bdc`, имя субъекта-службы изменится на `MSSQLSvc/master-0.bdc.contoso.local:1433`.  

Настраивать значение нового параметра поддомена в спецификации конфигурации Active Directory не обязательно. По умолчанию для расчета значения параметра поддомена будет использоваться имя кластера больших данных или имя пространства имен. Если пользователи хотят переопределить имя поддомена, это можно сделать с помощью нового параметра поддомена, представленного в спецификации конфигурации Active Directory.

### <a name="solution-to-solve-the-problem-regarding-account-names-uniqueness"></a>Решение проблемы, касающейся уникальности имен учетных записей

Чтобы имена учетных записей следовали схеме, которая гарантирует уникальность, мы представили концепцию префикса учетной записи. Префикс учетной записи — это часть имени учетной записи, которая является уникальной между любыми двумя кластерами. Оставшаяся часть имени учетной записи является постоянной для данной службы. Новый формат имени учетной записи будет выглядеть следующим образом: `<prefix>-<name>-<podId>`. 

>[!NOTE]
>Длина имени учетной записи Active Directory должна составлять не более 20 символов. Кластеру больших данных необходимо использовать 8 символов для различения объектов pod и наборов с отслеживанием состояния. В итоге остается 12 символов для префикса учетной записи.

Настраивать имя учетной записи не обязательно. Используйте параметр `accountPrefix` в спецификации конфигурации Active Directory. В SQL Server 2019 CU5 в спецификации конфигурации содержится `accountPrefix`. По умолчанию имя поддомена используется в качестве префикса учетной записи. Если имя поддомена длиннее 12 символов, то в качестве префикса учетной записи используются первые 12 символов имени поддомена.

Поддомен применяется только к DNS. Поэтому новое имя учетной записи пользователя LDAP — `bdc-ldap@contoso.local`. Учетная запись не будет иметь имя `bdc-ldap@bdc.contoso.local`.

## <a name="semantics"></a>Семантика

Обобщение семантики параметров, добавленных в SQL 2019 CU5 для нескольких кластеров в домене:

### `subdomain`

- Необязательное поле
- Тип данных: строка
- Определение: уникальный поддомен DNS, используемый для этого кластера больших данных. Это значение должно отличаться для каждого кластера, развернутого в домене Active Directory.  
- Значение по умолчанию: Если этот параметр не указан, в качестве значения по умолчанию будет использоваться имя кластера.
- Максимальная длина: 63 символа на метку (метка является строкой, разделенной точкой).
- Примечания: DNS-имена конечных точек должны включать поддомен в полном доменном имени.

### `accountPrefix`

- Необязательное поле
- Тип данных: строка
- Определение: будет создан уникальный префикс для кластера больших данных в учетных записях AD. Это значение должно отличаться для каждого кластера, развернутого в домене Active Directory.
- Значение по умолчанию: Если этот параметр не указан, в качестве значения по умолчанию будет использоваться имя поддомена. Если поддомен не указан, в качестве имени поддомена будет использоваться имя кластера, поэтому имя кластера будет также унаследовано как префикс учетной записи. Если поддомен указан и состоит из нескольких частей (содержит одну или несколько точек), пользователь должен предоставить префикс учетной записи. 
- Максимальная длина: 12 символов. 

## <a name="impact-on-ad-domain-and-dns-server"></a>Влияние на домен Active Directory и DNS-сервер 

В домене AD или контроллере домена не требуется никаких изменений для развертывания нескольких кластеров больших данных в одном домене Active Directory. Поддомен DNS будет автоматически создан на DNS-сервере при регистрации DNS-имен внешней конечной точки. 

## <a name="impact-on-setting-up-the-deployment-configuration-file-used-for-the-bdc-deployment"></a>Влияние на настройку файла конфигурации развертывания, используемого для развертывания кластера больших данных 

Раздел *activeDirectory* в конфигурации уровня управления *control.json* будет содержать два новых необязательных параметра: `subdomain` и `accountPrefix`. Предоставьте значения для этих параметров только в том случае, если необходимо переопределить поведение по умолчанию, то есть использовать имя кластера для каждого из них. Имя кластера совпадает с именем пространства имен.

Кроме того, можно использовать DNS-имена конечных точек, если они полностью определены и не конфликтуют между любыми двумя кластерами больших данных, развернутыми в одном домене. При необходимости можно использовать значение параметра поддомена, чтобы гарантировать, что DNS-имена различаются в разных кластерах.  В качестве примера рассмотрим конечную точку шлюза. Если вы хотите использовать имя `gateway` для конечной точки и зарегистрировать его на DNS-сервере автоматически в рамках развертывания кластера больших данных, используйте `gateway.bdc1.contoso.local` в качестве DNS-имени. Если `bdc1` является поддоменом, а `contoso.local` — это доменное имя DNS AD. Другие допустимые значения: `gateway-bdc1.contoso.local` или просто `gateway.contoso.local`.

## <a name="examples"></a>Примеры

Ниже приведен пример конфигурации безопасности Active Directory, если требуется переопределить поддомен и префикс учетной записи. 

```json
    "security": { 
        "activeDirectory": { 
            "ouDistinguishedName":"OU=contosoou,DC=contoso,DC=local", 
            "dnsIpAddresses": [ "10.10.10.10" ], 
            "domainControllerFullyQualifiedDns": [ "contoso-win2016-dc.contoso.local" ], 
            "domainDnsName":"contoso.local", 
            "subdomain": "bdc", 
            "accountPrefix": "myprefix", 
            "clusterAdmins": [ "contosoadmins" ], 
            "clusterUsers": [ "contosousers1", "contosousers2" ] 
        } 
    } 
  
```

Ниже приведен пример спецификации конечной точки для конечных точек уровня управления. Можно использовать любые значения DNS-имен, если они уникальны и являются полными:
  
```json
        "endpoints": [ 
            { 
                "serviceType": "NodePort", 
                "port": 30080, 
                "name": "Controller", 
                "dnsName": "control-bdc1.contoso.local" 
            }, 
            { 
                "serviceType": "NodePort", 
                "port": 30777, 
                "name": "ServiceProxy", 
                "dnsName": "monitor-bdc1.contoso.local" 
            } 
        ] 
  
```

## <a name="questions"></a>Вопросы

### <a name="do-you-need-to-create-separate-ous-for-different-clusters"></a>Нужно ли создавать отдельные подразделения для разных кластеров?

Это необязательно, но рекомендуется. Указание отдельных подразделений для отдельных кластеров помогает управлять созданными учетными записями пользователей.

### <a name="how-to-revert-back-to-the-pre-cu5-behavior-in-sql-2019"></a>Как вернуться к поведению до пакета обновлений CU5 в SQL 2019?

В некоторых ситуациях вы не можете использовать новый параметр `subdomain`. Например, необходимо развернуть выпуск до пакета обновлений CU5, и вы уже обновили [!INCLUDE [azure-data-cli-azdata](../includes/azure-data-cli-azdata.md)]. Это маловероятно, но если необходимо вернуться к предыдущему поведению, можно задать для параметра `useSubdomain` значение `false` в разделе `control.json` Active Directory.

В следующем примере для параметра `useSubdomain` задается значение `false` в этом сценарии.

```console
azdata bdc config replace -c custom-prod-kubeadm/control.json -j "$.security.activeDirectory.useSubdomain=false" 
```

## <a name="next-steps"></a>Дальнейшие действия

[Устранение неполадок при интеграции кластера больших данных SQL Server с Active Directory](troubleshoot-active-directory.md)
