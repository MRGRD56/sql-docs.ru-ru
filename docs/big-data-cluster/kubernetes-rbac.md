---
title: Kubernetes RBAC
titleSuffix: SQL Server big data clusters
description: Эта статья описывает, как платформа кластеров больших данных SQL Server использует RBAC с Kubernetes.
author: mihaelablendea
ms.author: mihaelab
ms.reviewer: mikeray
ms.date: 02/11/2021
ms.topic: conceptual
ms.prod: sql
ms.technology: big-data-cluster
ms.openlocfilehash: f8759714fe2846a86f53a4974960b511f4b4c3dd
ms.sourcegitcommit: 8dc7e0ececf15f3438c05ef2c9daccaac1bbff78
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/13/2021
ms.locfileid: "100343890"
---
# <a name="kubernetes-rbac-model--impact-on-users-and-service-accounts-managing-bdc"></a>Модель Kubernetes RBAC и ее влияние на пользователей и учетные записи служб, управляющие BDC

В этой статье описываются требования к разрешениям для пользователей, управляющих кластерами больших данных, а также семантика учетной записи службы по умолчанию и доступ к Kubernetes из кластера больших данных.

> [!NOTE]
> Дополнительные материалы по модели RBAC Kubernetes см. в разделах [Использование авторизации RBAC — Kubernetes](https://kubernetes.io/docs/reference/access-authn-authz/rbac/) и [Использование RBAC для определения и применения разрешений — OpenShift](https://docs.openshift.com/container-platform/4.4/authentication/using-rbac.html).

## <a name="role-required-for-deployment"></a>Роль, необходимая для развертывания

Кластер больших данных использует учетные записи служб (например, `sa-mssql-controller` или `master`) для оркестрации подготовки объектов pod кластера, служб, высокого уровня доступности, мониторинга и т. п. При запуске развертывания кластера больших данных (например, `azdata bdc create`) [!INCLUDE [azure-data-cli-azdata](../includes/azure-data-cli-azdata.md)] выполняет следующие действия:

1. Проверяет, существует ли указанное пространство имен.
2. Если оно не существует, создает его и применяет метку `MSSQL_CLUSTER`.
3. Создает учетную запись службы `sa-mssql-controller`.
4. Создает роль `<namespaced>-admin` с полными разрешениями на пространство имен или проект, но не разрешениями уровня кластера.
5. Создает назначение роли этой учетной записи службы для роли.

После выполнения этих шагов подготавливаются объекты pod уровня управления, а учетная запись службы развертывает оставшуюся часть кластера больших данных.  

В конечном итоге осуществляющий развертывание пользователь должен иметь разрешения на выполнение следующих задач:

- Вывод списка пространств имен в кластере (1).
- Исправление нового или существующего пространства имен с меткой (2).
- Создание учетной записи службы `sa-mssql-controller`, роли `<namespaced>-admin` и привязки роли (3–5).

Роль по умолчанию `admin` не имеет таких разрешений, поэтому пользователь, развертывающий кластер больших данных, должен иметь по меньшей мере разрешения администратора на уровне пространства имен.

## <a name="cluster-role-required-for-pods-and-nodes-metrics-collection"></a>Роль кластера, необходимая для сбора метрик объектов pod и узлов

Начиная с накопительного пакета обновления 5 для SQL Server 2019 для сбора метрик объектов pod и узлов Telegraf требует учетную запись службы с разрешениями роли в масштабе кластера. Во время развертывания (или обновления существующих развертываний) мы пытаемся создать необходимую учетную запись службы и роль кластера, но если пользователь, развертывающий кластер или осуществляющий обновление, не обладает достаточными разрешениями, развертывание или обновление продолжится с предупреждением и завершится успешно. В этом случае метрики объектов pod и узлов собираться не будут. Пользователь, развертывающий кластер, должен попросить администратора кластера создать роль и учетную запись службы (до или после развертывания или обновления). После создания их использует кластер больших данных. 

Ниже демонстрируется создание необходимых артефактов.

1. Создайте файл *metrics-role.yaml* с приведенным ниже содержимым. Не забудьте заменить заполнители *<clusterName>* именем кластера больших данных.

   ```yaml
   apiVersion: rbac.authorization.k8s.io/v1
   kind: ClusterRole
   metadata:
     name: <clusterName>:cr-mssql-metricsdc-reader
   rules:
   - apiGroups:
     - '*'
     resources:
     - pods
     - nodes/stats
     - nodes/proxy
     verbs:
     - get
   ---
   apiVersion: rbac.authorization.k8s.io/v1
   kind: ClusterRoleBinding
   metadata:
     name: <clusterName>:crb-mssql-metricsdc-reader
   roleRef:
     apiGroup: rbac.authorization.k8s.io
     kind: ClusterRole
     name: <clusterName>:cr-mssql-metricsdc-reader
   subjects:
   - kind: ServiceAccount
     name: sa-mssql-metricsdc-reader
     namespace: <clusterName>
   ```

2. Создайте роль кластера и привязку роли кластера:

   ```bash
   kubectl create -f metrics-role.yaml
   ```

Учетную запись службы, роль кластера и привязку роли кластера можно создать либо до, либо после развертывания кластера больших данных. Kubernetes автоматически обновляет разрешение для учетной записи службы Telegraf. Если эти данные создаются в качестве развертывания объекта pod, то в собираемых метриках объектов pod и узлов будет наблюдаться задержка в несколько минут.

> [!NOTE]
> Накопительный пакет обновления 5 для SQL Server 2019 представляет два параметра для управления сбором метрик объектов pod и узлов. По умолчанию для этих параметров задано значение true во всех целевых объектах среды, кроме OpenShift, где значение по умолчанию переопределено. 

Эти параметры можно настроить в разделе безопасности в файле конфигурации развертывания `control.json`:

```json
  "security": {
    …
    "allowNodeMetricsCollection": false,
    "allowPodMetricsCollection": false
  }
```

Если для этих параметров задано значение `false`, рабочий процесс развертывания кластера больших данных не будет пытаться создать учетную запись службы, роль кластера и привязку для Telegraf.

## <a name="default-service-account-usage-from-within-a-bdc-pod"></a>Использование учетной записи службы по умолчанию в модуле BDC Pod

Для более надежной модели безопасности в SQL Server 2019 CU5 по умолчанию отключено подключение учетных данных в модулях BDC для учетной записи службы Kubernetes по умолчанию. Это относится как к новым, так и к обновленным развертываниям в CU5 или более поздних версиях.
Токен учетных данных внутри модулей Pod можно использовать для доступа к серверу API Kubernetes, а уровень разрешений зависит от параметров политики авторизации Kubernetes. В случае особых вариантов использования, требующих возврата к предыдущему поведению CU5, в CU6 мы представляем новый переключатель, чтобы вы могли включить автоматическое подключение только на время развертывания. Это можно сделать с помощью файла развертывания конфигурации и установив для параметра *automountServiceAccountToken* значение *true*. Выполните эту команду, чтобы обновить этот параметр в своем файле конфигурации *control.json*, с помощью [!INCLUDE [azure-data-cli-azdata](../includes/azure-data-cli-azdata.md)]: 

``` bash
azdata bdc config replace -c custom-bdc/control.json -j "$.security.automountServiceAccountToken=true"
```
