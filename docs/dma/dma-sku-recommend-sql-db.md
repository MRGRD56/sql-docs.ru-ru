---
title: Найдите правильный номер SKU базы данных SQL Azure для локальной базы данных (Помощник по миграции данных) | Документация Майкрософт
description: Узнайте, как использовать Помощник по миграции данных для указания правой базы данных SQL Azure или номера SKU Azure SQL Управляемый экземпляр для локальной базы данных.
ms.custom: ''
ms.date: 05/06/2019
ms.prod: sql
ms.prod_service: dma
ms.reviewer: ''
ms.technology: dma
ms.topic: conceptual
keywords: ''
helpviewer_keywords:
- Data Migration Assistant, Assess
ms.assetid: ''
author: rajeshsetlem
ms.author: rajpo
ms.openlocfilehash: b29815876d804f387ce31754c960e80f9db99434
ms.sourcegitcommit: 0bcda4ce24de716f158a3b652c9c84c8f801677a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2021
ms.locfileid: "102247176"
---
# <a name="identify-the-right-azure-sql-database-or-sql-managed-instance-sku-for-your-on-premises-database"></a>Найдите нужную базу данных SQL Azure или номер SKU SQL Управляемый экземпляр для локальной базы данных

Миграция баз данных в облако может быть сложной, особенно при попытке выбрать оптимальную базу данных SQL Azure или целевой объект SQL Управляемый экземпляр и SKU для базы данных. Наша цель с Помощник по миграции базы данных (DMA) заключается в том, чтобы помочь решить эти вопросы и упростить процесс переноса базы данных, предоставив эти рекомендации по SKU в удобном для пользователя выводе.


Функция "рекомендации SKU" позволяет выбрать минимальную рекомендуемую базу данных SQL Azure или номер SKU Azure SQL Управляемый экземпляр на основе счетчиков производительности, собранных с компьютеров, на которых размещены базы данных. Эта функция предоставляет рекомендации, связанные с ценовой категорией, уровнем вычислений и максимальным размером данных, а также оценочной стоимостью в месяц. Кроме того, она предоставляет возможность выполнять сбор отдельных баз данных и управляемых экземпляров для всех рекомендуемых баз данных. В настоящее время эта функция доступна только через интерфейс командной строки (CLI).

Ниже приведены инструкции по определению рекомендаций SKU и подготовке соответствующих отдельных баз данных или управляемых экземпляров в Azure с помощью DMA.

[!INCLUDE [online-offline](../includes/azure-migrate-to-assess-sql-data-estate.md)]

## <a name="prerequisites"></a>Предварительные требования

- Скачайте и установите последнюю версию [DMA](https://aka.ms/get-dma). Если вы уже используете более раннюю версию средства, откройте его, и вам будет предложено обновить DMA.
- Убедитесь, что на компьютере установлен [PowerShell версии 5,1](https://www.microsoft.com/download/details.aspx?id=54616) или более поздней, который необходим для выполнения всех сценариев. Сведения о том, как узнать, какая версия PowerShell установлена на компьютере, см. в статье [Загрузка и установка Windows PowerShell 5,1](/skypeforbusiness/set-up-your-computer-for-windows-powershell/download-and-install-windows-powershell-5-1).
  > [!NOTE]
  > Для сбора сведений о компьютере Скрипт сбора данных использует командлет Get-WmiObject, который был признан устаревшим в PowerShell 6. Чтобы запустить этот скрипт в PowerShell 6 или 7, необходимо заменить командлеты WMI более новыми командлетами CIM.
- Убедитесь, что на компьютере установлен модуль Azure PowerShell. Дополнительные сведения см. в статье [Установка модуля Azure PowerShell](/powershell/azure/install-az-ps?view=azps-1.8.0&preserve-view=true).
- Убедитесь, что файл **SkuRecommendationDataCollectionScript.ps1** PowerShell, необходимый для получения счетчиков производительности, установлен в папку DMA.
- Убедитесь, что компьютер, на котором вы будете выполнять этот процесс, имеет разрешения администратора на компьютере, на котором размещаются базы данных.

## <a name="collect-performance-counters"></a>Получение счетчиков производительности

Первым этапом процесса является получение счетчиков производительности для баз данных. Вы можете получить счетчики производительности, выполнив команду PowerShell на компьютере, на котором размещены базы данных. DMA предоставляет копию этого файла PowerShell, но можно также использовать собственный метод для сбора данных счетчиков производительности с компьютера.

Вам не нужно выполнять эту задачу отдельно для каждой базы данных. Счетчики производительности, собранные с компьютера, можно использовать для рекомендуемого номера SKU для всех баз данных, размещенных на компьютере.

1. В папке DMA выберите файл PowerShell SkuRecommendationDataCollectionScript.ps1. Этот файл необходим для получения счетчиков производительности.

    ![Файл PowerShell, отображаемый в папке DMA](../dma/media/dma-sku-recommend-data-collection-file.png)

2. Запустите сценарий PowerShell со следующими аргументами:
    - **ComputerName**: имя компьютера, на котором размещены базы данных.
    - **OutputFilePath**: путь к выходному файлу для сохранения собранных счетчиков.
    - **Коллектионтимеинсекондс**. время, в течение которого требуется получить данные счетчиков производительности. Чтобы получить осмысленную рекомендацию, запишите счетчики производительности не менее 40 минут. Чем дольше продолжительность записи, тем точнее рекомендация будет. Также убедитесь, что рабочие нагрузки выполняются для нужных баз данных, чтобы обеспечить более точные рекомендации.
    - **Дбконнектионстринг**: строка подключения, указывающая на базу данных master, размещенную на компьютере, с которого будут собираться данные счетчика производительности.

    Вот пример вызова:

    ```
    .\SkuRecommendationDataCollectionScript.ps1
     -ComputerName Foobar1
     -OutputFilePath D:\counters2.csv
     -CollectionTimeInSeconds 2400
     -DbConnectionString Server=localhost;Initial Catalog=master;Integrated Security=SSPI;
    ```

    После выполнения команды процесс выводит файл, включая счетчики производительности, в указанное расположение. Этот файл можно использовать в качестве входных данных для следующей части процесса, который предоставит рекомендации по SKU для параметров отдельной базы данных и управляемых экземпляров.

## <a name="use-the-dma-cli-to-get-sku-recommendations"></a>Использование интерфейса командной строки DMA для получения рекомендаций по SKU

Используйте выходной файл счетчиков производительности, созданный в качестве входных данных для этого процесса.

Для параметра единственной базы данных DMA предоставит рекомендации для ценовой категории базы данных SQL Azure, уровня вычислений и максимального размера данных для каждой базы данных на компьютере. Если на компьютере установлено несколько баз данных, можно также указать базы данных, для которых нужны рекомендации. Кроме того, DMA предоставит вам оценочные ежемесячные затраты на каждую базу данных.

Для управляемого экземпляра рекомендации поддерживают сценарий переноса и сдвига. В результате DMA предоставит рекомендации для ценовой категории Azure SQL Управляемый экземпляр, уровня вычислений и максимального размера данных для набора баз данных на компьютере. Опять же, если на компьютере имеется несколько баз данных, можно также указать базы данных, для которых нужны рекомендации. Кроме того, DMA предоставит Вам приблизительные месячные затраты на управляемый экземпляр.

Чтобы использовать интерфейс командной строки DMA для получения рекомендаций по SKU, в командной строке выполните dmacmd.exe со следующими аргументами:

- **/Action = скурекоммендатион**: введите этот аргумент для выполнения оценки номера SKU.
- **/Скурекоммендатионинпутдатафилепас**: путь к файлу счетчика, собранному в предыдущем разделе.
- **/Скурекоммендатионтсваутпутресултсфилепас**: путь для записи выходных результатов в формате TSV.
- **/Скурекоммендатионжсонаутпутресултсфилепас**: путь для записи выходных результатов в формате JSON.
- **/Скурекоммендатионхтмлресултсфилепас**: путь для записи выходных результатов в формате HTML.

Кроме того, выберите один из следующих аргументов:

- Запретить обновление цен
  - **/Скурекоммендатионпревентприцерефреш**: Если задано значение true, предотвращается обновление цены и принимается цена по умолчанию. Используйте при работе в автономном режиме. Если этот параметр не используется, необходимо указать приведенные ниже параметры, чтобы получить актуальные цены на основе указанного региона.
- Получить последние цены
  - **/Скурекоммендатионкурренцикоде**: валюта, в которой отображаются цены (например, "USD").
  - **/Скурекоммендатионоффернаме**: имя предложения (например, MS-AZR-0003P). Дополнительные сведения см. на странице [сведений о предложении Microsoft Azure](https://azure.microsoft.com/support/legal/offer-details/) .
    - **/Скурекоммендатионрегионнаме**: имя региона (например, "WestUS").
    - **/Скурекоммендатионсубскриптионид**: идентификатор подписки.
    - **/Азуреаусентикатионтенантид**: клиент проверки подлинности.
    - **/Азуреаусентикатионклиентид**: идентификатор клиента приложения AAD, используемого для проверки подлинности.
    - Один из следующих вариантов проверки подлинности:
      - Интерактивно
        - **Азуреаусентикатионинтерактивеаусентикатион**: задайте значение true для всплывающего окна проверки подлинности.
      - На основе сертификата
        - **Азуреаусентикатионцертификатесторелокатион**: укажите расположение хранилища сертификатов (например, "CurrentUser").
        - **Азуреаусентикатионцертификатесумбпринт**: задайте отпечаток сертификата.
      - На основе токена
        - **Азуреаусентикатионтокен**: укажите маркер сертификата.

> [!NOTE]
> Чтобы получить ClientId и TenantId для интерактивной проверки подлинности, необходимо настроить новое приложение AAD. Дополнительные сведения о проверке подлинности и получении этих учетных данных см. в статье [Microsoft Azure API выставления счетов: RATECARD API](https://github.com/Azure-Samples/billing-dotnet-ratecard-api), следуйте инструкциям в разделе **Шаг 1. Настройка собственного клиентского приложения в клиенте AAD**.

Наконец, имеется необязательный аргумент, с помощью которого можно указать базы данных, для которых требуется получить рекомендации. 

- **/Скурекоммендатиондатабасесторекомменд**: список баз данных, для которых необходимо выполнить рекомендации. В именах баз данных учитывается регистр, и в файле input. csv должно быть найдено значение (1), а в каждом из них должны находиться двойные кавычки (3), которые разделяются одним пробелом между именами (например,/Скурекоммендатиондатабасесторекомменд = "Database1" "Database2" "Database3"). Пропуск этого параметра гарантирует, что рекомендации предоставляются для всех пользовательских баз данных, определенных во входном CSV-файле.  

Ниже приведены некоторые примеры вызовов.

**Пример 1. получение рекомендаций с ценами по умолчанию. Используйте при работе в автономном режиме или при отсутствии учетных данных для проверки подлинности.**

```
.\DmaCmd.exe /Action=SkuRecommendation
/SkuRecommendationInputDataFilePath="C:\TestOut\out.csv"
/SkuRecommendationTsvOutputResultsFilePath="C:\TestOut\prices.tsv"
/SkuRecommendationJsonOutputResultsFilePath="C:\TestOut\prices.json"
/SkuRecommendationOutputResultsFilePath="C:\TestOut\prices.html"
/SkuRecommendationPreventPriceRefresh=true
```

**Пример 2. получение рекомендаций с последними ценами для указанной области (например, "Уквест").**

```
.\DmaCmd.exe /Action=SkuRecommendation
/SkuRecommendationInputDataFilePath="C:\TestOut\out.csv"
/SkuRecommendationTsvOutputResultsFilePath="C:\TestOut\prices.tsv"
/SkuRecommendationJsonOutputResultsFilePath="C:\TestOut\prices.json"
/SkuRecommendationOutputResultsFilePath="C:\TestOut\prices.html"
/SkuRecommendationCurrencyCode=USD
/SkuRecommendationOfferName=MS-AZR-0044p
/SkuRecommendationRegionName=UKWest
/SkuRecommendationSubscriptionId=<Your Subscription Id>
/AzureAuthenticationInteractiveAuthentication=true
/AzureAuthenticationClientId=<Your AzureAuthenticationClientId>
/AzureAuthenticationTenantId=<Your AzureAuthenticationTenantId>
```

**Пример 3. получение рекомендаций для конкретных баз данных (например, "TPCDS1G, EDW_3G, TPCDS10G").**

```
.\DmaCmd.exe /Action=SkuRecommendation 
/SkuRecommendationInputDataFilePath="C:\TestOut\out.csv" 
/SkuRecommendationTsvOutputResultsFilePath="C:\TestOut\prices.tsv" 
/SkuRecommendationJsonOutputResultsFilePath="C:\TestOut\prices.json" 
/SkuRecommendationOutputResultsFilePath="C:\TestOut\prices.html" 
/SkuRecommendationCurrencyCode=USD 
/SkuRecommendationOfferName=MS-AZR-0044p 
/SkuRecommendationRegionName=UKWest 
/SkuRecommendationSubscriptionId=<Your Subscription Id> 
/SkuRecommendationDatabasesToRecommend=“TPCDS1G” “EDW_3G” “TPCDS10G” 
/AzureAuthenticationInteractiveAuthentication=true 
/AzureAuthenticationClientId=<Your AzureAuthenticationClientId> 
/AzureAuthenticationTenantId=<Your AzureAuthenticationTenantId>
```

Для рекомендаций по отдельным базам данных выходной файл TSV будет выглядеть следующим образом:

![Файл единой базы данных PowerShell, отображаемый в папке DMA](../dma/media/dma-sku-recommend-single-db-recommendations.png)

Для рекомендаций по управляемому экземпляру выходной файл TSV будет выглядеть следующим образом:

![Файл управляемого экземпляра PowerShell, отображаемый в папке DMA](../dma/media/dma-sku-recommend-mi-recommendations.png)

Далее следует описание каждого столбца в выходном файле.

- **DatabaseName** — имя базы данных.
- **Метриктипе** — рекомендуемый уровень производительности.
- **Метриквалуе** — рекомендуемый SKU.
- **Прицепермонс** — Оценочная цена за месяц для соответствующего номера SKU.
- **RegionName** — имя региона для соответствующего номера SKU. 
- **Истиеррекоммендед** — мы предлагаем минимальную рекомендацию по SKU для каждого уровня. Затем мы применяем эвристику для определения правильного уровня базы данных. Это отражает, какой уровень рекомендуется для базы данных. 
- **Ексклусионреасонс** — это значение пусто, если уровень рекомендуется. Для каждого уровня, который не рекомендуется, мы предоставляем причины, по которым он не был выбран.
- **Апплиедрулес** — короткая нотация примененных правил.

Последний рекомендуемый уровень (т. е. **метриктипе**) и значение (т. е. **метриквалуе**) — находятся в том случае, если столбец **истиеррекоммендед** имеет значение true, отражающий минимальный номер SKU, необходимый для выполнения запросов в Azure, с коэффициентом успеха, аналогичным локальным базам данных. Для Управляемый экземпляр Azure SQL сейчас DMA поддерживает рекомендации по наиболее часто используемым 8vcore 40vcore SKU. Например, если рекомендуемый минимальный номер SKU — S4 для уровня "Стандартный", то при выборе S3 или ниже запросы истечет время ожидания или не удастся выполнить.

HTML-файл содержит эти сведения в графическом формате. Он предоставляет понятные пользователю средства просмотра окончательной рекомендации и подготовки следующей части процесса. Дополнительные сведения о выходных данных HTML приведены в следующем разделе.

## <a name="provision-recommended-skus-to-azure"></a>Инициализация рекомендуемых номеров SKU в Azure

Всего за несколько щелчков мыши можно использовать рекомендации, идентифицированные для подготовки целевых SKU в Azure, в которые можно перенести базы данных. Вы можете использовать HTML-файл для ввода подписки Azure; Выберите ценовую категорию, уровень вычислений и максимальный размер данных для баз данных. и создайте скрипт для подготовки баз данных. Этот скрипт можно выполнить с помощью PowerShell.

Этот процесс можно выполнить на одном компьютере или выполнить на нескольких компьютерах, чтобы определить, какие рекомендации по SKU будут доступны в масштабе. В настоящее время DMA делает его простым и масштабируемым, поддерживая весь процесс с помощью интерфейса командной строки.

Чтобы ввести сведения об инициализации и внести изменения в рекомендации, обновите HTML-файл следующим образом.

**Рекомендации по использованию одной базы данных**

![Экран рекомендаций по SKU базы данных SQL Azure](../dma/media/dma-sku-recommend-single-db-recommendations1.png)

1. Откройте HTML-файл и введите следующие сведения:
    - **Идентификатор подписки** — идентификатор подписки подписки Azure, для которой необходимо подготавливать базы данных.
    - **Группа ресурсов** — группа ресурсов, в которой требуется развернуть базы данных. Введите существующую группу ресурсов.
    - **Регион** — регион, в котором должны подготавливаться базы данных. Убедитесь, что ваша подписка поддерживает выбранную область.
    - **Имя сервера** — сервер базы данных SQL Azure, на котором будут развернуты базы данных. Если ввести имя сервера, которое не существует, оно будет создано.
    - **Имя пользователя администратора** — имя администратора сервера. Убедитесь, что имя входа соответствует следующим требованиям.
      - Имя для входа не должно содержать идентификатор SQL или обычное системное имя (например, администратор, администратор, SA, root, DBManager, loginmanager и т. д.) или встроенного пользователя или роль базы данных (например, dbo, Guest, Public и т. д.).
      - Имя для входа не должно содержать символы, отличные от буквенно-цифровых (включая пробелы, символы Юникода).
      - Имя входа не должно начинаться с цифр или символов.

    - **Пароль администратора** — пароль администратора сервера. 
      - Длина пароля должна составлять не менее 8 символов и содержать не более 128 символов.
      - Пароль должен содержать символы трех из следующих категорий: прописные латинские буквы, строчные латинские буквы, цифры (0–9) и другие символы (!, $, #, % и т. д.).
      - Пароль не может содержать имя входа или его часть. (Часть имени для входа определена как три или более последовательных алфавитно-цифровых символов.)

2. Ознакомьтесь с рекомендациями для каждой базы данных и при необходимости измените ценовую категорию, уровень вычислений и максимальный размер данных. Не забудьте отменить выбор всех баз данных, которые в настоящее время не нужно подготавливать.

3. Выберите **создать скрипт подготовки**, сохраните скрипт, а затем выполните его в PowerShell.

    Этот процесс должен создать все базы данных, выбранные на странице HTML.

**Рекомендации по Управляемый экземпляр SQL Azure**

![Экран рекомендаций по SKU Azure SQL MI](../dma/media/dma-sku-recommend-mi-recommendations1.png)

1. Откройте HTML-файл и введите следующие сведения:
    - **Идентификатор подписки** — идентификатор подписки подписки Azure, для которой необходимо подготавливать базы данных.
    - **Группа ресурсов** — группа ресурсов, в которой требуется развернуть базы данных. Введите существующую группу ресурсов.
    - **Регион** — регион, в котором должны подготавливаться базы данных. Убедитесь, что ваша подписка поддерживает выбранную область.
    - **Имя экземпляра** — экземпляр управляемый экземпляр Azure SQL, в который необходимо перенести базы данных. Имя экземпляра может содержать только строчные буквы, цифры и "-", но не может начинаться или заканчиваться символом "-" или содержать более 63 символов.
    - **Имя пользователя администратора экземпляра** — имя пользователя администратора экземпляра. Убедитесь, что имя входа соответствует следующим требованиям.
      - Имя для входа не должно содержать идентификатор SQL или обычное системное имя (например, администратор, администратор, SA, root, DBManager, loginmanager и т. д.) или встроенного пользователя или роль базы данных (например, dbo, Guest, Public и т. д.).
      - Имя для входа не должно содержать символы, отличные от буквенно-цифровых (включая пробелы, символы Юникода).
      - Имя входа не должно начинаться с цифр или символов.

    - **Пароль администратора экземпляра** — пароль администратора экземпляра. 
      - Длина пароля должна составлять не менее 16 символов и содержать не более 128 символов.
      - Пароль должен содержать символы трех из следующих категорий: прописные латинские буквы, строчные латинские буквы, цифры (0–9) и другие символы (!, $, #, % и т. д.).
      - Пароль не может содержать имя входа или его часть. (Часть имени для входа определена как три или более последовательных алфавитно-цифровых символов.)

    - **Имя виртуальной сети** — имя виртуальной сети, в которой должен быть подготовлен управляемый экземпляр. Введите имя существующей виртуальной сети.
    - **Имя подсети** — имя подсети, под которой должен быть подготовлен управляемый экземпляр. Введите существующее имя подсети.

2. Ознакомьтесь с рекомендациями для каждого экземпляра и при необходимости измените ценовую категорию, уровень вычислений и максимальный размер данных. Хотя рекомендации в настоящее время ограничены 8vcore 40vcore номерами SKU, при необходимости можно подготавливать номера SKU 64vcore и 80vcore. Не забудьте отменить выбор экземпляров, которые сейчас не нужно подготавливать.

    Этот процесс должен создать все базы данных, выбранные на странице HTML.

    > [!NOTE]
    > Создание управляемых экземпляров в подсети (особенно в первый раз) может занять несколько часов. После запуска скрипта подготовки с помощью PowerShell можно проверить состояние развертывания на портале Azure.

## <a name="next-step"></a>Следующий шаг

- Полный список команд для запуска DMA из CLI см. в статье [запуск помощник по миграции данных из командной строки](./dma-commandline.md).
